function testUserAgent(e){return/(android|bb\d+|meego).+|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substring(0,4))}function isLandscape(){return 90===Math.abs(window.orientation)}function EventDispatcher(){}function Vector2(e,t){this.x=e||0,this.y=t||0}function Texture(e,t,i,r,n,o,a,s,l,c){Object.defineProperty(this,"id",{value:textureId++}),this.uuid=_Math.generateUUID(),this.name="",this.image=void 0!==e?e:Texture.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:Texture.DEFAULT_MAPPING,this.wrapS=void 0!==i?i:ClampToEdgeWrapping,this.wrapT=void 0!==r?r:ClampToEdgeWrapping,this.magFilter=void 0!==n?n:LinearFilter,this.minFilter=void 0!==o?o:LinearMipMapLinearFilter,this.anisotropy=void 0!==l?l:1,this.format=void 0!==a?a:RGBAFormat,this.type=void 0!==s?s:UnsignedByteType,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==c?c:LinearEncoding,this.version=0,this.onUpdate=null}function Vector4(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=void 0!==r?r:1}function WebGLRenderTarget(e,t,i){this.uuid=_Math.generateUUID(),this.width=e,this.height=t,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t),i=i||{},void 0===i.minFilter&&(i.minFilter=LinearFilter),this.texture=new Texture(void 0,void 0,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function Quaternion(e,t,i,r){this._x=e||0,this._y=t||0,this._z=i||0,this._w=void 0!==r?r:1}function Vector3(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}function Matrix4(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function DataTexture(e,t,i,r,n,o,a,s,l,c,h,u){Texture.call(this,null,o,a,s,l,c,r,n,h,u),this.image={data:e,width:t,height:i},this.magFilter=void 0!==l?l:NearestFilter,this.minFilter=void 0!==c?c:NearestFilter,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function CubeTexture(e,t,i,r,n,o,a,s,l,c){e=void 0!==e?e:[],t=void 0!==t?t:CubeReflectionMapping,Texture.call(this,e,t,i,r,n,o,a,s,l,c),this.flipY=!1}function UniformContainer(){this.seq=[],this.map={}}function flatten(e,t,i){var r=e[0];if(r<=0||r>0)return e;var n=t*i,o=arrayCacheF32[n];if(void 0===o&&(o=new Float32Array(n),arrayCacheF32[n]=o),0!==t){r.toArray(o,0);for(var a=1,s=0;a!==t;++a)s+=i,e[a].toArray(o,s)}return o}function allocTexUnits(e,t){var i=arrayCacheI32[t];void 0===i&&(i=new Int32Array(t),arrayCacheI32[t]=i);for(var r=0;r!==t;++r)i[r]=e.allocTextureUnit();return i}function setValue1f(e,t){e.uniform1f(this.addr,t)}function setValue1i(e,t){e.uniform1i(this.addr,t)}function setValue2fv(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function setValue3fv(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function setValue4fv(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function setValue2fm(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function setValue3fm(e,t){void 0===t.elements?e.uniformMatrix3fv(this.addr,!1,t):(mat3array.set(t.elements),e.uniformMatrix3fv(this.addr,!1,mat3array))}function setValue4fm(e,t){void 0===t.elements?e.uniformMatrix4fv(this.addr,!1,t):(mat4array.set(t.elements),e.uniformMatrix4fv(this.addr,!1,mat4array))}function setValueT1(e,t,i){var r=i.allocTextureUnit();e.uniform1i(this.addr,r),i.setTexture2D(t||emptyTexture,r)}function setValueT6(e,t,i){var r=i.allocTextureUnit();e.uniform1i(this.addr,r),i.setTextureCube(t||emptyCubeTexture,r)}function setValue2iv(e,t){e.uniform2iv(this.addr,t)}function setValue3iv(e,t){e.uniform3iv(this.addr,t)}function setValue4iv(e,t){e.uniform4iv(this.addr,t)}function getSingularSetter(e){switch(e){case 5126:return setValue1f;case 35664:return setValue2fv;case 35665:return setValue3fv;case 35666:return setValue4fv;case 35674:return setValue2fm;case 35675:return setValue3fm;case 35676:return setValue4fm;case 35678:return setValueT1;case 35680:return setValueT6;case 5124:case 35670:return setValue1i;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}function setValue1fv(e,t){e.uniform1fv(this.addr,t)}function setValue1iv(e,t){e.uniform1iv(this.addr,t)}function setValueV2a(e,t){e.uniform2fv(this.addr,flatten(t,this.size,2))}function setValueV3a(e,t){e.uniform3fv(this.addr,flatten(t,this.size,3))}function setValueV4a(e,t){e.uniform4fv(this.addr,flatten(t,this.size,4))}function setValueM2a(e,t){e.uniformMatrix2fv(this.addr,!1,flatten(t,this.size,4))}function setValueM3a(e,t){e.uniformMatrix3fv(this.addr,!1,flatten(t,this.size,9))}function setValueM4a(e,t){e.uniformMatrix4fv(this.addr,!1,flatten(t,this.size,16))}function setValueT1a(e,t,i){var r=t.length,n=allocTexUnits(i,r);e.uniform1iv(this.addr,n);for(var o=0;o!==r;++o)i.setTexture2D(t[o]||emptyTexture,n[o])}function setValueT6a(e,t,i){var r=t.length,n=allocTexUnits(i,r);e.uniform1iv(this.addr,n);for(var o=0;o!==r;++o)i.setTextureCube(t[o]||emptyCubeTexture,n[o])}function getPureArraySetter(e){switch(e){case 5126:return setValue1fv;case 35664:return setValueV2a;case 35665:return setValueV3a;case 35666:return setValueV4a;case 35674:return setValueM2a;case 35675:return setValueM3a;case 35676:return setValueM4a;case 35678:return setValueT1a;case 35680:return setValueT6a;case 5124:case 35670:return setValue1iv;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}function SingleUniform(e,t,i){this.id=e,this.addr=i,this.setValue=getSingularSetter(t.type)}function PureArrayUniform(e,t,i){this.id=e,this.addr=i,this.size=t.size,this.setValue=getPureArraySetter(t.type)}function StructuredUniform(e){this.id=e,UniformContainer.call(this)}function addUniform(e,t){e.seq.push(t),e.map[t.id]=t}function parseUniform(e,t,i){var r=e.name,n=r.length;for(RePathPart.lastIndex=0;;){var o=RePathPart.exec(r),a=RePathPart.lastIndex,s=o[1],l="]"===o[2],c=o[3];if(l&&(s|=0),void 0===c||"["===c&&a+2===n){addUniform(i,void 0===c?new SingleUniform(s,e,t):new PureArrayUniform(s,e,t));break}var h=i.map,u=h[s];void 0===u&&(u=new StructuredUniform(s),addUniform(i,u)),i=u}}function WebGLUniforms(e,t,i){UniformContainer.call(this),this.renderer=i;for(var r=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=0;n<r;++n){var o=e.getActiveUniform(t,n),a=o.name,s=e.getUniformLocation(t,a);parseUniform(o,s,this)}}function Color(e,t,i){return void 0===t&&void 0===i?this.set(e):this.setRGB(e,t,i)}function Box2(e,t){this.min=void 0!==e?e:new Vector2(+(1/0),+(1/0)),this.max=void 0!==t?t:new Vector2(-(1/0),-(1/0))}function LensFlarePlugin(e,t){function i(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),t=new Uint16Array([0,1,2,0,2,3]);n=d.createBuffer(),o=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,n),d.bufferData(d.ARRAY_BUFFER,e,d.STATIC_DRAW),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,o),d.bufferData(d.ELEMENT_ARRAY_BUFFER,t,d.STATIC_DRAW),h=d.createTexture(),u=d.createTexture(),p.bindTexture(d.TEXTURE_2D,h),d.texImage2D(d.TEXTURE_2D,0,d.RGB,16,16,0,d.RGB,d.UNSIGNED_BYTE,null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),p.bindTexture(d.TEXTURE_2D,u),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,16,16,0,d.RGBA,d.UNSIGNED_BYTE,null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),a={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},s=r(a),l={vertex:d.getAttribLocation(s,"position"),uv:d.getAttribLocation(s,"uv")},c={renderType:d.getUniformLocation(s,"renderType"),map:d.getUniformLocation(s,"map"),occlusionMap:d.getUniformLocation(s,"occlusionMap"),opacity:d.getUniformLocation(s,"opacity"),color:d.getUniformLocation(s,"color"),scale:d.getUniformLocation(s,"scale"),rotation:d.getUniformLocation(s,"rotation"),screenPosition:d.getUniformLocation(s,"screenPosition")}}function r(t){var i=d.createProgram(),r=d.createShader(d.FRAGMENT_SHADER),n=d.createShader(d.VERTEX_SHADER),o="precision "+e.getPrecision()+" float;\n";return d.shaderSource(r,o+t.fragmentShader),d.shaderSource(n,o+t.vertexShader),d.compileShader(r),d.compileShader(n),d.attachShader(i,r),d.attachShader(i,n),d.linkProgram(i),i}var n,o,a,s,l,c,h,u,d=e.context,p=e.state;this.render=function(r,a,f){if(0!==t.length){var m=new Vector3,v=f.w/f.z,g=.5*f.z,y=.5*f.w,x=16/f.w,b=new Vector2(x*v,x),_=new Vector3(1,1,0),w=new Vector2(1,1),M=new Box2;M.min.set(f.x,f.y),M.max.set(f.x+(f.z-16),f.y+(f.w-16)),void 0===s&&i(),d.useProgram(s),p.initAttributes(),p.enableAttribute(l.vertex),p.enableAttribute(l.uv),p.disableUnusedAttributes(),d.uniform1i(c.occlusionMap,0),d.uniform1i(c.map,1),d.bindBuffer(d.ARRAY_BUFFER,n),d.vertexAttribPointer(l.vertex,2,d.FLOAT,!1,16,0),d.vertexAttribPointer(l.uv,2,d.FLOAT,!1,16,8),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,o),p.disable(d.CULL_FACE),p.buffers.depth.setMask(!1);for(var E=0,S=t.length;E<S;E++){x=16/f.w,b.set(x*v,x);var T=t[E];if(m.set(T.matrixWorld.elements[12],T.matrixWorld.elements[13],T.matrixWorld.elements[14]),m.applyMatrix4(a.matrixWorldInverse),m.applyMatrix4(a.projectionMatrix),_.copy(m),w.x=f.x+_.x*g+g-8,w.y=f.y+_.y*y+y-8,M.containsPoint(w)===!0){p.activeTexture(d.TEXTURE0),p.bindTexture(d.TEXTURE_2D,null),p.activeTexture(d.TEXTURE1),p.bindTexture(d.TEXTURE_2D,h),d.copyTexImage2D(d.TEXTURE_2D,0,d.RGB,w.x,w.y,16,16,0),d.uniform1i(c.renderType,0),d.uniform2f(c.scale,b.x,b.y),d.uniform3f(c.screenPosition,_.x,_.y,_.z),p.disable(d.BLEND),p.enable(d.DEPTH_TEST),d.drawElements(d.TRIANGLES,6,d.UNSIGNED_SHORT,0),p.activeTexture(d.TEXTURE0),p.bindTexture(d.TEXTURE_2D,u),d.copyTexImage2D(d.TEXTURE_2D,0,d.RGBA,w.x,w.y,16,16,0),d.uniform1i(c.renderType,1),p.disable(d.DEPTH_TEST),p.activeTexture(d.TEXTURE1),p.bindTexture(d.TEXTURE_2D,h),d.drawElements(d.TRIANGLES,6,d.UNSIGNED_SHORT,0),T.positionScreen.copy(_),T.customUpdateCallback?T.customUpdateCallback(T):T.updateLensFlares(),d.uniform1i(c.renderType,2),p.enable(d.BLEND);for(var C=0,A=T.lensFlares.length;C<A;C++){var P=T.lensFlares[C];P.opacity>.001&&P.scale>.001&&(_.x=P.x,_.y=P.y,_.z=P.z,x=P.size*P.scale/f.w,b.x=x*v,b.y=x,d.uniform3f(c.screenPosition,_.x,_.y,_.z),d.uniform2f(c.scale,b.x,b.y),d.uniform1f(c.rotation,P.rotation),d.uniform1f(c.opacity,P.opacity),d.uniform3f(c.color,P.color.r,P.color.g,P.color.b),p.setBlending(P.blending,P.blendEquation,P.blendSrc,P.blendDst),e.setTexture2D(P.texture,1),d.drawElements(d.TRIANGLES,6,d.UNSIGNED_SHORT,0))}}}p.enable(d.CULL_FACE),p.enable(d.DEPTH_TEST),p.buffers.depth.setMask(!0),e.resetGLState()}}}function SpritePlugin(e,t){function i(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),t=new Uint16Array([0,1,2,0,2,3]);o=u.createBuffer(),a=u.createBuffer(),u.bindBuffer(u.ARRAY_BUFFER,o),u.bufferData(u.ARRAY_BUFFER,e,u.STATIC_DRAW),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,a),u.bufferData(u.ELEMENT_ARRAY_BUFFER,t,u.STATIC_DRAW),s=r(),l={position:u.getAttribLocation(s,"position"),uv:u.getAttribLocation(s,"uv")},c={uvOffset:u.getUniformLocation(s,"uvOffset"),uvScale:u.getUniformLocation(s,"uvScale"),rotation:u.getUniformLocation(s,"rotation"),scale:u.getUniformLocation(s,"scale"),color:u.getUniformLocation(s,"color"),map:u.getUniformLocation(s,"map"),opacity:u.getUniformLocation(s,"opacity"),modelViewMatrix:u.getUniformLocation(s,"modelViewMatrix"),projectionMatrix:u.getUniformLocation(s,"projectionMatrix"),fogType:u.getUniformLocation(s,"fogType"),fogDensity:u.getUniformLocation(s,"fogDensity"),fogNear:u.getUniformLocation(s,"fogNear"),fogFar:u.getUniformLocation(s,"fogFar"),fogColor:u.getUniformLocation(s,"fogColor"),alphaTest:u.getUniformLocation(s,"alphaTest")};var i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");i.width=8,i.height=8;var n=i.getContext("2d");n.fillStyle="white",n.fillRect(0,0,8,8),h=new Texture(i),h.needsUpdate=!0}function r(){var t=u.createProgram(),i=u.createShader(u.VERTEX_SHADER),r=u.createShader(u.FRAGMENT_SHADER);return u.shaderSource(i,["precision "+e.getPrecision()+" float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),u.shaderSource(r,["precision "+e.getPrecision()+" float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),u.compileShader(i),u.compileShader(r),u.attachShader(t,i),u.attachShader(t,r),u.linkProgram(t),t}function n(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}var o,a,s,l,c,h,u=e.context,d=e.state,p=new Vector3,f=new Quaternion,m=new Vector3;this.render=function(r,v){if(0!==t.length){void 0===s&&i(),u.useProgram(s),d.initAttributes(),d.enableAttribute(l.position),d.enableAttribute(l.uv),d.disableUnusedAttributes(),d.disable(u.CULL_FACE),d.enable(u.BLEND),u.bindBuffer(u.ARRAY_BUFFER,o),u.vertexAttribPointer(l.position,2,u.FLOAT,!1,16,0),u.vertexAttribPointer(l.uv,2,u.FLOAT,!1,16,8),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,a),u.uniformMatrix4fv(c.projectionMatrix,!1,v.projectionMatrix.elements),d.activeTexture(u.TEXTURE0),u.uniform1i(c.map,0);var g=0,y=0,x=r.fog;x?(u.uniform3f(c.fogColor,x.color.r,x.color.g,x.color.b),x.isFog?(u.uniform1f(c.fogNear,x.near),u.uniform1f(c.fogFar,x.far),u.uniform1i(c.fogType,1),g=1,y=1):x.isFogExp2&&(u.uniform1f(c.fogDensity,x.density),u.uniform1i(c.fogType,2),g=2,y=2)):(u.uniform1i(c.fogType,0),g=0,y=0);for(var b=0,_=t.length;b<_;b++){var w=t[b];w.modelViewMatrix.multiplyMatrices(v.matrixWorldInverse,w.matrixWorld),w.z=-w.modelViewMatrix.elements[14]}t.sort(n);for(var M=[],b=0,_=t.length;b<_;b++){var w=t[b],E=w.material;if(E.visible!==!1){u.uniform1f(c.alphaTest,E.alphaTest),u.uniformMatrix4fv(c.modelViewMatrix,!1,w.modelViewMatrix.elements),w.matrixWorld.decompose(p,f,m),M[0]=m.x,M[1]=m.y;var S=0;r.fog&&E.fog&&(S=y),g!==S&&(u.uniform1i(c.fogType,S),g=S),null!==E.map?(u.uniform2f(c.uvOffset,E.map.offset.x,E.map.offset.y),u.uniform2f(c.uvScale,E.map.repeat.x,E.map.repeat.y)):(u.uniform2f(c.uvOffset,0,0),u.uniform2f(c.uvScale,1,1)),u.uniform1f(c.opacity,E.opacity),u.uniform3f(c.color,E.color.r,E.color.g,E.color.b),u.uniform1f(c.rotation,E.rotation),u.uniform2fv(c.scale,M),d.setBlending(E.blending,E.blendEquation,E.blendSrc,E.blendDst),d.buffers.depth.setTest(E.depthTest),d.buffers.depth.setMask(E.depthWrite),E.map?e.setTexture2D(E.map,0):e.setTexture2D(h,0),u.drawElements(u.TRIANGLES,6,u.UNSIGNED_SHORT,0)}}d.enable(u.CULL_FACE),e.resetGLState()}}}function Material(){Object.defineProperty(this,"id",{value:materialId++}),this.uuid=_Math.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=NormalBlending,this.side=FrontSide,this.shading=SmoothShading,this.vertexColors=NoColors,this.opacity=1,this.transparent=!1,this.blendSrc=SrcAlphaFactor,this.blendDst=OneMinusSrcAlphaFactor,this.blendEquation=AddEquation,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.needsUpdate=!0}function ShaderMaterial(e){Material.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function MeshDepthMaterial(e){Material.call(this),this.type="MeshDepthMaterial",this.depthPacking=BasicDepthPacking,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function Box3(e,t){this.min=void 0!==e?e:new Vector3(+(1/0),+(1/0),+(1/0)),this.max=void 0!==t?t:new Vector3(-(1/0),-(1/0),-(1/0))}function Sphere(e,t){this.center=void 0!==e?e:new Vector3,this.radius=void 0!==t?t:0}function Matrix3(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function Plane(e,t){this.normal=void 0!==e?e:new Vector3(1,0,0),this.constant=void 0!==t?t:0}function Frustum(e,t,i,r,n,o){this.planes=[void 0!==e?e:new Plane,void 0!==t?t:new Plane,void 0!==i?i:new Plane,void 0!==r?r:new Plane,void 0!==n?n:new Plane,void 0!==o?o:new Plane]}function WebGLShadowMap(e,t,i,r){function n(t,i,r,n){var o=t.geometry,a=null,s=y,l=t.customDepthMaterial;if(r&&(s=x,l=t.customDistanceMaterial),l)a=l;else{var c=!1;i.morphTargets&&(o&&o.isBufferGeometry?c=o.morphAttributes&&o.morphAttributes.position&&o.morphAttributes.position.length>0:o&&o.isGeometry&&(c=o.morphTargets&&o.morphTargets.length>0)),t.isSkinnedMesh&&i.skinning===!1&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t);var h=t.isSkinnedMesh&&i.skinning,u=0;c&&(u|=m),h&&(u|=v),a=s[u]}if(e.localClippingEnabled&&i.clipShadows===!0&&0!==i.clippingPlanes.length){var d=a.uuid,p=i.uuid,f=b[d];void 0===f&&(f={},b[d]=f);var g=f[p];void 0===g&&(g=a.clone(),f[p]=g),a=g}a.visible=i.visible,a.wireframe=i.wireframe;var _=i.side;return B.renderSingleSided&&_==DoubleSide&&(_=FrontSide),B.renderReverseSided&&(_===FrontSide?_=BackSide:_===BackSide&&(_=FrontSide)),a.side=_,a.clipShadows=i.clipShadows,a.clippingPlanes=i.clippingPlanes,a.wireframeLinewidth=i.wireframeLinewidth,a.linewidth=i.linewidth,r&&void 0!==a.uniforms.lightPos&&a.uniforms.lightPos.value.copy(n),a}function o(t,r,a,s){if(t.visible!==!1){var c=t.layers.test(r.layers);if(c&&(t.isMesh||t.isLine||t.isPoints)&&t.castShadow&&(!t.frustumCulled||l.intersectsObject(t))){t.modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,t.matrixWorld);var h=i.update(t),u=t.material;if(Array.isArray(u))for(var d=h.groups,p=0,m=d.length;p<m;p++){var v=d[p],g=u[v.materialIndex];if(g&&g.visible){var y=n(t,g,s,f);e.renderBufferDirect(a,null,h,y,t,v)}}else if(u.visible){var y=n(t,u,s,f);e.renderBufferDirect(a,null,h,y,t,null)}}for(var x=t.children,b=0,_=x.length;b<_;b++)o(x[b],r,a,s)}}var a=e.context,s=e.state,l=new Frustum,c=new Matrix4,h=t.shadows,u=new Vector2,d=new Vector2(r.maxTextureSize,r.maxTextureSize),p=new Vector3,f=new Vector3,m=1,v=2,g=(m|v)+1,y=new Array(g),x=new Array(g),b={},_=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,1,0),new Vector3(0,-1,0)],w=[new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,0,1),new Vector3(0,0,-1)],M=[new Vector4,new Vector4,new Vector4,new Vector4,new Vector4,new Vector4],E=new MeshDepthMaterial;E.depthPacking=RGBADepthPacking,E.clipping=!0;for(var S=ShaderLib.distanceRGBA,T=UniformsUtils.clone(S.uniforms),C=0;C!==g;++C){var A=0!==(C&m),P=0!==(C&v),R=E.clone();R.morphTargets=A,R.skinning=P,y[C]=R;var L=new ShaderMaterial({defines:{USE_SHADOWMAP:""},uniforms:T,vertexShader:S.vertexShader,fragmentShader:S.fragmentShader,morphTargets:A,skinning:P,clipping:!0});x[C]=L}var B=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=PCFShadowMap,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(t,i){if(B.enabled!==!1&&(B.autoUpdate!==!1||B.needsUpdate!==!1)&&0!==h.length){s.disable(a.BLEND),s.buffers.color.setClear(1,1,1,1),s.buffers.depth.setTest(!0),s.setScissorTest(!1);for(var r,n,m=0,v=h.length;m<v;m++){var g=h[m],y=g.shadow;if(void 0!==y){var x=y.camera,b=y.matrix;if(f.setFromMatrixPosition(g.matrixWorld),x.position.copy(f),u.copy(y.mapSize),u.min(d),g&&g.isPointLight){r=6,n=!0;var E=u.x,S=u.y;M[0].set(2*E,S,E,S),M[1].set(0,S,E,S),M[2].set(3*E,S,E,S),M[3].set(E,S,E,S),M[4].set(3*E,0,E,S),M[5].set(E,0,E,S),u.x*=4,u.y*=2,b.makeTranslation(-f.x,-f.y,-f.z)}else r=1,n=!1,p.setFromMatrixPosition(g.target.matrixWorld),x.lookAt(p),x.updateMatrixWorld(),x.matrixWorldInverse.getInverse(x.matrixWorld),b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(x.projectionMatrix),b.multiply(x.matrixWorldInverse);if(null===y.map){var T={minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat};y.map=new WebGLRenderTarget(u.x,u.y,T),y.map.texture.name=g.name+".shadowMap",x.updateProjectionMatrix()}y.isSpotLightShadow&&y.update(g);var C=y.map;e.setRenderTarget(C),e.clear();for(var A=0;A<r;A++){if(n){p.copy(x.position),p.add(_[A]),x.up.copy(w[A]),x.lookAt(p),x.updateMatrixWorld(),x.matrixWorldInverse.getInverse(x.matrixWorld);var P=M[A];s.viewport(P)}c.multiplyMatrices(x.projectionMatrix,x.matrixWorldInverse),l.setFromMatrix(c),o(t,i,x,n)}}else console.warn("THREE.WebGLShadowMap:",g,"has no shadow.")}var R=e.getClearColor(),L=e.getClearAlpha();e.setClearColor(R,L),B.needsUpdate=!1}}}function Ray(e,t){this.origin=void 0!==e?e:new Vector3,this.direction=void 0!==t?t:new Vector3}function Euler(e,t,i,r){this._x=e||0,this._y=t||0,this._z=i||0,this._order=r||Euler.DefaultOrder}function Layers(){this.mask=1}function Object3D(){function e(){n.setFromEuler(r,!1)}function t(){r.setFromQuaternion(n,void 0,!1)}Object.defineProperty(this,"id",{value:object3DId++}),this.uuid=_Math.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DefaultUp.clone();var i=new Vector3,r=new Euler,n=new Quaternion,o=new Vector3(1,1,1);r.onChange(e),n.onChange(t),Object.defineProperties(this,{position:{enumerable:!0,value:i},rotation:{enumerable:!0,value:r},quaternion:{enumerable:!0,value:n},scale:{enumerable:!0,value:o},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.onBeforeRender=function(){},this.onAfterRender=function(){}}function Line3(e,t){this.start=void 0!==e?e:new Vector3,this.end=void 0!==t?t:new Vector3}function Triangle(e,t,i){this.a=void 0!==e?e:new Vector3,this.b=void 0!==t?t:new Vector3,this.c=void 0!==i?i:new Vector3}function Face3(e,t,i,r,n,o){this.a=e,this.b=t,this.c=i,this.normal=r&&r.isVector3?r:new Vector3,this.vertexNormals=Array.isArray(r)?r:[],this.color=n&&n.isColor?n:new Color,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=void 0!==o?o:0}function MeshBasicMaterial(e){Material.call(this),this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function BufferAttribute(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=_Math.generateUUID(),this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=i===!0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function Uint16BufferAttribute(e,t){BufferAttribute.call(this,new Uint16Array(e),t)}function Uint32BufferAttribute(e,t){BufferAttribute.call(this,new Uint32Array(e),t)}function Float32BufferAttribute(e,t){BufferAttribute.call(this,new Float32Array(e),t)}function DirectGeometry(){this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function arrayMax(e){if(0===e.length)return-(1/0);for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]>t&&(t=e[i]);return t}function GeometryIdCount(){return count++}function Geometry(){Object.defineProperty(this,"id",{value:GeometryIdCount()}),this.uuid=_Math.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function BufferGeometry(){Object.defineProperty(this,"id",{value:GeometryIdCount()}),this.uuid=_Math.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function Mesh(e,t){Object3D.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new MeshBasicMaterial({color:16777215*Math.random()}),this.drawMode=TrianglesDrawMode,this.updateMorphTargets()}function BoxGeometry(e,t,i,r,n,o){Geometry.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:r,heightSegments:n,depthSegments:o},this.fromBufferGeometry(new BoxBufferGeometry(e,t,i,r,n,o)),this.mergeVertices()}function BoxBufferGeometry(e,t,i,r,n,o){function a(e,t,i,r,n,o,a,f,m,v,g){var y,x,b=o/m,_=a/v,w=o/2,M=a/2,E=f/2,S=m+1,T=v+1,C=0,A=0,P=new Vector3;for(x=0;x<T;x++){var R=x*_-M;for(y=0;y<S;y++){var L=y*b-w;P[e]=L*r,P[t]=R*n,P[i]=E,c.push(P.x,P.y,P.z),P[e]=0,P[t]=0,P[i]=f>0?1:-1,h.push(P.x,P.y,P.z),
u.push(y/m),u.push(1-x/v),C+=1}}for(x=0;x<v;x++)for(y=0;y<m;y++){var B=d+y+S*x,O=d+y+S*(x+1),I=d+(y+1)+S*(x+1),D=d+(y+1)+S*x;l.push(B,O,D),l.push(O,I,D),A+=6}s.addGroup(p,A,g),p+=A,d+=C}BufferGeometry.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:r,heightSegments:n,depthSegments:o};var s=this;r=Math.floor(r)||1,n=Math.floor(n)||1,o=Math.floor(o)||1;var l=[],c=[],h=[],u=[],d=0,p=0;a("z","y","x",-1,-1,i,t,e,o,n,0),a("z","y","x",1,-1,i,t,-e,o,n,1),a("x","z","y",1,1,e,i,t,r,o,2),a("x","z","y",1,-1,e,i,-t,r,o,3),a("x","y","z",1,-1,e,t,i,r,n,4),a("x","y","z",-1,-1,e,t,-i,r,n,5),this.setIndex(l),this.addAttribute("position",new Float32BufferAttribute(c,3)),this.addAttribute("normal",new Float32BufferAttribute(h,3)),this.addAttribute("uv",new Float32BufferAttribute(u,2))}function PlaneGeometry(e,t,i,r){Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:r},this.fromBufferGeometry(new PlaneBufferGeometry(e,t,i,r)),this.mergeVertices()}function PlaneBufferGeometry(e,t,i,r){BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:r};var n,o,a=e/2,s=t/2,l=Math.floor(i)||1,c=Math.floor(r)||1,h=l+1,u=c+1,d=e/l,p=t/c,f=[],m=[],v=[],g=[];for(o=0;o<u;o++){var y=o*p-s;for(n=0;n<h;n++){var x=n*d-a;m.push(x,-y,0),v.push(0,0,1),g.push(n/l),g.push(1-o/c)}}for(o=0;o<c;o++)for(n=0;n<l;n++){var b=n+h*o,_=n+h*(o+1),w=n+1+h*(o+1),M=n+1+h*o;f.push(b,_,M),f.push(_,w,M)}this.setIndex(f),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(v,3)),this.addAttribute("uv",new Float32BufferAttribute(g,2))}function Camera(){Object3D.call(this),this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4}function PerspectiveCamera(e,t,i,r){Camera.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==i?i:.1,this.far=void 0!==r?r:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function OrthographicCamera(e,t,i,r,n,o){Camera.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=r,this.near=void 0!==n?n:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()}function WebGLAttributes(e){function t(t,i){var r=t.array,n=t.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,o=e.createBuffer();e.bindBuffer(i,o),e.bufferData(i,r,n),t.onUploadCallback();var a=e.FLOAT;return r instanceof Float32Array?a=e.FLOAT:r instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array"):r instanceof Uint16Array?a=e.UNSIGNED_SHORT:r instanceof Int16Array?a=e.SHORT:r instanceof Uint32Array?a=e.UNSIGNED_INT:r instanceof Int32Array?a=e.INT:r instanceof Int8Array?a=e.BYTE:r instanceof Uint8Array&&(a=e.UNSIGNED_BYTE),{buffer:o,type:a,bytesPerElement:r.BYTES_PER_ELEMENT,version:t.version}}function i(t,i,r){var n=i.array,o=i.updateRange;e.bindBuffer(r,t),i.dynamic===!1?e.bufferData(r,n,e.STATIC_DRAW):o.count===-1?e.bufferSubData(r,0,n):0===o.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(r,o.offset*n.BYTES_PER_ELEMENT,n.subarray(o.offset,o.offset+o.count)),o.count=0)}function r(e){return e.isInterleavedBufferAttribute&&(e=e.data),a[e.uuid]}function n(t){var i=a[t.uuid];i&&(e.deleteBuffer(i.buffer),delete a[t.uuid])}function o(e,r){e.isInterleavedBufferAttribute&&(e=e.data);var n=a[e.uuid];void 0===n?a[e.uuid]=t(e,r):n.version<e.version&&(i(n.buffer,e,r),n.version=e.version)}var a={};return{get:r,remove:n,update:o}}function painterSortStable(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program&&t.program&&e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function reversePainterSortStable(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function WebGLRenderList(){function e(){o=-1,s=-1}function t(e,t,i,r,l){var c,h;i.transparent?(c=a,h=++s):(c=n,h=++o);var u=c[h];u?(u.id=e.id,u.object=e,u.geometry=t,u.material=i,u.program=i.program,u.renderOrder=e.renderOrder,u.z=r,u.group=l):(u={id:e.id,object:e,geometry:t,material:i,program:i.program,renderOrder:e.renderOrder,z:r,group:l},c.push(u))}function i(){n.length=o+1,a.length=s+1}function r(){n.sort(painterSortStable),a.sort(reversePainterSortStable)}var n=[],o=-1,a=[],s=-1;return{opaque:n,transparent:a,init:e,push:t,finish:i,sort:r}}function WebGLRenderLists(){function e(e,t){var r=e.id+","+t.id,n=i[r];return void 0===n&&(n=new WebGLRenderList,i[r]=n),n}function t(){i={}}var i={};return{get:e,dispose:t}}function WebGLIndexedBufferRenderer(e,t,i){function r(e){s=e}function n(i){i.array instanceof Uint32Array&&t.get("OES_element_index_uint")?(l=e.UNSIGNED_INT,c=4):i.array instanceof Uint16Array?(l=e.UNSIGNED_SHORT,c=2):(l=e.UNSIGNED_BYTE,c=1)}function o(t,r){e.drawElements(s,r,l,t*c),i.calls++,i.vertices+=r,s===e.TRIANGLES&&(i.faces+=r/3)}function a(r,n,o){var a=t.get("ANGLE_instanced_arrays");return null===a?void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays."):(a.drawElementsInstancedANGLE(s,o,l,n*c,r.maxInstancedCount),i.calls++,i.vertices+=o*r.maxInstancedCount,void(s===e.TRIANGLES&&(i.faces+=r.maxInstancedCount*o/3)))}var s,l,c;this.setMode=r,this.setIndex=n,this.render=o,this.renderInstances=a}function WebGLBufferRenderer(e,t,i){function r(e){a=e}function n(t,r){e.drawArrays(a,t,r),i.calls++,i.vertices+=r,a===e.TRIANGLES&&(i.faces+=r/3)}function o(r,n,o){var s=t.get("ANGLE_instanced_arrays");if(null===s)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");var l=r.attributes.position;l.isInterleavedBufferAttribute?(o=l.data.count,s.drawArraysInstancedANGLE(a,0,o,r.maxInstancedCount)):s.drawArraysInstancedANGLE(a,n,o,r.maxInstancedCount),i.calls++,i.vertices+=o*r.maxInstancedCount,a===e.TRIANGLES&&(i.faces+=r.maxInstancedCount*o/3)}var a;this.setMode=r,this.render=n,this.renderInstances=o}function WebGLGeometries(e,t,i){function r(e){var n=e.target,o=s[n.id];null!==o.index&&t.remove(o.index);for(var a in o.attributes)t.remove(o.attributes[a]);n.removeEventListener("dispose",r),delete s[n.id];var c=l[n.id];c&&(t.remove(c),delete l[n.id]),c=l[o.id],c&&(t.remove(c),delete l[o.id]),i.geometries--}function n(e,t){var n=s[t.id];return n?n:(t.addEventListener("dispose",r),t.isBufferGeometry?n=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new BufferGeometry).setFromObject(e)),n=t._bufferGeometry),s[t.id]=n,i.geometries++,n)}function o(i){var r=i.index,n=i.attributes;null!==r&&t.update(r,e.ELEMENT_ARRAY_BUFFER);for(var o in n)t.update(n[o],e.ARRAY_BUFFER);var a=i.morphAttributes;for(var o in a)for(var s=a[o],l=0,c=s.length;l<c;l++)t.update(s[l],e.ARRAY_BUFFER)}function a(i){var r=l[i.id];if(r)return r;var n=[],o=i.index,a=i.attributes;if(null!==o)for(var s=o.array,c=0,h=s.length;c<h;c+=3){var u=s[c+0],d=s[c+1],p=s[c+2];n.push(u,d,d,p,p,u)}else for(var s=a.position.array,c=0,h=s.length/3-1;c<h;c+=3){var u=c+0,d=c+1,p=c+2;n.push(u,d,d,p,p,u)}return r=new(arrayMax(n)>65535?Uint32BufferAttribute:Uint16BufferAttribute)(n,1),t.update(r,e.ELEMENT_ARRAY_BUFFER),l[i.id]=r,r}var s={},l={};return{get:n,update:o,getWireframeAttribute:a}}function WebGLLights(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var i;switch(t.type){case"DirectionalLight":i={direction:new Vector3,color:new Color,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"SpotLight":i={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":i={position:new Vector3,color:new Color,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"HemisphereLight":i={direction:new Vector3,skyColor:new Color,groundColor:new Color};break;case"RectAreaLight":i={color:new Color,position:new Vector3,halfWidth:new Vector3,halfHeight:new Vector3}}return e[t.id]=i,i}}}function WebGLObjects(e,t,i){function r(e){var r=i.frame,n=e.geometry,a=t.get(e,n);return o[a.id]!==r&&(n.isGeometry&&a.updateFromObject(e),t.update(a),o[a.id]=r),a}function n(){o={}}var o={};return{update:r,clear:n}}function addLineNumbers(e){for(var t=e.split("\n"),i=0;i<t.length;i++)t[i]=i+1+": "+t[i];return t.join("\n")}function WebGLShader(e,t,i){var r=e.createShader(t);return e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)===!1&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(r)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(r),addLineNumbers(i)),r}function getEncodingComponents(e){switch(e){case LinearEncoding:return["Linear","( value )"];case sRGBEncoding:return["sRGB","( value )"];case RGBEEncoding:return["RGBE","( value )"];case RGBM7Encoding:return["RGBM","( value, 7.0 )"];case RGBM16Encoding:return["RGBM","( value, 16.0 )"];case RGBDEncoding:return["RGBD","( value, 256.0 )"];case GammaEncoding:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function getTexelDecodingFunction(e,t){var i=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function getTexelEncodingFunction(e,t){var i=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function getToneMappingFunction(e,t){var i;switch(t){case LinearToneMapping:i="Linear";break;case ReinhardToneMapping:i="Reinhard";break;case Uncharted2ToneMapping:i="Uncharted2";break;case CineonToneMapping:i="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function generateExtensions(e,t,i){e=e||{};var r=[e.derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&i.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&i.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&i.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""];return r.filter(filterEmptyLine).join("\n")}function generateDefines(e){var t=[];for(var i in e){var r=e[i];r!==!1&&t.push("#define "+i+" "+r)}return t.join("\n")}function fetchAttributeLocations(e,t,i){for(var r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),o=0;o<n;o++){var a=e.getActiveAttrib(t,o),s=a.name;r[s]=e.getAttribLocation(t,s)}return r}function filterEmptyLine(e){return""!==e}function replaceLightNums(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function parseIncludes(e){function t(e,t){var i=ShaderChunk[t];if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return parseIncludes(i)}var i=/^[ \t]*#include +<([\w\d.]+)>/gm;return e.replace(i,t)}function unrollLoops(e){function t(e,t,i,r){for(var n="",o=parseInt(t);o<parseInt(i);o++)n+=r.replace(/\[ i \]/g,"[ "+o+" ]");return n}var i=/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g;return e.replace(i,t)}function WebGLProgram(e,t,i,r){var n=e.context,o=i.extensions,a=i.defines,s=i.__webglShader.vertexShader,l=i.__webglShader.fragmentShader,c="SHADOWMAP_TYPE_BASIC";r.shadowMapType===PCFShadowMap?c="SHADOWMAP_TYPE_PCF":r.shadowMapType===PCFSoftShadowMap&&(c="SHADOWMAP_TYPE_PCF_SOFT");var h="ENVMAP_TYPE_CUBE",u="ENVMAP_MODE_REFLECTION",d="ENVMAP_BLENDING_MULTIPLY";if(r.envMap){switch(i.envMap.mapping){case CubeReflectionMapping:case CubeRefractionMapping:h="ENVMAP_TYPE_CUBE";break;case CubeUVReflectionMapping:case CubeUVRefractionMapping:h="ENVMAP_TYPE_CUBE_UV";break;case EquirectangularReflectionMapping:case EquirectangularRefractionMapping:h="ENVMAP_TYPE_EQUIREC";break;case SphericalReflectionMapping:h="ENVMAP_TYPE_SPHERE"}switch(i.envMap.mapping){case CubeRefractionMapping:case EquirectangularRefractionMapping:u="ENVMAP_MODE_REFRACTION"}switch(i.combine){case MultiplyOperation:d="ENVMAP_BLENDING_MULTIPLY";break;case MixOperation:d="ENVMAP_BLENDING_MIX";break;case AddOperation:d="ENVMAP_BLENDING_ADD"}}var p,f,m=e.gammaFactor>0?e.gammaFactor:1,v=generateExtensions(o,r,e.extensions),g=generateDefines(a),y=n.createProgram();i.isRawShaderMaterial?(p=[g,"\n"].filter(filterEmptyLine).join("\n"),f=[v,g,"\n"].filter(filterEmptyLine).join("\n")):(p=["precision "+r.precision+" float;","precision "+r.precision+" int;","#define SHADER_NAME "+i.__webglShader.name,g,r.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+m,"#define MAX_BONES "+r.maxBones,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+u:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.displacementMap&&r.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.vertexColors?"#define USE_COLOR":"",r.flatShading?"#define FLAT_SHADED":"",r.skinning?"#define USE_SKINNING":"",r.useVertexTexture?"#define BONE_TEXTURE":"",r.morphTargets?"#define USE_MORPHTARGETS":"",r.morphNormals&&r.flatShading===!1?"#define USE_MORPHNORMALS":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+r.numClippingPlanes,r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+c:"",r.sizeAttenuation?"#define USE_SIZEATTENUATION":"",r.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",r.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(filterEmptyLine).join("\n"),f=[v,"precision "+r.precision+" float;","precision "+r.precision+" int;","#define SHADER_NAME "+i.__webglShader.name,g,r.alphaTest?"#define ALPHATEST "+r.alphaTest:"","#define GAMMA_FACTOR "+m,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+h:"",r.envMap?"#define "+u:"",r.envMap?"#define "+d:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.vertexColors?"#define USE_COLOR":"",r.gradientMap?"#define USE_GRADIENTMAP":"",r.flatShading?"#define FLAT_SHADED":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+r.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(r.numClippingPlanes-r.numClipIntersection),r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+c:"",r.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",r.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",r.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",r.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",r.envMap&&e.extensions.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",r.toneMapping!==NoToneMapping?"#define TONE_MAPPING":"",r.toneMapping!==NoToneMapping?ShaderChunk.tonemapping_pars_fragment:"",r.toneMapping!==NoToneMapping?getToneMappingFunction("toneMapping",r.toneMapping):"",r.dithering?"#define DITHERING":"",r.outputEncoding||r.mapEncoding||r.envMapEncoding||r.emissiveMapEncoding?ShaderChunk.encodings_pars_fragment:"",r.mapEncoding?getTexelDecodingFunction("mapTexelToLinear",r.mapEncoding):"",r.envMapEncoding?getTexelDecodingFunction("envMapTexelToLinear",r.envMapEncoding):"",r.emissiveMapEncoding?getTexelDecodingFunction("emissiveMapTexelToLinear",r.emissiveMapEncoding):"",r.outputEncoding?getTexelEncodingFunction("linearToOutputTexel",r.outputEncoding):"",r.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(filterEmptyLine).join("\n")),s=parseIncludes(s,r),s=replaceLightNums(s,r),l=parseIncludes(l,r),l=replaceLightNums(l,r),i.isShaderMaterial||(s=unrollLoops(s),l=unrollLoops(l));var x=p+s,b=f+l,_=WebGLShader(n,n.VERTEX_SHADER,x),w=WebGLShader(n,n.FRAGMENT_SHADER,b);n.attachShader(y,_),n.attachShader(y,w),void 0!==i.index0AttributeName?n.bindAttribLocation(y,0,i.index0AttributeName):r.morphTargets===!0&&n.bindAttribLocation(y,0,"position"),n.linkProgram(y);var M=n.getProgramInfoLog(y),E=n.getShaderInfoLog(_),S=n.getShaderInfoLog(w),T=!0,C=!0;n.getProgramParameter(y,n.LINK_STATUS)===!1?(T=!1,console.error("THREE.WebGLProgram: shader error: ",n.getError(),"gl.VALIDATE_STATUS",n.getProgramParameter(y,n.VALIDATE_STATUS),"gl.getProgramInfoLog",M,E,S)):""!==M?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",M):""!==E&&""!==S||(C=!1),C&&(this.diagnostics={runnable:T,material:i,programLog:M,vertexShader:{log:E,prefix:p},fragmentShader:{log:S,prefix:f}}),n.deleteShader(_),n.deleteShader(w);var A;this.getUniforms=function(){return void 0===A&&(A=new WebGLUniforms(n,y,e)),A};var P;return this.getAttributes=function(){return void 0===P&&(P=fetchAttributeLocations(n,y)),P},this.destroy=function(){n.deleteProgram(y),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=programIdCount++,this.code=t,this.usedTimes=1,this.program=y,this.vertexShader=_,this.fragmentShader=w,this}function WebGLPrograms(e,t){function i(e){var i=e.skeleton,r=i.bones;if(t.floatVertexTextures)return 1024;var n=t.maxVertexUniforms,o=Math.floor((n-20)/4),a=Math.min(o,r.length);return a<r.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+r.length+" bones. This GPU supports "+a+"."),0):a}function r(e,t){var i;return e?e.isTexture?i=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),i=e.texture.encoding):i=LinearEncoding,i===LinearEncoding&&t&&(i=GammaEncoding),i}var n=[],o={MeshDepthMaterial:"depth",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points"},a=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];this.getParameters=function(n,a,s,l,c,h){var u=o[n.type],d=h.isSkinnedMesh?i(h):0,p=e.getPrecision();null!==n.precision&&(p=t.getMaxPrecision(n.precision),p!==n.precision&&console.warn("THREE.WebGLProgram.getParameters:",n.precision,"not supported, using",p,"instead."));var f=e.getRenderTarget(),m={shaderID:u,precision:p,supportsVertexTextures:t.vertexTextures,outputEncoding:r(f?f.texture:null,e.gammaOutput),map:!!n.map,mapEncoding:r(n.map,e.gammaInput),envMap:!!n.envMap,envMapMode:n.envMap&&n.envMap.mapping,envMapEncoding:r(n.envMap,e.gammaInput),envMapCubeUV:!!n.envMap&&(n.envMap.mapping===CubeUVReflectionMapping||n.envMap.mapping===CubeUVRefractionMapping),lightMap:!!n.lightMap,aoMap:!!n.aoMap,emissiveMap:!!n.emissiveMap,emissiveMapEncoding:r(n.emissiveMap,e.gammaInput),bumpMap:!!n.bumpMap,normalMap:!!n.normalMap,displacementMap:!!n.displacementMap,roughnessMap:!!n.roughnessMap,metalnessMap:!!n.metalnessMap,specularMap:!!n.specularMap,alphaMap:!!n.alphaMap,gradientMap:!!n.gradientMap,combine:n.combine,vertexColors:n.vertexColors,fog:!!s,useFog:n.fog,fogExp:s&&s.isFogExp2,flatShading:n.shading===FlatShading,sizeAttenuation:n.sizeAttenuation,logarithmicDepthBuffer:t.logarithmicDepthBuffer,skinning:n.skinning&&d>0,maxBones:d,useVertexTexture:t.floatVertexTextures,morphTargets:n.morphTargets,morphNormals:n.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numClippingPlanes:l,numClipIntersection:c,dithering:n.dithering,shadowMapEnabled:e.shadowMap.enabled&&h.receiveShadow&&a.shadows.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:n.premultipliedAlpha,alphaTest:n.alphaTest,doubleSided:n.side===DoubleSide,flipSided:n.side===BackSide,depthPacking:void 0!==n.depthPacking&&n.depthPacking};return m},this.getProgramCode=function(e,t){var i=[];if(t.shaderID?i.push(t.shaderID):(i.push(e.fragmentShader),i.push(e.vertexShader)),void 0!==e.defines)for(var r in e.defines)i.push(r),i.push(e.defines[r]);for(var n=0;n<a.length;n++)i.push(t[a[n]]);return i.join()},this.acquireProgram=function(t,i,r){for(var o,a=0,s=n.length;a<s;a++){var l=n[a];if(l.code===r){o=l,++o.usedTimes;break}}return void 0===o&&(o=new WebGLProgram(e,r,t,i),n.push(o)),o},this.releaseProgram=function(e){if(0===--e.usedTimes){var t=n.indexOf(e);n[t]=n[n.length-1],n.pop(),e.destroy()}},this.programs=n}function WebGLTextures(e,t,i,r,n,o,a){function s(e,t){if(e.width>t||e.height>t){var i=t/Math.max(e.width,e.height),r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");r.width=Math.floor(e.width*i),r.height=Math.floor(e.height*i);var n=r.getContext("2d");return n.drawImage(e,0,0,e.width,e.height,0,0,r.width,r.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+r.width+"x"+r.height,e),r}return e}function l(e){return _Math.isPowerOfTwo(e.width)&&_Math.isPowerOfTwo(e.height)}function c(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");t.width=_Math.nearestPowerOfTwo(e.width),t.height=_Math.nearestPowerOfTwo(e.height);var i=t.getContext("2d");return i.drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}function h(e){return e.wrapS!==ClampToEdgeWrapping||e.wrapT!==ClampToEdgeWrapping||e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter}function u(t){return t===NearestFilter||t===NearestMipMapNearestFilter||t===NearestMipMapLinearFilter?e.NEAREST:e.LINEAR}function d(e){var t=e.target;t.removeEventListener("dispose",d),f(t),a.textures--}function p(e){var t=e.target;t.removeEventListener("dispose",p),m(t),a.textures--}function f(t){var i=r.get(t);if(t.image&&i.__image__webglTextureCube)e.deleteTexture(i.__image__webglTextureCube);else{if(void 0===i.__webglInit)return;e.deleteTexture(i.__webglTexture)}r.remove(t)}function m(t){var i=r.get(t),n=r.get(t.texture);if(t){if(void 0!==n.__webglTexture&&e.deleteTexture(n.__webglTexture),t.depthTexture&&t.depthTexture.dispose(),t.isWebGLRenderTargetCube)for(var o=0;o<6;o++)e.deleteFramebuffer(i.__webglFramebuffer[o]),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[o]);else e.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer);r.remove(t.texture),r.remove(t)}}function v(t,n){var o=r.get(t);if(t.version>0&&o.__version!==t.version){var a=t.image;if(void 0===a)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(a.complete!==!1)return void b(o,t,n);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}i.activeTexture(e.TEXTURE0+n),i.bindTexture(e.TEXTURE_2D,o.__webglTexture)}function g(t,c){var h=r.get(t);if(6===t.image.length)if(t.version>0&&h.__version!==t.version){h.__image__webglTextureCube||(t.addEventListener("dispose",d),h.__image__webglTextureCube=e.createTexture(),a.textures++),i.activeTexture(e.TEXTURE0+c),i.bindTexture(e.TEXTURE_CUBE_MAP,h.__image__webglTextureCube),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var u=t&&t.isCompressedTexture,p=t.image[0]&&t.image[0].isDataTexture,f=[],m=0;m<6;m++)u||p?f[m]=p?t.image[m].image:t.image[m]:f[m]=s(t.image[m],n.maxCubemapSize);var v=f[0],g=l(v),y=o(t.format),b=o(t.type);x(e.TEXTURE_CUBE_MAP,t,g);for(var m=0;m<6;m++)if(u)for(var _,w=f[m].mipmaps,M=0,E=w.length;M<E;M++)_=w[M],t.format!==RGBAFormat&&t.format!==RGBFormat?i.getCompressedTextureFormats().indexOf(y)>-1?i.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,M,y,_.width,_.height,0,_.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,M,y,_.width,_.height,0,y,b,_.data);else p?i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,y,f[m].width,f[m].height,0,y,b,f[m].data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,y,y,b,f[m]);t.generateMipmaps&&g&&e.generateMipmap(e.TEXTURE_CUBE_MAP),h.__version=t.version,t.onUpdate&&t.onUpdate(t)}else i.activeTexture(e.TEXTURE0+c),i.bindTexture(e.TEXTURE_CUBE_MAP,h.__image__webglTextureCube)}function y(t,n){i.activeTexture(e.TEXTURE0+n),i.bindTexture(e.TEXTURE_CUBE_MAP,r.get(t).__webglTexture)}function x(i,a,s){var l;if(s?(e.texParameteri(i,e.TEXTURE_WRAP_S,o(a.wrapS)),e.texParameteri(i,e.TEXTURE_WRAP_T,o(a.wrapT)),e.texParameteri(i,e.TEXTURE_MAG_FILTER,o(a.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,o(a.minFilter))):(e.texParameteri(i,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(i,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a.wrapS===ClampToEdgeWrapping&&a.wrapT===ClampToEdgeWrapping||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",a),e.texParameteri(i,e.TEXTURE_MAG_FILTER,u(a.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,u(a.minFilter)),a.minFilter!==NearestFilter&&a.minFilter!==LinearFilter&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",a)),l=t.get("EXT_texture_filter_anisotropic")){if(a.type===FloatType&&null===t.get("OES_texture_float_linear"))return;if(a.type===HalfFloatType&&null===t.get("OES_texture_half_float_linear"))return;(a.anisotropy>1||r.get(a).__currentAnisotropy)&&(e.texParameterf(i,l.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,n.getMaxAnisotropy())),r.get(a).__currentAnisotropy=a.anisotropy)}}function b(t,r,u){void 0===t.__webglInit&&(t.__webglInit=!0,r.addEventListener("dispose",d),t.__webglTexture=e.createTexture(),a.textures++),i.activeTexture(e.TEXTURE0+u),i.bindTexture(e.TEXTURE_2D,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,r.unpackAlignment);var p=s(r.image,n.maxTextureSize);h(r)&&l(p)===!1&&(p=c(p));var f=l(p),m=o(r.format),v=o(r.type);x(e.TEXTURE_2D,r,f);var g,y=r.mipmaps;if(r.isDepthTexture){var b=e.DEPTH_COMPONENT;if(r.type===FloatType){if(!C)throw new Error("Float Depth Texture only supported in WebGL2.0");b=e.DEPTH_COMPONENT32F}else C&&(b=e.DEPTH_COMPONENT16);r.format===DepthFormat&&b===e.DEPTH_COMPONENT&&r.type!==UnsignedShortType&&r.type!==UnsignedIntType&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),r.type=UnsignedShortType,v=o(r.type)),r.format===DepthStencilFormat&&(b=e.DEPTH_STENCIL,r.type!==UnsignedInt248Type&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),r.type=UnsignedInt248Type,v=o(r.type))),i.texImage2D(e.TEXTURE_2D,0,b,p.width,p.height,0,m,v,null)}else if(r.isDataTexture)if(y.length>0&&f){for(var _=0,w=y.length;_<w;_++)g=y[_],i.texImage2D(e.TEXTURE_2D,_,m,g.width,g.height,0,m,v,g.data);r.generateMipmaps=!1}else i.texImage2D(e.TEXTURE_2D,0,m,p.width,p.height,0,m,v,p.data);else if(r.isCompressedTexture)for(var _=0,w=y.length;_<w;_++)g=y[_],r.format!==RGBAFormat&&r.format!==RGBFormat?i.getCompressedTextureFormats().indexOf(m)>-1?i.compressedTexImage2D(e.TEXTURE_2D,_,m,g.width,g.height,0,g.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(e.TEXTURE_2D,_,m,g.width,g.height,0,m,v,g.data);else if(y.length>0&&f){for(var _=0,w=y.length;_<w;_++)g=y[_],i.texImage2D(e.TEXTURE_2D,_,m,m,v,g);r.generateMipmaps=!1}else i.texImage2D(e.TEXTURE_2D,0,m,m,v,p);r.generateMipmaps&&f&&e.generateMipmap(e.TEXTURE_2D),t.__version=r.version,r.onUpdate&&r.onUpdate(r)}function _(t,n,a,s){var l=o(n.texture.format),c=o(n.texture.type);i.texImage2D(s,0,l,n.width,n.height,0,l,c,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,a,s,r.get(n.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function w(t,i){e.bindRenderbuffer(e.RENDERBUFFER,t),i.depthBuffer&&!i.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)):i.depthBuffer&&i.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,i.width,i.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}function M(t,i){var n=i&&i.isWebGLRenderTargetCube;
if(n)throw new Error("Depth Texture with cube render targets is not supported!");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");r.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),v(i.depthTexture,0);var o=r.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===DepthFormat)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0);else{if(i.depthTexture.format!==DepthStencilFormat)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0)}}function E(t){var i=r.get(t),n=t.isWebGLRenderTargetCube===!0;if(t.depthTexture){if(n)throw new Error("target.depthTexture not supported in Cube render targets");M(i.__webglFramebuffer,t)}else if(n){i.__webglDepthbuffer=[];for(var o=0;o<6;o++)e.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[o]),i.__webglDepthbuffer[o]=e.createRenderbuffer(),w(i.__webglDepthbuffer[o],t)}else e.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer),i.__webglDepthbuffer=e.createRenderbuffer(),w(i.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}function S(t){var n=r.get(t),o=r.get(t.texture);t.addEventListener("dispose",p),o.__webglTexture=e.createTexture(),a.textures++;var s=t.isWebGLRenderTargetCube===!0,c=l(t);if(s){n.__webglFramebuffer=[];for(var h=0;h<6;h++)n.__webglFramebuffer[h]=e.createFramebuffer()}else n.__webglFramebuffer=e.createFramebuffer();if(s){i.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture),x(e.TEXTURE_CUBE_MAP,t.texture,c);for(var h=0;h<6;h++)_(n.__webglFramebuffer[h],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+h);t.texture.generateMipmaps&&c&&e.generateMipmap(e.TEXTURE_CUBE_MAP),i.bindTexture(e.TEXTURE_CUBE_MAP,null)}else i.bindTexture(e.TEXTURE_2D,o.__webglTexture),x(e.TEXTURE_2D,t.texture,c),_(n.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),t.texture.generateMipmaps&&c&&e.generateMipmap(e.TEXTURE_2D),i.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&E(t)}function T(t){var n=t.texture;if(n.generateMipmaps&&l(t)&&n.minFilter!==NearestFilter&&n.minFilter!==LinearFilter){var o=t&&t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,a=r.get(n).__webglTexture;i.bindTexture(o,a),e.generateMipmap(o),i.bindTexture(o,null)}}var C="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext;this.setTexture2D=v,this.setTextureCube=g,this.setTextureCubeDynamic=y,this.setupRenderTarget=S,this.updateRenderTargetMipmap=T}function WebGLProperties(){function e(e){var t=e.uuid,i=r[t];return void 0===i&&(i={},r[t]=i),i}function t(e){delete r[e.uuid]}function i(){r={}}var r={};return{get:e,remove:t,clear:i}}function WebGLState(e,t,i){function r(){var t=!1,i=new Vector4,r=null,n=new Vector4;return{setMask:function(i){r===i||t||(e.colorMask(i,i,i,i),r=i)},setLocked:function(e){t=e},setClear:function(t,r,o,a,s){s===!0&&(t*=a,r*=a,o*=a),i.set(t,r,o,a),n.equals(i)===!1&&(e.clearColor(t,r,o,a),n.copy(i))},reset:function(){t=!1,r=null,n.set(0,0,0,1)}}}function n(){var t=!1,i=null,r=null,n=null;return{setTest:function(t){t?d(e.DEPTH_TEST):p(e.DEPTH_TEST)},setMask:function(r){i===r||t||(e.depthMask(r),i=r)},setFunc:function(t){if(r!==t){if(t)switch(t){case NeverDepth:e.depthFunc(e.NEVER);break;case AlwaysDepth:e.depthFunc(e.ALWAYS);break;case LessDepth:e.depthFunc(e.LESS);break;case LessEqualDepth:e.depthFunc(e.LEQUAL);break;case EqualDepth:e.depthFunc(e.EQUAL);break;case GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case GreaterDepth:e.depthFunc(e.GREATER);break;case NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);r=t}},setLocked:function(e){t=e},setClear:function(t){n!==t&&(e.clearDepth(t),n=t)},reset:function(){t=!1,i=null,r=null,n=null}}}function o(){var t=!1,i=null,r=null,n=null,o=null,a=null,s=null,l=null,c=null;return{setTest:function(t){t?d(e.STENCIL_TEST):p(e.STENCIL_TEST)},setMask:function(r){i===r||t||(e.stencilMask(r),i=r)},setFunc:function(t,i,a){r===t&&n===i&&o===a||(e.stencilFunc(t,i,a),r=t,n=i,o=a)},setOp:function(t,i,r){a===t&&s===i&&l===r||(e.stencilOp(t,i,r),a=t,s=i,l=r)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,i=null,r=null,n=null,o=null,a=null,s=null,l=null,c=null}}}function a(t,i,r){var n=new Uint8Array(4),o=e.createTexture();e.bindTexture(t,o),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var a=0;a<r;a++)e.texImage2D(i+a,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,n);return o}function s(){R.setClear(0,0,0,1),L.setClear(1),B.setClear(0),d(e.DEPTH_TEST),L.setFunc(LessEqualDepth),g(!1),y(CullFaceBack),d(e.CULL_FACE),d(e.BLEND),m(NormalBlending)}function l(){for(var e=0,t=I.length;e<t;e++)I[e]=0}function c(i){if(I[i]=1,0===D[i]&&(e.enableVertexAttribArray(i),D[i]=1),0!==k[i]){var r=t.get("ANGLE_instanced_arrays");r.vertexAttribDivisorANGLE(i,0),k[i]=0}}function h(i,r){if(I[i]=1,0===D[i]&&(e.enableVertexAttribArray(i),D[i]=1),k[i]!==r){var n=t.get("ANGLE_instanced_arrays");n.vertexAttribDivisorANGLE(i,r),k[i]=r}}function u(){for(var t=0,i=D.length;t!==i;++t)D[t]!==I[t]&&(e.disableVertexAttribArray(t),D[t]=0)}function d(t){F[t]!==!0&&(e.enable(t),F[t]=!0)}function p(t){F[t]!==!1&&(e.disable(t),F[t]=!1)}function f(){if(null===N&&(N=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")))for(var i=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),r=0;r<i.length;r++)N.push(i[r]);return N}function m(t,r,n,o,a,s,l,c){t!==NoBlending?d(e.BLEND):p(e.BLEND),t===V&&c===q||(t===AdditiveBlending?c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE,e.ONE,e.ONE)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE)):t===SubtractiveBlending?c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR)):t===MultiplyBlending?c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR)):c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)),V=t,q=c),t===CustomBlending?(a=a||r,s=s||n,l=l||o,r===U&&a===j||(e.blendEquationSeparate(i(r),i(a)),U=r,j=a),n===G&&o===z&&s===H&&l===W||(e.blendFuncSeparate(i(n),i(o),i(s),i(l)),G=n,z=o,H=s,W=l)):(U=null,G=null,z=null,j=null,H=null,W=null)}function v(t){t.side===DoubleSide?p(e.CULL_FACE):d(e.CULL_FACE),g(t.side===BackSide),t.transparent===!0?m(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha):m(NoBlending),L.setFunc(t.depthFunc),L.setTest(t.depthTest),L.setMask(t.depthWrite),R.setMask(t.colorWrite),b(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)}function g(t){X!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),X=t)}function y(t){t!==CullFaceNone?(d(e.CULL_FACE),t!==Y&&(t===CullFaceBack?e.cullFace(e.BACK):t===CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):p(e.CULL_FACE),Y=t}function x(t){t!==K&&(te&&e.lineWidth(t),K=t)}function b(t,i,r){t?(d(e.POLYGON_OFFSET_FILL),Q===i&&Z===r||(e.polygonOffset(i,r),Q=i,Z=r)):p(e.POLYGON_OFFSET_FILL)}function _(){return J}function w(t){J=t,t?d(e.SCISSOR_TEST):p(e.SCISSOR_TEST)}function M(t){void 0===t&&(t=e.TEXTURE0+$-1),ie!==t&&(e.activeTexture(t),ie=t)}function E(t,i){null===ie&&M();var r=re[ie];void 0===r&&(r={type:void 0,texture:void 0},re[ie]=r),r.type===t&&r.texture===i||(e.bindTexture(t,i||ae[t]),r.type=t,r.texture=i)}function S(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error(e)}}function T(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error(e)}}function C(t){ne.equals(t)===!1&&(e.scissor(t.x,t.y,t.z,t.w),ne.copy(t))}function A(t){oe.equals(t)===!1&&(e.viewport(t.x,t.y,t.z,t.w),oe.copy(t))}function P(){for(var t=0;t<D.length;t++)1===D[t]&&(e.disableVertexAttribArray(t),D[t]=0);F={},N=null,ie=null,re={},V=null,X=null,Y=null,R.reset(),L.reset(),B.reset()}var R=new r,L=new n,B=new o,O=e.getParameter(e.MAX_VERTEX_ATTRIBS),I=new Uint8Array(O),D=new Uint8Array(O),k=new Uint8Array(O),F={},N=null,V=null,U=null,G=null,z=null,j=null,H=null,W=null,q=!1,X=null,Y=null,K=null,Q=null,Z=null,J=null,$=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),ee=parseFloat(/^WebGL\ ([0-9])/.exec(e.getParameter(e.VERSION))[1]),te=parseFloat(ee)>=1,ie=null,re={},ne=new Vector4,oe=new Vector4,ae={};return ae[e.TEXTURE_2D]=a(e.TEXTURE_2D,e.TEXTURE_2D,1),ae[e.TEXTURE_CUBE_MAP]=a(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),{buffers:{color:R,depth:L,stencil:B},init:s,initAttributes:l,enableAttribute:c,enableAttributeAndDivisor:h,disableUnusedAttributes:u,enable:d,disable:p,getCompressedTextureFormats:f,setBlending:m,setMaterial:v,setFlipSided:g,setCullFace:y,setLineWidth:x,setPolygonOffset:b,getScissorTest:_,setScissorTest:w,activeTexture:M,bindTexture:E,compressedTexImage2D:S,texImage2D:T,scissor:C,viewport:A,reset:P}}function WebGLCapabilities(e,t,i){function r(){if(void 0!==o)return o;var i=t.get("EXT_texture_filter_anisotropic");return o=null!==i?e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}function n(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var o,a=void 0!==i.precision?i.precision:"highp",s=n(a);s!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",s,"instead."),a=s);var l=i.logarithmicDepthBuffer===!0&&!!t.get("EXT_frag_depth"),c=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_TEXTURE_SIZE),d=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),p=e.getParameter(e.MAX_VERTEX_ATTRIBS),f=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),m=e.getParameter(e.MAX_VARYING_VECTORS),v=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),g=h>0,y=!!t.get("OES_texture_float"),x=g&&y;return{getMaxAnisotropy:r,getMaxPrecision:n,precision:a,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:h,maxTextureSize:u,maxCubemapSize:d,maxAttributes:p,maxVertexUniforms:f,maxVaryings:m,maxFragmentUniforms:v,vertexTextures:g,floatFragmentTextures:y,floatVertexTextures:x}}function WebGLExtensions(e){var t={};return{get:function(i){if(void 0!==t[i])return t[i];var r;switch(i){case"WEBGL_depth_texture":r=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":r=e.getExtension("WEBGL_compressed_texture_etc1");break;default:r=e.getExtension(i)}return null===r&&console.warn("THREE.WebGLRenderer: "+i+" extension not supported."),t[i]=r,r}}}function WebGLClipping(){function e(){c.value!==r&&(c.value=r,c.needsUpdate=n>0),i.numPlanes=n,i.numIntersection=0}function t(e,t,r,n){var o=null!==e?e.length:0,a=null;if(0!==o){if(a=c.value,n!==!0||null===a){var h=r+4*o,u=t.matrixWorldInverse;l.getNormalMatrix(u),(null===a||a.length<h)&&(a=new Float32Array(h));for(var d=0,p=r;d!==o;++d,p+=4)s.copy(e[d]).applyMatrix4(u,l),s.normal.toArray(a,p),a[p+3]=s.constant}c.value=a,c.needsUpdate=!0}return i.numPlanes=o,a}var i=this,r=null,n=0,o=!1,a=!1,s=new Plane,l=new Matrix3,c={value:null,needsUpdate:!1};this.uniform=c,this.numPlanes=0,this.numIntersection=0,this.init=function(e,i,a){var s=0!==e.length||i||0!==n||o;return o=i,r=t(e,a,0),n=e.length,s},this.beginShadows=function(){a=!0,t(null)},this.endShadows=function(){a=!1,e()},this.setState=function(i,s,l,h,u,d){if(!o||null===i||0===i.length||a&&!l)a?t(null):e();else{var p=a?0:n,f=4*p,m=u.clippingState||null;c.value=m,m=t(i,h,f,d);for(var v=0;v!==f;++v)m[v]=r[v];u.clippingState=m,this.numIntersection=s?this.numPlanes:0,this.numPlanes+=p}}}function WebGLRenderer(e){function t(){return null===X?ae:1}function i(){Se.init(),Se.scissor(J.copy(se).multiplyScalar(ae)),Se.viewport(ee.copy(ce).multiplyScalar(ae)),Se.buffers.color.setClear(ie.r,ie.g,ie.b,re,N)}function r(){q=null,Z=null,Q="",K=-1,Se.reset()}function n(e){e.preventDefault(),r(),i(),Te.clear(),Re.clear()}function o(e){var t=e.target;t.removeEventListener("dispose",o),a(t)}function a(e){s(e),Te.remove(e)}function s(e){var t=Te.get(e).program;e.program=void 0,void 0!==t&&Le.releaseProgram(t)}function l(e,t,i){e.render(function(e){W.renderBufferImmediate(e,t,i)})}function c(e,t){return Math.abs(t[0])-Math.abs(e[0])}function h(e,t,i,r){if(i&&i.isInstancedBufferGeometry&&null===Me.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===r&&(r=0),Se.initAttributes();var n=i.attributes,o=t.getAttributes(),a=e.defaultAttributeValues;for(var s in o){var l=o[s];if(l>=0){var c=n[s];if(void 0!==c){var h=c.normalized,u=c.itemSize,d=Ae.get(c),p=d.buffer,f=d.type,m=d.bytesPerElement;if(c.isInterleavedBufferAttribute){var v=c.data,g=v.stride,y=c.offset;v&&v.isInstancedInterleavedBuffer?(Se.enableAttributeAndDivisor(l,v.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=v.meshPerAttribute*v.count)):Se.enableAttribute(l),_e.bindBuffer(_e.ARRAY_BUFFER,p),_e.vertexAttribPointer(l,u,f,h,g*m,(r*g+y)*m)}else c.isInstancedBufferAttribute?(Se.enableAttributeAndDivisor(l,c.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=c.meshPerAttribute*c.count)):Se.enableAttribute(l),_e.bindBuffer(_e.ARRAY_BUFFER,p),_e.vertexAttribPointer(l,u,f,h,0,r*u*m)}else if(void 0!==a){var x=a[s];if(void 0!==x)switch(x.length){case 2:_e.vertexAttrib2fv(l,x);break;case 3:_e.vertexAttrib3fv(l,x);break;case 4:_e.vertexAttrib4fv(l,x);break;default:_e.vertexAttrib1fv(l,x)}}}}Se.disableUnusedAttributes()}function u(e,t,i){if(e.visible){var r=e.layers.test(t.layers);if(r)if(e.isLight)U.push(e);else if(e.isSprite)e.frustumCulled&&!he.intersectsSprite(e)||j.push(e);else if(e.isLensFlare)H.push(e);else if(e.isImmediateRenderObject)i&&me.setFromMatrixPosition(e.matrixWorld).applyMatrix4(fe),G.push(e,null,e.material,me.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!e.frustumCulled||he.intersectsObject(e))){i&&me.setFromMatrixPosition(e.matrixWorld).applyMatrix4(fe);var n=Re.update(e),o=e.material;if(Array.isArray(o))for(var a=n.groups,s=0,l=a.length;s<l;s++){var c=a[s],h=o[c.materialIndex];h&&h.visible&&G.push(e,n,h,me.z,c)}else o.visible&&G.push(e,n,o,me.z,null)}for(var d=e.children,s=0,l=d.length;s<l;s++)u(d[s],t,i)}}function d(e,t,i,r){for(var n=0,o=e.length;n<o;n++){var a=e[n],s=a.object,l=a.geometry,c=void 0===r?a.material:r,h=a.group;if(s.onBeforeRender(W,t,i,l,c,h),i.isArrayCamera&&i.enabled)for(var u=i.cameras,d=0,f=u.length;d<f;d++){var m=u[d],v=m.bounds;W.setViewport(v.x*ne*ae,v.y*oe*ae,v.z*ne*ae,v.w*oe*ae),W.setScissor(v.x*ne*ae,v.y*oe*ae,v.z*ne*ae,v.w*oe*ae),W.setScissorTest(!0),p(s,t,m,l,c,h)}else p(s,t,i,l,c,h);s.onAfterRender(W,t,i,l,c,h)}}function p(e,t,i,r,n,o){if(e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){Se.setMaterial(n);var a=m(i,t.fog,n,e);Q="",l(e,a,n)}else W.renderBufferDirect(i,t.fog,r,n,e,o)}function f(e,t,i){var r=Te.get(e),n=Le.getParameters(e,ye,t,ue.numPlanes,ue.numIntersection,i),a=Le.getProgramCode(e,n),l=r.program,c=!0;if(void 0===l)e.addEventListener("dispose",o);else if(l.code!==a)s(e);else{if(void 0!==n.shaderID)return;c=!1}if(c){if(n.shaderID){var h=ShaderLib[n.shaderID];r.__webglShader={name:e.type,uniforms:UniformsUtils.clone(h.uniforms),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader}}else r.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=r.__webglShader,l=Le.acquireProgram(e,n,a),r.program=l,e.program=l}var u=l.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var d=0;d<W.maxMorphTargets;d++)u["morphTarget"+d]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(var d=0;d<W.maxMorphNormals;d++)u["morphNormal"+d]>=0&&e.numSupportedMorphNormals++}var p=r.__webglShader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&e.clipping!==!0||(r.numClippingPlanes=ue.numPlanes,r.numIntersection=ue.numIntersection,p.clippingPlanes=ue.uniform),r.fog=t,r.lightsHash=ye.hash,e.lights&&(p.ambientLightColor.value=ye.ambient,p.directionalLights.value=ye.directional,p.spotLights.value=ye.spot,p.rectAreaLights.value=ye.rectArea,p.pointLights.value=ye.point,p.hemisphereLights.value=ye.hemi,p.directionalShadowMap.value=ye.directionalShadowMap,p.directionalShadowMatrix.value=ye.directionalShadowMatrix,p.spotShadowMap.value=ye.spotShadowMap,p.spotShadowMatrix.value=ye.spotShadowMatrix,p.pointShadowMap.value=ye.pointShadowMap,p.pointShadowMatrix.value=ye.pointShadowMatrix);var f=r.program.getUniforms(),m=WebGLUniforms.seqWithValue(f.seq,p);r.uniformsList=m}function m(e,t,i,r){te=0;var n=Te.get(i);if(de&&(pe||e!==Z)){var o=e===Z&&i.id===K;ue.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,e,n,o)}i.needsUpdate===!1&&(void 0===n.program?i.needsUpdate=!0:i.fog&&n.fog!==t?i.needsUpdate=!0:i.lights&&n.lightsHash!==ye.hash?i.needsUpdate=!0:void 0===n.numClippingPlanes||n.numClippingPlanes===ue.numPlanes&&n.numIntersection===ue.numIntersection||(i.needsUpdate=!0)),i.needsUpdate&&(f(i,t,r),i.needsUpdate=!1);var a=!1,s=!1,l=!1,c=n.program,h=c.getUniforms(),u=n.__webglShader.uniforms;if(c.id!==q&&(_e.useProgram(c.program),q=c.id,a=!0,s=!0,l=!0),i.id!==K&&(K=i.id,s=!0),a||e!==Z){if(h.setValue(_e,"projectionMatrix",e.projectionMatrix),Ee.logarithmicDepthBuffer&&h.setValue(_e,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),e!==Z&&(Z=e,s=!0,l=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.envMap){var d=h.map.cameraPosition;void 0!==d&&d.setValue(_e,me.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.skinning)&&h.setValue(_e,"viewMatrix",e.matrixWorldInverse),h.setValue(_e,"toneMappingExposure",W.toneMappingExposure),h.setValue(_e,"toneMappingWhitePoint",W.toneMappingWhitePoint)}if(i.skinning){h.setOptional(_e,r,"bindMatrix"),h.setOptional(_e,r,"bindMatrixInverse");var p=r.skeleton;if(p){var m=p.bones;if(Ee.floatVertexTextures){if(void 0===p.boneTexture){var A=Math.sqrt(4*m.length);A=_Math.nextPowerOfTwo(Math.ceil(A)),A=Math.max(A,4);var P=new Float32Array(A*A*4);P.set(p.boneMatrices);var R=new DataTexture(P,A,A,RGBAFormat,FloatType);p.boneMatrices=P,p.boneTexture=R,p.boneTextureSize=A}h.setValue(_e,"boneTexture",p.boneTexture),h.setValue(_e,"boneTextureSize",p.boneTextureSize)}else h.setOptional(_e,p,"boneMatrices")}}return s&&(i.lights&&C(u,l),t&&i.fog&&b(u,t),(i.isMeshBasicMaterial||i.isMeshLambertMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.isMeshNormalMaterial||i.isMeshDepthMaterial)&&v(u,i),i.isLineBasicMaterial?g(u,i):i.isLineDashedMaterial?(g(u,i),y(u,i)):i.isPointsMaterial?x(u,i):i.isMeshLambertMaterial?_(u,i):i.isMeshToonMaterial?M(u,i):i.isMeshPhongMaterial?w(u,i):i.isMeshPhysicalMaterial?S(u,i):i.isMeshStandardMaterial?E(u,i):i.isMeshDepthMaterial?i.displacementMap&&(u.displacementMap.value=i.displacementMap,u.displacementScale.value=i.displacementScale,u.displacementBias.value=i.displacementBias):i.isMeshNormalMaterial&&T(u,i),void 0!==u.ltcMat&&(u.ltcMat.value=UniformsLib.LTC_MAT_TEXTURE),void 0!==u.ltcMag&&(u.ltcMag.value=UniformsLib.LTC_MAG_TEXTURE),WebGLUniforms.upload(_e,n.uniformsList,u,W)),h.setValue(_e,"modelViewMatrix",r.modelViewMatrix),h.setValue(_e,"normalMatrix",r.normalMatrix),h.setValue(_e,"modelMatrix",r.matrixWorld),c}function v(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var i;if(t.map?i=t.map:t.specularMap?i=t.specularMap:t.displacementMap?i=t.displacementMap:t.normalMap?i=t.normalMap:t.bumpMap?i=t.bumpMap:t.roughnessMap?i=t.roughnessMap:t.metalnessMap?i=t.metalnessMap:t.alphaMap?i=t.alphaMap:t.emissiveMap&&(i=t.emissiveMap),void 0!==i){i.isWebGLRenderTarget&&(i=i.texture);var r=i.offset,n=i.repeat;e.offsetRepeat.value.set(r.x,r.y,n.x,n.y)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function g(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function y(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function x(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*ae,e.scale.value=.5*oe,e.map.value=t.map,null!==t.map){var i=t.map.offset,r=t.map.repeat;e.offsetRepeat.value.set(i.x,i.y,r.x,r.y)}}function b(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function _(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function w(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function M(e,t){w(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}function E(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function S(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,E(e,t)}function T(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function C(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}function A(e){for(var t=0,i=0,r=e.length;i<r;i++){var n=e[i];n.castShadow&&(ye.shadows[t]=n,t++)}ye.shadows.length=t}function P(e,t){var i,r,n,o,a,s,l,c,h=0,u=0,d=0,p=t.matrixWorldInverse,f=0,m=0,v=0,g=0,y=0;for(i=0,r=e.length;i<r;i++)if(n=e[i],a=n.color,s=n.intensity,l=n.distance,c=n.shadow&&n.shadow.map?n.shadow.map.texture:null,n.isAmbientLight)h+=a.r*s,u+=a.g*s,d+=a.b*s;else if(n.isDirectionalLight){var x=Be.get(n);x.color.copy(n.color).multiplyScalar(n.intensity),x.direction.setFromMatrixPosition(n.matrixWorld),me.setFromMatrixPosition(n.target.matrixWorld),x.direction.sub(me),x.direction.transformDirection(p),x.shadow=n.castShadow,n.castShadow&&(o=n.shadow,x.shadowBias=o.bias,x.shadowRadius=o.radius,x.shadowMapSize=o.mapSize),ye.directionalShadowMap[f]=c,ye.directionalShadowMatrix[f]=n.shadow.matrix,ye.directional[f]=x,f++}else if(n.isSpotLight){var x=Be.get(n);x.position.setFromMatrixPosition(n.matrixWorld),x.position.applyMatrix4(p),x.color.copy(a).multiplyScalar(s),x.distance=l,x.direction.setFromMatrixPosition(n.matrixWorld),me.setFromMatrixPosition(n.target.matrixWorld),x.direction.sub(me),x.direction.transformDirection(p),x.coneCos=Math.cos(n.angle),x.penumbraCos=Math.cos(n.angle*(1-n.penumbra)),x.decay=0===n.distance?0:n.decay,x.shadow=n.castShadow,n.castShadow&&(o=n.shadow,x.shadowBias=o.bias,x.shadowRadius=o.radius,x.shadowMapSize=o.mapSize),ye.spotShadowMap[v]=c,ye.spotShadowMatrix[v]=n.shadow.matrix,ye.spot[v]=x,v++}else if(n.isRectAreaLight){var x=Be.get(n);x.color.copy(a).multiplyScalar(s/(n.width*n.height)),x.position.setFromMatrixPosition(n.matrixWorld),x.position.applyMatrix4(p),ge.identity(),ve.copy(n.matrixWorld),ve.premultiply(p),ge.extractRotation(ve),x.halfWidth.set(.5*n.width,0,0),x.halfHeight.set(0,.5*n.height,0),x.halfWidth.applyMatrix4(ge),x.halfHeight.applyMatrix4(ge),ye.rectArea[g]=x,g++}else if(n.isPointLight){var x=Be.get(n);x.position.setFromMatrixPosition(n.matrixWorld),x.position.applyMatrix4(p),x.color.copy(n.color).multiplyScalar(n.intensity),x.distance=n.distance,x.decay=0===n.distance?0:n.decay,x.shadow=n.castShadow,n.castShadow&&(o=n.shadow,x.shadowBias=o.bias,x.shadowRadius=o.radius,x.shadowMapSize=o.mapSize),ye.pointShadowMap[m]=c,ye.pointShadowMatrix[m]=n.shadow.matrix,ye.point[m]=x,m++}else if(n.isHemisphereLight){var x=Be.get(n);x.direction.setFromMatrixPosition(n.matrixWorld),x.direction.transformDirection(p),x.direction.normalize(),x.skyColor.copy(n.color).multiplyScalar(s),x.groundColor.copy(n.groundColor).multiplyScalar(s),ye.hemi[y]=x,y++}ye.ambient[0]=h,ye.ambient[1]=u,ye.ambient[2]=d,ye.directional.length=f,ye.spot.length=v,ye.rectArea.length=g,ye.point.length=m,ye.hemi.length=y,ye.hash=f+","+m+","+v+","+g+","+y+","+ye.shadows.length}function R(){var e=te;return e>=Ee.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+Ee.maxTextures),te+=1,e}function L(e){var t;if(e===RepeatWrapping)return _e.REPEAT;if(e===ClampToEdgeWrapping)return _e.CLAMP_TO_EDGE;if(e===MirroredRepeatWrapping)return _e.MIRRORED_REPEAT;if(e===NearestFilter)return _e.NEAREST;if(e===NearestMipMapNearestFilter)return _e.NEAREST_MIPMAP_NEAREST;if(e===NearestMipMapLinearFilter)return _e.NEAREST_MIPMAP_LINEAR;if(e===LinearFilter)return _e.LINEAR;if(e===LinearMipMapNearestFilter)return _e.LINEAR_MIPMAP_NEAREST;if(e===LinearMipMapLinearFilter)return _e.LINEAR_MIPMAP_LINEAR;if(e===UnsignedByteType)return _e.UNSIGNED_BYTE;if(e===UnsignedShort4444Type)return _e.UNSIGNED_SHORT_4_4_4_4;if(e===UnsignedShort5551Type)return _e.UNSIGNED_SHORT_5_5_5_1;if(e===UnsignedShort565Type)return _e.UNSIGNED_SHORT_5_6_5;if(e===ByteType)return _e.BYTE;if(e===ShortType)return _e.SHORT;if(e===UnsignedShortType)return _e.UNSIGNED_SHORT;if(e===IntType)return _e.INT;if(e===UnsignedIntType)return _e.UNSIGNED_INT;if(e===FloatType)return _e.FLOAT;if(e===HalfFloatType&&(t=Me.get("OES_texture_half_float"),null!==t))return t.HALF_FLOAT_OES;if(e===AlphaFormat)return _e.ALPHA;if(e===RGBFormat)return _e.RGB;if(e===RGBAFormat)return _e.RGBA;if(e===LuminanceFormat)return _e.LUMINANCE;if(e===LuminanceAlphaFormat)return _e.LUMINANCE_ALPHA;if(e===DepthFormat)return _e.DEPTH_COMPONENT;if(e===DepthStencilFormat)return _e.DEPTH_STENCIL;if(e===AddEquation)return _e.FUNC_ADD;if(e===SubtractEquation)return _e.FUNC_SUBTRACT;if(e===ReverseSubtractEquation)return _e.FUNC_REVERSE_SUBTRACT;if(e===ZeroFactor)return _e.ZERO;if(e===OneFactor)return _e.ONE;if(e===SrcColorFactor)return _e.SRC_COLOR;if(e===OneMinusSrcColorFactor)return _e.ONE_MINUS_SRC_COLOR;if(e===SrcAlphaFactor)return _e.SRC_ALPHA;if(e===OneMinusSrcAlphaFactor)return _e.ONE_MINUS_SRC_ALPHA;if(e===DstAlphaFactor)return _e.DST_ALPHA;if(e===OneMinusDstAlphaFactor)return _e.ONE_MINUS_DST_ALPHA;if(e===DstColorFactor)return _e.DST_COLOR;if(e===OneMinusDstColorFactor)return _e.ONE_MINUS_DST_COLOR;if(e===SrcAlphaSaturateFactor)return _e.SRC_ALPHA_SATURATE;if((e===RGB_S3TC_DXT1_Format||e===RGBA_S3TC_DXT1_Format||e===RGBA_S3TC_DXT3_Format||e===RGBA_S3TC_DXT5_Format)&&(t=Me.get("WEBGL_compressed_texture_s3tc"),null!==t)){if(e===RGB_S3TC_DXT1_Format)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===RGBA_S3TC_DXT1_Format)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===RGBA_S3TC_DXT3_Format)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===RGBA_S3TC_DXT5_Format)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===RGB_PVRTC_4BPPV1_Format||e===RGB_PVRTC_2BPPV1_Format||e===RGBA_PVRTC_4BPPV1_Format||e===RGBA_PVRTC_2BPPV1_Format)&&(t=Me.get("WEBGL_compressed_texture_pvrtc"),null!==t)){if(e===RGB_PVRTC_4BPPV1_Format)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===RGB_PVRTC_2BPPV1_Format)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===RGBA_PVRTC_4BPPV1_Format)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===RGBA_PVRTC_2BPPV1_Format)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===RGB_ETC1_Format&&(t=Me.get("WEBGL_compressed_texture_etc1"),null!==t))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===MinEquation||e===MaxEquation)&&(t=Me.get("EXT_blend_minmax"),null!==t)){if(e===MinEquation)return t.MIN_EXT;if(e===MaxEquation)return t.MAX_EXT}return e===UnsignedInt248Type&&(t=Me.get("WEBGL_depth_texture"),null!==t)?t.UNSIGNED_INT_24_8_WEBGL:0}console.log("THREE.WebGLRenderer",REVISION),e=e||{};var B=void 0!==e.canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),O=void 0!==e.context?e.context:null,I=void 0!==e.alpha&&e.alpha,D=void 0===e.depth||e.depth,k=void 0===e.stencil||e.stencil,F=void 0!==e.antialias&&e.antialias,N=void 0===e.premultipliedAlpha||e.premultipliedAlpha,V=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,U=[],G=null,z=new Float32Array(8),j=[],H=[];this.domElement=B,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=LinearToneMapping,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var W=this,q=null,X=null,Y=null,K=-1,Q="",Z=null,J=new Vector4,$=null,ee=new Vector4,te=0,ie=new Color(0),re=0,ne=B.width,oe=B.height,ae=1,se=new Vector4(0,0,ne,oe),le=!1,ce=new Vector4(0,0,ne,oe),he=new Frustum,ue=new WebGLClipping,de=!1,pe=!1,fe=new Matrix4,me=new Vector3,ve=new Matrix4,ge=new Matrix4,ye={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],shadows:[]},xe={geometries:0,textures:0},be={frame:0,calls:0,vertices:0,faces:0,points:0
};this.info={render:be,memory:xe,programs:null};var _e;try{var we={alpha:I,depth:D,stencil:k,antialias:F,premultipliedAlpha:N,preserveDrawingBuffer:V};if(_e=O||B.getContext("webgl",we)||B.getContext("experimental-webgl",we),null===_e)throw null!==B.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===_e.getShaderPrecisionFormat&&(_e.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),B.addEventListener("webglcontextlost",n,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}var Me=new WebGLExtensions(_e);Me.get("WEBGL_depth_texture"),Me.get("OES_texture_float"),Me.get("OES_texture_float_linear"),Me.get("OES_texture_half_float"),Me.get("OES_texture_half_float_linear"),Me.get("OES_standard_derivatives"),Me.get("ANGLE_instanced_arrays"),Me.get("OES_element_index_uint")&&(BufferGeometry.MaxIndex=4294967296);var Ee=new WebGLCapabilities(_e,Me,e),Se=new WebGLState(_e,Me,L),Te=new WebGLProperties,Ce=new WebGLTextures(_e,Me,Se,Te,Ee,L,xe),Ae=new WebGLAttributes(_e),Pe=new WebGLGeometries(_e,Ae,xe),Re=new WebGLObjects(_e,Pe,be),Le=new WebGLPrograms(this,Ee),Be=new WebGLLights,Oe=new WebGLRenderLists;this.info.programs=Le.programs;var Ie,De,ke,Fe,Ne=new WebGLBufferRenderer(_e,Me,be),Ve=new WebGLIndexedBufferRenderer(_e,Me,be);i(),this.context=_e,this.capabilities=Ee,this.extensions=Me,this.properties=Te,this.state=Se;var Ue=new WebGLShadowMap(this,ye,Re,Ee);this.shadowMap=Ue;var Ge=new SpritePlugin(this,j),ze=new LensFlarePlugin(this,H);this.getContext=function(){return _e},this.getContextAttributes=function(){return _e.getContextAttributes()},this.forceContextLoss=function(){var e=Me.get("WEBGL_lose_context");e&&e.loseContext()},this.getMaxAnisotropy=function(){return Ee.getMaxAnisotropy()},this.getPrecision=function(){return Ee.precision},this.getPixelRatio=function(){return ae},this.setPixelRatio=function(e){void 0!==e&&(ae=e,this.setSize(ce.z,ce.w,!1))},this.getSize=function(){return{width:ne,height:oe}},this.setSize=function(e,t,i){ne=e,oe=t,B.width=e*ae,B.height=t*ae,i!==!1&&(B.style.width=e+"px",B.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){Se.viewport(ce.set(e,t,i,r))},this.setScissor=function(e,t,i,r){Se.scissor(se.set(e,t,i,r))},this.setScissorTest=function(e){Se.setScissorTest(le=e)},this.getClearColor=function(){return ie},this.setClearColor=function(e,t){ie.set(e),re=void 0!==t?t:1,Se.buffers.color.setClear(ie.r,ie.g,ie.b,re,N)},this.getClearAlpha=function(){return re},this.setClearAlpha=function(e){re=e,Se.buffers.color.setClear(ie.r,ie.g,ie.b,re,N)},this.clear=function(e,t,i){var r=0;(void 0===e||e)&&(r|=_e.COLOR_BUFFER_BIT),(void 0===t||t)&&(r|=_e.DEPTH_BUFFER_BIT),(void 0===i||i)&&(r|=_e.STENCIL_BUFFER_BIT),_e.clear(r)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,i,r){this.setRenderTarget(e),this.clear(t,i,r)},this.resetGLState=r,this.dispose=function(){B.removeEventListener("webglcontextlost",n,!1),Oe.dispose()},this.renderBufferImmediate=function(e,t,i){Se.initAttributes();var r=Te.get(e);e.hasPositions&&!r.position&&(r.position=_e.createBuffer()),e.hasNormals&&!r.normal&&(r.normal=_e.createBuffer()),e.hasUvs&&!r.uv&&(r.uv=_e.createBuffer()),e.hasColors&&!r.color&&(r.color=_e.createBuffer());var n=t.getAttributes();if(e.hasPositions&&(_e.bindBuffer(_e.ARRAY_BUFFER,r.position),_e.bufferData(_e.ARRAY_BUFFER,e.positionArray,_e.DYNAMIC_DRAW),Se.enableAttribute(n.position),_e.vertexAttribPointer(n.position,3,_e.FLOAT,!1,0,0)),e.hasNormals){if(_e.bindBuffer(_e.ARRAY_BUFFER,r.normal),!i.isMeshPhongMaterial&&!i.isMeshStandardMaterial&&!i.isMeshNormalMaterial&&i.shading===FlatShading)for(var o=0,a=3*e.count;o<a;o+=9){var s=e.normalArray,l=(s[o+0]+s[o+3]+s[o+6])/3,c=(s[o+1]+s[o+4]+s[o+7])/3,h=(s[o+2]+s[o+5]+s[o+8])/3;s[o+0]=l,s[o+1]=c,s[o+2]=h,s[o+3]=l,s[o+4]=c,s[o+5]=h,s[o+6]=l,s[o+7]=c,s[o+8]=h}_e.bufferData(_e.ARRAY_BUFFER,e.normalArray,_e.DYNAMIC_DRAW),Se.enableAttribute(n.normal),_e.vertexAttribPointer(n.normal,3,_e.FLOAT,!1,0,0)}e.hasUvs&&i.map&&(_e.bindBuffer(_e.ARRAY_BUFFER,r.uv),_e.bufferData(_e.ARRAY_BUFFER,e.uvArray,_e.DYNAMIC_DRAW),Se.enableAttribute(n.uv),_e.vertexAttribPointer(Ae.uv,2,_e.FLOAT,!1,0,0)),e.hasColors&&i.vertexColors!==NoColors&&(_e.bindBuffer(_e.ARRAY_BUFFER,r.color),_e.bufferData(_e.ARRAY_BUFFER,e.colorArray,_e.DYNAMIC_DRAW),Se.enableAttribute(n.color),_e.vertexAttribPointer(n.color,3,_e.FLOAT,!1,0,0)),Se.disableUnusedAttributes(),_e.drawArrays(_e.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,i,r,n,o,a){Se.setMaterial(n);var s=m(e,i,n,o),l=r.id+"_"+s.id+"_"+(n.wireframe===!0),u=!1;l!==Q&&(Q=l,u=!0);var d=o.morphTargetInfluences;if(void 0!==d){for(var p=[],f=0,v=d.length;f<v;f++){var g=d[f];p.push([g,f])}p.sort(c),p.length>8&&(p.length=8);for(var y=r.morphAttributes,f=0,v=p.length;f<v;f++){var g=p[f];if(z[f]=g[0],0!==g[0]){var x=g[1];n.morphTargets===!0&&y.position&&r.addAttribute("morphTarget"+f,y.position[x]),n.morphNormals===!0&&y.normal&&r.addAttribute("morphNormal"+f,y.normal[x])}else n.morphTargets===!0&&r.removeAttribute("morphTarget"+f),n.morphNormals===!0&&r.removeAttribute("morphNormal"+f)}for(var f=p.length,b=z.length;f<b;f++)z[f]=0;s.getUniforms().setValue(_e,"morphTargetInfluences",z),u=!0}var x=r.index,_=r.attributes.position,w=1;n.wireframe===!0&&(x=Pe.getWireframeAttribute(r),w=2);var M=Ne;null!==x&&(M=Ve,M.setIndex(x)),u&&(h(n,s,r),null!==x&&_e.bindBuffer(_e.ELEMENT_ARRAY_BUFFER,Ae.get(x).buffer));var E=0;null!==x?E=x.count:void 0!==_&&(E=_.count);var S=r.drawRange.start*w,T=r.drawRange.count*w,C=null!==a?a.start*w:0,A=null!==a?a.count*w:1/0,P=Math.max(S,C),R=Math.min(E,S+T,C+A)-1,L=Math.max(0,R-P+1);if(0!==L){if(o.isMesh)if(n.wireframe===!0)Se.setLineWidth(n.wireframeLinewidth*t()),M.setMode(_e.LINES);else switch(o.drawMode){case TrianglesDrawMode:M.setMode(_e.TRIANGLES);break;case TriangleStripDrawMode:M.setMode(_e.TRIANGLE_STRIP);break;case TriangleFanDrawMode:M.setMode(_e.TRIANGLE_FAN)}else if(o.isLine){var B=n.linewidth;void 0===B&&(B=1),Se.setLineWidth(B*t()),o.isLineSegments?M.setMode(_e.LINES):o.isLineLoop?M.setMode(_e.LINE_LOOP):M.setMode(_e.LINE_STRIP)}else o.isPoints&&M.setMode(_e.POINTS);r&&r.isInstancedBufferGeometry?r.maxInstancedCount>0&&M.renderInstances(r,P,L):M.render(P,L)}},this.compile=function(e,t){U=[],e.traverse(function(e){e.isLight&&U.push(e)}),P(U,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var i=0;i<t.material.length;i++)f(t.material[i],e.fog,t);else f(t.material,e.fog,t)})},this.render=function(e,t,i,r){if(void 0!==t&&t.isCamera!==!0)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");Q="",K=-1,Z=null,e.autoUpdate===!0&&e.updateMatrixWorld(),t.onBeforeRender(W),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),fe.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),he.setFromMatrix(fe),U.length=0,j.length=0,H.length=0,pe=this.localClippingEnabled,de=ue.init(this.clippingPlanes,pe,t),G=Oe.get(e,t),G.init(),u(e,t,W.sortObjects),G.finish(),W.sortObjects===!0&&G.sort(),de&&ue.beginShadows(),A(U),Ue.render(e,t),P(U,t),de&&ue.endShadows(),be.frame++,be.calls=0,be.vertices=0,be.faces=0,be.points=0,void 0===i&&(i=null),this.setRenderTarget(i);var n=e.background;null===n?Se.buffers.color.setClear(ie.r,ie.g,ie.b,re,N):n&&n.isColor&&(Se.buffers.color.setClear(n.r,n.g,n.b,1,N),r=!0),(this.autoClear||r)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),n&&n.isCubeTexture?(void 0===ke&&(ke=new PerspectiveCamera,Fe=new Mesh(new BoxBufferGeometry(5,5,5),new ShaderMaterial({uniforms:ShaderLib.cube.uniforms,vertexShader:ShaderLib.cube.vertexShader,fragmentShader:ShaderLib.cube.fragmentShader,side:BackSide,depthTest:!1,depthWrite:!1,fog:!1}))),ke.projectionMatrix.copy(t.projectionMatrix),ke.matrixWorld.extractRotation(t.matrixWorld),ke.matrixWorldInverse.getInverse(ke.matrixWorld),Fe.material.uniforms.tCube.value=n,Fe.modelViewMatrix.multiplyMatrices(ke.matrixWorldInverse,Fe.matrixWorld),Re.update(Fe),W.renderBufferDirect(ke,null,Fe.geometry,Fe.material,Fe,null)):n&&n.isTexture&&(void 0===Ie&&(Ie=new OrthographicCamera(-1,1,1,-1,0,1),De=new Mesh(new PlaneBufferGeometry(2,2),new MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1}))),De.material.map=n,Re.update(De),W.renderBufferDirect(Ie,null,De.geometry,De.material,De,null));var o=G.opaque,a=G.transparent;if(e.overrideMaterial){var s=e.overrideMaterial;o.length&&d(o,e,t,s),a.length&&d(a,e,t,s)}else o.length&&d(o,e,t),a.length&&d(a,e,t);Ge.render(e,t),ze.render(e,t,ee),i&&Ce.updateRenderTargetMipmap(i),Se.buffers.depth.setTest(!0),Se.buffers.depth.setMask(!0),Se.buffers.color.setMask(!0),t.isArrayCamera&&t.enabled&&W.setScissorTest(!1),t.onAfterRender(W)},this.setFaceCulling=function(e,t){Se.setCullFace(e),Se.setFlipSided(t===FrontFaceDirectionCW)},this.allocTextureUnit=R,this.setTexture2D=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),Ce.setTexture2D(t,i)}}(),this.setTexture=function(){var e=!1;return function(t,i){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),Ce.setTexture2D(t,i)}}(),this.setTextureCube=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?Ce.setTextureCube(t,i):Ce.setTextureCubeDynamic(t,i)}}(),this.getRenderTarget=function(){return X},this.setRenderTarget=function(e){X=e,e&&void 0===Te.get(e).__webglFramebuffer&&Ce.setupRenderTarget(e);var t,i=e&&e.isWebGLRenderTargetCube;if(e){var r=Te.get(e);t=i?r.__webglFramebuffer[e.activeCubeFace]:r.__webglFramebuffer,J.copy(e.scissor),$=e.scissorTest,ee.copy(e.viewport)}else t=null,J.copy(se).multiplyScalar(ae),$=le,ee.copy(ce).multiplyScalar(ae);if(Y!==t&&(_e.bindFramebuffer(_e.FRAMEBUFFER,t),Y=t),Se.scissor(J),Se.setScissorTest($),Se.viewport(ee),i){var n=Te.get(e.texture);_e.framebufferTexture2D(_e.FRAMEBUFFER,_e.COLOR_ATTACHMENT0,_e.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,n.__webglTexture,e.activeMipMapLevel)}},this.readRenderTargetPixels=function(e,t,i,r,n,o){if((e&&e.isWebGLRenderTarget)===!1)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");var a=Te.get(e).__webglFramebuffer;if(a){var s=!1;a!==Y&&(_e.bindFramebuffer(_e.FRAMEBUFFER,a),s=!0);try{var l=e.texture,c=l.format,h=l.type;if(c!==RGBAFormat&&L(c)!==_e.getParameter(_e.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(h===UnsignedByteType||L(h)===_e.getParameter(_e.IMPLEMENTATION_COLOR_READ_TYPE)||h===FloatType&&(Me.get("OES_texture_float")||Me.get("WEBGL_color_buffer_float"))||h===HalfFloatType&&Me.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");_e.checkFramebufferStatus(_e.FRAMEBUFFER)===_e.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-r&&i>=0&&i<=e.height-n&&_e.readPixels(t,i,r,n,L(c),L(h),o):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&_e.bindFramebuffer(_e.FRAMEBUFFER,Y)}}}}function FogExp2(e,t){this.name="",this.color=new Color(e),this.density=void 0!==t?t:25e-5}function Fog(e,t,i){this.name="",this.color=new Color(e),this.near=void 0!==t?t:1,this.far=void 0!==i?i:1e3}function Scene(){Object3D.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function LensFlare(e,t,i,r,n){Object3D.call(this),this.lensFlares=[],this.positionScreen=new Vector3,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,i,r,n)}function SpriteMaterial(e){Material.call(this),this.type="SpriteMaterial",this.color=new Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Sprite(e){Object3D.call(this),this.type="Sprite",this.material=void 0!==e?e:new SpriteMaterial}function LOD(){Object3D.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function Skeleton(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var i=0,r=this.bones.length;i<r;i++)this.boneInverses.push(new Matrix4)}}function Bone(){Object3D.call(this),this.type="Bone"}function SkinnedMesh(e,t){Mesh.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Matrix4,this.bindMatrixInverse=new Matrix4;var i=this.initBones(),r=new Skeleton(i);this.bind(r,this.matrixWorld),this.normalizeSkinWeights()}function LineBasicMaterial(e){Material.call(this),this.type="LineBasicMaterial",this.color=new Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function Line(e,t,i){return 1===i?(console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new LineSegments(e,t)):(Object3D.call(this),this.type="Line",this.geometry=void 0!==e?e:new BufferGeometry,void(this.material=void 0!==t?t:new LineBasicMaterial({color:16777215*Math.random()})))}function LineSegments(e,t){Line.call(this,e,t),this.type="LineSegments"}function LineLoop(e,t){Line.call(this,e,t),this.type="LineLoop"}function PointsMaterial(e){Material.call(this),this.type="PointsMaterial",this.color=new Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.lights=!1,this.setValues(e)}function Points(e,t){Object3D.call(this),this.type="Points",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new PointsMaterial({color:16777215*Math.random()})}function Group(){Object3D.call(this),this.type="Group"}function CompressedTexture(e,t,i,r,n,o,a,s,l,c,h,u){Texture.call(this,null,o,a,s,l,c,r,n,h,u),this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function WireframeGeometry(e){BufferGeometry.call(this),this.type="WireframeGeometry";var t,i,r,n,o,a,s,l,c,h,u=[],d=[0,0],p={},f=["a","b","c"];if(e&&e.isGeometry){var m=e.faces;for(t=0,r=m.length;t<r;t++){var v=m[t];for(i=0;i<3;i++)s=v[f[i]],l=v[f[(i+1)%3]],d[0]=Math.min(s,l),d[1]=Math.max(s,l),c=d[0]+","+d[1],void 0===p[c]&&(p[c]={index1:d[0],index2:d[1]})}for(c in p)a=p[c],h=e.vertices[a.index1],u.push(h.x,h.y,h.z),h=e.vertices[a.index2],u.push(h.x,h.y,h.z)}else if(e&&e.isBufferGeometry){var g,y,x,b,_,w,M,E;if(h=new Vector3,null!==e.index){for(g=e.attributes.position,y=e.index,x=e.groups,0===x.length&&(x=[{start:0,count:y.count,materialIndex:0}]),n=0,o=x.length;n<o;++n)for(b=x[n],_=b.start,w=b.count,t=_,r=_+w;t<r;t+=3)for(i=0;i<3;i++)s=y.getX(t+i),l=y.getX(t+(i+1)%3),d[0]=Math.min(s,l),d[1]=Math.max(s,l),c=d[0]+","+d[1],void 0===p[c]&&(p[c]={index1:d[0],index2:d[1]});for(c in p)a=p[c],h.fromBufferAttribute(g,a.index1),u.push(h.x,h.y,h.z),h.fromBufferAttribute(g,a.index2),u.push(h.x,h.y,h.z)}else for(g=e.attributes.position,t=0,r=g.count/3;t<r;t++)for(i=0;i<3;i++)M=3*t+i,h.fromBufferAttribute(g,M),u.push(h.x,h.y,h.z),E=3*t+(i+1)%3,h.fromBufferAttribute(g,E),u.push(h.x,h.y,h.z)}this.addAttribute("position",new Float32BufferAttribute(u,3))}function ParametricGeometry(e,t,i){Geometry.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:i},this.fromBufferGeometry(new ParametricBufferGeometry(e,t,i)),this.mergeVertices()}function ParametricBufferGeometry(e,t,i){BufferGeometry.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:i};var r,n,o=[],a=[],s=[],l=[],c=1e-5,h=new Vector3,u=new Vector3,d=new Vector3,p=new Vector3,f=new Vector3,m=t+1;for(r=0;r<=i;r++){var v=r/i;for(n=0;n<=t;n++){var g=n/t;u=e(g,v,u),a.push(u.x,u.y,u.z),g-c>=0?(d=e(g-c,v,d),p.subVectors(u,d)):(d=e(g+c,v,d),p.subVectors(d,u)),v-c>=0?(d=e(g,v-c,d),f.subVectors(u,d)):(d=e(g,v+c,d),f.subVectors(d,u)),h.crossVectors(p,f).normalize(),s.push(h.x,h.y,h.z),l.push(g,v)}}for(r=0;r<i;r++)for(n=0;n<t;n++){var y=r*m+n,x=r*m+n+1,b=(r+1)*m+n+1,_=(r+1)*m+n;o.push(y,x,_),o.push(x,b,_)}this.setIndex(o),this.addAttribute("position",new Float32BufferAttribute(a,3)),this.addAttribute("normal",new Float32BufferAttribute(s,3)),this.addAttribute("uv",new Float32BufferAttribute(l,2))}function PolyhedronGeometry(e,t,i,r){Geometry.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:r},this.fromBufferGeometry(new PolyhedronBufferGeometry(e,t,i,r)),this.mergeVertices()}function PolyhedronBufferGeometry(e,t,i,r){function n(e){for(var i=new Vector3,r=new Vector3,n=new Vector3,a=0;a<t.length;a+=3)h(t[a+0],i),h(t[a+1],r),h(t[a+2],n),o(i,r,n,e)}function o(e,t,i,r){var n,o,a=Math.pow(2,r),s=[];for(n=0;n<=a;n++){s[n]=[];var l=e.clone().lerp(i,n/a),h=t.clone().lerp(i,n/a),u=a-n;for(o=0;o<=u;o++)0===o&&n===a?s[n][o]=l:s[n][o]=l.clone().lerp(h,o/u)}for(n=0;n<a;n++)for(o=0;o<2*(a-n)-1;o++){var d=Math.floor(o/2);o%2===0?(c(s[n][d+1]),c(s[n+1][d]),c(s[n][d])):(c(s[n][d+1]),c(s[n+1][d+1]),c(s[n+1][d]))}}function a(e){for(var t=new Vector3,i=0;i<m.length;i+=3)t.x=m[i+0],t.y=m[i+1],t.z=m[i+2],t.normalize().multiplyScalar(e),m[i+0]=t.x,m[i+1]=t.y,m[i+2]=t.z}function s(){for(var e=new Vector3,t=0;t<m.length;t+=3){e.x=m[t+0],e.y=m[t+1],e.z=m[t+2];var i=p(e)/2/Math.PI+.5,r=f(e)/Math.PI+.5;v.push(i,1-r)}u(),l()}function l(){for(var e=0;e<v.length;e+=6){var t=v[e+0],i=v[e+2],r=v[e+4],n=Math.max(t,i,r),o=Math.min(t,i,r);n>.9&&o<.1&&(t<.2&&(v[e+0]+=1),i<.2&&(v[e+2]+=1),r<.2&&(v[e+4]+=1))}}function c(e){m.push(e.x,e.y,e.z)}function h(t,i){var r=3*t;i.x=e[r+0],i.y=e[r+1],i.z=e[r+2]}function u(){for(var e=new Vector3,t=new Vector3,i=new Vector3,r=new Vector3,n=new Vector2,o=new Vector2,a=new Vector2,s=0,l=0;s<m.length;s+=9,l+=6){e.set(m[s+0],m[s+1],m[s+2]),t.set(m[s+3],m[s+4],m[s+5]),i.set(m[s+6],m[s+7],m[s+8]),n.set(v[l+0],v[l+1]),o.set(v[l+2],v[l+3]),a.set(v[l+4],v[l+5]),r.copy(e).add(t).add(i).divideScalar(3);var c=p(r);d(n,l+0,e,c),d(o,l+2,t,c),d(a,l+4,i,c)}}function d(e,t,i,r){r<0&&1===e.x&&(v[t]=e.x-1),0===i.x&&0===i.z&&(v[t]=r/2/Math.PI+.5)}function p(e){return Math.atan2(e.z,-e.x)}function f(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}BufferGeometry.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:r},i=i||1,r=r||0;var m=[],v=[];n(r),a(i),s(),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(m.slice(),3)),this.addAttribute("uv",new Float32BufferAttribute(v,2)),this.normalizeNormals()}function TetrahedronGeometry(e,t){Geometry.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new TetrahedronBufferGeometry(e,t)),this.mergeVertices()}function TetrahedronBufferGeometry(e,t){var i=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],r=[2,1,0,0,3,2,1,3,0,2,3,1];PolyhedronBufferGeometry.call(this,i,r,e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function OctahedronGeometry(e,t){Geometry.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new OctahedronBufferGeometry(e,t)),this.mergeVertices()}function OctahedronBufferGeometry(e,t){var i=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],r=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];PolyhedronBufferGeometry.call(this,i,r,e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function IcosahedronGeometry(e,t){Geometry.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new IcosahedronBufferGeometry(e,t)),this.mergeVertices()}function IcosahedronBufferGeometry(e,t){var i=(1+Math.sqrt(5))/2,r=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];PolyhedronBufferGeometry.call(this,r,n,e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function DodecahedronGeometry(e,t){Geometry.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new DodecahedronBufferGeometry(e,t)),this.mergeVertices()}function DodecahedronBufferGeometry(e,t){var i=(1+Math.sqrt(5))/2,r=1/i,n=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-r,-i,0,-r,i,0,r,-i,0,r,i,-r,-i,0,-r,i,0,r,-i,0,r,i,0,-i,0,-r,i,0,-r,-i,0,r,i,0,r],o=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];PolyhedronBufferGeometry.call(this,n,o,e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function TubeGeometry(e,t,i,r,n,o){Geometry.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:n},void 0!==o&&console.warn("THREE.TubeGeometry: taper has been removed.");var a=new TubeBufferGeometry(e,t,i,r,n);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals,this.fromBufferGeometry(a),this.mergeVertices()}function TubeBufferGeometry(e,t,i,r,n){function o(){for(h=0;h<t;h++)a(h);a(n===!1?t:0),l(),s()}function a(n){var o=e.getPointAt(n/t),a=c.normals[n],s=c.binormals[n];for(u=0;u<=r;u++){var l=u/r*Math.PI*2,h=Math.sin(l),f=-Math.cos(l);p.x=f*a.x+h*s.x,p.y=f*a.y+h*s.y,p.z=f*a.z+h*s.z,p.normalize(),v.push(p.x,p.y,p.z),d.x=o.x+i*p.x,d.y=o.y+i*p.y,d.z=o.z+i*p.z,m.push(d.x,d.y,d.z)}}function s(){for(u=1;u<=t;u++)for(h=1;h<=r;h++){var e=(r+1)*(u-1)+(h-1),i=(r+1)*u+(h-1),n=(r+1)*u+h,o=(r+1)*(u-1)+h;y.push(e,i,o),y.push(i,n,o)}}function l(){for(h=0;h<=t;h++)for(u=0;u<=r;u++)f.x=h/t,f.y=u/r,g.push(f.x,f.y)}BufferGeometry.call(this),this.type="TubeBufferGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:n},t=t||64,i=i||1,r=r||8,n=n||!1;var c=e.computeFrenetFrames(t,n);this.tangents=c.tangents,this.normals=c.normals,this.binormals=c.binormals;var h,u,d=new Vector3,p=new Vector3,f=new Vector2,m=[],v=[],g=[],y=[];o(),this.setIndex(y),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(v,3)),this.addAttribute("uv",new Float32BufferAttribute(g,2))}function TorusKnotGeometry(e,t,i,r,n,o,a){Geometry.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:r,p:n,q:o},void 0!==a&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new TorusKnotBufferGeometry(e,t,i,r,n,o)),this.mergeVertices()}function TorusKnotBufferGeometry(e,t,i,r,n,o){function a(e,t,i,r,n){var o=Math.cos(e),a=Math.sin(e),s=i/t*e,l=Math.cos(s);n.x=r*(2+l)*.5*o,n.y=r*(2+l)*a*.5,n.z=r*Math.sin(s)*.5}BufferGeometry.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:r,p:n,q:o},e=e||100,t=t||40,i=Math.floor(i)||64,r=Math.floor(r)||8,n=n||2,o=o||3;var s,l,c=[],h=[],u=[],d=[],p=new Vector3,f=new Vector3,m=new Vector3,v=new Vector3,g=new Vector3,y=new Vector3,x=new Vector3;for(s=0;s<=i;++s){var b=s/i*n*Math.PI*2;for(a(b,n,o,e,m),a(b+.01,n,o,e,v),y.subVectors(v,m),x.addVectors(v,m),g.crossVectors(y,x),x.crossVectors(g,y),g.normalize(),x.normalize(),l=0;l<=r;++l){var _=l/r*Math.PI*2,w=-t*Math.cos(_),M=t*Math.sin(_);p.x=m.x+(w*x.x+M*g.x),p.y=m.y+(w*x.y+M*g.y),p.z=m.z+(w*x.z+M*g.z),h.push(p.x,p.y,p.z),f.subVectors(p,m).normalize(),u.push(f.x,f.y,f.z),d.push(s/i),d.push(l/r)}}for(l=1;l<=i;l++)for(s=1;s<=r;s++){var E=(r+1)*(l-1)+(s-1),S=(r+1)*l+(s-1),T=(r+1)*l+s,C=(r+1)*(l-1)+s;c.push(E,S,C),c.push(S,T,C)}this.setIndex(c),this.addAttribute("position",new Float32BufferAttribute(h,3)),this.addAttribute("normal",new Float32BufferAttribute(u,3)),this.addAttribute("uv",new Float32BufferAttribute(d,2))}function TorusGeometry(e,t,i,r,n){Geometry.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:r,arc:n},this.fromBufferGeometry(new TorusBufferGeometry(e,t,i,r,n)),this.mergeVertices()}function TorusBufferGeometry(e,t,i,r,n){BufferGeometry.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:r,arc:n},e=e||100,t=t||40,i=Math.floor(i)||8,r=Math.floor(r)||6,n=n||2*Math.PI;var o,a,s=[],l=[],c=[],h=[],u=new Vector3,d=new Vector3,p=new Vector3;for(o=0;o<=i;o++)for(a=0;a<=r;a++){var f=a/r*n,m=o/i*Math.PI*2;d.x=(e+t*Math.cos(m))*Math.cos(f),d.y=(e+t*Math.cos(m))*Math.sin(f),d.z=t*Math.sin(m),l.push(d.x,d.y,d.z),u.x=e*Math.cos(f),u.y=e*Math.sin(f),p.subVectors(d,u).normalize(),c.push(p.x,p.y,p.z),h.push(a/r),h.push(o/i)}for(o=1;o<=i;o++)for(a=1;a<=r;a++){var v=(r+1)*o+a-1,g=(r+1)*(o-1)+a-1,y=(r+1)*(o-1)+a,x=(r+1)*o+a;s.push(v,g,x),s.push(g,y,x)}this.setIndex(s),this.addAttribute("position",new Float32BufferAttribute(l,3)),this.addAttribute("normal",new Float32BufferAttribute(c,3)),this.addAttribute("uv",new Float32BufferAttribute(h,2))}function ExtrudeGeometry(e,t){Geometry.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new ExtrudeBufferGeometry(e,t)),this.mergeVertices()}function ExtrudeBufferGeometry(e,t){return"undefined"==typeof e?void(e=[]):(BufferGeometry.call(this),this.type="ExtrudeBufferGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),void this.computeVertexNormals())}function TextGeometry(e,t){Geometry.call(this),this.type="TextGeometry",this.parameters={text:e,parameters:t},this.fromBufferGeometry(new TextBufferGeometry(e,t)),this.mergeVertices()}function TextBufferGeometry(e,t){t=t||{};var i=t.font;if((i&&i.isFont)===!1)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Geometry;var r=i.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),ExtrudeBufferGeometry.call(this,r,t),this.type="TextBufferGeometry"}function SphereGeometry(e,t,i,r,n,o,a){Geometry.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:r,phiLength:n,thetaStart:o,thetaLength:a},this.fromBufferGeometry(new SphereBufferGeometry(e,t,i,r,n,o,a)),this.mergeVertices()}function SphereBufferGeometry(e,t,i,r,n,o,a){BufferGeometry.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:r,phiLength:n,thetaStart:o,thetaLength:a},e=e||50,t=Math.max(3,Math.floor(t)||8),i=Math.max(2,Math.floor(i)||6),r=void 0!==r?r:0,n=void 0!==n?n:2*Math.PI,o=void 0!==o?o:0,a=void 0!==a?a:Math.PI;var s,l,c=o+a,h=0,u=[],d=new Vector3,p=new Vector3,f=[],m=[],v=[],g=[];for(l=0;l<=i;l++){var y=[],x=l/i;for(s=0;s<=t;s++){var b=s/t;d.x=-e*Math.cos(r+b*n)*Math.sin(o+x*a),d.y=e*Math.cos(o+x*a),d.z=e*Math.sin(r+b*n)*Math.sin(o+x*a),m.push(d.x,d.y,d.z),p.set(d.x,d.y,d.z).normalize(),v.push(p.x,p.y,p.z),g.push(b,1-x),y.push(h++)}u.push(y)}for(l=0;l<i;l++)for(s=0;s<t;s++){var _=u[l][s+1],w=u[l][s],M=u[l+1][s],E=u[l+1][s+1];(0!==l||o>0)&&f.push(_,w,E),(l!==i-1||c<Math.PI)&&f.push(w,M,E)}this.setIndex(f),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(v,3)),this.addAttribute("uv",new Float32BufferAttribute(g,2))}function RingGeometry(e,t,i,r,n,o){Geometry.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:r,thetaStart:n,thetaLength:o},this.fromBufferGeometry(new RingBufferGeometry(e,t,i,r,n,o)),this.mergeVertices()}function RingBufferGeometry(e,t,i,r,n,o){BufferGeometry.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:r,thetaStart:n,thetaLength:o},e=e||20,t=t||50,n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI,i=void 0!==i?Math.max(3,i):8,r=void 0!==r?Math.max(1,r):1;var a,s,l,c=[],h=[],u=[],d=[],p=e,f=(t-e)/r,m=new Vector3,v=new Vector2;for(s=0;s<=r;s++){for(l=0;l<=i;l++)a=n+l/i*o,m.x=p*Math.cos(a),m.y=p*Math.sin(a),h.push(m.x,m.y,m.z),u.push(0,0,1),v.x=(m.x/t+1)/2,v.y=(m.y/t+1)/2,d.push(v.x,v.y);p+=f}for(s=0;s<r;s++){var g=s*(i+1);for(l=0;l<i;l++){a=l+g;var y=a,x=a+i+1,b=a+i+2,_=a+1;c.push(y,x,_),c.push(x,b,_)}}this.setIndex(c),this.addAttribute("position",new Float32BufferAttribute(h,3)),this.addAttribute("normal",new Float32BufferAttribute(u,3)),this.addAttribute("uv",new Float32BufferAttribute(d,2))}function LatheGeometry(e,t,i,r){Geometry.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:r},this.fromBufferGeometry(new LatheBufferGeometry(e,t,i,r)),this.mergeVertices()}function LatheBufferGeometry(e,t,i,r){BufferGeometry.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:r},t=Math.floor(t)||12,i=i||0,r=r||2*Math.PI,r=_Math.clamp(r,0,2*Math.PI);var n,o,a,s=[],l=[],c=[],h=1/t,u=new Vector3,d=new Vector2;for(o=0;o<=t;o++){var p=i+o*h*r,f=Math.sin(p),m=Math.cos(p);for(a=0;a<=e.length-1;a++)u.x=e[a].x*f,u.y=e[a].y,u.z=e[a].x*m,l.push(u.x,u.y,u.z),d.x=o/t,d.y=a/(e.length-1),c.push(d.x,d.y)}for(o=0;o<t;o++)for(a=0;a<e.length-1;a++){n=a+o*e.length;var v=n,g=n+e.length,y=n+e.length+1,x=n+1;s.push(v,g,x),s.push(g,y,x)}if(this.setIndex(s),this.addAttribute("position",new Float32BufferAttribute(l,3)),this.addAttribute("uv",new Float32BufferAttribute(c,2)),this.computeVertexNormals(),r===2*Math.PI){var b=this.attributes.normal.array,_=new Vector3,w=new Vector3,M=new Vector3;for(n=t*e.length*3,o=0,a=0;o<e.length;o++,a+=3)_.x=b[a+0],_.y=b[a+1],_.z=b[a+2],w.x=b[n+a+0],w.y=b[n+a+1],w.z=b[n+a+2],M.addVectors(_,w).normalize(),b[a+0]=b[n+a+0]=M.x,b[a+1]=b[n+a+1]=M.y,b[a+2]=b[n+a+2]=M.z}}function ShapeGeometry(e,t){Geometry.call(this),this.type="ShapeGeometry","object"==typeof t&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new ShapeBufferGeometry(e,t)),this.mergeVertices()}function ShapeBufferGeometry(e,t){function i(e){var i,s,c,h=n.length/3,u=e.extractPoints(t),d=u.shape,p=u.holes;if(ShapeUtils.isClockWise(d)===!1)for(d=d.reverse(),i=0,s=p.length;i<s;i++)c=p[i],ShapeUtils.isClockWise(c)===!0&&(p[i]=c.reverse());var f=ShapeUtils.triangulateShape(d,p);for(i=0,s=p.length;i<s;i++)c=p[i],d=d.concat(c);for(i=0,s=d.length;i<s;i++){var m=d[i];n.push(m.x,m.y,0),o.push(0,0,1),a.push(m.x,m.y)}for(i=0,s=f.length;i<s;i++){var v=f[i],g=v[0]+h,y=v[1]+h,x=v[2]+h;r.push(g,y,x),l+=3}}BufferGeometry.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:t},t=t||12;var r=[],n=[],o=[],a=[],s=0,l=0;if(Array.isArray(e)===!1)i(e);else for(var c=0;c<e.length;c++)i(e[c]),this.addGroup(s,l,c),s+=l,l=0;this.setIndex(r),this.addAttribute("position",new Float32BufferAttribute(n,3)),this.addAttribute("normal",new Float32BufferAttribute(o,3)),this.addAttribute("uv",new Float32BufferAttribute(a,2))}function EdgesGeometry(e,t){
BufferGeometry.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var i,r,n,o,a=[],s=Math.cos(_Math.DEG2RAD*t),l=[0,0],c={},h=["a","b","c"];e.isBufferGeometry?(o=new Geometry,o.fromBufferGeometry(e)):o=e.clone(),o.mergeVertices(),o.computeFaceNormals();for(var u=o.vertices,d=o.faces,p=0,f=d.length;p<f;p++)for(var m=d[p],v=0;v<3;v++)i=m[h[v]],r=m[h[(v+1)%3]],l[0]=Math.min(i,r),l[1]=Math.max(i,r),n=l[0]+","+l[1],void 0===c[n]?c[n]={index1:l[0],index2:l[1],face1:p,face2:void 0}:c[n].face2=p;for(n in c){var g=c[n];if(void 0===g.face2||d[g.face1].normal.dot(d[g.face2].normal)<=s){var y=u[g.index1];a.push(y.x,y.y,y.z),y=u[g.index2],a.push(y.x,y.y,y.z)}}this.addAttribute("position",new Float32BufferAttribute(a,3))}function CylinderGeometry(e,t,i,r,n,o,a,s){Geometry.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:a,thetaLength:s},this.fromBufferGeometry(new CylinderBufferGeometry(e,t,i,r,n,o,a,s)),this.mergeVertices()}function CylinderBufferGeometry(e,t,i,r,n,o,a,s){function l(){var o,l,c=new Vector3,x=new Vector3,b=0,_=(t-e)/i;for(l=0;l<=n;l++){var w=[],M=l/n,E=M*(t-e)+e;for(o=0;o<=r;o++){var S=o/r,T=S*s+a,C=Math.sin(T),A=Math.cos(T);x.x=E*C,x.y=-M*i+g,x.z=E*A,d.push(x.x,x.y,x.z),c.set(C,_,A).normalize(),p.push(c.x,c.y,c.z),f.push(S,1-M),w.push(m++)}v.push(w)}for(o=0;o<r;o++)for(l=0;l<n;l++){var P=v[l][o],R=v[l+1][o],L=v[l+1][o+1],B=v[l][o+1];u.push(P,R,B),u.push(R,L,B),b+=6}h.addGroup(y,b,0),y+=b}function c(i){var n,o,l,c=new Vector2,v=new Vector3,x=0,b=i===!0?e:t,_=i===!0?1:-1;for(o=m,n=1;n<=r;n++)d.push(0,g*_,0),p.push(0,_,0),f.push(.5,.5),m++;for(l=m,n=0;n<=r;n++){var w=n/r,M=w*s+a,E=Math.cos(M),S=Math.sin(M);v.x=b*S,v.y=g*_,v.z=b*E,d.push(v.x,v.y,v.z),p.push(0,_,0),c.x=.5*E+.5,c.y=.5*S*_+.5,f.push(c.x,c.y),m++}for(n=0;n<r;n++){var T=o+n,C=l+n;i===!0?u.push(C,C+1,T):u.push(C+1,C,T),x+=3}h.addGroup(y,x,i===!0?1:2),y+=x}BufferGeometry.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:a,thetaLength:s};var h=this;e=void 0!==e?e:20,t=void 0!==t?t:20,i=void 0!==i?i:100,r=Math.floor(r)||8,n=Math.floor(n)||1,o=void 0!==o&&o,a=void 0!==a?a:0,s=void 0!==s?s:2*Math.PI;var u=[],d=[],p=[],f=[],m=0,v=[],g=i/2,y=0;l(),o===!1&&(e>0&&c(!0),t>0&&c(!1)),this.setIndex(u),this.addAttribute("position",new Float32BufferAttribute(d,3)),this.addAttribute("normal",new Float32BufferAttribute(p,3)),this.addAttribute("uv",new Float32BufferAttribute(f,2))}function ConeGeometry(e,t,i,r,n,o,a){CylinderGeometry.call(this,0,e,t,i,r,n,o,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:o,thetaLength:a}}function ConeBufferGeometry(e,t,i,r,n,o,a){CylinderBufferGeometry.call(this,0,e,t,i,r,n,o,a),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:o,thetaLength:a}}function CircleGeometry(e,t,i,r){Geometry.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:r},this.fromBufferGeometry(new CircleBufferGeometry(e,t,i,r)),this.mergeVertices()}function CircleBufferGeometry(e,t,i,r){BufferGeometry.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:r},e=e||50,t=void 0!==t?Math.max(3,t):8,i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI;var n,o,a=[],s=[],l=[],c=[],h=new Vector3,u=new Vector2;for(s.push(0,0,0),l.push(0,0,1),c.push(.5,.5),o=0,n=3;o<=t;o++,n+=3){var d=i+o/t*r;h.x=e*Math.cos(d),h.y=e*Math.sin(d),s.push(h.x,h.y,h.z),l.push(0,0,1),u.x=(s[n]/e+1)/2,u.y=(s[n+1]/e+1)/2,c.push(u.x,u.y)}for(n=1;n<=t;n++)a.push(n,n+1,0);this.setIndex(a),this.addAttribute("position",new Float32BufferAttribute(s,3)),this.addAttribute("normal",new Float32BufferAttribute(l,3)),this.addAttribute("uv",new Float32BufferAttribute(c,2))}function ShadowMaterial(e){ShaderMaterial.call(this,{uniforms:UniformsUtils.merge([UniformsLib.lights,{opacity:{value:1}}]),vertexShader:ShaderChunk.shadow_vert,fragmentShader:ShaderChunk.shadow_frag}),this.lights=!0,this.transparent=!0,Object.defineProperties(this,{opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}}}),this.setValues(e)}function RawShaderMaterial(e){ShaderMaterial.call(this,e),this.type="RawShaderMaterial"}function MeshStandardMaterial(e){Material.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Color(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshPhysicalMaterial(e){MeshStandardMaterial.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function MeshPhongMaterial(e){Material.call(this),this.type="MeshPhongMaterial",this.color=new Color(16777215),this.specular=new Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshToonMaterial(e){MeshPhongMaterial.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function MeshNormalMaterial(e){Material.call(this,e),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshLambertMaterial(e){Material.call(this),this.type="MeshLambertMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function LineDashedMaterial(e){Material.call(this),this.type="LineDashedMaterial",this.color=new Color(16777215),this.linewidth=1,this.scale=1,this.dashSize=3,this.gapSize=1,this.lights=!1,this.setValues(e)}function LoadingManager(e,t,i){var r=this,n=!1,o=0,a=0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){a++,n===!1&&void 0!==r.onStart&&r.onStart(e,o,a),n=!0},this.itemEnd=function(e){o++,void 0!==r.onProgress&&r.onProgress(e,o,a),o===a&&(n=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(e){void 0!==r.onError&&r.onError(e)}}function FileLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function CompressedTextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this._parser=null}function DataTextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this._parser=null}function ImageLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function CubeTextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function TextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function Light(e,t){Object3D.call(this),this.type="Light",this.color=new Color(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function HemisphereLight(e,t,i){Light.call(this,e,i),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.groundColor=new Color(t)}function LightShadow(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new Vector2(512,512),this.map=null,this.matrix=new Matrix4}function SpotLightShadow(){LightShadow.call(this,new PerspectiveCamera(50,1,.5,500))}function SpotLight(e,t,i,r,n,o){Light.call(this,e,t),this.type="SpotLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==r?r:Math.PI/3,this.penumbra=void 0!==n?n:0,this.decay=void 0!==o?o:1,this.shadow=new SpotLightShadow}function PointLight(e,t,i,r){Light.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==r?r:1,this.shadow=new LightShadow(new PerspectiveCamera(90,1,.5,500))}function DirectionalLightShadow(){LightShadow.call(this,new OrthographicCamera(-5,5,5,-5,.5,500))}function DirectionalLight(e,t){Light.call(this,e,t),this.type="DirectionalLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,this.shadow=new DirectionalLightShadow}function AmbientLight(e,t){Light.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function RectAreaLight(e,t,i,r){Light.call(this,e,t),this.type="RectAreaLight",this.position.set(0,1,0),this.updateMatrix(),this.width=void 0!==i?i:10,this.height=void 0!==r?r:10}function Interpolant(e,t,i,r){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==r?r:new t.constructor(i),this.sampleValues=t,this.valueSize=i}function CubicInterpolant(e,t,i,r){Interpolant.call(this,e,t,i,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function LinearInterpolant(e,t,i,r){Interpolant.call(this,e,t,i,r)}function DiscreteInterpolant(e,t,i,r){Interpolant.call(this,e,t,i,r)}function KeyframeTrackConstructor(e,t,i,r){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=AnimationUtils.convertArray(t,this.TimeBufferType),this.values=AnimationUtils.convertArray(i,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation),this.validate(),this.optimize()}function VectorKeyframeTrack(e,t,i,r){KeyframeTrackConstructor.call(this,e,t,i,r)}function QuaternionLinearInterpolant(e,t,i,r){Interpolant.call(this,e,t,i,r)}function QuaternionKeyframeTrack(e,t,i,r){KeyframeTrackConstructor.call(this,e,t,i,r)}function NumberKeyframeTrack(e,t,i,r){KeyframeTrackConstructor.call(this,e,t,i,r)}function StringKeyframeTrack(e,t,i,r){KeyframeTrackConstructor.call(this,e,t,i,r)}function BooleanKeyframeTrack(e,t,i){KeyframeTrackConstructor.call(this,e,t,i)}function ColorKeyframeTrack(e,t,i,r){KeyframeTrackConstructor.call(this,e,t,i,r)}function KeyframeTrack(e,t,i,r){KeyframeTrackConstructor.apply(this,arguments)}function AnimationClip(e,t,i){this.name=e,this.tracks=i,this.duration=void 0!==t?t:-1,this.uuid=_Math.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function MaterialLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.textures={}}function BufferGeometryLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function Loader(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function JSONLoader(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:DefaultLoadingManager,this.withCredentials=!1}function ObjectLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.texturePath=""}function CatmullRom(e,t,i,r,n){var o=.5*(r-t),a=.5*(n-i),s=e*e,l=e*s;return(2*i-2*r+o+a)*l+(-3*i+3*r-2*o-a)*s+o*e+i}function QuadraticBezierP0(e,t){var i=1-e;return i*i*t}function QuadraticBezierP1(e,t){return 2*(1-e)*e*t}function QuadraticBezierP2(e,t){return e*e*t}function QuadraticBezier(e,t,i,r){return QuadraticBezierP0(e,t)+QuadraticBezierP1(e,i)+QuadraticBezierP2(e,r)}function CubicBezierP0(e,t){var i=1-e;return i*i*i*t}function CubicBezierP1(e,t){var i=1-e;return 3*i*i*e*t}function CubicBezierP2(e,t){return 3*(1-e)*e*e*t}function CubicBezierP3(e,t){return e*e*e*t}function CubicBezier(e,t,i,r,n){return CubicBezierP0(e,t)+CubicBezierP1(e,i)+CubicBezierP2(e,r)+CubicBezierP3(e,n)}function Curve(){this.arcLengthDivisions=200}function LineCurve(e,t){Curve.call(this),this.v1=e,this.v2=t}function CurvePath(){Curve.call(this),this.curves=[],this.autoClose=!1}function EllipseCurve(e,t,i,r,n,o,a,s){Curve.call(this),this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=r,this.aStartAngle=n,this.aEndAngle=o,this.aClockwise=a,this.aRotation=s||0}function SplineCurve(e){Curve.call(this),this.points=void 0===e?[]:e}function CubicBezierCurve(e,t,i,r){Curve.call(this),this.v0=e,this.v1=t,this.v2=i,this.v3=r}function QuadraticBezierCurve(e,t,i){Curve.call(this),this.v0=e,this.v1=t,this.v2=i}function Path(e){CurvePath.call(this),this.currentPoint=new Vector2,e&&this.fromPoints(e)}function Shape(){Path.apply(this,arguments),this.holes=[]}function ShapePath(){this.subPaths=[],this.currentPath=null}function Font(e){this.data=e}function FontLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function AudioLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function StereoCamera(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new PerspectiveCamera,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new PerspectiveCamera,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function ArrayCamera(e){PerspectiveCamera.call(this),this.enabled=!1,this.cameras=e||[]}function AudioListener(){Object3D.call(this),this.type="AudioListener",this.context=AudioContext$1.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function Audio$1(e){Object3D.call(this),this.type="Audio",this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function PositionalAudio(e){Audio$1.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function AudioAnalyser(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function PropertyMixer(e,t,i){this.binding=e,this.valueSize=i;var r,n=Float64Array;switch(t){case"quaternion":r=this._slerp;break;case"string":case"bool":n=Array,r=this._select;break;default:r=this._lerp}this.buffer=new n(4*i),this._mixBufferRegion=r,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function Composite(e,t,i){var r=i||PropertyBinding.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,r)}function PropertyBinding(e,t,i){this.path=t,this.parsedPath=i||PropertyBinding.parseTrackName(t),this.node=PropertyBinding.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function AnimationObjectGroup(e){this.uuid=_Math.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var i=0,r=arguments.length;i!==r;++i)t[arguments[i].uuid]=i;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var n=this;this.stats={objects:{get total(){return n._objects.length},get inUse(){return this.total-n.nCachedObjects_}},get bindingsPerObject(){return n._bindings.length}}}function AnimationAction(e,t,i){this._mixer=e,this._clip=t,this._localRoot=i||null;for(var r=t.tracks,n=r.length,o=new Array(n),a={endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding},s=0;s!==n;++s){var l=r[s].createInterpolant(null);o[s]=l,l.settings=a}this._interpolantSettings=a,this._interpolants=o,this._propertyBindings=new Array(n),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=LoopRepeat,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function AnimationMixer(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Uniform(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function InstancedBufferGeometry(){BufferGeometry.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function InterleavedBufferAttribute(e,t,i,r){this.uuid=_Math.generateUUID(),this.data=e,this.itemSize=t,this.offset=i,this.normalized=r===!0}function InterleavedBuffer(e,t){this.uuid=_Math.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function InstancedInterleavedBuffer(e,t,i){InterleavedBuffer.call(this,e,t),this.meshPerAttribute=i||1}function InstancedBufferAttribute(e,t,i){BufferAttribute.call(this,e,t),this.meshPerAttribute=i||1}function Raycaster(e,t,i,r){this.ray=new Ray(e,t),this.near=i||0,this.far=r||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function ascSort(e,t){return e.distance-t.distance}function intersectObject(e,t,i,r){if(e.visible!==!1&&(e.raycast(t,i),r===!0))for(var n=e.children,o=0,a=n.length;o<a;o++)intersectObject(n[o],t,i,!0)}function Clock(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function Spherical(e,t,i){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==i?i:0,this}function Cylindrical(e,t,i){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==i?i:0,this}function VertexNormalsHelper(e,t,i,r){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==i?i:16711680,o=void 0!==r?r:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=3*s.faces.length:s&&s.isBufferGeometry&&(a=s.attributes.normal.count);var l=new BufferGeometry,c=new Float32BufferAttribute(2*a*3,3);l.addAttribute("position",c),LineSegments.call(this,l,new LineBasicMaterial({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function SkeletonHelper(e){this.bones=this.getBoneList(e);for(var t=new BufferGeometry,i=[],r=[],n=new Color(0,0,1),o=new Color(0,1,0),a=0;a<this.bones.length;a++){var s=this.bones[a];s.parent&&s.parent.isBone&&(i.push(0,0,0),i.push(0,0,0),r.push(n.r,n.g,n.b),r.push(o.r,o.g,o.b))}t.addAttribute("position",new Float32BufferAttribute(i,3)),t.addAttribute("color",new Float32BufferAttribute(r,3));var l=new LineBasicMaterial({vertexColors:VertexColors,depthTest:!1,depthWrite:!1,transparent:!0});LineSegments.call(this,t,l),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function HemisphereLightHelper(e,t){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;var i=new OctahedronBufferGeometry(t);i.rotateY(.5*Math.PI);var r=new MeshBasicMaterial({vertexColors:VertexColors,wireframe:!0}),n=i.getAttribute("position"),o=new Float32Array(3*n.count);i.addAttribute("color",new BufferAttribute(o,3)),this.add(new Mesh(i,r)),this.update()}function FaceNormalsHelper(e,t,i,r){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==i?i:16776960,o=void 0!==r?r:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var l=new BufferGeometry,c=new Float32BufferAttribute(2*a*3,3);l.addAttribute("position",c),LineSegments.call(this,l,new LineBasicMaterial({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function CameraHelper(e){function t(e,t,r){i(e,r),i(t,r)}function i(e,t){o.push(0,0,0),a.push(t.r,t.g,t.b),void 0===s[e]&&(s[e]=[]),s[e].push(o.length/3-1)}var r=new BufferGeometry,n=new LineBasicMaterial({color:16777215,vertexColors:FaceColors}),o=[],a=[],s={},l=new Color(16755200),c=new Color(16711680),h=new Color(43775),u=new Color(16777215),d=new Color(3355443);t("n1","n2",l),t("n2","n4",l),t("n4","n3",l),t("n3","n1",l),t("f1","f2",l),t("f2","f4",l),t("f4","f3",l),t("f3","f1",l),t("n1","f1",l),t("n2","f2",l),t("n3","f3",l),t("n4","f4",l),t("p","n1",c),t("p","n2",c),t("p","n3",c),t("p","n4",c),t("u1","u2",h),t("u2","u3",h),t("u3","u1",h),t("c","t",u),t("p","c",d),t("cn1","cn2",d),t("cn3","cn4",d),t("cf1","cf2",d),t("cf3","cf4",d),r.addAttribute("position",new Float32BufferAttribute(o,3)),r.addAttribute("color",new Float32BufferAttribute(a,3)),LineSegments.call(this,r,n),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=s,this.update()}function CubicPoly(){function e(e,o,a,s){t=e,i=a,r=-3*e+3*o-2*a-s,n=2*e-2*o+a+s}var t=0,i=0,r=0,n=0;return{initCatmullRom:function(t,i,r,n,o){e(i,r,o*(r-t),o*(n-i))},initNonuniformCatmullRom:function(t,i,r,n,o,a,s){var l=(i-t)/o-(r-t)/(o+a)+(r-i)/a,c=(r-i)/a-(n-i)/(a+s)+(n-r)/s;l*=a,c*=a,e(i,r,l,c)},calc:function(e){var o=e*e,a=o*e;return t+i*e+r*o+n*a}}}function CatmullRomCurve3(e){Curve.call(this),this.points=e||[],this.closed=!1}function MultiMaterial(e){return void 0===e&&(e=[]),console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,e.materials=e,e.clone=function(){return e.slice()},e}function Spline(e){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),CatmullRomCurve3.call(this,e),this.type="catmullrom"}function hub(){return new Object3D}function findProperty(e,t){for(var i=0;i<t.length;++i)if(t[i]in e)return t[i]}function cache(e,t,i){return _cache[e]?i&&i(_cache[e]):_cache[e]=t(),_cache[e]}function deleteSetting(e){window.localStorage&&window.localStorage.removeItem(e)}function getSetting(e,t){if(window.localStorage){var i=window.localStorage.getItem(e);if(i)try{return JSON.parse(i)}catch(t){console.error("getSetting",e,i,"undefined"==typeof i?"undefined":_typeof(i),t),console.error(t),console.error("getSetting",e,i,"undefined"==typeof i?"undefined":_typeof(i))}}return t}function hax(e,t,i){var r=e[t];r&&(e[t]=function(){var e=Array.prototype.slice.call(arguments);return i(r,e)})}function haxClass(e,t,i){hax(e,t,function(e,t){i(t),t.unshift(null);var r=e.bind.apply(e,t);return new r})}function haxFunction(e,t,i){hax(e,t,function(t,r){i(r);var n=t.apply(e,r);return n})}function injectIceServers(e,t){haxClass(e,t,function(e){window.HAXICE||(window.HAXICE=e[0]),e[0]=e[0]||window.HAXICE})}function injectUserMedia(e,t){haxFunction(e,t,function(e){e[0]=window.HAKBOX||e[0]})}function identity(e){return e}function immutable(e){var t="function"==typeof e?e:function(){return e};return{enumerable:!0,configurable:!0,get:t,set:function(){throw new Error("This value is immutable and may only be read, not written.")}}}function isTimestampDeltaValid(e){return!isNaN(e)&&MIN_TIMESTEP<e&&e<=MAX_TIMESTEP}function mutable(e,t){return t?"function"==typeof t?{enumerable:!0,configurable:!0,get:function(){return e},set:function(i){if(i instanceof t)throw new Error("Value must be a "+t+": "+i);e=i}}:{enumerable:!0,configurable:!0,get:function(){return e},set:function(i){var r="undefined"==typeof i?"undefined":_typeof(i);if(r!==t)throw new Error("Value must be a "+t+". An "+r+" was provided instead: "+i);e=i}}:{enumerable:!0,configurable:!0,get:function(){return e},set:function(t){e=t}}}function lock(e){var t=screen.orientation&&screen.orientation.type||screen.mozOrientation||"";if(t.indexOf("landscape")===-1&&(t="landscape-primary"),screen.orientation&&screen.orientation.lock)return screen.orientation.lock(t);if(!screen.mozLockOrientation)return Promise.reject(new Error("Pointer lock not supported."));var i=screen.mozLockOrientation(t);return i?Promise.resolve(e):void 0}function unlock(){screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.mozUnlockOrientation&&screen.mozUnlockOrientation()}function promisify(e,t){return new Promise(function(i,r){var n=e(function(e,o){e?r(e):i(o||n||t)})})}function setSetting(e,t){if(window.localStorage&&t)try{window.localStorage.setItem(e,JSON.stringify(t))}catch(i){console.error("setSetting",e,t,"undefined"==typeof t?"undefined":_typeof(t),i)}}function standardUnlockBehavior(){return isMobile?(Orientation.unlock(),Promise.resolve()):PointerLock.exit().catch(function(e){return console.warn("PointerLock exit failed",e)})}function standardExitFullScreenBehavior(){return standardUnlockBehavior().then(function(){return FullScreen.exit()}).catch(function(e){return console.warn("FullScreen failed",e)})}function standardLockBehavior(e){return isiOS?Promise.resolve(e):isMobile?Orientation.lock(e).catch(function(e){return console.warn("OrientationLock failed",e)}):PointerLock.request(e).catch(function(e){return console.warn("PointerLock failed",e)})}function standardFullScreenBehavior(e){return FullScreen.request(e).catch(function(e){return console.warn("FullScreen failed",e)}).then(standardLockBehavior)}function material(e,t){void 0===t&&"string"!=typeof e&&(t=e,e="none"),t=Object.assign({},{opacity:1,roughness:.5,metalness:0,color:16777215,useFog:!0,unshaded:!1,wireframe:!1,side:FrontSide},t);var i="Primrose.material("+e+", "+t.color+", "+t.unshaded+", "+t.side+", "+t.opacity+", "+t.roughness+", "+t.metalness+", "+t.color+", "+t.emissive+", "+t.wireframe+", "+t.useFog+")";return cache(i,function(){var e={fog:t.useFog,transparent:t.transparent||void 0!==t.opacity&&t.opacity<1,opacity:t.opacity,side:t.side||FrontSide},i=MeshStandardMaterial;t.unshaded?(e.shading=FlatShading,i=MeshBasicMaterial):(e.roughness=t.roughness,e.metalness=t.metalness,void 0!==t.emissive&&(e.emissive=t.emissive));var r=new i(e);return("number"==typeof t.color||t.color instanceof Number)&&r.color.set(t.color),r.wireframe=t.wireframe,r})}function loadTexture(e,t,i){var r=null;return t instanceof Array&&6===t.length?r=new CubeTextureLoader:(t instanceof HTMLImageElement&&(t=t.src),"string"==typeof t&&(r=new TextureLoader)),r&&r.setCrossOrigin("anonymous"),cache("Texture("+e+")",function(){return new Promise(function(e,n){r?r.load(t,e,i,n):e(new Texture(t))})})}function textured(e,t,i){i||(i={}),i.txtRepeatX||(i.txtRepeatX=1),i.txtRepeatY||(i.txtRepeatY=1),i.anisotropy||(i.anisotropy=1);var r="undefined"==typeof t?"undefined":_typeof(t),n=null;if("object"===r)t.id?n=t.id:(seenElements.has(t)||(seenElements.set(t,"TextureAutoID"+seenElementCount),++seenElementCount),n=seenElements.get(t));else if("string"===r)n=t;else{var o=new Error("Couldn't figure out how to make a texture out of typeof '"+r+"', value "+t+".");if(!i.reject)throw o;i.reject(o)}var a="Primrose.textured("+n+", "+i.txtRepeatX+", "+i.txtRepeatY+", "+i.anisotropy+", "+i.scaleTextureWidth+", "+i.scaleTextureHeight+")",s=cache(a,function(){if("string"==typeof t||t instanceof Array||6===t.length)return loadTexture(a,t,i.progress);var e=null;return t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof HTMLImageElement?e=new Texture(t):t.isTexture?e=t:Promise.reject("Texture description couldn't be converted to a THREE.Texture object"),Promise.resolve(e)}),l=material(a,i),c=null;if(e.type.indexOf("Geometry")>-1?c=new Mesh(e,l):e.isMesh&&(c=e,c.material=l,e=c.geometry),i.shadow&&(c.receiveShadow=!0,c.castShadow=!0),i.scaleTextureWidth||i.scaleTextureHeight)if(e.attributes&&e.attributes.uv&&e.attributes.uv.array){var h,u=e.attributes.uv,d=u.array;if(i.scaleTextureWidth)for(h=0;h<d.length;h+=u.itemSize)d[h]*=i.scaleTextureWidth;if(i.scaleTextureHeight)for(h=1;h<d.length;h+=u.itemSize)d[h]=1-(1-d[h])*i.scaleTextureHeight}else console.trace(e,i);return i.promise=s.then(function(e){return i.txtRepeatX*i.txtRepeatY>1&&(e.wrapS=e.wrapT=RepeatWrapping,e.repeat.set(i.txtRepeatX,i.txtRepeatY)),e.anisotropy=i.anisotropy,e.isCubeTexture?l.envMap=e:e.isTexture&&(l.map=e),l.needsUpdate=!0,e.needsUpdate=!0,e}),c}function colored(e,t,i){i=i||{},i.color=t;var r=material("",i),n=null;return e.type.indexOf("Geometry")>-1?n=new Mesh(e,r):e.isObject3D&&(n=e,n.material=r),i.shadow&&(n.receiveShadow=!0,n.castShadow=!0),i.resolve&&i.resolve(),n}function box(e,t,i,r,n,o){return void 0===t&&(t=e),void 0===i&&(i=e),cache("BoxBufferGeometry("+e+", "+t+", "+i+", "+r+", "+n+", "+o+")",function(){return new BoxBufferGeometry(e,t,i,r,n,o)})}function brick(e,t,i,r,n){t=t||1,i=i||1,r=r||1,n=Object.assign({},{txtRepeatX:t,txtRepeatY:r,anisotropy:8,transparent:!0,opacity:1},n);var o="number"==typeof e?colored:textured,a=o(box(t,i,r),e,n);return a}function axis(e,t){return hub().add(brick(16711680,e,t,t)).add(brick(65280,t,e,t)).add(brick(255,t,t,e))}function intervalometer(e,t,i,r){function n(i){o=t(n,r),e(i-(a||i)),a=i}var o,a;return{start:function(){o||n(0)},stop:function(){i(o),o=null,a=0}}}function frameIntervalometer(e){return intervalometer(e,requestAnimationFrame,cancelAnimationFrame)}function preventEvent(e,t,i,r){function n(t){Boolean(e[i])===Boolean(r)&&t.stopImmediatePropagation(),delete e[i]}return e.addEventListener(t,n,!1),n}function proxyProperty(e,t,i,r){function n(){return i[t]}function o(e){i[t]=e}r&&o(e[t]),Object.defineProperty(e,t,{get:n,set:o})}function proxyEvent(e,t,i){i.addEventListener(t,function(){return e.dispatchEvent(new Event(t))})}function dispatchEventAsync(e,t){Promise.resolve().then(function(){e.dispatchEvent(new Event(t))})}function getAudioFromVideo(e){var t=new Audio;return proxyEvent(e,"play",t),proxyEvent(e,"playing",t),proxyEvent(e,"pause",t),t.crossOrigin=e.crossOrigin,t.src=e.src||e.currentSrc||"data:",t}function setTime(e,t,i){(lastTimeupdateEvent||0)+200<Date.now()&&(e[ಠevent]=!0,lastTimeupdateEvent=Date.now()),i||(e.currentTime=t),lastRequests[++requestIndex%3]=100*t|0}function isPlayerEnded(e){return e.driver.currentTime>=e.video.duration}function update(e){var t=this;t.video.readyState>=t.video.HAVE_FUTURE_DATA?(t.hasAudio||(t.driver.currentTime=t.video.currentTime+e*t.video.playbackRate/1e3,t.video.loop&&isPlayerEnded(t)&&(t.driver.currentTime=0)),setTime(t.video,t.driver.currentTime)):t.video.networkState!==t.video.NETWORK_IDLE||t.video.buffered.length||t.video.load(),t.video.ended&&(delete t.video[ಠevent],t.video.pause(!0))}function play(){var e=this,t=e[ಠ];return e.webkitDisplayingFullscreen?void e[ಠplay]():("data:"!==t.driver.src&&t.driver.src!==e.src&&(setTime(e,0,!0),t.driver.src=e.src),void(e.paused&&(t.paused=!1,e.buffered.length||e.load(),
t.driver.play(),t.updater.start(),t.hasAudio||(dispatchEventAsync(e,"play"),t.video.readyState>=t.video.HAVE_ENOUGH_DATA&&dispatchEventAsync(e,"playing")))))}function pause(e){var t=this,i=t[ಠ];i.driver.pause(),i.updater.stop(),t.webkitDisplayingFullscreen&&t[ಠpause](),i.paused&&!e||(i.paused=!0,i.hasAudio||dispatchEventAsync(t,"pause"),t.ended&&(t[ಠevent]=!0,dispatchEventAsync(t,"ended")))}function addPlayer(e,t){var i=e[ಠ]={};i.paused=!0,i.hasAudio=t,i.video=e,i.updater=frameIntervalometer(update.bind(i)),t?i.driver=getAudioFromVideo(e):(e.addEventListener("canplay",function(){e.paused||dispatchEventAsync(e,"playing")}),i.driver={src:e.src||e.currentSrc||"data:",muted:!0,paused:!0,pause:function(){i.driver.paused=!0},play:function(){i.driver.paused=!1,isPlayerEnded(i)&&setTime(e,0)},get ended(){return isPlayerEnded(i)}}),e.addEventListener("emptied",function(){var t=!i.driver.src||"data:"===i.driver.src;i.driver.src&&i.driver.src!==e.src&&(setTime(e,0,!0),i.driver.src=e.src,t?i.driver.play():i.updater.stop())},!1),e.addEventListener("webkitbeginfullscreen",function(){e.paused?t&&!i.driver.buffered.length&&i.driver.load():(e.pause(),e[ಠplay]())}),t&&(e.addEventListener("webkitendfullscreen",function(){i.driver.currentTime=e.currentTime}),e.addEventListener("seeking",function(){lastRequests.indexOf(100*e.currentTime|0)<0&&(i.driver.currentTime=e.currentTime)}))}function overloadAPI(e){var t=e[ಠ];e[ಠplay]=e.play,e[ಠpause]=e.pause,e.play=play,e.pause=pause,proxyProperty(e,"paused",t.driver),proxyProperty(e,"muted",t.driver,!0),proxyProperty(e,"playbackRate",t.driver,!0),proxyProperty(e,"ended",t.driver),proxyProperty(e,"loop",t.driver,!0),preventEvent(e,"seeking"),preventEvent(e,"seeked"),preventEvent(e,"timeupdate",ಠevent,!1),preventEvent(e,"ended",ಠevent,!1)}function enableInlineVideo(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!0),i&&!isWhitelisted||e[ಠ]||(addPlayer(e,t),overloadAPI(e),e.classList.add("IIV"),!t&&e.autoplay&&e.play(),/iPhone|iPod|iPad/.test(navigator.platform)||console.warn("iphone-inline-video is not guaranteed to work in emulated environments"))}function preStepAllEntities(){for(var e=0;e<entities$1.length;++e)entities$1[e].preStep()}function postStepAllEntities(){for(var e=0;e<entities$1.length;++e)entities$1[e].postStep()}function updateAllEntities(){for(var e=0;e<entities$1.length;++e)entities$1[e].update()}function updateAll(){for(var e=0;e<entities.length;++e){var t=entities[e];t.eyeBlank(0),t.update()}}function eyeBlankAll(e){for(var t=0;t<entities.length;++t){var i=entities[t];i.eyeBlank(e)}}function findAndFixVideo(e){for(var t=document.querySelectorAll("video"),i=0;i<t.length;++i)fixVideo(t[i]);window.removeEventListener("touchend",findAndFixVideo),window.removeEventListener("mouseup",findAndFixVideo),window.removeEventListener("keyup",findAndFixVideo)}function fixVideo(e){isiOS&&processedVideos.indexOf(e)===-1&&(processedVideos.push(e),enableInlineVideo(e,!1))}function camera(e,t){return t=Object.assign({width:1,height:.6,unshaded:!0,transparent:!0,opacity:.5},t),navigator.mediaDevices.enumerateDevices().catch(console.error.bind(console,"ERR [enumerating devices]:>")).then(function(t){return t.filter(function(e){return"videoinput"===e.kind})[e]}).catch(console.error.bind(console,"ERR [filtering devices]:>")).then(function(e){return navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId,width:{ideal:1280},height:{ideal:768}}})}).catch(console.error.bind(console,"ERR [getting media access]:>")).then(function(e){return new Video(e,t).ready}).catch(console.error.bind(console,"ERR [creating image]:>"))}function circle(e,t,i,r){return e=e||1,t=t||18,cache("CircleBufferGeometry("+e+", "+t+", "+i+", "+r+")",function(){return new CircleBufferGeometry(e,t,i,r)})}function cloud(e,t,i){for(var r=new Geometry,n=0;n<e.length;++n)r.vertices.push(e[n]);var o=cache("PointsMaterial("+t+", "+i+")",function(){return new PointsMaterial({color:t,size:i})});return new Points(r,o)}function cylinder(e,t,i,r,n,o,a,s){return void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===i&&(i=1),cache("CylinderBufferGeometry("+e+", "+t+", "+i+", "+r+", "+n+", "+o+", "+a+", "+s+")",function(){return new CylinderBufferGeometry(e,t,i,r,n,o,a,s)})}function light(e,t,i,r){return new PointLight(e,t,i,r)}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}function phys(e,t){t=Object.assign({},t);var i=new Entity(e.name,t);if(e.name="",i.mesh=e,i.add(e),i.rigidBody=new cannon.Body(t),i.rigidBody.position.copy(e.position),i.rigidBody.quaternion.copy(e.quaternion),e.position.set(0,0,0),e.quaternion.set(0,0,0,1),!t.disableAutoShape&&e.geometry){var r=e.geometry;r.computeBoundingSphere(),r.computeBoundingBox(),r.boundingBox.getSize(TEMP);var n=r.boundingSphere.radius*r.boundingSphere.radius*Math.PI,o=TEMP.x*TEMP.y*TEMP.z;n<o?i.rigidBody.addShape(new cannon.Sphere(r.boundingSphere.radius)):(TEMP.multiplyScalar(.5),i.rigidBody.addShape(new cannon.Box((new cannon.Vec3).copy(TEMP))))}return i}function fixGeometry(e,t){t=t||{};var i=t.maxU||1,r=t.maxV||1,n=e.attributes||e._bufferGeometry&&e._bufferGeometry.attributes;if(n&&n.uv&&n.uv.array){for(var o=n.uv,a=o.array,s=0;s<a.length;s+=o.itemSize)a[s]*=i;for(var l=1;l<a.length;l+=o.itemSize)a[l]=1-(1-a[l])*r}else if(e.faceVertexUvs)for(var c=e.faceVertexUvs,h=0;h<c.length;++h)for(var u=c[h],d=0;d<u.length;++d)for(var p=u[d],f=0;f<p.length;++f){var m=p[f];m.x*=i,m.y=1-(1-m.y)*r}return e}function quad(e,t,i){return void 0===e&&(e=1),void 0===t&&(t=e),i=Object.assign({},{s:1,t:1},i),cache("PlaneBufferGeometry("+e+", "+t+", "+i.s+", "+i.t+", "+i.maxU+", "+i.maxV+")",function(){return fixGeometry(new PlaneBufferGeometry(e,t,i.s,i.t),i)})}function quat(e,t,i,r){return new Quaternion(e,t,i,r)}function range(e,t,i,r){var n=i&&e||0,o=i&&t||e,a=r&&i||1,s=r||i||t,l=null;s instanceof Function||(s=identity);for(var c=n;c<o;c+=a){var h=s(c);null===l&&void 0!==h&&(l=[]),null!==l&&l.push(h)}if(null!==l)return l}function raycaster(){return new Raycaster}function ring(e,t,i,r,n,o){return void 0===e&&(e=.5),i=i||18,r=r||1,t=t||1,n=n||0,o=o||2*Math.PI,cache("RingBufferGeometry("+e+", "+t+", "+i+", "+r+", "+n+", "+o+")",function(){return new RingBufferGeometry(e,t,i,r,n,o)})}function shell(e,t,i,r,n,o){void 0===r&&(r=Math.PI*SLICE),void 0===n&&(n=Math.PI*SLICE*.6);var a=1.5*Math.PI-.5*r,s=.5*(Math.PI-n);return o=o||{},cache("InsideSphereGeometry("+e+", "+t+", "+i+", "+r+", "+n+")",function(){return fixGeometry(new InsideSphereGeometry(e,t,i,a,r,s,n,!0),o)})}function sphere(e,t,i){return cache("SphereGeometry("+e+", "+t+", "+i+")",function(){return new SphereGeometry(e,t,i)})}function spring(e,t,i){var r=new Spring(e,t,i);return e.components.push(r),r}function v2(e,t){return new Vector2(e,t)}function v3(e,t,i){return new Vector3(e,t,i)}function v4(e,t,i,r){return new Vector4(e,t,i,r)}function XHR(e,t,i,r){return new Promise(function(n,o){r=r||{},r.headers=r.headers||{},"POST"===e&&(r.headers["Content-Type"]=r.headers["Content-Type"]||t);var a=new XMLHttpRequest;a.onerror=function(e){return o(new Error("Request error: "+e.message))},a.onabort=function(e){return o(new Error("Request abort: "+e.message))},a.onload=function(){a.status<400?n(a.response):o(a)},a.open(e,i),t&&(a.responseType=t),a.onprogress=r.progress;for(var s in r.headers)a.setRequestHeader(s,r.headers[s]);a.withCredentials=!!r.withCredentials,r.data?a.send(JSON.stringify(r.data)):a.send()})}function get$1(e,t,i){return XHR("GET",e||"text",t,i)}function getBuffer(e,t){return get$1("arraybuffer",e,t)}function cascadeElement(e,t,i,r){var n=null;if(null===e?(n=document.createElement(t),n.id=e="auto_"+t+Date.now()):void 0===i||e instanceof i?n=e:"string"==typeof e&&(n=document.getElementById(e)||document.querySelector(e),null===n?(n=document.createElement(t),n.id=e,r&&document.body.appendChild(n)):n.tagName!==t.toUpperCase()&&(n=null)),null===n)throw new Error(e+" does not refer to a valid "+t+" element.");return n}function hasGazeEvent(e){return e&&e._listeners&&(e._listeners.gazecomplete&&e._listeners.gazecomplete.length>0||e._listeners.select&&e._listeners.select.length>0||e._listeners.click&&e._listeners.click.length>0)}function loader(e,t){return function(i){return ModelFactory.loadObject(e[t]).then(function(e){return i[t]=e,i})}}function fixJSONScene(e){return e.traverse(function(e){e.geometry&&(e.geometry.computeBoundingSphere(),e.geometry.computeBoundingBox())}),e}function fixOBJScene(e){return"Group"===e.type&&1===e.children.length&&e.children[0].isMesh?e.children[0]:e}function setProperties(e){return e.traverse(function(e){if(e.isMesh)for(var t in propertyTests)e[t]=e[t]||propertyTests[t](e)}),e}function mat4_perspectiveFromFieldOfView(e,t,i,r){var n=Math.tan(t?t.upDegrees*piOver180:rad45),o=Math.tan(t?t.downDegrees*piOver180:rad45),a=Math.tan(t?t.leftDegrees*piOver180:rad45),s=Math.tan(t?t.rightDegrees*piOver180:rad45),l=2/(a+s),c=2/(n+o);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-((a-s)*l*.5),e[9]=(n-o)*c*.5,e[10]=r/(i-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*i/(i-r),e[15]=0,e}function mat4_fromRotationTranslation(e,t,i){var r=t[0],n=t[1],o=t[2],a=t[3],s=r+r,l=n+n,c=o+o,h=r*s,u=r*l,d=r*c,p=n*l,f=n*c,m=o*c,v=a*s,g=a*l,y=a*c;return e[0]=1-(p+m),e[1]=u+y,e[2]=d-g,e[3]=0,e[4]=u-y,e[5]=1-(h+m),e[6]=f+v,e[7]=0,e[8]=d+g,e[9]=f-v,e[10]=1-(h+p),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function mat4_translate(e,t,i){var r,n,o,a,s,l,c,h,u,d,p,f,m=i[0],v=i[1],g=i[2];return t===e?(e[12]=t[0]*m+t[4]*v+t[8]*g+t[12],e[13]=t[1]*m+t[5]*v+t[9]*g+t[13],e[14]=t[2]*m+t[6]*v+t[10]*g+t[14],e[15]=t[3]*m+t[7]*v+t[11]*g+t[15]):(r=t[0],n=t[1],o=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],p=t[10],f=t[11],e[0]=r,e[1]=n,e[2]=o,e[3]=a,e[4]=s,e[5]=l,e[6]=c,e[7]=h,e[8]=u,e[9]=d,e[10]=p,e[11]=f,e[12]=r*m+s*v+u*g+t[12],e[13]=n*m+l*v+d*g+t[13],e[14]=o*m+c*v+p*g+t[14],e[15]=a*m+h*v+f*g+t[15]),e}function mat4_invert(e,t){var i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],u=t[9],d=t[10],p=t[11],f=t[12],m=t[13],v=t[14],g=t[15],y=i*s-r*a,x=i*l-n*a,b=i*c-o*a,_=r*l-n*s,w=r*c-o*s,M=n*c-o*l,E=h*m-u*f,S=h*v-d*f,T=h*g-p*f,C=u*v-d*m,A=u*g-p*m,P=d*g-p*v,R=y*P-x*A+b*C+_*T-w*S+M*E;return R?(R=1/R,e[0]=(s*P-l*A+c*C)*R,e[1]=(n*A-r*P-o*C)*R,e[2]=(m*M-v*w+g*_)*R,e[3]=(d*w-u*M-p*_)*R,e[4]=(l*T-a*P-c*S)*R,e[5]=(i*P-n*T+o*S)*R,e[6]=(v*b-f*M-g*x)*R,e[7]=(h*M-d*b+p*x)*R,e[8]=(a*A-s*T+c*E)*R,e[9]=(r*T-i*A-o*E)*R,e[10]=(f*w-m*b+g*y)*R,e[11]=(u*b-h*w-p*y)*R,e[12]=(s*S-a*C-l*E)*R,e[13]=(i*C-r*S+n*E)*R,e[14]=(m*x-f*_-v*y)*R,e[15]=(h*_-u*x+d*y)*R,e):null}function updateEyeMatrices(e,t,i,r,n){mat4_perspectiveFromFieldOfView(e,r?r.fieldOfView:null,n.depthNear,n.depthFar);var o=i.orientation||defaultOrientation,a=i.position||defaultPosition;mat4_fromRotationTranslation(t,o,a),r&&mat4_translate(t,t,r.offset),mat4_invert(t,t)}function frameDataFromPose(e,t,i){return!(!e||!t)&&(e.pose=t,e.timestamp=t.timestamp,updateEyeMatrices(e.leftProjectionMatrix,e.leftViewMatrix,t,i.getEyeParameters("left"),i),updateEyeMatrices(e.rightProjectionMatrix,e.rightViewMatrix,t,i.getEyeParameters("right"),i),!0)}function calculateElementSize(e){var t=0,i=0;return isiOS?isLandscape()?(t=screen.height,i=screen.width):(t=screen.width,i=screen.height):(t=document.body.clientWidth,i=document.body.clientHeight),t*=devicePixelRatio,i*=devicePixelRatio,{width:t,height:i}}function getDefaultFieldOfView(){return defaultFieldOfView}function setDefaultFieldOfView(e){defaultFieldOfView=e}function calcFoV(e,t,i){return RAD2DEG$1*Math.atan(Math.tan(DEG2RAD$1*e)*t/i)}function getMonoscopicEyeParameters(e){if("left"===e){var t=calculateElementSize(this),i=void 0,r=void 0;return t.height>t.width?(i=defaultFieldOfView/2,r=calcFoV(i,t.width,t.height)):(r=defaultFieldOfView/2,i=calcFoV(r,t.height,t.width)),{fieldOfView:{upDegrees:i,downDegrees:i,leftDegrees:r,rightDegrees:r},offset:new Float32Array([0,0,0]),renderWidth:t.width,renderHeight:t.height}}}function mixinMonoscopicEyeParameters(e){Object.defineProperty(e,"DEFAULT_FOV",{get:getDefaultFieldOfView,set:setDefaultFieldOfView}),e.prototype.getEyeParameters=getMonoscopicEyeParameters}function defaultPose(){return{position:[0,0,0],orientation:[0,0,0,1],linearVelocity:null,linearAcceleration:null,angularVelocity:null,angularAcceleration:null}}function makeHidingContainer(e,t){var i=cascadeElement(e,"div",window.HTMLDivElement);return i.style.position="absolute",i.style.left=0,i.style.top=0,i.style.width=0,i.style.height=0,i.style.overflow="hidden",i.appendChild(t),i}function initState(){this.inputState={buttons:[],axes:[],ctrl:!1,alt:!1,shift:!1,meta:!1},this.lastInputState={buttons:[],axes:[],ctrl:!1,alt:!1,shift:!1,meta:!1}}function filterMetaKey(e){for(var t=0;t<Keys.MODIFIER_KEYS.length;++t){var i=Keys.MODIFIER_KEYS[t];if(Math.abs(e)===Keys[i.toLocaleUpperCase()])return Math.sign(e)*(t+1)}}function filterValue(e){var t="undefined"==typeof e?"undefined":_typeof(e),i=0,r=!1,n=1;if("number"===t)i=Math.abs(e)-1,r=e<0,n=e<0?-1:1;else{if("string"!==t)throw new Error("Cannot clone command spec. Element was type: "+t,e);"-"===e[0]&&(n=-1,e=e.substring(1)),i=this.axisNames.indexOf(e)}return{index:i,toggle:r,sign:n}}function swap(e,t){for(var i=0;i<this.inputState.buttons.length;++i)this[e].buttons[i]=this[t].buttons[i];for(var r=0;r<this.inputState.axes.length;++r)this[e].axes[r]=this[t].axes[r];for(var n=0;n<Keys.MODIFIER_KEYS.length;++n){var o=Keys.MODIFIER_KEYS[n];this[e][o]=this[t][o]}}function resetInputState(){swap.call(this,"inputState","lastInputState")}function recordLastState(){swap.call(this,"lastInputState","inputState")}function playPattern(e,t,i){if(t.length>0){var r=t.shift();if(!i)for(var n=0;n<e.length;++n)e[0].vibrate(1,r);setTimeout(playPattern,r,e,t,!i)}}function del(e,t,i){return XHR("DELETE",e,t,i)}function delObject(e,t){return del("json",e,t)}function getObject(e,t){return get$1("json",e,t)}function getText(e,t){return get$1("text",e,t)}function post(e,t,i){return XHR("POST",e,t,i)}function postObject(e,t){return post("json",e,t)}function upgrade1_0_to_1_1(){"VRDisplay"in window&&!("VRFrameData"in window)&&(window.VRFrameData=VRFrameData,"depthNear"in window.VRDisplay.prototype||(window.VRDisplay.prototype.depthNear=.01),"depthFar"in window.VRDisplay.prototype||(window.VRDisplay.prototype.depthFar=1e4),window.VRDisplay.prototype.getFrameData=function(e){return frameDataFromPose(e,this.getPose(),this)})}function getPolyfillDisplays(e){return polyFillDevicesPopulated||((isCardboardCompatible||e.forceStereo)&&(FullScreen.addChangeListener(fireVRDisplayPresentChange),allDisplays.push(new CardboardVRDisplay(e))),polyFillDevicesPopulated=!0),new Promise(function(e,t){try{e(allDisplays)}catch(e){t(e)}})}function fireVRDisplayPresentChange(){var e=new CustomEvent("vrdisplaypresentchange",{detail:{vrdisplay:this}});window.dispatchEvent(e)}function installPolyfill(e){var t=null;t=hasNativeWebVR?navigator.getVRDisplays:function(){return Promise.resolve([])},navigator.getVRDisplays=function(){return t.call(navigator).then(function(t){return 0===t.length||"Mozilla/5.0 (Linux; Android 6.0.1; SM-G930V Build/MMB29M) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2664.0 Mobile Safari/537.36"===navigator.userAgent?(e.overrideOrientation=t[0],getPolyfillDisplays(e)):t})},window.VRDisplay=window.VRDisplay||VRDisplay,Object.defineProperty(navigator,"vrEnabled",{get:function(){return isCardboardCompatible&&(FullScreen.available||isiOS)}})}function installStandardMonitor(e){if(!standardMonitorPopulated&&!isGearVR){var t=navigator.getVRDisplays;navigator.getVRDisplays=function(){return t.call(navigator).then(function(t){for(var i=!1,r=0;r<t.length&&!i;++r){var n=t[r];i=n instanceof StandardMonitorVRDisplay}return i||(e&&e.defaultFOV&&(StandardMonitorVRDisplay.DEFAULT_FOV=e.defaultFOV),t.unshift(new StandardMonitorVRDisplay(t[0]))),t})},standardMonitorPopulated=!0}}function installMockDisplay(e){var t=e&&e.replayData;if(t){var i=navigator.getVRDisplays;navigator.getVRDisplays=function(){return i.call(navigator).then(function(e){var i=e.map(function(e){return e instanceof MockVRDisplay}).reduce(function(e,t){return e||t},!1);if(i)return e;return"object"===("undefined"==typeof t?"undefined":_typeof(t))?Promise.resolve(t):/\.json$/.test(t)?getObject(t):Promise.resolve(JSON.parse(t))})}}}function install(e){e=Object.assign({FORCE_ENABLE_VR:!1},e),installPolyfill(e),installStandardMonitor(e),installMockDisplay(e),upgrade1_0_to_1_1()}function number(e,t,i){i=i||1,void 0===t&&(t=e,e=0);var r=t-e,n=Math.pow(Math.random(),i);return e+n*r}function int(e,t,i){return Math.floor(number(e,t,i))}function color(){var e=int(0,256),t=int(0,256),i=int(0,256);return e<<16|t<<8|i}function findEverything(e,t){e=e||document,t=t||{};for(var i=e.querySelectorAll("*"),r=0;r<i.length;++r){var n=i[r];n.id&&n.id.length>0&&(t[n.id]=n,n.parentElement&&(n.parentElement[n.id]=n))}return t}function extractSdp$1(e,t){var i=e.match(t);return i&&2==i.length?i[1]:null}function preferOpus(e){if(ENABLE_OPUS_HACK&&e){for(var t=e.sdp,i=t.split("\r\n"),r=null,n=0;n<i.length;n++)if(i[n].search("m=audio")!==-1){r=n;break}if(null===r)return t;for(var o=0;o<i.length;o++)if(i[o].search("opus/48000")!==-1){var a=extractSdp(i[o],/:(\d+) opus\/48000/i);a&&(i[r]=setDefaultCodec(i[r],a));break}i=removeCN(i,r),e.sdp=i.join("\r\n")}return e}function extractSdp(e,t){var i=e.match(t);return i&&2==i.length?i[1]:null}function setDefaultCodec(e,t){for(var i=e.split(" "),r=[],n=0,o=0;o<i.length;o++)3===n&&(r[n++]=t),i[o]!==t&&(r[n++]=i[o]);return r.join(" ")}function removeCN(e,t){for(var i=e[t].split(" "),r=e.length-1;r>=0;r--){var n=extractSdp(e[r],/a=rtpmap:(\d+) CN\/\d+/i);if(n){var o=i.indexOf(n);o!==-1&&i.splice(o,1),e.splice(r,1)}}return e[t]=i.join(" "),e}function flipCoin(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return number(1)<e}function ID(){return(Math.random()*Math.log(Number.MAX_VALUE)).toString(36).replace(".","")}function item(e){return e[int(e.length)]}function steps(e,t,i){return e+int(0,(1+t-e)/i)*i}function vector(e,t){return(new Vector3).set(number(e,t),number(e,t),number(e,t))}console.info("[Primrose]:> primrose v0.32.0. see https://www.primrosevr.com for more information."),!function(e){"use strict";function t(e,t,i,n){var o=t&&t.prototype instanceof r?t:r,a=Object.create(o.prototype),s=new d(n||[]);return a._invoke=l(e,i,s),a}function i(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}function r(){}function n(){}function o(){}function a(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function s(t){function r(e,n,o,a){var s=i(t[e],t,n);if("throw"!==s.type){var l=s.arg,c=l.value;return c&&"object"==typeof c&&g.call(c,"__await")?Promise.resolve(c.__await).then(function(e){r("next",e,o,a)},function(e){r("throw",e,o,a)}):Promise.resolve(c).then(function(e){l.value=e,o(l)},a)}a(s.arg)}function n(e,t){function i(){return new Promise(function(i,n){r(e,t,i,n)})}return o=o?o.then(i,i):i()}"object"==typeof e.process&&e.process.domain&&(r=e.process.domain.bind(r));var o;this._invoke=n}function l(e,t,r){var n=E;return function(o,a){if(n===T)throw new Error("Generator is already running");if(n===C){if("throw"===o)throw a;return f()}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var l=c(s,r);if(l){if(l===A)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===E)throw n=C,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=T;var h=i(e,t,r);if("normal"===h.type){if(n=r.done?C:S,h.arg===A)continue;return{value:h.arg,done:r.done}}"throw"===h.type&&(n=C,r.method="throw",r.arg=h.arg)}}}function c(e,t){var r=e.iterator[t.method];if(r===m){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=m,c(e,t),"throw"===t.method))return A;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var n=i(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,A;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=m),t.delegate=null,A):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,A)}function h(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function u(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function d(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(h,this),this.reset(!0)}function p(e){if(e){var t=e[x];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,r=function t(){for(;++i<e.length;)if(g.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=m,t.done=!0,t};return r.next=r}}return{next:f}}function f(){return{value:m,done:!0}}var m,v=Object.prototype,g=v.hasOwnProperty,y="function"==typeof Symbol?Symbol:{},x=y.iterator||"@@iterator",b=y.asyncIterator||"@@asyncIterator",_=y.toStringTag||"@@toStringTag",w="object"==typeof module,M=e.regeneratorRuntime;if(M)return void(w&&(module.exports=M));M=e.regeneratorRuntime=w?module.exports:{},M.wrap=t;var E="suspendedStart",S="suspendedYield",T="executing",C="completed",A={},P={};P[x]=function(){return this};var R=Object.getPrototypeOf,L=R&&R(R(p([])));L&&L!==v&&g.call(L,x)&&(P=L);var B=o.prototype=r.prototype=Object.create(P);n.prototype=B.constructor=o,o.constructor=n,o[_]=n.displayName="GeneratorFunction",M.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===n||"GeneratorFunction"===(t.displayName||t.name))},M.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,o):(e.__proto__=o,_ in e||(e[_]="GeneratorFunction")),e.prototype=Object.create(B),e},M.awrap=function(e){return{__await:e}},a(s.prototype),s.prototype[b]=function(){return this},M.AsyncIterator=s,M.async=function(e,i,r,n){var o=new s(t(e,i,r,n));return M.isGeneratorFunction(i)?o:o.next().then(function(e){return e.done?e.value:o.next()})},a(B),B[_]="Generator",B[x]=function(){return this},B.toString=function(){return"[object Generator]"},M.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},M.values=p,d.prototype={constructor:d,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=m,this.done=!1,this.delegate=null,this.method="next",this.arg=m,this.tryEntries.forEach(u),!e)for(var t in this)"t"===t.charAt(0)&&g.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=m)},stop:function(){this.done=!0;var e=this.tryEntries[0],t=e.completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){function t(t,r){return o.type="throw",o.arg=e,i.next=t,r&&(i.method="next",i.arg=m),!!r}if(this.done)throw e;for(var i=this,r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r],o=n.completion;if("root"===n.tryLoc)return t("end");if(n.tryLoc<=this.prev){var a=g.call(n,"catchLoc"),s=g.call(n,"finallyLoc");if(a&&s){if(this.prev<n.catchLoc)return t(n.catchLoc,!0);if(this.prev<n.finallyLoc)return t(n.finallyLoc)}else if(a){if(this.prev<n.catchLoc)return t(n.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return t(n.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var r=this.tryEntries[i];if(r.tryLoc<=this.prev&&g.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var n=r;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var o=n?n.completion:{};return o.type=e,o.arg=t,n?(this.method="next",this.next=n.finallyLoc,A):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),A},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),u(i),A}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;u(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:p(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=m),A}}}("object"==typeof global?global:"object"==typeof window?window:"object"==typeof self?self:this);var isMobile=testUserAgent(navigator.userAgent||navigator.vendor||window.opera),isGearVR=navigator.userAgent.indexOf("Mobile VR")>-1,isCardboard=isMobile&&!isGearVR,isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isChrome=!!window.chrome&&!isOpera,isFirefox="undefined"!=typeof window.InstallTrigger,isIE=!!document.documentMode,isInIFrame=window.self!==window.top,isiOS=/iP(hone|od|ad)/.test(navigator.userAgent||""),isMacOS=/Macintosh/.test(navigator.userAgent||""),isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isWebKit=isOpera||isChrome||isSafari,isWindows=/Windows/.test(navigator.userAgent||""),index$1={isCardboard:isCardboard,isChrome:isChrome,isFirefox:isFirefox,isGearVR:isGearVR,isIE:isIE,isInIFrame:isInIFrame,isiOS:isiOS,isLandscape:isLandscape,isMacOS:isMacOS,isMobile:isMobile,isOpera:isOpera,isSafari:isSafari,isWebKit:isWebKit,isWindows:isWindows},flags=Object.freeze({isCardboard:isCardboard,isChrome:isChrome,isFirefox:isFirefox,isGearVR:isGearVR,isIE:isIE,isInIFrame:isInIFrame,isiOS:isiOS,isLandscape:isLandscape,isMacOS:isMacOS,isMobile:isMobile,isOpera:isOpera,isSafari:isSafari,isWebKit:isWebKit,isWindows:isWindows,default:index$1});void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&!function(){Object.assign=function(e){"use strict";if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),i=1;i<arguments.length;i++){var r=arguments[i];if(void 0!==r&&null!==r)for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}}(),Object.assign(EventDispatcher.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[e]&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&i[e].indexOf(t)!==-1},removeEventListener:function(e,t){if(void 0!==this._listeners){var i=this._listeners,r=i[e];if(void 0!==r){var n=r.indexOf(t);n!==-1&&r.splice(n,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners,i=t[e.type];if(void 0!==i){e.target=this;var r=[],n=0,o=i.length;for(n=0;n<o;n++)r[n]=i[n];for(n=0;n<o;n++)r[n].call(this,e)}}}});var REVISION="85",CullFaceNone=0,CullFaceBack=1,CullFaceFront=2,FrontFaceDirectionCW=0,PCFShadowMap=1,PCFSoftShadowMap=2,FrontSide=0,BackSide=1,DoubleSide=2,FlatShading=1,SmoothShading=2,NoColors=0,FaceColors=1,VertexColors=2,NoBlending=0,NormalBlending=1,AdditiveBlending=2,SubtractiveBlending=3,MultiplyBlending=4,CustomBlending=5,AddEquation=100,SubtractEquation=101,ReverseSubtractEquation=102,MinEquation=103,MaxEquation=104,ZeroFactor=200,OneFactor=201,SrcColorFactor=202,OneMinusSrcColorFactor=203,SrcAlphaFactor=204,OneMinusSrcAlphaFactor=205,DstAlphaFactor=206,OneMinusDstAlphaFactor=207,DstColorFactor=208,OneMinusDstColorFactor=209,SrcAlphaSaturateFactor=210,NeverDepth=0,AlwaysDepth=1,LessDepth=2,LessEqualDepth=3,EqualDepth=4,GreaterEqualDepth=5,GreaterDepth=6,NotEqualDepth=7,MultiplyOperation=0,MixOperation=1,AddOperation=2,NoToneMapping=0,LinearToneMapping=1,ReinhardToneMapping=2,Uncharted2ToneMapping=3,CineonToneMapping=4,UVMapping=300,CubeReflectionMapping=301,CubeRefractionMapping=302,EquirectangularReflectionMapping=303,EquirectangularRefractionMapping=304,SphericalReflectionMapping=305,CubeUVReflectionMapping=306,CubeUVRefractionMapping=307,RepeatWrapping=1e3,ClampToEdgeWrapping=1001,MirroredRepeatWrapping=1002,NearestFilter=1003,NearestMipMapNearestFilter=1004,NearestMipMapLinearFilter=1005,LinearFilter=1006,LinearMipMapNearestFilter=1007,LinearMipMapLinearFilter=1008,UnsignedByteType=1009,ByteType=1010,ShortType=1011,UnsignedShortType=1012,IntType=1013,UnsignedIntType=1014,FloatType=1015,HalfFloatType=1016,UnsignedShort4444Type=1017,UnsignedShort5551Type=1018,UnsignedShort565Type=1019,UnsignedInt248Type=1020,AlphaFormat=1021,RGBFormat=1022,RGBAFormat=1023,LuminanceFormat=1024,LuminanceAlphaFormat=1025,DepthFormat=1026,DepthStencilFormat=1027,RGB_S3TC_DXT1_Format=2001,RGBA_S3TC_DXT1_Format=2002,RGBA_S3TC_DXT3_Format=2003,RGBA_S3TC_DXT5_Format=2004,RGB_PVRTC_4BPPV1_Format=2100,RGB_PVRTC_2BPPV1_Format=2101,RGBA_PVRTC_4BPPV1_Format=2102,RGBA_PVRTC_2BPPV1_Format=2103,RGB_ETC1_Format=2151,LoopOnce=2200,LoopRepeat=2201,LoopPingPong=2202,InterpolateDiscrete=2300,InterpolateLinear=2301,InterpolateSmooth=2302,ZeroCurvatureEnding=2400,ZeroSlopeEnding=2401,WrapAroundEnding=2402,TrianglesDrawMode=0,TriangleStripDrawMode=1,TriangleFanDrawMode=2,LinearEncoding=3e3,sRGBEncoding=3001,GammaEncoding=3007,RGBEEncoding=3002,RGBM7Encoding=3004,RGBM16Encoding=3005,RGBDEncoding=3006,BasicDepthPacking=3200,RGBADepthPacking=3201,_Math={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=new Array(36),r=0;return function(){for(var n=0;n<36;n++)8===n||13===n||18===n||23===n?i[n]="-":14===n?i[n]="4":(r<=2&&(r=33554432+16777216*Math.random()|0),e=15&r,r>>=4,i[n]=t[19===n?3&e|8:e]);return i.join("")}}(),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,i,r,n){return r+(e-t)*(n-r)/(i-t)},lerp:function(e,t,i){return(1-i)*e+i*t},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t),e*e*(3-2*e))},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t),e*e*e*(e*(6*e-15)+10))},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*_Math.DEG2RAD},radToDeg:function(e){return e*_Math.RAD2DEG},isPowerOfTwo:function(e){return 0===(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}};Object.defineProperties(Vector2.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(Vector2.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,
this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e=new Vector2,t=new Vector2;return function(i,r){return e.set(i,i),t.set(r,r),this.clamp(e,t)}}(),clampLength:function(e,t){var i=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,i))/i)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length())},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y;return t*t+i*i},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var i=Math.cos(t),r=Math.sin(t),n=this.x-e.x,o=this.y-e.y;return this.x=n*i-o*r+e.x,this.y=n*r+o*i+e.y,this}});var textureId=0;Texture.DEFAULT_IMAGE=void 0,Texture.DEFAULT_MAPPING=UVMapping,Object.defineProperty(Texture.prototype,"needsUpdate",{set:function(e){e===!0&&this.version++}}),Object.assign(Texture.prototype,EventDispatcher.prototype,{constructor:Texture,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){function t(e){var t;return void 0!==e.toDataURL?t=e:(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)),t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}if(void 0!==e.textures[this.uuid])return e.textures[this.uuid];var i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var r=this.image;void 0===r.uuid&&(r.uuid=_Math.generateUUID()),void 0===e.images[r.uuid]&&(e.images[r.uuid]={uuid:r.uuid,url:t(r)}),i.image=r.uuid}return e.textures[this.uuid]=i,i},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(this.mapping===UVMapping){if(e.multiply(this.repeat),e.add(this.offset),e.x<0||e.x>1)switch(this.wrapS){case RepeatWrapping:e.x=e.x-Math.floor(e.x);break;case ClampToEdgeWrapping:e.x=e.x<0?0:1;break;case MirroredRepeatWrapping:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case RepeatWrapping:e.y=e.y-Math.floor(e.y);break;case ClampToEdgeWrapping:e.y=e.y<0?0:1;break;case MirroredRepeatWrapping:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}}}),Object.assign(Vector4.prototype,{isVector4:!0,set:function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,i=this.y,r=this.z,n=this.w,o=e.elements;return this.x=o[0]*t+o[4]*i+o[8]*r+o[12]*n,this.y=o[1]*t+o[5]*i+o[9]*r+o[13]*n,this.z=o[2]*t+o[6]*i+o[10]*r+o[14]*n,this.w=o[3]*t+o[7]*i+o[11]*r+o[15]*n,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,i,r,n,o=.01,a=.1,s=e.elements,l=s[0],c=s[4],h=s[8],u=s[1],d=s[5],p=s[9],f=s[2],m=s[6],v=s[10];if(Math.abs(c-u)<o&&Math.abs(h-f)<o&&Math.abs(p-m)<o){if(Math.abs(c+u)<a&&Math.abs(h+f)<a&&Math.abs(p+m)<a&&Math.abs(l+d+v-3)<a)return this.set(1,0,0,0),this;t=Math.PI;var g=(l+1)/2,y=(d+1)/2,x=(v+1)/2,b=(c+u)/4,_=(h+f)/4,w=(p+m)/4;return g>y&&g>x?g<o?(i=0,r=.707106781,n=.707106781):(i=Math.sqrt(g),r=b/i,n=_/i):y>x?y<o?(i=.707106781,r=0,n=.707106781):(r=Math.sqrt(y),i=b/r,n=w/r):x<o?(i=.707106781,r=.707106781,n=0):(n=Math.sqrt(x),i=_/n,r=w/n),this.set(i,r,n,t),this}var M=Math.sqrt((m-p)*(m-p)+(h-f)*(h-f)+(u-c)*(u-c));return Math.abs(M)<.001&&(M=1),this.x=(m-p)/M,this.y=(h-f)/M,this.z=(u-c)/M,this.w=Math.acos((l+d+v-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e=new Vector4,t=new Vector4;return function(i,r){return e.set(i,i,i,i),t.set(r,r,r,r),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.assign(WebGLRenderTarget.prototype,EventDispatcher.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.assign(Quaternion,{slerp:function(e,t,i,r){return i.copy(e).slerp(t,r)},slerpFlat:function(e,t,i,r,n,o,a){var s=i[r+0],l=i[r+1],c=i[r+2],h=i[r+3],u=n[o+0],d=n[o+1],p=n[o+2],f=n[o+3];if(h!==f||s!==u||l!==d||c!==p){var m=1-a,v=s*u+l*d+c*p+h*f,g=v>=0?1:-1,y=1-v*v;if(y>Number.EPSILON){var x=Math.sqrt(y),b=Math.atan2(x,v*g);m=Math.sin(m*b)/x,a=Math.sin(a*b)/x}var _=a*g;if(s=s*m+u*_,l=l*m+d*_,c=c*m+p*_,h=h*m+f*_,m===1-a){var w=1/Math.sqrt(s*s+l*l+c*c+h*h);s*=w,l*=w,c*=w,h*=w}}e[t]=s,e[t+1]=l,e[t+2]=c,e[t+3]=h}}),Object.defineProperties(Quaternion.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(Quaternion.prototype,{set:function(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if((e&&e.isEuler)===!1)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var i=e._x,r=e._y,n=e._z,o=e.order,a=Math.cos,s=Math.sin,l=a(i/2),c=a(r/2),h=a(n/2),u=s(i/2),d=s(r/2),p=s(n/2);return"XYZ"===o?(this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p):"YXZ"===o?(this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p):"ZXY"===o?(this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p):"ZYX"===o?(this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p):"YZX"===o?(this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p):"XZY"===o&&(this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p),t!==!1&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var i=t/2,r=Math.sin(i);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(i),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,i=e.elements,r=i[0],n=i[4],o=i[8],a=i[1],s=i[5],l=i[9],c=i[2],h=i[6],u=i[10],d=r+s+u;return d>0?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(h-l)*t,this._y=(o-c)*t,this._z=(a-n)*t):r>s&&r>u?(t=2*Math.sqrt(1+r-s-u),this._w=(h-l)/t,this._x=.25*t,this._y=(n+a)/t,this._z=(o+c)/t):s>u?(t=2*Math.sqrt(1+s-r-u),this._w=(o-c)/t,this._x=(n+a)/t,this._y=.25*t,this._z=(l+h)/t):(t=2*Math.sqrt(1+u-r-s),this._w=(a-n)/t,this._x=(o+c)/t,this._y=(l+h)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t=new Vector3,i=1e-6;return function(r,n){return void 0===t&&(t=new Vector3),e=r.dot(n)+1,e<i?(e=0,Math.abs(r.x)>Math.abs(r.z)?t.set(-r.y,r.x,0):t.set(0,-r.z,r.y)):t.crossVectors(r,n),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize()}}(),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var i=e._x,r=e._y,n=e._z,o=e._w,a=t._x,s=t._y,l=t._z,c=t._w;return this._x=i*c+o*a+r*l-n*s,this._y=r*c+o*s+n*a-i*l,this._z=n*c+o*l+i*s-r*a,this._w=o*c-i*a-r*s-n*l,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var i=this._x,r=this._y,n=this._z,o=this._w,a=o*e._w+i*e._x+r*e._y+n*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=o,this._x=i,this._y=r,this._z=n,this;var s=Math.sqrt(1-a*a);if(Math.abs(s)<.001)return this._w=.5*(o+this._w),this._x=.5*(i+this._x),this._y=.5*(r+this._y),this._z=.5*(n+this._z),this;var l=Math.atan2(s,a),c=Math.sin((1-t)*l)/s,h=Math.sin(t*l)/s;return this._w=o*c+this._w*h,this._x=i*c+this._x*h,this._y=r*c+this._y*h,this._z=n*c+this._z*h,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Vector3.prototype,{isVector3:!0,set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e=new Quaternion;return function(t){return(t&&t.isEuler)===!1&&console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(e.setFromEuler(t))}}(),applyAxisAngle:function(){var e=new Quaternion;return function(t,i){return this.applyQuaternion(e.setFromAxisAngle(t,i))}}(),applyMatrix3:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*r,this.y=n[1]*t+n[4]*i+n[7]*r,this.z=n[2]*t+n[5]*i+n[8]*r,this},applyMatrix4:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;this.x=n[0]*t+n[4]*i+n[8]*r+n[12],this.y=n[1]*t+n[5]*i+n[9]*r+n[13],this.z=n[2]*t+n[6]*i+n[10]*r+n[14];var o=n[3]*t+n[7]*i+n[11]*r+n[15];return this.divideScalar(o)},applyQuaternion:function(e){var t=this.x,i=this.y,r=this.z,n=e.x,o=e.y,a=e.z,s=e.w,l=s*t+o*r-a*i,c=s*i+a*t-n*r,h=s*r+n*i-o*t,u=-n*t-o*i-a*r;return this.x=l*s+u*-n+c*-a-h*-o,this.y=c*s+u*-o+h*-n-l*-a,this.z=h*s+u*-a+l*-o-c*-n,this},project:function(){var e=new Matrix4;return function(t){return e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyMatrix4(e)}}(),unproject:function(){var e=new Matrix4;return function(t){return e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyMatrix4(e)}}(),transformDirection:function(e){var t=this.x,i=this.y,r=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*r,this.y=n[1]*t+n[5]*i+n[9]*r,this.z=n[2]*t+n[6]*i+n[10]*r,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e=new Vector3,t=new Vector3;return function(i,r){return e.set(i,i,i),t.set(r,r,r),this.clamp(e,t)}}(),clampLength:function(e,t){var i=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,i))/i)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var i=this.x,r=this.y,n=this.z;return this.x=r*e.z-n*e.y,this.y=n*e.x-i*e.z,this.z=i*e.y-r*e.x,this},crossVectors:function(e,t){var i=e.x,r=e.y,n=e.z,o=t.x,a=t.y,s=t.z;return this.x=r*s-n*a,this.y=n*o-i*s,this.z=i*a-r*o,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:function(){var e=new Vector3;return function(t){return e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e=new Vector3;return function(t){return this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(_Math.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y,r=this.z-e.z;return t*t+i*i+r*r},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromCylindrical:function(e){return this.x=e.radius*Math.sin(e.theta),this.y=e.y,this.z=e.radius*Math.cos(e.theta),this},setFromMatrixPosition:function(e){return this.setFromMatrixColumn(e,3)},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=r,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(Matrix4.prototype,{isMatrix4:!0,set:function(e,t,i,r,n,o,a,s,l,c,h,u,d,p,f,m){var v=this.elements;return v[0]=e,v[4]=t,v[8]=i,v[12]=r,v[1]=n,v[5]=o,v[9]=a,v[13]=s,v[2]=l,v[6]=c,v[10]=h,v[14]=u,v[3]=d,v[7]=p,v[11]=f,v[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new Matrix4).fromArray(this.elements)},copy:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this},copyPosition:function(e){var t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractBasis:function(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this},extractRotation:function(){var e=new Vector3;return function(t){var i=this.elements,r=t.elements,n=1/e.setFromMatrixColumn(t,0).length(),o=1/e.setFromMatrixColumn(t,1).length(),a=1/e.setFromMatrixColumn(t,2).length();return i[0]=r[0]*n,i[1]=r[1]*n,i[2]=r[2]*n,i[4]=r[4]*o,i[5]=r[5]*o,i[6]=r[6]*o,i[8]=r[8]*a,i[9]=r[9]*a,i[10]=r[10]*a,this}}(),makeRotationFromEuler:function(e){(e&&e.isEuler)===!1&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,i=e.x,r=e.y,n=e.z,o=Math.cos(i),a=Math.sin(i),s=Math.cos(r),l=Math.sin(r),c=Math.cos(n),h=Math.sin(n);if("XYZ"===e.order){var u=o*c,d=o*h,p=a*c,f=a*h;t[0]=s*c,t[4]=-s*h,t[8]=l,t[1]=d+p*l,t[5]=u-f*l,t[9]=-a*s,t[2]=f-u*l,t[6]=p+d*l,t[10]=o*s}else if("YXZ"===e.order){var m=s*c,v=s*h,g=l*c,y=l*h;t[0]=m+y*a,t[4]=g*a-v,t[8]=o*l,t[1]=o*h,t[5]=o*c,t[9]=-a,t[2]=v*a-g,t[6]=y+m*a,t[10]=o*s}else if("ZXY"===e.order){var m=s*c,v=s*h,g=l*c,y=l*h;t[0]=m-y*a,t[4]=-o*h,t[8]=g+v*a,t[1]=v+g*a,t[5]=o*c,t[9]=y-m*a,t[2]=-o*l,t[6]=a,t[10]=o*s}else if("ZYX"===e.order){var u=o*c,d=o*h,p=a*c,f=a*h;t[0]=s*c,t[4]=p*l-d,t[8]=u*l+f,t[1]=s*h,t[5]=f*l+u,t[9]=d*l-p,t[2]=-l,t[6]=a*s,t[10]=o*s}else if("YZX"===e.order){var x=o*s,b=o*l,_=a*s,w=a*l;t[0]=s*c,t[4]=w-x*h,t[8]=_*h+b,t[1]=h,t[5]=o*c,t[9]=-a*c,t[2]=-l*c,t[6]=b*h+_,t[10]=x-w*h}else if("XZY"===e.order){var x=o*s,b=o*l,_=a*s,w=a*l;t[0]=s*c,t[4]=-h,t[8]=l*c,t[1]=x*h+w,t[5]=o*c,t[9]=b*h-_,t[2]=_*h-b,t[6]=a*c,t[10]=w*h+x}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,i=e._x,r=e._y,n=e._z,o=e._w,a=i+i,s=r+r,l=n+n,c=i*a,h=i*s,u=i*l,d=r*s,p=r*l,f=n*l,m=o*a,v=o*s,g=o*l;return t[0]=1-(d+f),t[4]=h-g,t[8]=u+v,t[1]=h+g,t[5]=1-(c+f),t[9]=p-m,t[2]=u-v,t[6]=p+m,t[10]=1-(c+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e=new Vector3,t=new Vector3,i=new Vector3;return function(r,n,o){var a=this.elements;return i.subVectors(r,n),0===i.lengthSq()&&(i.z=1),i.normalize(),e.crossVectors(o,i),0===e.lengthSq()&&(i.z+=1e-4,e.crossVectors(o,i)),e.normalize(),t.crossVectors(i,e),a[0]=e.x,a[4]=t.x,a[8]=i.x,a[1]=e.y,a[5]=t.y,a[9]=i.y,a[2]=e.z,a[6]=t.z,a[10]=i.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var i=e.elements,r=t.elements,n=this.elements,o=i[0],a=i[4],s=i[8],l=i[12],c=i[1],h=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],v=i[14],g=i[3],y=i[7],x=i[11],b=i[15],_=r[0],w=r[4],M=r[8],E=r[12],S=r[1],T=r[5],C=r[9],A=r[13],P=r[2],R=r[6],L=r[10],B=r[14],O=r[3],I=r[7],D=r[11],k=r[15];return n[0]=o*_+a*S+s*P+l*O,n[4]=o*w+a*T+s*R+l*I,n[8]=o*M+a*C+s*L+l*D,n[12]=o*E+a*A+s*B+l*k,n[1]=c*_+h*S+u*P+d*O,n[5]=c*w+h*T+u*R+d*I,n[9]=c*M+h*C+u*L+d*D,n[13]=c*E+h*A+u*B+d*k,n[2]=p*_+f*S+m*P+v*O,n[6]=p*w+f*T+m*R+v*I,n[10]=p*M+f*C+m*L+v*D,n[14]=p*E+f*A+m*B+v*k,n[3]=g*_+y*S+x*P+b*O,n[7]=g*w+y*T+x*R+b*I,n[11]=g*M+y*C+x*L+b*D,n[15]=g*E+y*A+x*B+b*k,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToBufferAttribute:function(){var e=new Vector3;return function(t){for(var i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],i=e[4],r=e[8],n=e[12],o=e[1],a=e[5],s=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14],p=e[3],f=e[7],m=e[11],v=e[15];return p*(+n*s*h-r*l*h-n*a*u+i*l*u+r*a*d-i*s*d)+f*(+t*s*d-t*l*u+n*o*u-r*o*d+r*l*c-n*s*c)+m*(+t*l*h-t*a*d-n*o*h+i*o*d+n*a*c-i*l*c)+v*(-r*a*c-t*s*h+t*a*u+r*o*h-i*o*u+i*s*c)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var i=this.elements,r=e.elements,n=r[0],o=r[1],a=r[2],s=r[3],l=r[4],c=r[5],h=r[6],u=r[7],d=r[8],p=r[9],f=r[10],m=r[11],v=r[12],g=r[13],y=r[14],x=r[15],b=p*y*u-g*f*u+g*h*m-c*y*m-p*h*x+c*f*x,_=v*f*u-d*y*u-v*h*m+l*y*m+d*h*x-l*f*x,w=d*g*u-v*p*u+v*c*m-l*g*m-d*c*x+l*p*x,M=v*p*h-d*g*h-v*c*f+l*g*f+d*c*y-l*p*y,E=n*b+o*_+a*w+s*M;if(0===E){var S="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t===!0)throw new Error(S);return console.warn(S),this.identity()}var T=1/E;return i[0]=b*T,i[1]=(g*f*s-p*y*s-g*a*m+o*y*m+p*a*x-o*f*x)*T,i[2]=(c*y*s-g*h*s+g*a*u-o*y*u-c*a*x+o*h*x)*T,i[3]=(p*h*s-c*f*s-p*a*u+o*f*u+c*a*m-o*h*m)*T,i[4]=_*T,i[5]=(d*y*s-v*f*s+v*a*m-n*y*m-d*a*x+n*f*x)*T,i[6]=(v*h*s-l*y*s-v*a*u+n*y*u+l*a*x-n*h*x)*T,i[7]=(l*f*s-d*h*s+d*a*u-n*f*u-l*a*m+n*h*m)*T,i[8]=w*T,i[9]=(v*p*s-d*g*s-v*o*m+n*g*m+d*o*x-n*p*x)*T,i[10]=(l*g*s-v*c*s+v*o*u-n*g*u-l*o*x+n*c*x)*T,i[11]=(d*c*s-l*p*s-d*o*u+n*p*u+l*o*m-n*c*m)*T,i[12]=M*T,i[13]=(d*g*a-v*p*a+v*o*f-n*g*f-d*o*y+n*p*y)*T,i[14]=(v*c*a-l*g*a-v*o*h+n*g*h+l*o*y-n*c*y)*T,i[15]=(l*p*a-d*c*a+d*o*h-n*p*h-l*o*f+n*c*f)*T,this},scale:function(e){var t=this.elements,i=e.x,r=e.y,n=e.z;return t[0]*=i,t[4]*=r,t[8]*=n,t[1]*=i,t[5]*=r,t[9]*=n,t[2]*=i,t[6]*=r,t[10]*=n,t[3]*=i,t[7]*=r,t[11]*=n,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var i=Math.cos(t),r=Math.sin(t),n=1-i,o=e.x,a=e.y,s=e.z,l=n*o,c=n*a;return this.set(l*o+i,l*a-r*s,l*s+r*a,0,l*a+r*s,c*a+i,c*s-r*o,0,l*s-r*a,c*s+r*o,n*s*s+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeShear:function(e,t,i){return this.set(1,t,i,0,e,1,i,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,i){return this.makeRotationFromQuaternion(t),
this.scale(i),this.setPosition(e),this},decompose:function(){var e=new Vector3,t=new Matrix4;return function(i,r,n){var o=this.elements,a=e.set(o[0],o[1],o[2]).length(),s=e.set(o[4],o[5],o[6]).length(),l=e.set(o[8],o[9],o[10]).length(),c=this.determinant();c<0&&(a=-a),i.x=o[12],i.y=o[13],i.z=o[14],t.copy(this);var h=1/a,u=1/s,d=1/l;return t.elements[0]*=h,t.elements[1]*=h,t.elements[2]*=h,t.elements[4]*=u,t.elements[5]*=u,t.elements[6]*=u,t.elements[8]*=d,t.elements[9]*=d,t.elements[10]*=d,r.setFromRotationMatrix(t),n.x=a,n.y=s,n.z=l,this}}(),makePerspective:function(e,t,i,r,n,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var a=this.elements,s=2*n/(t-e),l=2*n/(i-r),c=(t+e)/(t-e),h=(i+r)/(i-r),u=-(o+n)/(o-n),d=-2*o*n/(o-n);return a[0]=s,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=l,a[9]=h,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makeOrthographic:function(e,t,i,r,n,o){var a=this.elements,s=1/(t-e),l=1/(i-r),c=1/(o-n),h=(t+e)*s,u=(i+r)*l,d=(o+n)*c;return a[0]=2*s,a[4]=0,a[8]=0,a[12]=-h,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*c,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(e){for(var t=this.elements,i=e.elements,r=0;r<16;r++)if(t[r]!==i[r])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<16;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}),DataTexture.prototype=Object.create(Texture.prototype),DataTexture.prototype.constructor=DataTexture,DataTexture.prototype.isDataTexture=!0,CubeTexture.prototype=Object.create(Texture.prototype),CubeTexture.prototype.constructor=CubeTexture,CubeTexture.prototype.isCubeTexture=!0,Object.defineProperty(CubeTexture.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var emptyTexture=new Texture,emptyCubeTexture=new CubeTexture,arrayCacheF32=[],arrayCacheI32=[],mat4array=new Float32Array(16),mat3array=new Float32Array(9);StructuredUniform.prototype.setValue=function(e,t){for(var i=this.seq,r=0,n=i.length;r!==n;++r){var o=i[r];o.setValue(e,t[o.id])}};var RePathPart=/([\w\d_]+)(\])?(\[|\.)?/g;WebGLUniforms.prototype.setValue=function(e,t,i){var r=this.map[t];void 0!==r&&r.setValue(e,i,this.renderer)},WebGLUniforms.prototype.setOptional=function(e,t,i){var r=t[i];void 0!==r&&this.setValue(e,i,r)},WebGLUniforms.upload=function(e,t,i,r){for(var n=0,o=t.length;n!==o;++n){var a=t[n],s=i[a.id];s.needsUpdate!==!1&&a.setValue(e,s.value,r)}},WebGLUniforms.seqWithValue=function(e,t){for(var i=[],r=0,n=e.length;r!==n;++r){var o=e[r];o.id in t&&i.push(o)}return i};var ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Object.assign(Color.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,i){return this.r=e,this.g=t,this.b=i,this},setHSL:function(){function e(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}return function(t,i,r){if(t=_Math.euclideanModulo(t,1),i=_Math.clamp(i,0,1),r=_Math.clamp(r,0,1),0===i)this.r=this.g=this.b=r;else{var n=r<=.5?r*(1+i):r+i-r*i,o=2*r-n;this.r=e(o,n,t+1/3),this.g=e(o,n,t),this.b=e(o,n,t-1/3)}return this}}(),setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var r,n=i[1],o=i[2];switch(n){case"rgb":case"rgba":if(r=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,t(r[5]),this;if(r=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,t(r[5]),this;break;case"hsl":case"hsla":if(r=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o)){var a=parseFloat(r[1])/360,s=parseInt(r[2],10)/100,l=parseInt(r[3],10)/100;return t(r[5]),this.setHSL(a,s,l)}}}else if(i=/^\#([A-Fa-f0-9]+)$/.exec(e)){var c=i[1],h=c.length;if(3===h)return this.r=parseInt(c.charAt(0)+c.charAt(0),16)/255,this.g=parseInt(c.charAt(1)+c.charAt(1),16)/255,this.b=parseInt(c.charAt(2)+c.charAt(2),16)/255,this;if(6===h)return this.r=parseInt(c.charAt(0)+c.charAt(1),16)/255,this.g=parseInt(c.charAt(2)+c.charAt(3),16)/255,this.b=parseInt(c.charAt(4)+c.charAt(5),16)/255,this}if(e&&e.length>0){var c=ColorKeywords[e];void 0!==c?this.setHex(c):console.warn("THREE.Color: Unknown color "+e)}return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this},convertGammaToLinear:function(){var e=this.r,t=this.g,i=this.b;return this.r=e*e,this.g=t*t,this.b=i*i,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,i,r=e||{h:0,s:0,l:0},n=this.r,o=this.g,a=this.b,s=Math.max(n,o,a),l=Math.min(n,o,a),c=(l+s)/2;if(l===s)t=0,i=0;else{var h=s-l;switch(i=c<=.5?h/(s+l):h/(2-s-l),s){case n:t=(o-a)/h+(o<a?6:0);break;case o:t=(a-n)/h+2;break;case a:t=(n-o)/h+4}t/=6}return r.h=t,r.s=i,r.l=c,r},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,i){var r=this.getHSL();return r.h+=e,r.s+=t,r.l+=i,this.setHSL(r.h,r.s,r.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}});var UniformsLib={common:{diffuse:{value:new Color(15658734)},opacity:{value:1},map:{value:null},offsetRepeat:{value:new Vector4(0,0,1,1)},specularMap:{value:null},alphaMap:{value:null},envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new Color(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},offsetRepeat:{value:new Vector4(0,0,1,1)}}},UniformsUtils={merge:function(e){for(var t={},i=0;i<e.length;i++){var r=this.clone(e[i]);for(var n in r)t[n]=r[n]}return t},clone:function(e){var t={};for(var i in e){t[i]={};for(var r in e[i]){var n=e[i][r];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?t[i][r]=n.clone():Array.isArray(n)?t[i][r]=n.slice():t[i][r]=n}}return t}},alphamap_fragment="#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif\n",alphamap_pars_fragment="#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment="#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment="#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment="#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex="\nvec3 transformed = vec3( position );\n",beginnormal_vertex="\nvec3 objectNormal = vec3( normal );\n",bsdfs="float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat theta = acos( dot( N, V ) );\n\tvec2 uv = vec2(\n\t\tsqrt( saturate( roughness ) ),\n\t\tsaturate( theta / ( 0.5 * PI ) ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\n\tfloat b = 3.45068 + (4.18814 + y) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transpose( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\n\treturn result;\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment="#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = dFdx( surf_pos );\n\t\tvec3 vSigmaY = dFdy( surf_pos );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment="#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment="#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex="#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex="#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment="#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment="#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex="#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex="#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common="#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transpose( const in mat3 v ) {\n\tmat3 tmp;\n\ttmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n\ttmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n\ttmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n\treturn tmp;\n}\n",cube_uv_reflection_fragment="#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex="#ifdef FLIP_SIDED\n\tobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;\n",displacementmap_pars_vertex="#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex="#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normal * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment="#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment="#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment="  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment="\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment="#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\tsampleUV.y = saturate( flipNormal * reflectVec.y * 0.5 + 0.5 );\n\t\tsampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\tvec3 reflectView = flipNormal * normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment="#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex="#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex="#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex="\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex="#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment="#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment="#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment="#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment="#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment="#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex="vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",lights_pars="uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltcMat;\tuniform sampler2D ltcMag;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = saturate( reflectVec.y * 0.5 + 0.5 );\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment="BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment="varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_BlinnPhong( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = BlinnExponentToGGXRoughness( material.specularShininess );\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment="PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment="struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template="\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment="#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n\tgl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment="#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex="#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex="#ifdef USE_LOGDEPTHBUF\n\tgl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n\t#endif\n#endif\n",map_fragment="#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment="#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment="#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment="#ifdef USE_MAP\n\tuniform vec4 offsetRepeat;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment="float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment="#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex="#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex="#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex="#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_flip="#ifdef DOUBLE_SIDED\n\tfloat flipNormal = ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n#else\n\tfloat flipNormal = 1.0;\n#endif\n",normal_fragment="#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal ) * flipNormal;\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment="#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing="vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 1.0 - 2.0 * rgb.xyz;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment="#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex="#ifdef USE_SKINNING\n\tvec4 mvPosition = modelViewMatrix * skinned;\n#else\n\tvec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment="#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment="#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment="float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment="#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment="#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn 1.0;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\tfloat dp = ( length( lightToPosition ) - shadowBias ) / 1000.0;\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex="#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex="#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment="float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex="#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex="#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex="#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\tskinned  = bindMatrixInverse * skinned;\n#endif\n",skinnormal_vertex="#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment="float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment="#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment="#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment="#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment="#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex="#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform vec4 offsetRepeat;\n#endif\n",uv_vertex="#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",uv2_pars_fragment="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex="#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( PHYSICAL ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n\t#ifdef USE_SKINNING\n\t\tvec4 worldPosition = modelMatrix * skinned;\n\t#else\n\t\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n\t#endif\n#endif\n",cube_frag="uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert="varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",depth_frag="#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert="#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag="uniform vec3 lightPos;\nvarying vec4 vWorldPosition;\n#include <common>\n#include <packing>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tgl_FragColor = packDepthToRGBA( length( vWorldPosition.xyz - lightPos.xyz ) / 1000.0 );\n}\n",distanceRGBA_vert="varying vec4 vWorldPosition;\n#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition;\n}\n",equirect_frag="uniform sampler2D tEquirect;\nuniform float tFlip;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = saturate( tFlip * direction.y * -0.5 + 0.5 );\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert="varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag="uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert="uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag="uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert="#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag="uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert="#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag="#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert="#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag="#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert="#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag="#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",normal_vert="#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert="uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag="uniform float opacity;\n#include <common>\n#include <packing>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( 0.0, 0.0, 0.0, opacity * ( 1.0 - getShadowMask() ) );\n}\n",shadow_vert="#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n",ShaderChunk={
alphamap_fragment:alphamap_fragment,alphamap_pars_fragment:alphamap_pars_fragment,alphatest_fragment:alphatest_fragment,aomap_fragment:aomap_fragment,aomap_pars_fragment:aomap_pars_fragment,begin_vertex:begin_vertex,beginnormal_vertex:beginnormal_vertex,bsdfs:bsdfs,bumpmap_pars_fragment:bumpmap_pars_fragment,clipping_planes_fragment:clipping_planes_fragment,clipping_planes_pars_fragment:clipping_planes_pars_fragment,clipping_planes_pars_vertex:clipping_planes_pars_vertex,clipping_planes_vertex:clipping_planes_vertex,color_fragment:color_fragment,color_pars_fragment:color_pars_fragment,color_pars_vertex:color_pars_vertex,color_vertex:color_vertex,common:common,cube_uv_reflection_fragment:cube_uv_reflection_fragment,defaultnormal_vertex:defaultnormal_vertex,displacementmap_pars_vertex:displacementmap_pars_vertex,displacementmap_vertex:displacementmap_vertex,emissivemap_fragment:emissivemap_fragment,emissivemap_pars_fragment:emissivemap_pars_fragment,encodings_fragment:encodings_fragment,encodings_pars_fragment:encodings_pars_fragment,envmap_fragment:envmap_fragment,envmap_pars_fragment:envmap_pars_fragment,envmap_pars_vertex:envmap_pars_vertex,envmap_vertex:envmap_vertex,fog_vertex:fog_vertex,fog_pars_vertex:fog_pars_vertex,fog_fragment:fog_fragment,fog_pars_fragment:fog_pars_fragment,gradientmap_pars_fragment:gradientmap_pars_fragment,lightmap_fragment:lightmap_fragment,lightmap_pars_fragment:lightmap_pars_fragment,lights_lambert_vertex:lights_lambert_vertex,lights_pars:lights_pars,lights_phong_fragment:lights_phong_fragment,lights_phong_pars_fragment:lights_phong_pars_fragment,lights_physical_fragment:lights_physical_fragment,lights_physical_pars_fragment:lights_physical_pars_fragment,lights_template:lights_template,logdepthbuf_fragment:logdepthbuf_fragment,logdepthbuf_pars_fragment:logdepthbuf_pars_fragment,logdepthbuf_pars_vertex:logdepthbuf_pars_vertex,logdepthbuf_vertex:logdepthbuf_vertex,map_fragment:map_fragment,map_pars_fragment:map_pars_fragment,map_particle_fragment:map_particle_fragment,map_particle_pars_fragment:map_particle_pars_fragment,metalnessmap_fragment:metalnessmap_fragment,metalnessmap_pars_fragment:metalnessmap_pars_fragment,morphnormal_vertex:morphnormal_vertex,morphtarget_pars_vertex:morphtarget_pars_vertex,morphtarget_vertex:morphtarget_vertex,normal_flip:normal_flip,normal_fragment:normal_fragment,normalmap_pars_fragment:normalmap_pars_fragment,packing:packing,premultiplied_alpha_fragment:premultiplied_alpha_fragment,project_vertex:project_vertex,dithering_fragment:dithering_fragment,dithering_pars_fragment:dithering_pars_fragment,roughnessmap_fragment:roughnessmap_fragment,roughnessmap_pars_fragment:roughnessmap_pars_fragment,shadowmap_pars_fragment:shadowmap_pars_fragment,shadowmap_pars_vertex:shadowmap_pars_vertex,shadowmap_vertex:shadowmap_vertex,shadowmask_pars_fragment:shadowmask_pars_fragment,skinbase_vertex:skinbase_vertex,skinning_pars_vertex:skinning_pars_vertex,skinning_vertex:skinning_vertex,skinnormal_vertex:skinnormal_vertex,specularmap_fragment:specularmap_fragment,specularmap_pars_fragment:specularmap_pars_fragment,tonemapping_fragment:tonemapping_fragment,tonemapping_pars_fragment:tonemapping_pars_fragment,uv_pars_fragment:uv_pars_fragment,uv_pars_vertex:uv_pars_vertex,uv_vertex:uv_vertex,uv2_pars_fragment:uv2_pars_fragment,uv2_pars_vertex:uv2_pars_vertex,uv2_vertex:uv2_vertex,worldpos_vertex:worldpos_vertex,cube_frag:cube_frag,cube_vert:cube_vert,depth_frag:depth_frag,depth_vert:depth_vert,distanceRGBA_frag:distanceRGBA_frag,distanceRGBA_vert:distanceRGBA_vert,equirect_frag:equirect_frag,equirect_vert:equirect_vert,linedashed_frag:linedashed_frag,linedashed_vert:linedashed_vert,meshbasic_frag:meshbasic_frag,meshbasic_vert:meshbasic_vert,meshlambert_frag:meshlambert_frag,meshlambert_vert:meshlambert_vert,meshphong_frag:meshphong_frag,meshphong_vert:meshphong_vert,meshphysical_frag:meshphysical_frag,meshphysical_vert:meshphysical_vert,normal_frag:normal_frag,normal_vert:normal_vert,points_frag:points_frag,points_vert:points_vert,shadow_frag:shadow_frag,shadow_vert:shadow_vert},ShaderLib={basic:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.fog]),vertexShader:ShaderChunk.meshbasic_vert,fragmentShader:ShaderChunk.meshbasic_frag},lambert:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)}}]),vertexShader:ShaderChunk.meshlambert_vert,fragmentShader:ShaderChunk.meshlambert_frag},phong:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.gradientmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:ShaderChunk.meshphong_vert,fragmentShader:ShaderChunk.meshphong_frag},standard:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.roughnessmap,UniformsLib.metalnessmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag},points:{uniforms:UniformsUtils.merge([UniformsLib.points,UniformsLib.fog]),vertexShader:ShaderChunk.points_vert,fragmentShader:ShaderChunk.points_frag},dashed:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ShaderChunk.linedashed_vert,fragmentShader:ShaderChunk.linedashed_frag},depth:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.displacementmap]),vertexShader:ShaderChunk.depth_vert,fragmentShader:ShaderChunk.depth_frag},normal:{uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,{opacity:{value:1}}]),vertexShader:ShaderChunk.normal_vert,fragmentShader:ShaderChunk.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:ShaderChunk.cube_vert,fragmentShader:ShaderChunk.cube_frag},equirect:{uniforms:{tEquirect:{value:null},tFlip:{value:-1}},vertexShader:ShaderChunk.equirect_vert,fragmentShader:ShaderChunk.equirect_frag},distanceRGBA:{uniforms:{lightPos:{value:new Vector3}},vertexShader:ShaderChunk.distanceRGBA_vert,fragmentShader:ShaderChunk.distanceRGBA_frag}};ShaderLib.physical={uniforms:UniformsUtils.merge([ShaderLib.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag},Object.assign(Box2.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new Vector2;return function(t,i){var r=e.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=+(1/0),this.max.x=this.max.y=-(1/0),this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new Vector2;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Vector2;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){var i=t||new Vector2;return i.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){var i=t||new Vector2;return i.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Vector2;return function(t){var i=e.copy(t).clamp(this.min,this.max);return i.sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}});var materialId=0;Object.assign(Material.prototype,EventDispatcher.prototype,{isMaterial:!0,setValues:function(e){if(void 0!==e)for(var t in e){var i=e[t];if(void 0!==i){var r=this[t];void 0!==r?r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):"overdraw"===t?this[t]=Number(i):this[t]=i:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){function t(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}var i=void 0===e;i&&(e={textures:{},images:{}});var r={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearCoat&&(r.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(r.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,r.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(r.size=this.size),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==NormalBlending&&(r.blending=this.blending),this.shading!==SmoothShading&&(r.shading=this.shading),this.side!==FrontSide&&(r.side=this.side),this.vertexColors!==NoColors&&(r.vertexColors=this.vertexColors),this.opacity<1&&(r.opacity=this.opacity),this.transparent===!0&&(r.transparent=this.transparent),r.depthFunc=this.depthFunc,r.depthTest=this.depthTest,r.depthWrite=this.depthWrite,this.alphaTest>0&&(r.alphaTest=this.alphaTest),this.premultipliedAlpha===!0&&(r.premultipliedAlpha=this.premultipliedAlpha),this.wireframe===!0&&(r.wireframe=this.wireframe),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),r.skinning=this.skinning,r.morphTargets=this.morphTargets,r.dithering=this.dithering,i){var n=t(e.textures),o=t(e.images);n.length>0&&(r.textures=n),o.length>0&&(r.images=o)}return r},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.shading=e.shading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,i=null;if(null!==t){var r=t.length;i=new Array(r);for(var n=0;n!==r;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),ShaderMaterial.prototype=Object.create(Material.prototype),ShaderMaterial.prototype.constructor=ShaderMaterial,ShaderMaterial.prototype.isShaderMaterial=!0,ShaderMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=UniformsUtils.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},ShaderMaterial.prototype.toJSON=function(e){var t=Material.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},MeshDepthMaterial.prototype=Object.create(Material.prototype),MeshDepthMaterial.prototype.constructor=MeshDepthMaterial,MeshDepthMaterial.prototype.isMeshDepthMaterial=!0,MeshDepthMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},Object.assign(Box3.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=+(1/0),i=+(1/0),r=+(1/0),n=-(1/0),o=-(1/0),a=-(1/0),s=0,l=e.length;s<l;s+=3){var c=e[s],h=e[s+1],u=e[s+2];c<t&&(t=c),h<i&&(i=h),u<r&&(r=u),c>n&&(n=c),h>o&&(o=h),u>a&&(a=u)}return this.min.set(t,i,r),this.max.set(n,o,a),this},setFromBufferAttribute:function(e){for(var t=+(1/0),i=+(1/0),r=+(1/0),n=-(1/0),o=-(1/0),a=-(1/0),s=0,l=e.count;s<l;s++){var c=e.getX(s),h=e.getY(s),u=e.getZ(s);c<t&&(t=c),h<i&&(i=h),u<r&&(r=u),c>n&&(n=c),h>o&&(o=h),u>a&&(a=u)}return this.min.set(t,i,r),this.max.set(n,o,a),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new Vector3;return function(t,i){var r=e.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}}(),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=+(1/0),this.max.x=this.max.y=this.max.z=-(1/0),this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new Vector3;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Vector3;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var e=new Vector3;return function(t){var i=this;return t.updateMatrixWorld(!0),t.traverse(function(t){var r,n,o=t.geometry;if(void 0!==o)if(o.isGeometry){var a=o.vertices;for(r=0,n=a.length;r<n;r++)e.copy(a[r]),e.applyMatrix4(t.matrixWorld),i.expandByPoint(e)}else if(o.isBufferGeometry){var s=o.attributes.position;if(void 0!==s)for(r=0,n=s.count;r<n;r++)e.fromBufferAttribute(s,r).applyMatrix4(t.matrixWorld),i.expandByPoint(e)}}),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){var i=t||new Vector3;return i.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:function(){var e=new Vector3;return function(t){return this.clampPoint(t.center,e),e.distanceToSquared(t.center)<=t.radius*t.radius}}(),intersectsPlane:function(e){var t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=e.constant&&i>=e.constant},clampPoint:function(e,t){var i=t||new Vector3;return i.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Vector3;return function(t){var i=e.copy(t).clamp(this.min,this.max);return i.sub(t).length()}}(),getBoundingSphere:function(){var e=new Vector3;return function(t){var i=t||new Sphere;return this.getCenter(i.center),i.radius=.5*this.getSize(e).length(),i}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3];return function(t){return this.isEmpty()?this:(e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(e),this)}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(Sphere.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var e=new Box3;return function(t,i){var r=this.center;void 0!==i?r.copy(i):e.setFromPoints(t).getCenter(r);for(var n=0,o=0,a=t.length;o<a;o++)n=Math.max(n,r.distanceToSquared(t[o]));return this.radius=Math.sqrt(n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(this.center.dot(e.normal)-e.constant)<=this.radius},clampPoint:function(e,t){var i=this.center.distanceToSquared(e),r=t||new Vector3;return r.copy(e),i>this.radius*this.radius&&(r.sub(this.center).normalize(),r.multiplyScalar(this.radius).add(this.center)),r},getBoundingBox:function(e){var t=e||new Box3;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.assign(Matrix3.prototype,{isMatrix3:!0,set:function(e,t,i,r,n,o,a,s,l){var c=this.elements;return c[0]=e,c[1]=r,c[2]=a,c[3]=t,c[4]=n,c[5]=s,c[6]=i,c[7]=o,c[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var e=new Vector3;return function(t){for(var i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix3(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var i=e.elements,r=t.elements,n=this.elements,o=i[0],a=i[3],s=i[6],l=i[1],c=i[4],h=i[7],u=i[2],d=i[5],p=i[8],f=r[0],m=r[3],v=r[6],g=r[1],y=r[4],x=r[7],b=r[2],_=r[5],w=r[8];return n[0]=o*f+a*g+s*b,n[3]=o*m+a*y+s*_,n[6]=o*v+a*x+s*w,n[1]=l*f+c*g+h*b,n[4]=l*m+c*y+h*_,n[7]=l*v+c*x+h*w,n[2]=u*f+d*g+p*b,n[5]=u*m+d*y+p*_,n[8]=u*v+d*x+p*w,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],i=e[1],r=e[2],n=e[3],o=e[4],a=e[5],s=e[6],l=e[7],c=e[8];return t*o*c-t*a*l-i*n*c+i*a*s+r*n*l-r*o*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3.getInverse no longer takes a Matrix4 argument.");var i=e.elements,r=this.elements,n=i[0],o=i[1],a=i[2],s=i[3],l=i[4],c=i[5],h=i[6],u=i[7],d=i[8],p=d*l-c*u,f=c*h-d*s,m=u*s-l*h,v=n*p+o*f+a*m;if(0===v){var g="THREE.Matrix3.getInverse(): can't invert matrix, determinant is 0";if(t===!0)throw new Error(g);return console.warn(g),this.identity()}var y=1/v;return r[0]=p*y,r[1]=(a*u-d*o)*y,r[2]=(c*o-a*l)*y,r[3]=f*y,r[4]=(d*n-a*h)*y,r[5]=(a*s-c*n)*y,r[6]=m*y,r[7]=(o*h-u*n)*y,r[8]=(l*n-o*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},equals:function(e){for(var t=this.elements,i=e.elements,r=0;r<9;r++)if(t[r]!==i[r])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<9;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}}),Object.assign(Plane.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,r){return this.normal.set(e,t,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new Vector3,t=new Vector3;return function(i,r,n){var o=e.subVectors(n,r).cross(t.subVectors(i,r)).normalize();return this.setFromNormalAndCoplanarPoint(o,i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var i=this.distanceToPoint(e),r=t||new Vector3;return r.copy(this.normal).multiplyScalar(i)},intersectLine:function(){var e=new Vector3;return function(t,i){var r=i||new Vector3,n=t.delta(e),o=this.normal.dot(n);if(0!==o){var a=-(t.start.dot(this.normal)+this.constant)/o;if(!(a<0||a>1))return r.copy(n).multiplyScalar(a).add(t.start)}else if(0===this.distanceToPoint(t.start))return r.copy(t.start)}}(),intersectsLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){var t=e||new Vector3;return t.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new Vector3,t=new Matrix3;return function(i,r){var n=this.coplanarPoint(e).applyMatrix4(i),o=r||t.getNormalMatrix(i),a=this.normal.applyMatrix3(o).normalize();return this.constant=-n.dot(a),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(Frustum.prototype,{set:function(e,t,i,r,n,o){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(r),a[4].copy(n),a[5].copy(o),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,i=e.elements,r=i[0],n=i[1],o=i[2],a=i[3],s=i[4],l=i[5],c=i[6],h=i[7],u=i[8],d=i[9],p=i[10],f=i[11],m=i[12],v=i[13],g=i[14],y=i[15];return t[0].setComponents(a-r,h-s,f-u,y-m).normalize(),t[1].setComponents(a+r,h+s,f+u,y+m).normalize(),t[2].setComponents(a+n,h+l,f+d,y+v).normalize(),t[3].setComponents(a-n,h-l,f-d,y-v).normalize(),t[4].setComponents(a-o,h-c,f-p,y-g).normalize(),t[5].setComponents(a+o,h+c,f+p,y+g).normalize(),this},intersectsObject:function(){var e=new Sphere;return function(t){var i=t.geometry;return null===i.boundingSphere&&i.computeBoundingSphere(),e.copy(i.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSprite:function(){var e=new Sphere;return function(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,i=e.center,r=-e.radius,n=0;n<6;n++){var o=t[n].distanceToPoint(i);if(o<r)return!1}return!0},intersectsBox:function(){var e=new Vector3,t=new Vector3;return function(i){for(var r=this.planes,n=0;n<6;n++){var o=r[n];e.x=o.normal.x>0?i.min.x:i.max.x,t.x=o.normal.x>0?i.max.x:i.min.x,e.y=o.normal.y>0?i.min.y:i.max.y,t.y=o.normal.y>0?i.max.y:i.min.y,e.z=o.normal.z>0?i.min.z:i.max.z,t.z=o.normal.z>0?i.max.z:i.min.z;var a=o.distanceToPoint(e),s=o.distanceToPoint(t);if(a<0&&s<0)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}}),Object.assign(Ray.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){var i=t||new Vector3;return i.copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new Vector3;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var i=t||new Vector3;i.subVectors(e,this.origin);var r=i.dot(this.direction);return r<0?i.copy(this.origin):i.copy(this.direction).multiplyScalar(r).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new Vector3;return function(t){var i=e.subVectors(t,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(i).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:function(){var e=new Vector3,t=new Vector3,i=new Vector3;return function(r,n,o,a){e.copy(r).add(n).multiplyScalar(.5),t.copy(n).sub(r).normalize(),i.copy(this.origin).sub(e);var s,l,c,h,u=.5*r.distanceTo(n),d=-this.direction.dot(t),p=i.dot(this.direction),f=-i.dot(t),m=i.lengthSq(),v=Math.abs(1-d*d);if(v>0)if(s=d*f-p,l=d*p-f,h=u*v,s>=0)if(l>=-h)if(l<=h){var g=1/v;s*=g,l*=g,c=s*(s+d*l+2*p)+l*(d*s+l+2*f)+m}else l=u,s=Math.max(0,-(d*l+p)),c=-s*s+l*(l+2*f)+m;else l=-u,s=Math.max(0,-(d*l+p)),c=-s*s+l*(l+2*f)+m;else l<=-h?(s=Math.max(0,-(-d*u+p)),l=s>0?-u:Math.min(Math.max(-u,-f),u),c=-s*s+l*(l+2*f)+m):l<=h?(s=0,l=Math.min(Math.max(-u,-f),u),c=l*(l+2*f)+m):(s=Math.max(0,-(d*u+p)),l=s>0?u:Math.min(Math.max(-u,-f),u),c=-s*s+l*(l+2*f)+m);else l=d>0?-u:u,s=Math.max(0,-(d*l+p)),c=-s*s+l*(l+2*f)+m;return o&&o.copy(this.direction).multiplyScalar(s).add(this.origin),a&&a.copy(t).multiplyScalar(l).add(e),c}}(),intersectSphere:function(){var e=new Vector3;return function(t,i){e.subVectors(t.center,this.origin);var r=e.dot(this.direction),n=e.dot(e)-r*r,o=t.radius*t.radius;if(n>o)return null;var a=Math.sqrt(o-n),s=r-a,l=r+a;return s<0&&l<0?null:s<0?this.at(l,i):this.at(s,i)}}(),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null},intersectPlane:function(e,t){var i=this.distanceToPlane(e);return null===i?null:this.at(i,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);if(0===t)return!0;var i=e.normal.dot(this.direction);return i*t<0},intersectBox:function(e,t){var i,r,n,o,a,s,l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(i=(e.min.x-u.x)*l,r=(e.max.x-u.x)*l):(i=(e.max.x-u.x)*l,r=(e.min.x-u.x)*l),c>=0?(n=(e.min.y-u.y)*c,o=(e.max.y-u.y)*c):(n=(e.max.y-u.y)*c,o=(e.min.y-u.y)*c),i>o||n>r?null:((n>i||i!==i)&&(i=n),(o<r||r!==r)&&(r=o),h>=0?(a=(e.min.z-u.z)*h,s=(e.max.z-u.z)*h):(a=(e.max.z-u.z)*h,s=(e.min.z-u.z)*h),i>s||a>r?null:((a>i||i!==i)&&(i=a),(s<r||r!==r)&&(r=s),r<0?null:this.at(i>=0?i:r,t)))},intersectsBox:function(){var e=new Vector3;return function(t){return null!==this.intersectBox(t,e)}}(),intersectTriangle:function(){var e=new Vector3,t=new Vector3,i=new Vector3,r=new Vector3;return function(n,o,a,s,l){t.subVectors(o,n),i.subVectors(a,n),
r.crossVectors(t,i);var c,h=this.direction.dot(r);if(h>0){if(s)return null;c=1}else{if(!(h<0))return null;c=-1,h=-h}e.subVectors(this.origin,n);var u=c*this.direction.dot(i.crossVectors(e,i));if(u<0)return null;var d=c*this.direction.dot(t.cross(e));if(d<0)return null;if(u+d>h)return null;var p=-c*e.dot(r);return p<0?null:this.at(p/h,l)}}(),applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="XYZ",Object.defineProperties(Euler.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(Euler.prototype,{isEuler:!0,set:function(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._order=r||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,i){var r=_Math.clamp,n=e.elements,o=n[0],a=n[4],s=n[8],l=n[1],c=n[5],h=n[9],u=n[2],d=n[6],p=n[10];return t=t||this._order,"XYZ"===t?(this._y=Math.asin(r(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-a,o)):(this._x=Math.atan2(d,c),this._z=0)):"YXZ"===t?(this._x=Math.asin(-r(h,-1,1)),Math.abs(h)<.99999?(this._y=Math.atan2(s,p),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-u,o),this._z=0)):"ZXY"===t?(this._x=Math.asin(r(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-a,c)):(this._y=0,this._z=Math.atan2(l,o))):"ZYX"===t?(this._y=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(l,o)):(this._x=0,this._z=Math.atan2(-a,c))):"YZX"===t?(this._z=Math.asin(r(l,-1,1)),Math.abs(l)<.99999?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-u,o)):(this._x=0,this._y=Math.atan2(s,p))):"XZY"===t?(this._z=Math.asin(-r(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(d,c),this._y=Math.atan2(s,o)):(this._x=Math.atan2(-h,p),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,i!==!1&&this.onChangeCallback(),this},setFromQuaternion:function(){var e=new Matrix4;return function(t,i,r){return e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,i,r)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(){var e=new Quaternion;return function(t){return e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Layers.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!==(this.mask&e.mask)}});var object3DId=0;Object3D.DefaultUp=new Vector3(0,1,0),Object3D.DefaultMatrixAutoUpdate=!0,Object.assign(Object3D.prototype,EventDispatcher.prototype,{isObject3D:!0,applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var e=new Quaternion;return function(t,i){return e.setFromAxisAngle(t,i),this.quaternion.multiply(e),this}}(),rotateX:function(){var e=new Vector3(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new Vector3(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new Vector3(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new Vector3;return function(t,i){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(i)),this}}(),translateX:function(){var e=new Vector3(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new Vector3(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new Vector3(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var e=new Matrix4;return function(t){return t.applyMatrix4(e.getInverse(this.matrixWorld))}}(),lookAt:function(){var e=new Matrix4;return function(t){this.isCamera?e.lookAt(this.position,t,this.up):e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1)for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);var i=this.children.indexOf(e);i!==-1&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(i,1))},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var i=0,r=this.children.length;i<r;i++){var n=this.children[i],o=n.getObjectByProperty(e,t);if(void 0!==o)return o}},getWorldPosition:function(e){var t=e||new Vector3;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var e=new Vector3,t=new Vector3;return function(i){var r=i||new Quaternion;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,r,t),r}}(),getWorldRotation:function(){var e=new Quaternion;return function(t){var i=t||new Euler;return this.getWorldQuaternion(e),i.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new Vector3,t=new Quaternion;return function(i){var r=i||new Vector3;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,r),r}}(),getWorldDirection:function(){var e=new Quaternion;return function(t){var i=t||new Vector3;return this.getWorldQuaternion(e),i.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].traverse(e)},traverseVisible:function(e){if(this.visible!==!1){e(this);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].updateMatrixWorld(e)},toJSON:function(e){function t(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}function i(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}var r=void 0===e||""===e,n={};r&&(e={geometries:{},materials:{},textures:{},images:{}},n.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var o={};if(o.uuid=this.uuid,o.type=this.type,""!==this.name&&(o.name=this.name),"{}"!==JSON.stringify(this.userData)&&(o.userData=this.userData),this.castShadow===!0&&(o.castShadow=!0),this.receiveShadow===!0&&(o.receiveShadow=!0),this.visible===!1&&(o.visible=!1),o.matrix=this.matrix.toArray(),void 0!==this.geometry&&(o.geometry=t(e.geometries,this.geometry)),void 0!==this.material)if(Array.isArray(this.material)){for(var a=[],s=0,l=this.material.length;s<l;s++)a.push(t(e.materials,this.material[s]));o.material=a}else o.material=t(e.materials,this.material);if(this.children.length>0){o.children=[];for(var s=0;s<this.children.length;s++)o.children.push(this.children[s].toJSON(e).object)}if(r){var c=i(e.geometries),h=i(e.materials),u=i(e.textures),d=i(e.images);c.length>0&&(n.geometries=c),h.length>0&&(n.materials=h),u.length>0&&(n.textures=u),d.length>0&&(n.images=d)}return n.object=o,n},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),t===!0)for(var i=0;i<e.children.length;i++){var r=e.children[i];this.add(r.clone())}return this}}),Object.assign(Line3.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){var t=e||new Vector3;return t.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){var t=e||new Vector3;return t.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var i=t||new Vector3;return this.delta(i).multiplyScalar(e).add(this.start)},closestPointToPointParameter:function(){var e=new Vector3,t=new Vector3;return function(i,r){e.subVectors(i,this.start),t.subVectors(this.end,this.start);var n=t.dot(t),o=t.dot(e),a=o/n;return r&&(a=_Math.clamp(a,0,1)),a}}(),closestPointToPoint:function(e,t,i){var r=this.closestPointToPointParameter(e,t),n=i||new Vector3;return this.delta(n).multiplyScalar(r).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}}),Object.assign(Triangle,{normal:function(){var e=new Vector3;return function(t,i,r,n){var o=n||new Vector3;o.subVectors(r,i),e.subVectors(t,i),o.cross(e);var a=o.lengthSq();return a>0?o.multiplyScalar(1/Math.sqrt(a)):o.set(0,0,0)}}(),barycoordFromPoint:function(){var e=new Vector3,t=new Vector3,i=new Vector3;return function(r,n,o,a,s){e.subVectors(a,n),t.subVectors(o,n),i.subVectors(r,n);var l=e.dot(e),c=e.dot(t),h=e.dot(i),u=t.dot(t),d=t.dot(i),p=l*u-c*c,f=s||new Vector3;if(0===p)return f.set(-2,-1,-1);var m=1/p,v=(u*h-c*d)*m,g=(l*d-c*h)*m;return f.set(1-v-g,g,v)}}(),containsPoint:function(){var e=new Vector3;return function(t,i,r,n){var o=Triangle.barycoordFromPoint(t,i,r,n,e);return o.x>=0&&o.y>=0&&o.x+o.y<=1}}()}),Object.assign(Triangle.prototype,{set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,r){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[r]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new Vector3,t=new Vector3;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){var t=e||new Vector3;return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){var t=e||new Plane;return t.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return Triangle.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:function(){var e=new Plane,t=[new Line3,new Line3,new Line3],i=new Vector3,r=new Vector3;return function(n,o){var a=o||new Vector3,s=1/0;if(e.setFromCoplanarPoints(this.a,this.b,this.c),e.projectPoint(n,i),this.containsPoint(i)===!0)a.copy(i);else{t[0].set(this.a,this.b),t[1].set(this.b,this.c),t[2].set(this.c,this.a);for(var l=0;l<t.length;l++){t[l].closestPointToPoint(i,!0,r);var c=i.distanceToSquared(r);c<s&&(s=c,a.copy(r))}}return a}}(),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),Object.assign(Face3.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,i=e.vertexNormals.length;t<i;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(var t=0,i=e.vertexColors.length;t<i;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}),MeshBasicMaterial.prototype=Object.create(Material.prototype),MeshBasicMaterial.prototype.constructor=MeshBasicMaterial,MeshBasicMaterial.prototype.isMeshBasicMaterial=!0,MeshBasicMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},Object.defineProperty(BufferAttribute.prototype,"needsUpdate",{set:function(e){e===!0&&this.version++}}),Object.assign(BufferAttribute.prototype,{isBufferAttribute:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,i){e*=this.itemSize,i*=t.itemSize;for(var r=0,n=this.itemSize;r<n;r++)this.array[e+r]=t.array[i+r];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",r),o=new Color),t[i++]=o.r,t[i++]=o.g,t[i++]=o.b}return this},copyIndicesArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];t[i++]=o.a,t[i++]=o.b,t[i++]=o.c}return this},copyVector2sArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",r),o=new Vector2),t[i++]=o.x,t[i++]=o.y}return this},copyVector3sArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",r),o=new Vector3),t[i++]=o.x,t[i++]=o.y,t[i++]=o.z}return this},copyVector4sArray:function(e){for(var t=this.array,i=0,r=0,n=e.length;r<n;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",r),o=new Vector4),t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=o.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this},setXYZ:function(e,t,i,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this},setXYZW:function(e,t,i,r,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=r,this.array[e+3]=n,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),Uint16BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint16BufferAttribute.prototype.constructor=Uint16BufferAttribute,Uint32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint32BufferAttribute.prototype.constructor=Uint32BufferAttribute,Float32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Float32BufferAttribute.prototype.constructor=Float32BufferAttribute,Object.assign(DirectGeometry.prototype,{computeGroups:function(e){for(var t,i=[],r=void 0,n=e.faces,o=0;o<n.length;o++){var a=n[o];a.materialIndex!==r&&(r=a.materialIndex,void 0!==t&&(t.count=3*o-t.start,i.push(t)),t={start:3*o,materialIndex:r})}void 0!==t&&(t.count=3*o-t.start,i.push(t)),this.groups=i},fromGeometry:function(e){var t,i=e.faces,r=e.vertices,n=e.faceVertexUvs,o=n[0]&&n[0].length>0,a=n[1]&&n[1].length>0,s=e.morphTargets,l=s.length;if(l>0){t=[];for(var c=0;c<l;c++)t[c]=[];this.morphTargets.position=t}var h,u=e.morphNormals,d=u.length;if(d>0){h=[];for(var c=0;c<d;c++)h[c]=[];this.morphTargets.normal=h}for(var p=e.skinIndices,f=e.skinWeights,m=p.length===r.length,v=f.length===r.length,c=0;c<i.length;c++){var g=i[c];this.vertices.push(r[g.a],r[g.b],r[g.c]);var y=g.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var x=g.normal;this.normals.push(x,x,x)}var b=g.vertexColors;if(3===b.length)this.colors.push(b[0],b[1],b[2]);else{var _=g.color;this.colors.push(_,_,_)}if(o===!0){var w=n[0][c];void 0!==w?this.uvs.push(w[0],w[1],w[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",c),this.uvs.push(new Vector2,new Vector2,new Vector2))}if(a===!0){var w=n[1][c];void 0!==w?this.uvs2.push(w[0],w[1],w[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",c),this.uvs2.push(new Vector2,new Vector2,new Vector2))}for(var M=0;M<l;M++){var E=s[M].vertices;t[M].push(E[g.a],E[g.b],E[g.c])}for(var M=0;M<d;M++){var S=u[M].vertexNormals[c];h[M].push(S.a,S.b,S.c)}m&&this.skinIndices.push(p[g.a],p[g.b],p[g.c]),v&&this.skinWeights.push(f[g.a],f[g.b],f[g.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}});var count=0;Object.assign(Geometry.prototype,EventDispatcher.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new Matrix3).getNormalMatrix(e),i=0,r=this.vertices.length;i<r;i++){var n=this.vertices[i];n.applyMatrix4(e)}for(var i=0,r=this.faces.length;i<r;i++){var o=this.faces[i];o.normal.applyMatrix3(t).normalize();for(var a=0,s=o.vertexNormals.length;a<s;a++)o.vertexNormals[a].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e=new Matrix4;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new Matrix4;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new Matrix4;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new Matrix4;return function(t,i,r){return e.makeTranslation(t,i,r),this.applyMatrix(e),this}}(),scale:function(){var e=new Matrix4;return function(t,i,r){return e.makeScale(t,i,r),this.applyMatrix(e),this}}(),lookAt:function(){var e=new Object3D;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),fromBufferGeometry:function(e){function t(e,t,r,n){var o=void 0!==a?[h[e].clone(),h[t].clone(),h[r].clone()]:[],p=void 0!==s?[i.colors[e].clone(),i.colors[t].clone(),i.colors[r].clone()]:[],f=new Face3(e,t,r,o,p,n);i.faces.push(f),void 0!==l&&i.faceVertexUvs[0].push([u[e].clone(),u[t].clone(),u[r].clone()]),void 0!==c&&i.faceVertexUvs[1].push([d[e].clone(),d[t].clone(),d[r].clone()])}var i=this,r=null!==e.index?e.index.array:void 0,n=e.attributes,o=n.position.array,a=void 0!==n.normal?n.normal.array:void 0,s=void 0!==n.color?n.color.array:void 0,l=void 0!==n.uv?n.uv.array:void 0,c=void 0!==n.uv2?n.uv2.array:void 0;void 0!==c&&(this.faceVertexUvs[1]=[]);for(var h=[],u=[],d=[],p=0,f=0;p<o.length;p+=3,f+=2)i.vertices.push(new Vector3(o[p],o[p+1],o[p+2])),void 0!==a&&h.push(new Vector3(a[p],a[p+1],a[p+2])),void 0!==s&&i.colors.push(new Color(s[p],s[p+1],s[p+2])),void 0!==l&&u.push(new Vector2(l[f],l[f+1])),void 0!==c&&d.push(new Vector2(c[f],c[f+1]));var m=e.groups;if(m.length>0)for(var p=0;p<m.length;p++)for(var v=m[p],g=v.start,y=v.count,f=g,x=g+y;f<x;f+=3)void 0!==r?t(r[f],r[f+1],r[f+2],v.materialIndex):t(f,f+1,f+2,v.materialIndex);else if(void 0!==r)for(var p=0;p<r.length;p+=3)t(r[p],r[p+1],r[p+2]);else for(var p=0;p<o.length/3;p+=3)t(p,p+1,p+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,i=0===t?1:1/t,r=new Matrix4;return r.set(i,0,0,-i*e.x,0,i,0,-i*e.y,0,0,i,-i*e.z,0,0,0,1),this.applyMatrix(r),this},computeFaceNormals:function(){for(var e=new Vector3,t=new Vector3,i=0,r=this.faces.length;i<r;i++){var n=this.faces[i],o=this.vertices[n.a],a=this.vertices[n.b],s=this.vertices[n.c];e.subVectors(s,a),t.subVectors(o,a),e.cross(t),e.normalize(),n.normal.copy(e)}},computeVertexNormals:function(e){void 0===e&&(e=!0);var t,i,r,n,o,a;for(a=new Array(this.vertices.length),t=0,i=this.vertices.length;t<i;t++)a[t]=new Vector3;if(e){var s,l,c,h=new Vector3,u=new Vector3;for(r=0,n=this.faces.length;r<n;r++)o=this.faces[r],s=this.vertices[o.a],l=this.vertices[o.b],c=this.vertices[o.c],h.subVectors(c,l),u.subVectors(s,l),h.cross(u),a[o.a].add(h),a[o.b].add(h),a[o.c].add(h)}else for(this.computeFaceNormals(),r=0,n=this.faces.length;r<n;r++)o=this.faces[r],a[o.a].add(o.normal),a[o.b].add(o.normal),a[o.c].add(o.normal);for(t=0,i=this.vertices.length;t<i;t++)a[t].normalize();for(r=0,n=this.faces.length;r<n;r++){o=this.faces[r];var d=o.vertexNormals;3===d.length?(d[0].copy(a[o.a]),d[1].copy(a[o.b]),d[2].copy(a[o.c])):(d[0]=a[o.a].clone(),d[1]=a[o.b].clone(),d[2]=a[o.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,i;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){i=this.faces[e];var r=i.vertexNormals;3===r.length?(r[0].copy(i.normal),r[1].copy(i.normal),r[2].copy(i.normal)):(r[0]=i.normal.clone(),r[1]=i.normal.clone(),r[2]=i.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,i,r,n;for(i=0,r=this.faces.length;i<r;i++)for(n=this.faces[i],n.__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),e=0,t=n.vertexNormals.length;e<t;e++)n.__originalVertexNormals[e]?n.__originalVertexNormals[e].copy(n.vertexNormals[e]):n.__originalVertexNormals[e]=n.vertexNormals[e].clone();var o=new Geometry;for(o.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var a,s,l=this.morphNormals[e].faceNormals,c=this.morphNormals[e].vertexNormals;for(i=0,r=this.faces.length;i<r;i++)a=new Vector3,s={a:new Vector3,b:new Vector3,c:new Vector3},l.push(a),c.push(s)}var h=this.morphNormals[e];o.vertices=this.morphTargets[e].vertices,o.computeFaceNormals(),o.computeVertexNormals();var a,s;for(i=0,r=this.faces.length;i<r;i++)n=this.faces[i],a=h.faceNormals[i],s=h.vertexNormals[i],a.copy(n.normal),s.a.copy(n.vertexNormals[0]),s.b.copy(n.vertexNormals[1]),s.c.copy(n.vertexNormals[2])}for(i=0,r=this.faces.length;i<r;i++)n=this.faces[i],n.normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeLineDistances:function(){for(var e=0,t=this.vertices,i=0,r=t.length;i<r;i++)i>0&&(e+=t[i].distanceTo(t[i-1])),this.lineDistances[i]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,i){if((e&&e.isGeometry)===!1)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);var r,n=this.vertices.length,o=this.vertices,a=e.vertices,s=this.faces,l=e.faces,c=this.faceVertexUvs[0],h=e.faceVertexUvs[0],u=this.colors,d=e.colors;void 0===i&&(i=0),void 0!==t&&(r=(new Matrix3).getNormalMatrix(t));for(var p=0,f=a.length;p<f;p++){var m=a[p],v=m.clone();void 0!==t&&v.applyMatrix4(t),o.push(v)}for(var p=0,f=d.length;p<f;p++)u.push(d[p].clone());for(p=0,f=l.length;p<f;p++){var g,y,x,b=l[p],_=b.vertexNormals,w=b.vertexColors;g=new Face3(b.a+n,b.b+n,b.c+n),g.normal.copy(b.normal),void 0!==r&&g.normal.applyMatrix3(r).normalize();for(var M=0,E=_.length;M<E;M++)y=_[M].clone(),void 0!==r&&y.applyMatrix3(r).normalize(),g.vertexNormals.push(y);g.color.copy(b.color);for(var M=0,E=w.length;M<E;M++)x=w[M],g.vertexColors.push(x.clone());g.materialIndex=b.materialIndex+i,s.push(g)}for(p=0,f=h.length;p<f;p++){var S=h[p],T=[];if(void 0!==S){for(var M=0,E=S.length;M<E;M++)T.push(S[M].clone());c.push(T)}}},mergeMesh:function(e){return(e&&e.isMesh)===!1?void console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e):(e.matrixAutoUpdate&&e.updateMatrix(),void this.merge(e.geometry,e.matrix))},mergeVertices:function(){var e,t,i,r,n,o,a,s,l={},c=[],h=[],u=4,d=Math.pow(10,u);for(i=0,r=this.vertices.length;i<r;i++)e=this.vertices[i],t=Math.round(e.x*d)+"_"+Math.round(e.y*d)+"_"+Math.round(e.z*d),void 0===l[t]?(l[t]=i,c.push(this.vertices[i]),h[i]=c.length-1):h[i]=h[l[t]];var p=[];for(i=0,r=this.faces.length;i<r;i++){n=this.faces[i],n.a=h[n.a],n.b=h[n.b],n.c=h[n.c],o=[n.a,n.b,n.c];for(var f=0;f<3;f++)if(o[f]===o[(f+1)%3]){p.push(i);break}}for(i=p.length-1;i>=0;i--){var m=p[i];for(this.faces.splice(m,1),a=0,s=this.faceVertexUvs.length;a<s;a++)this.faceVertexUvs[a].splice(m,1)}var v=this.vertices.length-c.length;return this.vertices=c,v},sortFacesByMaterialIndex:function(){function e(e,t){return e.materialIndex-t.materialIndex}for(var t=this.faces,i=t.length,r=0;r<i;r++)t[r]._id=r;t.sort(e);var n,o,a=this.faceVertexUvs[0],s=this.faceVertexUvs[1];a&&a.length===i&&(n=[]),s&&s.length===i&&(o=[]);for(var r=0;r<i;r++){var l=t[r]._id;n&&n.push(a[l]),o&&o.push(s[l])}n&&(this.faceVertexUvs[0]=n),o&&(this.faceVertexUvs[1]=o)},toJSON:function(){function e(e,t,i){return i?e|1<<t:e&~(1<<t)}function t(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==d[t]?d[t]:(d[t]=u.length/3,u.push(e.x,e.y,e.z),d[t])}function i(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==f[t]?f[t]:(f[t]=p.length,p.push(e.getHex()),f[t])}function r(e){var t=e.x.toString()+e.y.toString();return void 0!==v[t]?v[t]:(v[t]=m.length/2,m.push(e.x,e.y),v[t])}var n={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),void 0!==this.parameters){var o=this.parameters;for(var a in o)void 0!==o[a]&&(n[a]=o[a]);return n}for(var s=[],l=0;l<this.vertices.length;l++){var c=this.vertices[l];s.push(c.x,c.y,c.z)}for(var h=[],u=[],d={},p=[],f={},m=[],v={},l=0;l<this.faces.length;l++){var g=this.faces[l],y=!0,x=!1,b=void 0!==this.faceVertexUvs[0][l],_=g.normal.length()>0,w=g.vertexNormals.length>0,M=1!==g.color.r||1!==g.color.g||1!==g.color.b,E=g.vertexColors.length>0,S=0;if(S=e(S,0,0),S=e(S,1,y),S=e(S,2,x),S=e(S,3,b),S=e(S,4,_),S=e(S,5,w),S=e(S,6,M),S=e(S,7,E),h.push(S),h.push(g.a,g.b,g.c),h.push(g.materialIndex),b){var T=this.faceVertexUvs[0][l];h.push(r(T[0]),r(T[1]),r(T[2]))}if(_&&h.push(t(g.normal)),w){var C=g.vertexNormals;h.push(t(C[0]),t(C[1]),t(C[2]))}if(M&&h.push(i(g.color)),E){var A=g.vertexColors;h.push(i(A[0]),i(A[1]),i(A[2]))}}return n.data={},n.data.vertices=s,n.data.normals=u,p.length>0&&(n.data.colors=p),m.length>0&&(n.data.uvs=[m]),n.data.faces=h,n},clone:function(){return(new Geometry).copy(this)},copy:function(e){var t,i,r,n,o,a;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var s=e.vertices;for(t=0,i=s.length;t<i;t++)this.vertices.push(s[t].clone());var l=e.colors;for(t=0,i=l.length;t<i;t++)this.colors.push(l[t].clone());var c=e.faces;for(t=0,i=c.length;t<i;t++)this.faces.push(c[t].clone());for(t=0,i=e.faceVertexUvs.length;t<i;t++){var h=e.faceVertexUvs[t];for(void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]),r=0,n=h.length;r<n;r++){var u=h[r],d=[];for(o=0,a=u.length;o<a;o++){var p=u[o];d.push(p.clone())}this.faceVertexUvs[t].push(d)}}var f=e.morphTargets;for(t=0,i=f.length;t<i;t++){var m={};if(m.name=f[t].name,void 0!==f[t].vertices)for(m.vertices=[],r=0,n=f[t].vertices.length;r<n;r++)m.vertices.push(f[t].vertices[r].clone());if(void 0!==f[t].normals)for(m.normals=[],r=0,n=f[t].normals.length;r<n;r++)m.normals.push(f[t].normals[r].clone());this.morphTargets.push(m)}var v=e.morphNormals;for(t=0,i=v.length;t<i;t++){var g={};if(void 0!==v[t].vertexNormals)for(g.vertexNormals=[],r=0,n=v[t].vertexNormals.length;r<n;r++){var y=v[t].vertexNormals[r],x={};x.a=y.a.clone(),x.b=y.b.clone(),x.c=y.c.clone(),g.vertexNormals.push(x)}if(void 0!==v[t].faceNormals)for(g.faceNormals=[],r=0,n=v[t].faceNormals.length;r<n;r++)g.faceNormals.push(v[t].faceNormals[r].clone());this.morphNormals.push(g)}var b=e.skinWeights;for(t=0,i=b.length;t<i;t++)this.skinWeights.push(b[t].clone());var _=e.skinIndices;for(t=0,i=_.length;t<i;t++)this.skinIndices.push(_[t].clone());var w=e.lineDistances;for(t=0,i=w.length;t<i;t++)this.lineDistances.push(w[t]);var M=e.boundingBox;null!==M&&(this.boundingBox=M.clone());var E=e.boundingSphere;return null!==E&&(this.boundingSphere=E.clone()),
this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),BufferGeometry.MaxIndex=65535,Object.assign(BufferGeometry.prototype,EventDispatcher.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(arrayMax(e)>65535?Uint32BufferAttribute:Uint16BufferAttribute)(e,1):this.index=e},addAttribute:function(e,t){return(t&&t.isBufferAttribute)===!1&&(t&&t.isInterleavedBufferAttribute)===!1?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new BufferAttribute(arguments[1],arguments[2]))):"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this)},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:void 0!==i?i:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var i=this.attributes.normal;if(void 0!==i){var r=(new Matrix3).getNormalMatrix(e);r.applyToBufferAttribute(i),i.needsUpdate=!0}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e=new Matrix4;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new Matrix4;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new Matrix4;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new Matrix4;return function(t,i,r){return e.makeTranslation(t,i,r),this.applyMatrix(e),this}}(),scale:function(){var e=new Matrix4;return function(t,i,r){return e.makeScale(t,i,r),this.applyMatrix(e),this}}(),lookAt:function(){var e=new Object3D;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e.isPoints||e.isLine){var i=new Float32BufferAttribute(3*t.vertices.length,3),r=new Float32BufferAttribute(3*t.colors.length,3);if(this.addAttribute("position",i.copyVector3sArray(t.vertices)),this.addAttribute("color",r.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){var n=new Float32BufferAttribute(t.lineDistances.length,1);this.addAttribute("lineDistance",n.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},updateFromObject:function(e){var t=e.geometry;if(e.isMesh){var i=t.__directGeometry;if(t.elementsNeedUpdate===!0&&(i=void 0,t.elementsNeedUpdate=!1),void 0===i)return this.fromGeometry(t);i.verticesNeedUpdate=t.verticesNeedUpdate,i.normalsNeedUpdate=t.normalsNeedUpdate,i.colorsNeedUpdate=t.colorsNeedUpdate,i.uvsNeedUpdate=t.uvsNeedUpdate,i.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=i}var r;return t.verticesNeedUpdate===!0&&(r=this.attributes.position,void 0!==r&&(r.copyVector3sArray(t.vertices),r.needsUpdate=!0),t.verticesNeedUpdate=!1),t.normalsNeedUpdate===!0&&(r=this.attributes.normal,void 0!==r&&(r.copyVector3sArray(t.normals),r.needsUpdate=!0),t.normalsNeedUpdate=!1),t.colorsNeedUpdate===!0&&(r=this.attributes.color,void 0!==r&&(r.copyColorsArray(t.colors),r.needsUpdate=!0),t.colorsNeedUpdate=!1),t.uvsNeedUpdate&&(r=this.attributes.uv,void 0!==r&&(r.copyVector2sArray(t.uvs),r.needsUpdate=!0),t.uvsNeedUpdate=!1),t.lineDistancesNeedUpdate&&(r=this.attributes.lineDistance,void 0!==r&&(r.copyArray(t.lineDistances),r.needsUpdate=!0),t.lineDistancesNeedUpdate=!1),t.groupsNeedUpdate&&(t.computeGroups(e.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new DirectGeometry).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new BufferAttribute(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var i=new Float32Array(3*e.normals.length);this.addAttribute("normal",new BufferAttribute(i,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var r=new Float32Array(3*e.colors.length);this.addAttribute("color",new BufferAttribute(r,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var n=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new BufferAttribute(n,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var o=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new BufferAttribute(o,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var a=arrayMax(e.indices)>65535?Uint32Array:Uint16Array,s=new a(3*e.indices.length);this.setIndex(new BufferAttribute(s,1).copyIndicesArray(e.indices))}this.groups=e.groups;for(var l in e.morphTargets){for(var c=[],h=e.morphTargets[l],u=0,d=h.length;u<d;u++){var p=h[u],f=new Float32BufferAttribute(3*p.length,3);c.push(f.copyVector3sArray(p))}this.morphAttributes[l]=c}if(e.skinIndices.length>0){var m=new Float32BufferAttribute(4*e.skinIndices.length,4);this.addAttribute("skinIndex",m.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var v=new Float32BufferAttribute(4*e.skinWeights.length,4);this.addAttribute("skinWeight",v.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new Box3,t=new Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);var i=this.attributes.position;if(i){var r=this.boundingSphere.center;e.setFromBufferAttribute(i),e.getCenter(r);for(var n=0,o=0,a=i.count;o<a;o++)t.x=i.getX(o),t.y=i.getY(o),t.z=i.getZ(o),n=Math.max(n,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,i=this.groups;if(t.position){var r=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(r.length),3));else for(var n=t.normal.array,o=0,a=n.length;o<a;o++)n[o]=0;var s,l,c,h=t.normal.array,u=new Vector3,d=new Vector3,p=new Vector3,f=new Vector3,m=new Vector3;if(e){var v=e.array;0===i.length&&this.addGroup(0,v.length);for(var g=0,y=i.length;g<y;++g)for(var x=i[g],b=x.start,_=x.count,o=b,a=b+_;o<a;o+=3)s=3*v[o+0],l=3*v[o+1],c=3*v[o+2],u.fromArray(r,s),d.fromArray(r,l),p.fromArray(r,c),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[s]+=f.x,h[s+1]+=f.y,h[s+2]+=f.z,h[l]+=f.x,h[l+1]+=f.y,h[l+2]+=f.z,h[c]+=f.x,h[c+1]+=f.y,h[c+2]+=f.z}else for(var o=0,a=r.length;o<a;o+=9)u.fromArray(r,o),d.fromArray(r,o+3),p.fromArray(r,o+6),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[o]=f.x,h[o+1]=f.y,h[o+2]=f.z,h[o+3]=f.x,h[o+4]=f.y,h[o+5]=f.z,h[o+6]=f.x,h[o+7]=f.y,h[o+8]=f.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if((e&&e.isBufferGeometry)===!1)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0);var i=this.attributes;for(var r in i)if(void 0!==e.attributes[r])for(var n=i[r],o=n.array,a=e.attributes[r],s=a.array,l=a.itemSize,c=0,h=l*t;c<s.length;c++,h++)o[h]=s[c];return this},normalizeNormals:function(){for(var e,t,i,r,n=this.attributes.normal,o=0,a=n.count;o<a;o++)e=n.getX(o),t=n.getY(o),i=n.getZ(o),r=1/Math.sqrt(e*e+t*t+i*i),n.setXYZ(o,e*r,t*r,i*r)},toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new BufferGeometry,t=this.index.array,i=this.attributes;for(var r in i){for(var n=i[r],o=n.array,a=n.itemSize,s=new o.constructor(t.length*a),l=0,c=0,h=0,u=t.length;h<u;h++){l=t[h]*a;for(var d=0;d<a;d++)s[c++]=o[l++]}e.addAttribute(r,new BufferAttribute(s,a))}return e},toJSON:function(){var e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};var r=this.index;if(null!==r){var n=Array.prototype.slice.call(r.array);e.data.index={type:r.array.constructor.name,array:n}}var o=this.attributes;for(var i in o){var a=o[i],n=Array.prototype.slice.call(a.array);e.data.attributes[i]={itemSize:a.itemSize,type:a.array.constructor.name,array:n,normalized:a.normalized}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var l=this.boundingSphere;return null!==l&&(e.data.boundingSphere={center:l.center.toArray(),radius:l.radius}),e},clone:function(){return(new BufferGeometry).copy(this)},copy:function(e){var t,i,r;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var n=e.index;null!==n&&this.setIndex(n.clone());var o=e.attributes;for(t in o){var a=o[t];this.addAttribute(t,a.clone())}var s=e.morphAttributes;for(t in s){var l=[],c=s[t];for(i=0,r=c.length;i<r;i++)l.push(c[i].clone());this.morphAttributes[t]=l}var h=e.groups;for(i=0,r=h.length;i<r;i++){var u=h[i];this.addGroup(u.start,u.count,u.materialIndex)}var d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());var p=e.boundingSphere;return null!==p&&(this.boundingSphere=p.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Mesh.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Mesh,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return Object3D.prototype.copy.call(this,e),this.drawMode=e.drawMode,this},updateMorphTargets:function(){var e=this.geometry.morphTargets;if(void 0!==e&&e.length>0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var t=0,i=e.length;t<i;t++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[e[t].name]=t}},raycast:function(){function e(e,t,i,r,n,o,a){return Triangle.barycoordFromPoint(e,t,i,r,m),n.multiplyScalar(m.x),o.multiplyScalar(m.y),a.multiplyScalar(m.z),n.add(o).add(a),n.clone()}function t(e,t,i,r,n,o,a){var s,l=e.material;if(s=l.side===BackSide?i.intersectTriangle(o,n,r,!0,a):i.intersectTriangle(r,n,o,l.side!==DoubleSide,a),null===s)return null;g.copy(a),g.applyMatrix4(e.matrixWorld);var c=t.ray.origin.distanceTo(g);return c<t.near||c>t.far?null:{distance:c,point:g.clone(),object:e}}function i(i,r,n,o,c,h,u,m){a.fromBufferAttribute(o,h),s.fromBufferAttribute(o,u),l.fromBufferAttribute(o,m);var g=t(i,r,n,a,s,l,v);return g&&(c&&(d.fromBufferAttribute(c,h),p.fromBufferAttribute(c,u),f.fromBufferAttribute(c,m),g.uv=e(v,a,s,l,d,p,f)),g.face=new Face3(h,u,m,Triangle.normal(a,s,l)),g.faceIndex=h),g}var r=new Matrix4,n=new Ray,o=new Sphere,a=new Vector3,s=new Vector3,l=new Vector3,c=new Vector3,h=new Vector3,u=new Vector3,d=new Vector2,p=new Vector2,f=new Vector2,m=new Vector3,v=new Vector3,g=new Vector3;return function(m,g){var y=this.geometry,x=this.material,b=this.matrixWorld;if(void 0!==x&&(null===y.boundingSphere&&y.computeBoundingSphere(),o.copy(y.boundingSphere),o.applyMatrix4(b),m.ray.intersectsSphere(o)!==!1&&(r.getInverse(b),n.copy(m.ray).applyMatrix4(r),null===y.boundingBox||n.intersectsBox(y.boundingBox)!==!1))){var _;if(y.isBufferGeometry){var w,M,E,S,T,C=y.index,A=y.attributes.position,P=y.attributes.uv;if(null!==C)for(S=0,T=C.count;S<T;S+=3)w=C.getX(S),M=C.getX(S+1),E=C.getX(S+2),_=i(this,m,n,A,P,w,M,E),_&&(_.faceIndex=Math.floor(S/3),g.push(_));else for(S=0,T=A.count;S<T;S+=3)w=S,M=S+1,E=S+2,_=i(this,m,n,A,P,w,M,E),_&&(_.index=w,g.push(_))}else if(y.isGeometry){var R,L,B,O,I=Array.isArray(x),D=y.vertices,k=y.faces,F=y.faceVertexUvs[0];F.length>0&&(O=F);for(var N=0,V=k.length;N<V;N++){var U=k[N],G=I?x[U.materialIndex]:x;if(void 0!==G){if(R=D[U.a],L=D[U.b],B=D[U.c],G.morphTargets===!0){var z=y.morphTargets,j=this.morphTargetInfluences;a.set(0,0,0),s.set(0,0,0),l.set(0,0,0);for(var H=0,W=z.length;H<W;H++){var q=j[H];if(0!==q){var X=z[H].vertices;a.addScaledVector(c.subVectors(X[U.a],R),q),s.addScaledVector(h.subVectors(X[U.b],L),q),l.addScaledVector(u.subVectors(X[U.c],B),q)}}a.add(R),s.add(L),l.add(B),R=a,L=s,B=l}if(_=t(this,m,n,R,L,B,v)){if(O&&O[N]){var Y=O[N];d.copy(Y[0]),p.copy(Y[1]),f.copy(Y[2]),_.uv=e(v,R,L,B,d,p,f)}_.face=U,_.faceIndex=N,g.push(_)}}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),BoxGeometry.prototype=Object.create(Geometry.prototype),BoxGeometry.prototype.constructor=BoxGeometry,BoxBufferGeometry.prototype=Object.create(BufferGeometry.prototype),BoxBufferGeometry.prototype.constructor=BoxBufferGeometry,PlaneGeometry.prototype=Object.create(Geometry.prototype),PlaneGeometry.prototype.constructor=PlaneGeometry,PlaneBufferGeometry.prototype=Object.create(BufferGeometry.prototype),PlaneBufferGeometry.prototype.constructor=PlaneBufferGeometry,Camera.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Camera,isCamera:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},getWorldDirection:function(){var e=new Quaternion;return function(t){var i=t||new Vector3;return this.getWorldQuaternion(e),i.set(0,0,-1).applyQuaternion(e)}}(),clone:function(){return(new this.constructor).copy(this)}}),PerspectiveCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:PerspectiveCamera,isPerspectiveCamera:!0,copy:function(e){return Camera.prototype.copy.call(this,e),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*_Math.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*_Math.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*_Math.RAD2DEG*Math.atan(Math.tan(.5*_Math.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,i,r,n,o){this.aspect=e/t,this.view={fullWidth:e,fullHeight:t,offsetX:i,offsetY:r,width:n,height:o},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*_Math.DEG2RAD*this.fov)/this.zoom,i=2*t,r=this.aspect*i,n=-.5*r,o=this.view;if(null!==o){var a=o.fullWidth,s=o.fullHeight;n+=o.offsetX*r/a,t-=o.offsetY*i/s,r*=o.width/a,i*=o.height/s}var l=this.filmOffset;0!==l&&(n+=e*l/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+r,t,t-i,e,this.far)},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),OrthographicCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:OrthographicCamera,isOrthographicCamera:!0,copy:function(e){return Camera.prototype.copy.call(this,e),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,i,r,n,o){this.view={fullWidth:e,fullHeight:t,offsetX:i,offsetY:r,width:n,height:o},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,r=(this.top+this.bottom)/2,n=i-e,o=i+e,a=r+t,s=r-t;if(null!==this.view){var l=this.zoom/(this.view.width/this.view.fullWidth),c=this.zoom/(this.view.height/this.view.fullHeight),h=(this.right-this.left)/this.view.width,u=(this.top-this.bottom)/this.view.height;n+=h*(this.view.offsetX/l),o=n+h*(this.view.width/l),a-=u*(this.view.offsetY/c),s=a-u*(this.view.height/c)}this.projectionMatrix.makeOrthographic(n,o,a,s,this.near,this.far)},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}});var programIdCount=0;FogExp2.prototype.isFogExp2=!0,FogExp2.prototype.clone=function(){return new FogExp2(this.color.getHex(),this.density)},FogExp2.prototype.toJSON=function(e){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},Fog.prototype.isFog=!0,Fog.prototype.clone=function(){return new Fog(this.color.getHex(),this.near,this.far)},Fog.prototype.toJSON=function(e){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},Scene.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Scene,copy:function(e,t){return Object3D.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}),LensFlare.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LensFlare,isLensFlare:!0,copy:function(e){Object3D.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,i=e.lensFlares.length;t<i;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,i,r,n,o){void 0===t&&(t=-1),void 0===i&&(i=0),void 0===o&&(o=1),void 0===n&&(n=new Color(16777215)),void 0===r&&(r=NormalBlending),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:e,size:t,distance:i,x:0,y:0,z:0,scale:1,rotation:0,opacity:o,color:n,blending:r})},updateLensFlares:function(){var e,t,i=this.lensFlares.length,r=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<i;e++)t=this.lensFlares[e],t.x=this.positionScreen.x+r*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),SpriteMaterial.prototype=Object.create(Material.prototype),SpriteMaterial.prototype.constructor=SpriteMaterial,SpriteMaterial.prototype.isSpriteMaterial=!0,SpriteMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},Sprite.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Sprite,isSprite:!0,raycast:function(){var e=new Vector3,t=new Vector3,i=new Vector3;return function(r,n){t.setFromMatrixPosition(this.matrixWorld),r.ray.closestPointToPoint(t,e),i.setFromMatrixScale(this.matrixWorld);var o=i.x*i.y/4;if(!(t.distanceToSquared(e)>o)){var a=r.ray.origin.distanceTo(e);a<r.near||a>r.far||n.push({distance:a,point:e.clone(),face:null,object:this})}}}(),clone:function(){return new this.constructor(this.material).copy(this)}}),LOD.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LOD,copy:function(e){Object3D.prototype.copy.call(this,e,!1);for(var t=e.levels,i=0,r=t.length;i<r;i++){var n=t[i];this.addLevel(n.object.clone(),n.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var i=this.levels,r=0;r<i.length&&!(t<i[r].distance);r++);i.splice(r,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,i=1,r=t.length;i<r&&!(e<t[i].distance);i++);return t[i-1].object},raycast:function(){var e=new Vector3;return function(t,i){e.setFromMatrixPosition(this.matrixWorld);var r=t.ray.origin.distanceTo(e);this.getObjectForDistance(r).raycast(t,i)}}(),update:function(){var e=new Vector3,t=new Vector3;return function(i){var r=this.levels;if(r.length>1){e.setFromMatrixPosition(i.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var n=e.distanceTo(t);r[0].object.visible=!0;for(var o=1,a=r.length;o<a&&n>=r[o].distance;o++)r[o-1].object.visible=!1,r[o].object.visible=!0;for(;o<a;o++)r[o].object.visible=!1}}}(),toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);t.object.levels=[];for(var i=this.levels,r=0,n=i.length;r<n;r++){var o=i[r];t.object.levels.push({object:o.object.uuid,distance:o.distance})}return t}}),Object.assign(Skeleton.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var i=new Matrix4;this.bones[e]&&i.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(i)}},pose:function(){var e,t,i;for(t=0,i=this.bones.length;t<i;t++)e=this.bones[t],e&&e.matrixWorld.getInverse(this.boneInverses[t]);for(t=0,i=this.bones.length;t<i;t++)e=this.bones[t],e&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:function(){var e=new Matrix4,t=new Matrix4;return function(){for(var i=this.bones,r=this.boneInverses,n=this.boneMatrices,o=this.boneTexture,a=0,s=i.length;a<s;a++){var l=i[a]?i[a].matrixWorld:t;e.multiplyMatrices(l,r[a]),e.toArray(n,16*a)}void 0!==o&&(o.needsUpdate=!0)}}(),clone:function(){return new Skeleton(this.bones,this.boneInverses)}}),Bone.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Bone,isBone:!0}),SkinnedMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:SkinnedMesh,isSkinnedMesh:!0,initBones:function(){var e,t,i,r,n=[];if(this.geometry&&void 0!==this.geometry.bones){for(i=0,r=this.geometry.bones.length;i<r;i++)t=this.geometry.bones[i],e=new Bone,n.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(i=0,r=this.geometry.bones.length;i<r;i++)t=this.geometry.bones[i],t.parent!==-1&&null!==t.parent&&void 0!==n[t.parent]?n[t.parent].add(n[i]):this.add(n[i])}return this.updateMatrixWorld(!0),n},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var i=this.geometry.skinWeights[t];e=1/i.lengthManhattan(),e!==1/0?i.multiplyScalar(e):i.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var r=new Vector4,n=this.geometry.attributes.skinWeight;for(t=0;t<n.count;t++)r.x=n.getX(t),r.y=n.getY(t),r.z=n.getZ(t),r.w=n.getW(t),e=1/r.lengthManhattan(),e!==1/0?r.multiplyScalar(e):r.set(1,0,0,0),n.setXYZW(t,r.x,r.y,r.z,r.w)}},updateMatrixWorld:function(e){Mesh.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),LineBasicMaterial.prototype=Object.create(Material.prototype),LineBasicMaterial.prototype.constructor=LineBasicMaterial,LineBasicMaterial.prototype.isLineBasicMaterial=!0,LineBasicMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},Line.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Line,isLine:!0,raycast:function(){var e=new Matrix4,t=new Ray,i=new Sphere;return function(r,n){var o=r.linePrecision,a=o*o,s=this.geometry,l=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere),i.applyMatrix4(l),r.ray.intersectsSphere(i)!==!1){e.getInverse(l),t.copy(r.ray).applyMatrix4(e);var c=new Vector3,h=new Vector3,u=new Vector3,d=new Vector3,p=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){var f=s.index,m=s.attributes,v=m.position.array;if(null!==f)for(var g=f.array,y=0,x=g.length-1;y<x;y+=p){var b=g[y],_=g[y+1];c.fromArray(v,3*b),h.fromArray(v,3*_);var w=t.distanceSqToSegment(c,h,d,u);if(!(w>a)){d.applyMatrix4(this.matrixWorld);var M=r.ray.origin.distanceTo(d);M<r.near||M>r.far||n.push({distance:M,point:u.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this})}}else for(var y=0,x=v.length/3-1;y<x;y+=p){c.fromArray(v,3*y),h.fromArray(v,3*y+3);var w=t.distanceSqToSegment(c,h,d,u);if(!(w>a)){d.applyMatrix4(this.matrixWorld);var M=r.ray.origin.distanceTo(d);M<r.near||M>r.far||n.push({distance:M,point:u.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this})}}}else if(s.isGeometry)for(var E=s.vertices,S=E.length,y=0;y<S-1;y+=p){var w=t.distanceSqToSegment(E[y],E[y+1],d,u);if(!(w>a)){d.applyMatrix4(this.matrixWorld);var M=r.ray.origin.distanceTo(d);M<r.near||M>r.far||n.push({distance:M,point:u.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),LineSegments.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineSegments,isLineSegments:!0}),LineLoop.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineLoop,isLineLoop:!0}),PointsMaterial.prototype=Object.create(Material.prototype),PointsMaterial.prototype.constructor=PointsMaterial,PointsMaterial.prototype.isPointsMaterial=!0,PointsMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this},Points.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Points,isPoints:!0,raycast:function(){var e=new Matrix4,t=new Ray,i=new Sphere;return function(r,n){function o(e,i){var o=t.distanceSqToPoint(e);if(o<u){var s=t.closestPointToPoint(e);s.applyMatrix4(l);var c=r.ray.origin.distanceTo(s);if(c<r.near||c>r.far)return;n.push({distance:c,distanceToRay:Math.sqrt(o),point:s.clone(),index:i,face:null,object:a})}}var a=this,s=this.geometry,l=this.matrixWorld,c=r.params.Points.threshold;if(null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere),i.applyMatrix4(l),i.radius+=c,r.ray.intersectsSphere(i)!==!1){e.getInverse(l),t.copy(r.ray).applyMatrix4(e);var h=c/((this.scale.x+this.scale.y+this.scale.z)/3),u=h*h,d=new Vector3;if(s.isBufferGeometry){var p=s.index,f=s.attributes,m=f.position.array;if(null!==p)for(var v=p.array,g=0,y=v.length;g<y;g++){var x=v[g];d.fromArray(m,3*x),o(d,x)}else for(var g=0,b=m.length/3;g<b;g++)d.fromArray(m,3*g),o(d,g)}else for(var _=s.vertices,g=0,b=_.length;g<b;g++)o(_[g],g)}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Group.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Group}),CompressedTexture.prototype=Object.create(Texture.prototype),CompressedTexture.prototype.constructor=CompressedTexture,CompressedTexture.prototype.isCompressedTexture=!0,WireframeGeometry.prototype=Object.create(BufferGeometry.prototype),WireframeGeometry.prototype.constructor=WireframeGeometry,ParametricGeometry.prototype=Object.create(Geometry.prototype),ParametricGeometry.prototype.constructor=ParametricGeometry,ParametricBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ParametricBufferGeometry.prototype.constructor=ParametricBufferGeometry,PolyhedronGeometry.prototype=Object.create(Geometry.prototype),PolyhedronGeometry.prototype.constructor=PolyhedronGeometry,PolyhedronBufferGeometry.prototype=Object.create(BufferGeometry.prototype),PolyhedronBufferGeometry.prototype.constructor=PolyhedronBufferGeometry,TetrahedronGeometry.prototype=Object.create(Geometry.prototype),TetrahedronGeometry.prototype.constructor=TetrahedronGeometry,TetrahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),TetrahedronBufferGeometry.prototype.constructor=TetrahedronBufferGeometry,OctahedronGeometry.prototype=Object.create(Geometry.prototype),OctahedronGeometry.prototype.constructor=OctahedronGeometry,OctahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),OctahedronBufferGeometry.prototype.constructor=OctahedronBufferGeometry,IcosahedronGeometry.prototype=Object.create(Geometry.prototype),IcosahedronGeometry.prototype.constructor=IcosahedronGeometry,IcosahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),IcosahedronBufferGeometry.prototype.constructor=IcosahedronBufferGeometry,DodecahedronGeometry.prototype=Object.create(Geometry.prototype),DodecahedronGeometry.prototype.constructor=DodecahedronGeometry,DodecahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),DodecahedronBufferGeometry.prototype.constructor=DodecahedronBufferGeometry,TubeGeometry.prototype=Object.create(Geometry.prototype),TubeGeometry.prototype.constructor=TubeGeometry,TubeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TubeBufferGeometry.prototype.constructor=TubeBufferGeometry,TorusKnotGeometry.prototype=Object.create(Geometry.prototype),TorusKnotGeometry.prototype.constructor=TorusKnotGeometry,TorusKnotBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TorusKnotBufferGeometry.prototype.constructor=TorusKnotBufferGeometry,TorusGeometry.prototype=Object.create(Geometry.prototype),TorusGeometry.prototype.constructor=TorusGeometry,TorusBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TorusBufferGeometry.prototype.constructor=TorusBufferGeometry;var ShapeUtils={area:function(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},triangulate:function(){function e(e,t,i,r,n,o){var a,s,l,c,h,u,d,p,f;if(s=e[o[t]].x,l=e[o[t]].y,c=e[o[i]].x,h=e[o[i]].y,u=e[o[r]].x,d=e[o[r]].y,(c-s)*(d-l)-(h-l)*(u-s)<=0)return!1;var m,v,g,y,x,b,_,w,M,E,S,T,C,A,P;
for(m=u-c,v=d-h,g=s-u,y=l-d,x=c-s,b=h-l,a=0;a<n;a++)if(p=e[o[a]].x,f=e[o[a]].y,!(p===s&&f===l||p===c&&f===h||p===u&&f===d)&&(_=p-s,w=f-l,M=p-c,E=f-h,S=p-u,T=f-d,P=m*E-v*M,C=x*w-b*_,A=g*T-y*S,P>=-Number.EPSILON&&A>=-Number.EPSILON&&C>=-Number.EPSILON))return!1;return!0}return function(t,i){var r=t.length;if(r<3)return null;var n,o,a,s=[],l=[],c=[];if(ShapeUtils.area(t)>0)for(o=0;o<r;o++)l[o]=o;else for(o=0;o<r;o++)l[o]=r-1-o;var h=r,u=2*h;for(o=h-1;h>2;){if(u--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),i?c:s;if(n=o,h<=n&&(n=0),o=n+1,h<=o&&(o=0),a=o+1,h<=a&&(a=0),e(t,n,o,a,h,l)){var d,p,f,m,v;for(d=l[n],p=l[o],f=l[a],s.push([t[d],t[p],t[f]]),c.push([l[n],l[o],l[a]]),m=o,v=o+1;v<h;m++,v++)l[m]=l[v];h--,u=2*h}}return i?c:s}}(),triangulateShape:function(e,t){function i(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function r(e,t,i){return e.x!==t.x?e.x<t.x?e.x<=i.x&&i.x<=t.x:t.x<=i.x&&i.x<=e.x:e.y<t.y?e.y<=i.y&&i.y<=t.y:t.y<=i.y&&i.y<=e.y}function n(e,t,i,n,o){var a=t.x-e.x,s=t.y-e.y,l=n.x-i.x,c=n.y-i.y,h=e.x-i.x,u=e.y-i.y,d=s*l-a*c,p=s*h-a*u;if(Math.abs(d)>Number.EPSILON){var f;if(d>0){if(p<0||p>d)return[];if(f=c*h-l*u,f<0||f>d)return[]}else{if(p>0||p<d)return[];if(f=c*h-l*u,f>0||f<d)return[]}if(0===f)return!o||0!==p&&p!==d?[e]:[];if(f===d)return!o||0!==p&&p!==d?[t]:[];if(0===p)return[i];if(p===d)return[n];var m=f/d;return[{x:e.x+m*a,y:e.y+m*s}]}if(0!==p||c*h!==l*u)return[];var v=0===a&&0===s,g=0===l&&0===c;if(v&&g)return e.x!==i.x||e.y!==i.y?[]:[e];if(v)return r(i,n,e)?[e]:[];if(g)return r(e,t,i)?[i]:[];var y,x,b,_,w,M,E,S;return 0!==a?(e.x<t.x?(y=e,b=e.x,x=t,_=t.x):(y=t,b=t.x,x=e,_=e.x),i.x<n.x?(w=i,E=i.x,M=n,S=n.x):(w=n,E=n.x,M=i,S=i.x)):(e.y<t.y?(y=e,b=e.y,x=t,_=t.y):(y=t,b=t.y,x=e,_=e.y),i.y<n.y?(w=i,E=i.y,M=n,S=n.y):(w=n,E=n.y,M=i,S=i.y)),b<=E?_<E?[]:_===E?o?[]:[w]:_<=S?[w,x]:[w,M]:b>S?[]:b===S?o?[]:[y]:_<=S?[y,x]:[y,M]}function o(e,t,i,r){var n=t.x-e.x,o=t.y-e.y,a=i.x-e.x,s=i.y-e.y,l=r.x-e.x,c=r.y-e.y,h=n*s-o*a,u=n*c-o*l;if(Math.abs(h)>Number.EPSILON){var d=l*s-c*a;return h>0?u>=0&&d>=0:u>=0||d>=0}return u>0}function a(e,t){function i(e,t){var i=y.length-1,r=e-1;r<0&&(r=i);var n=e+1;n>i&&(n=0);var a=o(y[e],y[r],y[n],s[t]);if(!a)return!1;var l=s.length-1,c=t-1;c<0&&(c=l);var h=t+1;return h>l&&(h=0),a=o(s[t],s[c],s[h],y[e]),!!a}function r(e,t){var i,r,o;for(i=0;i<y.length;i++)if(r=i+1,r%=y.length,o=n(e,t,y[i],y[r],!0),o.length>0)return!0;return!1}function a(e,i){var r,o,a,s,l;for(r=0;r<x.length;r++)for(o=t[x[r]],a=0;a<o.length;a++)if(s=a+1,s%=o.length,l=n(e,i,o[a],o[s],!0),l.length>0)return!0;return!1}for(var s,l,c,h,u,d,p,f,m,v,g,y=e.concat(),x=[],b=[],_=0,w=t.length;_<w;_++)x.push(_);for(var M=0,E=2*x.length;x.length>0;){if(E--,E<0){console.log("Infinite Loop! Holes left:"+x.length+", Probably Hole outside Shape!");break}for(c=M;c<y.length;c++){h=y[c],l=-1;for(var _=0;_<x.length;_++)if(d=x[_],p=h.x+":"+h.y+":"+d,void 0===b[p]){s=t[d];for(var S=0;S<s.length;S++)if(u=s[S],i(c,S)&&!r(h,u)&&!a(h,u)){l=S,x.splice(_,1),f=y.slice(0,c+1),m=y.slice(c),v=s.slice(l),g=s.slice(0,l+1),y=f.concat(v).concat(g).concat(m),M=c;break}if(l>=0)break;b[p]=!0}if(l>=0)break}}return y}i(e),t.forEach(i);for(var s,l,c,h,u,d,p={},f=e.concat(),m=0,v=t.length;m<v;m++)Array.prototype.push.apply(f,t[m]);for(s=0,l=f.length;s<l;s++)u=f[s].x+":"+f[s].y,void 0!==p[u]&&console.warn("THREE.ShapeUtils: Duplicate point",u,s),p[u]=s;var g=a(e,t),y=ShapeUtils.triangulate(g,!1);for(s=0,l=y.length;s<l;s++)for(h=y[s],c=0;c<3;c++)u=h[c].x+":"+h[c].y,d=p[u],void 0!==d&&(h[c]=d);return y.concat()},isClockWise:function(e){return ShapeUtils.area(e)<0}};ExtrudeGeometry.prototype=Object.create(Geometry.prototype),ExtrudeGeometry.prototype.constructor=ExtrudeGeometry,ExtrudeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ExtrudeBufferGeometry.prototype.constructor=ExtrudeBufferGeometry,ExtrudeBufferGeometry.prototype.getArrays=function(){var e=this.getAttribute("position"),t=e?Array.prototype.slice.call(e.array):[],i=this.getAttribute("uv"),r=i?Array.prototype.slice.call(i.array):[],n=this.index,o=n?Array.prototype.slice.call(n.array):[];return{position:t,uv:r,index:o}},ExtrudeBufferGeometry.prototype.addShapeList=function(e,t){var i=e.length;t.arrays=this.getArrays();for(var r=0;r<i;r++){var n=e[r];this.addShape(n,t)}this.setIndex(t.arrays.index),this.addAttribute("position",new Float32BufferAttribute(t.arrays.position,3)),this.addAttribute("uv",new Float32BufferAttribute(t.arrays.uv,2))},ExtrudeBufferGeometry.prototype.addShape=function(e,t){function i(e,t,i){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(i).add(e)}function r(e,t,i){var r,n,o=1,a=e.x-t.x,s=e.y-t.y,l=i.x-e.x,c=i.y-e.y,h=a*a+s*s,u=a*c-s*l;if(Math.abs(u)>Number.EPSILON){var d=Math.sqrt(h),p=Math.sqrt(l*l+c*c),f=t.x-s/d,m=t.y+a/d,v=i.x-c/p,g=i.y+l/p,y=((v-f)*c-(g-m)*l)/(a*c-s*l);r=f+a*y-e.x,n=m+s*y-e.y;var x=r*r+n*n;if(x<=2)return new Vector2(r,n);o=Math.sqrt(x/2)}else{var b=!1;a>Number.EPSILON?l>Number.EPSILON&&(b=!0):a<-Number.EPSILON?l<-Number.EPSILON&&(b=!0):Math.sign(s)===Math.sign(c)&&(b=!0),b?(r=-s,n=a,o=Math.sqrt(h)):(r=a,n=s,o=Math.sqrt(h/2))}return new Vector2(r/o,n/o)}function n(){var e=y.length/3;if(T){var i=0,r=Y*i;for(Z=0;Z<K;Z++)X=U[Z],l(X[2]+r,X[1]+r,X[0]+r);for(i=A+2*S,r=Y*i,Z=0;Z<K;Z++)X=U[Z],l(X[0]+r,X[1]+r,X[2]+r)}else{for(Z=0;Z<K;Z++)X=U[Z],l(X[2],X[1],X[0]);for(Z=0;Z<K;Z++)X=U[Z],l(X[0]+Y*A,X[1]+Y*A,X[2]+Y*A)}D.addGroup(e,y.length/3-e,void 0!==t.material?t.material:0)}function o(){var e=y.length/3,i=0;for(a(G,i),i+=G.length,O=0,I=N.length;O<I;O++)B=N[O],a(B,i),i+=B.length;D.addGroup(e,y.length/3-e,void 0!==t.extrudeMaterial?t.extrudeMaterial:1)}function a(e,t){var i,r;for(Z=e.length;--Z>=0;){i=Z,r=Z-1,r<0&&(r=e.length-1);var n=0,o=A+2*S;for(n=0;n<o;n++){var a=Y*n,s=Y*(n+1),l=t+i+a,h=t+r+a,u=t+r+s,d=t+i+s;c(l,h,u,d,e,n,o,i,r)}}}function s(e,t,i){_.push(e),_.push(t),_.push(i)}function l(e,t,i){h(e),h(t),h(i);var r=y.length/3,n=L.generateTopUV(D,y,r-3,r-2,r-1);u(n[0]),u(n[1]),u(n[2])}function c(e,t,i,r,n,o,a,s,l){h(e),h(t),h(r),h(t),h(i),h(r);var c=y.length/3,d=L.generateSideWallUV(D,y,c-6,c-3,c-2,c-1);u(d[0]),u(d[1]),u(d[3]),u(d[1]),u(d[2]),u(d[3])}function h(e){x.push(y.length/3),y.push(_[3*e+0]),y.push(_[3*e+1]),y.push(_[3*e+2])}function u(e){b.push(e.x),b.push(e.y)}var d,p,f,m,v,g=t.arrays?t.arrays:this.getArrays(),y=g.position,x=g.index,b=g.uv,_=[],w=void 0!==t.amount?t.amount:100,M=void 0!==t.bevelThickness?t.bevelThickness:6,E=void 0!==t.bevelSize?t.bevelSize:M-2,S=void 0!==t.bevelSegments?t.bevelSegments:3,T=void 0===t.bevelEnabled||t.bevelEnabled,C=void 0!==t.curveSegments?t.curveSegments:12,A=void 0!==t.steps?t.steps:1,P=t.extrudePath,R=!1,L=void 0!==t.UVGenerator?t.UVGenerator:ExtrudeGeometry.WorldUVGenerator;P&&(d=P.getSpacedPoints(A),R=!0,T=!1,p=void 0!==t.frames?t.frames:P.computeFrenetFrames(A,!1),f=new Vector3,m=new Vector3,v=new Vector3),T||(S=0,M=0,E=0);var B,O,I,D=this,k=e.extractPoints(C),F=k.shape,N=k.holes,V=!ShapeUtils.isClockWise(F);if(V){for(F=F.reverse(),O=0,I=N.length;O<I;O++)B=N[O],ShapeUtils.isClockWise(B)&&(N[O]=B.reverse());V=!1}var U=ShapeUtils.triangulateShape(F,N),G=F;for(O=0,I=N.length;O<I;O++)B=N[O],F=F.concat(B);for(var z,j,H,W,q,X,Y=F.length,K=U.length,Q=[],Z=0,J=G.length,$=J-1,ee=Z+1;Z<J;Z++,$++,ee++)$===J&&($=0),ee===J&&(ee=0),Q[Z]=r(G[Z],G[$],G[ee]);var te,ie=[],re=Q.concat();for(O=0,I=N.length;O<I;O++){for(B=N[O],te=[],Z=0,J=B.length,$=J-1,ee=Z+1;Z<J;Z++,$++,ee++)$===J&&($=0),ee===J&&(ee=0),te[Z]=r(B[Z],B[$],B[ee]);ie.push(te),re=re.concat(te)}for(z=0;z<S;z++){for(H=z/S,W=M*Math.cos(H*Math.PI/2),j=E*Math.sin(H*Math.PI/2),Z=0,J=G.length;Z<J;Z++)q=i(G[Z],Q[Z],j),s(q.x,q.y,-W);for(O=0,I=N.length;O<I;O++)for(B=N[O],te=ie[O],Z=0,J=B.length;Z<J;Z++)q=i(B[Z],te[Z],j),s(q.x,q.y,-W)}for(j=E,Z=0;Z<Y;Z++)q=T?i(F[Z],re[Z],j):F[Z],R?(m.copy(p.normals[0]).multiplyScalar(q.x),f.copy(p.binormals[0]).multiplyScalar(q.y),v.copy(d[0]).add(m).add(f),s(v.x,v.y,v.z)):s(q.x,q.y,0);var ne;for(ne=1;ne<=A;ne++)for(Z=0;Z<Y;Z++)q=T?i(F[Z],re[Z],j):F[Z],R?(m.copy(p.normals[ne]).multiplyScalar(q.x),f.copy(p.binormals[ne]).multiplyScalar(q.y),v.copy(d[ne]).add(m).add(f),s(v.x,v.y,v.z)):s(q.x,q.y,w/A*ne);for(z=S-1;z>=0;z--){for(H=z/S,W=M*Math.cos(H*Math.PI/2),j=E*Math.sin(H*Math.PI/2),Z=0,J=G.length;Z<J;Z++)q=i(G[Z],Q[Z],j),s(q.x,q.y,w+W);for(O=0,I=N.length;O<I;O++)for(B=N[O],te=ie[O],Z=0,J=B.length;Z<J;Z++)q=i(B[Z],te[Z],j),R?s(q.x,q.y+d[A-1].y,d[A-1].x+W):s(q.x,q.y,w+W)}n(),o(),t.arrays||(this.setIndex(x),this.addAttribute("position",new Float32BufferAttribute(y,3)),this.addAttribute("uv",new Float32BufferAttribute(t.arrays.uv,2)))},ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(e,t,i,r,n){var o=t[3*i],a=t[3*i+1],s=t[3*r],l=t[3*r+1],c=t[3*n],h=t[3*n+1];return[new Vector2(o,a),new Vector2(s,l),new Vector2(c,h)]},generateSideWallUV:function(e,t,i,r,n,o){var a=t[3*i],s=t[3*i+1],l=t[3*i+2],c=t[3*r],h=t[3*r+1],u=t[3*r+2],d=t[3*n],p=t[3*n+1],f=t[3*n+2],m=t[3*o],v=t[3*o+1],g=t[3*o+2];return Math.abs(s-h)<.01?[new Vector2(a,1-l),new Vector2(c,1-u),new Vector2(d,1-f),new Vector2(m,1-g)]:[new Vector2(s,1-l),new Vector2(h,1-u),new Vector2(p,1-f),new Vector2(v,1-g)]}},TextGeometry.prototype=Object.create(Geometry.prototype),TextGeometry.prototype.constructor=TextGeometry,TextBufferGeometry.prototype=Object.create(ExtrudeBufferGeometry.prototype),TextBufferGeometry.prototype.constructor=TextBufferGeometry,SphereGeometry.prototype=Object.create(Geometry.prototype),SphereGeometry.prototype.constructor=SphereGeometry,SphereBufferGeometry.prototype=Object.create(BufferGeometry.prototype),SphereBufferGeometry.prototype.constructor=SphereBufferGeometry,RingGeometry.prototype=Object.create(Geometry.prototype),RingGeometry.prototype.constructor=RingGeometry,RingBufferGeometry.prototype=Object.create(BufferGeometry.prototype),RingBufferGeometry.prototype.constructor=RingBufferGeometry,LatheGeometry.prototype=Object.create(Geometry.prototype),LatheGeometry.prototype.constructor=LatheGeometry,LatheBufferGeometry.prototype=Object.create(BufferGeometry.prototype),LatheBufferGeometry.prototype.constructor=LatheBufferGeometry,ShapeGeometry.prototype=Object.create(Geometry.prototype),ShapeGeometry.prototype.constructor=ShapeGeometry,ShapeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ShapeBufferGeometry.prototype.constructor=ShapeBufferGeometry,EdgesGeometry.prototype=Object.create(BufferGeometry.prototype),EdgesGeometry.prototype.constructor=EdgesGeometry,CylinderGeometry.prototype=Object.create(Geometry.prototype),CylinderGeometry.prototype.constructor=CylinderGeometry,CylinderBufferGeometry.prototype=Object.create(BufferGeometry.prototype),CylinderBufferGeometry.prototype.constructor=CylinderBufferGeometry,ConeGeometry.prototype=Object.create(CylinderGeometry.prototype),ConeGeometry.prototype.constructor=ConeGeometry,ConeBufferGeometry.prototype=Object.create(CylinderBufferGeometry.prototype),ConeBufferGeometry.prototype.constructor=ConeBufferGeometry,CircleGeometry.prototype=Object.create(Geometry.prototype),CircleGeometry.prototype.constructor=CircleGeometry,CircleBufferGeometry.prototype=Object.create(BufferGeometry.prototype),CircleBufferGeometry.prototype.constructor=CircleBufferGeometry;var Geometries=Object.freeze({WireframeGeometry:WireframeGeometry,ParametricGeometry:ParametricGeometry,ParametricBufferGeometry:ParametricBufferGeometry,TetrahedronGeometry:TetrahedronGeometry,TetrahedronBufferGeometry:TetrahedronBufferGeometry,OctahedronGeometry:OctahedronGeometry,OctahedronBufferGeometry:OctahedronBufferGeometry,IcosahedronGeometry:IcosahedronGeometry,IcosahedronBufferGeometry:IcosahedronBufferGeometry,DodecahedronGeometry:DodecahedronGeometry,DodecahedronBufferGeometry:DodecahedronBufferGeometry,PolyhedronGeometry:PolyhedronGeometry,PolyhedronBufferGeometry:PolyhedronBufferGeometry,TubeGeometry:TubeGeometry,TubeBufferGeometry:TubeBufferGeometry,TorusKnotGeometry:TorusKnotGeometry,TorusKnotBufferGeometry:TorusKnotBufferGeometry,TorusGeometry:TorusGeometry,TorusBufferGeometry:TorusBufferGeometry,TextGeometry:TextGeometry,TextBufferGeometry:TextBufferGeometry,SphereGeometry:SphereGeometry,SphereBufferGeometry:SphereBufferGeometry,RingGeometry:RingGeometry,RingBufferGeometry:RingBufferGeometry,PlaneGeometry:PlaneGeometry,PlaneBufferGeometry:PlaneBufferGeometry,LatheGeometry:LatheGeometry,LatheBufferGeometry:LatheBufferGeometry,ShapeGeometry:ShapeGeometry,ShapeBufferGeometry:ShapeBufferGeometry,ExtrudeGeometry:ExtrudeGeometry,ExtrudeBufferGeometry:ExtrudeBufferGeometry,EdgesGeometry:EdgesGeometry,ConeGeometry:ConeGeometry,ConeBufferGeometry:ConeBufferGeometry,CylinderGeometry:CylinderGeometry,CylinderBufferGeometry:CylinderBufferGeometry,CircleGeometry:CircleGeometry,CircleBufferGeometry:CircleBufferGeometry,BoxGeometry:BoxGeometry,BoxBufferGeometry:BoxBufferGeometry});ShadowMaterial.prototype=Object.create(ShaderMaterial.prototype),ShadowMaterial.prototype.constructor=ShadowMaterial,ShadowMaterial.prototype.isShadowMaterial=!0,RawShaderMaterial.prototype=Object.create(ShaderMaterial.prototype),RawShaderMaterial.prototype.constructor=RawShaderMaterial,RawShaderMaterial.prototype.isRawShaderMaterial=!0,MeshStandardMaterial.prototype=Object.create(Material.prototype),MeshStandardMaterial.prototype.constructor=MeshStandardMaterial,MeshStandardMaterial.prototype.isMeshStandardMaterial=!0,MeshStandardMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},MeshPhysicalMaterial.prototype=Object.create(MeshStandardMaterial.prototype),MeshPhysicalMaterial.prototype.constructor=MeshPhysicalMaterial,MeshPhysicalMaterial.prototype.isMeshPhysicalMaterial=!0,MeshPhysicalMaterial.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},MeshPhongMaterial.prototype=Object.create(Material.prototype),MeshPhongMaterial.prototype.constructor=MeshPhongMaterial,MeshPhongMaterial.prototype.isMeshPhongMaterial=!0,MeshPhongMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},MeshToonMaterial.prototype=Object.create(MeshPhongMaterial.prototype),MeshToonMaterial.prototype.constructor=MeshToonMaterial,MeshToonMaterial.prototype.isMeshToonMaterial=!0,MeshToonMaterial.prototype.copy=function(e){return MeshPhongMaterial.prototype.copy.call(this,e),this.gradientMap=e.gradientMap,this},MeshNormalMaterial.prototype=Object.create(Material.prototype),MeshNormalMaterial.prototype.constructor=MeshNormalMaterial,MeshNormalMaterial.prototype.isMeshNormalMaterial=!0,MeshNormalMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},MeshLambertMaterial.prototype=Object.create(Material.prototype),MeshLambertMaterial.prototype.constructor=MeshLambertMaterial,MeshLambertMaterial.prototype.isMeshLambertMaterial=!0,MeshLambertMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},LineDashedMaterial.prototype=Object.create(Material.prototype),LineDashedMaterial.prototype.constructor=LineDashedMaterial,LineDashedMaterial.prototype.isLineDashedMaterial=!0,LineDashedMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var Materials=Object.freeze({ShadowMaterial:ShadowMaterial,SpriteMaterial:SpriteMaterial,RawShaderMaterial:RawShaderMaterial,ShaderMaterial:ShaderMaterial,PointsMaterial:PointsMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshToonMaterial:MeshToonMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshBasicMaterial:MeshBasicMaterial,LineDashedMaterial:LineDashedMaterial,LineBasicMaterial:LineBasicMaterial,Material:Material}),Cache={enabled:!1,files:{},add:function(e,t){this.enabled!==!1&&(this.files[e]=t)},get:function(e){if(this.enabled!==!1)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},DefaultLoadingManager=new LoadingManager;Object.assign(FileLoader.prototype,{load:function(e,t,i,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var n=this,o=Cache.get(e);if(void 0!==o)return n.manager.itemStart(e),setTimeout(function(){t&&t(o),n.manager.itemEnd(e)},0),o;var a=/^data:(.*?)(;base64)?,(.*)$/,s=e.match(a);if(s){var l=s[1],c=!!s[2],h=s[3];h=window.decodeURIComponent(h),c&&(h=window.atob(h));try{var u,d=(this.responseType||"").toLowerCase();switch(d){case"arraybuffer":case"blob":u=new ArrayBuffer(h.length);for(var p=new Uint8Array(u),f=0;f<h.length;f++)p[f]=h.charCodeAt(f);"blob"===d&&(u=new Blob([u],{type:l}));break;case"document":var m=new DOMParser;u=m.parseFromString(h,l);break;case"json":u=JSON.parse(h);break;default:u=h}window.setTimeout(function(){t&&t(u),n.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){r&&r(t),n.manager.itemEnd(e),n.manager.itemError(e)},0)}}else{var v=new XMLHttpRequest;v.open("GET",e,!0),v.addEventListener("load",function(i){var o=i.target.response;Cache.add(e,o),200===this.status?(t&&t(o),n.manager.itemEnd(e)):0===this.status?(console.warn("THREE.FileLoader: HTTP Status 0 received."),t&&t(o),n.manager.itemEnd(e)):(r&&r(i),n.manager.itemEnd(e),n.manager.itemError(e))},!1),void 0!==i&&v.addEventListener("progress",function(e){i(e)},!1),v.addEventListener("error",function(t){r&&r(t),n.manager.itemEnd(e),n.manager.itemError(e)},!1),void 0!==this.responseType&&(v.responseType=this.responseType),void 0!==this.withCredentials&&(v.withCredentials=this.withCredentials),v.overrideMimeType&&v.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(var g in this.requestHeader)v.setRequestHeader(g,this.requestHeader[g]);v.send(null)}return n.manager.itemStart(e),v},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(CompressedTextureLoader.prototype,{load:function(e,t,i,r){function n(n){l.load(e[n],function(e){var i=o._parser(e,!0);a[n]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},c+=1,6===c&&(1===i.mipmapCount&&(s.minFilter=LinearFilter),s.format=i.format,s.needsUpdate=!0,t&&t(s))},i,r)}var o=this,a=[],s=new CompressedTexture;s.image=a;var l=new FileLoader(this.manager);if(l.setPath(this.path),l.setResponseType("arraybuffer"),Array.isArray(e))for(var c=0,h=0,u=e.length;h<u;++h)n(h);else l.load(e,function(e){var i=o._parser(e,!0);if(i.isCubemap)for(var r=i.mipmaps.length/i.mipmapCount,n=0;n<r;n++){a[n]={mipmaps:[]};for(var l=0;l<i.mipmapCount;l++)a[n].mipmaps.push(i.mipmaps[n*i.mipmapCount+l]),a[n].format=i.format,a[n].width=i.width,a[n].height=i.height}else s.image.width=i.width,s.image.height=i.height,s.mipmaps=i.mipmaps;1===i.mipmapCount&&(s.minFilter=LinearFilter),s.format=i.format,s.needsUpdate=!0,t&&t(s)},i,r);return s},setPath:function(e){return this.path=e,this}}),Object.assign(DataTextureLoader.prototype,{load:function(e,t,i,r){var n=this,o=new DataTexture,a=new FileLoader(this.manager);return a.setResponseType("arraybuffer"),a.load(e,function(e){var i=n._parser(e);i&&(void 0!==i.image?o.image=i.image:void 0!==i.data&&(o.image.width=i.width,o.image.height=i.height,o.image.data=i.data),o.wrapS=void 0!==i.wrapS?i.wrapS:ClampToEdgeWrapping,o.wrapT=void 0!==i.wrapT?i.wrapT:ClampToEdgeWrapping,o.magFilter=void 0!==i.magFilter?i.magFilter:LinearFilter,o.minFilter=void 0!==i.minFilter?i.minFilter:LinearMipMapLinearFilter,o.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.format&&(o.format=i.format),void 0!==i.type&&(o.type=i.type),void 0!==i.mipmaps&&(o.mipmaps=i.mipmaps),1===i.mipmapCount&&(o.minFilter=LinearFilter),o.needsUpdate=!0,t&&t(o,i))},i,r),o}}),Object.assign(ImageLoader.prototype,{load:function(e,t,i,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var n=this,o=Cache.get(e);if(void 0!==o)return n.manager.itemStart(e),setTimeout(function(){t&&t(o),n.manager.itemEnd(e)},0),o;var a=document.createElementNS("http://www.w3.org/1999/xhtml","img");return a.addEventListener("load",function(){Cache.add(e,this),t&&t(this),n.manager.itemEnd(e)},!1),a.addEventListener("error",function(t){r&&r(t),n.manager.itemEnd(e),n.manager.itemError(e)},!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),n.manager.itemStart(e),a.src=e,a},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(CubeTextureLoader.prototype,{load:function(e,t,i,r){function n(i){a.load(e[i],function(e){o.images[i]=e,s++,6===s&&(o.needsUpdate=!0,t&&t(o))},void 0,r)}var o=new CubeTexture,a=new ImageLoader(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);for(var s=0,l=0;l<e.length;++l)n(l);return o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(TextureLoader.prototype,{load:function(e,t,i,r){var n=new ImageLoader(this.manager);n.setCrossOrigin(this.crossOrigin),n.setPath(this.path);var o=new Texture;return o.image=n.load(e,function(){var i=e.search(/\.(jpg|jpeg)$/)>0||0===e.search(/^data\:image\/jpeg/);o.format=i?RGBFormat:RGBAFormat,o.needsUpdate=!0,void 0!==t&&t(o)},i,r),o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Light.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Light,isLight:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),HemisphereLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:HemisphereLight,isHemisphereLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(LightShadow.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),SpotLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:SpotLightShadow,isSpotLightShadow:!0,update:function(e){var t=this.camera,i=2*_Math.RAD2DEG*e.angle,r=this.mapSize.width/this.mapSize.height,n=e.distance||t.far;i===t.fov&&r===t.aspect&&n===t.far||(t.fov=i,t.aspect=r,t.far=n,t.updateProjectionMatrix())}}),SpotLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:SpotLight,isSpotLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),PointLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:PointLight,isPointLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),DirectionalLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:DirectionalLightShadow}),DirectionalLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:DirectionalLight,isDirectionalLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),AmbientLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:AmbientLight,isAmbientLight:!0}),RectAreaLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:RectAreaLight,isRectAreaLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.width=e.width,this.height=e.height,this},toJSON:function(e){var t=Light.prototype.toJSON.call(this,e);return t.object.width=this.width,t.object.height=this.height,t}});var AnimationUtils={arraySlice:function(e,t,i){return AnimationUtils.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==i?i:e.length)):e.slice(t,i)},convertArray:function(e,t,i){return!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){function t(t,i){return e[t]-e[i]}for(var i=e.length,r=new Array(i),n=0;n!==i;++n)r[n]=n;return r.sort(t),r},sortedArray:function(e,t,i){for(var r=e.length,n=new e.constructor(r),o=0,a=0;a!==r;++o)for(var s=i[o]*t,l=0;l!==t;++l)n[a++]=e[s+l];return n},flattenJSON:function(e,t,i,r){for(var n=1,o=e[0];void 0!==o&&void 0===o[r];)o=e[n++];if(void 0!==o){var a=o[r];if(void 0!==a)if(Array.isArray(a)){do a=o[r],void 0!==a&&(t.push(o.time),i.push.apply(i,a)),o=e[n++];while(void 0!==o)}else if(void 0!==a.toArray){do a=o[r],void 0!==a&&(t.push(o.time),a.toArray(i,i.length)),o=e[n++];while(void 0!==o)}else do a=o[r],void 0!==a&&(t.push(o.time),i.push(a)),o=e[n++];while(void 0!==o)}}};Object.assign(Interpolant.prototype,{evaluate:function(e){var t=this.parameterPositions,i=this._cachedIndex,r=t[i],n=t[i-1];e:{t:{var o;i:{r:if(!(e<r)){for(var a=i+2;;){if(void 0===r){if(e<n)break r;return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,e,n)}if(i===a)break;if(n=r,r=t[++i],e<r)break t}o=t.length;break i}if(e>=n)break e;var s=t[1];e<s&&(i=2,n=s);for(var a=i-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(i===a)break;if(r=n,n=t[--i-1],e>=n)break t}o=i,i=0}for(;i<o;){var l=i+o>>>1;e<t[l]?o=l:i=l+1}if(r=t[i],n=t[i-1],void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(void 0===r)return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,n,e)}this._cachedIndex=i,this.intervalChanged_(i,n,r)}return this.interpolate_(i,n,e,r)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,i=this.sampleValues,r=this.valueSize,n=e*r,o=0;o!==r;++o)t[o]=i[n+o];return t},interpolate_:function(e,t,i,r){throw new Error("call to abstract method")},intervalChanged_:function(e,t,i){}}),Object.assign(Interpolant.prototype,{beforeStart_:Interpolant.prototype.copySampleValue_,afterEnd_:Interpolant.prototype.copySampleValue_}),CubicInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:CubicInterpolant,DefaultSettings_:{endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding},intervalChanged_:function(e,t,i){var r=this.parameterPositions,n=e-2,o=e+1,a=r[n],s=r[o];if(void 0===a)switch(this.getSettings_().endingStart){case ZeroSlopeEnding:n=e,a=2*t-i;break;case WrapAroundEnding:n=r.length-2,a=t+r[n]-r[n+1];break;default:n=e,a=i}if(void 0===s)switch(this.getSettings_().endingEnd){case ZeroSlopeEnding:o=e,s=2*i-t;break;case WrapAroundEnding:o=1,s=i+r[1]-r[0];break;default:o=e-1,s=t}var l=.5*(i-t),c=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(s-i),this._offsetPrev=n*c,this._offsetNext=o*c},interpolate_:function(e,t,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,l=s-a,c=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(i-t)/(r-t),f=p*p,m=f*p,v=-u*m+2*u*f-u*p,g=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,x=d*m-d*f,b=0;b!==a;++b)n[b]=v*o[c+b]+g*o[l+b]+y*o[s+b]+x*o[h+b];return n}}),LinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:LinearInterpolant,interpolate_:function(e,t,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,l=s-a,c=(i-t)/(r-t),h=1-c,u=0;u!==a;++u)n[u]=o[l+u]*h+o[s+u]*c;return n}}),DiscreteInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:DiscreteInterpolant,interpolate_:function(e,t,i,r){return this.copySampleValue_(e-1)}});var KeyframeTrackPrototype;KeyframeTrackPrototype={TimeBufferType:Float32Array,ValueBufferType:Float32Array,
DefaultInterpolation:InterpolateLinear,InterpolantFactoryMethodDiscrete:function(e){return new DiscreteInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new LinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new CubicInterpolant(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case InterpolateDiscrete:t=this.InterpolantFactoryMethodDiscrete;break;case InterpolateLinear:t=this.InterpolantFactoryMethodLinear;break;case InterpolateSmooth:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){var i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(i);this.setInterpolation(this.DefaultInterpolation)}return void console.warn(i)}this.createInterpolant=t},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return InterpolateDiscrete;case this.InterpolantFactoryMethodLinear:return InterpolateLinear;case this.InterpolantFactoryMethodSmooth:return InterpolateSmooth}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,i=0,r=t.length;i!==r;++i)t[i]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,i=0,r=t.length;i!==r;++i)t[i]*=e;return this},trim:function(e,t){for(var i=this.times,r=i.length,n=0,o=r-1;n!==r&&i[n]<e;)++n;for(;o!==-1&&i[o]>t;)--o;if(++o,0!==n||o!==r){n>=o&&(o=Math.max(o,1),n=o-1);var a=this.getValueSize();this.times=AnimationUtils.arraySlice(i,n,o),this.values=AnimationUtils.arraySlice(this.values,n*a,o*a)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!==0&&(console.error("invalid value size in track",this),e=!1);var i=this.times,r=this.values,n=i.length;0===n&&(console.error("track is empty",this),e=!1);for(var o=null,a=0;a!==n;a++){var s=i[a];if("number"==typeof s&&isNaN(s)){console.error("time is not a valid number",this,a,s),e=!1;break}if(null!==o&&o>s){console.error("out of order keys",this,a,s,o),e=!1;break}o=s}if(void 0!==r&&AnimationUtils.isTypedArray(r))for(var a=0,l=r.length;a!==l;++a){var c=r[a];if(isNaN(c)){console.error("value is not a valid number",this,a,c),e=!1;break}}return e},optimize:function(){for(var e=this.times,t=this.values,i=this.getValueSize(),r=this.getInterpolation()===InterpolateSmooth,n=1,o=e.length-1,a=1;a<o;++a){var s=!1,l=e[a],c=e[a+1];if(l!==c&&(1!==a||l!==l[0]))if(r)s=!0;else for(var h=a*i,u=h-i,d=h+i,p=0;p!==i;++p){var f=t[h+p];if(f!==t[u+p]||f!==t[d+p]){s=!0;break}}if(s){if(a!==n){e[n]=e[a];for(var m=a*i,v=n*i,p=0;p!==i;++p)t[v+p]=t[m+p]}++n}}if(o>0){e[n]=e[o];for(var m=o*i,v=n*i,p=0;p!==i;++p)t[v+p]=t[m+p];++n}return n!==e.length&&(this.times=AnimationUtils.arraySlice(e,0,n),this.values=AnimationUtils.arraySlice(t,0,n*i)),this}},VectorKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrackPrototype),{constructor:VectorKeyframeTrack,ValueTypeName:"vector"}),QuaternionLinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:QuaternionLinearInterpolant,interpolate_:function(e,t,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,l=(i-t)/(r-t),c=s+a;s!==c;s+=4)Quaternion.slerpFlat(n,0,o,s-a,o,s,l);return n}}),QuaternionKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrackPrototype),{constructor:QuaternionKeyframeTrack,ValueTypeName:"quaternion",DefaultInterpolation:InterpolateLinear,InterpolantFactoryMethodLinear:function(e){return new QuaternionLinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),NumberKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrackPrototype),{constructor:NumberKeyframeTrack,ValueTypeName:"number"}),StringKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrackPrototype),{constructor:StringKeyframeTrack,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:InterpolateDiscrete,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),BooleanKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrackPrototype),{constructor:BooleanKeyframeTrack,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:InterpolateDiscrete,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ColorKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrackPrototype),{constructor:ColorKeyframeTrack,ValueTypeName:"color"}),KeyframeTrack.prototype=KeyframeTrackPrototype,KeyframeTrackPrototype.constructor=KeyframeTrack,Object.assign(KeyframeTrack,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=KeyframeTrack._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var i=[],r=[];AnimationUtils.flattenJSON(e.keys,i,r,"value"),e.times=i,e.values=r}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,i=e.constructor;if(void 0!==i.toJSON)t=i.toJSON(e);else{t={name:e.name,times:AnimationUtils.convertArray(e.times,Array),values:AnimationUtils.convertArray(e.values,Array)};var r=e.getInterpolation();r!==e.DefaultInterpolation&&(t.interpolation=r)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return VectorKeyframeTrack;case"color":return ColorKeyframeTrack;case"quaternion":return QuaternionKeyframeTrack;case"bool":case"boolean":return BooleanKeyframeTrack;case"string":return StringKeyframeTrack}throw new Error("Unsupported typeName: "+e)}}),Object.assign(AnimationClip,{parse:function(e){for(var t=[],i=e.tracks,r=1/(e.fps||1),n=0,o=i.length;n!==o;++n)t.push(KeyframeTrack.parse(i[n]).scale(r));return new AnimationClip(e.name,e.duration,t)},toJSON:function(e){for(var t=[],i=e.tracks,r={name:e.name,duration:e.duration,tracks:t},n=0,o=i.length;n!==o;++n)t.push(KeyframeTrack.toJSON(i[n]));return r},CreateFromMorphTargetSequence:function(e,t,i,r){for(var n=t.length,o=[],a=0;a<n;a++){var s=[],l=[];s.push((a+n-1)%n,a,(a+1)%n),l.push(0,1,0);var c=AnimationUtils.getKeyframeOrder(s);s=AnimationUtils.sortedArray(s,1,c),l=AnimationUtils.sortedArray(l,1,c),r||0!==s[0]||(s.push(n),l.push(l[0])),o.push(new NumberKeyframeTrack(".morphTargetInfluences["+t[a].name+"]",s,l).scale(1/i))}return new AnimationClip(e,-1,o)},findByName:function(e,t){var i=e;if(!Array.isArray(e)){var r=e;i=r.geometry&&r.geometry.animations||r.animations}for(var n=0;n<i.length;n++)if(i[n].name===t)return i[n];return null},CreateClipsFromMorphTargetSequences:function(e,t,i){for(var r={},n=/^([\w-]*?)([\d]+)$/,o=0,a=e.length;o<a;o++){var s=e[o],l=s.name.match(n);if(l&&l.length>1){var c=l[1],h=r[c];h||(r[c]=h=[]),h.push(s)}}var u=[];for(var c in r)u.push(AnimationClip.CreateFromMorphTargetSequence(c,r[c],t,i));return u},parseAnimation:function(e,t){if(!e)return console.error("  no animation in JSONLoader data"),null;for(var i=function(e,t,i,r,n){if(0!==i.length){var o=[],a=[];AnimationUtils.flattenJSON(i,o,a,r),0!==o.length&&n.push(new e(t,o,a))}},r=[],n=e.name||"default",o=e.length||-1,a=e.fps||30,s=e.hierarchy||[],l=0;l<s.length;l++){var c=s[l].keys;if(c&&0!==c.length)if(c[0].morphTargets){for(var h={},u=0;u<c.length;u++)if(c[u].morphTargets)for(var d=0;d<c[u].morphTargets.length;d++)h[c[u].morphTargets[d]]=-1;for(var p in h){for(var f=[],m=[],d=0;d!==c[u].morphTargets.length;++d){var v=c[u];f.push(v.time),m.push(v.morphTarget===p?1:0)}r.push(new NumberKeyframeTrack(".morphTargetInfluence["+p+"]",f,m))}o=h.length*(a||1)}else{var g=".bones["+t[l].name+"]";i(VectorKeyframeTrack,g+".position",c,"pos",r),i(QuaternionKeyframeTrack,g+".quaternion",c,"rot",r),i(VectorKeyframeTrack,g+".scale",c,"scl",r)}}if(0===r.length)return null;var y=new AnimationClip(n,o,r);return y}}),Object.assign(AnimationClip.prototype,{resetDuration:function(){for(var e=this.tracks,t=0,i=0,r=e.length;i!==r;++i){var n=this.tracks[i];t=Math.max(t,n.times[n.times.length-1])}this.duration=t},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}}),Object.assign(MaterialLoader.prototype,{load:function(e,t,i,r){var n=this,o=new FileLoader(n.manager);o.setResponseType("json"),o.load(e,function(e){t(n.parse(e))},i,r)},setTextures:function(e){this.textures=e},parse:function(e){function t(e){return void 0===i[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),i[e]}var i=this.textures,r=new Materials[e.type];if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&r.specular.setHex(e.specular),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.clearCoat&&(r.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(r.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.uniforms&&(r.uniforms=e.uniforms),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(r.vertexColors=e.vertexColors),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.shading&&(r.shading=e.shading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.side&&(r.side=e.side),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.skinning&&(r.skinning=e.skinning),void 0!==e.morphTargets&&(r.morphTargets=e.morphTargets),void 0!==e.size&&(r.size=e.size),void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(r.map=t(e.map)),void 0!==e.alphaMap&&(r.alphaMap=t(e.alphaMap),r.transparent=!0),void 0!==e.bumpMap&&(r.bumpMap=t(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=t(e.normalMap)),void 0!==e.normalScale){var n=e.normalScale;Array.isArray(n)===!1&&(n=[n,n]),r.normalScale=(new Vector2).fromArray(n)}return void 0!==e.displacementMap&&(r.displacementMap=t(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=t(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=t(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=t(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=t(e.specularMap)),void 0!==e.envMap&&(r.envMap=t(e.envMap)),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.lightMap&&(r.lightMap=t(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=t(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(r.gradientMap=t(e.gradientMap)),r}}),Object.assign(BufferGeometryLoader.prototype,{load:function(e,t,i,r){var n=this,o=new FileLoader(n.manager);o.setResponseType("json"),o.load(e,function(e){t(n.parse(e))},i,r)},parse:function(e){var t=new BufferGeometry,i=e.data.index;if(void 0!==i){var r=new TYPED_ARRAYS[i.type](i.array);t.setIndex(new BufferAttribute(r,1))}var n=e.data.attributes;for(var o in n){var a=n[o],r=new TYPED_ARRAYS[a.type](a.array);t.addAttribute(o,new BufferAttribute(r,a.itemSize,a.normalized))}var s=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==s)for(var l=0,c=s.length;l!==c;++l){var h=s[l];t.addGroup(h.start,h.count,h.materialIndex)}var u=e.data.boundingSphere;if(void 0!==u){var d=new Vector3;void 0!==u.center&&d.fromArray(u.center),t.boundingSphere=new Sphere(d,u.radius)}return t}});var TYPED_ARRAYS={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};Loader.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,i=0,r=t.length;i<r;i+=2){var n=t[i],o=t[i+1];if(n.test(e))return o}return null}},Object.assign(Loader.prototype,{crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,i){for(var r=[],n=0;n<e.length;++n)r[n]=this.createMaterial(e[n],t,i);return r},createMaterial:function(){var e={NoBlending:NoBlending,NormalBlending:NormalBlending,AdditiveBlending:AdditiveBlending,SubtractiveBlending:SubtractiveBlending,MultiplyBlending:MultiplyBlending,CustomBlending:CustomBlending},t=new Color,i=new TextureLoader,r=new MaterialLoader;return function(n,o,a){function s(e,t,r,n,s){var c,h=o+e,u=Loader.Handlers.get(h);null!==u?c=u.load(h):(i.setCrossOrigin(a),c=i.load(h)),void 0!==t&&(c.repeat.fromArray(t),1!==t[0]&&(c.wrapS=RepeatWrapping),1!==t[1]&&(c.wrapT=RepeatWrapping)),void 0!==r&&c.offset.fromArray(r),void 0!==n&&("repeat"===n[0]&&(c.wrapS=RepeatWrapping),"mirror"===n[0]&&(c.wrapS=MirroredRepeatWrapping),"repeat"===n[1]&&(c.wrapT=RepeatWrapping),"mirror"===n[1]&&(c.wrapT=MirroredRepeatWrapping)),void 0!==s&&(c.anisotropy=s);var d=_Math.generateUUID();return l[d]=c,d}var l={},c={uuid:_Math.generateUUID(),type:"MeshLambertMaterial"};for(var h in n){var u=n[h];switch(h){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":c.name=u;break;case"blending":c.blending=e[u];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",h,"is no longer supported.");break;case"colorDiffuse":c.color=t.fromArray(u).getHex();break;case"colorSpecular":c.specular=t.fromArray(u).getHex();break;case"colorEmissive":c.emissive=t.fromArray(u).getHex();break;case"specularCoef":c.shininess=u;break;case"shading":"basic"===u.toLowerCase()&&(c.type="MeshBasicMaterial"),"phong"===u.toLowerCase()&&(c.type="MeshPhongMaterial"),"standard"===u.toLowerCase()&&(c.type="MeshStandardMaterial");break;case"mapDiffuse":c.map=s(u,n.mapDiffuseRepeat,n.mapDiffuseOffset,n.mapDiffuseWrap,n.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":c.emissiveMap=s(u,n.mapEmissiveRepeat,n.mapEmissiveOffset,n.mapEmissiveWrap,n.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":c.lightMap=s(u,n.mapLightRepeat,n.mapLightOffset,n.mapLightWrap,n.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":c.aoMap=s(u,n.mapAORepeat,n.mapAOOffset,n.mapAOWrap,n.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":c.bumpMap=s(u,n.mapBumpRepeat,n.mapBumpOffset,n.mapBumpWrap,n.mapBumpAnisotropy);break;case"mapBumpScale":c.bumpScale=u;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":c.normalMap=s(u,n.mapNormalRepeat,n.mapNormalOffset,n.mapNormalWrap,n.mapNormalAnisotropy);break;case"mapNormalFactor":c.normalScale=[u,u];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":c.specularMap=s(u,n.mapSpecularRepeat,n.mapSpecularOffset,n.mapSpecularWrap,n.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":c.metalnessMap=s(u,n.mapMetalnessRepeat,n.mapMetalnessOffset,n.mapMetalnessWrap,n.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":c.roughnessMap=s(u,n.mapRoughnessRepeat,n.mapRoughnessOffset,n.mapRoughnessWrap,n.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":c.alphaMap=s(u,n.mapAlphaRepeat,n.mapAlphaOffset,n.mapAlphaWrap,n.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":c.side=BackSide;break;case"doubleSided":c.side=DoubleSide;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),c.opacity=u;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":c[h]=u;break;case"vertexColors":u===!0&&(c.vertexColors=VertexColors),"face"===u&&(c.vertexColors=FaceColors);break;default:console.error("THREE.Loader.createMaterial: Unsupported",h,u)}}return"MeshBasicMaterial"===c.type&&delete c.emissive,"MeshPhongMaterial"!==c.type&&delete c.specular,c.opacity<1&&(c.transparent=!0),r.setTextures(l),r.parse(c)}}()}),Object.assign(JSONLoader.prototype,{load:function(e,t,i,r){var n=this,o=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:Loader.prototype.extractUrlBase(e),a=new FileLoader(this.manager);a.setResponseType("json"),a.setWithCredentials(this.withCredentials),a.load(e,function(i){var r=i.metadata;if(void 0!==r){var a=r.type;if(void 0!==a){if("object"===a.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===a.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}}var s=n.parse(i,o);t(s.geometry,s.materials)},i,r)},setTexturePath:function(e){this.texturePath=e},parse:function(){function e(e,t){function i(e,t){return e&1<<t}var r,n,o,a,s,l,c,h,u,d,p,f,m,v,g,y,x,b,_,w,M,E,S,T,C,A,P,R=e.faces,L=e.vertices,B=e.normals,O=e.colors,I=e.scale,D=0;if(void 0!==e.uvs){for(r=0;r<e.uvs.length;r++)e.uvs[r].length&&D++;for(r=0;r<D;r++)t.faceVertexUvs[r]=[]}for(a=0,s=L.length;a<s;)b=new Vector3,b.x=L[a++]*I,b.y=L[a++]*I,b.z=L[a++]*I,t.vertices.push(b);for(a=0,s=R.length;a<s;)if(d=R[a++],p=i(d,0),f=i(d,1),m=i(d,3),v=i(d,4),g=i(d,5),y=i(d,6),x=i(d,7),p){if(w=new Face3,w.a=R[a],w.b=R[a+1],w.c=R[a+3],M=new Face3,M.a=R[a+1],M.b=R[a+2],M.c=R[a+3],a+=4,f&&(u=R[a++],w.materialIndex=u,M.materialIndex=u),o=t.faces.length,m)for(r=0;r<D;r++)for(T=e.uvs[r],t.faceVertexUvs[r][o]=[],t.faceVertexUvs[r][o+1]=[],n=0;n<4;n++)h=R[a++],A=T[2*h],P=T[2*h+1],C=new Vector2(A,P),2!==n&&t.faceVertexUvs[r][o].push(C),0!==n&&t.faceVertexUvs[r][o+1].push(C);if(v&&(c=3*R[a++],w.normal.set(B[c++],B[c++],B[c]),M.normal.copy(w.normal)),g)for(r=0;r<4;r++)c=3*R[a++],S=new Vector3(B[c++],B[c++],B[c]),2!==r&&w.vertexNormals.push(S),0!==r&&M.vertexNormals.push(S);if(y&&(l=R[a++],E=O[l],w.color.setHex(E),M.color.setHex(E)),x)for(r=0;r<4;r++)l=R[a++],E=O[l],2!==r&&w.vertexColors.push(new Color(E)),0!==r&&M.vertexColors.push(new Color(E));t.faces.push(w),t.faces.push(M)}else{if(_=new Face3,_.a=R[a++],_.b=R[a++],_.c=R[a++],f&&(u=R[a++],_.materialIndex=u),o=t.faces.length,m)for(r=0;r<D;r++)for(T=e.uvs[r],t.faceVertexUvs[r][o]=[],n=0;n<3;n++)h=R[a++],A=T[2*h],P=T[2*h+1],C=new Vector2(A,P),t.faceVertexUvs[r][o].push(C);if(v&&(c=3*R[a++],_.normal.set(B[c++],B[c++],B[c])),g)for(r=0;r<3;r++)c=3*R[a++],S=new Vector3(B[c++],B[c++],B[c]),_.vertexNormals.push(S);if(y&&(l=R[a++],_.color.setHex(O[l])),x)for(r=0;r<3;r++)l=R[a++],_.vertexColors.push(new Color(O[l]));t.faces.push(_)}}function t(e,t){var i=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var r=0,n=e.skinWeights.length;r<n;r+=i){var o=e.skinWeights[r],a=i>1?e.skinWeights[r+1]:0,s=i>2?e.skinWeights[r+2]:0,l=i>3?e.skinWeights[r+3]:0;t.skinWeights.push(new Vector4(o,a,s,l))}if(e.skinIndices)for(var r=0,n=e.skinIndices.length;r<n;r+=i){var c=e.skinIndices[r],h=i>1?e.skinIndices[r+1]:0,u=i>2?e.skinIndices[r+2]:0,d=i>3?e.skinIndices[r+3]:0;t.skinIndices.push(new Vector4(c,h,u,d))}t.bones=e.bones,t.bones&&t.bones.length>0&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}function i(e,t){var i=e.scale;if(void 0!==e.morphTargets)for(var r=0,n=e.morphTargets.length;r<n;r++){t.morphTargets[r]={},t.morphTargets[r].name=e.morphTargets[r].name,t.morphTargets[r].vertices=[];for(var o=t.morphTargets[r].vertices,a=e.morphTargets[r].vertices,s=0,l=a.length;s<l;s+=3){var c=new Vector3;c.x=a[s]*i,c.y=a[s+1]*i,c.z=a[s+2]*i,o.push(c)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');for(var h=t.faces,u=e.morphColors[0].colors,r=0,n=h.length;r<n;r++)h[r].color.fromArray(u,3*r)}}function r(e,t){var i=[],r=[];void 0!==e.animation&&r.push(e.animation),void 0!==e.animations&&(e.animations.length?r=r.concat(e.animations):r.push(e.animations));for(var n=0;n<r.length;n++){var o=AnimationClip.parseAnimation(r[n],t.bones);o&&i.push(o)}if(t.morphTargets){var a=AnimationClip.CreateClipsFromMorphTargetSequences(t.morphTargets,10);i=i.concat(a)}i.length>0&&(t.animations=i)}return function(n,o){void 0!==n.data&&(n=n.data),void 0!==n.scale?n.scale=1/n.scale:n.scale=1;var a=new Geometry;if(e(n,a),t(n,a),i(n,a),r(n,a),a.computeFaceNormals(),a.computeBoundingSphere(),void 0===n.materials||0===n.materials.length)return{geometry:a};var s=Loader.prototype.initMaterials(n.materials,o,this.crossOrigin);return{geometry:a,materials:s}}}()}),Object.assign(ObjectLoader.prototype,{load:function(e,t,i,r){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var n=this,o=new FileLoader(n.manager);o.load(e,function(i){var o=null;try{o=JSON.parse(i)}catch(t){return void 0!==r&&r(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var a=o.metadata;return void 0===a||void 0===a.type||"geometry"===a.type.toLowerCase()?void console.error("THREE.ObjectLoader: Can't load "+e+". Use THREE.JSONLoader instead."):void n.parse(o,t)},i,r)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var i=this.parseGeometries(e.geometries),r=this.parseImages(e.images,function(){void 0!==t&&t(a)}),n=this.parseTextures(e.textures,r),o=this.parseMaterials(e.materials,n),a=this.parseObject(e.object,i,o);return e.animations&&(a.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(a),a},parseGeometries:function(e){var t={};if(void 0!==e)for(var i=new JSONLoader,r=new BufferGeometryLoader,n=0,o=e.length;n<o;n++){var a,s=e[n];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new Geometries[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":a=new Geometries[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":a=new Geometries[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":a=new Geometries[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":a=new Geometries[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":a=new Geometries[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"IcosahedronGeometry":case"OctahedronGeometry":case"TetrahedronGeometry":a=new Geometries[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":a=new Geometries[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":a=new Geometries[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":a=new Geometries[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":a=new Geometries[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"BufferGeometry":a=r.parse(s);break;case"Geometry":a=i.parse(s,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t},parseMaterials:function(e,t){var i={};if(void 0!==e){var r=new MaterialLoader;r.setTextures(t);for(var n=0,o=e.length;n<o;n++){var a=e[n];if("MultiMaterial"===a.type){for(var s=[],l=0;l<a.materials.length;l++)s.push(r.parse(a.materials[l]));i[a.uuid]=s}else i[a.uuid]=r.parse(a)}}return i},parseAnimations:function(e){for(var t=[],i=0;i<e.length;i++){var r=AnimationClip.parse(e[i]);t.push(r)}return t},parseImages:function(e,t){function i(e){return r.manager.itemStart(e),a.load(e,function(){r.manager.itemEnd(e)},void 0,function(){r.manager.itemEnd(e),r.manager.itemError(e)})}var r=this,n={};if(void 0!==e&&e.length>0){var o=new LoadingManager(t),a=new ImageLoader(o);a.setCrossOrigin(this.crossOrigin);for(var s=0,l=e.length;s<l;s++){var c=e[s],h=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(c.url)?c.url:r.texturePath+c.url;n[c.uuid]=i(h)}}return n},parseTextures:function(e,t){function i(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var n=0,o=e.length;n<o;n++){var a=e[n];void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===t[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);var s=new Texture(t[a.image]);s.needsUpdate=!0,s.uuid=a.uuid,void 0!==a.name&&(s.name=a.name),void 0!==a.mapping&&(s.mapping=i(a.mapping,TEXTURE_MAPPING)),void 0!==a.offset&&s.offset.fromArray(a.offset),void 0!==a.repeat&&s.repeat.fromArray(a.repeat),void 0!==a.wrap&&(s.wrapS=i(a.wrap[0],TEXTURE_WRAPPING),s.wrapT=i(a.wrap[1],TEXTURE_WRAPPING)),void 0!==a.minFilter&&(s.minFilter=i(a.minFilter,TEXTURE_FILTER)),void 0!==a.magFilter&&(s.magFilter=i(a.magFilter,TEXTURE_FILTER)),void 0!==a.anisotropy&&(s.anisotropy=a.anisotropy),void 0!==a.flipY&&(s.flipY=a.flipY),r[a.uuid]=s}return r},parseObject:function(){var e=new Matrix4;return function(t,i,r){function n(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function o(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===r[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(r[o])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}var a;switch(t.type){case"Scene":a=new Scene,void 0!==t.background&&Number.isInteger(t.background)&&(a.background=new Color(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?a.fog=new Fog(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(a.fog=new FogExp2(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":a=new PerspectiveCamera(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(a.focus=t.focus),void 0!==t.zoom&&(a.zoom=t.zoom),void 0!==t.filmGauge&&(a.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(a.filmOffset=t.filmOffset),void 0!==t.view&&(a.view=Object.assign({},t.view));break;case"OrthographicCamera":a=new OrthographicCamera(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":a=new AmbientLight(t.color,t.intensity);break;case"DirectionalLight":a=new DirectionalLight(t.color,t.intensity);break;case"PointLight":a=new PointLight(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":a=new RectAreaLight(t.color,t.intensity,t.width,t.height);break;case"SpotLight":a=new SpotLight(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":a=new HemisphereLight(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var s=n(t.geometry),l=o(t.material);a=s.bones&&s.bones.length>0?new SkinnedMesh(s,l):new Mesh(s,l);break;case"LOD":a=new LOD;break;case"Line":a=new Line(n(t.geometry),o(t.material),t.mode);break;case"LineLoop":a=new LineLoop(n(t.geometry),o(t.material));break;case"LineSegments":a=new LineSegments(n(t.geometry),o(t.material));break;case"PointCloud":case"Points":a=new Points(n(t.geometry),o(t.material));break;case"Sprite":a=new Sprite(o(t.material));break;case"Group":a=new Group;break;default:a=new Object3D}if(a.uuid=t.uuid,void 0!==t.name&&(a.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(a.position,a.quaternion,a.scale)):(void 0!==t.position&&a.position.fromArray(t.position),void 0!==t.rotation&&a.rotation.fromArray(t.rotation),void 0!==t.quaternion&&a.quaternion.fromArray(t.quaternion),void 0!==t.scale&&a.scale.fromArray(t.scale)),void 0!==t.castShadow&&(a.castShadow=t.castShadow),void 0!==t.receiveShadow&&(a.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(a.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(a.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&a.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(a.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(a.visible=t.visible),void 0!==t.userData&&(a.userData=t.userData),void 0!==t.children)for(var c in t.children)a.add(this.parseObject(t.children[c],i,r));if("LOD"===t.type)for(var h=t.levels,u=0;u<h.length;u++){var d=h[u],c=a.getObjectByProperty("uuid",d.object);void 0!==c&&a.addLevel(c,d.distance)}return a}}()});var TEXTURE_MAPPING={UVMapping:UVMapping,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,SphericalReflectionMapping:SphericalReflectionMapping,CubeUVReflectionMapping:CubeUVReflectionMapping,CubeUVRefractionMapping:CubeUVRefractionMapping},TEXTURE_WRAPPING={RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MirroredRepeatWrapping:MirroredRepeatWrapping},TEXTURE_FILTER={NearestFilter:NearestFilter,NearestMipMapNearestFilter:NearestMipMapNearestFilter,NearestMipMapLinearFilter:NearestMipMapLinearFilter,LinearFilter:LinearFilter,LinearMipMapNearestFilter:LinearMipMapNearestFilter,LinearMipMapLinearFilter:LinearMipMapLinearFilter};Object.assign(Curve.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;
this.needsUpdate=!1;var t,i,r=[],n=this.getPoint(0),o=0;for(r.push(0),i=1;i<=e;i++)t=this.getPoint(i/e),o+=t.distanceTo(n),r.push(o),n=t;return this.cacheArcLengths=r,r},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var i,r=this.getLengths(),n=0,o=r.length;i=t?t:e*r[o-1];for(var a,s=0,l=o-1;s<=l;)if(n=Math.floor(s+(l-s)/2),a=r[n]-i,a<0)s=n+1;else{if(!(a>0)){l=n;break}l=n-1}if(n=l,r[n]===i)return n/(o-1);var c=r[n],h=r[n+1],u=h-c,d=(i-c)/u,p=(n+d)/(o-1);return p},getTangent:function(e){var t=1e-4,i=e-t,r=e+t;i<0&&(i=0),r>1&&(r=1);var n=this.getPoint(i),o=this.getPoint(r),a=o.clone().sub(n);return a.normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var i,r,n,o=new Vector3,a=[],s=[],l=[],c=new Vector3,h=new Matrix4;for(i=0;i<=e;i++)r=i/e,a[i]=this.getTangentAt(r),a[i].normalize();s[0]=new Vector3,l[0]=new Vector3;var u=Number.MAX_VALUE,d=Math.abs(a[0].x),p=Math.abs(a[0].y),f=Math.abs(a[0].z);for(d<=u&&(u=d,o.set(1,0,0)),p<=u&&(u=p,o.set(0,1,0)),f<=u&&o.set(0,0,1),c.crossVectors(a[0],o).normalize(),s[0].crossVectors(a[0],c),l[0].crossVectors(a[0],s[0]),i=1;i<=e;i++)s[i]=s[i-1].clone(),l[i]=l[i-1].clone(),c.crossVectors(a[i-1],a[i]),c.length()>Number.EPSILON&&(c.normalize(),n=Math.acos(_Math.clamp(a[i-1].dot(a[i]),-1,1)),s[i].applyMatrix4(h.makeRotationAxis(c,n))),l[i].crossVectors(a[i],s[i]);if(t===!0)for(n=Math.acos(_Math.clamp(s[0].dot(s[e]),-1,1)),n/=e,a[0].dot(c.crossVectors(s[0],s[e]))>0&&(n=-n),i=1;i<=e;i++)s[i].applyMatrix4(h.makeRotationAxis(a[i],n*i)),l[i].crossVectors(a[i],s[i]);return{tangents:a,normals:s,binormals:l}}}),LineCurve.prototype=Object.create(Curve.prototype),LineCurve.prototype.constructor=LineCurve,LineCurve.prototype.isLineCurve=!0,LineCurve.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},LineCurve.prototype.getTangent=function(e){var t=this.v2.clone().sub(this.v1);return t.normalize()},CurvePath.prototype=Object.assign(Object.create(Curve.prototype),{constructor:CurvePath,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new LineCurve(t,e))},getPoint:function(e){for(var t=e*this.getLength(),i=this.getCurveLengths(),r=0;r<i.length;){if(i[r]>=t){var n=i[r]-t,o=this.curves[r],a=o.getLength(),s=0===a?0:1-n/a;return o.getPointAt(s)}r++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,i=0,r=this.curves.length;i<r;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,i=[],r=0,n=this.curves;r<n.length;r++)for(var o=n[r],a=o&&o.isEllipseCurve?2*e:o&&o.isLineCurve?1:o&&o.isSplineCurve?e*o.points.length:e,s=o.getPoints(a),l=0;l<s.length;l++){var c=s[l];t&&t.equals(c)||(i.push(c),t=c)}return this.autoClose&&i.length>1&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i},createPointsGeometry:function(e){var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){for(var t=new Geometry,i=0,r=e.length;i<r;i++){var n=e[i];t.vertices.push(new Vector3(n.x,n.y,n.z||0))}return t}}),EllipseCurve.prototype=Object.create(Curve.prototype),EllipseCurve.prototype.constructor=EllipseCurve,EllipseCurve.prototype.isEllipseCurve=!0,EllipseCurve.prototype.getPoint=function(e){for(var t=2*Math.PI,i=this.aEndAngle-this.aStartAngle,r=Math.abs(i)<Number.EPSILON;i<0;)i+=t;for(;i>t;)i-=t;i<Number.EPSILON&&(i=r?0:t),this.aClockwise!==!0||r||(i===t?i=-t:i-=t);var n=this.aStartAngle+e*i,o=this.aX+this.xRadius*Math.cos(n),a=this.aY+this.yRadius*Math.sin(n);if(0!==this.aRotation){var s=Math.cos(this.aRotation),l=Math.sin(this.aRotation),c=o-this.aX,h=a-this.aY;o=c*s-h*l+this.aX,a=c*l+h*s+this.aY}return new Vector2(o,a)},SplineCurve.prototype=Object.create(Curve.prototype),SplineCurve.prototype.constructor=SplineCurve,SplineCurve.prototype.isSplineCurve=!0,SplineCurve.prototype.getPoint=function(e){var t=this.points,i=(t.length-1)*e,r=Math.floor(i),n=i-r,o=t[0===r?r:r-1],a=t[r],s=t[r>t.length-2?t.length-1:r+1],l=t[r>t.length-3?t.length-1:r+2];return new Vector2(CatmullRom(n,o.x,a.x,s.x,l.x),CatmullRom(n,o.y,a.y,s.y,l.y))},CubicBezierCurve.prototype=Object.create(Curve.prototype),CubicBezierCurve.prototype.constructor=CubicBezierCurve,CubicBezierCurve.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2,n=this.v3;return new Vector2(CubicBezier(e,t.x,i.x,r.x,n.x),CubicBezier(e,t.y,i.y,r.y,n.y))},QuadraticBezierCurve.prototype=Object.create(Curve.prototype),QuadraticBezierCurve.prototype.constructor=QuadraticBezierCurve,QuadraticBezierCurve.prototype.getPoint=function(e){var t=this.v0,i=this.v1,r=this.v2;return new Vector2(QuadraticBezier(e,t.x,i.x,r.x),QuadraticBezier(e,t.y,i.y,r.y))};var PathPrototype=Object.assign(Object.create(CurvePath.prototype),{fromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var i=new LineCurve(this.currentPoint.clone(),new Vector2(e,t));this.curves.push(i),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,i,r){var n=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(i,r));this.curves.push(n),this.currentPoint.set(i,r)},bezierCurveTo:function(e,t,i,r,n,o){var a=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(i,r),new Vector2(n,o));this.curves.push(a),this.currentPoint.set(n,o)},splineThru:function(e){var t=[this.currentPoint.clone()].concat(e),i=new SplineCurve(t);this.curves.push(i),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,i,r,n,o){var a=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+a,t+s,i,r,n,o)},absarc:function(e,t,i,r,n,o){this.absellipse(e,t,i,i,r,n,o)},ellipse:function(e,t,i,r,n,o,a,s){var l=this.currentPoint.x,c=this.currentPoint.y;this.absellipse(e+l,t+c,i,r,n,o,a,s)},absellipse:function(e,t,i,r,n,o,a,s){var l=new EllipseCurve(e,t,i,r,n,o,a,s);if(this.curves.length>0){var c=l.getPoint(0);c.equals(this.currentPoint)||this.lineTo(c.x,c.y)}this.curves.push(l);var h=l.getPoint(1);this.currentPoint.copy(h)}});Path.prototype=PathPrototype,PathPrototype.constructor=Path,Shape.prototype=Object.assign(Object.create(PathPrototype),{constructor:Shape,getPointsHoles:function(e){for(var t=[],i=0,r=this.holes.length;i<r;i++)t[i]=this.holes[i].getPoints(e);return t},extractAllPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},extractPoints:function(e){return this.extractAllPoints(e)}}),Object.assign(ShapePath.prototype,{moveTo:function(e,t){this.currentPath=new Path,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,i,r){this.currentPath.quadraticCurveTo(e,t,i,r)},bezierCurveTo:function(e,t,i,r,n,o){this.currentPath.bezierCurveTo(e,t,i,r,n,o)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function i(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e[i],o=new Shape;o.curves=n.curves,t.push(o)}return t}function r(e,t){for(var i=t.length,r=!1,n=i-1,o=0;o<i;n=o++){var a=t[n],s=t[o],l=s.x-a.x,c=s.y-a.y;if(Math.abs(c)>Number.EPSILON){if(c<0&&(a=t[o],l=-l,s=t[n],c=-c),e.y<a.y||e.y>s.y)continue;if(e.y===a.y){if(e.x===a.x)return!0}else{var h=c*(e.x-a.x)-l*(e.y-a.y);if(0===h)return!0;if(h<0)continue;r=!r}}else{if(e.y!==a.y)continue;if(s.x<=e.x&&e.x<=a.x||a.x<=e.x&&e.x<=s.x)return!0}}return r}var n=ShapeUtils.isClockWise,o=this.subPaths;if(0===o.length)return[];if(t===!0)return i(o);var a,s,l,c=[];if(1===o.length)return s=o[0],l=new Shape,l.curves=s.curves,c.push(l),c;var h=!n(o[0].getPoints());h=e?!h:h;var u,d=[],p=[],f=[],m=0;p[m]=void 0,f[m]=[];for(var v=0,g=o.length;v<g;v++)s=o[v],u=s.getPoints(),a=n(u),a=e?!a:a,a?(!h&&p[m]&&m++,p[m]={s:new Shape,p:u},p[m].s.curves=s.curves,h&&m++,f[m]=[]):f[m].push({h:s,p:u[0]});if(!p[0])return i(o);if(p.length>1){for(var y=!1,x=[],b=0,_=p.length;b<_;b++)d[b]=[];for(var b=0,_=p.length;b<_;b++)for(var w=f[b],M=0;M<w.length;M++){for(var E=w[M],S=!0,T=0;T<p.length;T++)r(E.p,p[T].p)&&(b!==T&&x.push({froms:b,tos:T,hole:M}),S?(S=!1,d[T].push(E)):y=!0);S&&d[b].push(E)}x.length>0&&(y||(f=d))}for(var C,v=0,A=p.length;v<A;v++){l=p[v].s,c.push(l),C=f[v];for(var P=0,R=C.length;P<R;P++)l.holes.push(C[P].h)}return c}}),Object.assign(Font.prototype,{isFont:!0,generateShapes:function(e,t,i){function r(e){for(var i=String(e).split(""),r=t/o.resolution,a=(o.boundingBox.yMax-o.boundingBox.yMin+o.underlineThickness)*r,s=0,l=0,c=[],h=0;h<i.length;h++){var u=i[h];if("\n"===u)s=0,l-=a;else{var d=n(u,r,s,l);s+=d.offsetX,c.push(d.path)}}return c}function n(e,t,r,n){var a=o.glyphs[e]||o.glyphs["?"];if(a){var s,l,c,h,u,d,p,f,m,v,g,y=new ShapePath,x=[];if(a.o)for(var b=a._cachedOutline||(a._cachedOutline=a.o.split(" ")),_=0,w=b.length;_<w;){var M=b[_++];switch(M){case"m":s=b[_++]*t+r,l=b[_++]*t+n,y.moveTo(s,l);break;case"l":s=b[_++]*t+r,l=b[_++]*t+n,y.lineTo(s,l);break;case"q":if(c=b[_++]*t+r,h=b[_++]*t+n,p=b[_++]*t+r,f=b[_++]*t+n,y.quadraticCurveTo(p,f,c,h),g=x[x.length-1]){u=g.x,d=g.y;for(var E=1;E<=i;E++){var S=E/i;QuadraticBezier(S,u,p,c),QuadraticBezier(S,d,f,h)}}break;case"b":if(c=b[_++]*t+r,h=b[_++]*t+n,p=b[_++]*t+r,f=b[_++]*t+n,m=b[_++]*t+r,v=b[_++]*t+n,y.bezierCurveTo(p,f,m,v,c,h),g=x[x.length-1]){u=g.x,d=g.y;for(var E=1;E<=i;E++){var S=E/i;CubicBezier(S,u,p,m,c),CubicBezier(S,d,f,v,h)}}}}return{offsetX:a.ha*t,path:y}}}void 0===t&&(t=100),void 0===i&&(i=4);for(var o=this.data,a=r(e),s=[],l=0,c=a.length;l<c;l++)Array.prototype.push.apply(s,a[l].toShapes());return s}}),Object.assign(FontLoader.prototype,{load:function(e,t,i,r){var n=this,o=new FileLoader(this.manager);o.load(e,function(e){var i;try{i=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(e.substring(65,e.length-2))}var r=n.parse(i);t&&t(r)},i,r)},parse:function(e){return new Font(e)}});var context,AudioContext$1={getContext:function(){return void 0===context&&(context=new(window.AudioContext||window.webkitAudioContext)),context},setContext:function(e){context=e}};Object.assign(AudioLoader.prototype,{load:function(e,t,i,r){var n=new FileLoader(this.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){var i=AudioContext$1.getContext();i.decodeAudioData(e,function(e){t(e)})},i,r)}}),Object.assign(StereoCamera.prototype,{update:function(){var e,t,i,r,n,o,a,s,l=new Matrix4,c=new Matrix4;return function(h){var u=e!==this||t!==h.focus||i!==h.fov||r!==h.aspect*this.aspect||n!==h.near||o!==h.far||a!==h.zoom||s!==this.eyeSep;if(u){e=this,t=h.focus,i=h.fov,r=h.aspect*this.aspect,n=h.near,o=h.far,a=h.zoom;var d=h.projectionMatrix.clone();s=this.eyeSep/2;var p,f,m=s*n/t,v=n*Math.tan(_Math.DEG2RAD*i*.5)/a;c.elements[12]=-s,l.elements[12]=s,p=-v*r+m,f=v*r+m,d.elements[0]=2*n/(f-p),d.elements[8]=(f+p)/(f-p),this.cameraL.projectionMatrix.copy(d),p=-v*r-m,f=v*r-m,d.elements[0]=2*n/(f-p),d.elements[8]=(f+p)/(f-p),this.cameraR.projectionMatrix.copy(d)}this.cameraL.matrixWorld.copy(h.matrixWorld).multiply(c),this.cameraR.matrixWorld.copy(h.matrixWorld).multiply(l)}}()}),ArrayCamera.prototype=Object.assign(Object.create(PerspectiveCamera.prototype),{constructor:ArrayCamera,isArrayCamera:!0}),AudioListener.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:AudioListener,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:function(){var e=new Vector3,t=new Quaternion,i=new Vector3,r=new Vector3;return function(n){Object3D.prototype.updateMatrixWorld.call(this,n);var o=this.context.listener,a=this.up;this.matrixWorld.decompose(e,t,i),r.set(0,0,-1).applyQuaternion(t),o.positionX?(o.positionX.setValueAtTime(e.x,this.context.currentTime),o.positionY.setValueAtTime(e.y,this.context.currentTime),o.positionZ.setValueAtTime(e.z,this.context.currentTime),o.forwardX.setValueAtTime(r.x,this.context.currentTime),o.forwardY.setValueAtTime(r.y,this.context.currentTime),o.forwardZ.setValueAtTime(r.z,this.context.currentTime),o.upX.setValueAtTime(a.x,this.context.currentTime),o.upY.setValueAtTime(a.y,this.context.currentTime),o.upZ.setValueAtTime(a.z,this.context.currentTime)):(o.setPosition(e.x,e.y,e.z),o.setOrientation(r.x,r.y,r.z,a.x,a.y,a.z))}}()}),Audio$1.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Audio$1,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(this.isPlaying===!0)return void console.warn("THREE.Audio: Audio is already playing.");if(this.hasPlaybackControl===!1)return void console.warn("THREE.Audio: this Audio has no playback control.");var e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.onended=this.onEnded.bind(this),e.playbackRate.setValueAtTime(this.playbackRate,this.startTime),e.start(0,this.startTime),this.isPlaying=!0,this.source=e,this.connect()},pause:function(){return this.hasPlaybackControl===!1?void console.warn("THREE.Audio: this Audio has no playback control."):(this.source.stop(),this.startTime=this.context.currentTime,this.isPlaying=!1,this)},stop:function(){return this.hasPlaybackControl===!1?void console.warn("THREE.Audio: this Audio has no playback control."):(this.source.stop(),this.startTime=0,this.isPlaying=!1,this)},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),this.isPlaying===!0?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){return this.hasPlaybackControl===!1?void console.warn("THREE.Audio: this Audio has no playback control."):(this.playbackRate=e,this.isPlaying===!0&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this)},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return this.hasPlaybackControl===!1?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){return this.hasPlaybackControl===!1?void console.warn("THREE.Audio: this Audio has no playback control."):(this.loop=e,this.isPlaying===!0&&(this.source.loop=this.loop),this)},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),PositionalAudio.prototype=Object.assign(Object.create(Audio$1.prototype),{constructor:PositionalAudio,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:function(){var e=new Vector3;return function(t){Object3D.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}()}),Object.assign(AudioAnalyser.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),i=0;i<t.length;i++)e+=t[i];return e/t.length}}),Object.assign(PropertyMixer.prototype,{accumulate:function(e,t){var i=this.buffer,r=this.valueSize,n=e*r+r,o=this.cumulativeWeight;if(0===o){for(var a=0;a!==r;++a)i[n+a]=i[a];o=t}else{o+=t;var s=t/o;this._mixBufferRegion(i,n,0,s,r)}this.cumulativeWeight=o},apply:function(e){var t=this.valueSize,i=this.buffer,r=e*t+t,n=this.cumulativeWeight,o=this.binding;if(this.cumulativeWeight=0,n<1){var a=3*t;this._mixBufferRegion(i,r,a,1-n,t)}for(var s=t,l=t+t;s!==l;++s)if(i[s]!==i[s+t]){o.setValue(i,r);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,i=this.valueSize,r=3*i;e.getValue(t,r);for(var n=i,o=r;n!==o;++n)t[n]=t[r+n%i];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,i,r,n){if(r>=.5)for(var o=0;o!==n;++o)e[t+o]=e[i+o]},_slerp:function(e,t,i,r){Quaternion.slerpFlat(e,t,e,t,e,i,r)},_lerp:function(e,t,i,r,n){for(var o=1-r,a=0;a!==n;++a){var s=t+a;e[s]=e[s]*o+e[i+a]*r}}}),Object.assign(Composite.prototype,{getValue:function(e,t){this.bind();var i=this._targetGroup.nCachedObjects_,r=this._bindings[i];void 0!==r&&r.getValue(e,t)},setValue:function(e,t){for(var i=this._bindings,r=this._targetGroup.nCachedObjects_,n=i.length;r!==n;++r)i[r].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}),Object.assign(PropertyBinding,{Composite:Composite,create:function(e,t,i){return e&&e.isAnimationObjectGroup?new PropertyBinding.Composite(e,t,i):new PropertyBinding(e,t,i)},parseTrackName:function(){var e=/((?:[\w-]+[\/:])*)/,t=/([\w-\.]+)?/,i=/(?:\.([\w-]+)(?:\[(.+)\])?)?/,r=/\.([\w-]+)(?:\[(.+)\])?/,n=new RegExp("^"+e.source+t.source+i.source+r.source+"$"),o=["material","materials","bones"];return function(e){var t=n.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);var i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},r=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==r&&r!==-1){var a=i.nodeName.substring(r+1);o.indexOf(a)!==-1&&(i.nodeName=i.nodeName.substring(0,r),i.objectName=a)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}}(),findNode:function(e,t){if(!t||""===t||"root"===t||"."===t||t===-1||t===e.name||t===e.uuid)return e;if(e.skeleton){var i=function(e){for(var i=0;i<e.bones.length;i++){var r=e.bones[i];if(r.name===t)return r}return null},r=i(e.skeleton);if(r)return r}if(e.children){var n=function(e){for(var i=0;i<e.length;i++){var r=e[i];if(r.name===t||r.uuid===t)return r;var o=n(r.children);if(o)return o}return null},o=n(e.children);if(o)return o}return null}}),Object.assign(PropertyBinding.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)e[t++]=i[r]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.node[this.propertyName]=e[t]},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=e[t++]},function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,i=t.objectName,r=t.propertyName,n=t.propertyIndex;if(e||(e=PropertyBinding.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.error("  trying to update node for track: "+this.path+" but it wasn't found.");if(i){var o=t.objectIndex;switch(i){case"materials":if(!e.material)return void console.error("  can not bind to material as node does not have a material",this);if(!e.material.materials)return void console.error("  can not bind to material.materials as node.material does not have a materials array",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("  can not bind to bones as node does not have a skeleton",this);e=e.skeleton.bones;for(var a=0;a<e.length;a++)if(e[a].name===o){o=a;break}break;default:if(void 0===e[i])return void console.error("  can not bind to objectName of node, undefined",this);e=e[i]}if(void 0!==o){if(void 0===e[o])return void console.error("  trying to bind to objectIndex of objectName, but is undefined:",this,e);e=e[o]}}var s=e[r];if(void 0===s){var l=t.nodeName;return void console.error("  trying to update property for track: "+l+"."+r+" but it wasn't found.",e)}var c=this.Versioning.None;void 0!==e.needsUpdate?(c=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(c=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var h=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===r){if(!e.geometry)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry",this);if(!e.geometry.morphTargets)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry.morphTargets",this);for(var a=0;a<this.node.geometry.morphTargets.length;a++)if(e.geometry.morphTargets[a].name===n){n=a;break}}h=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=n}else void 0!==s.fromArray&&void 0!==s.toArray?(h=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(h=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=r;this.getValue=this.GetterByBindingType[h],this.setValue=this.SetterByBindingTypeAndVersioning[h][c]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(PropertyBinding.prototype,{_getValue_unbound:PropertyBinding.prototype.getValue,_setValue_unbound:PropertyBinding.prototype.setValue}),Object.assign(AnimationObjectGroup.prototype,{isAnimationObjectGroup:!0,add:function(e){for(var t=this._objects,i=t.length,r=this.nCachedObjects_,n=this._indicesByUUID,o=this._paths,a=this._parsedPaths,s=this._bindings,l=s.length,c=0,h=arguments.length;c!==h;++c){var u=arguments[c],d=u.uuid,p=n[d],f=void 0;if(void 0===p){p=i++,n[d]=p,t.push(u);for(var m=0,v=l;m!==v;++m)s[m].push(new PropertyBinding(u,o[m],a[m]))}else if(p<r){f=t[p];var g=--r,y=t[g];n[y.uuid]=p,t[p]=y,n[d]=g,t[g]=u;for(var m=0,v=l;m!==v;++m){var x=s[m],b=x[g],_=x[p];x[p]=b,void 0===_&&(_=new PropertyBinding(u,o[m],a[m])),x[g]=_}}else t[p]!==f&&console.error("Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes...")}this.nCachedObjects_=r},remove:function(e){for(var t=this._objects,i=this.nCachedObjects_,r=this._indicesByUUID,n=this._bindings,o=n.length,a=0,s=arguments.length;a!==s;++a){var l=arguments[a],c=l.uuid,h=r[c];if(void 0!==h&&h>=i){var u=i++,d=t[u];r[d.uuid]=h,t[h]=d,r[c]=u,t[u]=l;for(var p=0,f=o;p!==f;++p){var m=n[p],v=m[u],g=m[h];m[h]=v,m[u]=g}}}this.nCachedObjects_=i},uncache:function(e){for(var t=this._objects,i=t.length,r=this.nCachedObjects_,n=this._indicesByUUID,o=this._bindings,a=o.length,s=0,l=arguments.length;s!==l;++s){var c=arguments[s],h=c.uuid,u=n[h];if(void 0!==u)if(delete n[h],u<r){var d=--r,p=t[d],f=--i,m=t[f];n[p.uuid]=u,t[u]=p,n[m.uuid]=d,t[d]=m,t.pop();for(var v=0,g=a;v!==g;++v){var y=o[v],x=y[d],b=y[f];y[u]=x,y[d]=b,y.pop()}}else{var f=--i,m=t[f];n[m.uuid]=u,t[u]=m,t.pop();for(var v=0,g=a;v!==g;++v){var y=o[v];y[u]=y[f],y.pop()}}}this.nCachedObjects_=r},subscribe_:function(e,t){var i=this._bindingsIndicesByPath,r=i[e],n=this._bindings;if(void 0!==r)return n[r];var o=this._paths,a=this._parsedPaths,s=this._objects,l=s.length,c=this.nCachedObjects_,h=new Array(l);r=n.length,i[e]=r,o.push(e),a.push(t),n.push(h);for(var u=c,d=s.length;u!==d;++u){var p=s[u];h[u]=new PropertyBinding(p,e,t)}return h},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,i=t[e];if(void 0!==i){var r=this._paths,n=this._parsedPaths,o=this._bindings,a=o.length-1,s=o[a],l=e[a];t[l]=i,o[i]=s,o.pop(),n[i]=n[a],n.pop(),r[i]=r[a],r.pop()}}}),Object.assign(AnimationAction.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,i){if(e.fadeOut(t),this.fadeIn(t),i){var r=this._clip.duration,n=e._clip.duration,o=n/r,a=r/n;e.warp(1,o,t),this.warp(a,1,t)}return this},crossFadeTo:function(e,t,i){return e.crossFadeFrom(this,t,i)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,i){var r=this._mixer,n=r.time,o=this._timeScaleInterpolant,a=this.timeScale;null===o&&(o=r._lendControlInterpolant(),this._timeScaleInterpolant=o);var s=o.parameterPositions,l=o.sampleValues;return s[0]=n,s[1]=n+i,l[0]=e/a,l[1]=t/a,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,i,r){if(!this.enabled)return void this._updateWeight(e);var n=this._startTime;if(null!==n){var o=(e-n)*i;if(o<0||0===i)return;this._startTime=null,t=i*o}t*=this._updateTimeScale(e);var a=this._updateTime(t),s=this._updateWeight(e);if(s>0)for(var l=this._interpolants,c=this._propertyBindings,h=0,u=l.length;h!==u;++h)l[h].evaluate(a),c[h].accumulate(r,s)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var i=this._weightInterpolant;if(null!==i){var r=i.evaluate(e)[0];t*=r,e>i.parameterPositions[1]&&(this.stopFading(),0===r&&(this.enabled=!1))}}return this._effectiveWeight=t,t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var i=this._timeScaleInterpolant;if(null!==i){var r=i.evaluate(e)[0];t*=r,e>i.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var i=this._clip.duration,r=this.loop,n=this._loopCount;if(r===LoopOnce){n===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(t>=i)t=i;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var o=r===LoopPingPong;if(n===-1&&(e>=0?(n=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),t>=i||t<0){var a=Math.floor(t/i);t-=i*a,n+=Math.abs(a);var s=this.repetitions-n;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=e>0?i:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(0===s){var l=e<0;this._setEndings(l,!l,o)}else this._setEndings(!1,!1,o);this._loopCount=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:a})}}if(o&&1===(1&n))return this.time=t,i-t}return this.time=t,t},_setEndings:function(e,t,i){var r=this._interpolantSettings;i?(r.endingStart=ZeroSlopeEnding,r.endingEnd=ZeroSlopeEnding):(e?r.endingStart=this.zeroSlopeAtStart?ZeroSlopeEnding:ZeroCurvatureEnding:r.endingStart=WrapAroundEnding,t?r.endingEnd=this.zeroSlopeAtEnd?ZeroSlopeEnding:ZeroCurvatureEnding:r.endingEnd=WrapAroundEnding)},_scheduleFading:function(e,t,i){var r=this._mixer,n=r.time,o=this._weightInterpolant;null===o&&(o=r._lendControlInterpolant(),this._weightInterpolant=o);var a=o.parameterPositions,s=o.sampleValues;return a[0]=n,s[0]=t,a[1]=n+e,s[1]=i,this}}),Object.assign(AnimationMixer.prototype,EventDispatcher.prototype,{_bindAction:function(e,t){var i=e._localRoot||this._root,r=e._clip.tracks,n=r.length,o=e._propertyBindings,a=e._interpolants,s=i.uuid,l=this._bindingsByRootAndName,c=l[s];void 0===c&&(c={},l[s]=c);for(var h=0;h!==n;++h){var u=r[h],d=u.name,p=c[d];if(void 0!==p)o[h]=p;else{if(p=o[h],void 0!==p){null===p._cacheIndex&&(++p.referenceCount,
this._addInactiveBinding(p,s,d));continue}var f=t&&t._propertyBindings[h].binding.parsedPath;p=new PropertyMixer(PropertyBinding.create(i,d,f),u.ValueTypeName,u.getValueSize()),++p.referenceCount,this._addInactiveBinding(p,s,d),o[h]=p}a[h].resultBuffer=p.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,i=e._clip.uuid,r=this._actionsByClip[i];this._bindAction(e,r&&r.knownActions[0]),this._addInactiveAction(e,i,t)}for(var n=e._propertyBindings,o=0,a=n.length;o!==a;++o){var s=n[o];0===s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,i=0,r=t.length;i!==r;++i){var n=t[i];0===--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,i){var r=this._actions,n=this._actionsByClip,o=n[t];if(void 0===o)o={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,n[t]=o;else{var a=o.knownActions;e._byClipCacheIndex=a.length,a.push(e)}e._cacheIndex=r.length,r.push(e),o.actionByRoot[i]=e},_removeInactiveAction:function(e){var t=this._actions,i=t[t.length-1],r=e._cacheIndex;i._cacheIndex=r,t[r]=i,t.pop(),e._cacheIndex=null;var n=e._clip.uuid,o=this._actionsByClip,a=o[n],s=a.knownActions,l=s[s.length-1],c=e._byClipCacheIndex;l._byClipCacheIndex=c,s[c]=l,s.pop(),e._byClipCacheIndex=null;var h=a.actionByRoot,u=(e._localRoot||this._root).uuid;delete h[u],0===s.length&&delete o[n],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,i=0,r=t.length;i!==r;++i){var n=t[i];0===--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(e){var t=this._actions,i=e._cacheIndex,r=this._nActiveActions++,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_takeBackAction:function(e){var t=this._actions,i=e._cacheIndex,r=--this._nActiveActions,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_addInactiveBinding:function(e,t,i){var r=this._bindingsByRootAndName,n=r[t],o=this._bindings;void 0===n&&(n={},r[t]=n),n[i]=e,e._cacheIndex=o.length,o.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,i=e.binding,r=i.rootNode.uuid,n=i.path,o=this._bindingsByRootAndName,a=o[r],s=t[t.length-1],l=e._cacheIndex;s._cacheIndex=l,t[l]=s,t.pop(),delete a[n];e:{for(var c in a)break e;delete o[r]}},_lendBinding:function(e){var t=this._bindings,i=e._cacheIndex,r=this._nActiveBindings++,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_takeBackBinding:function(e){var t=this._bindings,i=e._cacheIndex,r=--this._nActiveBindings,n=t[r];e._cacheIndex=r,t[r]=e,n._cacheIndex=i,t[i]=n},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,i=e[t];return void 0===i&&(i=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),i.__cacheIndex=t,e[t]=i),i},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,i=e.__cacheIndex,r=--this._nActiveControlInterpolants,n=t[r];e.__cacheIndex=r,t[r]=e,n.__cacheIndex=i,t[i]=n},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var i=t||this._root,r=i.uuid,n="string"==typeof e?AnimationClip.findByName(i,e):e,o=null!==n?n.uuid:e,a=this._actionsByClip[o],s=null;if(void 0!==a){var l=a.actionByRoot[r];if(void 0!==l)return l;s=a.knownActions[0],null===n&&(n=s._clip)}if(null===n)return null;var c=new AnimationAction(this,n,t);return this._bindAction(c,s),this._addInactiveAction(c,o,r),c},existingAction:function(e,t){var i=t||this._root,r=i.uuid,n="string"==typeof e?AnimationClip.findByName(i,e):e,o=n?n.uuid:e,a=this._actionsByClip[o];return void 0!==a?a.actionByRoot[r]||null:null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,i=this._bindings,r=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var n=0;n!==t;++n)e[n].reset();for(var n=0;n!==r;++n)i[n].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,i=this._nActiveActions,r=this.time+=e,n=Math.sign(e),o=this._accuIndex^=1,a=0;a!==i;++a){var s=t[a];s._update(r,e,n,o)}for(var l=this._bindings,c=this._nActiveBindings,a=0;a!==c;++a)l[a].apply(o);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,i=e.uuid,r=this._actionsByClip,n=r[i];if(void 0!==n){for(var o=n.knownActions,a=0,s=o.length;a!==s;++a){var l=o[a];this._deactivateAction(l);var c=l._cacheIndex,h=t[t.length-1];l._cacheIndex=null,l._byClipCacheIndex=null,h._cacheIndex=c,t[c]=h,t.pop(),this._removeInactiveBindingsForAction(l)}delete r[i]}},uncacheRoot:function(e){var t=e.uuid,i=this._actionsByClip;for(var r in i){var n=i[r].actionByRoot,o=n[t];void 0!==o&&(this._deactivateAction(o),this._removeInactiveAction(o))}var a=this._bindingsByRootAndName,s=a[t];if(void 0!==s)for(var l in s){var c=s[l];c.restoreOriginalState(),this._removeInactiveBinding(c)}},uncacheAction:function(e,t){var i=this.existingAction(e,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}),Uniform.prototype.clone=function(){return new Uniform(void 0===this.value.clone?this.value:this.value.clone())},InstancedBufferGeometry.prototype=Object.assign(Object.create(BufferGeometry.prototype),{constructor:InstancedBufferGeometry,isInstancedBufferGeometry:!0,addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:i})},copy:function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var i=e.attributes;for(var r in i){var n=i[r];this.addAttribute(r,n.clone())}for(var o=e.groups,a=0,s=o.length;a<s;a++){var l=o[a];this.addGroup(l.start,l.count,l.materialIndex)}return this}}),Object.defineProperties(InterleavedBufferAttribute.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(InterleavedBufferAttribute.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this},setXYZ:function(e,t,i,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=r,this},setXYZW:function(e,t,i,r,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=r,this.data.array[e+3]=n,this}}),Object.defineProperty(InterleavedBuffer.prototype,"needsUpdate",{set:function(e){e===!0&&this.version++}}),Object.assign(InterleavedBuffer.prototype,{isInterleavedBuffer:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,i){e*=this.stride,i*=t.stride;for(var r=0,n=this.stride;r<n;r++)this.array[e+r]=t.array[i+r];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),InstancedInterleavedBuffer.prototype=Object.assign(Object.create(InterleavedBuffer.prototype),{constructor:InstancedInterleavedBuffer,isInstancedInterleavedBuffer:!0,copy:function(e){return InterleavedBuffer.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),InstancedBufferAttribute.prototype=Object.assign(Object.create(BufferAttribute.prototype),{constructor:InstancedBufferAttribute,isInstancedBufferAttribute:!0,copy:function(e){return BufferAttribute.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Object.assign(Raycaster.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var i=[];return intersectObject(e,this,i,t),i.sort(ascSort),i},intersectObjects:function(e,t){var i=[];if(Array.isArray(e)===!1)return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),i;for(var r=0,n=e.length;r<n;r++)intersectObject(e[r],this,i,t);return i.sort(ascSort),i}}),Object.assign(Clock.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}),Object.assign(Spherical.prototype,{set:function(e,t,i){return this.radius=e,this.phi=t,this.theta=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){var e=1e-6;return this.phi=Math.max(e,Math.min(Math.PI-e,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(_Math.clamp(e.y/this.radius,-1,1))),this}}),Object.assign(Cylindrical.prototype,{set:function(e,t,i){return this.radius=e,this.theta=t,this.y=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.radius=Math.sqrt(e.x*e.x+e.z*e.z),this.theta=Math.atan2(e.x,e.z),this.y=e.y,this}}),VertexNormalsHelper.prototype=Object.create(LineSegments.prototype),VertexNormalsHelper.prototype.constructor=VertexNormalsHelper,VertexNormalsHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,i=new Matrix3;return function(){var r=["a","b","c"];this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);var n=this.object.matrixWorld,o=this.geometry.attributes.position,a=this.object.geometry;if(a&&a.isGeometry)for(var s=a.vertices,l=a.faces,c=0,h=0,u=l.length;h<u;h++)for(var d=l[h],p=0,f=d.vertexNormals.length;p<f;p++){var m=s[d[r[p]]],v=d.vertexNormals[p];e.copy(m).applyMatrix4(n),t.copy(v).applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),o.setXYZ(c,e.x,e.y,e.z),c+=1,o.setXYZ(c,t.x,t.y,t.z),c+=1}else if(a&&a.isBufferGeometry)for(var g=a.attributes.position,y=a.attributes.normal,c=0,p=0,f=g.count;p<f;p++)e.set(g.getX(p),g.getY(p),g.getZ(p)).applyMatrix4(n),t.set(y.getX(p),y.getY(p),y.getZ(p)),t.applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),o.setXYZ(c,e.x,e.y,e.z),c+=1,o.setXYZ(c,t.x,t.y,t.z),c+=1;o.needsUpdate=!0}}(),SkeletonHelper.prototype=Object.create(LineSegments.prototype),SkeletonHelper.prototype.constructor=SkeletonHelper,SkeletonHelper.prototype.getBoneList=function(e){var t=[];e&&e.isBone&&t.push(e);for(var i=0;i<e.children.length;i++)t.push.apply(t,this.getBoneList(e.children[i]));return t},SkeletonHelper.prototype.update=function(){var e=new Vector3,t=new Matrix4,i=new Matrix4;return function(){var r=this.geometry,n=r.getAttribute("position");i.getInverse(this.root.matrixWorld);for(var o=0,a=0;o<this.bones.length;o++){var s=this.bones[o];s.parent&&s.parent.isBone&&(t.multiplyMatrices(i,s.matrixWorld),e.setFromMatrixPosition(t),n.setXYZ(a,e.x,e.y,e.z),t.multiplyMatrices(i,s.parent.matrixWorld),e.setFromMatrixPosition(t),n.setXYZ(a+1,e.x,e.y,e.z),a+=2)}r.getAttribute("position").needsUpdate=!0}}(),HemisphereLightHelper.prototype=Object.create(Object3D.prototype),HemisphereLightHelper.prototype.constructor=HemisphereLightHelper,HemisphereLightHelper.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},HemisphereLightHelper.prototype.update=function(){var e=new Vector3,t=new Color,i=new Color;return function(){var r=this.children[0],n=r.geometry.getAttribute("color");t.copy(this.light.color),i.copy(this.light.groundColor);for(var o=0,a=n.count;o<a;o++){var s=o<a/2?t:i;n.setXYZ(o,s.r,s.g,s.b)}r.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate()),n.needsUpdate=!0}}(),FaceNormalsHelper.prototype=Object.create(LineSegments.prototype),FaceNormalsHelper.prototype.constructor=FaceNormalsHelper,FaceNormalsHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,i=new Matrix3;return function(){this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);for(var r=this.object.matrixWorld,n=this.geometry.attributes.position,o=this.object.geometry,a=o.vertices,s=o.faces,l=0,c=0,h=s.length;c<h;c++){var u=s[c],d=u.normal;e.copy(a[u.a]).add(a[u.b]).add(a[u.c]).divideScalar(3).applyMatrix4(r),t.copy(d).applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),n.setXYZ(l,e.x,e.y,e.z),l+=1,n.setXYZ(l,t.x,t.y,t.z),l+=1}n.needsUpdate=!0}}(),CameraHelper.prototype=Object.create(LineSegments.prototype),CameraHelper.prototype.constructor=CameraHelper,CameraHelper.prototype.update=function(){function e(e,o,a,s){r.set(o,a,s).unproject(n);var l=i[e];if(void 0!==l)for(var c=t.getAttribute("position"),h=0,u=l.length;h<u;h++)c.setXYZ(l[h],r.x,r.y,r.z)}var t,i,r=new Vector3,n=new Camera;return function(){t=this.geometry,i=this.pointMap;var r=1,o=1;n.projectionMatrix.copy(this.camera.projectionMatrix),e("c",0,0,-1),e("t",0,0,1),e("n1",-r,-o,-1),e("n2",r,-o,-1),e("n3",-r,o,-1),e("n4",r,o,-1),e("f1",-r,-o,1),e("f2",r,-o,1),e("f3",-r,o,1),e("f4",r,o,1),e("u1",.7*r,1.1*o,-1),e("u2",.7*-r,1.1*o,-1),e("u3",0,2*o,-1),e("cf1",-r,0,1),e("cf2",r,0,1),e("cf3",0,-o,1),e("cf4",0,o,1),e("cn1",-r,0,-1),e("cn2",r,0,-1),e("cn3",0,-o,-1),e("cn4",0,o,-1),t.getAttribute("position").needsUpdate=!0}}();var tmp=new Vector3,px=new CubicPoly,py=new CubicPoly,pz=new CubicPoly;CatmullRomCurve3.prototype=Object.create(Curve.prototype),CatmullRomCurve3.prototype.constructor=CatmullRomCurve3,CatmullRomCurve3.prototype.getPoint=function(e){var t=this.points,i=t.length;i<2&&console.log("duh, you need at least 2 points");var r=(i-(this.closed?0:1))*e,n=Math.floor(r),o=r-n;this.closed?n+=n>0?0:(Math.floor(Math.abs(n)/t.length)+1)*t.length:0===o&&n===i-1&&(n=i-2,o=1);var a,s,l,c;if(this.closed||n>0?a=t[(n-1)%i]:(tmp.subVectors(t[0],t[1]).add(t[0]),a=tmp),s=t[n%i],l=t[(n+1)%i],this.closed||n+2<i?c=t[(n+2)%i]:(tmp.subVectors(t[i-1],t[i-2]).add(t[i-1]),c=tmp),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var h="chordal"===this.type?.5:.25,u=Math.pow(a.distanceToSquared(s),h),d=Math.pow(s.distanceToSquared(l),h),p=Math.pow(l.distanceToSquared(c),h);d<1e-4&&(d=1),u<1e-4&&(u=d),p<1e-4&&(p=d),px.initNonuniformCatmullRom(a.x,s.x,l.x,c.x,u,d,p),py.initNonuniformCatmullRom(a.y,s.y,l.y,c.y,u,d,p),pz.initNonuniformCatmullRom(a.z,s.z,l.z,c.z,u,d,p)}else if("catmullrom"===this.type){var f=void 0!==this.tension?this.tension:.5;px.initCatmullRom(a.x,s.x,l.x,c.x,f),py.initCatmullRom(a.y,s.y,l.y,c.y,f),pz.initCatmullRom(a.z,s.z,l.z,c.z,f)}return new Vector3(px.calc(o),py.calc(o),pz.calc(o))},Curve.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(Curve.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Spline.prototype=Object.create(CatmullRomCurve3.prototype),Object.assign(Spline.prototype,{initFromArray:function(e){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(e){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(e){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),Object.assign(Box2.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign(Box3.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),Line3.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},_Math.random16=function(){return console.warn("THREE.Math.random16() has been deprecated. Use Math.random() instead."),Math.random()},Object.assign(Matrix3.prototype,{flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix3: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},applyToBuffer:function(e,t,i){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,i){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(Matrix4.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},getPosition:function(){var e;return function(){return void 0===e&&(e=new Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),e.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(e,t,i){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,i){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(e,t,i,r,n,o){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,r,i,n,o)}}),Plane.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},Quaternion.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Object.assign(Ray.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign(Shape.prototype,{extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new ExtrudeGeometry(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new ShapeGeometry(this,e)}}),Object.assign(Vector2.prototype,{fromAttribute:function(e,t,i){return console.error("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Object.assign(Vector3.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},applyProjection:function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},fromAttribute:function(e,t,i){return console.error("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Object.assign(Vector4.prototype,{fromAttribute:function(e,t,i){return console.error("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Geometry.prototype.computeTangents=function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},Object.assign(Object3D.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(Object3D.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(LOD.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(Skeleton.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Object.defineProperty(Curve.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),PerspectiveCamera.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Light.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(BufferAttribute.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}}}),Object.assign(BufferGeometry.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(BufferGeometry.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(Uniform.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(Material.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new Color}}}),Object.defineProperties(MeshPhongMaterial.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(ShaderMaterial.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),Object.assign(WebGLRenderer.prototype,{getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){
return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(WebGLRenderer.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(WebGLShadowMap.prototype,{cullFace:{get:function(){return this.renderReverseSided?CullFaceFront:CullFaceBack},set:function(e){var t=e!==CullFaceBack;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(WebGLRenderTarget.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Audio$1.prototype.load=function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var t=this,i=new AudioLoader;return i.load(e,function(e){t.setBuffer(e)}),this},AudioAnalyser.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()};var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),get=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,r)}if("value"in n)return n.value;var a=n.get;if(void 0!==a)return a.call(r)},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},set=function e(t,i,r,n){var o=Object.getOwnPropertyDescriptor(t,i);if(void 0===o){var a=Object.getPrototypeOf(t);null!==a&&e(a,i,r,n)}else if("value"in o&&o.writable)o.value=r;else{var s=o.set;void 0!==s&&s.call(n,r)}return r},DEG2RAD=_Math.DEG2RAD,RAD2DEG=_Math.RAD2DEG,Angle=function(){function e(t){if(classCallCheck(this,e),"number"!=typeof t)throw new Error("Angle must be initialized with a number. Initial value was: "+t);this._value=t,this._delta=0,this._d1=null,this._d2=null,this._d3=null}return createClass(e,[{key:"degrees",get:function(){return this._value},set:function(e){do this._d1=e+this._delta-this._value,this._d2=Math.abs(this._d1+360),this._d3=Math.abs(this._d1-360),this._d1=Math.abs(this._d1),this._d2<this._d1&&this._d2<this._d3?this._delta+=360:this._d3<this._d1&&(this._delta-=360);while(this._d1>this._d2||this._d1>this._d3);this._value=e+this._delta}},{key:"radians",get:function(){return this.degrees*DEG2RAD},set:function(e){this.degrees=e*RAD2DEG}}]),e}(),AsyncLockRequest=function(){function e(t,i,r,n,o,a){classCallCheck(this,e),this.name=t,this._elementName=findProperty(document,i),this._requestMethodName=findProperty(document.documentElement,o),this._exitMethodName=findProperty(document,a),this._changeTimeout=null,this._changeEventName=findProperty(document,r),this._errorEventName=findProperty(document,n),this._changeEventName=this._changeEventName&&this._changeEventName.substring(2),this._errorEventName=this._errorEventName&&this._errorEventName.substring(2),this._events={change:this._changeEventName,error:this._errorEventName},this.exit=this.exit.bind(this),this.request=this.request.bind(this)}return createClass(e,[{key:"addEventListener",value:function(e,t,i){this._events[e]&&document.addEventListener(this._events[e],t,i)}},{key:"removeEventListener",value:function(e,t){this._events[e]&&document.removeEventListener(this._events[e],t)}},{key:"addChangeListener",value:function(e,t){this.addEventListener("change",e,t)}},{key:"removeChangeListener",value:function(e){this.removeEventListener("change",e)}},{key:"addErrorListener",value:function(e,t){this.addEventListener("error",e,t)}},{key:"removeErrorListener",value:function(e){this.removeEventListener("error",e)}},{key:"_withChange",value:function(e){var t=this;return new Promise(function(i,r){var n=function(){setTimeout(s),i(t.element)},o=function(e){setTimeout(s),r(e)},a=function(){t._changeTimeout&&(clearTimeout(t._changeTimeout),t._changeTimeout=null)},s=function(){a(),t.removeChangeListener(n),t.removeErrorListener(o)};t.addChangeListener(n,!1),t.addErrorListener(o,!1),e()?n():(a(),t._changeTimeout=setTimeout(function(){return o(name+" state did not change in allotted time")},1e3))})}},{key:"request",value:function(e,t){var i=this;return this._withChange(function(){if(!i._requestMethodName)throw new Error("No "+i.name+" API support.");return!!i.isActive||void(t?e[i._requestMethodName](t):e[i._requestMethodName]())})}},{key:"exit",value:function(){var e=this;return this._withChange(function(){if(!e._exitMethodName)throw new Error("No "+name+" API support.");return!e.isActive||void document[e._exitMethodName]()})}},{key:"element",get:function(){return document[this._elementName]}},{key:"isActive",get:function(){return!!this.element}}]),e}(),_cache={},FullScreenLockRequest=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Fullscreen",["fullscreenElement","msFullscreenElement","mozFullScreenElement","webkitFullscreenElement"],["onfullscreenchange","onmsfullscreenchange","onmozfullscreenchange","onwebkitfullscreenchange"],["onfullscreenerror","onmsfullscreenerror","onmozfullscreenerror","onwebkitfullscreenerror"],["requestFullscreen","msRequestFullscreen","mozRequestFullScreen","webkitRequestFullscreen"],["exitFullscreen","msExitFullscreen","mozExitFullScreen","webkitExitFullscreen"]));return e._fullScreenEnabledProperty=findProperty(document,["fullscreenEnabled","msFullscreenEnabled","mozFullScreenEnabled","webkitFullscreenEnabled"]),e}return inherits(t,e),createClass(t,[{key:"available",get:function(){return!(!this._fullScreenEnabledProperty||!document[this._fullScreenEnabledProperty])}}]),t}(AsyncLockRequest),FullScreen=new FullScreenLockRequest;injectIceServers(window,"RTCPeerConnection"),injectIceServers(window,"webkitRTCPeerConnection"),injectUserMedia(navigator,"webkitGetUserMedia"),injectUserMedia(navigator,"getUserMedia"),injectUserMedia(navigator.mediaDevices,"getUserMedia");var MIN_TIMESTEP=.001,MAX_TIMESTEP=1,Orientation={lock:lock,unlock:unlock},PointerLock=new AsyncLockRequest("Pointer Lock",["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"],["onpointerlockchange","onmozpointerlockchange","onwebkitpointerlockchange"],["onpointerlockerror","onmozpointerlockerror","onwebkitpointerlockerror"],["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock","webkitRequestPointerLock"],["exitPointerLock","mozExitPointerLock","webkitExitPointerLock","webkitExitPointerLock"]);Promise.prototype.log=function(e){return e=e||[],this.then(function(t){return console.log.apply(console,e.concat([t])),t})};var lastTimeupdateEvent,Workerize=function(e){function t(e){classCallCheck(this,t);var i,r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),n=e.toString(),o=n.match(/function\s+(\w+)\s*\(/),a=o[1];for(i in e.prototype)n+="\n\n"+a+".prototype."+i+" = "+e.prototype[i].toString()+";";n+="\n\n(function(){\n  var instance = new "+a+"(true);",n+="\n  if(instance.addEventListener){\n    self.args = [null, null];\n    for(var k in instance.listeners) {\n      instance.addEventListener(k, function(eventName, args){\n        self.args[0] = eventName;\n        self.args[1] = args;\n        postMessage(self.args);\n      }.bind(this, k));\n    }\n  }",n+="\n\n  onmessage = function(evt){\n    var f = evt.data[0],\n        t = instance[f];\n    if(t){\n      t.call(instance, evt.data[1]);\n    }\n  };\n\n})();",r.worker=t.createWorker(n,!1),r.args=[null,null],r.worker.onmessage=function(e){return r.emit(e.data[0],e.data[1])};for(i in e.prototype)"addEventListener"!==i&&"_"!==i[0]&&(r[i]=r.methodShim.bind(r,i));return r.ready=!0,r}return inherits(t,e),createClass(t,null,[{key:"createWorker",value:function(e,t){if("function"==typeof e&&(e=e.toString()),t){e=e.trim();var i=e.indexOf("{");e=e.substring(i+1,e.length-1)}var r=new Blob([e],{type:"text/javascript"}),n=URL.createObjectURL(r);return new Worker(n)}}]),createClass(t,[{key:"methodShim",value:function(e,t){this.args[0]=e,this.args[1]=t,this.worker.postMessage(this.args)}}]),t}(EventDispatcher),index$3={Angle:Angle,AsyncLockRequest:AsyncLockRequest,cache:cache,deleteSetting:deleteSetting,findProperty:findProperty,FullScreen:FullScreen,getSetting:getSetting,haxClass:haxClass,haxFunction:haxFunction,identity:identity,immutable:immutable,isTimestampDeltaValid:isTimestampDeltaValid,mutable:mutable,Orientation:Orientation,PointerLock:PointerLock,promisify:promisify,setSetting:setSetting,standardExitFullScreenBehavior:standardExitFullScreenBehavior,standardFullScreenBehavior:standardFullScreenBehavior,standardLockBehavior:standardLockBehavior,standardUnlockBehavior:standardUnlockBehavior,Workerize:Workerize},util=Object.freeze({Angle:Angle,AsyncLockRequest:AsyncLockRequest,cache:cache,deleteSetting:deleteSetting,findProperty:findProperty,FullScreen:FullScreen,getSetting:getSetting,haxClass:haxClass,haxFunction:haxFunction,identity:identity,immutable:immutable,isTimestampDeltaValid:isTimestampDeltaValid,mutable:mutable,Orientation:Orientation,PointerLock:PointerLock,promisify:promisify,setSetting:setSetting,standardExitFullScreenBehavior:standardExitFullScreenBehavior,standardFullScreenBehavior:standardFullScreenBehavior,standardLockBehavior:standardLockBehavior,standardUnlockBehavior:standardUnlockBehavior,Workerize:Workerize,default:index$3}),seenElements=new WeakMap,seenElementCount=0,index$4="undefined"==typeof Symbol?function(e){return"@"+(e||"@")+Math.random()}:Symbol,isWhitelisted="object-fit"in document.head.style&&/iPhone|iPod/i.test(navigator.userAgent)&&!matchMedia("(-webkit-video-playable-inline)").matches,ಠ=index$4(),ಠevent=index$4(),ಠplay=index$4("nativeplay"),ಠpause=index$4("nativepause"),lastRequests=[],requestIndex=0;enableInlineVideo.isWhitelisted=isWhitelisted;var TEMP_EULER=new Euler,TEMP_QUAT=new Quaternion,entities$1=[],Entity=function(e){function t(e,i){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.isEntity=!0,r.name=e,r.options=i||{},r.ready=r._ready.then(function(){return r}),r.disabled=!1,r.mesh=null,r.rigidBody=null,r.components=[],entities$1.push(r),r}return inherits(t,e),createClass(t,[{key:"updateMatrix",value:function(){this.rigidBody&&(this.position.copy(this.rigidBody.position),this.quaternion.copy(this.rigidBody.quaternion)),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateMatrix",this).call(this)}},{key:"at",value:function(e,t,i){return this.rigidBody?this.rigidBody.position.set(e,t,i):this.position.set(e,t,i),this}},{key:"rot",value:function(e,t,i){return TEMP_EULER.set(e,t,i),TEMP_QUAT.setFromEueler(TEMP_EULER),this.rigidBody?this.rigidBody.quaternion.copy(TEMP_QUAT):this.quaternion.copy(TEMP_QUAT),this}},{key:"vel",value:function(e,t,i){return this.rigidBody&&this.rigidBody.velocity.set(e,t,i),this}},{key:"linearDamping",value:function(e){return this.rigidBody&&(this.rigidBody.linearDamping=e),this}},{key:"angularDamping",value:function(e){return this.rigidBody&&(this.rigidBody.angularDamping=e),this}},{key:"angVel",value:function(e,t,i){return this.rigidBody&&this.rigidBody.angularVelocity.set(e,t,i),this}},{key:"addShape",value:function(e){return this.rigidBody&&this.rigidBody.addShape(e),this}},{key:"preStep",value:function(){for(var e=0;e<this.components.length;++e)this.components[e].preStep()}},{key:"postStep",value:function(){for(var e=0;e<this.components.length;++e)this.components[e].postStep()}},{key:"update",value:function(){for(var e=0;e<this.components.length;++e)this.components[e].update()}},{key:"_ready",get:function(){return Promise.resolve()}},{key:"velocity",get:function(){if(this.rigidBody)return this.rigidBody.velocity}},{key:"angularVelocity",get:function(){if(this.rigidBody)return this.rigidBody.angularVelocity}},{key:"position",get:function(){return this.rigidBody&&this.rigidBody.position||get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"position",this)}},{key:"quaternion",get:function(){return this.rigidBody&&this.rigidBody.quaternion||get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"quaternion",this)}}]),t}(Object3D),entities=[],BaseTextured=function(e){function t(e,i){classCallCheck(this,t),name=i&&i.id||e.join();var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,name,i));return entities.push(r),r._files=e,r._meshes=[],r._textures=[],r._currentImageIndex=0,r.options.geometry?r._geometry=r.options.geometry:r.options.radius?r._geometry=shell(r.options.radius,72,36,2*Math.PI,Math.PI,i):(r.options.width||(r.options.width=.5),r.options.height||(r.options.height=.5),r._geometry=quad(r.options.width,r.options.height,i)),r}return inherits(t,e),createClass(t,[{key:"eyeBlank",value:function(e){if(this._meshes&&this._meshes.length>0){this._currentImageIndex=e%this._meshes.length;for(var t=0;t<this._meshes.length;++t)this._meshes[t].visible=t===this._currentImageIndex}}},{key:"_ready",get:function(){var e=this;return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_ready",this).then(function(){return e._loadFiles(e._files,e.options.progress)}).then(function(){return e._meshes.forEach(function(t){return e.add(t)})})}},{key:"blending",get:function(){return this._meshes&&this._meshes.length>0&&this._meshes[0]&&this._meshes[0].material.blending},set:function(e){this._meshes.forEach(function(t){return t.material.blending=e})}}]),t}(Entity),COUNTER=0,processedVideos=[];window.addEventListener("touchend",findAndFixVideo,!1),window.addEventListener("mouseup",findAndFixVideo,!1),window.addEventListener("keyup",findAndFixVideo,!1);var Video=function(e){function t(e,i){return classCallCheck(this,t),e instanceof Array||(e=[e]),i=Object.assign({},{id:"Primrose.Controls.Video["+COUNTER++ +"]"},i),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i))}return inherits(t,e),createClass(t,[{key:"_loadFiles",value:function(e,t){var i=this;return this._elements=Array.prototype.map.call(e,function(e,r){var n=null;"string"==typeof e?(n=document.querySelector("video[src='"+e+"']"),n||(n=document.createElement("video"),n.src=e)):e instanceof HTMLVideoElement?n=e:"[object MediaStream]"!==e.toString()&&"[object LocalMediaStream]"!==e.toString()||(n=document.createElement("video"),n.srcObject=e),n.onprogress=t,n.onloadedmetadata=t,n.muted=!0,n.loop=!0,n.setAttribute("playsinline",""),n.setAttribute("webkit-playsinline",""),isiOS||(n.preload="auto");var o=Object.assign({},i.options);return i._meshes[r]=textured(i._geometry,n,o),n.parentElement||(document.body.insertBefore(n,document.body.children[0]),fixVideo(n)),o.promise.then(function(e){i._textures[r]=e,console.log(e),e.minFilter=LinearFilter}),n}),Promise.resolve()}},{key:"play",value:function(){this._elements.length>0&&this._elements[0].play()}},{key:"update",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this);for(var e=0;e<this._textures.length;++e)if(this._textures[e]){var i=this._elements[e];i.currentTime!==this._lastTime&&(this._textures[e].needsUpdate=!0,this._lastTime=i.currentTime)}}}]),t}(BaseTextured),commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},cannon=createCommonjsModule(function(e,t){!function(t){e.exports=t()}(function(){return function e(t,i,r){function n(a,s){if(!i[a]){if(!t[a]){var l="function"==typeof commonjsRequire&&commonjsRequire;if(!s&&l)return l(a,!0);if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=i[a]={exports:{}};t[a][0].call(c.exports,function(e){var i=t[a][1][e];return n(i?i:e)},c,c.exports,e,t,i,r)}return i[a].exports}for(var o="function"==typeof commonjsRequire&&commonjsRequire,a=0;a<r.length;a++)n(r[a]);return n}({1:[function(e,t,i){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t,i){function r(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}var n=e("../math/Vec3");e("../utils/Utils");t.exports=r;var o=new n;r.prototype.setFromPoints=function(e,t,i,r){var n=this.lowerBound,a=this.upperBound,s=i;n.copy(e[0]),s&&s.vmult(n,n),a.copy(n);for(var l=1;l<e.length;l++){var c=e[l];s&&(s.vmult(c,o),c=o),c.x>a.x&&(a.x=c.x),c.x<n.x&&(n.x=c.x),c.y>a.y&&(a.y=c.y),c.y<n.y&&(n.y=c.y),c.z>a.z&&(a.z=c.z),c.z<n.z&&(n.z=c.z)}return t&&(t.vadd(n,n),t.vadd(a,a)),r&&(n.x-=r,n.y-=r,n.z-=r,a.x+=r,a.y+=r,a.z+=r),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){var t=e.lowerBound.x;this.lowerBound.x>t&&(this.lowerBound.x=t);var i=e.upperBound.x;this.upperBound.x<i&&(this.upperBound.x=i);var t=e.lowerBound.y;this.lowerBound.y>t&&(this.lowerBound.y=t);var i=e.upperBound.y;this.upperBound.y<i&&(this.upperBound.y=i);var t=e.lowerBound.z;this.lowerBound.z>t&&(this.lowerBound.z=t);var i=e.upperBound.z;this.upperBound.z<i&&(this.upperBound.z=i)},r.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,r=e.lowerBound,n=e.upperBound;return(r.x<=i.x&&i.x<=n.x||t.x<=n.x&&n.x<=i.x)&&(r.y<=i.y&&i.y<=n.y||t.y<=n.y&&n.y<=i.y)&&(r.z<=i.z&&i.z<=n.z||t.z<=n.z&&n.z<=i.z)},r.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,r=e.lowerBound,n=e.upperBound;return t.x<=r.x&&i.x>=n.x&&t.y<=r.y&&i.y>=n.y&&t.z<=r.z&&i.z>=n.z},r.prototype.getCorners=function(e,t,i,r,n,o,a,s){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),i.set(c.x,c.y,l.z),r.set(l.x,c.y,c.z),n.set(c.x,l.y,l.z),o.set(l.x,c.y,l.z),a.set(l.x,l.y,c.z),s.copy(c)};var a=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(e,t){var i=a,r=i[0],n=i[1],o=i[2],s=i[3],l=i[4],c=i[5],h=i[6],u=i[7];this.getCorners(r,n,o,s,l,c,h,u);for(var d=0;8!==d;d++){var p=i[d];e.pointToLocal(p,p)}return t.setFromPoints(i)},r.prototype.toWorldFrame=function(e,t){var i=a,r=i[0],n=i[1],o=i[2],s=i[3],l=i[4],c=i[5],h=i[6],u=i[7];this.getCorners(r,n,o,s,l,c,h,u);for(var d=0;8!==d;d++){var p=i[d];e.pointToWorld(p,p)}return t.setFromPoints(i)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t,i){function r(){this.matrix=[]}t.exports=r,r.prototype.get=function(e,t){if(e=e.index,t=t.index,t>e){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},r.prototype.set=function(e,t,i){if(e=e.index,t=t.index,t>e){var r=t;t=e,e=r}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},r.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},r.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var n=e("../objects/Body"),o=e("../math/Vec3"),a=e("../math/Quaternion");e("../shapes/Shape"),e("../shapes/Plane");t.exports=r,r.prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var s=n.STATIC|n.KINEMATIC;r.prototype.needBroadphaseCollision=function(e,t){return 0!==(e.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&e.collisionFilterMask)&&(0===(e.type&s)&&e.sleepState!==n.SLEEPING||0===(t.type&s)&&t.sleepState!==n.SLEEPING)},r.prototype.intersectionTest=function(e,t,i,r){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,r):this.doBoundingSphereBroadphase(e,t,i,r)};var l=new o;new o,new a,new o;r.prototype.doBoundingSphereBroadphase=function(e,t,i,r){var n=l;t.position.vsub(e.position,n);var o=Math.pow(e.boundingRadius+t.boundingRadius,2),a=n.norm2();a<o&&(i.push(e),r.push(t))},r.prototype.doBoundingBoxBroadphase=function(e,t,i,r){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),r.push(t))};var c={keys:[]},h=[],u=[];r.prototype.makePairsUnique=function(e,t){for(var i=c,r=h,n=u,o=e.length,a=0;a!==o;a++)r[a]=e[a],n[a]=t[a];e.length=0,t.length=0;for(var a=0;a!==o;a++){var s=r[a].id,l=n[a].id,d=s<l?s+","+l:l+","+s;i[d]=a,i.keys.push(d)}for(var a=0;a!==i.keys.length;a++){var d=i.keys.pop(),p=i[d];e.push(r[p]),t.push(n[p]),delete i[d]}},r.prototype.setWorld=function(e){};var d=new o;r.boundingSphereCheck=function(e,t){var i=d;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},r.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t,i){function r(e,t,i,r,a){n.apply(this),this.nx=i||10,this.ny=r||10,this.nz=a||10,this.aabbMin=e||new o(100,100,100),this.aabbMax=t||new o(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var l=0;l<s;l++)this.bins[l]=[],this.binLengths[l]=0}t.exports=r;var n=e("./Broadphase"),o=e("../math/Vec3"),a=e("../shapes/Shape");r.prototype=new n,r.prototype.constructor=r;var s=new o;new o;r.prototype.collisionPairs=function(e,t,i){function r(e,t,i,r,n,o,a){var s=(e-x)*w|0,l=(t-b)*M|0,c=(i-_)*E|0,v=k((r-x)*w),g=k((n-b)*M),y=k((o-_)*E);s<0?s=0:s>=h&&(s=h-1),l<0?l=0:l>=u&&(l=u-1),c<0?c=0:c>=d&&(c=d-1),v<0?v=0:v>=h&&(v=h-1),g<0?g=0:g>=u&&(g=u-1),y<0?y=0:y>=d&&(y=d-1),s*=p,l*=f,c*=m,v*=p,g*=f,y*=m;for(var S=s;S<=v;S+=p)for(var T=l;T<=g;T+=f)for(var C=c;C<=y;C+=m){var A=S+T+C;B[A][O[A]++]=a}}for(var n=e.numObjects(),o=e.bodies,l=this.aabbMax,c=this.aabbMin,h=this.nx,u=this.ny,d=this.nz,p=u*d,f=d,m=1,v=l.x,g=l.y,y=l.z,x=c.x,b=c.y,_=c.z,w=h/(v-x),M=u/(g-b),E=d/(y-_),S=(v-x)/h,T=(g-b)/u,C=(y-_)/d,A=.5*Math.sqrt(S*S+T*T+C*C),P=a.types,R=P.SPHERE,L=P.PLANE,B=(P.BOX,P.COMPOUND,P.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,I=this.bins.length,D=0;D!==I;D++)O[D]=0;for(var k=Math.ceil,c=Math.min,l=Math.max,D=0;D!==n;D++){var F=o[D],N=F.shape;switch(N.type){case R:var V=F.position.x,U=F.position.y,G=F.position.z,z=N.radius;r(V-z,U-z,G-z,V+z,U+z,G+z,F);break;case L:N.worldNormalNeedsUpdate&&N.computeWorldNormal(F.quaternion);var j=N.worldNormal,H=x+.5*S-F.position.x,W=b+.5*T-F.position.y,q=_+.5*C-F.position.z,X=s;X.set(H,W,q);for(var Y=0,K=0;Y!==h;Y++,K+=p,X.y=W,X.x+=S)for(var Q=0,Z=0;Q!==u;Q++,Z+=f,X.z=q,X.y+=T)for(var J=0,$=0;J!==d;J++,$+=m,X.z+=C)if(X.dot(j)<A){var ee=K+Z+$;B[ee][O[ee]++]=F}break;default:F.aabbNeedsUpdate&&F.computeAABB(),r(F.aabb.lowerBound.x,F.aabb.lowerBound.y,F.aabb.lowerBound.z,F.aabb.upperBound.x,F.aabb.upperBound.y,F.aabb.upperBound.z,F);
}}for(var D=0;D!==I;D++){var te=O[D];if(te>1)for(var ie=B[D],Y=0;Y!==te;Y++)for(var F=ie[Y],Q=0;Q!==Y;Q++){var re=ie[Q];this.needBroadphaseCollision(F,re)&&this.intersectionTest(F,re,t,i)}}this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t,i){function r(){n.apply(this)}t.exports=r;var n=e("./Broadphase"),o=e("./AABB");r.prototype=new n,r.prototype.constructor=r,r.prototype.collisionPairs=function(e,t,i){var r,n,o,a,s=e.bodies,l=s.length;for(r=0;r!==l;r++)for(n=0;n!==r;n++)o=s[r],a=s[n],this.needBroadphaseCollision(o,a)&&this.intersectionTest(o,a,t,i)};new o;r.prototype.aabbQuery=function(e,t,i){i=i||[];for(var r=0;r<e.bodies.length;r++){var n=e.bodies[r];n.aabbNeedsUpdate&&n.computeAABB(),n.aabb.overlaps(t)&&i.push(n)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function r(){this.matrix={}}t.exports=r,r.prototype.get=function(e,t){if(e=e.id,t=t.id,t>e){var i=t;t=e,e=i}return e+"-"+t in this.matrix},r.prototype.set=function(e,t,i){if(e=e.id,t=t.id,t>e){var r=t;t=e,e=r}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},r.prototype.reset=function(){this.matrix={}},r.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function r(e,t){this.from=e?e.clone():new a,this.to=t?t.clone():new a,this._direction=new a,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=r.ANY,this.result=new c,this.hasHit=!1,this.callback=function(e){}}function n(e,t,i,r){r.vsub(t,D),i.vsub(t,f),e.vsub(t,m);var n,o,a=D.dot(D),s=D.dot(f),l=D.dot(m),c=f.dot(f),h=f.dot(m);return(n=c*l-s*h)>=0&&(o=a*h-s*l)>=0&&n+o<a*c-s*s}function o(e,t,i){i.vsub(e,D);var r=D.dot(t);t.mult(r,k),k.vadd(e,k);var n=i.distanceTo(k);return n}t.exports=r;var a=e("../math/Vec3"),s=e("../math/Quaternion"),l=e("../math/Transform"),c=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),h=e("../shapes/Shape"),u=e("../collision/AABB");r.prototype.constructor=r,r.CLOSEST=1,r.ANY=2,r.ALL=4;var d=new u,p=[];r.prototype.intersectWorld=function(e,t){return this.mode=t.mode||r.ANY,this.result=t.result||new c,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask="undefined"!=typeof t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!=typeof t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(d),p.length=0,e.broadphase.aabbQuery(e,d,p),this.intersectBodies(p),this.hasHit};var f=new a,m=new a;r.pointInTriangle=n;var v=new a,g=new s;r.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!==(this.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&this.collisionFilterMask))for(var r=v,n=g,o=0,a=e.shapes.length;o<a;o++){var s=e.shapes[o];if((!i||s.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[o],n),e.quaternion.vmult(e.shapeOffsets[o],r),r.vadd(e.position,r),this.intersectShape(s,n,r,e),this.result._shouldStop))break}},r.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,r=e.length;!this.result._shouldStop&&i<r;i++)this.intersectBody(e[i])},r.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},r.prototype.intersectShape=function(e,t,i,r){var n=this.from,a=o(n,this._direction,i);if(!(a>e.boundingSphereRadius)){var s=this[e.type];s&&s.call(this,e,t,i,r)}};var y=(new a,new a,new a),x=new a,b=new a,_=new a;new a,new c;r.prototype.intersectBox=function(e,t,i,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,r)},r.prototype[h.types.BOX]=r.prototype.intersectBox,r.prototype.intersectPlane=function(e,t,i,r){var n=this.from,o=this.to,s=this._direction,l=new a(0,0,1);t.vmult(l,l);var c=new a;n.vsub(i,c);var h=c.dot(l);o.vsub(i,c);var u=c.dot(l);if(!(h*u>0||n.distanceTo(o)<h)){var d=l.dot(s);if(!(Math.abs(d)<this.precision)){var p=new a,f=new a,m=new a;n.vsub(i,p);var v=-l.dot(p)/d;s.scale(v,f),n.vadd(f,m),this.reportIntersection(l,m,e,r,-1)}}},r.prototype[h.types.PLANE]=r.prototype.intersectPlane,r.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var w={faceList:[0]};r.prototype.intersectHeightfield=function(e,t,i,n){var o=(e.data,e.elementSize,new a),s=new r(this.from,this.to);l.pointToLocalFrame(i,t,s.from,s.from),l.pointToLocalFrame(i,t,s.to,s.to);var c=[],h=null,u=null,d=null,p=null,f=e.getIndexOfPosition(s.from.x,s.from.y,c,!1);if(f&&(h=c[0],u=c[1],d=c[0],p=c[1]),f=e.getIndexOfPosition(s.to.x,s.to.y,c,!1),f&&((null===h||c[0]<h)&&(h=c[0]),(null===d||c[0]>d)&&(d=c[0]),(null===u||c[1]<u)&&(u=c[1]),(null===p||c[1]>p)&&(p=c[1])),null!==h){var m=[];e.getRectMinMax(h,u,d,p,m);for(var v=(m[0],m[1],h);v<=d;v++)for(var g=u;g<=p;g++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(v,g,!1),l.pointToWorldFrame(i,t,e.pillarOffset,o),this.intersectConvex(e.pillarConvex,t,o,n,w),this.result._shouldStop)return;e.getConvexTrianglePillar(v,g,!0),l.pointToWorldFrame(i,t,e.pillarOffset,o),this.intersectConvex(e.pillarConvex,t,o,n,w)}}},r.prototype[h.types.HEIGHTFIELD]=r.prototype.intersectHeightfield;var M=new a,E=new a;r.prototype.intersectSphere=function(e,t,i,r){var n=this.from,o=this.to,a=e.radius,s=Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2)+Math.pow(o.z-n.z,2),l=2*((o.x-n.x)*(n.x-i.x)+(o.y-n.y)*(n.y-i.y)+(o.z-n.z)*(n.z-i.z)),c=Math.pow(n.x-i.x,2)+Math.pow(n.y-i.y,2)+Math.pow(n.z-i.z,2)-Math.pow(a,2),h=Math.pow(l,2)-4*s*c,u=M,d=E;if(!(h<0))if(0===h)n.lerp(o,h,u),u.vsub(i,d),d.normalize(),this.reportIntersection(d,u,e,r,-1);else{var p=(-l-Math.sqrt(h))/(2*s),f=(-l+Math.sqrt(h))/(2*s);if(p>=0&&p<=1&&(n.lerp(o,p,u),u.vsub(i,d),d.normalize(),this.reportIntersection(d,u,e,r,-1)),this.result._shouldStop)return;f>=0&&f<=1&&(n.lerp(o,f,u),u.vsub(i,d),d.normalize(),this.reportIntersection(d,u,e,r,-1))}},r.prototype[h.types.SPHERE]=r.prototype.intersectSphere;var S=new a,T=(new a,new a,new a);r.prototype.intersectConvex=function(e,t,i,r,o){for(var a=S,s=T,l=o&&o.faceList||null,c=e.faces,h=e.vertices,u=e.faceNormals,d=this._direction,p=this.from,f=this.to,m=p.distanceTo(f),v=l?l.length:c.length,g=this.result,w=0;!g._shouldStop&&w<v;w++){var M=l?l[w]:w,E=c[M],C=u[M],A=t,P=i;s.copy(h[E[0]]),A.vmult(s,s),s.vadd(P,s),s.vsub(p,s),A.vmult(C,a);var R=d.dot(a);if(!(Math.abs(R)<this.precision)){var L=a.dot(s)/R;if(!(L<0)){d.mult(L,y),y.vadd(p,y),x.copy(h[E[0]]),A.vmult(x,x),P.vadd(x,x);for(var B=1;!g._shouldStop&&B<E.length-1;B++){b.copy(h[E[B]]),_.copy(h[E[B+1]]),A.vmult(b,b),A.vmult(_,_),P.vadd(b,b),P.vadd(_,_);var O=y.distanceTo(p);!n(y,x,b,_)&&!n(y,b,x,_)||O>m||this.reportIntersection(a,y,e,r,M)}}}}},r.prototype[h.types.CONVEXPOLYHEDRON]=r.prototype.intersectConvex;var C=new a,A=new a,P=new a,R=new a,L=new a,B=new a,O=(new u,[]),I=new l;r.prototype.intersectTrimesh=function(e,t,i,r,o){var a=C,s=O,c=I,h=T,u=A,d=P,p=R,f=B,m=L,v=(o&&o.faceList||null,e.indices),g=(e.vertices,e.faceNormals,this.from),w=this.to,M=this._direction;c.position.copy(i),c.quaternion.copy(t),l.vectorToLocalFrame(i,t,M,u),l.pointToLocalFrame(i,t,g,d),l.pointToLocalFrame(i,t,w,p);var E=d.distanceSquared(p);e.tree.rayQuery(this,c,s);for(var S=0,D=s.length;!this.result._shouldStop&&S!==D;S++){var k=s[S];e.getNormal(k,a),e.getVertex(v[3*k],x),x.vsub(d,h);var F=u.dot(a),N=a.dot(h)/F;if(!(N<0)){u.scale(N,y),y.vadd(d,y),e.getVertex(v[3*k+1],b),e.getVertex(v[3*k+2],_);var V=y.distanceSquared(d);!n(y,b,x,_)&&!n(y,x,b,_)||V>E||(l.vectorToWorldFrame(t,a,m),l.pointToWorldFrame(i,t,y,f),this.reportIntersection(m,f,e,r,k))}}s.length=0},r.prototype[h.types.TRIMESH]=r.prototype.intersectTrimesh,r.prototype.reportIntersection=function(e,t,i,n,o){var a=this.from,s=this.to,l=a.distanceTo(t),c=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(c.hitFaceIndex="undefined"!=typeof o?o:-1,this.mode){case r.ALL:this.hasHit=!0,c.set(a,s,e,t,i,n,l),c.hasHit=!0,this.callback(c);break;case r.CLOSEST:(l<c.distance||!c.hasHit)&&(this.hasHit=!0,c.hasHit=!0,c.set(a,s,e,t,i,n,l));break;case r.ANY:this.hasHit=!0,c.hasHit=!0,c.set(a,s,e,t,i,n,l),c._shouldStop=!0}};var D=new a,k=new a},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t,i){function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var n=e("../math/Vec3");t.exports=r,r.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,i,r,n,o,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(r),this.shape=n,this.body=o,this.distance=a}},{"../math/Vec3":30}],11:[function(e,t,i){function r(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var i=t.indexOf(e.body);i!==-1&&t.splice(i,1)},e&&this.setWorld(e)}var n=(e("../shapes/Shape"),e("../collision/Broadphase"));t.exports=r,r.prototype=new n,r.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},r.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],n=t-1;n>=0&&!(e[n].aabb.lowerBound.x<=r.aabb.lowerBound.x);n--)e[n+1]=e[n];e[n+1]=r}return e},r.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],n=t-1;n>=0&&!(e[n].aabb.lowerBound.y<=r.aabb.lowerBound.y);n--)e[n+1]=e[n];e[n+1]=r}return e},r.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],n=t-1;n>=0&&!(e[n].aabb.lowerBound.z<=r.aabb.lowerBound.z);n--)e[n+1]=e[n];e[n+1]=r}return e},r.prototype.collisionPairs=function(e,t,i){var n,o,a=this.axisList,s=a.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==s;n++){var c=a[n];for(o=n+1;o<s;o++){var h=a[o];if(this.needBroadphaseCollision(c,h)){if(!r.checkBounds(c,h,l))break;this.intersectionTest(c,h,t,i)}}}},r.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var o=e[n];o.aabbNeedsUpdate&&o.computeAABB()}0===t?r.insertionSortX(e):1===t?r.insertionSortY(e):2===t&&r.insertionSortZ(e)},r.checkBounds=function(e,t,i){var r,n;0===i?(r=e.position.x,n=t.position.x):1===i?(r=e.position.y,n=t.position.y):2===i&&(r=e.position.z,n=t.position.z);var o=e.boundingRadius,a=t.boundingRadius,s=r+o,l=n-a;return l<s},r.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,r=0,n=0,o=0,a=this.axisList,s=a.length,l=1/s,c=0;c!==s;c++){var h=a[c],u=h.position.x;e+=u,t+=u*u;var d=h.position.y;i+=d,r+=d*d;var p=h.position.z;n+=p,o+=p*p}var f=t-e*e*l,m=r-i*i*l,v=o-n*n*l;f>m?f>v?this.axisIndex=0:this.axisIndex=2:m>v?this.axisIndex=1:this.axisIndex=2},r.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var r=this.axisIndex,n="x";1===r&&(n="y"),2===r&&(n="z");for(var o=this.axisList,a=(t.lowerBound[n],t.upperBound[n],0);a<o.length;a++){var s=o[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&i.push(s)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t,i){function r(e,t,i){i=i||{};var r="undefined"!=typeof i.maxForce?i.maxForce:1e6,l=i.pivotA?i.pivotA.clone():new s,c=i.pivotB?i.pivotB.clone():new s;this.axisA=i.axisA?i.axisA.clone():new s,this.axisB=i.axisB?i.axisB.clone():new s,n.call(this,e,l,t,c,r),this.collideConnected=!!i.collideConnected,this.angle="undefined"!=typeof i.angle?i.angle:0;var h=this.coneEquation=new o(e,t,i),u=this.twistEquation=new a(e,t,i);this.twistAngle="undefined"!=typeof i.twistAngle?i.twistAngle:0,h.maxForce=0,h.minForce=-r,u.maxForce=0,u.minForce=-r,this.equations.push(h,u)}t.exports=r;var n=(e("./Constraint"),e("./PointToPointConstraint")),o=e("../equations/ConeEquation"),a=e("../equations/RotationalEquation"),s=(e("../equations/ContactEquation"),e("../math/Vec3"));r.prototype=new n,r.constructor=r;new s,new s;r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t,i){function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}t.exports=r;var n=e("../utils/Utils");r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":53}],14:[function(e,t,i){function r(e,t,i,r){n.call(this,e,t),"undefined"==typeof i&&(i=e.position.distanceTo(t.position)),"undefined"==typeof r&&(r=1e6),this.distance=i;var a=this.distanceEquation=new o(e,t);this.equations.push(a),a.minForce=-r,a.maxForce=r}t.exports=r;var n=e("./Constraint"),o=e("../equations/ContactEquation");r.prototype=new n,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,r=.5*this.distance,n=i.ni;t.position.vsub(e.position,n),n.normalize(),n.mult(r,i.ri),n.mult(-r,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t,i){function r(e,t,i){i=i||{};var r="undefined"!=typeof i.maxForce?i.maxForce:1e6,l=i.pivotA?i.pivotA.clone():new s,c=i.pivotB?i.pivotB.clone():new s;n.call(this,e,l,t,c,r);var h=this.axisA=i.axisA?i.axisA.clone():new s(1,0,0);h.normalize();var u=this.axisB=i.axisB?i.axisB.clone():new s(1,0,0);u.normalize();var d=this.rotationalEquation1=new o(e,t,i),p=this.rotationalEquation2=new o(e,t,i),f=this.motorEquation=new a(e,t,r);f.enabled=!1,this.equations.push(d,p,f)}t.exports=r;var n=(e("./Constraint"),e("./PointToPointConstraint")),o=e("../equations/RotationalEquation"),a=e("../equations/RotationalMotorEquation"),s=(e("../equations/ContactEquation"),e("../math/Vec3"));r.prototype=new n,r.constructor=r,r.prototype.enableMotor=function(){this.motorEquation.enabled=!0},r.prototype.disableMotor=function(){this.motorEquation.enabled=!1},r.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},r.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var l=new s,c=new s;r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,o=this.rotationalEquation2,a=l,s=c,h=this.axisA,u=this.axisB;n.prototype.update.call(this),e.quaternion.vmult(h,a),t.quaternion.vmult(u,s),a.tangents(r.axisA,o.axisA),r.axisB.copy(s),o.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t,i){function r(e,t,i){i=i||{};var r="undefined"!=typeof i.maxForce?i.maxForce:1e6,s=new a,l=new a,c=new a;e.position.vadd(t.position,c),c.scale(.5,c),t.pointToLocalFrame(c,l),e.pointToLocalFrame(c,s),n.call(this,e,s,t,l,r);var h=this.rotationalEquation1=new o(e,t,i),u=this.rotationalEquation2=new o(e,t,i),d=this.rotationalEquation3=new o(e,t,i);this.equations.push(h,u,d)}t.exports=r;var n=(e("./Constraint"),e("./PointToPointConstraint")),o=e("../equations/RotationalEquation"),a=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));r.prototype=new n,r.constructor=r;new a,new a;r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,o=this.rotationalEquation3;n.prototype.update.call(this),e.vectorToWorldFrame(a.UNIT_X,i.axisA),t.vectorToWorldFrame(a.UNIT_Y,i.axisB),e.vectorToWorldFrame(a.UNIT_Y,r.axisA),t.vectorToWorldFrame(a.UNIT_Z,r.axisB),e.vectorToWorldFrame(a.UNIT_Z,o.axisA),t.vectorToWorldFrame(a.UNIT_X,o.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t,i){function r(e,t,i,r,s){n.call(this,e,i),s="undefined"!=typeof s?s:1e6,this.pivotA=t?t.clone():new a,this.pivotB=r?r.clone():new a;var l=this.equationX=new o(e,i),c=this.equationY=new o(e,i),h=this.equationZ=new o(e,i);this.equations.push(l,c,h),l.minForce=c.minForce=h.minForce=-s,l.maxForce=c.maxForce=h.maxForce=s,l.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}t.exports=r;var n=e("./Constraint"),o=e("../equations/ContactEquation"),a=e("../math/Vec3");r.prototype=new n,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,r=this.equationY,n=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t,i){function r(e,t,i){i=i||{};var r="undefined"!=typeof i.maxForce?i.maxForce:1e6;o.call(this,e,t,-r,r),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.angle="undefined"!=typeof i.angle?i.angle:0}t.exports=r;var n=e("../math/Vec3"),o=(e("../math/Mat3"),e("./Equation"));r.prototype=new o,r.prototype.constructor=r;var a=new n,s=new n;r.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.axisA,n=this.axisB,o=a,l=s,c=this.jacobianElementA,h=this.jacobianElementB;r.cross(n,o),n.cross(r,l),c.rotational.copy(l),h.rotational.copy(o);var u=Math.cos(this.angle)-r.dot(n),d=this.computeGW(),p=this.computeGiMf(),f=-u*t-d*i-e*p;return f}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t,i){function r(e,t,i){i="undefined"!=typeof i?i:1e6,n.call(this,e,t,0,i),this.restitution=0,this.ri=new o,this.rj=new o,this.ni=new o}t.exports=r;var n=e("./Equation"),o=e("../math/Vec3");e("../math/Mat3");r.prototype=new n,r.prototype.constructor=r;var a=new o,s=new o,l=new o;r.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.bi,n=this.bj,o=this.ri,c=this.rj,h=a,u=s,d=r.velocity,p=r.angularVelocity,f=(r.force,r.torque,n.velocity),m=n.angularVelocity,v=(n.force,n.torque,l),g=this.jacobianElementA,y=this.jacobianElementB,x=this.ni;o.cross(x,h),c.cross(x,u),x.negate(g.spatial),h.negate(g.rotational),y.spatial.copy(x),y.rotational.copy(u),v.copy(n.position),v.vadd(c,v),v.vsub(r.position,v),v.vsub(o,v);var b=x.dot(v),_=this.restitution+1,w=_*f.dot(x)-_*d.dot(x)+m.dot(u)-p.dot(h),M=this.computeGiMf(),E=-b*t-w*i-e*M;return E};var c=new o,h=new o,u=new o,d=new o,p=new o;r.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=h,i=u,r=d,n=p;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,r),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(r,t),e.vsub(t,n),this.ni.dot(n)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t,i){function r(e,t,i,o){this.id=r.id++,this.minForce="undefined"==typeof i?-1e6:i,this.maxForce="undefined"==typeof o?1e6:o,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}t.exports=r;var n=e("../math/JacobianElement"),o=e("../math/Vec3");r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(e,t,i){var r=t,n=e,o=i;this.a=4/(o*(1+4*r)),this.b=4*r/(1+4*r),this.eps=4/(o*o*n*(1+4*r))},r.prototype.computeB=function(e,t,i){var r=this.computeGW(),n=this.computeGq(),o=this.computeGiMf();return-n*e-r*t-o*i},r.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.position,o=r.position;return e.spatial.dot(n)+t.spatial.dot(o)};var a=new o;r.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.velocity,o=r.velocity,s=i.angularVelocity||a,l=r.angularVelocity||a;return e.multiplyVectors(n,s)+t.multiplyVectors(o,l)},r.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.vlambda,o=r.vlambda,s=i.wlambda||a,l=r.wlambda||a;return e.multiplyVectors(n,s)+t.multiplyVectors(o,l)};var s=new o,l=new o,c=new o,h=new o;r.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.force,o=i.torque,a=r.force,u=r.torque,d=i.invMassSolve,p=r.invMassSolve;return i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(o,c):c.set(0,0,0),r.invInertiaWorldSolve?r.invInertiaWorldSolve.vmult(u,h):h.set(0,0,0),n.mult(d,s),a.mult(p,l),e.multiplyVectors(s,c)+t.multiplyVectors(l,h)};var u=new o;r.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.invMassSolve,o=r.invMassSolve,a=i.invInertiaWorldSolve,s=r.invInertiaWorldSolve,l=n+o;return a&&(a.vmult(e.rotational,u),l+=u.dot(e.rotational)),s&&(s.vmult(t.rotational,u),l+=u.dot(t.rotational)),l};var d=new o;new o,new o,new o,new o,new o;r.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,r=this.bi,n=this.bj,o=d;t.spatial.mult(r.invMassSolve*e,o),r.vlambda.vadd(o,r.vlambda),i.spatial.mult(n.invMassSolve*e,o),n.vlambda.vadd(o,n.vlambda),r.invInertiaWorldSolve&&(r.invInertiaWorldSolve.vmult(t.rotational,o),o.mult(e,o),r.wlambda.vadd(o,r.wlambda)),n.invInertiaWorldSolve&&(n.invInertiaWorldSolve.vmult(i.rotational,o),o.mult(e,o),n.wlambda.vadd(o,n.wlambda))},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t,i){function r(e,t,i){n.call(this,e,t,-i,i),this.ri=new o,this.rj=new o,this.t=new o}t.exports=r;var n=e("./Equation"),o=e("../math/Vec3");e("../math/Mat3");r.prototype=new n,r.prototype.constructor=r;var a=new o,s=new o;r.prototype.computeB=function(e){var t=(this.a,this.b),i=(this.bi,this.bj,this.ri),r=this.rj,n=a,o=s,l=this.t;i.cross(l,n),r.cross(l,o);var c=this.jacobianElementA,h=this.jacobianElementB;l.negate(c.spatial),n.negate(c.rotational),h.spatial.copy(l),h.rotational.copy(o);var u=this.computeGW(),d=this.computeGiMf(),p=-u*t-e*d;return p}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t,i){function r(e,t,i){i=i||{};var r="undefined"!=typeof i.maxForce?i.maxForce:1e6;o.call(this,e,t,-r,r),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}t.exports=r;var n=e("../math/Vec3"),o=(e("../math/Mat3"),e("./Equation"));r.prototype=new o,r.prototype.constructor=r;var a=new n,s=new n;r.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.axisA,n=this.axisB,o=a,l=s,c=this.jacobianElementA,h=this.jacobianElementB;r.cross(n,o),n.cross(r,l),c.rotational.copy(l),h.rotational.copy(o);var u=Math.cos(this.maxAngle)-r.dot(n),d=this.computeGW(),p=this.computeGiMf(),f=-u*t-d*i-e*p;return f}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t,i){function r(e,t,i){i="undefined"!=typeof i?i:1e6,o.call(this,e,t,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}t.exports=r;var n=e("../math/Vec3"),o=(e("../math/Mat3"),e("./Equation"));r.prototype=new o,r.prototype.constructor=r,r.prototype.computeB=function(e){var t=(this.a,this.b),i=(this.bi,this.bj,this.axisA),r=this.axisB,n=this.jacobianElementA,o=this.jacobianElementB;n.rotational.copy(i),r.negate(o.rotational);var a=this.computeGW()-this.targetVelocity,s=this.computeGiMf(),l=-a*t-e*s;return l}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t,i){function r(e,t,i){i=n.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=r.idCounter++,this.materials=[e,t],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}var n=e("../utils/Utils");t.exports=r,r.idCounter=0},{"../utils/Utils":53}],25:[function(e,t,i){function r(e){var t="";e=e||{},"string"==typeof e?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=r.idCounter++,this.friction="undefined"!=typeof e.friction?e.friction:-1,this.restitution="undefined"!=typeof e.restitution?e.restitution:-1}t.exports=r,r.idCounter=0},{}],26:[function(e,t,i){function r(){this.spatial=new n,this.rotational=new n}t.exports=r;var n=e("./Vec3");r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t,i){function r(e){e?this.elements=e:this.elements=[0,0,0,0,0,0,0,0,0]}t.exports=r;var n=e("./Vec3");r.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},r.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},r.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},r.prototype.getTrace=function(e){var e=e||new n,t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},r.prototype.vmult=function(e,t){t=t||new n;var i=this.elements,r=e.x,o=e.y,a=e.z;return t.x=i[0]*r+i[1]*o+i[2]*a,t.y=i[3]*r+i[4]*o+i[5]*a,t.z=i[6]*r+i[7]*o+i[8]*a,t},r.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},r.prototype.mmult=function(e,t){for(var i=t||new r,n=0;n<3;n++)for(var o=0;o<3;o++){for(var a=0,s=0;s<3;s++)a+=e.elements[n+3*s]*this.elements[s+3*o];i.elements[n+3*o]=a}return i},r.prototype.scale=function(e,t){t=t||new r;for(var i=this.elements,n=t.elements,o=0;3!==o;o++)n[3*o+0]=e.x*i[3*o+0],n[3*o+1]=e.y*i[3*o+1],n[3*o+2]=e.z*i[3*o+2];return t},r.prototype.solve=function(e,t){t=t||new n;for(var i=3,r=4,o=[],a=0;a<i*r;a++)o.push(0);var a,s;for(a=0;a<3;a++)for(s=0;s<3;s++)o[a+r*s]=this.elements[a+3*s];o[3]=e.x,o[7]=e.y,o[11]=e.z;var l,c,h=3,u=h,d=4;do{if(a=u-h,0===o[a+r*a])for(s=a+1;s<u;s++)if(0!==o[a+r*s]){l=d;do c=d-l,o[c+r*a]+=o[c+r*s];while(--l);break}if(0!==o[a+r*a])for(s=a+1;s<u;s++){var p=o[a+r*s]/o[a+r*a];l=d;do c=d-l,o[c+r*s]=c<=a?0:o[c+r*s]-o[c+r*a]*p;while(--l)}}while(--h);if(t.z=o[2*r+3]/o[2*r+2],t.y=(o[1*r+3]-o[1*r+2]*t.z)/o[1*r+1],t.x=(o[0*r+3]-o[0*r+2]*t.z-o[0*r+1]*t.y)/o[0*r+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},r.prototype.e=function(e,t,i){return void 0===i?this.elements[t+3*e]:void(this.elements[t+3*e]=i)},r.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},r.prototype.toString=function(){for(var e="",t=",",i=0;i<9;i++)e+=this.elements[i]+t;return e},r.prototype.reverse=function(e){e=e||new r;for(var t=3,i=6,n=[],o=0;o<t*i;o++)n.push(0);var o,a;for(o=0;o<3;o++)for(a=0;a<3;a++)n[o+i*a]=this.elements[o+3*a];n[3]=1,n[9]=0,n[15]=0,n[4]=0,n[10]=1,n[16]=0,n[5]=0,n[11]=0,n[17]=1;var s,l,c=3,h=c,u=i;do{if(o=h-c,0===n[o+i*o])for(a=o+1;a<h;a++)if(0!==n[o+i*a]){s=u;do l=u-s,n[l+i*o]+=n[l+i*a];while(--s);break}if(0!==n[o+i*o])for(a=o+1;a<h;a++){var d=n[o+i*a]/n[o+i*o];s=u;do l=u-s,n[l+i*a]=l<=o?0:n[l+i*a]-n[l+i*o]*d;while(--s)}}while(--c);o=2;do{a=o-1;do{var d=n[o+i*a]/n[o+i*o];s=i;do l=i-s,n[l+i*a]=n[l+i*a]-n[l+i*o]*d;while(--s)}while(a--)}while(--o);o=2;do{var d=1/n[o+i*o];s=i;do l=i-s,n[l+i*o]=n[l+i*o]*d;while(--s)}while(o--);o=2;do{a=2;do{if(l=n[t+a+i*o],isNaN(l)||l===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(o,a,l)}while(a--)}while(o--);return e},r.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,r=e.z,n=e.w,o=t+t,a=i+i,s=r+r,l=t*o,c=t*a,h=t*s,u=i*a,d=i*s,p=r*s,f=n*o,m=n*a,v=n*s,g=this.elements;return g[0]=1-(u+p),g[1]=c-v,g[2]=h+m,g[3]=c+v,g[4]=1-(l+p),g[5]=d-f,g[6]=h-m,g[7]=d+f,g[8]=1-(l+u),this},r.prototype.transpose=function(e){e=e||new r;for(var t=e.elements,i=this.elements,n=0;3!==n;n++)for(var o=0;3!==o;o++)t[3*n+o]=i[3*o+n];return e}},{"./Vec3":30}],28:[function(e,t,i){function r(e,t,i,r){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==r?r:1}t.exports=r;var n=e("./Vec3");r.prototype.set=function(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r},r.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},r.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},r.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t)},r.prototype.toAxisAngle=function(e){e=e||new n,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var o=new n,a=new n;r.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=o,r=a;e.tangents(i,r),this.setFromAxisAngle(i,Math.PI)}else{var n=e.cross(t);this.x=n.x,this.y=n.y,this.z=n.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}};var s=new n,l=new n,c=new n;r.prototype.mult=function(e,t){t=t||new r;var i=this.w,n=s,o=l,a=c;return n.set(this.x,this.y,this.z),o.set(e.x,e.y,e.z),t.w=i*e.w-n.dot(o),n.cross(o,a),t.x=i*o.x+e.w*n.x+a.x,t.y=i*o.y+e.w*n.y+a.y,t.z=i*o.z+e.w*n.z+a.z,t},r.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,o=this.w;e=e||new r,this.conjugate(e);var a=1/(t*t+i*i+n*n+o*o);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},r.prototype.conjugate=function(e){return e=e||new r,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},r.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},r.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},r.prototype.vmult=function(e,t){t=t||new n;var i=e.x,r=e.y,o=e.z,a=this.x,s=this.y,l=this.z,c=this.w,h=c*i+s*o-l*r,u=c*r+l*i-a*o,d=c*o+a*r-s*i,p=-a*i-s*r-l*o;return t.x=h*c+p*-a+u*-l-d*-s,t.y=u*c+p*-s+d*-a-h*-l,t.z=d*c+p*-l+h*-s-u*-a,t},r.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,
this.w=e.w,this},r.prototype.toEuler=function(e,t){t=t||"YZX";var i,r,n,o=this.x,a=this.y,s=this.z,l=this.w;switch(t){case"YZX":var c=o*a+s*l;if(c>.499&&(i=2*Math.atan2(o,l),r=Math.PI/2,n=0),c<-.499&&(i=-2*Math.atan2(o,l),r=-Math.PI/2,n=0),isNaN(i)){var h=o*o,u=a*a,d=s*s;i=Math.atan2(2*a*l-2*o*s,1-2*u-2*d),r=Math.asin(2*c),n=Math.atan2(2*o*l-2*a*s,1-2*h-2*d)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=r,e.x=n},r.prototype.setFromEuler=function(e,t,i,r){r=r||"XYZ";var n=Math.cos(e/2),o=Math.cos(t/2),a=Math.cos(i/2),s=Math.sin(e/2),l=Math.sin(t/2),c=Math.sin(i/2);return"XYZ"===r?(this.x=s*o*a+n*l*c,this.y=n*l*a-s*o*c,this.z=n*o*c+s*l*a,this.w=n*o*a-s*l*c):"YXZ"===r?(this.x=s*o*a+n*l*c,this.y=n*l*a-s*o*c,this.z=n*o*c-s*l*a,this.w=n*o*a+s*l*c):"ZXY"===r?(this.x=s*o*a-n*l*c,this.y=n*l*a+s*o*c,this.z=n*o*c+s*l*a,this.w=n*o*a-s*l*c):"ZYX"===r?(this.x=s*o*a-n*l*c,this.y=n*l*a+s*o*c,this.z=n*o*c-s*l*a,this.w=n*o*a+s*l*c):"YZX"===r?(this.x=s*o*a+n*l*c,this.y=n*l*a+s*o*c,this.z=n*o*c-s*l*a,this.w=n*o*a-s*l*c):"XZY"===r&&(this.x=s*o*a-n*l*c,this.y=n*l*a-s*o*c,this.z=n*o*c+s*l*a,this.w=n*o*a+s*l*c),this},r.prototype.clone=function(){return new r(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t,i){function r(e){e=e||{},this.position=new n,e.position&&this.position.copy(e.position),this.quaternion=new o,e.quaternion&&this.quaternion.copy(e.quaternion)}var n=e("./Vec3"),o=e("./Quaternion");t.exports=r;var a=new o;r.pointToLocalFrame=function(e,t,i,r){var r=r||new n;return i.vsub(e,r),t.conjugate(a),a.vmult(r,r),r},r.prototype.pointToLocal=function(e,t){return r.pointToLocalFrame(this.position,this.quaternion,e,t)},r.pointToWorldFrame=function(e,t,i,r){var r=r||new n;return t.vmult(i,r),r.vadd(e,r),r},r.prototype.pointToWorld=function(e,t){return r.pointToWorldFrame(this.position,this.quaternion,e,t)},r.prototype.vectorToWorldFrame=function(e,t){var t=t||new n;return this.quaternion.vmult(e,t),t},r.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},r.vectorToLocalFrame=function(e,t,i,r){var r=r||new n;return t.w*=-1,t.vmult(i,r),t.w*=-1,r}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t,i){function r(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}t.exports=r;var n=e("./Mat3");r.ZERO=new r(0,0,0),r.UNIT_X=new r(1,0,0),r.UNIT_Y=new r(0,1,0),r.UNIT_Z=new r(0,0,1),r.prototype.cross=function(e,t){var i=e.x,n=e.y,o=e.z,a=this.x,s=this.y,l=this.z;return t=t||new r,t.x=s*o-l*n,t.y=l*i-a*o,t.z=a*n-s*i,t},r.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},r.prototype.setZero=function(){this.x=this.y=this.z=0},r.prototype.vadd=function(e,t){return t?(t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z,void 0):new r(this.x+e.x,this.y+e.y,this.z+e.z)},r.prototype.vsub=function(e,t){return t?(t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,void 0):new r(this.x-e.x,this.y-e.y,this.z-e.z)},r.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},r.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,r=Math.sqrt(e*e+t*t+i*i);if(r>0){var n=1/r;this.x*=n,this.y*=n,this.z*=n}else this.x=0,this.y=0,this.z=0;return r},r.prototype.unit=function(e){e=e||new r;var t=this.x,i=this.y,n=this.z,o=Math.sqrt(t*t+i*i+n*n);return o>0?(o=1/o,e.x=t*o,e.y=i*o,e.z=n*o):(e.x=1,e.y=0,e.z=0),e},r.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},r.prototype.length=r.prototype.norm,r.prototype.norm2=function(){return this.dot(this)},r.prototype.lengthSquared=r.prototype.norm2,r.prototype.distanceTo=function(e){var t=this.x,i=this.y,r=this.z,n=e.x,o=e.y,a=e.z;return Math.sqrt((n-t)*(n-t)+(o-i)*(o-i)+(a-r)*(a-r))},r.prototype.distanceSquared=function(e){var t=this.x,i=this.y,r=this.z,n=e.x,o=e.y,a=e.z;return(n-t)*(n-t)+(o-i)*(o-i)+(a-r)*(a-r)},r.prototype.mult=function(e,t){t=t||new r;var i=this.x,n=this.y,o=this.z;return t.x=e*i,t.y=e*n,t.z=e*o,t},r.prototype.scale=r.prototype.mult,r.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},r.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},r.prototype.negate=function(e){return e=e||new r,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var o=new r,a=new r;r.prototype.tangents=function(e,t){var i=this.norm();if(i>0){var r=o,n=1/i;r.set(this.x*n,this.y*n,this.z*n);var s=a;Math.abs(r.x)<.9?(s.set(1,0,0),r.cross(s,e)):(s.set(0,1,0),r.cross(s,e)),r.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},r.prototype.toString=function(){return this.x+","+this.y+","+this.z},r.prototype.toArray=function(){return[this.x,this.y,this.z]},r.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},r.prototype.lerp=function(e,t,i){var r=this.x,n=this.y,o=this.z;i.x=r+(e.x-r)*t,i.y=n+(e.y-n)*t,i.z=o+(e.z-o)*t},r.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},r.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var s=new r;r.prototype.isAntiparallelTo=function(e,t){return this.negate(s),s.almostEquals(e,t)},r.prototype.clone=function(){return new r(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t,i){function r(e){e=e||{},n.apply(this),this.id=r.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new o,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new o,e.position&&this.position.copy(e.position),this.previousPosition=new o,this.initPosition=new o,this.velocity=new o,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new o,this.force=new o;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?r.STATIC:r.DYNAMIC,typeof e.type==typeof r.STATIC&&(this.type=e.type),this.allowSleep="undefined"==typeof e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit="undefined"!=typeof e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit="undefined"!=typeof e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new o,this.quaternion=new s,e.quaternion&&this.quaternion.copy(e.quaternion),this.initQuaternion=new s,this.angularVelocity=new o,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new o,this.interpolatedPosition=new o,this.interpolatedQuaternion=new s,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new o,this.invInertia=new o,this.invInertiaWorld=new a,this.invMassSolve=0,this.invInertiaSolve=new o,this.invInertiaWorldSolve=new a,this.fixedRotation="undefined"!=typeof e.fixedRotation&&e.fixedRotation,this.angularDamping="undefined"!=typeof e.angularDamping?e.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new o,e.shape&&this.addShape(e.shape),this.updateMassProperties()}t.exports=r;var n=e("../utils/EventTarget"),o=(e("../shapes/Shape"),e("../math/Vec3")),a=e("../math/Mat3"),s=e("../math/Quaternion"),l=(e("../material/Material"),e("../collision/AABB")),c=e("../shapes/Box");r.prototype=new n,r.prototype.constructor=r,r.DYNAMIC=1,r.STATIC=2,r.KINEMATIC=4,r.AWAKE=0,r.SLEEPY=1,r.SLEEPING=2,r.idCounter=0,r.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===r.SLEEPING&&this.dispatchEvent({type:"wakeup"})},r.prototype.sleep=function(){this.sleepState=r.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},r.sleepyEvent={type:"sleepy"},r.sleepEvent={type:"sleep"},r.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===r.AWAKE&&i<n?(this.sleepState=r.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(r.sleepyEvent)):t===r.SLEEPY&&i>n?this.wakeUp():t===r.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(r.sleepEvent))}},r.prototype.updateSolveMassProperties=function(){this.sleepState===r.SLEEPING||this.type===r.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},r.prototype.pointToLocalFrame=function(e,t){var t=t||new o;return e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},r.prototype.vectorToLocalFrame=function(e,t){var t=t||new o;return this.quaternion.conjugate().vmult(e,t),t},r.prototype.pointToWorldFrame=function(e,t){var t=t||new o;return this.quaternion.vmult(e,t),t.vadd(this.position,t),t},r.prototype.vectorToWorldFrame=function(e,t){var t=t||new o;return this.quaternion.vmult(e,t),t};var h=new o,u=new s;r.prototype.addShape=function(e,t,i){var r=new o,n=new s;return t&&r.copy(t),i&&n.copy(i),this.shapes.push(e),this.shapeOffsets.push(r),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},r.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,r=0,n=0;n!==i;n++){var o=e[n];o.updateBoundingSphereRadius();var a=t[n].norm(),s=o.boundingSphereRadius;a+s>r&&(r=a+s)}this.boundingRadius=r};var d=new l;r.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,r=e.length,n=h,o=u,a=this.quaternion,s=this.aabb,l=d,c=0;c!==r;c++){var p=e[c];i[c].mult(a,o),o.vmult(t[c],n),n.vadd(this.position,n),p.calculateWorldAABB(n,o,l.lowerBound,l.upperBound),0===c?s.copy(l):s.extend(l)}this.aabbNeedsUpdate=!1};var p=new a,f=new a;new a;r.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=p,r=f;i.setRotationFromQuaternion(this.quaternion),i.transpose(r),i.scale(t,i),i.mmult(r,this.invInertiaWorld)}else;};var m=new o,v=new o;r.prototype.applyForce=function(e,t){if(this.type===r.DYNAMIC){var i=m;t.vsub(this.position,i);var n=v;i.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}};var g=new o,y=new o;r.prototype.applyLocalForce=function(e,t){if(this.type===r.DYNAMIC){var i=g,n=y;this.vectorToWorldFrame(e,i),this.pointToWorldFrame(t,n),this.applyForce(i,n)}};var x=new o,b=new o,_=new o;r.prototype.applyImpulse=function(e,t){if(this.type===r.DYNAMIC){var i=x;t.vsub(this.position,i);var n=b;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var o=_;i.cross(e,o),this.invInertiaWorld.vmult(o,o),this.angularVelocity.vadd(o,this.angularVelocity)}};var w=new o,M=new o;r.prototype.applyLocalImpulse=function(e,t){if(this.type===r.DYNAMIC){var i=w,n=M;this.vectorToWorldFrame(e,i),this.pointToWorldFrame(t,n),this.applyImpulse(i,n)}};var E=new o;r.prototype.updateMassProperties=function(){var e=E;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!i?1/t.x:0,t.y>0&&!i?1/t.y:0,t.z>0&&!i?1/t.z:0),this.updateInertiaWorld(!0)},r.prototype.getVelocityAtWorldPoint=function(e,t){var i=new o;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t,i){function r(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!=typeof e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis="undefined"!=typeof e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis="undefined"!=typeof e.indexUpAxis?e.indexUpAxis:2}function n(e,t,i,r,n){var a=0,s=i,l=_,c=w,h=M;e.getVelocityAtWorldPoint(s,l),t.getVelocityAtWorldPoint(s,c),l.vsub(c,h);var u=r.dot(h),d=o(e,i,r),p=o(t,i,r),f=1,m=f/(d+p);return a=-u*m,n<a&&(a=n),a<-n&&(a=-n),a}function o(e,t,i){var r=E,n=S,o=T,a=C;return t.vsub(e.position,r),r.cross(i,n),e.invInertiaWorld.vmult(n,a),a.cross(r,o),e.invMass+i.dot(o)}function a(e,t,i,r,n,o){var a=n.norm2();if(a>1.1)return 0;var s=A,l=P,c=R;e.getVelocityAtWorldPoint(t,s),i.getVelocityAtWorldPoint(r,l),s.vsub(l,c);var h=n.dot(c),u=.2,d=1/(e.invMass+i.invMass),o=-u*h*d;return o}var s=(e("./Body"),e("../math/Vec3")),l=e("../math/Quaternion"),c=(e("../collision/RaycastResult"),e("../collision/Ray")),h=e("../objects/WheelInfo");t.exports=r;var u=(new s,new s,new s,new s),d=new s,p=new s;new c;r.prototype.addWheel=function(e){e=e||{};var t=new h(e),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},r.prototype.setSteeringValue=function(e,t){var i=this.wheelInfos[t];i.steering=e};new s;r.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},r.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},r.prototype.addToWorld=function(e){this.constraints;e.add(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},r.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},r.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,r=this.chassisBody,n=0;n<i;n++)this.updateWheelTransform(n);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var o=new s;this.getVehicleAxisWorld(this.indexForwardAxis,o),o.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var n=0;n<i;n++)this.castRay(t[n]);this.updateSuspension(e);for(var a=new s,l=new s,n=0;n<i;n++){var c=t[n],h=c.suspensionForce;h>c.maxSuspensionForce&&(h=c.maxSuspensionForce),c.raycastResult.hitNormalWorld.scale(h*e,a),c.raycastResult.hitPointWorld.vsub(r.position,l),r.applyImpulse(a,c.raycastResult.hitPointWorld)}this.updateFriction(e);var u=new s,d=new s,p=new s;for(n=0;n<i;n++){var c=t[n];r.getVelocityAtWorldPoint(c.chassisConnectionPointWorld,p);var f=1;switch(this.indexUpAxis){case 1:f=-1}if(c.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,d);var m=d.dot(c.raycastResult.hitNormalWorld);c.raycastResult.hitNormalWorld.scale(m,u),d.vsub(u,d);var v=d.dot(p);c.deltaRotation=f*v*e/c.radius}!c.sliding&&c.isInContact||0===c.engineForce||!c.useCustomSlidingRotationalSpeed||(c.deltaRotation=(c.engineForce>0?1:-1)*c.customSlidingRotationalSpeed*e),Math.abs(c.brake)>Math.abs(c.engineForce)&&(c.deltaRotation=0),c.rotation+=c.deltaRotation,c.deltaRotation*=.99}},r.prototype.updateSuspension=function(e){for(var t=this.chassisBody,i=t.mass,r=this.wheelInfos,n=r.length,o=0;o<n;o++){var a=r[o];if(a.isInContact){var s,l=a.suspensionRestLength,c=a.suspensionLength,h=l-c;s=a.suspensionStiffness*h*a.clippedInvContactDotSuspension;var u,d=a.suspensionRelativeVelocity;u=d<0?a.dampingCompression:a.dampingRelaxation,s-=u*d,a.suspensionForce=s*i,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},r.prototype.removeFromWorld=function(e){this.constraints;e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var f=new s,m=new s;r.prototype.castRay=function(e){var t=f,i=m;this.updateWheelTransformWorld(e);var r=this.chassisBody,n=-1,o=e.suspensionRestLength+e.radius;e.directionWorld.scale(o,t);var a=e.chassisConnectionPointWorld;a.vadd(t,i);var l=e.raycastResult;l.reset();var c=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(a,i,l),r.collisionResponse=c;var h=l.body;if(e.raycastResult.groundObject=0,h){n=l.distance,e.raycastResult.hitNormalWorld=l.hitNormalWorld,e.isInContact=!0;var u=l.distance;e.suspensionLength=u-e.radius;var d=e.suspensionRestLength-e.maxSuspensionTravel,p=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<d&&(e.suspensionLength=d),e.suspensionLength>p&&(e.suspensionLength=p,e.raycastResult.reset());var v=e.raycastResult.hitNormalWorld.dot(e.directionWorld),g=new s;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,g);var y=e.raycastResult.hitNormalWorld.dot(g);if(v>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var x=-1/v;e.suspensionRelativeVelocity=y*x,e.clippedInvContactDotSuspension=x}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return n},r.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},r.prototype.updateWheelTransform=function(e){var t=u,i=d,r=p,n=this.wheelInfos[e];this.updateWheelTransformWorld(n),n.directionLocal.scale(-1,t),i.copy(n.axleLocal),t.cross(i,r),r.normalize(),i.normalize();var o=n.steering,a=new l;a.setFromAxisAngle(t,o);var s=new l;s.setFromAxisAngle(i,n.rotation);var c=n.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,c),c.mult(s,c),c.normalize();var h=n.worldTransform.position;h.copy(n.directionWorld),h.scale(n.suspensionLength,h),h.vadd(n.chassisConnectionPointWorld,h)};var v=[new s(1,0,0),new s(0,1,0),new s(0,0,1)];r.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var g=new s,y=[],x=[],b=1;r.prototype.updateFriction=function(e){for(var t=g,i=this.wheelInfos,r=i.length,o=this.chassisBody,l=x,c=y,h=0,u=0;u<r;u++){var d=i[u],p=d.raycastResult.body;p&&h++,d.sideImpulse=0,d.forwardImpulse=0,l[u]||(l[u]=new s),c[u]||(c[u]=new s)}for(var u=0;u<r;u++){var d=i[u],p=d.raycastResult.body;if(p){var f=c[u],m=this.getWheelTransformWorld(u);m.vectorToWorldFrame(v[this.indexRightAxis],f);var _=d.raycastResult.hitNormalWorld,w=f.dot(_);_.scale(w,t),f.vsub(t,f),f.normalize(),_.cross(f,l[u]),l[u].normalize(),d.sideImpulse=a(o,d.raycastResult.hitPointWorld,p,d.raycastResult.hitPointWorld,f),d.sideImpulse*=b}}var M=1,E=.5;this.sliding=!1;for(var u=0;u<r;u++){var d=i[u],p=d.raycastResult.body,S=0;if(d.slipInfo=1,p){var T=0,C=d.brake?d.brake:T;S=n(o,p,d.raycastResult.hitPointWorld,l[u],C),S+=d.engineForce*e;var A=C/S;d.slipInfo*=A}if(d.forwardImpulse=0,d.skidInfo=1,p){d.skidInfo=1;var P=d.suspensionForce*e*d.frictionSlip,R=P,L=P*R;d.forwardImpulse=S;var B=d.forwardImpulse*E,O=d.sideImpulse*M,I=B*B+O*O;if(d.sliding=!1,I>L){this.sliding=!0,d.sliding=!0;var A=P/Math.sqrt(I);d.skidInfo*=A}}}if(this.sliding)for(var u=0;u<r;u++){var d=i[u];0!==d.sideImpulse&&d.skidInfo<1&&(d.forwardImpulse*=d.skidInfo,d.sideImpulse*=d.skidInfo)}for(var u=0;u<r;u++){var d=i[u],D=new s;if(D.copy(d.raycastResult.hitPointWorld),0!==d.forwardImpulse){var k=new s;l[u].scale(d.forwardImpulse,k),o.applyImpulse(k,D)}if(0!==d.sideImpulse){var p=d.raycastResult.body,F=new s;F.copy(d.raycastResult.hitPointWorld);var N=new s;c[u].scale(d.sideImpulse,N),o.pointToLocalFrame(D,D),D["xyz"[this.indexUpAxis]]*=d.rollInfluence,o.pointToWorldFrame(D,D),o.applyImpulse(N,D),N.scale(-1,N),p.applyImpulse(N,F)}}};var _=new s,w=new s,M=new s,E=new s,S=new s,T=new s,C=new s,A=new s,P=new s,R=new s},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t,i){function r(e){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof e.coordinateSystem?new s(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new a(new s(5,2,.5));this.chassisBody=new n(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var n=e("./Body"),o=e("../shapes/Sphere"),a=e("../shapes/Box"),s=e("../math/Vec3"),l=e("../constraints/HingeConstraint");t.exports=r,r.prototype.addWheel=function(e){e=e||{};var t=e.body;t||(t=new n(1,new o(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0);var i=(new s,"undefined"!=typeof e.position?e.position.clone():new s),r=new s;this.chassisBody.pointToWorldFrame(i,r),t.position.set(r.x,r.y,r.z);var a="undefined"!=typeof e.axis?e.axis.clone():new s(0,1,0);this.wheelAxes.push(a);var c=new l(this.chassisBody,t,{pivotA:i,axisA:a,pivotB:s.ZERO,axisB:a,collideConnected:!1});return this.constraints.push(c),this.wheelBodies.length-1},r.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],r=Math.cos(e),n=Math.sin(e),o=i.x,a=i.y;this.constraints[t].axisA.set(r*o-n*a,n*o+r*a,0)},r.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},r.prototype.disableMotor=function(e){var t=this.constraints[e];t.disableMotor()};var c=new s;r.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},r.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],r=this.wheelBodies[t],n=r.torque;i.scale(e,c),r.vectorToWorldFrame(c,c),n.vadd(c,n)},r.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),r=0;r<i.length;r++)e.add(i[r]);for(var r=0;r<t.length;r++)e.addConstraint(t[r]);e.addEventListener("preStep",this._update.bind(this))},r.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},r.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),r=0;r<i.length;r++)e.remove(i[r]);for(var r=0;r<t.length;r++)e.removeConstraint(t[r])};var h=new s;r.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e],r=i.angularVelocity;return this.chassisBody.vectorToWorldFrame(t,h),r.dot(h)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t,i){function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t.exports=r;var n=(e("../shapes/Shape"),e("../math/Vec3"));e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material");r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);t!==-1&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var o=new n;r.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,r=e.id,n=this.smoothingRadius*this.smoothingRadius,a=o,s=0;s!==i;s++){var l=this.particles[s];l.position.vsub(e.position,a),r!==l.id&&a.norm2()<n&&t.push(l)}};var a=new n,s=new n,l=new n,c=new n,h=new n,u=new n;r.prototype.update=function(){for(var e=this.particles.length,t=a,i=this.speedOfSound,r=this.eps,n=0;n!==e;n++){var o=this.particles[n],d=this.neighbors[n];d.length=0,this.getNeighbors(o,d),d.push(this.particles[n]);for(var p=d.length,f=0,m=0;m!==p;m++){o.position.vsub(d[m].position,t);var v=t.norm(),g=this.w(v);f+=d[m].mass*g}this.densities[n]=f,this.pressures[n]=i*i*(this.densities[n]-this.density)}for(var y=s,x=l,b=c,_=h,w=u,n=0;n!==e;n++){var M=this.particles[n];y.set(0,0,0),x.set(0,0,0);for(var E,S,d=this.neighbors[n],p=d.length,m=0;m!==p;m++){var T=d[m];M.position.vsub(T.position,_);var C=_.norm();E=-T.mass*(this.pressures[n]/(this.densities[n]*this.densities[n]+r)+this.pressures[m]/(this.densities[m]*this.densities[m]+r)),this.gradw(_,b),b.mult(E,b),y.vadd(b,y),T.velocity.vsub(M.velocity,w),w.mult(1/(1e-4+this.densities[n]*this.densities[m])*this.viscosity*T.mass,w),S=this.nablaw(C),w.mult(S,w),x.vadd(w,x)}x.mult(M.mass,x),y.mult(M.mass,y),M.force.vadd(x,M.force),M.force.vadd(y,M.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var i=e.norm(),r=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(r,9))*Math.pow(r*r-i*i,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius,i=945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t);return i}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t,i){function r(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}var n=e("../math/Vec3");t.exports=r,r.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var o=new n,a=new n,s=new n,l=new n,c=new n,h=new n,u=new n,d=new n,p=new n,f=new n,m=new n;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,r=this.bodyA,n=this.bodyB,v=o,g=a,y=s,x=l,b=m,_=c,w=h,M=u,E=d,S=p,T=f;this.getWorldAnchorA(_),this.getWorldAnchorB(w),_.vsub(r.position,M),w.vsub(n.position,E),w.vsub(_,v);var C=v.norm();g.copy(v),g.normalize(),n.velocity.vsub(r.velocity,y),n.angularVelocity.cross(E,b),y.vadd(b,y),r.angularVelocity.cross(M,b),y.vsub(b,y),g.mult(-e*(C-i)-t*y.dot(g),x),r.force.vsub(x,r.force),n.force.vadd(x,n.force),M.cross(x,S),E.cross(x,T),r.torque.vsub(S,r.torque),n.torque.vadd(T,n.torque)}},{"../math/Vec3":30}],36:[function(e,t,i){function r(e){e=s.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new o,this.isInContact=!1}var n=e("../math/Vec3"),o=e("../math/Transform"),a=e("../collision/RaycastResult"),s=e("../utils/Utils");t.exports=r;var l=new n,c=new n,l=new n;r.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,l);var r=t.hitNormalWorld.dot(l);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var n=-1/i;this.suspensionRelativeVelocity=r*n,this.clippedInvContactDotSuspension=n}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t,i){function r(e){n.call(this),this.type=n.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3"),a=e("./ConvexPolyhedron");r.prototype=new n,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,r=o,n=[new r(-e,-t,-i),new r(e,-t,-i),new r(e,t,-i),new r(-e,t,-i),new r(-e,-t,i),new r(e,-t,i),new r(e,t,i),new r(-e,t,i)],s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],l=([new r(0,0,1),new r(0,1,0),new r(1,0,0)],new a(n,s));this.convexPolyhedronRepresentation=l,l.material=this.material},r.prototype.calculateLocalInertia=function(e,t){return t=t||new o,r.calculateInertia(this.halfExtents,e,t),t},r.calculateInertia=function(e,t,i){var r=e;i.x=1/12*t*(2*r.y*2*r.y+2*r.z*2*r.z),i.y=1/12*t*(2*r.x*2*r.x+2*r.z*2*r.z),i.z=1/12*t*(2*r.y*2*r.y+2*r.x*2*r.x)},r.prototype.getSideNormals=function(e,t){var i=e,r=this.halfExtents;if(i[0].set(r.x,0,0),i[1].set(0,r.y,0),i[2].set(0,0,r.z),i[3].set(-r.x,0,0),i[4].set(0,-r.y,0),i[5].set(0,0,-r.z),void 0!==t)for(var n=0;n!==i.length;n++)t.vmult(i[n],i[n]);return i},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var s=new o;new o;r.prototype.forEachWorldCorner=function(e,t,i){for(var r=this.halfExtents,n=[[r.x,r.y,r.z],[-r.x,r.y,r.z],[-r.x,-r.y,r.z],[-r.x,-r.y,-r.z],[r.x,-r.y,-r.z],[r.x,r.y,-r.z],[-r.x,r.y,-r.z],[r.x,-r.y,r.z]],o=0;o<n.length;o++)s.set(n[o][0],n[o][1],n[o][2]),t.vmult(s,s),e.vadd(s,s),i(s.x,s.y,s.z)};var l=[new o,new o,new o,new o,new o,new o,new o,new o];r.prototype.calculateWorldAABB=function(e,t,i,r){var n=this.halfExtents;l[0].set(n.x,n.y,n.z),l[1].set(-n.x,n.y,n.z),l[2].set(-n.x,-n.y,n.z),l[3].set(-n.x,-n.y,-n.z),l[4].set(n.x,-n.y,-n.z),l[5].set(n.x,n.y,-n.z),l[6].set(-n.x,n.y,-n.z),l[7].set(n.x,-n.y,n.z);var o=l[0];t.vmult(o,o),e.vadd(o,o),r.copy(o),i.copy(o);for(var a=1;a<8;a++){var o=l[a];t.vmult(o,o),e.vadd(o,o);var s=o.x,c=o.y,h=o.z;s>r.x&&(r.x=s),c>r.y&&(r.y=c),h>r.z&&(r.z=h),s<i.x&&(i.x=s),c<i.y&&(i.y=c),h<i.z&&(i.z=h)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t,i){function r(e,t,i){n.call(this),this.type=n.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3"),a=(e("../math/Quaternion"),e("../math/Transform"));r.prototype=new n,r.prototype.constructor=r;var s=new o;r.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var r=s,n=0;n!==e.length;n++)for(var o=e[n],a=o.length,l=0;l!==a;l++){var c=(l+1)%a;t[o[l]].vsub(t[o[c]],r),r.normalize();for(var h=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(r)||i[u].almostEquals(r)){h=!0;break}h||i.push(r.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");
var i=this.faceNormals[e]||new o;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var r=this.vertices[this.faces[e][0]];if(i.dot(r)<0){console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}}};var l=new o,c=new o;r.computeNormal=function(e,t,i,r){t.vsub(e,c),i.vsub(t,l),l.cross(c,r),r.isZero()||r.normalize()},r.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],o=this.vertices[i[1]],a=this.vertices[i[2]];return r.computeNormal(n,o,a,t)};var h=new o;r.prototype.clipAgainstHull=function(e,t,i,r,n,a,s,l,c){for(var u=h,d=-1,p=-Number.MAX_VALUE,f=0;f<i.faces.length;f++){u.copy(i.faceNormals[f]),n.vmult(u,u);var m=u.dot(a);m>p&&(p=m,d=f)}for(var v=[],g=i.faces[d],y=g.length,x=0;x<y;x++){var b=i.vertices[g[x]],_=new o;_.copy(b),n.vmult(_,_),r.vadd(_,_),v.push(_)}d>=0&&this.clipFaceAgainstHull(a,e,t,v,s,l,c)};var u=new o,d=new o,p=new o,f=new o,m=new o,v=new o;r.prototype.findSeparatingAxis=function(e,t,i,r,n,o,a,s){var l=u,c=d,h=p,g=f,y=m,x=v,b=Number.MAX_VALUE,_=this,w=0;if(_.uniqueAxes)for(var M=0;M!==_.uniqueAxes.length;M++){i.vmult(_.uniqueAxes[M],l);var E=_.testSepAxis(l,e,t,i,r,n);if(E===!1)return!1;E<b&&(b=E,o.copy(l))}else for(var S=a?a.length:_.faces.length,M=0;M<S;M++){var T=a?a[M]:M;l.copy(_.faceNormals[T]),i.vmult(l,l);var E=_.testSepAxis(l,e,t,i,r,n);if(E===!1)return!1;E<b&&(b=E,o.copy(l))}if(e.uniqueAxes)for(var M=0;M!==e.uniqueAxes.length;M++){n.vmult(e.uniqueAxes[M],c),w++;var E=_.testSepAxis(c,e,t,i,r,n);if(E===!1)return!1;E<b&&(b=E,o.copy(c))}else for(var C=s?s.length:e.faces.length,M=0;M<C;M++){var T=s?s[M]:M;c.copy(e.faceNormals[T]),n.vmult(c,c),w++;var E=_.testSepAxis(c,e,t,i,r,n);if(E===!1)return!1;E<b&&(b=E,o.copy(c))}for(var A=0;A!==_.uniqueEdges.length;A++){i.vmult(_.uniqueEdges[A],g);for(var P=0;P!==e.uniqueEdges.length;P++)if(n.vmult(e.uniqueEdges[P],y),g.cross(y,x),!x.almostZero()){x.normalize();var R=_.testSepAxis(x,e,t,i,r,n);if(R===!1)return!1;R<b&&(b=R,o.copy(x))}}return r.vsub(t,h),h.dot(o)>0&&o.negate(o),!0};var g=[],y=[];r.prototype.testSepAxis=function(e,t,i,n,o,a){var s=this;r.project(s,e,i,n,g),r.project(t,e,o,a,y);var l=g[0],c=g[1],h=y[0],u=y[1];if(l<u||h<c)return!1;var d=l-u,p=h-c,f=d<p?d:p;return f};var x=new o,b=new o;r.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(x,b);var i=b.x-x.x,r=b.y-x.y,n=b.z-x.z;t.x=1/12*e*(2*r*2*r+2*n*2*n),t.y=1/12*e*(2*i*2*i+2*n*2*n),t.z=1/12*e*(2*r*2*r+2*i*2*i)},r.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],r=this.vertices[t[0]],n=-i.dot(r);return n};var _=new o,w=new o,M=new o,E=new o,S=new o,T=new o,C=new o,A=new o;r.prototype.clipFaceAgainstHull=function(e,t,i,r,n,o,a){for(var s=_,l=w,c=M,h=E,u=S,d=T,p=C,f=A,m=this,v=[],g=r,y=v,x=-1,b=Number.MAX_VALUE,P=0;P<m.faces.length;P++){s.copy(m.faceNormals[P]),i.vmult(s,s);var R=s.dot(e);R<b&&(b=R,x=P)}if(!(x<0)){var L=m.faces[x];L.connectedFaces=[];for(var B=0;B<m.faces.length;B++)for(var O=0;O<m.faces[B].length;O++)L.indexOf(m.faces[B][O])!==-1&&B!==x&&L.connectedFaces.indexOf(B)===-1&&L.connectedFaces.push(B);for(var I=(g.length,L.length),D=0;D<I;D++){var k=m.vertices[L[D]],F=m.vertices[L[(D+1)%I]];k.vsub(F,l),c.copy(l),i.vmult(c,c),t.vadd(c,c),h.copy(this.faceNormals[x]),i.vmult(h,h),t.vadd(h,h),c.cross(h,u),u.negate(u),d.copy(k),i.vmult(d,d),t.vadd(d,d);var N,V=(-d.dot(u),L.connectedFaces[D]);p.copy(this.faceNormals[V]);var U=this.getPlaneConstantOfFace(V);f.copy(p),i.vmult(f,f);var N=U-f.dot(t);for(this.clipFaceAgainstPlane(g,y,f,N);g.length;)g.shift();for(;y.length;)g.push(y.shift())}p.copy(this.faceNormals[x]);var U=this.getPlaneConstantOfFace(x);f.copy(p),i.vmult(f,f);for(var N=U-f.dot(t),B=0;B<g.length;B++){var G=f.dot(g[B])+N;if(G<=n&&(console.log("clamped: depth="+G+" to minDist="+(n+"")),G=n),G<=o){var z=g[B];if(G<=0){var j={point:z,normal:f,depth:G};a.push(j)}}}}},r.prototype.clipFaceAgainstPlane=function(e,t,i,r){var n,a,s=e.length;if(s<2)return t;var l=e[e.length-1],c=e[0];n=i.dot(l)+r;for(var h=0;h<s;h++){if(c=e[h],a=i.dot(c)+r,n<0)if(a<0){var u=new o;u.copy(c),t.push(u)}else{var u=new o;l.lerp(c,n/(n-a),u),t.push(u)}else if(a<0){var u=new o;l.lerp(c,n/(n-a),u),t.push(u),t.push(c)}l=c,n=a}return t},r.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new o);for(var r=this.vertices,n=this.worldVertices,a=0;a!==i;a++)t.vmult(r[a],n[a]),e.vadd(n[a],n[a]);this.worldVerticesNeedsUpdate=!1};new o;r.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,r=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var n=0;n<i;n++){var o=r[n];o.x<e.x?e.x=o.x:o.x>t.x&&(t.x=o.x),o.y<e.y?e.y=o.y:o.y>t.y&&(t.y=o.y),o.z<e.z?e.z=o.z:o.z>t.z&&(t.z=o.z)}},r.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new o);for(var i=this.faceNormals,r=this.worldFaceNormals,n=0;n!==t;n++)e.vmult(i[n],r[n]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,r=t.length;i!==r;i++){var n=t[i].norm2();n>e&&(e=n)}this.boundingSphereRadius=Math.sqrt(e)};var P=new o;r.prototype.calculateWorldAABB=function(e,t,i,r){for(var n,o,a,s,l,c,h=this.vertices.length,u=this.vertices,d=0;d<h;d++){P.copy(u[d]),t.vmult(P,P),e.vadd(P,P);var p=P;p.x<n||void 0===n?n=p.x:(p.x>s||void 0===s)&&(s=p.x),p.y<o||void 0===o?o=p.y:(p.y>l||void 0===l)&&(l=p.y),p.z<a||void 0===a?a=p.z:(p.z>c||void 0===c)&&(c=p.z)}i.set(n,o,a),r.set(s,l,c)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(e){e=e||new o;for(var t=this.vertices.length,i=this.vertices,r=0;r<t;r++)e.vadd(i[r],e);return e.mult(1/t,e),e},r.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,r=this.vertices;if(t){for(var n=0;n<i;n++){var o=r[n];t.vmult(o,o)}for(var n=0;n<this.faceNormals.length;n++){var o=this.faceNormals[n];t.vmult(o,o)}}if(e)for(var n=0;n<i;n++){var o=r[n];o.vadd(e,o)}};var R=new o,L=new o,B=new o;r.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,r=this.faces,n=this.faceNormals,o=null,a=this.faces.length,s=R;this.getAveragePointLocal(s);for(var l=0;l<a;l++){var t=(this.faces[l].length,n[l]),c=i[r[l][0]],h=L;e.vsub(c,h);var u=t.dot(h),d=B;s.vsub(c,d);var p=t.dot(d);if(u<0&&p>0||u>0&&p<0)return!1}return o?1:-1};var O=(new o,new o),I=new o;r.project=function(e,t,i,r,n){var o=e.vertices.length,s=O,l=0,c=0,h=I,u=e.vertices;h.setZero(),a.vectorToLocalFrame(i,r,t,s),a.pointToLocalFrame(i,r,h,h);var d=h.dot(s);c=l=u[0].dot(s);for(var p=1;p<o;p++){var f=u[p].dot(s);f>l&&(l=f),f<c&&(c=f)}if(c-=d,l-=d,c>l){var m=c;c=l,l=m}n[0]=l,n[1]=c}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t,i){function r(e,t,i,r){var s=r,l=[],c=[],h=[],u=[],d=[],p=Math.cos,f=Math.sin;l.push(new o(t*p(0),t*f(0),.5*-i)),u.push(0),l.push(new o(e*p(0),e*f(0),.5*i)),d.push(1);for(var m=0;m<s;m++){var v=2*Math.PI/s*(m+1),g=2*Math.PI/s*(m+.5);m<s-1?(l.push(new o(t*p(v),t*f(v),.5*-i)),u.push(2*m+2),l.push(new o(e*p(v),e*f(v),.5*i)),d.push(2*m+3),h.push([2*m+2,2*m+3,2*m+1,2*m])):h.push([0,1,2*m+1,2*m]),(s%2===1||m<s/2)&&c.push(new o(p(g),f(g),0))}h.push(d),c.push(new o(0,0,1));for(var y=[],m=0;m<u.length;m++)y.push(u[u.length-m-1]);h.push(y),this.type=n.types.CONVEXPOLYHEDRON,a.call(this,l,h,c)}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3"),a=(e("../math/Quaternion"),e("./ConvexPolyhedron"));r.prototype=new a},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t,i){function r(e,t){t=s.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this),this.pillarConvex=new o,this.pillarOffset=new a,this.type=n.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var n=e("./Shape"),o=e("./ConvexPolyhedron"),a=e("../math/Vec3"),s=e("../utils/Utils");t.exports=r,r.prototype=new n,r.prototype.update=function(){this._cachedPillars={}},r.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var r=0;r!==e[i].length;r++){var n=e[i][r];n<t&&(t=n)}this.minValue=t},r.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var r=0;r!==e[i].length;r++){var n=e[i][r];n>t&&(t=n)}this.maxValue=t},r.prototype.setHeightValueAtIndex=function(e,t,i){var r=this.data;r[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},r.prototype.getRectMinMax=function(e,t,i,r,n){n=n||[];for(var o=this.data,a=this.minValue,s=e;s<=i;s++)for(var l=t;l<=r;l++){var c=o[s][l];c>a&&(a=c)}n[0]=this.minValue,n[1]=a},r.prototype.getIndexOfPosition=function(e,t,i,r){var n=this.elementSize,o=this.data,a=Math.floor(e/n),s=Math.floor(t/n);return i[0]=a,i[1]=s,r&&(a<0&&(a=0),s<0&&(s=0),a>=o.length-1&&(a=o.length-1),s>=o[0].length-1&&(s=o[0].length-1)),!(a<0||s<0||a>=o.length-1||s>=o[0].length-1)},r.prototype.getHeightAt=function(e,t,i){var r=[];this.getIndexOfPosition(e,t,r,i);var n=[];return this.getRectMinMax(r[0],r[1]+1,r[0],r[1]+1,n),(n[0]+n[1])/2},r.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},r.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},r.prototype.setCachedConvexTrianglePillar=function(e,t,i,r,n){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:r,offset:n}},r.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},r.prototype.getConvexTrianglePillar=function(e,t,i){var r=this.pillarConvex,n=this.pillarOffset;if(this.cacheEnabled){var s=this.getCachedConvexTrianglePillar(e,t,i);if(s)return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);r=new o,n=new a,this.pillarConvex=r,this.pillarOffset=n}var s=this.data,l=this.elementSize,c=r.faces;r.vertices.length=6;for(var h=0;h<6;h++)r.vertices[h]||(r.vertices[h]=new a);c.length=5;for(var h=0;h<5;h++)c[h]||(c[h]=[]);var u=r.vertices,d=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;i?(n.set((e+.75)*l,(t+.75)*l,d),u[0].set(.25*l,.25*l,s[e+1][t+1]-d),u[1].set(-.75*l,.25*l,s[e][t+1]-d),u[2].set(.25*l,-.75*l,s[e+1][t]-d),u[3].set(.25*l,.25*l,-d-1),u[4].set(-.75*l,.25*l,-d-1),u[5].set(.25*l,-.75*l,-d-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=2,c[2][1]=5,c[2][2]=3,c[2][3]=0,c[3][0]=3,c[3][1]=4,c[3][2]=1,c[3][3]=0,c[4][0]=1,c[4][1]=4,c[4][2]=5,c[4][3]=2):(n.set((e+.25)*l,(t+.25)*l,d),u[0].set(-.25*l,-.25*l,s[e][t]-d),u[1].set(.75*l,-.25*l,s[e+1][t]-d),u[2].set(-.25*l,.75*l,s[e][t+1]-d),u[3].set(-.25*l,-.25*l,-d-1),u[4].set(.75*l,-.25*l,-d-1),u[5].set(-.25*l,.75*l,-d-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=0,c[2][1]=2,c[2][2]=5,c[2][3]=3,c[3][0]=1,c[3][1]=0,c[3][2]=3,c[3][3]=4,c[4][0]=4,c[4][1]=5,c[4][2]=2,c[4][3]=1),r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,r,n)},r.prototype.calculateLocalInertia=function(e,t){return t=t||new a,t.set(0,0,0),t},r.prototype.volume=function(){return Number.MAX_VALUE},r.prototype.calculateWorldAABB=function(e,t,i,r){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},r.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new a(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t,i){function r(){n.call(this),this.type=n.types.PARTICLE}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3");r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){return t=t||new o,t.set(0,0,0),t},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(e,t,i,r){i.copy(e),r.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t,i){function r(){n.call(this),this.type=n.types.PLANE,this.worldNormal=new o,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3");r.prototype=new n,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(e,t){return t=t||new o},r.prototype.volume=function(){return Number.MAX_VALUE};var a=new o;r.prototype.calculateWorldAABB=function(e,t,i,r){a.set(0,0,1),t.vmult(a,a);var n=Number.MAX_VALUE;i.set(-n,-n,-n),r.set(n,n,n),1===a.x&&(r.x=e.x),1===a.y&&(r.y=e.y),1===a.z&&(r.z=e.z),a.x===-1&&(i.x=e.x),a.y===-1&&(i.y=e.y),a.z===-1&&(i.z=e.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t,i){function r(){this.id=r.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}t.exports=r;var r=e("./Shape");e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material");r.prototype.constructor=r,r.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},r.idCounter=0,r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t,i){function r(e){if(n.call(this),this.radius=void 0!==e?Number(e):1,this.type=n.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3");r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){t=t||new o;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(e,t,i,r){for(var n=this.radius,o=["x","y","z"],a=0;a<o.length;a++){var s=o[a];i[s]=e[s]-n,r[s]=e[s]+n}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t,i){function r(e,t){n.call(this),this.type=n.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new s,this.edges=null,this.scale=new o(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}t.exports=r;var n=e("./Shape"),o=e("../math/Vec3"),a=(e("../math/Quaternion"),e("../math/Transform")),s=e("../collision/AABB"),l=e("../utils/Octree");r.prototype=new n,r.prototype.constructor=r;var c=new o;r.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new s,r=new o,n=new o,a=new o,l=[r,n,a],c=0;c<this.indices.length/3;c++){var h=3*c;this._getUnscaledVertex(this.indices[h],r),this._getUnscaledVertex(this.indices[h+1],n),this._getUnscaledVertex(this.indices[h+2],a),i.setFromPoints(l),e.insert(i,c)}e.removeEmptyNodes()};var h=new s;r.prototype.getTrianglesInAABB=function(e,t){h.copy(e);var i=this.scale,r=i.x,n=i.y,o=i.z,a=h.lowerBound,s=h.upperBound;return a.x/=r,a.y/=n,a.z/=o,s.x/=r,s.y/=n,s.z/=o,this.tree.aabbQuery(h,t)},r.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},r.prototype.updateNormals=function(){for(var e=c,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,o=this.indices[n],a=this.indices[n+1],s=this.indices[n+2];this.getVertex(o,m),this.getVertex(a,v),this.getVertex(s,g),r.computeNormal(v,m,g,e),t[n]=e.x,t[n+1]=e.y,t[n+2]=e.z}},r.prototype.updateEdges=function(){for(var e={},t=function(t,i){var r=n<o?n+"_"+o:o+"_"+n;e[r]=!0},i=0;i<this.indices.length/3;i++){var r=3*i,n=this.indices[r],o=this.indices[r+1],a=this.indices[r+2];t(n,o),t(o,a),t(a,n)}var s=Object.keys(e);this.edges=new Int16Array(2*s.length);for(var i=0;i<s.length;i++){var l=s[i].split("_");this.edges[2*i]=parseInt(l[0],10),this.edges[2*i+1]=parseInt(l[1],10)}},r.prototype.getEdgeVertex=function(e,t,i){var r=this.edges[2*e+(t?1:0)];this.getVertex(r,i)};var u=new o,d=new o;r.prototype.getEdgeVector=function(e,t){var i=u,r=d;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,r),r.vsub(i,t)};var p=new o,f=new o;r.computeNormal=function(e,t,i,r){t.vsub(e,f),i.vsub(t,p),p.cross(f,r),r.isZero()||r.normalize()};var m=new o,v=new o,g=new o;r.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},r.prototype._getUnscaledVertex=function(e,t){var i=3*e,r=this.vertices;return t.set(r[i],r[i+1],r[i+2])},r.prototype.getWorldVertex=function(e,t,i,r){return this.getVertex(e,r),a.pointToWorldFrame(t,i,r,r),r},r.prototype.getTriangleVertices=function(e,t,i,r){var n=3*e;this.getVertex(this.indices[n],t),this.getVertex(this.indices[n+1],i),this.getVertex(this.indices[n+2],r)},r.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[i+1],this.normals[i+2])};var y=new s;r.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y);var i=y.upperBound.x-y.lowerBound.x,r=y.upperBound.y-y.lowerBound.y,n=y.upperBound.z-y.lowerBound.z;return t.set(1/12*e*(2*r*2*r+2*n*2*n),1/12*e*(2*i*2*i+2*n*2*n),1/12*e*(2*r*2*r+2*i*2*i))};var x=new o;r.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,r=this.vertices.length,n=(this.vertices,x);this.getVertex(0,n),t.copy(n),i.copy(n);for(var o=0;o!==r;o++)this.getVertex(o,n),n.x<t.x?t.x=n.x:n.x>i.x&&(i.x=n.x),n.y<t.y?t.y=n.y:n.y>i.y&&(i.y=n.y),n.z<t.z?t.z=n.z:n.z>i.z&&(i.z=n.z)},r.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},r.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new o,r=0,n=t.length/3;r!==n;r++){this.getVertex(r,i);var a=i.norm2();a>e&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)};var b=(new o,new a),_=new s;r.prototype.calculateWorldAABB=function(e,t,i,r){var n=b,o=_;n.position=e,n.quaternion=t,this.aabb.toWorldFrame(n,o),i.copy(o.lowerBound),r.copy(o.upperBound)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.createTorus=function(e,t,i,n,o){e=e||1,t=t||.5,i=i||8,n=n||6,o=o||2*Math.PI;for(var a=[],s=[],l=0;l<=i;l++)for(var c=0;c<=n;c++){var h=c/n*o,u=l/i*Math.PI*2,d=(e+t*Math.cos(u))*Math.cos(h),p=(e+t*Math.cos(u))*Math.sin(h),f=t*Math.sin(u);a.push(d,p,f)}for(var l=1;l<=i;l++)for(var c=1;c<=n;c++){var m=(n+1)*l+c-1,v=(n+1)*(l-1)+c-1,g=(n+1)*(l-1)+c,y=(n+1)*l+c;s.push(m,v,y),s.push(v,g,y)}return new r(a,s)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t,i){function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}t.exports=r;var n=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver"));r.prototype=new n;var o=[],a=[],s=[];r.prototype.solve=function(e,t){var i,r,n,l,c,h,u=0,d=this.iterations,p=this.tolerance*this.tolerance,f=this.equations,m=f.length,v=t.bodies,g=v.length,y=e;if(0!==m)for(var x=0;x!==g;x++)v[x].updateSolveMassProperties();var b=a,_=s,w=o;b.length=m,_.length=m,w.length=m;for(var x=0;x!==m;x++){var M=f[x];w[x]=0,_[x]=M.computeB(y),b[x]=1/M.computeC()}if(0!==m){for(var x=0;x!==g;x++){var E=v[x],S=E.vlambda,T=E.wlambda;S.set(0,0,0),T&&T.set(0,0,0)}for(u=0;u!==d;u++){l=0;for(var C=0;C!==m;C++){var M=f[C];i=_[C],r=b[C],h=w[C],c=M.computeGWlambda(),n=r*(i-c-M.eps*h),h+n<M.minForce?n=M.minForce-h:h+n>M.maxForce&&(n=M.maxForce-h),w[C]+=n,l+=n>0?n:-n,M.addToWlambda(n)}if(l*l<p)break}for(var x=0;x!==g;x++){var E=v[x],A=E.velocity,P=E.angularVelocity;A.vadd(E.vlambda,A),P&&P.vadd(E.wlambda,P)}}return u}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t,i){function r(){this.equations=[]}t.exports=r,r.prototype.solve=function(e,t){return 0},r.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},r.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);i!==-1&&t.splice(i,1)},r.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t,i){function r(e){for(l.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function n(e){for(var t=e.length,i=0;i!==t;i++){var r=e[i];if(!(r.visited||r.body.type&p))return r}return!1}function o(e,t,i,r){for(f.push(e),e.visited=!0,t(e,i,r);f.length;)for(var o,a=f.pop();o=n(a.children);)o.visited=!0,t(o,i,r),f.push(o)}function a(e,t,i){t.push(e.body);for(var r=e.eqs.length,n=0;n!==r;n++){var o=e.eqs[n];i.indexOf(o)===-1&&i.push(o)}}function s(e,t){return t.id-e.id}t.exports=r;var l=(e("../math/Vec3"),e("../math/Quaternion"),e("./Solver")),c=e("../objects/Body");r.prototype=new l;var h=[],u=[],d={bodies:[]},p=c.STATIC,f=[];r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(e,t){for(var i=h,r=this.nodePool,l=t.bodies,c=this.equations,p=c.length,f=l.length,m=this.subsolver;r.length<f;)r.push(this.createNode());i.length=f;for(var v=0;v<f;v++)i[v]=r[v];for(var v=0;v!==f;v++){var g=i[v];g.body=l[v],g.children.length=0,g.eqs.length=0,g.visited=!1}for(var y=0;y!==p;y++){var x=c[y],v=l.indexOf(x.bi),b=l.indexOf(x.bj),_=i[v],w=i[b];_.children.push(w),_.eqs.push(x),w.children.push(_),w.eqs.push(x)}var M,E=0,S=u;m.tolerance=this.tolerance,m.iterations=this.iterations;for(var T=d;M=n(i);){S.length=0,T.bodies.length=0,o(M,a,T.bodies,S);var C=S.length;S=S.sort(s);for(var v=0;v!==C;v++)m.addEquation(S[v]);m.solve(e,T);m.removeAllEquations(),E++}return E}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t,i){var r=function(){};t.exports=r,r.prototype={constructor:r,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&i[e].indexOf(t)!==-1},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var r=i[e].indexOf(t);return r!==-1&&i[e].splice(r,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners,i=t[e.type];if(void 0!==i){e.target=this;for(var r=0,n=i.length;r<n;r++)i[r].call(this,e)}return this}}},{}],50:[function(e,t,i){function r(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new o,this.data=[],this.children=[]}function n(e,t){t=t||{},t.root=null,t.aabb=e,r.call(this,t),this.maxDepth="undefined"!=typeof t.maxDepth?t.maxDepth:8}var o=e("../collision/AABB"),a=e("../math/Vec3");t.exports=n,n.prototype=new r,r.prototype.reset=function(e,t){this.children.length=this.data.length=0},r.prototype.insert=function(e,t,i){var r=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var n=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var o=!1;n.length||(this.subdivide(),o=!0);for(var a=0;8!==a;a++)if(n[a].insert(e,t,i+1))return!0;o&&(n.length=0)}return r.push(t),!0};var s=new a;r.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,n=this.children;n.push(new r({aabb:new o({lowerBound:new a(0,0,0)})}),new r({aabb:new o({lowerBound:new a(1,0,0)})}),new r({aabb:new o({lowerBound:new a(1,1,0)})}),new r({aabb:new o({lowerBound:new a(1,1,1)})}),new r({aabb:new o({lowerBound:new a(0,1,1)})}),new r({aabb:new o({lowerBound:new a(0,0,1)})}),new r({aabb:new o({lowerBound:new a(1,0,1)})}),new r({aabb:new o({lowerBound:new a(0,1,0)})})),i.vsub(t,s),s.scale(.5,s);for(var l=this.root||this,c=0;8!==c;c++){var h=n[c];h.root=l;var u=h.aabb.lowerBound;u.x*=s.x,u.y*=s.y,u.z*=s.z,u.vadd(t,u),u.vadd(s,h.aabb.upperBound)}},r.prototype.aabbQuery=function(e,t){for(var i=(this.data,this.children,[this]);i.length;){var r=i.pop();r.aabb.overlaps(e)&&Array.prototype.push.apply(t,r.data),Array.prototype.push.apply(i,r.children)}return t};var l=new o;r.prototype.rayQuery=function(e,t,i){return e.getAABB(l),l.toLocalFrame(t,l),this.aabbQuery(l,i),i},r.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;i>=0;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t,i){function r(){this.objects=[],this.type=Object}t.exports=r,r.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t])},r.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},r.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t,i){function r(){this.data={keys:[]}}t.exports=r,r.prototype.get=function(e,t){if(e>t){var i=t;t=e,e=i}return this.data[e+"-"+t]},r.prototype.set=function(e,t,i){if(e>t){var r=t;t=e,e=r}var n=e+"-"+t;this.get(e,t)||this.data.keys.push(n),this.data[n]=i},r.prototype.reset=function(){for(var e=this.data,t=e.keys;t.length>0;){var i=t.pop();delete e[i]}}},{}],53:[function(e,t,i){function r(){}t.exports=r,r.defaults=function(e,t){e=e||{};for(var i in t)i in e||(e[i]=t[i]);return e}},{}],54:[function(e,t,i){function r(){o.call(this),this.type=n}t.exports=r;var n=e("../math/Vec3"),o=e("./Pool");r.prototype=new o,r.prototype.constructObject=function(){return new n}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t,i){function r(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new u,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function n(e,t,i){for(var r=null,n=e.length,o=0;o!==n;o++){var a=e[o],s=G;e[(o+1)%n].vsub(a,s);var l=z;s.cross(t,l);var c=j;i.vsub(a,c);var h=l.dot(c);if(!(null===r||h>0&&r===!0||h<=0&&r===!1))return!1;null===r&&(r=h>0)}return!0}t.exports=r;var o=e("../collision/AABB"),a=e("../shapes/Shape"),s=e("../collision/Ray"),l=e("../math/Vec3"),c=e("../math/Transform"),h=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),u=(e("../solver/Solver"),e("../utils/Vec3Pool")),d=e("../equations/ContactEquation"),p=e("../equations/FrictionEquation");r.prototype.createContactEquation=function(e,t,i,r,n,o){var a;this.contactPointPool.length?(a=this.contactPointPool.pop(),a.bi=e,a.bj=t):a=new d(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&i.collisionResponse&&r.collisionResponse;var s=this.currentContactMaterial;a.restitution=s.restitution,a.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,c=r.material||t.material;return l&&c&&l.restitution>=0&&c.restitution>=0&&(a.restitution=l.restitution*c.restitution),a.si=n||i,a.sj=o||r,a},r.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,r=e.bj,n=e.si,o=e.sj,a=this.world,s=this.currentContactMaterial,l=s.friction,c=n.material||i.material,h=o.material||r.material;if(c&&h&&c.friction>=0&&h.friction>=0&&(l=c.friction*h.friction),l>0){var u=l*a.gravity.length(),d=i.invMass+r.invMass;d>0&&(d=1/d);var f=this.frictionEquationPool,m=f.length?f.pop():new p(i,r,u*d),v=f.length?f.pop():new p(i,r,u*d);return m.bi=v.bi=i,m.bj=v.bj=r,m.minForce=v.minForce=-u*d,m.maxForce=v.maxForce=u*d,m.ri.copy(e.ri),m.rj.copy(e.rj),v.ri.copy(e.ri),v.rj.copy(e.rj),e.ni.tangents(m.t,v.t),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),v.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),m.enabled=v.enabled=e.enabled,t.push(m,v),!0}return!1};var f=new l,m=new l,v=new l;r.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],r=this.frictionResult[this.frictionResult.length-1];f.setZero(),m.setZero(),v.setZero();for(var n=t.bi,o=(t.bj,0);o!==e;o++)t=this.result[this.result.length-1-o],t.bodyA!==n?(f.vadd(t.ni,f),m.vadd(t.ri,m),v.vadd(t.rj,v)):(f.vsub(t.ni,f),m.vadd(t.rj,m),v.vadd(t.ri,v));var a=1/e;m.scale(a,i.ri),v.scale(a,i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj),f.normalize(),f.tangents(i.t,r.t)}};var g=new l,y=new l,x=new h,b=new h;r.prototype.getContacts=function(e,t,i,r,n,o,a){this.contactPointPool=n,this.frictionEquationPool=a,this.result=r,this.frictionResult=o;for(var s=x,l=b,c=g,h=y,u=0,d=e.length;u!==d;u++){var p=e[u],f=t[u],m=null;p.material&&f.material&&(m=i.getContactMaterial(p.material,f.material)||null);for(var v=0;v<p.shapes.length;v++){p.quaternion.mult(p.shapeOrientations[v],s),p.quaternion.vmult(p.shapeOffsets[v],c),c.vadd(p.position,c);for(var _=p.shapes[v],w=0;w<f.shapes.length;w++){f.quaternion.mult(f.shapeOrientations[w],l),f.quaternion.vmult(f.shapeOffsets[w],h),h.vadd(f.position,h);var M=f.shapes[w];if(!(c.distanceTo(h)>_.boundingSphereRadius+M.boundingSphereRadius)){var E=null;_.material&&M.material&&(E=i.getContactMaterial(_.material,M.material)||null),this.currentContactMaterial=E||m||i.defaultContactMaterial;var S=this[_.type|M.type];S&&(_.type<M.type?S.call(this,_,M,c,h,s,l,p,f,_,M):S.call(this,M,_,h,c,l,s,f,p,_,M))}}}}};r.prototype[a.types.BOX|a.types.BOX]=r.prototype.boxBox=function(e,t,i,r,n,o,a,s){e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,r,n,o,a,s,e,t)},r.prototype[a.types.BOX|a.types.CONVEXPOLYHEDRON]=r.prototype.boxConvex=function(e,t,i,r,n,o,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,r,n,o,a,s,e,t)},r.prototype[a.types.BOX|a.types.PARTICLE]=r.prototype.boxParticle=function(e,t,i,r,n,o,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,r,n,o,a,s,e,t)},r.prototype[a.types.SPHERE]=r.prototype.sphereSphere=function(e,t,i,r,n,o,a,s){
var l=this.createContactEquation(a,s,e,t);r.vsub(i,l.ni),l.ni.normalize(),l.ri.copy(l.ni),l.rj.copy(l.ni),l.ri.mult(e.radius,l.ri),l.rj.mult(-t.radius,l.rj),l.ri.vadd(i,l.ri),l.ri.vsub(a.position,l.ri),l.rj.vadd(r,l.rj),l.rj.vsub(s.position,l.rj),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)};var _=new l,w=new l,M=new l;r.prototype[a.types.PLANE|a.types.TRIMESH]=r.prototype.planeTrimesh=function(e,t,i,r,n,o,a,s){var h=new l,u=_;u.set(0,0,1),n.vmult(u,u);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,h);var p=new l;p.copy(h),c.pointToWorldFrame(r,o,p,h);var f=w;h.vsub(i,f);var m=u.dot(f);if(m<=0){var v=this.createContactEquation(a,s,e,t);v.ni.copy(u);var g=M;u.scale(f.dot(u),g),h.vsub(g,g),v.ri.copy(g),v.ri.vsub(a.position,v.ri),v.rj.copy(h),v.rj.vsub(s.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}};var E=new l,S=new l,T=(new l,new l),C=new l,A=new l,P=new l,R=new l,L=new l,B=new l,O=new l,I=new l,D=new l,k=new l,F=new o,N=[];r.prototype[a.types.SPHERE|a.types.TRIMESH]=r.prototype.sphereTrimesh=function(e,t,i,r,n,o,a,l){var h=A,u=P,d=R,p=L,f=B,m=O,v=F,g=C,y=S,x=N;c.pointToLocalFrame(r,o,i,f);var b=e.radius;v.lowerBound.set(f.x-b,f.y-b,f.z-b),v.upperBound.set(f.x+b,f.y+b,f.z+b),t.getTrianglesInAABB(v,x);for(var _=T,w=e.radius*e.radius,M=0;M<x.length;M++)for(var V=0;V<3;V++)if(t.getVertex(t.indices[3*x[M]+V],_),_.vsub(f,y),y.norm2()<=w){g.copy(_),c.pointToWorldFrame(r,o,g,_),_.vsub(i,y);var U=this.createContactEquation(a,l,e,t);U.ni.copy(y),U.ni.normalize(),U.ri.copy(U.ni),U.ri.scale(e.radius,U.ri),U.ri.vadd(i,U.ri),U.ri.vsub(a.position,U.ri),U.rj.copy(_),U.rj.vsub(l.position,U.rj),this.result.push(U),this.createFrictionEquationsFromContact(U,this.frictionResult)}for(var M=0;M<x.length;M++)for(var V=0;V<3;V++){t.getVertex(t.indices[3*x[M]+V],h),t.getVertex(t.indices[3*x[M]+(V+1)%3],u),u.vsub(h,d),f.vsub(u,m);var G=m.dot(d);f.vsub(h,m);var z=m.dot(d);if(z>0&&G<0){f.vsub(h,m),p.copy(d),p.normalize(),z=m.dot(p),p.scale(z,m),m.vadd(h,m);var j=m.distanceTo(f);if(j<e.radius){var U=this.createContactEquation(a,l,e,t);m.vsub(f,U.ni),U.ni.normalize(),U.ni.scale(e.radius,U.ri),c.pointToWorldFrame(r,o,m,m),m.vsub(l.position,U.rj),c.vectorToWorldFrame(o,U.ni,U.ni),c.vectorToWorldFrame(o,U.ri,U.ri),this.result.push(U),this.createFrictionEquationsFromContact(U,this.frictionResult)}}}for(var H=I,W=D,q=k,X=E,M=0,Y=x.length;M!==Y;M++){t.getTriangleVertices(x[M],H,W,q),t.getNormal(x[M],X),f.vsub(H,m);var j=m.dot(X);if(X.scale(j,m),f.vsub(m,m),j=m.distanceTo(f),s.pointInTriangle(m,H,W,q)&&j<e.radius){var U=this.createContactEquation(a,l,e,t);m.vsub(f,U.ni),U.ni.normalize(),U.ni.scale(e.radius,U.ri),c.pointToWorldFrame(r,o,m,m),m.vsub(l.position,U.rj),c.vectorToWorldFrame(o,U.ni,U.ni),c.vectorToWorldFrame(o,U.ri,U.ri),this.result.push(U),this.createFrictionEquationsFromContact(U,this.frictionResult)}}x.length=0};var V=new l,U=new l;r.prototype[a.types.SPHERE|a.types.PLANE]=r.prototype.spherePlane=function(e,t,i,r,n,o,a,s){var l=this.createContactEquation(a,s,e,t);if(l.ni.set(0,0,1),o.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(e.radius,l.ri),i.vsub(r,V),l.ni.mult(l.ni.dot(V),U),V.vsub(U,l.rj),-V.dot(l.ni)<=e.radius){var c=l.ri,h=l.rj;c.vadd(i,c),c.vsub(a.position,c),h.vadd(r,h),h.vsub(s.position,h),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var G=new l,z=new l,j=new l,H=new l,W=new l,q=new l,X=new l,Y=[new l,new l,new l,new l,new l,new l],K=new l,Q=new l,Z=new l,J=new l;r.prototype[a.types.SPHERE|a.types.BOX]=r.prototype.sphereBox=function(e,t,i,r,n,o,a,s){var l=this.v3pool,c=Y;i.vsub(r,H),t.getSideNormals(c,o);for(var h=e.radius,u=!1,d=Q,p=Z,f=J,m=null,v=0,g=0,y=0,x=null,b=0,_=c.length;b!==_&&u===!1;b++){var w=W;w.copy(c[b]);var M=w.norm();w.normalize();var E=H.dot(w);if(E<M+h&&E>0){var S=q,T=X;S.copy(c[(b+1)%3]),T.copy(c[(b+2)%3]);var C=S.norm(),A=T.norm();S.normalize(),T.normalize();var P=H.dot(S),R=H.dot(T);if(P<C&&P>-C&&R<A&&R>-A){var L=Math.abs(E-M-h);(null===x||L<x)&&(x=L,g=P,y=R,m=M,d.copy(w),p.copy(S),f.copy(T),v++)}}}if(v){u=!0;var B=this.createContactEquation(a,s,e,t);d.mult(-h,B.ri),B.ni.copy(d),B.ni.negate(B.ni),d.mult(m,d),p.mult(g,p),d.vadd(p,d),f.mult(y,f),d.vadd(f,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(a.position,B.ri),B.rj.vadd(r,B.rj),B.rj.vsub(s.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var O=l.get(),I=K,D=0;2!==D&&!u;D++)for(var k=0;2!==k&&!u;k++)for(var F=0;2!==F&&!u;F++)if(O.set(0,0,0),D?O.vadd(c[0],O):O.vsub(c[0],O),k?O.vadd(c[1],O):O.vsub(c[1],O),F?O.vadd(c[2],O):O.vsub(c[2],O),r.vadd(O,I),I.vsub(i,I),I.norm2()<h*h){u=!0;var B=this.createContactEquation(a,s,e,t);B.ri.copy(I),B.ri.normalize(),B.ni.copy(B.ri),B.ri.mult(h,B.ri),B.rj.copy(O),B.ri.vadd(i,B.ri),B.ri.vsub(a.position,B.ri),B.rj.vadd(r,B.rj),B.rj.vsub(s.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}l.release(O),O=null;for(var N=l.get(),V=l.get(),B=l.get(),U=l.get(),L=l.get(),G=c.length,D=0;D!==G&&!u;D++)for(var k=0;k!==G&&!u;k++)if(D%3!==k%3){c[k].cross(c[D],N),N.normalize(),c[D].vadd(c[k],V),B.copy(i),B.vsub(V,B),B.vsub(r,B);var z=B.dot(N);N.mult(z,U);for(var F=0;F===D%3||F===k%3;)F++;L.copy(i),L.vsub(U,L),L.vsub(V,L),L.vsub(r,L);var j=Math.abs(z),$=L.norm();if(j<c[F].norm()&&$<h){u=!0;var ee=this.createContactEquation(a,s,e,t);V.vadd(U,ee.rj),ee.rj.copy(ee.rj),L.negate(ee.ni),ee.ni.normalize(),ee.ri.copy(ee.rj),ee.ri.vadd(r,ee.ri),ee.ri.vsub(i,ee.ri),ee.ri.normalize(),ee.ri.mult(h,ee.ri),ee.ri.vadd(i,ee.ri),ee.ri.vsub(a.position,ee.ri),ee.rj.vadd(r,ee.rj),ee.rj.vsub(s.position,ee.rj),this.result.push(ee),this.createFrictionEquationsFromContact(ee,this.frictionResult)}}l.release(N,V,B,U,L)};var $=new l,ee=new l,te=new l,ie=new l,re=new l,ne=new l,oe=new l,ae=new l,se=new l,le=new l;r.prototype[a.types.SPHERE|a.types.CONVEXPOLYHEDRON]=r.prototype.sphereConvex=function(e,t,i,r,o,a,s,l){var c=this.v3pool;i.vsub(r,$);for(var h=t.faceNormals,u=t.faces,d=t.vertices,p=e.radius,f=0;f!==d.length;f++){var m=d[f],v=re;a.vmult(m,v),r.vadd(v,v);var g=ie;if(v.vsub(i,g),g.norm2()<p*p){x=!0;var y=this.createContactEquation(s,l,e,t);return y.ri.copy(g),y.ri.normalize(),y.ni.copy(y.ri),y.ri.mult(p,y.ri),v.vsub(r,y.rj),y.ri.vadd(i,y.ri),y.ri.vsub(s.position,y.ri),y.rj.vadd(r,y.rj),y.rj.vsub(l.position,y.rj),this.result.push(y),void this.createFrictionEquationsFromContact(y,this.frictionResult)}}for(var x=!1,f=0,b=u.length;f!==b&&x===!1;f++){var _=h[f],w=u[f],M=ne;a.vmult(_,M);var E=oe;a.vmult(d[w[0]],E),E.vadd(r,E);var S=ae;M.mult(-p,S),i.vadd(S,S);var T=se;S.vsub(E,T);var C=T.dot(M),A=le;if(i.vsub(E,A),C<0&&A.dot(M)>0){for(var P=[],R=0,L=w.length;R!==L;R++){var B=c.get();a.vmult(d[w[R]],B),r.vadd(B,B),P.push(B)}if(n(P,M,i)){x=!0;var y=this.createContactEquation(s,l,e,t);M.mult(-p,y.ri),M.negate(y.ni);var O=c.get();M.mult(-C,O);var I=c.get();M.mult(-p,I),i.vsub(r,y.rj),y.rj.vadd(I,y.rj),y.rj.vadd(O,y.rj),y.rj.vadd(r,y.rj),y.rj.vsub(l.position,y.rj),y.ri.vadd(i,y.ri),y.ri.vsub(s.position,y.ri),c.release(O),c.release(I),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult);for(var R=0,D=P.length;R!==D;R++)c.release(P[R]);return}for(var R=0;R!==w.length;R++){var k=c.get(),F=c.get();a.vmult(d[w[(R+1)%w.length]],k),a.vmult(d[w[(R+2)%w.length]],F),r.vadd(k,k),r.vadd(F,F);var N=ee;F.vsub(k,N);var V=te;N.unit(V);var U=c.get(),G=c.get();i.vsub(k,G);var z=G.dot(V);V.mult(z,U),U.vadd(k,U);var j=c.get();if(U.vsub(i,j),z>0&&z*z<N.norm2()&&j.norm2()<p*p){var y=this.createContactEquation(s,l,e,t);U.vsub(r,y.rj),U.vsub(i,y.ni),y.ni.normalize(),y.ni.mult(p,y.ri),y.rj.vadd(r,y.rj),y.rj.vsub(l.position,y.rj),y.ri.vadd(i,y.ri),y.ri.vsub(s.position,y.ri),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult);for(var R=0,D=P.length;R!==D;R++)c.release(P[R]);return c.release(k),c.release(F),c.release(U),c.release(j),void c.release(G)}c.release(k),c.release(F),c.release(U),c.release(j),c.release(G)}for(var R=0,D=P.length;R!==D;R++)c.release(P[R])}}};new l,new l;r.prototype[a.types.PLANE|a.types.BOX]=r.prototype.planeBox=function(e,t,i,r,n,o,a,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.planeConvex(e,t.convexPolyhedronRepresentation,i,r,n,o,a,s)};var ce=new l,he=new l,ue=new l,de=new l;r.prototype[a.types.PLANE|a.types.CONVEXPOLYHEDRON]=r.prototype.planeConvex=function(e,t,i,r,n,o,a,s){var l=ce,c=he;c.set(0,0,1),n.vmult(c,c);for(var h=0,u=ue,d=0;d!==t.vertices.length;d++){l.copy(t.vertices[d]),o.vmult(l,l),r.vadd(l,l),l.vsub(i,u);var p=c.dot(u);if(p<=0){var f=this.createContactEquation(a,s,e,t),m=de;c.mult(c.dot(u),m),l.vsub(m,m),m.vsub(i,f.ri),f.ni.copy(c),l.vsub(r,f.rj),f.ri.vadd(i,f.ri),f.ri.vsub(a.position,f.ri),f.rj.vadd(r,f.rj),f.rj.vsub(s.position,f.rj),this.result.push(f),h++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(f,this.frictionResult)}}this.enableFrictionReduction&&h&&this.createFrictionFromAverage(h)};var pe=new l,fe=new l;r.prototype[a.types.CONVEXPOLYHEDRON]=r.prototype.convexConvex=function(e,t,i,r,n,o,a,s,l,c,h,u){var d=pe;if(!(i.distanceTo(r)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,n,r,o,d,h,u)){var p=[],f=fe;e.clipAgainstHull(i,n,t,r,o,d,-100,100,p);for(var m=0,v=0;v!==p.length;v++){var g=this.createContactEquation(a,s,e,t,l,c),y=g.ri,x=g.rj;d.negate(g.ni),p[v].normal.negate(f),f.mult(p[v].depth,f),p[v].point.vadd(f,y),x.copy(p[v].point),y.vsub(i,y),x.vsub(r,x),y.vadd(i,y),y.vsub(a.position,y),x.vadd(r,x),x.vsub(s.position,x),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var me=new l,ve=new l,ge=new l;r.prototype[a.types.PLANE|a.types.PARTICLE]=r.prototype.planeParticle=function(e,t,i,r,n,o,a,s){var l=me;l.set(0,0,1),a.quaternion.vmult(l,l);var c=ve;r.vsub(a.position,c);var h=l.dot(c);if(h<=0){var u=this.createContactEquation(s,a,t,e);u.ni.copy(l),u.ni.negate(u.ni),u.ri.set(0,0,0);var d=ge;l.mult(l.dot(r),d),r.vsub(d,d),u.rj.copy(d),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}};var ye=new l;r.prototype[a.types.PARTICLE|a.types.SPHERE]=r.prototype.sphereParticle=function(e,t,i,r,n,o,a,s){var l=ye;l.set(0,0,1),r.vsub(i,l);var c=l.norm2();if(c<=e.radius*e.radius){var h=this.createContactEquation(s,a,t,e);l.normalize(),h.rj.copy(l),h.rj.mult(e.radius,h.rj),h.ni.copy(l),h.ni.negate(h.ni),h.ri.set(0,0,0),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var xe=new h,be=new l,_e=(new l,new l),we=new l,Me=new l;r.prototype[a.types.PARTICLE|a.types.CONVEXPOLYHEDRON]=r.prototype.convexParticle=function(e,t,i,r,n,o,a,s){var l=-1,c=_e,h=Me,u=null,d=0,p=be;if(p.copy(r),p.vsub(i,p),n.conjugate(xe),xe.vmult(p,p),e.pointIsInside(p)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,n),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(n);for(var f=0,m=e.faces.length;f!==m;f++){var v=[e.worldVertices[e.faces[f][0]]],g=e.worldFaceNormals[f];r.vsub(v[0],we);var y=-g.dot(we);(null===u||Math.abs(y)<Math.abs(u))&&(u=y,l=f,c.copy(g),d++)}if(l!==-1){var x=this.createContactEquation(s,a,t,e);c.mult(u,h),h.vadd(r,h),h.vsub(i,h),x.rj.copy(h),c.negate(x.ni),x.ri.set(0,0,0);var b=x.ri,_=x.rj;b.vadd(r,b),b.vsub(s.position,b),_.vadd(i,_),_.vsub(a.position,_),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},r.prototype[a.types.BOX|a.types.HEIGHTFIELD]=r.prototype.boxHeightfield=function(e,t,i,r,n,o,a,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,r,n,o,a,s)};var Ee=new l,Se=new l,Te=[0];r.prototype[a.types.CONVEXPOLYHEDRON|a.types.HEIGHTFIELD]=r.prototype.convexHeightfield=function(e,t,i,r,n,o,a,s){var l=t.data,h=t.elementSize,u=e.boundingSphereRadius,d=Se,p=Te,f=Ee;c.pointToLocalFrame(r,o,i,f);var m=Math.floor((f.x-u)/h)-1,v=Math.ceil((f.x+u)/h)+1,g=Math.floor((f.y-u)/h)-1,y=Math.ceil((f.y+u)/h)+1;if(!(v<0||y<0||m>l.length||g>l[0].length)){m<0&&(m=0),v<0&&(v=0),g<0&&(g=0),y<0&&(y=0),m>=l.length&&(m=l.length-1),v>=l.length&&(v=l.length-1),y>=l[0].length&&(y=l[0].length-1),g>=l[0].length&&(g=l[0].length-1);var x=[];t.getRectMinMax(m,g,v,y,x);var b=x[0],_=x[1];if(!(f.z-u>_||f.z+u<b))for(var w=m;w<v;w++)for(var M=g;M<y;M++)t.getConvexTrianglePillar(w,M,!1),c.pointToWorldFrame(r,o,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,i,d,n,o,a,s,null,null,p,null),t.getConvexTrianglePillar(w,M,!0),c.pointToWorldFrame(r,o,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,i,d,n,o,a,s,null,null,p,null)}};var Ce=new l,Ae=new l;r.prototype[a.types.SPHERE|a.types.HEIGHTFIELD]=r.prototype.sphereHeightfield=function(e,t,i,r,n,o,a,s){var l=t.data,h=e.radius,u=t.elementSize,d=Ae,p=Ce;c.pointToLocalFrame(r,o,i,p);var f=Math.floor((p.x-h)/u)-1,m=Math.ceil((p.x+h)/u)+1,v=Math.floor((p.y-h)/u)-1,g=Math.ceil((p.y+h)/u)+1;if(!(m<0||g<0||f>l.length||g>l[0].length)){f<0&&(f=0),m<0&&(m=0),v<0&&(v=0),g<0&&(g=0),f>=l.length&&(f=l.length-1),m>=l.length&&(m=l.length-1),g>=l[0].length&&(g=l[0].length-1),v>=l[0].length&&(v=l[0].length-1);var y=[];t.getRectMinMax(f,v,m,g,y);var x=y[0],b=y[1];if(!(p.z-h>b||p.z+h<x))for(var _=this.result,w=f;w<m;w++)for(var M=v;M<g;M++){var E=_.length;t.getConvexTrianglePillar(w,M,!1),c.pointToWorldFrame(r,o,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,i,d,n,o,a,s),t.getConvexTrianglePillar(w,M,!0),c.pointToWorldFrame(r,o,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,i,d,n,o,a,s);var S=_.length-E;if(S>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t,i){function r(){c.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new o,this.broadphase=new y,this.bodies=[],this.solver=new s,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new h,this.collisionMatrixPrevious=new h,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new f,this.defaultMaterial=new u("default"),this.defaultContactMaterial=new d(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}t.exports=r;var n=e("../shapes/Shape"),o=e("../math/Vec3"),a=e("../math/Quaternion"),s=e("../solver/GSSolver"),l=(e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),c=e("../utils/EventTarget"),h=e("../collision/ArrayCollisionMatrix"),u=e("../material/Material"),d=e("../material/ContactMaterial"),p=e("../objects/Body"),f=e("../utils/TupleDictionary"),m=e("../collision/RaycastResult"),v=e("../collision/AABB"),g=e("../collision/Ray"),y=e("../collision/NaiveBroadphase");r.prototype=new c;var x=(new v,new g);if(r.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},r.prototype.numObjects=function(){return this.bodies.length},r.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},r.prototype.add=r.prototype.addBody=function(e){this.bodies.indexOf(e)===-1&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof p&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},r.prototype.addConstraint=function(e){this.constraints.push(e)},r.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);t!==-1&&this.constraints.splice(t,1)},r.prototype.rayTest=function(e,t,i){i instanceof m?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},r.prototype.raycastAll=function(e,t,i,r){return i.mode=g.ALL,i.from=e,i.to=t,i.callback=r,x.intersectWorld(this,i)},r.prototype.raycastAny=function(e,t,i,r){return i.mode=g.ANY,i.from=e,i.to=t,i.result=r,x.intersectWorld(this,i)},r.prototype.raycastClosest=function(e,t,i,r){return i.mode=g.CLOSEST,i.from=e,i.to=t,i.result=r,x.intersectWorld(this,i)},r.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,r=i.indexOf(e);if(r!==-1){i.splice(r,1);for(var n=0;n!==i.length;n++)i[n].index=n;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},r.prototype.removeBody=r.prototype.remove,r.prototype.addMaterial=function(e){this.materials.push(e)},r.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var b=Date.now();performance.timing&&performance.timing.navigationStart&&(b=performance.timing.navigationStart),performance.now=function(){return Date.now()-b}}var _=new o;r.prototype.step=function(e,t,i){if(i=i||10,t=t||0,0===t)this.internalStep(e),this.time+=e;else{var r=Math.floor((this.time+t)/e)-Math.floor(this.time/e);r=Math.min(r,i);for(var n=performance.now(),o=0;o!==r&&(this.internalStep(e),!(performance.now()-n>1e3*e));o++);this.time+=t;for(var a=this.time%e,s=a/e,l=_,c=this.bodies,h=0;h!==c.length;h++){var u=c[h];u.type!==p.STATIC&&u.sleepState!==p.SLEEPING?(u.position.vsub(u.previousPosition,l),l.scale(s,l),u.position.vadd(l,u.interpolatedPosition)):(u.interpolatedPosition.copy(u.position),u.interpolatedQuaternion.copy(u.quaternion))}}};var w={type:"postStep"},M={type:"preStep"},E={type:"collide",body:null,contact:null},S=[],T=[],C=[],A=[],P=(new o,new o,new o,new o,new o,new o,new o,new o,new o,new a,new a),R=new a,L=new o;r.prototype.internalStep=function(e){this.dt=e;var t,i=this.contacts,r=C,o=A,a=this.numObjects(),s=this.bodies,l=this.solver,c=this.gravity,h=this.doProfiling,u=this.profile,d=p.DYNAMIC,f=this.constraints,m=T,v=(c.norm(),c.x),g=c.y,y=c.z,x=0;for(h&&(t=performance.now()),x=0;x!==a;x++){var b=s[x];if(b.type&d){var _=b.force,B=b.mass;_.x+=B*v,_.y+=B*g,_.z+=B*y}}for(var x=0,O=this.subsystems.length;x!==O;x++)this.subsystems[x].update();h&&(t=performance.now()),r.length=0,o.length=0,this.broadphase.collisionPairs(this,r,o),h&&(u.broadphase=performance.now()-t);var I=f.length;for(x=0;x!==I;x++){var D=f[x];if(!D.collideConnected)for(var k=r.length-1;k>=0;k-=1)(D.bodyA===r[k]&&D.bodyB===o[k]||D.bodyB===r[k]&&D.bodyA===o[k])&&(r.splice(k,1),o.splice(k,1))}this.collisionMatrixTick(),h&&(t=performance.now());var F=S,N=i.length;for(x=0;x!==N;x++)F.push(i[x]);i.length=0;var V=this.frictionEquations.length;for(x=0;x!==V;x++)m.push(this.frictionEquations[x]);this.frictionEquations.length=0,this.narrowphase.getContacts(r,o,this,i,F,this.frictionEquations,m),h&&(u.narrowphase=performance.now()-t),h&&(t=performance.now());for(var x=0;x<this.frictionEquations.length;x++)l.addEquation(this.frictionEquations[x]);for(var U=i.length,G=0;G!==U;G++){var z,D=i[G],b=D.bi,j=D.bj;D.si,D.sj;z=b.material&&j.material?this.getContactMaterial(b.material,j.material)||this.defaultContactMaterial:this.defaultContactMaterial;var H=z.friction;if(b.material&&j.material&&(b.material.friction>=0&&j.material.friction>=0&&(H=b.material.friction*j.material.friction),b.material.restitution>=0&&j.material.restitution>=0&&(D.restitution=b.material.restitution*j.material.restitution)),l.addEquation(D),b.allowSleep&&b.type===p.DYNAMIC&&b.sleepState===p.SLEEPING&&j.sleepState===p.AWAKE&&j.type!==p.STATIC){var W=j.velocity.norm2()+j.angularVelocity.norm2(),q=Math.pow(j.sleepSpeedLimit,2);W>=2*q&&(b._wakeUpAfterNarrowphase=!0)}if(j.allowSleep&&j.type===p.DYNAMIC&&j.sleepState===p.SLEEPING&&b.sleepState===p.AWAKE&&b.type!==p.STATIC){var X=b.velocity.norm2()+b.angularVelocity.norm2(),Y=Math.pow(b.sleepSpeedLimit,2);X>=2*Y&&(j._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(b,j,!0),this.collisionMatrixPrevious.get(b,j)||(E.body=j,E.contact=D,b.dispatchEvent(E),E.body=b,j.dispatchEvent(E))}for(h&&(u.makeContactConstraints=performance.now()-t,t=performance.now()),x=0;x!==a;x++){var b=s[x];b._wakeUpAfterNarrowphase&&(b.wakeUp(),b._wakeUpAfterNarrowphase=!1)}var I=f.length;for(x=0;x!==I;x++){var D=f[x];D.update();for(var k=0,K=D.equations.length;k!==K;k++){var Q=D.equations[k];l.addEquation(Q)}}l.solve(e,this),h&&(u.solve=performance.now()-t),l.removeAllEquations();var Z=Math.pow;for(x=0;x!==a;x++){var b=s[x];if(b.type&d){var J=Z(1-b.linearDamping,e),$=b.velocity;$.mult(J,$);var ee=b.angularVelocity;if(ee){var te=Z(1-b.angularDamping,e);ee.mult(te,ee)}}}for(this.dispatchEvent(M),x=0;x!==a;x++){var b=s[x];b.preStep&&b.preStep.call(b)}h&&(t=performance.now());var ie=P,re=R,ne=this.stepnumber,oe=p.DYNAMIC|p.KINEMATIC,ae=ne%(this.quatNormalizeSkip+1)===0,se=this.quatNormalizeFast,le=.5*e;n.types.PLANE,n.types.CONVEXPOLYHEDRON;for(x=0;x!==a;x++){var ce=s[x],he=ce.force,ue=ce.torque;if(ce.type&oe&&ce.sleepState!==p.SLEEPING){var de=ce.velocity,pe=ce.angularVelocity,fe=ce.position,me=ce.quaternion,ve=ce.invMass,ge=ce.invInertiaWorld;de.x+=he.x*ve*e,de.y+=he.y*ve*e,de.z+=he.z*ve*e,ce.angularVelocity&&(ge.vmult(ue,L),L.mult(e,L),L.vadd(pe,pe)),fe.x+=de.x*e,fe.y+=de.y*e,fe.z+=de.z*e,ce.angularVelocity&&(ie.set(pe.x,pe.y,pe.z,0),ie.mult(me,re),me.x+=le*re.x,me.y+=le*re.y,me.z+=le*re.z,me.w+=le*re.w,ae&&(se?me.normalizeFast():me.normalize())),ce.aabb&&(ce.aabbNeedsUpdate=!0),ce.updateInertiaWorld&&ce.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,h&&(u.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(w),x=0;x!==a;x++){var b=s[x],ye=b.postStep;ye&&ye.call(b)}if(this.allowSleep)for(x=0;x!==a;x++)s[x].sleepTick(this.time)},r.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var r=e[i];r.force,r.torque;r.force.set(0,0,0),r.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})}),TEMP=new Vector3,InsideSphereGeometry=function(e){function t(e,i,r,n,o,a,s){classCallCheck(this,t);var l=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));l.type="InsideSphereGeometry",l.parameters={radius:e,widthSegments:i,heightSegments:r,phiStart:n,phiLength:o,thetaStart:a,thetaLength:s},e=e||50,i=Math.max(3,Math.floor(i)||8),r=Math.max(2,Math.floor(r)||6),n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI,a=void 0!==a?a:0,s=void 0!==s?s:Math.PI;var c,h,u=[],d=[];for(h=0;h<=r;h++){var p=[],f=[];for(c=i;c>=0;c--){var m=c/i,v=h/r,g=new Vector3;g.x=-e*Math.cos(n+m*o)*Math.sin(a+v*s),g.y=e*Math.cos(a+v*s),g.z=e*Math.sin(n+m*o)*Math.sin(a+v*s),l.vertices.push(g),p.push(l.vertices.length-1),f.push(new Vector2(1-m,1-v))}u.push(p),d.push(f)}for(h=0;h<r;h++)for(c=0;c<i;c++){var y=u[h][c+1],x=u[h][c],b=u[h+1][c],_=u[h+1][c+1],w=l.vertices[y].clone().normalize(),M=l.vertices[x].clone().normalize(),E=l.vertices[b].clone().normalize(),S=l.vertices[_].clone().normalize(),T=d[h][c+1].clone(),C=d[h][c].clone(),A=d[h+1][c].clone(),P=d[h+1][c+1].clone();Math.abs(l.vertices[y].y)===e?(T.x=(T.x+C.x)/2,l.faces.push(new Face3(y,b,_,[w,E,S])),l.faceVertexUvs[0].push([T,A,P])):Math.abs(l.vertices[b].y)===e?(A.x=(A.x+P.x)/2,l.faces.push(new Face3(y,x,b,[w,M,E])),l.faceVertexUvs[0].push([T,C,A])):(l.faces.push(new Face3(y,x,_,[w,M,S])),l.faceVertexUvs[0].push([T,C,P]),l.faces.push(new Face3(x,b,_,[M.clone(),E,S.clone()])),l.faceVertexUvs[0].push([C.clone(),A,P.clone()]))}l.computeFaceNormals();for(var R=0;R<l.faces.length;++R){var L=l.faces[R];L.normal.multiplyScalar(-1);for(var B=0;B<L.vertexNormals.length;++B)L.vertexNormals[B].multiplyScalar(-1)}return l.boundingSphere=new Sphere(new Vector3,e),l}return inherits(t,e),t}(Geometry),SLICE=.45,Component=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"preStep",value:function(){}},{key:"postStep",value:function(){}},{key:"update",value:function(){}}]),e}(),Spring=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(e.rigidBody||console.error("Object A has no rigidBody",e),i.rigidBody||console.error("Object B has no rigidBody",e),!e.rigidBody||!e.rigidBody)throw new Error("invalid argument");return n._spring=new cannon.Spring(e.rigidBody,i.rigidBody,r),n}return inherits(t,e),createClass(t,[{key:"postStep",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"postStep",this).call(this),this._spring.applyForce()}}]),t}(Component),index$2={axis:axis,box:box,brick:brick,camera:camera,circle:circle,cloud:cloud,colored:colored,cylinder:cylinder,hub:hub,light:light,material:material,phys:phys,quad:quad,quat:quat,range:range,raycaster:raycaster,ring:ring,shell:shell,sphere:sphere,spring:spring,textured:textured,v2:v2,v3:v3,v4:v4},liveAPI=Object.freeze({axis:axis,box:box,brick:brick,camera:camera,circle:circle,cloud:cloud,colored:colored,cylinder:cylinder,hub:hub,light:light,material:material,phys:phys,quad:quad,quat:quat,range:range,raycaster:raycaster,ring:ring,shell:shell,sphere:sphere,spring:spring,textured:textured,v2:v2,v3:v3,v4:v4,default:index$2});BufferGeometry.prototype.center=Geometry.prototype.center=function(){this.computeBoundingBox();var e=this.boundingBox,t=(e.max.x+e.min.x)/2,i=(e.max.y+e.min.y)/2,r=(e.max.z+e.min.z)/2;return this.offset(-t,-i,-r)},BufferGeometry.prototype.colored=Geometry.prototype.colored=Mesh.prototype.colored=function(e,t){return colored(this,e,t)},CubeTextureLoader.prototype.load=function(e,t,i,r){var n=new CubeTexture,o=new ImageLoader(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);for(var a=0,s=0;s<e.length;++s)o.load(e[s],function(e){n.images[s]=e,++a,6===a&&(n.needsUpdate=!0,t&&t(n))}.bind(null,s),i,r);return n},Object3D.prototype.emit=EventDispatcher.prototype.emit=function(e,t){t||(t={}),"object"!==("undefined"==typeof t?"undefined":_typeof(t))||t instanceof Event||(t.type=e,void 0===t.defaultPrevented&&(t.defaultPrevented=!1,t.preventDefault=function(){return t.defaultPrevented=!0})),this.dispatchEvent(t)},Object3D.prototype.dispatchEvent=EventDispatcher.prototype.dispatchEvent=function(e){if(void 0!==this._listeners){var t=this._listeners,i=t[e.type];if(void 0!==i){e instanceof Event||(e.target=this);var r=[],n=0,o=i.length;for(n=0;n<o;n++)r[n]=i[n];for(n=0;n<o;n++)r[n].call(this,e)}}},Object3D.prototype.watch=EventDispatcher.prototype.watch=function(e,t){var i=this;return t instanceof Array||(t=[t]),t.forEach(function(t){return e.addEventListener(t,i.dispatchEvent.bind(i))}),this},Object3D.prototype.route=EventDispatcher.prototype.route=function(e,t){var i=this;return e.forEach(function(e){return i.addEventListener(e,t)}),this},Object3D.prototype.on=EventDispatcher.prototype.on=function(e,t){return this.addEventListener(e,t),this},Matrix4.prototype.toString=function(e){void 0===e&&(e=10),this.transpose();var t=this.toArray();if(this.transpose(),void 0!==e)for(var i=0;i<t.length;++i);for(var r="",n=0;n<t.length;++n)n%4===0&&(r+="| "),r+=Math.sign(t[n])===-1?"-":" ",r+=null!==t[n]&&void 0!==t[n]?Math.abs(t[n]).toFixed(e):"undefined".substring(0,e),r+=n%4===3?" |\n":", ";return r};var MTLLoader=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=void 0!==e?e:DefaultLoadingManager,i}return inherits(t,e),createClass(t,[{key:"load",value:function(e,t,i,r){var n=this,o=new FileLoader(this.manager);o.setPath(this.path),o.load(e,function(e){t(n.parse(e))},i,r)}},{key:"setPath",value:function(e){this.path=e}},{key:"setTexturePath",value:function(e){this.texturePath=e}},{key:"setBaseUrl",value:function(e){console.warn("MTLLoader: .setBaseUrl() is deprecated. Use .setTexturePath( path ) for texture path or .setPath( path ) for general base path instead."),this.setTexturePath(e)}},{key:"setCrossOrigin",value:function(e){this.crossOrigin=e}},{key:"setMaterialOptions",value:function(e){this.materialOptions=e}},{key:"parse",value:function(e){for(var t=e.split("\n"),i={},r=/\s+/,n={},o=0;o<t.length;o++){var a=t[o];if(a=a.trim(),0!==a.length&&"#"!==a.charAt(0)){var s=a.indexOf(" "),l=s>=0?a.substring(0,s):a;l=l.toLowerCase();var c=s>=0?a.substring(s+1):"";if(c=c.trim(),"newmtl"===l)i={name:c},n[c]=i;else if(i)if("ka"===l||"kd"===l||"ks"===l){var h=c.split(r,3);i[l]=[parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2])]}else i[l]=c}}var u=new MaterialCreator(this.texturePath||this.path,this.materialOptions);return u.setCrossOrigin(this.crossOrigin),u.setManager(this.manager),u.setMaterials(n),u}}]),t}(EventDispatcher),MaterialCreator=function(){function e(t,i){classCallCheck(this,e),this.baseUrl=t||"",this.options=i,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:RepeatWrapping}return createClass(e,[{key:"setCrossOrigin",value:function(e){this.crossOrigin=e}},{key:"setManager",value:function(e){this.manager=e}},{key:"setMaterials",value:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}}},{key:"convert",value:function(e){if(!this.options)return e;var t={};for(var i in e){var r=e[i],n={};t[i]=n;for(var o in r){var a=!0,s=r[o],l=o.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(s=[s[0]/255,s[1]/255,s[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===s[0]&&0===s[1]&&0===s[2]&&(a=!1)}a&&(n[l]=s)}}return t}},{key:"preload",value:function(){for(var e in this.materialsInfo)this.create(e)}},{key:"getIndex",value:function(e){return this.nameLookup[e]}},{key:"getAsArray",value:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray}},{key:"create",value:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]}},{key:"createMaterial_",value:function(e){function t(e,t){if(!o[e]){var i=r.getTextureParams(t,o),n=r.loadTexture(a(r.baseUrl,i.url));n.repeat.copy(i.scale),n.offset.copy(i.offset),n.wrapS=r.wrap,n.wrapT=r.wrap,o[e]=n}}var i=MeshPhongMaterial,r=this,n=this.materialsInfo[e],o={name:e,side:this.side},a=function(e,t){return"string"!=typeof t||""===t?"":/^https?:\/\//i.test(t)?t:e+t;
};for(var s in n){var l=n[s];if(""!==l)switch(s.toLowerCase()){case"kd":o.color=(new Color).fromArray(l);break;case"ks":o.specular=(new Color).fromArray(l);break;case"map_kd":t("map",l);break;case"map_ks":t("specularMap",l);break;case"map_bump":case"bump":t("bumpMap",l);break;case"ns":o.shininess=parseFloat(l);break;case"d":l<1&&(o.opacity=l,o.transparent=!0);break;case"illum":l=parseFloat(l),l===MTLLoader.COLOR_ON_AND_AMBIENT_OFF&&(i=MeshBasicMaterial);break;case"Tr":l>0&&(o.opacity=1-l,o.transparent=!0)}}return i===MeshBasicMaterial&&["shininess","specular"].forEach(function(e){e in o&&delete o[e]}),this.materials[e]=new i(o),this.materials[e]}},{key:"getTextureParams",value:function(e,t){var i,r={scale:new Vector2(1,1),offset:new Vector2(0,0)},n=e.split(/\s+/);return i=n.indexOf("-bm"),i>=0&&(t.bumpScale=parseFloat(n[i+1]),n.splice(i,2)),i=n.indexOf("-s"),i>=0&&(r.scale.set(parseFloat(n[i+1]),parseFloat(n[i+2])),n.splice(i,4)),i=n.indexOf("-o"),i>=0&&(r.offset.set(parseFloat(n[i+1]),parseFloat(n[i+2])),n.splice(i,4)),r.url=n.join(" ").trim(),r}},{key:"loadTexture",value:function(e,t,i,r,n){var o,a=Loader.Handlers.get(e),s=void 0!==this.manager?this.manager:DefaultLoadingManager;return null===a&&(a=new TextureLoader(s)),a.setCrossOrigin&&a.setCrossOrigin(this.crossOrigin),o=a.load(e,i,r,n),void 0!==t&&(o.mapping=t),o}}]),e}();Object.assign(MTLLoader,{COLOR_ON_AND_AMBIENT_OFF:0,COLOR_ON_AND_AMBIENT_ON:1,HIGHLIGHT_ON:2,REFLECTION_ON_AND_RAY_TRACE_ON:3,TRANSPARENCY_GLASS_ON_REFLECTION_RAY_TRACE_ON:4,REFLECTION_FRESNEL_ON_AND_RAY_TRACE_ON:5,TRANSPARENCY_REFRACTION_ON_REFLECTION_FRESNEL_OFF_AND_RAY_TRACE_ON:6,TRANSPARENCY_REFRACTION_ON_REFLECTION_FRESNEL_ON_AND_RAY_TRACE_ON:7,REFLECTION_ON_AND_RAY_TRACE_OFF:8,TRANSPARENCY_GLASS_ON_REFLECTION_RAY_TRACE_OFF:9,CASTS_SHADOWS_ONTO_INVISIBLE_SURFACES:10}),Object3D.prototype.appendChild=function(e){return this.add(e)},Object.defineProperty(Object3D.prototype,"pickable",{get:function(){var e=this._listeners;return e&&(e.enter&&e.enter.length>0||e.exit&&e.exit.length>0||e.select&&e.select.length>0||e.useraction&&e.useraction.length>0||e.pointerstart&&e.pointerstart.length>0||e.pointerend&&e.pointerend.length>0||e.pointermove&&e.pointermove.length>0||e.gazestart&&e.gazestart.length>0||e.gazecancel&&e.gazecancel.length>0||e.gazemove&&e.gazemove.length>0||e.gazecomplete&&e.gazecomplete.length>0)}}),Object3D.prototype.latLng=function(e,t,i){return e=-Math.PI*(e||0)/180,t=Math.PI*(t||0)/180,i=i||1.5,this.rotation.set(e,t,0,"XYZ"),this.position.set(0,0,-i),this.position.applyQuaternion(this.quaternion),this},Object3D.prototype.named=function(e){return this.name=e,this},Object3D.prototype.addTo=function(e){return e.add(this),this},Object3D.prototype.at=function(e,t,i){return this.position.set(e,t,i),this},Object3D.prototype.rot=function(e,t,i){return this.rotation.set(e,t,i),this},Object3D.prototype.scl=function(e,t,i){return this.scale.set(e,t,i),this},Object.defineProperty(Object3D.prototype,"visible",{get:function(){return this._visible},set:function(e){var t=this._visible;this._visible=e,t!==e&&this.emit("visiblechanged")}});var OBJLoader=function(){function e(t){classCallCheck(this,e),this.manager=void 0!==t?t:DefaultLoadingManager,this.materials=null,this.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}}return createClass(e,[{key:"load",value:function(e,t,i,r){var n=this,o=new FileLoader(n.manager);o.setPath(this.path),o.load(e,function(e){t(n.parse(e))},i,r)}},{key:"setPath",value:function(e){this.path=e}},{key:"setMaterials",value:function(e){this.materials=e}},{key:"_createParserState",value:function(){var e=new OBJParserState;return e.startObject("",!1),e}},{key:"parse",value:function(e){console.time("OBJLoader");var t=this._createParserState();e.indexOf("\r\n")!==-1&&(e=e.replace("\r\n","\n"));for(var i=e.split("\n"),r="",n="",o="",a=0,s=[],l="function"==typeof"".trimLeft,c=0,h=i.length;c<h;c++)if(r=i[c],r=l?r.trimLeft():r.trim(),a=r.length,0!==a&&(n=r.charAt(0),"#"!==n))if("v"===n)if(o=r.charAt(1)," "===o&&null!==(s=this.regexp.vertex_pattern.exec(r)))t.vertices.push(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));else if("n"===o&&null!==(s=this.regexp.normal_pattern.exec(r)))t.normals.push(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));else{if("t"!==o||null===(s=this.regexp.uv_pattern.exec(r)))throw new Error("Unexpected vertex/normal/uv line: '"+r+"'");t.uvs.push(parseFloat(s[1]),parseFloat(s[2]))}else if("f"===n)if(null!==(s=this.regexp.face_vertex_uv_normal.exec(r)))t.addFace(s[1],s[4],s[7],s[10],s[2],s[5],s[8],s[11],s[3],s[6],s[9],s[12]);else if(null!==(s=this.regexp.face_vertex_uv.exec(r)))t.addFace(s[1],s[3],s[5],s[7],s[2],s[4],s[6],s[8]);else if(null!==(s=this.regexp.face_vertex_normal.exec(r)))t.addFace(s[1],s[3],s[5],s[7],void 0,void 0,void 0,void 0,s[2],s[4],s[6],s[8]);else{if(null===(s=this.regexp.face_vertex.exec(r)))throw new Error("Unexpected face line: '"+r+"'");t.addFace(s[1],s[2],s[3],s[4])}else if("l"===n){var u=r.substring(1).trim().split(" "),d=[],p=[];if(r.indexOf("/")===-1)d=u;else for(var f=0,m=u.length;f<m;f++){var v=u[f].split("/");""!==v[0]&&d.push(v[0]),""!==v[1]&&p.push(v[1])}t.addLineGeometry(d,p)}else if(null!==(s=this.regexp.object_pattern.exec(r))){var g=s[0].substr(1).trim();t.startObject(g)}else if(this.regexp.material_use_pattern.test(r))t.object.startMaterial(r.substring(7).trim(),t.materialLibraries);else if(this.regexp.material_library_pattern.test(r))t.materialLibraries.push(r.substring(7).trim());else{if(null===(s=this.regexp.smoothing_pattern.exec(r))){if("\0"===r)continue;throw new Error("Unexpected line: '"+r+"'")}var y=s[1].trim().toLowerCase();t.object.smooth="1"===y||"on"===y;var x=t.object.currentMaterial();x&&(x.smooth=t.object.smooth)}t.finalize();var b=new Group;b.materialLibraries=[].concat(t.materialLibraries);for(var c=0,h=t.objects.length;c<h;c++){var _=t.objects[c],w=_.geometry,M=_.materials,E="Line"===w.type;if(0!==w.vertices.length){var S=new BufferGeometry;S.addAttribute("position",new BufferAttribute(new Float32Array(w.vertices),3)),w.normals.length>0?S.addAttribute("normal",new BufferAttribute(new Float32Array(w.normals),3)):S.computeVertexNormals(),w.uvs.length>0&&S.addAttribute("uv",new BufferAttribute(new Float32Array(w.uvs),2));for(var T=[],C=0,A=M.length;C<A;C++){var P=M[C],x=void 0;if(null!==this.materials&&(x=this.materials.create(P.name),E&&x&&!x.isLineBasicMaterial)){var R=new LineBasicMaterial;R.copy(x),x=R}x||(x=E?new LineBasicMaterial:new MeshPhongMaterial,x.name=P.name),x.shading=P.smooth?SmoothShading:FlatShading,T.push(x)}var L;if(T.length>1){for(var C=0,A=M.length;C<A;C++){var P=M[C];S.addGroup(P.groupStart,P.groupCount,C)}var B=new MultiMaterial(T);L=E?new LineSegments(S,B):new Mesh(S,B)}else L=E?new LineSegments(S,T[0]):new Mesh(S,T[0]);L.name=_.name,b.add(L)}}return console.timeEnd("OBJLoader"),b}}]),e}(),OBJParserState=function(){function e(){classCallCheck(this,e),this.objects=[],this.object={},this.vertices=[],this.normals=[],this.uvs=[],this.materialLibraries=[]}return createClass(e,[{key:"startObject",value:function(e,t){if(this.object&&this.object.fromDeclaration===!1)return this.object.name=e,void(this.object.fromDeclaration=t!==!1);this.object&&"function"==typeof this.object._finalize&&this.object._finalize();var i=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object=new OBJ(e,t),i&&i.name&&"function"==typeof i.clone){var r=i.clone(0);r.inherited=!0,this.object.materials.push(r)}this.objects.push(this.object)}},{key:"finalize",value:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize()}},{key:"parseVertexIndex",value:function(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)}},{key:"parseNormalIndex",value:function(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)}},{key:"parseUVIndex",value:function(e,t){var i=parseInt(e,10);return 2*(i>=0?i-1:i+t/2)}},{key:"addVertex",value:function(e,t,i){var r=this.vertices,n=this.object.geometry.vertices;n.push(r[e+0]),n.push(r[e+1]),n.push(r[e+2]),n.push(r[t+0]),n.push(r[t+1]),n.push(r[t+2]),n.push(r[i+0]),n.push(r[i+1]),n.push(r[i+2])}},{key:"addVertexLine",value:function(e){var t=this.vertices,i=this.object.geometry.vertices;i.push(t[e+0]),i.push(t[e+1]),i.push(t[e+2])}},{key:"addNormal",value:function(e,t,i){var r=this.normals,n=this.object.geometry.normals;n.push(r[e+0]),n.push(r[e+1]),n.push(r[e+2]),n.push(r[t+0]),n.push(r[t+1]),n.push(r[t+2]),n.push(r[i+0]),n.push(r[i+1]),n.push(r[i+2])}},{key:"addUV",value:function(e,t,i){var r=this.uvs,n=this.object.geometry.uvs;n.push(r[e+0]),n.push(r[e+1]),n.push(r[t+0]),n.push(r[t+1]),n.push(r[i+0]),n.push(r[i+1])}},{key:"addUVLine",value:function(e){var t=this.uvs,i=this.object.geometry.uvs;i.push(t[e+0]),i.push(t[e+1])}},{key:"addFace",value:function(e,t,i,r,n,o,a,s,l,c,h,u){var d,p=this.vertices.length,f=this.parseVertexIndex(e,p),m=this.parseVertexIndex(t,p),v=this.parseVertexIndex(i,p);if(void 0===r?this.addVertex(f,m,v):(d=this.parseVertexIndex(r,p),this.addVertex(f,m,d),this.addVertex(m,v,d)),void 0!==n){var g=this.uvs.length;f=this.parseUVIndex(n,g),m=this.parseUVIndex(o,g),v=this.parseUVIndex(a,g),void 0===r?this.addUV(f,m,v):(d=this.parseUVIndex(s,g),this.addUV(f,m,d),this.addUV(m,v,d))}if(void 0!==l){var y=this.normals.length;f=this.parseNormalIndex(l,y),m=l===c?f:this.parseNormalIndex(c,y),v=l===h?f:this.parseNormalIndex(h,y),void 0===r?this.addNormal(f,m,v):(d=this.parseNormalIndex(u,y),this.addNormal(f,m,d),this.addNormal(m,v,d))}}},{key:"addLineGeometry",value:function(e,t){this.object.geometry.type="Line";for(var i=this.vertices.length,r=this.uvs.length,n=0,o=e.length;n<o;n++)this.addVertexLine(this.parseVertexIndex(e[n],i));for(var a=0,o=t.length;a<o;a++)this.addUVLine(this.parseUVIndex(t[a],r))}}]),e}(),OBJ=function(){function e(t,i){classCallCheck(this,e),this.name=t||"",this.fromDeclaration=i!==!1,this.geometry={vertices:[],normals:[],uvs:[]},this.materials=[],this.smooth=!0}return createClass(e,[{key:"startMaterial",value:function(e,t){var i=this._finalize(!1);i&&(i.inherited||i.groupCount<=0)&&this.materials.splice(i.index,1);var r={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==i?i.smooth:this.smooth,groupStart:void 0!==i?i.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){return{index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:this.groupEnd,groupEnd:-1,groupCount:-1,inherited:!1}}};return this.materials.push(r),r}},{key:"currentMaterial",value:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]}},{key:"_finalize",value:function(e){var t=this.currentMaterial();return t&&t.groupEnd===-1&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e!==!1&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}}]),e}();Geometry.prototype.offset=function(e,t,i){for(var r=this.vertices,n=0;n<r.length;++n){var o=r[n];o.x+=e,o.y+=t,o.z+=i}return this},BufferGeometry.prototype.offset=function(e,t,i){for(var r=this.attributes.position.array,n=this.attributes.position.itemSize,o=0;o<r.length;o+=n)r[o]+=e,r[o+1]+=t,r[o+2]+=i;return this},Object3D.prototype.phys=Mesh.prototype.phys=function(e){return phys(this,e)},BufferGeometry.prototype.textured=Geometry.prototype.textured=Mesh.prototype.textured=function(e,t){return textured(this,e,t)},Euler.prototype.toString=Quaternion.prototype.toString=Vector2.prototype.toString=Vector3.prototype.toString=Vector4.prototype.toString=function(e){var t=this.toArray();if(void 0!==e)for(var i=0;i<t.length;++i)null!==t[i]&&void 0!==t[i]?t[i]=t[i].toFixed(e):t[i]="undefined";return"<"+t.join(", ")+">"};var debugOutputCache={};Euler.prototype.debug=Quaternion.prototype.debug=Vector2.prototype.debug=Vector3.prototype.debug=Vector4.prototype.debug=Matrix3.prototype.debug=Matrix4.prototype.debug=function(e,t){var i=this.toString(t);return i!==debugOutputCache[e]&&(debugOutputCache[e]=i,console.trace(e+"\n"+i)),this};var promise=createCommonjsModule(function(e){!function(t){function i(){}function r(e,t){return function(){e.apply(t,arguments)}}function n(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(e,this)}function o(e,t){for(;3===e._state;)e=e._value;return 0===e._state?void e._deferreds.push(t):(e._handled=!0,void d(function(){var i=1===e._state?t.onFulfilled:t.onRejected;if(null===i)return void(1===e._state?a:s)(t.promise,e._value);var r;try{r=i(e._value)}catch(e){return void s(t.promise,e)}a(t.promise,r)}))}function a(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var i=t.then;if(t instanceof n)return e._state=3,e._value=t,void l(e);if("function"==typeof i)return void h(r(i,t),e)}e._state=1,e._value=t,l(e)}catch(t){s(e,t)}}function s(e,t){e._state=2,e._value=t,l(e)}function l(e){2===e._state&&0===e._deferreds.length&&d(function(){e._handled||p(e._value)});for(var t=0,i=e._deferreds.length;t<i;t++)o(e,e._deferreds[t]);e._deferreds=null}function c(e,t,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=i}function h(e,t){var i=!1;try{e(function(e){i||(i=!0,a(t,e))},function(e){i||(i=!0,s(t,e))})}catch(e){if(i)return;i=!0,s(t,e)}}var u=setTimeout,d="function"==typeof setImmediate&&setImmediate||function(e){u(e,0)},p=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};n.prototype.catch=function(e){return this.then(null,e)},n.prototype.then=function(e,t){var r=new this.constructor(i);return o(this,new c(e,t,r)),r},n.all=function(e){var t=Array.prototype.slice.call(e);return new n(function(e,i){function r(o,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){r(o,e)},i)}t[o]=a,0===--n&&e(t)}catch(e){i(e)}}if(0===t.length)return e([]);for(var n=t.length,o=0;o<t.length;o++)r(o,t[o])})},n.resolve=function(e){return e&&"object"==typeof e&&e.constructor===n?e:new n(function(t){t(e)})},n.reject=function(e){return new n(function(t,i){i(e)})},n.race=function(e){return new n(function(t,i){for(var r=0,n=e.length;r<n;r++)e[r].then(t,i)})},n._setImmediateFn=function(e){d=e},n._setUnhandledRejectionFn=function(e){p=e},e.exports?e.exports=n:t.Promise||(t.Promise=n)}(commonjsGlobal)});window.AudioContext=function(e){Object.defineProperties(e.prototype,{createGain:{value:e.prototype.createGain||e.prototype.createGainNode},createDelay:{value:e.prototype.createDelay||e.prototype.createDelayNode},createScriptProcessor:{value:e.prototype.createScriptProcessor||e.prototype.createJavaScriptNode}});var t=new e,i=t.createOscillator().constructor,r=t.createBufferSource().constructor,n=t.createGain().gain.constructor;return Object.defineProperties(i.prototype,{setPeriodicWave:{value:i.prototype.setPeriodicWave||i.prototype.setWaveTable},start:{value:i.prototype.start||i.prototype.noteOn},stop:{value:i.prototype.stop||i.prototype.noteOff}}),Object.defineProperties(r.prototype,{start:{value:r.prototype.start||function(){return arguments.length>1?r.prototype.noteGrainOn.apply(this,arguments):r.prototype.noteOn.apply(this,arguments)}},stop:{value:r.prototype.stop||r.prototype.noteOff}}),Object.defineProperties(n.prototype,{setTargetAtTime:{value:n.prototype.setTargetAtTime||n.prototype.setTargetValueAtTime}}),e}(window.AudioContext||window.webkitAudioContext);var VECTOR=new Vector3,UP=new Vector3,TEMP$1=new Matrix4,Audio3D=function(){function e(){var t=this;classCallCheck(this,e),this.ready=new Promise(function(i,r){try{if(e.isAvailable){var n=function(){try{t.sampleRate=t.context.sampleRate,t.mainVolume=t.context.createGain(),t.start(),i()}catch(e){r(e)}};if(isiOS){var o=function e(){try{t.context=t.context||new AudioContext;var i=t.context.createBufferSource();i.buffer=t.createRawSound([[0]]),i.connect(t.context.destination),i.start(),setTimeout(function(){i.playbackState!==i.PLAYING_STATE&&i.playbackState!==i.FINISHED_STATE||(window.removeEventListener("mouseup",e),window.removeEventListener("touchend",e),window.removeEventListener("keyup",e),i.disconnect(),n())},0)}catch(e){r(e)}};window.addEventListener("mouseup",o,!1),window.addEventListener("touchend",o,!1),window.addEventListener("keyup",o,!1)}else t.context=new AudioContext,n()}}catch(e){r(e)}})}return createClass(e,null,[{key:"setAudioStream",value:function(e,t){var i=document.querySelectorAll("audio").length,r=cascadeElement(t||"audioStream"+i,"audio",HTMLAudioElement,!0);return setAudioProperties(r),r.srcObject=e,r}},{key:"setAudioProperties",value:function(e){e.autoplay=!0,e.controls=!1,e.crossOrigin="anonymous"}}]),createClass(e,[{key:"setVelocity",value:function(e,t,i){this.context&&this.context.listener.setVelocity(e,t,i)}},{key:"setPlayer",value:function(e){if(this.context&&this.context.listener){var t=e.matrixWorld,i=t.elements,r=i[12],n=i[13],o=i[14];isNaN(r+n+o)||(this.context.listener.setPosition(r,n,o),VECTOR.set(0,0,-1).applyMatrix4(t).normalize(),UP.set(0,1,0).applyMatrix4(t).normalize(),this.context.listener.setOrientation(VECTOR.x,VECTOR.y,VECTOR.z,UP.x,UP.y,UP.z))}}},{key:"start",value:function(){this.mainVolume&&this.mainVolume.connect(this.context.destination),this.context&&this.context.resume&&this.context.resume()}},{key:"stop",value:function(){this.context&&this.context.suspend&&this.context.suspend(),this.mainVolume&&this.mainVolume.disconnect()}},{key:"loadURL",value:function(e){var t=this;return this.ready.then(function(){console.log("Loading "+e+" from URL"),getBuffer(e)}).then(function(e){return new Promise(function(i,r){return t.context.decodeAudioData(e,i,r)})}).then(function(t){return console.log(e+" loaded"),t}).catch(function(t){console.error("Couldn't load "+e+". Reason: "+t)})}},{key:"createRawSound",value:function(e){if(1!==e.length&&2!==e.length)throw new Error("Incorrect number of channels. Expected 1 or 2, got "+e.length);var t=e[0].length;if(e.length>1&&e[1].length!==t)throw new Error("Second channel is not the same length as the first channel. Expected "+t+", but was "+e[1].length);for(var i=this.context.createBuffer(e.length,t,this.sampleRate||22050),r=0;r<e.length;++r)for(var n=i.getChannelData(r),o=0;o<t;++o)n[o]=e[r][o];return i}},{key:"create3DSound",value:function(e,t,i,r){return r.panner=this.context.createPanner(),r.panner.setPosition(e,t,i),r.panner.connect(this.mainVolume),r.volume.connect(r.panner),r}},{key:"createFixedSound",value:function(e){return e.volume.connect(this.mainVolume),e}},{key:"loadSource",value:function(e,t){var i=this;return this.ready.then(function(){return new Promise(function(r,n){console.log("Loading "+e),e instanceof Array||(e=[e]);var o=document.createElement("audio");o.autoplay=!0,o.preload="auto",o["webkit-playsinline"]=!0,o.playsinline=!0,o.loop=t,o.crossOrigin="anonymous",e.map(function(e){var t=document.createElement("source");return t.src=e,t}).forEach(o.appendChild.bind(o)),o.onerror=n,o.oncanplay=function(){o.oncanplay=null;var e={volume:i.context.createGain(),source:i.context.createMediaElementSource(o)};e.source.connect(e.volume),r(e)},o.play(),document.body.appendChild(o)})}).then(function(t){return console.log(e+" loaded"),t}).catch(function(t){console.error("Couldn't load "+e+". Reason: "+t)})}},{key:"load3DSound",value:function(e,t,i,r,n){return this.loadSource(e,t).then(this.create3DSound.bind(this,i,r,n))}},{key:"loadFixedSound",value:function(e,t){return this.loadSource(e,t).then(this.createFixedSound.bind(this))}}]),e}();Audio3D.isAvailable=!!window.AudioContext&&!!AudioContext.prototype.createGain;var PositionalSound=function(){function e(t,i){classCallCheck(this,e),this.gn=t.createGain(),this.pnr=t.createPanner(),this.gn.connect(this.pnr),this.pnr.connect(i),this.gn.gain.value=0,this.ctx=t}return createClass(e,[{key:"at",value:function(e,t,i,r,n,o){return e=e||0,t=t||0,i=i||0,void 0!==r&&null!==r||(r=0),n=n||0,o=o||0,this.pnr.setPosition(e,t,i),this.pnr.setOrientation(r,n,o),this}}]),e}(),PIANO_BASE=Math.pow(2,1/12),Note=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.osc=e.createOscillator(),n.osc.type=r,n.osc.frequency.value=0,n.osc.connect(n.gn),n.osc.start(),n}return inherits(t,e),createClass(t,null,[{key:"piano",value:function(e){return 440*Math.pow(PIANO_BASE,e-49)}}]),createClass(t,[{key:"on",value:function(e,i,r,n){void 0===r&&(r=0);var o=t.piano(parseFloat(e)+1),a=this.ctx.currentTime+r;return this.gn.gain.setValueAtTime(i,a),n?this.osc.frequency.exponentialRampToValueAtTime(o,a):this.osc.frequency.setValueAtTime(o,a),this}},{key:"off",value:function(e){void 0===e&&(e=0);var t=this.ctx.currentTime+e;return this.gn.gain.setValueAtTime(0,t),this.osc.frequency.setValueAtTime(0,t),this}},{key:"ready",get:function(){return 0===this.gn.gain.value}}]),t}(PositionalSound),MAX_NOTE_COUNT=(navigator.maxTouchPoints||10)+1,TYPES=["sine","square","sawtooth","triangle"],Music=function(){function e(t,i){var r=this;classCallCheck(this,e),void 0===i&&(i=MAX_NOTE_COUNT),this.oscillators={},this.isAvailable=!1,this.audio=t,this.audio.ready.then(function(){var e=r.audio.context;r.mainVolume=e.createGain(),r.mainVolume.connect(r.audio.mainVolume),r.mainVolume.gain.value=1,r.numNotes=i,TYPES.forEach(function(t){var i=r.oscillators[t]=[];r[t]=r.play.bind(r,t);for(var n=0;n<r.numNotes;++n)i.push(new Note(e,r.mainVolume,t))}),r.isAvailable=!0})}return createClass(e,[{key:"getOsc",value:function(e){var t=this.oscillators[e],i=void 0;for(i=0;i<t.length&&!t[i].ready;++i);return t[i%this.numNotes]}},{key:"play",value:function(e,t,i,r,n){void 0===n&&(n=0);var o=this.getOsc(e).on(t,i,n);return n+=r,o.off(n),n=this.audio.context.currentTime+n-performance.now()/1e3,o}},{key:"type",get:function(){return this._type},set:function(e){var t=this;this.isAvailable&&(this._type=e,this.oscillators.forEach(function(e){return e.osc.type=t._type}))}}]),e}();Music.TYPES=TYPES;var Sound=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.context,e.mainVolume));return n.audio=document.createElement("audio"),n.audio.autoplay=!0,n.audio.preload="auto",n.audio["webkit-playsinline"]=!0,n.audio.playsinline=!0,n.audio.loop=r,n.audio.crossOrigin="anonymous",console.log("Loading "+i),i instanceof Array||(i=[i]),i.map(function(e){var t=document.createElement("source");return t.src=e,t}).forEach(n.audio.appendChild.bind(n.audio)),n.ready=new Promise(function(e,t){n.audio.onerror=t,n.audio.oncanplay=function(){n.audio.oncanplay=null,n.node=n.ctx.createMediaElementSource(n.audio),n.node.connect(n.gn),n.gn.gain.setValueAtTime(0,n.ctx.currentTime),e(n)},n.audio.play()}),document.body.appendChild(n.audio),n}return inherits(t,e),createClass(t,[{key:"play",value:function(){return this.gn.gain.setValueAtTime(1,this.ctx.currentTime),this.audio.play(),this}}]),t}(PositionalSound),DEFAULT_SPEECH_SETTINGS={remoteVoices:!0,volume:1,rate:1,pitch:1,voice:0},Speech=function(){function e(t){var i=this;if(classCallCheck(this,e),this.options=Object.assign({},DEFAULT_SPEECH_SETTINGS,t),e.isAvailable){var r=function(){i.voices=speechSynthesis.getVoices().filter(function(e){return i.options.remoteVoices||e.default||e.localService}),i.voiceNames=i.voices.map(function(e){return e.name})};r(),speechSynthesis.onvoiceschanged=r}}return createClass(e,[{key:"speak",value:function(t,i){var r=this;return e.isAvailable?new Promise(function(e,n){var o=new SpeechSynthesisUtterance;o.voice=r.voices[i&&i.voice||r.options.voice],o.volume=i&&i.volume||r.options.volume,o.rate=i&&i.rate||r.options.rate,o.pitch=i&&i.pitch||r.options.pitch,o.text=t,o.onend=e,o.onerror=n,speechSynthesis.speak(o)}):Promise.reject()}},{key:"speaking",get:function(){return e.isAvailable&&speechSynthesis.speaking}}],[{key:"isAvailable",get:function(){return!!window.speechSynthesis}}]),e}(),Audio$2={Audio3D:Audio3D,Music:Music,Note:Note,PositionalSound:PositionalSound,Sound:Sound,Speech:Speech},FORWARD=new Vector3(0,0,-1),LASER_WIDTH=.01,LASER_LENGTH=3*LASER_WIDTH,GAZE_RING_DISTANCE=-1.25,GAZE_RING_INNER=.015,GAZE_RING_OUTER=.03,VECTOR_TEMP=new Vector3,EULER_TEMP$1=new Euler,QUAT_TEMP$1=new Quaternion,Pointer=function(e){function t(e,i,r,n,o,a,s){classCallCheck(this,t);var l=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,s));return l.isPointer=!0,l.devices=o.filter(identity),l.triggerDevices=a&&a.filter(identity)||l.devices.slice(),l.gazeTimeout=1e3*(l.options.gazeLength||1.5),l.unproject=null,l.picker=new Raycaster,l.showPointer=!0,l.color=i,l.highlight=r,l.mesh=box(LASER_WIDTH/n,LASER_WIDTH/n,LASER_LENGTH*n).colored(l.color,{unshaded:!0}).named(e+"-pointer").addTo(l).at(0,0,-1.5),l.gazeInner=circle(GAZE_RING_INNER/2,10).colored(12632256,{unshaded:!0}).addTo(l).at(0,0,GAZE_RING_DISTANCE),l.gazeReference=ring(.5*GAZE_RING_INNER,.75*GAZE_RING_INNER,10,36,0,2*Math.PI).colored(16777215,{unshaded:!0}).addTo(l.gazeInner),l.gazeOuter=ring(GAZE_RING_INNER,GAZE_RING_OUTER,10,36,0,2*Math.PI).colored(16777215,{unshaded:!0}).addTo(l.gazeInner),l.gazeOuter.visible=!1,l.useGaze=l.options.useGaze,l.lastHit=null,l}return inherits(t,e),createClass(t,[{key:"addDevice",value:function(e,t){e&&this.devices.push(e),t&&this.triggerDevices.push(t)}},{key:"setSize",value:function(e,t){for(var i=2*devicePixelRatio/e,r=2*devicePixelRatio/t,n=0;n<this.devices.length;++n){var o=this.devices[n];o.commands.U&&(o.commands.U.scale=i),o.commands.V&&(o.commands.V.scale=r)}}},{key:"update",value:function(){if(get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this),this.position.set(0,0,0),this.unproject){QUAT_TEMP$1.set(0,1,0,0),VECTOR_TEMP.set(0,0,0);for(var e=0;e<this.devices.length;++e){var i=this.devices[e];i.enabled&&i.inPhysicalUse&&(i.commands.U&&!i.commands.U.disabled&&(VECTOR_TEMP.x+=i.getValue("U")-1),i.commands.V&&!i.commands.V.disabled&&(VECTOR_TEMP.y+=i.getValue("V")-1))}VECTOR_TEMP.applyMatrix4(this.unproject).applyQuaternion(QUAT_TEMP$1),this.lookAt(VECTOR_TEMP)}else{this.quaternion.set(0,0,0,1),EULER_TEMP$1.set(0,0,0,"YXZ");for(var r=0;r<this.devices.length;++r){var n=this.devices[r];n.enabled&&(n.quaternion&&this.quaternion.multiply(n.quaternion),n.position&&this.position.add(n.position))}QUAT_TEMP$1.setFromEuler(EULER_TEMP$1),this.quaternion.multiply(QUAT_TEMP$1)}this.updateMatrixWorld()}},{key:"_check",value:function(e){var t=e&&e.object,i=this.lastHit,r=i&&i.object;if(t||r){var n=i&&e&&(e.point.x!==i.point.x||e.point.y!==i.point.y||e.point.z!==i.point.z),o=i&&i.time&&performance.now()-i.time,a=t&&t.id,s=r&&r.id,l=a!==s,c={pointer:this,buttons:0,hit:e},h={pointer:this,buttons:0,hit:i};e?(this.gazeInner.position.z=.02-e.distance,e.time=performance.now(),this.mesh.material=material("",{color:this.highlight,unshaded:!0})):this.gazeInner.position.z=GAZE_RING_DISTANCE,n&&i.point.copy(e.point);for(var u=0,d=0;d<this.triggerDevices.length;++d){var p=this.triggerDevices[d];p.enabled&&(c.buttons|=p.getValue("buttons"),u|=p.getValue("dButtons"))}h.buttons=c.buttons,l&&(r&&this.emit("exit",h),t&&this.emit("enter",c));var f=!1;if(u?c.buttons?(t&&this.emit("pointerstart",c),i&&(i.time=performance.now())):t&&(f=!!e,this.emit("pointerend",c)):n&&t&&this.emit("pointermove",c),this.useGaze)if(l)null!==o&&o<this.gazeTimeout&&(this.gazeOuter.visible=!1,r&&this.emit("gazecancel",h)),e&&(this.gazeOuter.visible=!0,t&&this.emit("gazestart",c));else if(null!==o)if(o>=this.gazeTimeout)this.gazeOuter.visible=!1,t&&(f=!!e,this.emit("gazecomplete",c)),i.time=null;else if(hasGazeEvent(t)){var m=Math.round(36*o/this.gazeTimeout),v=2*Math.PI*m/36;this.gazeOuter.geometry=ring(GAZE_RING_INNER,GAZE_RING_OUTER,36,m,0,v),n&&t&&this.emit("gazemove",c)}else this.gazeOuter.visible=!1;return f&&this.emit("select",c),!l&&e&&i&&(e.time=i.time),!0}return!1}},{key:"resolvePicking",value:function(e){if(this.mesh.visible=!1,this.gazeInner.visible=!1,this.mesh.material=material("",{color:this.color,unshaded:!0}),this.showPointer){VECTOR_TEMP.set(0,0,0).applyMatrix4(this.matrixWorld),FORWARD.set(0,0,-1).applyMatrix4(this.matrixWorld).sub(VECTOR_TEMP),this.picker.set(VECTOR_TEMP,FORWARD),this.gazeInner.visible=this.useGaze,this.mesh.visible=!this.useGaze;for(var t=this.picker.intersectObject(e,!0),i=0;i<t.length;++i){for(var r=t[i],n=r.object,o=n;o&&(!o.isEntity||o.isPointer);)o=o.parent;if(o||(o=n),o&&!o.pickable&&(o=null),r.object=o,o&&this._check(r))return this.lastHit=r,r.object._listeners.useraction}this._check(),this.lastHit=null}}},{key:"pickable",get:function(){return!1}},{key:"material",get:function(){return this.mesh.material},set:function(e){this.mesh.material=e,this.gazeInner.material=e,this.gazeOuter.material=e}}]),t}(Entity);Pointer.EVENTS=["pointerstart","pointerend","pointermove","gazestart","gazemove","gazecomplete","gazecancel","exit","enter","select","useraction"];var Keys={ANY:Number.MAX_VALUE,MODIFIER_KEYS:["ctrl","shift","alt","meta","meta_l","meta_r"],SHIFT:16,CTRL:17,ALT:18,META:91,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,VOLUME_DOWN:174,VOLUME_UP:175,TRACK_NEXT:176,TRACK_PREVIOUS:177};for(var key in Keys){var val=Keys[key];Keys.hasOwnProperty(key)&&"number"==typeof val&&(Keys[val]=key)}var Point=function(){function e(t,i){classCallCheck(this,e),this.set(t||0,i||0)}return createClass(e,[{key:"set",value:function(e,t){this.x=e,this.y=t}},{key:"copy",value:function(e){e&&(this.x=e.x,this.y=e.y)}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"toString",value:function(){return"(x:"+this.x+", y:"+this.y+")"}}]),e}(),Size=function(){function e(t,i){classCallCheck(this,e),this.set(t||0,i||0)}return createClass(e,[{key:"set",value:function(e,t){this.width=e,this.height=t}},{key:"copy",value:function(e){e&&(this.width=e.width,this.height=e.height)}},{key:"clone",value:function(){return new e(this.width,this.height)}},{key:"toString",value:function(){return"<w:"+this.width+", h:"+this.height+">"}}]),e}(),Rectangle=function(){function e(t,i,r,n){classCallCheck(this,e),this.isRectangle=!0,this.point=new Point(t,i),this.size=new Size(r,n)}return createClass(e,[{key:"set",value:function(e,t,i,r){
this.point.set(e,t),this.size.set(i,r)}},{key:"copy",value:function(e){e&&(this.point.copy(e.point),this.size.copy(e.size))}},{key:"clone",value:function(){return new e(this.point.x,this.point.y,this.size.width,this.size.height)}},{key:"toString",value:function(){return"["+this.point.toString()+" x "+this.size.toString()+"]"}},{key:"overlap",value:function(t){var i=Math.max(this.left,t.left),r=Math.max(this.top,t.top),n=Math.min(this.right,t.right),o=Math.min(this.bottom,t.bottom);if(n>i&&o>r)return new e(i,r,n-i,o-r)}},{key:"x",get:function(){return this.point.x},set:function(e){this.point.x=e}},{key:"left",get:function(){return this.point.x},set:function(e){this.point.x=e}},{key:"width",get:function(){return this.size.width},set:function(e){this.size.width=e}},{key:"right",get:function(){return this.point.x+this.size.width},set:function(e){this.point.x=e-this.size.width}},{key:"y",get:function(){return this.point.y},set:function(e){this.point.y=e}},{key:"top",get:function(){return this.point.y},set:function(e){this.point.y=e}},{key:"height",get:function(){return this.size.height},set:function(e){this.size.height=e}},{key:"bottom",get:function(){return this.point.y+this.size.height},set:function(e){this.point.y=e-this.size.height}},{key:"area",get:function(){return this.width*this.height}}]),e}(),COUNTER$4=0,Surface=function(e){function t(e){classCallCheck(this,t),e=Object.assign({},{id:"Primrose.Controls.Surface["+COUNTER$4++ +"]",bounds:new Rectangle},e),e.width&&(e.bounds.width=e.width),e.height&&(e.bounds.height=e.height);var i=null,r=null;if(e.id instanceof t)throw new Error("Object is already a Surface. Please don't try to wrap them.");if(e.id instanceof CanvasRenderingContext2D?(r=e.id,i=r.canvas):e.id instanceof HTMLCanvasElement?i=e.id:("string"==typeof e.id||e.id instanceof String)&&(i=document.getElementById(e.id),null===i?(i=document.createElement("canvas"),i.id=e.id):"CANVAS"!==i.tagName&&(i=null)),null===i)throw console.error(_typeof(e.id)),console.error(e.id),new Error(e.id+" does not refer to a valid canvas element.");var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,[i],e));return n.isSurface=!0,n.bounds=n.options.bounds,n.canvas=i,n.context=r||n.canvas.getContext("2d"),n._opacity=1,n.focused=!1,n.focusable=!0,n.style={},Object.defineProperties(n.style,{width:{get:function(){return n.bounds.width},set:function(e){n.bounds.width=e,n.resize()}},height:{get:function(){return n.bounds.height},set:function(e){n.bounds.height=e,n.resize()}},left:{get:function(){return n.bounds.left},set:function(e){n.bounds.left=e}},top:{get:function(){return n.bounds.top},set:function(e){n.bounds.top=e}},opacity:{get:function(){return n._opacity},set:function(e){n._opacity=e}},fontSize:{get:function(){return n.fontSize},set:function(e){n.fontSize=e}},backgroundColor:{get:function(){return n.backgroundColor},set:function(e){n.backgroundColor=e}},color:{get:function(){return n.color},set:function(e){n.color=e}}}),0===n.bounds.width&&(n.bounds.width=n.imageWidth,n.bounds.height=n.imageHeight),n.imageWidth=n.bounds.width,n.imageHeight=n.bounds.height,n.canvas.style.imageRendering=isChrome?"pixelated":"optimizespeed",n.context.imageSmoothingEnabled=!1,n.context.textBaseline="top",n.subSurfaces=[],n.render=n.render.bind(n),n.on("focus",n.render).on("blur",n.render).on("pointerstart",n.startUV.bind(n)).on("pointermove",n.moveUV.bind(n)).on("gazemove",n.moveUV.bind(n)).on("pointerend",n.endPointer.bind(n)).on("gazecomplete",function(e){n.startUV(e),setTimeout(function(){return n.endPointer(e)},100)}).on("keydown",n.keyDown.bind(n)).on("keyup",n.keyUp.bind(n)),n.render(),n}return inherits(t,e),createClass(t,[{key:"_loadFiles",value:function(e,t){var i=this;return Promise.all(e.map(function(e,t){var r=Object.assign({},i.options);return i._meshes[t]=i._geometry.textured(e,r),r.promise.then(function(e){return i._textures[t]=e})}))}},{key:"invalidate",value:function(e){e?e.isRectangle&&(e=e.clone()):(e=this.bounds.clone(),e.left=0,e.top=0);for(var i=0;i<this.subSurfaces.length;++i){var r=this.subSurfaces[i],n=e.overlap(r.bounds);if(n){var o=n.left-r.bounds.left,a=n.top-r.bounds.top;this.context.drawImage(r.canvas,o,a,n.width,n.height,n.x,n.y,n.width,n.height)}}this._textures[0]&&(this._textures[0].needsUpdate=!0),this._meshes[0]&&(this._meshes[0].material.needsUpdate=!0),this.parent instanceof t&&(e.left+=this.bounds.left,e.top+=this.bounds.top,this.parent.invalidate(e))}},{key:"render",value:function(){this.invalidate()}},{key:"resize",value:function(){this.setSize(this.surfaceWidth,this.surfaceHeight)}},{key:"setSize",value:function(e,t){var i=this.context.textBaseline,r=this.context.textAlign;this.imageWidth=e,this.imageHeight=t,this.context.textBaseline=i,this.context.textAlign=r}},{key:"add",value:function(e){if(e.isSurface)this.subSurfaces.push(e),this.invalidate();else{if(!e.isObject3D)throw new Error("Can only append other Surfaces to a Surface. You gave: "+e);get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"add",this).call(this,e)}}},{key:"mapUV",value:function(e){return e instanceof Array?{x:e[0]*this.imageWidth,y:(1-e[1])*this.imageHeight}:e.isVector2?{x:e.x*this.imageWidth,y:(1-e.y)*this.imageHeight}:void 0}},{key:"unmapUV",value:function(e){return[e.x/this.imageWidth,1-e.y/this.imageHeight]}},{key:"_findSubSurface",value:function(e,t,i){for(var r=this.inBounds(e,t),n=null,o=this.subSurfaces.length-1;o>=0;--o){var a=this.subSurfaces[o];!n&&a.inBounds(e-this.bounds.left,t-this.bounds.top)?n=a:a.focused&&a.blur()}return n||r&&this}},{key:"inBounds",value:function(e,t){return this.bounds.left<=e&&e<this.bounds.right&&this.bounds.top<=t&&t<this.bounds.bottom}},{key:"startPointer",value:function(e,t){if(this.inBounds(e,t)){var i=this._findSubSurface(e,t,function(e,t,i){return e.startPointer(t,i)});i?(this.focused||this.focus(),this.emit("click",{target:i,x:e,y:t}),i!==this&&i.startPointer(e-this.bounds.left,t-this.bounds.top)):this.focused&&this.blur()}}},{key:"movePointer",value:function(e,t){var i=this._findSubSurface(e,t,function(e,t,i){return e.startPointer(t,i)});i&&(this.emit("move",{target:i,x:e,y:t}),i!==this&&i.movePointer(e-this.bounds.left,t-this.bounds.top))}},{key:"_forFocusedSubSurface",value:function(e,t){var i=this.focusedElement;return!(!i||i===this)&&(i[e](t),!0)}},{key:"startUV",value:function(e){if(!this._forFocusedSubSurface("startUV",e)){var t=this.mapUV(e.hit.uv);this.startPointer(t.x,t.y)}}},{key:"moveUV",value:function(e){if(!this._forFocusedSubSurface("moveUV",e)){var t=this.mapUV(e.hit.uv);this.movePointer(t.x,t.y)}}},{key:"endPointer",value:function(e){this._forFocusedSubSurface("endPointer",e)}},{key:"focus",value:function(){this.focusable&&!this.focused&&(this.focused=!0,this.emit("focus"))}},{key:"blur",value:function(){if(this.focused){this.focused=!1;for(var e=0;e<this.subSurfaces.length;++e)this.subSurfaces[e].focused&&this.subSurfaces[e].blur();this.emit("blur")}}},{key:"keyDown",value:function(e){this._forFocusedSubSurface("keyDown",e)}},{key:"keyUp",value:function(e){this._forFocusedSubSurface("keyUp",e)}},{key:"readClipboard",value:function(e){this._forFocusedSubSurface("readClipboard",e)}},{key:"copySelectedText",value:function(e){this._forFocusedSubSurface("copySelectedText",e)}},{key:"cutSelectedText",value:function(e){this._forFocusedSubSurface("cutSelectedText",e)}},{key:"readWheel",value:function(e){this._forFocusedSubSurface("readWheel",e)}},{key:"pickable",get:function(){return!0}},{key:"imageWidth",get:function(){return this.canvas.width},set:function(e){this.canvas.width=e,this.bounds.width=e}},{key:"imageHeight",get:function(){return this.canvas.height},set:function(e){this.canvas.height=e,this.bounds.height=e}},{key:"elementWidth",get:function(){return this.canvas.clientWidth*devicePixelRatio},set:function(e){this.canvas.style.width=e/devicePixelRatio+"px"}},{key:"elementHeight",get:function(){return this.canvas.clientHeight*devicePixelRatio},set:function(e){this.canvas.style.height=e/devicePixelRatio+"px"}},{key:"surfaceWidth",get:function(){return this.canvas.parentElement?this.elementWidth:this.bounds.width}},{key:"surfaceHeight",get:function(){return this.canvas.parentElement?this.elementHeight:this.bounds.height}},{key:"resized",get:function(){return this.imageWidth!==this.surfaceWidth||this.imageHeight!==this.surfaceHeight}},{key:"environment",get:function(){for(var e=this;e;){if(e._environment)return e!==this&&(this._environment=e._environment),this._environment;e=e.parent}}},{key:"theme",get:function(){return null},set:function(e){for(var t=0;t<this.subSurfaces.length;++t)this.subSurfaces[t].theme=e}},{key:"lockMovement",get:function(){for(var e=!1,t=0;t<this.subSurfaces.length&&!e;++t)e=e||this.subSurfaces[t].lockMovement;return e}},{key:"focusedElement",get:function(){for(var e=null,t=this;t&&t.focused;){e=t;var i=t.subSurfaces;t=null;for(var r=0;r<i.length;++r){var n=i[r];n.focused&&(t=n)}}return e}}]),t}(BaseTextured),Default={name:"Light",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"black",fontSize:16,lineNumbers:{foreColor:"black"},regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}},COUNTER$3=0,Label=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({},{id:"Primrose.Controls.Label["+COUNTER$3++ +"]"},e)));return i._lastFont=null,i._lastText=null,i._lastCharacterWidth=null,i._lastCharacterHeight=null,i._lastPadding=null,i._lastWidth=-1,i._lastHeight=-1,i._lastTextAlign=null,i.textAlign=i.options.textAlign,i.character=new Size,i.theme=i.options.theme,i.fontSize=i.options.fontSize||16,i.refreshCharacter(),i.backgroundColor=i.options.backgroundColor||i.theme.regular.backColor,i.color=i.options.color||i.theme.regular.foreColor,i.value=i.options.value,i}return inherits(t,e),createClass(t,[{key:"refreshCharacter",value:function(){this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100}},{key:"_isChanged",value:function(){var e=this._lastText!==this.value,t=this.character.width!==this._lastCharacterWidth,i=this.character.height!==this._lastCharacterHeight,r=this.context.font!==this._lastFont,n=this.textAlign!==this._lastTextAlign,o=this.resized||e||t||i||this.resized||r||n;return o}},{key:"render",value:function(){if(this.resized&&this.resize(),this.theme&&this._isChanged){this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastFont=this.context.font,this._lastTextAlign=this.textAlign,this.context.textAlign=this.textAlign||"left";var e=this.backgroundColor?"fillRect":"clearRect";if(this.theme.regular.backColor&&(this.context.fillStyle=this.backgroundColor),this.context[e](0,0,this.imageWidth,this.imageHeight),this.value)for(var t=this.value.split("\n"),i=0;i<t.length;++i){var r=t[i],n=(this.imageHeight-t.length*this.character.height)/2+i*this.character.height,o=null;switch(this.textAlign){case"right":o=this.imageWidth;break;case"center":o=this.imageWidth/2;break;default:o=0}var a=(this.theme.regular.fontWeight||"")+" "+(this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this.context.font=a.trim(),this.context.fillStyle=this.color,this.context.fillText(r,o,n)}this.renderCanvasTrim(),this.invalidate()}}},{key:"renderCanvasTrim",value:function(){}},{key:"textAlign",get:function(){return this.context.textAlign},set:function(e){this.context.textAlign=e,this.render()}},{key:"value",get:function(){return this._value},set:function(e){e=e||"",this._value=e.replace(/\r\n/g,"\n"),this.render()}},{key:"theme",get:function(){return this._theme},set:function(e){this._theme=Object.assign({},Default,e),this._theme.fontSize=this.fontSize,this.refreshCharacter(),this.render()}}]),t}(Surface),COUNTER$2=0,Button2D=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({},{id:"Primrose.Controls.Button2D["+COUNTER$2++ +"]",textAlign:"center"},e)));return i._lastActivated=null,i}return inherits(t,e),createClass(t,[{key:"startPointer",value:function(e,t){this.focus(),this._activated=!0,this.render()}},{key:"endPointer",value:function(){this._activated&&(this._activated=!1,this.emit("click",{target:this}),this.render())}},{key:"_isChanged",value:function(){var e=this._activated!==this._lastActivated,i=get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_isChanged",this)||e;return i}},{key:"renderCanvasTrim",value:function(){this.context.lineWidth=this._activated?4:2,this.context.strokeStyle=this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,this.context.strokeRect(0,0,this.imageWidth,this.imageHeight)}}]),t}(Label),Button3D=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,Object.assign({},t.DEFAULTS,r)));return n.options.minDeflection=Math.cos(n.options.minDeflection),n.options.colorUnpressed=new Color(n.options.colorUnpressed),n.options.colorPressed=new Color(n.options.colorPressed),n.base=e.children[1],n.cap=e.children[0],n.cap.name=i,n.cap.material=n.cap.material.clone(),n.cap.button=n,n.cap.base=n.base,n.add(n.base),n.add(n.cap),n.color=n.cap.material.color,n.name=i,n.element=null,n}return inherits(t,e),createClass(t,[{key:"startUV",value:function(e){this.color.copy(this.options.colorPressed),this.element?this.element.click():this.emit("click",{source:this})}},{key:"endPointer",value:function(e){this.color.copy(this.options.colorUnpressed),this.emit("release",{source:this})}},{key:"consumeEvent",value:function(e){var t=this;switch(e.type){case"pointerstart":this.startUV();break;case"pointerend":this.endPointer(e);break;case"gazecomplete":this.startUV(),setTimeout(function(){return t.endPointer(e)},100)}}}]),t}(Entity);Button3D.DEFAULTS={maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0};var buttonCount=0,ButtonFactory=function(){function e(t,i){classCallCheck(this,e),this.options=i,this.template=t}return createClass(e,[{key:"create",value:function(e){var t="button"+ ++buttonCount,i=this.template.clone(),r=new Button3D(i,t,this.options,e);return r}}]),e}();ButtonFactory.DEFAULT=new ButtonFactory(colored(box(1,1,1),16711680),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0});var COUNTER$5=0,Image=function(e){function t(e,i){return classCallCheck(this,t),e instanceof Array||(e=[e]),i=Object.assign({},{id:"Primrose.Controls.Image["+COUNTER$5++ +"]"},i),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i))}return inherits(t,e),createClass(t,[{key:"_loadFiles",value:function(e,t){var i=this;return Promise.all(Array.prototype.map.call(e,function(e,r){var n=Object.assign({},i.options,{progress:t});return i._meshes[r]=i._geometry.textured(e,n).named(i.name+"-mesh-"+r),n.promise.then(function(e){return i._textures[r]=e})}))}}]),t}(BaseTextured),loaders=null,PATH_PATTERN=/((?:https?:\/\/)?(?:[^\/]+\/)+)(\w+)(\.(?:\w+))$/,EXTENSION_PATTERN=/(\.(?:\w+))+$/,propertyTests={isButton:function(e){return e.material&&e.material.name.match(/^button\d+$/)},isSolid:function(e){return!e.name.match(/^(water|sky)/)},isGround:function(e){return e.material&&e.material.name&&e.material.name.match(/\bground\b/)}},ModelFactory=function(){function e(t){classCallCheck(this,e),this.template=t}return createClass(e,null,[{key:"loadModel",value:function(t,i,r){return e.loadObject(t,i,r).then(function(t){for(;t&&"Group"===t.type;)t=t.children[0];return new e(t)})}},{key:"loadObject",value:function(t,i,r){var n=t.match(EXTENSION_PATTERN),o=i&&"."+i||n[0];if(o){o=o.toLowerCase(),null===loaders&&(loaders={".json":ObjectLoader,".mtl":MTLLoader,".obj":OBJLoader,".typeface.json":FontLoader});var a=loaders[o];if(a){var s=new a,l=t.substring(0,n.index),c=l+"_"+o.toLowerCase(),h=document.getElementById(c),u=Promise.resolve();if(".obj"===o){var d=t.replace(EXTENSION_PATTERN,".mtl");u=u.then(function(){return e.loadObject(d,"mtl",r)}).then(function(e){e.preload(),s.setMaterials(e)}).catch(console.error.bind(console,"Error loading MTL file: "+d))}else if(".mtl"===o){var p=t.match(PATH_PATTERN);if(p){var f=p[1];t=p[2]+p[3],s.setTexturePath(f),s.setPath(f)}}if(h){var m=h.innerHTML.split(/\r?\n/g).map(function(e){return e.trim()}).join("\n");u=u.then(function(){return s.parse(m)})}else s.setCrossOrigin&&s.setCrossOrigin("anonymous"),u=u.then(function(){return new Promise(function(e,i){return s.load(t,e,r,i)})});return".obj"===o&&(u=u.then(fixOBJScene)),".json"===o&&(u=u.then(fixJSONScene)),".mtl"!==o&&".typeface.json"!==o&&(u=u.then(setProperties)),u=u.catch(console.error.bind(console,"MODEL_ERR",t))}return Promise.reject("There is no loader type for the file extension: "+o)}return Promise.reject("File path `"+t+"` does not have a file extension, and a type was not provided as a parameter, so we can't determine the type.")}},{key:"loadObjects",value:function(e){var t={},i=Promise.resolve(t);for(var r in e)e[r]&&(i=i.then(loader(e,r)));return i}}]),createClass(e,[{key:"clone",value:function(){var e=this,t=this.template.clone();return t.traverse(function(i){i.isSkinnedMesh&&(t.animation=new AnimationClip(i,i.geometry.animation),!e.template.originalAnimationClipData&&t.animation.data&&(e.template.originalAnimationClipData=t.animation.data),t.animation.data||(t.animation.data=e.template.originalAnimationClipData))}),setProperties(t),t}}]),e}(),heightTester=new Raycaster;heightTester.ray.direction.set(0,-1,0);var Ground=function(e){function t(e){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Ground",{transparent:!1,dim:e.drawDistance,texture:e.groundTexture,model:e.groundModel,shadow:e.enableShadows,progress:e.progress}))}return inherits(t,e),createClass(t,[{key:"moveTo",value:function(e){this.isInfinite&&this.position.set(Math.floor(e.x),0,Math.floor(e.z))}},{key:"getHeightAt",value:function(e){if(this.model){heightTester.ray.origin.copy(e),heightTester.ray.origin.y=100;var t=heightTester.intersectObject(this.model);if(t.length>0){var i=t[0];return 100-i.distance}}}},{key:"_ready",get:function(){var e=this,t=this.options.dim,i=_typeof(this.options.texture),r=null;return this.model=null,this.isInfinite=null,this.options.model?r=ModelFactory.loadObject(this.options.model).then(function(t){e.model=t,e.isInfinite=!1}):"number"===i?(this.isInfinite=!0,this.model=quad(t,t).colored(this.options.texture,this.options),r=Promise.resolve()):"string"===i?(this.isInfinite=!0,this.model=new Image(this.options.texture,Object.assign({},this.options,{width:t,height:t,txtRepeatX:t,txtRepeatY:t,anisotropy:8})),r=this.model.ready):(this.model=new Object3D,r=Promise.resolve()),r=r.then(function(){if(null!=e.isInfinite&&(e.model.receiveShadow=e.options.shadow,e.model.named(e.name+"-"+(e.options.model||e.options.texture)).addTo(e),e.watch(e.model,Pointer.EVENTS),e.rigidBody=new cannon.Body({mass:0}),e.isInfinite)){var t=new cannon.Plane;e.rigidBody.addShape(t),e.rigidBody.quaternion.setFromVectors(cannon.Vec3.UNIT_Z,cannon.Vec3.UNIT_Y)}})}}]),t}(Entity),Sky=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Sky",{transparent:!1,useFog:!1,unshaded:!0,skyRadius:e.drawDistance,texture:e.skyTexture,progress:e.progress,enableShadows:e.enableShadows,shadowMapSize:e.shadowMapSize,shadowCameraSize:e.shadowCameraSize,shadowRadius:e.shadowRadius}));return i._image=null,e.disableDefaultLighting?(i.ambient=null,i.sun=null):(i.ambient=new AmbientLight(16777215,.5).addTo(i),i.sun=new DirectionalLight(16777215,1).addTo(i).at(0,100,100),i.add(i.sun.target),i.options.enableShadows&&(i.sun.castShadow=!0,i.sun.shadow.mapSize.width=i.sun.shadow.mapSize.height=i.options.shadowMapSize,i.sun.shadow.radius=i.options.shadowRadius,i.sun.shadow.camera.top=i.sun.shadow.camera.right=i.options.shadowCameraSize,i.sun.shadow.camera.bottom=i.sun.shadow.camera.left=-i.options.shadowCameraSize,i.sun.shadow.camera.updateProjectionMatrix())),i}return inherits(t,e),createClass(t,[{key:"replace",value:function(e){return this.options.texture=e,this.children.splice(0),this._ready}},{key:"_ready",get:function(){var e=_typeof(this.options.texture);if("number"===e){var i=this.options.skyRadius/Math.sqrt(2);this.options.side=BackSide,this.add(box(i,i,i).colored(this.options.texture,this.options))}else("string"===e||this.options.texture instanceof Array&&6===this.options.texture.length&&"string"==typeof this.options.texture[0])&&(this._image=new Image(this.options.texture,this.options),this.add(this._image));return this._image&&this._image.ready||get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_ready",this)}}]),t}(Entity),reverse=function(){function e(r){r=r.replace(t,function(t,i,r){return e(r)+i}).replace(i,"$2$1");for(var n="",o=r.length-1;o>=0;--o)n+=r[o];return n}var t=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,i=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;return e}(),Cursor=function(){function e(t,i,r){classCallCheck(this,e),this.i=t||0,this.x=i||0,this.y=r||0,this.moved=!0}return createClass(e,null,[{key:"min",value:function(e,t){return e.i<=t.i?e:t}},{key:"max",value:function(e,t){return e.i>t.i?e:t}}]),createClass(e,[{key:"clone",value:function(){return new e(this.i,this.x,this.y)}},{key:"toString",value:function(){return"[i:"+this.i+" x:"+this.x+" y:"+this.y+"]"}},{key:"copy",value:function(e){this.i=e.i,this.x=e.x,this.y=e.y,this.moved=!1}},{key:"fullhome",value:function(){this.i=0,this.x=0,this.y=0,this.moved=!0}},{key:"fullend",value:function(e){this.i=0;for(var t=0,i=0;i<e.length;++i){var r=e[i];t=r.length,this.i+=t}this.y=e.length-1,this.x=t,this.moved=!0}},{key:"skipleft",value:function(e){if(0===this.x)this.left(e);else{var t=this.x-1,i=e[this.y],r=reverse(i.substring(0,t)),n=r.match(/(\s|\W)+/),o=n?n.index+n[0].length+1:r.length;this.i-=o,this.x-=o}this.moved=!0}},{key:"left",value:function(e){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var t=e[this.y];this.x=t.length}this.reverseFromNewline(e)&&++this.i}this.moved=!0}},{key:"skipright",value:function(e){var t=e[this.y];if(this.x===t.length||"\n"===t[this.x])this.right(e);else{var i=this.x+1;t=t.substring(i);var r=t.match(/(\s|\W)+/),n=r?r.index+r[0].length+1:t.length-this.x;this.i+=n,this.x+=n,this.reverseFromNewline(e)}this.moved=!0}},{key:"fixCursor",value:function(e){this.x=this.i,this.y=0;for(var t=0,i=e[this.y];this.x>i.length;){if(this.x-=i.length,t+=i.length,this.y>=e.length-1){this.i=t,this.x=i.length,this.moved=!0;break}++this.y,i=e[this.y]}return this.moved}},{key:"right",value:function(e){this.advanceN(e,1)}},{key:"advanceN",value:function(e,t){var i=e[this.y];(this.y<e.length-1||this.x<i.length)&&(this.i+=t,this.fixCursor(e),i=e[this.y],this.x>0&&"\n"===i[this.x-1]&&(++this.y,this.x=0)),this.moved=!0}},{key:"home",value:function(){this.i-=this.x,this.x=0,this.moved=!0}},{key:"end",value:function(e){var t=e[this.y],i=t.length-this.x;this.i+=i,this.x+=i,this.reverseFromNewline(e),this.moved=!0}},{key:"up",value:function(e){if(this.y>0){--this.y;var t=e[this.y],i=Math.min(0,t.length-this.x);this.x+=i,this.i-=t.length-i,this.reverseFromNewline(e)}this.moved=!0}},{key:"down",value:function(e){if(this.y<e.length-1){++this.y;var t=e[this.y],i=e[this.y-1],r=Math.min(0,t.length-this.x);this.x+=r,this.i+=i.length+r,this.reverseFromNewline(e)}this.moved=!0}},{key:"incY",value:function(e,t){this.y=Math.max(0,Math.min(t.length-1,this.y+e));var i=t[this.y];this.x=Math.max(0,Math.min(i.length,this.x)),this.i=this.x;for(var r=0;r<this.y;++r)this.i+=t[r].length;this.reverseFromNewline(t),this.moved=!0}},{key:"setXY",value:function(e,t,i){this.y=Math.max(0,Math.min(i.length-1,t));var r=i[this.y];this.x=Math.max(0,Math.min(r.length,e)),this.i=this.x;for(var n=0;n<this.y;++n)this.i+=i[n].length;this.reverseFromNewline(i),this.moved=!0}},{key:"setI",value:function(e,t){this.i=e,this.fixCursor(t),this.moved=!0}},{key:"reverseFromNewline",value:function(e){var t=e[this.y];return this.x>0&&"\n"===t[this.x-1]&&(--this.x,--this.i,!0)}}]),e}(),CommandPack=function e(t,i){classCallCheck(this,e),this.name=t,Object.assign(this,i)},BasicTextInput=function(e){function t(e,i){classCallCheck(this,t);var r={NORMAL_LEFTARROW:function(e,t){e.cursorLeft(t,e.frontCursor)},NORMAL_SKIPLEFT:function(e,t){e.cursorSkipLeft(t,e.frontCursor)},NORMAL_RIGHTARROW:function(e,t){e.cursorRight(t,e.frontCursor)},NORMAL_SKIPRIGHT:function(e,t){e.cursorSkipRight(t,e.frontCursor)},NORMAL_HOME:function(e,t){e.cursorHome(t,e.frontCursor)},NORMAL_END:function(e,t){e.cursorEnd(t,e.frontCursor)},NORMAL_BACKSPACE:function(e,t){e.frontCursor.i===e.backCursor.i&&e.frontCursor.left(t),e.selectedText="",e.scrollIntoView(e.frontCursor)},NORMAL_ENTER:function(e,t,i){e.emit("change",{target:e})},NORMAL_DELETE:function(e,t){e.frontCursor.i===e.backCursor.i&&e.backCursor.right(t),e.selectedText="",e.scrollIntoView(e.frontCursor)},NORMAL_TAB:function(e,t){e.selectedText=e.tabString},SHIFT_LEFTARROW:function(e,t){e.cursorLeft(t,e.backCursor)},SHIFT_SKIPLEFT:function(e,t){e.cursorSkipLeft(t,e.backCursor)},SHIFT_RIGHTARROW:function(e,t){e.cursorRight(t,e.backCursor)},SHIFT_SKIPRIGHT:function(e,t){e.cursorSkipRight(t,e.backCursor)},SHIFT_HOME:function(e,t){e.cursorHome(t,e.backCursor)},SHIFT_END:function(e,t){e.cursorEnd(t,e.backCursor)},SHIFT_DELETE:function(e,t){e.frontCursor.i===e.backCursor.i&&(e.frontCursor.home(t),e.backCursor.end(t)),e.selectedText="",e.scrollIntoView(e.frontCursor)},CTRL_HOME:function(e,t){e.cursorFullHome(t,e.frontCursor)},CTRL_END:function(e,t){e.cursorFullEnd(t,e.frontCursor)},CTRLSHIFT_HOME:function(e,t){e.cursorFullHome(t,e.backCursor)},CTRLSHIFT_END:function(e,t){e.cursorFullEnd(t,e.backCursor)},SELECT_ALL:function(e,t){e.frontCursor.fullhome(t),e.backCursor.fullend(t)},REDO:function(e,t){e.redo(),e.scrollIntoView(e.frontCursor)},UNDO:function(e,t){e.undo(),e.scrollIntoView(e.frontCursor)}};if(i)for(var n in i)r[n]=i[n];return possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e||"Text editor commands",r))}return inherits(t,e),t}(CommandPack),TextEditor=new BasicTextInput("Text Area input commands",{NORMAL_UPARROW:function(e,t){e.cursorUp(t,e.frontCursor)},NORMAL_DOWNARROW:function(e,t){e.cursorDown(t,e.frontCursor)},NORMAL_PAGEUP:function(e,t){e.cursorPageUp(t,e.frontCursor)},NORMAL_PAGEDOWN:function(e,t){e.cursorPageDown(t,e.frontCursor)},NORMAL_ENTER:function(e,t,i){var r="",n=t[e.frontCursor.y];n.length>0&&"whitespace"===n[0].type&&(r=n[0].value),e.selectedText="\n"+r,e.scrollIntoView(e.frontCursor)},SHIFT_UPARROW:function(e,t){e.cursorUp(t,e.backCursor)},SHIFT_DOWNARROW:function(e,t){e.cursorDown(t,e.backCursor)},SHIFT_PAGEUP:function(e,t){e.cursorPageUp(t,e.backCursor)},SHIFT_PAGEDOWN:function(e,t){e.cursorPageDown(t,e.backCursor)},WINDOW_SCROLL_DOWN:function(e,t){e.scroll.y<t.length&&++e.scroll.y},WINDOW_SCROLL_UP:function(e,t){e.scroll.y>0&&--e.scroll.y}}),Rule=function(){function e(t,i){classCallCheck(this,e),this.name=t,this.test=i}return createClass(e,[{key:"carveOutMatchedToken",value:function(e,t){var i=e[t];if("regular"===i.type){var r=this.test.exec(i.value);if(r){var n=r[r.length-1],o=r.input.indexOf(n),a=o+n.length;if(0===o){if(i.type=this.name,a<i.value.length){var s=i.splitAt(a);s.type="regular",e.splice(t+1,0,s)}}else{var l=i.splitAt(o);if(n.length<l.value.length){var c=l.splitAt(n.length);e.splice(t+1,0,c)}l.type=this.name,e.splice(t+1,0,l)}}}}}]),e}(),Token=function(){function e(t,i,r,n){classCallCheck(this,e),this.value=t,this.type=i,this.index=r,this.line=n}return createClass(e,[{key:"clone",value:function(){return new e(this.value,this.type,this.index,this.line)}},{key:"splitAt",value:function(t){var i=this.value.substring(t);return this.value=this.value.substring(0,t),new e(i,this.type,this.index+t,this.line)}},{key:"toString",value:function(){return"["+this.type+": "+this.value+"]"}}]),e}(),Grammar=function(){function e(t,i){function r(e){var t,i,r=null,n=null,o=0;for(t=0;t<e.length;++t)i=e[t],i.line=o,"newlines"===i.type&&++o,n?("stringDelim"!==i.type||i.value!==n||0!==t&&"\\"===e[t-1].value[e[t-1].value.length-1]||(n=null),"newlines"!==i.type&&(i.type="strings")):r?(("startBlockComments"===r&&"endBlockComments"===i.type||"startLineComments"===r&&"newlines"===i.type)&&(r=null),"newlines"!==i.type&&(i.type="comments")):"stringDelim"===i.type?(n=i.value,i.type="strings"):"startBlockComments"!==i.type&&"startLineComments"!==i.type||(r=i.type,i.type="comments");for(t=e.length-1;t>0;--t){var a=e[t-1];i=e[t],a.type===i.type&&"newlines"!==a.type&&(a.value+=i.value,e.splice(t,1))}}classCallCheck(this,e),this.name=t,this.grammar=i.map(function(e){return new Rule(e[0],e[1])}),this.tokenize=function(e){for(var t=[new Token(e,"regular",0)],i=0;i<this.grammar.length;++i)for(var n=this.grammar[i],o=0;o<t.length;++o)n.carveOutMatchedToken(t,o);return r(t),t}}return createClass(e,[{key:"toHTML",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Default,i=this.tokenize(e),r=document.createElement("div"),n=0;n<i.length;++n){var o=i[n];if("newlines"===o.type)r.appendChild(document.createElement("br"));else{var a=t[o.type]||{},s=document.createElement("span");s.style.fontWeight=a.fontWeight||t.regular.fontWeight,s.style.fontStyle=a.fontStyle||t.regular.fontStyle||"",s.style.color=a.foreColor||t.regular.foreColor,s.style.backgroundColor=a.backColor||t.regular.backColor,s.style.fontFamily=a.fontFamily||t.fontFamily,s.appendChild(document.createTextNode(o.value)),r.appendChild(s)}}return r.innerHTML}}]),e}(),JavaScript=new Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["regexes",/(?:^|,|;|\(|\[|\{)(?:\s*)(\/(?:\\\/|[^\n\/])+\/)/],["stringDelim",/("|')/],["startLineComments",/\/\/.*$/m],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|class|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(\w+)\./],["members",/((\w+\.)+)(\w+)/]]),SCROLL_SCALE=isFirefox?3:100,COUNTER$6=0,OFFSET=0,TextBox=function(e){function t(e){classCallCheck(this,t),"string"==typeof e&&(e={value:e});var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({},{id:"Primrose.Controls.TextBox["+COUNTER$6++ +"]"},e)));i.isTextBox=!0,i.useCaching=!isFirefox||!isMobile;var r=function(e){var t=e.toLowerCase();this["cursor"+e]=function(e,i){i[t](e),this.scrollIntoView(i)}};["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(r.bind(i)),i.tokens=null,i.lines=null,i._commandPack=null,i._tokenRows=null,i._tokenHashes=null,i._tabString=null,i._currentTouchID=null,i._lineCountWidth=null,i._lastFont=null,i._lastText=null,i._lastCharacterWidth=null,i._lastCharacterHeight=null,i._lastGridBounds=null,i._lastPadding=null,i._lastFrontCursor=null,i._lastBackCursor=null,i._lastWidth=-1,i._lastHeight=-1,
i._lastScrollX=-1,i._lastScrollY=-1,i._lastFocused=!1,i._lastThemeName=null,i._lastPointer=new Point,i._browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",i._pointer=new Point,i._history=[],i._historyFrame=-1,i._topLeftGutter=new Size,i._bottomRightGutter=new Size,i._dragging=!1,i._scrolling=!1,i._wheelScrollSpeed=4;var n=new Rectangle(0,0,i.bounds.width,i.bounds.height);return i._fg=new Surface({id:i.id+"-fore",bounds:n}),i._fgCanvas=i._fg.canvas,i._fgfx=i._fg.context,i._bg=new Surface({id:i.id+"-back",bounds:n}),i._bgCanvas=i._bg.canvas,i._bgfx=i._bg.context,i._trim=new Surface({id:i.id+"-trim",bounds:n}),i._trimCanvas=i._trim.canvas,i._tgfx=i._trim.context,i._rowCache={},i._VSCROLL_WIDTH=2,i.tabWidth=i.options.tabWidth,i.showLineNumbers=!i.options.hideLineNumbers,i.showScrollBars=!i.options.hideScrollBars,i.wordWrap=!i.options.disableWordWrap,i.readOnly=!!i.options.readOnly,i.multiline=!i.options.singleLine,i.gridBounds=new Rectangle,i.frontCursor=new Cursor,i.backCursor=new Cursor,i.scroll=new Point,i.character=new Size,i.theme=i.options.theme,i.fontSize=i.options.fontSize,i.tokenizer=i.options.tokenizer,i.commandPack=i.options.commands||TextEditor,i.value=i.options.value,i.padding=i.options.padding||1,i.addEventListener("visiblechanged",i.blur.bind(i)),i}return inherits(t,e),createClass(t,[{key:"cursorPageUp",value:function(e,t){t.incY(-this.gridBounds.height,e),this.scrollIntoView(t)}},{key:"cursorPageDown",value:function(e,t){t.incY(this.gridBounds.height,e),this.scrollIntoView(t)}},{key:"pushUndo",value:function(e){this._historyFrame<this._history.length-1&&this._history.splice(this._historyFrame+1),this._history.push(e),this._historyFrame=this._history.length-1,this.refreshTokens(),this.render()}},{key:"redo",value:function(){this._historyFrame<this._history.length-1&&++this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"undo",value:function(){this._historyFrame>0&&--this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"scrollIntoView",value:function(e){this.scroll.y+=this.minDelta(e.y,this.scroll.y,this.scroll.y+this.gridBounds.height),this.wordWrap||(this.scroll.x+=this.minDelta(e.x,this.scroll.x,this.scroll.x+this.gridBounds.width)),this.clampScroll()}},{key:"readWheel",value:function(e){this.focused&&((e.shiftKey||isChrome)&&(this.fontSize+=-e.deltaX/SCROLL_SCALE),e.shiftKey&&!isChrome||(this.scroll.y+=Math.floor(e.deltaY*this._wheelScrollSpeed/SCROLL_SCALE)),this.clampScroll(),this.render(),e.preventDefault())}},{key:"startPointer",value:function(e,i){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"startPointer",this).call(this,e,i)||(this._dragging=!0,this.setCursorXY(this.frontCursor,e,i))}},{key:"movePointer",value:function(e,t){this._dragging&&this.setCursorXY(this.backCursor,e,t)}},{key:"endPointer",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"endPointer",this).call(this),this._dragging=!1,this._scrolling=!1}},{key:"copySelectedText",value:function(e){if(this.focused&&this.frontCursor.i!==this.backCursor.i){var t=e.clipboardData||window.clipboardData;t.setData(window.clipboardData?"Text":"text/plain",this.selectedText),e.returnValue=!1}}},{key:"cutSelectedText",value:function(e){this.focused&&(this.copySelectedText(e),this.readOnly||(this.selectedText=""))}},{key:"keyDown",value:function(e){if(this.focused&&!this.readOnly){var t=this.commandPack[e.altCmdName]||this.commandPack[e.cmdName]||e.altCmdText||e.cmdText;(t instanceof String||"string"==typeof t)&&(console.warn("This shouldn't have happened."),t=this.commandPack[t]||this.commandPack[t]||t),t&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,t instanceof Function?t(this,this.lines):(t instanceof String||"string"==typeof t)&&(console.log(t),this.selectedText=t),e.resetDeadKeyState(),e.preventDefault(),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),this.clampScroll(),this.render())}}},{key:"readClipboard",value:function(e){if(this.focused&&!this.readOnly){e.returnValue=!1;var t=e.clipboardData||window.clipboardData,i=t.getData(window.clipboardData?"Text":"text/plain");i&&(this.selectedText=i)}}},{key:"resize",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"resize",this).call(this),this._bg.setSize(this.surfaceWidth,this.surfaceHeight),this._fg.setSize(this.surfaceWidth,this.surfaceHeight),this._trim.setSize(this.surfaceWidth,this.surfaceHeight),this.theme&&(this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100),this.render()}},{key:"pixel2cell",value:function(e){e.x*this.imageWidth/this.surfaceWidth,e.y*this.imageHeight/this.surfaceHeight;e.set(Math.round(e.x/this.character.width)+this.scroll.x-this.gridBounds.x,Math.floor(e.y/this.character.height-.25)+this.scroll.y)}},{key:"clampScroll",value:function(){if(this.scroll.y<0)this.scroll.y=0;else for(;0<this.scroll.y&&this.scroll.y>this.lines.length-this.gridBounds.height;)--this.scroll.y}},{key:"refreshTokens",value:function(){this.tokens=this.tokenizer.tokenize(this.value)}},{key:"fixCursor",value:function(){var e=this.frontCursor.fixCursor(this.lines)||this.backCursor.fixCursor(this.lines);e&&this.render()}},{key:"setCursorXY",value:function(e,t,i){t=Math.round(t),i=Math.round(i),this._pointer.set(t,i),this.pixel2cell(this._pointer,this.scroll,this.gridBounds);var r=this._pointer.x-this.scroll.x,n=this._pointer.y-this.scroll.y,o=n>=this.gridBounds.height,a=r<0,s=this._pointer.x>=this.gridBounds.width;if(this._scrolling||o||a||s){if(this._scrolling||s&&!o){this._scrolling=!0;var l=this.lines.length-this.gridBounds.height;if(n>=0&&l>=0){var c=n*l/this.gridBounds.height;this.scroll.y=Math.floor(c)}}else if(o&&!a){for(var h=0,u=0;u<this.lines.length;++u)h=Math.max(h,this.lines[u].length);var d=h-this.gridBounds.width;if(r>=0&&d>=0){var p=r*d/this.gridBounds.width;this.scroll.x=Math.floor(p)}}}else e.setXY(this._pointer.x,this._pointer.y,this.lines),this.backCursor.copy(e);this._lastPointer.copy(this._pointer),this.render()}},{key:"setGutter",value:function(){this.showLineNumbers?this._topLeftGutter.width=1:this._topLeftGutter.width=0,this.showScrollBars?this.wordWrap?this._bottomRightGutter.set(this._VSCROLL_WIDTH,0):this._bottomRightGutter.set(this._VSCROLL_WIDTH,1):this._bottomRightGutter.set(0,0)}},{key:"refreshGridBounds",value:function(){this._lineCountWidth=0,this.showLineNumbers&&(this._lineCountWidth=Math.max(1,Math.ceil(Math.log(this._history[this._historyFrame].length)/Math.LN10)));var e=Math.floor(this._topLeftGutter.width+this._lineCountWidth+this.padding/this.character.width),t=Math.floor(this.padding/this.character.height),i=Math.floor((this.imageWidth-2*this.padding)/this.character.width)-e-this._bottomRightGutter.width,r=Math.floor((this.imageHeight-2*this.padding)/this.character.height)-t-this._bottomRightGutter.height;this.gridBounds.set(e,t,i,r)}},{key:"performLayout",value:function(){this._tokenRows=[[]],this._tokenHashes=[""],this.lines=[""];for(var e=0,t=this.tokens.slice(),i=0;i<t.length;++i){var r=t[i].clone(),n=this.gridBounds.width-e,o=this.wordWrap&&"newlines"!==r.type&&r.value.length>n,a="newlines"===r.type||o;if(o){var s=r.value.length>this.gridBounds.width?n:0;t.splice(i+1,0,r.splitAt(s))}r.value.length>0&&(this._tokenRows[this._tokenRows.length-1].push(r),this._tokenHashes[this._tokenHashes.length-1]+=JSON.stringify(r),this.lines[this.lines.length-1]+=r.value,e+=r.value.length),a&&(this._tokenRows.push([]),this._tokenHashes.push(""),this.lines.push(""),e=0)}}},{key:"minDelta",value:function(e,t,i){var r=e-t,n=e-i+5,o=0;return(r<0||n>=0)&&(o=Math.abs(r)<Math.abs(n)?r:n),o}},{key:"fillRect",value:function(e,t,i,r,n,o){e.fillStyle=t,e.fillRect(i*this.character.width,r*this.character.height,n*this.character.width+1,o*this.character.height+1)}},{key:"strokeRect",value:function(e,t,i,r,n,o){e.strokeStyle=t,e.strokeRect(i*this.character.width,r*this.character.height,n*this.character.width+1,o*this.character.height+1)}},{key:"renderCanvasBackground",value:function(){var e=Cursor.min(this.frontCursor,this.backCursor),t=Cursor.max(this.frontCursor,this.backCursor),i=new Cursor,r=new Cursor,n=this.theme.regular.backColor?"fillRect":"clearRect",o=OFFSET/this.character.height;this.theme.regular.backColor&&(this._bgfx.fillStyle=this.theme.regular.backColor),this._bgfx[n](0,0,this.imageWidth,this.imageHeight),this._bgfx.save(),this._bgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,-this.scroll.y*this.character.height+this.padding),this.focused&&this.fillRect(this._bgfx,this.theme.regular.currentRowBackColor||Default.regular.currentRowBackColor,0,e.y+o,this.gridBounds.width,t.y-e.y+1);for(var a=0;a<this._tokenRows.length;++a){for(var s=this._tokenRows[a],l=0;l<s.length;++l){var c=s[l];if(r.x+=c.value.length,r.i+=c.value.length,this.scroll.y<=a&&a<this.scroll.y+this.gridBounds.height&&this.scroll.x<=r.x&&i.x<this.scroll.x+this.gridBounds.width){var h=e.i<=r.i&&i.i<t.i;if(h){var u=Cursor.max(e,i),d=Cursor.min(t,r),p=d.i-u.i;this.fillRect(this._bgfx,this.theme.regular.selectedBackColor||Default.regular.selectedBackColor,u.x,u.y+o,p,1)}}i.copy(r)}i.x=0,++i.y,r.copy(i)}if(this.focused){var f=this.theme.cursorColor||"black",m=1/this.character.width;this.fillRect(this._bgfx,f,e.x,e.y+o,m,1),this.fillRect(this._bgfx,f,t.x,t.y+o,m,1)}this._bgfx.restore()}},{key:"renderCanvasForeground",value:function(){var e=new Cursor,t=new Cursor;this._fgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._fgfx.save(),this._fgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,this.padding);for(var i=0;i<this._tokenRows.length;++i){for(var r=this.lines[i]+this.padding,n=this._tokenRows[i],o=!1,a=(i-this.scroll.y)*this.character.height,s=0;s<n.length;++s){var l=n[s];if(t.x+=l.value.length,t.i+=l.value.length,this.scroll.y<=i&&i<this.scroll.y+this.gridBounds.height&&this.scroll.x<=t.x&&e.x<this.scroll.x+this.gridBounds.width)if(this.useCaching&&void 0!==this._rowCache[r])0===s&&this._fgfx.putImageData(this._rowCache[r],this.padding,a+this.padding+OFFSET);else{var c=this.theme[l.type]||{},h=(c.fontWeight||this.theme.regular.fontWeight||"")+" "+(c.fontStyle||this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this._fgfx.font=h.trim(),this._fgfx.fillStyle=c.foreColor||this.theme.regular.foreColor,this.drawText(this._fgfx,l.value,e.x*this.character.width,a),o=!0}e.copy(t)}e.x=0,++e.y,t.copy(e),this.useCaching&&o&&void 0===this._rowCache[r]&&(this._rowCache[r]=this._fgfx.getImageData(this.padding,a+this.padding+OFFSET,this.imageWidth-2*this.padding,this.character.height))}this._fgfx.restore()}},{key:"drawText",value:function(e,t,i,r){e.fillText(t,i,r)}},{key:"renderCanvasTrim",value:function(){var e=new Cursor,t=new Cursor,i=0;this._tgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._tgfx.save(),this._tgfx.translate(this.padding,this.padding),this._tgfx.save(),this._tgfx.lineWidth=2,this._tgfx.translate(0,-this.scroll.y*this.character.height);for(var r=0,n=-1;r<this._tokenRows.length;++r){for(var o=this._tokenRows[r],a=0;a<o.length;++a){var s=o[a];t.x+=s.value.length,t.i+=s.value.length,e.copy(t)}if(i=Math.max(i,t.x),e.x=0,++e.y,t.copy(e),this.showLineNumbers&&this.scroll.y<=r&&r<this.scroll.y+this.gridBounds.height){for(var l=o.length>0?o[0].line:n+1,c=l.toString();c.length<this._lineCountWidth;)c=" "+c;this.fillRect(this._tgfx,this.theme.regular.selectedBackColor||Default.regular.selectedBackColor,0,r,this.gridBounds.x,1),this._tgfx.font="bold "+this.character.height+"px "+this.theme.fontFamily,l>n&&(this._tgfx.fillStyle=this.theme.regular.foreColor,this._tgfx.fillText(c,0,r*this.character.height)),n=l}}if(this._tgfx.restore(),this.showLineNumbers&&this.strokeRect(this._tgfx,this.theme.regular.foreColor||Default.regular.foreColor,0,0,this.gridBounds.x,this.gridBounds.height),this.showScrollBars){var h=this.gridBounds.width*this.character.width-this.padding,u=this.gridBounds.height*this.character.height,d=this.scroll.x*h/i+this.gridBounds.x*this.character.width,p=this.scroll.y*u/this._tokenRows.length;this._tgfx.fillStyle=this.theme.regular.selectedBackColor||Default.regular.selectedBackColor;var f;if(!this.wordWrap&&i>this.gridBounds.width){var m=h*(this.gridBounds.width/i),v=this.gridBounds.height*this.character.height;f=Math.max(this.character.width,m),this._tgfx.fillRect(d,v,f,this.character.height),this._tgfx.strokeRect(d,v,f,this.character.height)}if(this._tokenRows.length>this.gridBounds.height){var g=u*(this.gridBounds.height/this._tokenRows.length),y=this.image-this._VSCROLL_WIDTH*this.character.width-2*this.padding,x=Math.max(this.character.height,g);f=this._VSCROLL_WIDTH*this.character.width,this._tgfx.fillRect(y,p,f,x),this._tgfx.strokeRect(y,p,f,x)}}this._tgfx.lineWidth=2,this._tgfx.restore(),this._tgfx.strokeRect(1,1,this.imageWidth-2,this.imageHeight-2),this.focused||(this._tgfx.fillStyle=this.theme.regular.unfocused||Default.regular.unfocused,this._tgfx.fillRect(0,0,this.imageWidth,this.imageHeight))}},{key:"render",value:function(){if(this.tokens&&this.theme){this.refreshGridBounds();var e=this.gridBounds.toString()!==this._lastGridBounds,t=this._lastText!==this.value,i=this.character.width!==this._lastCharacterWidth,r=this.character.height!==this._lastCharacterHeight,n=this.padding!==this._lastPadding,o=!this._lastFrontCursor||!this._lastBackCursor||this.frontCursor.i!==this._lastFrontCursor.i||this._lastBackCursor.i!==this.backCursor.i,a=this.scroll.x!==this._lastScrollX||this.scroll.y!==this._lastScrollY,s=(this.context.font!==this._lastFont,this.theme.name!==this._lastThemeName),l=this.focused!==this._lastFocused,c=null,h=this.resized||e||t||i||r||n,u=h||o||a||s,d=u||t,p=u||l,f=d||u||p;if(h&&(this.performLayout(this.gridBounds),this._rowCache={}),f){if(o&&!(h||a||s||l)){var m=Math.min(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+this.gridBounds.y,v=Math.max(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+1;c=new Rectangle(0,m*this.character.height,this.bounds.width,(v-m)*this.character.height+2)}u&&this.renderCanvasBackground(),d&&this.renderCanvasForeground(),p&&this.renderCanvasTrim(),this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.context.drawImage(this._bgCanvas,0,0),this.context.drawImage(this._fgCanvas,0,0),this.context.drawImage(this._trimCanvas,0,0),this.invalidate(c)}this._lastGridBounds=this.gridBounds.toString(),this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastPadding=this.padding,this._lastFrontCursor=this.frontCursor.clone(),this._lastBackCursor=this.backCursor.clone(),this._lastFocused=this.focused,this._lastFont=this.context.font,this._lastThemeName=this.theme.name,this._lastScrollX=this.scroll.x,this._lastScrollY=this.scroll.y}}},{key:"value",get:function(){return this._history[this._historyFrame].join("\n")},set:function(e){e=e||"",e=e.replace(/\r\n/g,"\n"),this.multiline||(e=e.replace(/\n/g,""));var t=e.split("\n");this.pushUndo(t),this.render(),this.emit("change",{target:this})}},{key:"selectedText",get:function(){var e=Cursor.min(this.frontCursor,this.backCursor),t=Cursor.max(this.frontCursor,this.backCursor);return this.value.substring(e.i,t.i)},set:function(e){if(e=e||"",e=e.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||e.length>0){var t=Cursor.min(this.frontCursor,this.backCursor),i=Cursor.max(this.frontCursor,this.backCursor),r=this.value,n=r.substring(0,t.i),o=r.substring(i.i),a=n+e+o;this.value=a,this.refreshGridBounds(),this.performLayout(),t.advanceN(this.lines,Math.max(0,e.length)),this.scrollIntoView(i),this.clampScroll(),i.copy(t),this.render()}}},{key:"padding",get:function(){return this._padding},set:function(e){this._padding=e,this.render()}},{key:"wordWrap",get:function(){return this._wordWrap},set:function(e){this._wordWrap=e||!1,this.setGutter()}},{key:"showLineNumbers",get:function(){return this._showLineNumbers},set:function(e){this._showLineNumbers=e,this.setGutter()}},{key:"showScrollBars",get:function(){return this._showScrollBars},set:function(e){this._showScrollBars=e,this.setGutter()}},{key:"theme",get:function(){return this._theme},set:function(e){this._theme=Object.assign({},Default,e),this._theme.fontSize=this.fontSize,this._rowCache={},this.render()}},{key:"commandPack",get:function(){return this._commandPack},set:function(e){this._commandPack=e}},{key:"selectionStart",get:function(){return this.frontCursor.i},set:function(e){this.frontCursor.setI(e,this.lines)}},{key:"selectionEnd",get:function(){return this.backCursor.i},set:function(e){this.backCursor.setI(e,this.lines)}},{key:"selectionDirection",get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}},{key:"tokenizer",get:function(){return this._tokenizer},set:function(e){this._tokenizer=e||JavaScript,this._history&&this._history.length>0&&(this.refreshTokens(),this.render())}},{key:"tabWidth",get:function(){return this._tabWidth},set:function(e){this._tabWidth=e||2,this._tabString="";for(var t=0;t<this._tabWidth;++t)this._tabString+=" "}},{key:"tabString",get:function(){return this._tabString}},{key:"fontSize",get:function(){return this._fontSize||16},set:function(e){e=e||16,this._fontSize=e,this.theme&&(this.theme.fontSize=this._fontSize,this.resize(),this.render())}},{key:"lockMovement",get:function(){return this.focused&&!this.readOnly}}]),t}(Surface),piOver180=Math.PI/180,rad45=.25*Math.PI,defaultOrientation=new Float32Array([0,0,0,1]),defaultPosition=new Float32Array([0,0,0]),VRFrameData=function e(){classCallCheck(this,e),this.leftProjectionMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.rightViewMatrix=new Float32Array(16),this.pose=null},nextDisplayId=1e3,VRDisplay=function(){function e(t){classCallCheck(this,e),this._currentLayers=[],Object.defineProperties(this,{capabilities:immutable(Object.defineProperties({},{hasPosition:immutable(!1),hasOrientation:immutable(isMobile),hasExternalDisplay:immutable(!1),canPresent:immutable(!0),maxLayers:immutable(1)})),displayId:immutable(nextDisplayId++),displayName:immutable(t),stageParameters:immutable(null),isPresenting:immutable(function(){return FullScreen.isActive}),depthNear:mutable(.01,"number"),depthFar:mutable(1e4,"number"),isPolyfilled:immutable(!0)}),this._frameData=null,this._poseData=null}return createClass(e,[{key:"getFrameData",value:function(e){return this._frameData||(this._frameData=frameDataFromPose(e,this.getPose(),this)),this._frameData}},{key:"getPose",value:function(){return this._poseData||(this._poseData=this._getPose()),this._poseData}},{key:"requestAnimationFrame",value:function(e){return window.requestAnimationFrame(e)}},{key:"cancelAnimationFrame",value:function(e){return window.cancelAnimationFrame(e)}},{key:"requestPresent",value:function(e){for(var t=0;t<this.capabilities.maxLayers&&t<e.length;++t)this._currentLayers[t]=e[t];var i=e[0].source;return standardFullScreenBehavior(i)}},{key:"exitPresent",value:function(){return this._currentLayers.splice(0),standardExitFullScreenBehavior()}},{key:"getLayers",value:function(){return this._currentLayers.slice()}},{key:"submitFrame",value:function(e){this._frameData=null,this._poseData=null}}]),e}(),DEG2RAD$1=_Math.DEG2RAD,RAD2DEG$1=_Math.RAD2DEG,defaultFieldOfView=100,StandardMonitorVRDisplay=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Full Screen"));return i._display=e,i}return inherits(t,e),createClass(t,[{key:"submitFrame",value:function(e){this._display&&this._display.isPolyfilled&&this._display.submitFrame(e)}},{key:"getPose",value:function(){var e=isMobile&&this._display;return e?e.getPose():defaultPose()}}]),t}(VRDisplay);mixinMonoscopicEyeParameters(StandardMonitorVRDisplay);var CommandState=function e(){classCallCheck(this,e),this.value=null,this.pressed=!1,this.wasPressed=!1,this.fireAgain=!1,this.lt=0,this.ct=0,this.repeatCount=0},InputProcessor=function(e){function t(e,i,r,n){classCallCheck(this,t);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));o.name=e,o.commands={},o.commandNames=[],o.enabled=!0,o.paused=!1,o.ready=!0,o.inPhysicalUse=!1,initState.call(o);var a=function(e){for(var t=0;t<Keys.MODIFIER_KEYS.length;++t){var i=Keys.MODIFIER_KEYS[t];o.inputState[i]=e[i+"Key"]}};window.addEventListener("keydown",a,!1),window.addEventListener("keyup",a,!1),window.addEventListener("focus",a,!1),o.axisNames=r||[];for(var s=0;s<o.axisNames.length;++s)o.inputState.axes[s]=0;for(var l in i)o.addCommand(l,i[l]);for(var c=0;c<Keys.MODIFIER_KEYS.length;++c)o.inputState[Keys.MODIFIER_KEYS[c]]=!1;return o.userActionHandlers=null,n&&window.addEventListener(n,function(e){if(o.userActionHandlers)for(var t=0;t<o.userActionHandlers.length;++t)o.userActionHandlers[t](e)}),o}return inherits(t,e),createClass(t,[{key:"addCommand",value:function(e,t){t.name=e,t=this.cloneCommand(t),"undefined"==typeof t.repetitions&&(t.repetitions=1),t.state=new CommandState,this.commands[e]=t,this.commandNames.push(e)}},{key:"cloneCommand",value:function(e){return{name:e.name,disabled:!!e.disabled,dt:e.dt||0,deadzone:e.deadzone||0,threshold:e.threshold||0,repetitions:e.repetitions,scale:e.scale,offset:e.offset,min:e.min,max:e.max,integrate:!!e.integrate,delta:!!e.delta,axes:this.maybeClone(e.axes),commands:e.commands&&e.commands.slice()||[],buttons:this.maybeClone(e.buttons),metaKeys:this.maybeClone(e.metaKeys&&e.metaKeys.map(filterMetaKey)),commandDown:e.commandDown,commandUp:e.commandUp}}},{key:"maybeClone",value:function(e){var t=[];if(e)for(var i=0;i<e.length;++i)t[i]=filterValue.call(this,e[i]);return t}},{key:"update",value:function(e){if(this.enabled&&this.ready&&this.inPhysicalUse&&!this.paused&&e>0){this.inputState.buttons[Keys.ANY]=!1;for(var t in this.inputState.buttons)if(this.inputState.buttons[t]){this.inputState.buttons[Keys.ANY]=!0;break}var i=recordLastState;for(var r in this.commands){var n=this.commands[r];if(n.state.wasPressed=n.state.pressed,n.state.pressed=!1,!n.disabled){var o=!0,a=0;if(n.metaKeys)for(var s=0;s<n.metaKeys.length&&o;++s){var l=n.metaKeys[s];o=o&&(this.inputState[Keys.MODIFIER_KEYS[l.index]]&&!l.toggle||!this.inputState[Keys.MODIFIER_KEYS[l.index]]&&l.toggle)}if(o){if(n.buttons.length>0)for(var c=0;c<n.buttons.length;++c){var h=n.buttons[c],u=h.index+1,d=!!this.inputState.buttons[u],p=d?h.sign:0;o=o&&(d&&!h.toggle||!d&&h.toggle),Math.abs(p)>Math.abs(a)&&(a=p)}if(0===n.buttons.length||0!==a){if(n.axes.length>0){a=0;for(var f=0;f<n.axes.length;++f){var m=n.axes[f],v=m.sign*this.inputState.axes[m.index];Math.abs(v)>Math.abs(a)&&(a=v)}}else if(n.commands.length>0){a=0;for(var g=0;g<n.commands.length;++g){var y=this.getValue(n.commands[g]);Math.abs(y)>Math.abs(a)&&(a=y)}}if(void 0!==n.scale&&(a*=n.scale),void 0!==n.offset&&(a+=n.offset),n.deadzone&&Math.abs(a)<n.deadzone&&(a=0),n.integrate)a=this.getValue(n.name)+a*e;else if(n.delta){var x=a;void 0!==n.state.lv&&(a-=n.state.lv),n.state.lv=x}void 0!==n.min&&a<n.min&&(a=n.min,i=resetInputState),void 0!==n.max&&a>n.max&&(a=n.max,i=resetInputState),n.threshold&&(o=o&&a>n.threshold)}}n.state.pressed=o,n.state.value=a,n.state.lt+=e,n.state.fireAgain=n.state.pressed&&n.state.lt>=n.dt&&(n.repetitions===-1||n.state.repeatCount<n.repetitions),n.state.fireAgain?(n.state.lt=0,++n.state.repeatCount):n.state.pressed||(n.state.repeatCount=0)}}i.call(this),this.fireCommands()}}},{key:"zero",value:function(){initState.call(this);for(var e in this.commands)this.commands[e].state=new CommandState}},{key:"fireCommands",value:function(){if(this.ready&&!this.paused)for(var e in this.commands){var t=this.commands[e];t.state.fireAgain&&t.commandDown&&t.commandDown(this.name),!t.state.pressed&&t.state.wasPressed&&t.commandUp&&t.commandUp(this.name)}}},{key:"setProperty",value:function(e,t,i){this.commands[t]&&(this.commands[t][e]=i)}},{key:"setDeadzone",value:function(e,t){this.setProperty("deadzone",e,t)}},{key:"setScale",value:function(e,t){this.setProperty("scale",e,t)}},{key:"setDT",value:function(e,t){this.setProperty("dt",e,t)}},{key:"setMin",value:function(e,t){this.setProperty("min",e,t)}},{key:"setMax",value:function(e,t){this.setProperty("max",e,t)}},{key:"addMetaKey",value:function(e,t){this.addToArray("metaKeys",e,filterMetaKey(t))}},{key:"addAxis",value:function(e,t){this.addToArray("axes",e,t)}},{key:"addButton",value:function(e,t){this.addToArray("buttons",e,t)}},{key:"removeMetaKey",value:function(e,t){this.removeFromArray("metaKeys",e,t)}},{key:"removeAxis",value:function(e,t){this.removeFromArray("axes",e,t)}},{key:"removeButton",value:function(e,t){this.removeFromArray("buttons",e,t)}},{key:"invertAxis",value:function(e,t){this.invertInArray("axes",e,t)}},{key:"invertButton",value:function(e,t){this.invertInArray("buttons",e,t)}},{key:"invertMetaKey",value:function(e,t){this.invertInArray("metaKeys",e,t)}},{key:"addToArray",value:function(e,t,i){this.commands[t]&&this.commands[t][e]&&this.commands[t][e].push(filterValue(i))}},{key:"removeFromArray",value:function(e,t,i){if(this.commands[t]&&this.commands[t][e]){--i;for(var r=this.commands[t][e],n=0;n<r.length;++n){var o=r[n];if(o.index===i)return r.splice(n,1)}}}},{key:"invertInArray",value:function(e,t,i){if(this.commands[t]&&this.commands[t][e])for(var r=this.commands[t][e],n=(r.indexOf(i),0);n<r.length;++n){var o=r[n];if(o.index===i)return void(o.sign*=-1)}}},{key:"pause",value:function(e){this.paused=e}},{key:"isPaused",value:function(){return this.paused}},{key:"enable",value:function(e,t){void 0!==t&&null!==t||(t=e,e=null),e?this.setProperty("disabled",e,!t):this.enabled=t}},{key:"isEnabled",value:function(e){return e&&this.commands[e]&&!this.commands[e].disabled}},{key:"getAxis",value:function(e){var t=this.axisNames.indexOf(e);if(t>-1){var i=this.inputState.axes[t]||0;return i}return null}},{key:"setAxis",value:function(e,t){var i=this.axisNames.indexOf(e);i>-1&&(this.inPhysicalUse||0!==t)&&(this.inputState.axes[i]=t)}},{key:"setButton",value:function(e,t){(this.inPhysicalUse||t)&&(this.inputState.buttons[e]=t)}},{key:"isDown",value:function(e){return this.enabled&&this.isEnabled(e)&&this.commands[e].state.pressed}},{key:"isUp",value:function(e){return this.enabled&&this.isEnabled(e)&&this.commands[e].state.pressed}},{key:"getValue",value:function(e){return this.enabled&&this.isEnabled(e)&&(this.commands[e].state.value||this.getAxis(e))||0}},{key:"setValue",value:function(e,t){var i=this.axisNames.indexOf(e);!this.commands[e]&&i>-1?this.setAxis(e,t):this.commands[e]&&!this.commands[e].disabled&&(this.commands[e].state.value=t)}},{key:"inPhysicalUse",get:function(){return this._inPhysicalUse},set:function(e){var t=this._inPhysicalUse;this._inPhysicalUse=e,!t&&e&&this.emit("activate")}}]),t}(EventDispatcher),OperatingSystem=function(){function e(t,i,r,n,o,a,s,l){classCallCheck(this,e),this.name=t;var c=o;o=o.length>0?o:"NORMAL",this[i+"_a"]="SELECT_ALL",this[i+"_c"]="COPY",this[i+"_x"]="CUT",this[i+"_v"]="PASTE",this[n]="REDO",this[i+"_z"]="UNDO",this[i+"_DOWNARROW"]="WINDOW_SCROLL_DOWN",this[i+"_UPARROW"]="WINDOW_SCROLL_UP",this[r+"_LEFTARROW"]="NORMAL_SKIPLEFT",this[r+"SHIFT_LEFTARROW"]="SHIFT_SKIPLEFT",this[r+"_RIGHTARROW"]="NORMAL_SKIPRIGHT",this[r+"SHIFT_RIGHTARROW"]="SHIFT_SKIPRIGHT",this[o+"_HOME"]="NORMAL_HOME",this[c+"SHIFT_HOME"]="SHIFT_HOME",this[o+"_END"]="NORMAL_END",this[c+"SHIFT_END"]="SHIFT_END",this[l+"_HOME"]="CTRL_HOME",this[l+"SHIFT_HOME"]="CTRLSHIFT_HOME",this[l+"_END"]="CTRL_END",this[l+"SHIFT_END"]="CTRLSHIFT_END"}return createClass(e,[{key:"makeCommandName",value:function(e,t){var i=e.keyCode;if(i!==Keys.CTRL&&i!==Keys.ALT&&i!==Keys.META_L&&i!==Keys.META_R&&i!==Keys.SHIFT){var r=t.deadKeyState;return e.ctrlKey&&(r+="CTRL"),e.altKey&&(r+="ALT"),e.metaKey&&(r+="META"),e.shiftKey&&(r+="SHIFT"),r===t.deadKeyState&&(r+="NORMAL"),r+="_"+t.keyNames[i],this[r]||r}}}]),e}(),Windows=new OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END"),macOS=new OperatingSystem("macOS","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW"),CodePage=function(){function e(t,i,r){function n(e,t,i){t.selectedText=e}classCallCheck(this,e),this.name=t,this.language=i;var o={NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}};for(var a in r)o[a]=Object.assign({},o[a],r[a]);for(var s,l,c,h=0;h<=9;++h)l=Keys["NUMPAD"+h],o.NORMAL[l]=h.toString();o.NORMAL[Keys.MULTIPLY]="*",o.NORMAL[Keys.ADD]="+",o.NORMAL[Keys.SUBTRACT]="-",o.NORMAL[Keys.DECIMALPOINT]=".",o.NORMAL[Keys.DIVIDE]="/",this.keyNames={},this.commandNames=[];for(s in Keys)l=Keys[s],isNaN(l)||(this.keyNames[l]=s);for(var u in o){var d=o[u];if("object"===("undefined"==typeof d?"undefined":_typeof(d)))for(l in d){if(l.indexOf("_")>-1){var p=l.split(" "),f=p[0];l=p[1],s=o.NORMAL[l],c=f+"_"+u+" "+s}else s=o.NORMAL[l],c=u+"_"+s;this.commandNames.push(c),this.keyNames[l]=s;var m=d[l];"function"!=typeof m&&(m=n.bind(null,m)),this[c]=m.bind(this)}}this.lastDeadKeyState=this.deadKeyState=""}return createClass(e,[{key:"resetDeadKeyState",value:function(){this.deadKeyState===this.lastDeadKeyState&&(this.deadKeyState="")}}]),e}();CodePage.DEAD=function(e){return function(t){this.lastDeadKeyState=this.deadKeyState,this.deadKeyState="DEAD"+e}};var DE_QWERTZ=new CodePage("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"ß",160:CodePage.DEAD(3),163:"#",171:"+",173:"-",186:"ü",187:"+",188:",",189:"-",190:".",191:"#",192:CodePage.DEAD(4),219:"ß",220:CodePage.DEAD(1),221:CodePage.DEAD(2),222:"ä",226:"<"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û",190:"."},DEAD2NORMAL:{65:"á",69:"é",73:"í",79:"ó",83:"s",85:"ú",89:"ý"},SHIFT:{32:" ",48:"=",49:"!",50:'"',51:"§",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"Ü",187:"*",188:";",189:"_",190:":",191:"'",192:"Ö",219:"?",222:"Ä",226:">"},CTRLALT:{48:"}",50:"²",51:"³",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"€",77:"µ",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"ẞ",219:"ẞ"},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}}),EN_UKX=new CodePage("English: UK Extended","en-GB",{CTRLALT:{52:"€",65:"á",69:"é",73:"í",79:"ó",85:"ú",163:"\\",192:"¦",222:"\\",223:"¦"},CTRLALTSHIFT:{65:"Á",69:"É",73:"Í",79:"Ó",85:"Ú",222:"|"},NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{32:" ",48:")",49:"!",50:'"',51:"£",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:"¬"}}),EN_US=new CodePage("English: USA","en-US",{NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{32:" ",48:")",49:"!",50:"@",51:"#",
52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}}),FR_AZERTY=new CodePage("Français: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{32:" ",48:"à",49:"&",50:"é",51:'"',52:"'",53:"(",54:"-",55:"è",56:"_",57:"ç",186:"$",187:"=",188:",",190:";",191:":",192:"ù",219:")",220:"*",221:CodePage.DEAD(1),222:"²",223:"!",226:"<"},SHIFT:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"£",187:"+",188:"?",190:".",191:"/",192:"%",219:"°",220:"µ",223:"§",226:">"},CTRLALT:{48:"@",50:CodePage.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:CodePage.DEAD(3),56:"\\",57:"^",69:"€",186:"¤",187:"}",219:"]"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û"},DEAD2NORMAL:{65:"ã",78:"ñ",79:"õ"},DEAD3NORMAL:{48:"à",50:"é",55:"è",65:"à",69:"è",73:"ì",79:"ò",85:"ù"}}),CodePages={CodePage:CodePage,DE_QWERTZ:DE_QWERTZ,EN_UKX:EN_UKX,EN_US:EN_US,FR_AZERTY:FR_AZERTY},Keyboard=function(e){function t(e,i){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Keyboard",i));return r._operatingSystem=null,r.browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",r._codePage=null,r.resetDeadKeyState=function(){return r.codePage.resetDeadKeyState()},r}return inherits(t,e),createClass(t,[{key:"consumeEvent",value:function(e){this.inPhysicalUse=!0;var t="keydown"===e.type;this.setButton(e.keyCode,t),t&&(e.cmdName=this.operatingSystem.makeCommandName(e,this.codePage),e.altCmdName=this.browser+"_"+e.cmdName,e.cmdText=this.codePage[e.cmdName],e.altCmdText=this.codePage[e.altCmdName],e.resetDeadKeyState=this.resetDeadKeyState)}},{key:"operatingSystem",get:function(){return this._operatingSystem},set:function(e){this._operatingSystem=e||(isMacOS?macOS:Windows)}},{key:"codePage",get:function(){return this._codePage},set:function(e){var t;if(this._codePage=e,!this._codePage){var i=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;i&&"en"!==i||(i="en-US");for(t in CodePages)if(e=CodePages[t],e.language===i){this._codePage=e;break}this._codePage||(this._codePage=CodePages.EN_US)}}}]),t}(InputProcessor),Mouse=function(e){function t(e,i){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Mouse",i,["BUTTONS","X","Y","Z","W"],"mousedown")),n=function(i,n){r.inPhysicalUse=!0;for(var o=n.buttons,a=0;a<t.NUM_BUTTONS;++a){var s=o&!0;(s&&i||!s&&!i)&&r.setButton(a,i),o>>=1}r.setAxis("BUTTONS",n.buttons<<10),n.target===e&&n.preventDefault()};return e.addEventListener("mousedown",n.bind(r,!0),!1),e.addEventListener("mouseup",n.bind(r,!1),!1),e.addEventListener("contextmenu",function(e){return!(e.ctrlKey&&e.shiftKey)&&e.preventDefault()},!1),e.addEventListener("mousemove",function(e){if(n(!0,e),PointerLock.isActive){var t=e.movementX,i=e.movementY;void 0===t&&(t=e.webkitMovementX||e.mozMovementX||0,i=e.webkitMovementY||e.mozMovementY||0),r.setAxis("X",r.getAxis("X")+t),r.setAxis("Y",r.getAxis("Y")+i)}else r.setAxis("X",e.layerX),r.setAxis("Y",e.layerY)},!1),e.addEventListener("wheel",function(t){isChrome?(r.W+=t.deltaX,r.Z+=t.deltaY):t.shiftKey?r.W+=t.deltaY:r.Z+=t.deltaY,t.target===e&&t.preventDefault()},!1),r}return inherits(t,e),t}(InputProcessor);Mouse.NUM_BUTTONS=3;var DEFAULT_POSE={position:[0,0,0],orientation:[0,0,0,1]},EMPTY_SCALE=new Vector3,IE_CORRECTION=new Quaternion(1,0,0,0),PoseInputProcessor=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,r));return n.currentDevice=null,n.lastPose=null,n.currentPose=null,n.posePosition=new Vector3,n.poseQuaternion=new Quaternion,n.position=new Vector3,n.quaternion=new Quaternion,n.matrix=new Matrix4,n}return inherits(t,e),createClass(t,[{key:"update",value:function(e){if(get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this,e),this.currentDevice){var i=this.currentPose||this.lastPose||DEFAULT_POSE;this.lastPose=i,this.inPhysicalUse=this.hasOrientation||this.inPhysicalUse;var r=this.currentPose&&this.currentPose.orientation,n=this.currentPose&&this.currentPose.position;r?(this.poseQuaternion.fromArray(r),isMobile&&isIE&&this.poseQuaternion.multiply(IE_CORRECTION)):this.poseQuaternion.set(0,0,0,1),n?this.posePosition.fromArray(n):this.posePosition.set(0,0,0)}}},{key:"updateStage",value:function(e){this.matrix.makeRotationFromQuaternion(this.poseQuaternion),this.matrix.setPosition(this.posePosition),this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,EMPTY_SCALE)}},{key:"hasPose",get:function(){return!!this.currentPose}}]),t}(InputProcessor),Gamepad=function(e){function t(e,i,r,n){classCallCheck(this,t);var o=t.ID(i),a=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o,n,["LSX","LSY","RSX","RSY","IDK1","IDK2","Z","BUTTONS"]));return e.registerPad(o,a),a.currentDevice=i,a.axisOffset=r,a}return inherits(t,e),createClass(t,null,[{key:"ID",value:function(e){var t=e.id;return t="OpenVR Gamepad"===t?"Vive":0===t.indexOf("Rift")?"Rift":0===t.indexOf("Unknown")?"Unknown":"Gamepad",t=(t+"_"+(e.index||0)).replace(/\s+/g,"_")}},{key:"isMotionController",value:function(e){if(e){var t=e.capabilities||e.pose;return t&&t.hasOrientation}return!1}}]),createClass(t,[{key:"getPose",value:function(){return this.currentPose}},{key:"checkDevice",value:function(e){this.inPhysicalUse=!0;var t,i,r=0;for(this.currentDevice=e,this.currentPose=this.hasOrientation&&this.currentDevice.pose,t=0,i=e.buttons.length;t<e.buttons.length;++t,++i){var n=e.buttons[t];this.setButton(t,n.pressed),n.pressed&&(r|=1<<t),this.setButton(i,n.touched),n.touched&&(r|=1<<i)}for(this.setAxis("BUTTONS",r),t=0;t<e.axes.length;++t){var o=this.axisNames[this.axisOffset*e.axes.length+t],a=e.axes[t];this.setAxis(o,a)}}},{key:"vibratePattern",value:function(e){this.currentDevice&&(this.currentDevice.vibrate?this.currentDevice.vibrate(e):this.currentDevice.haptics&&this.currentDevice.haptics.length>0&&playPattern(this.currentDevice.haptics,e))}},{key:"hasOrientation",get:function(){return t.isMotionController(this.currentDevice)}},{key:"haptics",get:function(){return this.currentDevice&&this.currentDevice.haptics}}]),t}(PoseInputProcessor);Gamepad.XBOX_360_BUTTONS={A:1,B:2,X:3,Y:4,LEFT_BUMPER:5,RIGHT_BUMPER:6,LEFT_TRIGGER:7,RIGHT_TRIGGER:8,BACK:9,START:10,LEFT_STICK:11,RIGHT_STICK:12,UP_DPAD:13,DOWN_DPAD:14,LEFT_DPAD:15,RIGHT_DPAD:16},Gamepad.XBOX_ONE_BUTTONS={A:1,B:2,X:3,Y:4,LEFT_BUMPER:5,RIGHT_BUMPER:6,LEFT_TRIGGER:7,RIGHT_TRIGGER:8,BACK:9,START:10,LEFT_STICK:11,RIGHT_STICK:12,UP_DPAD:13,DOWN_DPAD:14,LEFT_DPAD:15,RIGHT_DPAD:16},Gamepad.VIVE_BUTTONS={TOUCHPAD_PRESSED:0,TRIGGER_PRESSED:1,GRIP_PRESSED:2,MENU_PRESSED:3,TOUCHPAD_TOUCHED:4,GRIP_TOUCHED:6,MENU_TOUCHED:7};var blackList=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2910.0 Safari/537.36"];navigator.getGamepads=navigator.getGamepads||navigator.webkitGetGamepads;var GamepadManager=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.currentDevices=[],e.currentDeviceIDs=[],e.currentManagers={},e}return inherits(t,e),createClass(t,null,[{key:"isAvailable",get:function(){return blackList.indexOf(navigator.userAgent)===-1&&!!navigator.getGamepads}}]),createClass(t,[{key:"poll",value:function(){if(t.isAvailable){var e,i,r=navigator.getGamepads(),n=[],o=[],a=[],s=[];if(r)for(e=0;e<r.length;++e){var l=r[e];if(l){i=Gamepad.ID(l);var c=this.currentDeviceIDs.indexOf(i);n.push(l),o.push(i),c===-1?(a.push(l),this.currentDeviceIDs.push(i),this.currentDevices.push(l),delete this.currentManagers[i]):this.currentDevices[c]=l}}for(e=this.currentDeviceIDs.length-1;e>=0;--e){i=this.currentDeviceIDs[e];var h=this.currentManagers[i],u=this.currentDevices[e];o.indexOf(i)===-1?(s.push(i),this.currentDevices.splice(e,1),this.currentDeviceIDs.splice(e,1)):h&&h.checkDevice(u)}a.forEach(this.emit.bind(this,"gamepadconnected")),s.forEach(this.emit.bind(this,"gamepaddisconnected"))}}},{key:"registerPad",value:function(e,t){this.currentManagers[e]=t}},{key:"pads",get:function(){return this.currentDevices}}]),t}(EventDispatcher),Touch=function(e){function t(e,i){classCallCheck(this,t);for(var r=["FINGERS"],n=0;n<10;++n)r.push("X"+n),r.push("Y"+n),r.push("LX"+n),r.push("LY"+n),r.push("DX"+n),r.push("DY"+n);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Touch",i,r,"touchend")),a=function(t,i,r){o.inPhysicalUse=!0;for(var n=r.changedTouches,a=Number.MAX_VALUE,s=0;s<n.length;++s)a=Math.min(a,n[s].identifier);for(var l=0;l<n.length;++l){var c=n[l],h=c.identifier-a,u=c.pageX,d=c.pageY;if(o.setAxis("X"+h,u),o.setAxis("Y"+h,d),o.setButton("FINGER"+h,t),i){var p=o.getAxis("LX"+h),f=o.getAxis("LY"+h);o.setAxis("DX"+h,u-p),o.setAxis("DY"+h,d-f)}o.setAxis("LX"+h,u),o.setAxis("LY"+h,d)}n=r.touches;for(var m=0,v=0;v<n.length;++v){var g=n[v];m|=1<<g.identifier}o.setAxis("FINGERS",m),r.target===e&&r.preventDefault()};return e.addEventListener("touchstart",a.bind(o,!0,!1),!1),e.addEventListener("touchend",a.bind(o,!1,!0),!1),e.addEventListener("touchmove",a.bind(o,!0,!0),!1),o}return inherits(t,e),createClass(t,[{key:"update",value:function(e){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this,e);for(var i=0;i<10;++i){var r=this.getAxis("X"+i),n=this.getAxis("Y"+i),o=this.getAxis("LX"+i),a=this.getAxis("LY"+i);this.setAxis("DX"+i,r-o),this.setAxis("DY"+i,n-a),this.setAxis("LX"+i,r),this.setAxis("LY"+i,n)}}}]),t}(InputProcessor),Speech$1=function(e){function t(e){function i(){var e="Failed to initialize speech engine. Reason: "+l.message;return console.error(e),!1}function r(){return available?!a&&(a=!0,s.start(),!0):i()}function n(){return available?!!a&&(s.stop(),!0):i()}classCallCheck(this,t);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Speech",e)),a=!1,s=null,l=null;o.check=function(){this.enabled&&!a?r():!this.enabled&&a&&n()},o.getErrorMessage=function(){return l};try{s=window.SpeechRecognition?new SpeechRecognition:new webkitSpeechRecognition,s.continuous=!0,s.interimResults=!0,s.lang="en-US";var c=!1;s.addEventListener("start",function(){console.log("speech started"),command=""}.bind(o),!0),s.addEventListener("error",function(e){c=!0,console.log("speech error",e),a=!1,command="speech error"}.bind(o),!0),s.addEventListener("end",function(e){console.log("speech ended",e),a=!1,command="speech ended",c&&(c=!1,this.enable(!0))}.bind(o),!0),s.addEventListener("result",function(e){var t=[],i=e.results[e.resultIndex],r=0,n=-1;if(i&&i.isFinal)for(var o=0;o<i.length;++o){var a=i[o];a.confidence>r&&(r=a.confidence,n=o)}r>.85&&t.push(i[n].transcript.trim()),t=t.join(" "),t!==this.inputState&&(this.inputState.text=t),this.update()}.bind(o),!0),available=!0}catch(e){console.error(e),l=e,available=!1}return o}return inherits(t,e),createClass(t,[{key:"cloneCommand",value:function(e){return{name:e.name,preamble:e.preamble,keywords:t.maybeClone(e.keywords),commandUp:e.commandUp,disabled:e.disabled}}},{key:"evalCommand",value:function(e,t,i,r){if(i&&this.inputState.text)for(var n=0;n<e.keywords.length;++n)0!==this.inputState.text.indexOf(e.keywords[n])||!e.preamble&&e.keywords[n].length!==this.inputState.text.length||(t.pressed=!0,t.value=this.inputState.text.substring(e.keywords[n].length).trim(),this.inputState.text=null)}},{key:"enable",value:function(e,i){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"enable",this).call(this,e,i),this.check()}}],[{key:"maybeClone",value:function(e){return e&&e.slice()||[]}}]),t}(InputProcessor),SensorSample=function(){function e(t,i){classCallCheck(this,e),this.set(t,i)}return createClass(e,[{key:"set",value:function(e,t){this.sample=e,this.timestampS=t}},{key:"copy",value:function(e){this.set(e.sample,e.timestampS)}}]),e}(),ComplementaryFilter=function(){function e(t){classCallCheck(this,e),this.kFilter=t,this.currentAccelMeasurement=new SensorSample,this.currentGyroMeasurement=new SensorSample,this.previousGyroMeasurement=new SensorSample,isiOS?this.filterQ=new Quaternion(-1,0,0,1):this.filterQ=new Quaternion(1,0,0,1),this.previousFilterQ=new Quaternion,this.previousFilterQ.copy(this.filterQ),this.accelQ=new Quaternion,this.isOrientationInitialized=!1,this.estimatedGravity=new Vector3,this.measuredGravity=new Vector3,this.gyroIntegralQ=new Quaternion}return createClass(e,[{key:"addAccelMeasurement",value:function(e,t){this.currentAccelMeasurement.set(e,t)}},{key:"addGyroMeasurement",value:function(e,t){this.currentGyroMeasurement.set(e,t);var i=t-this.previousGyroMeasurement.timestampS;isTimestampDeltaValid(i)&&this.run_(),this.previousGyroMeasurement.copy(this.currentGyroMeasurement)}},{key:"run_",value:function(){if(!this.isOrientationInitialized)return this.accelQ=this.accelToQuaternion_(this.currentAccelMeasurement.sample),this.previousFilterQ.copy(this.accelQ),void(this.isOrientationInitialized=!0);var e=this.currentGyroMeasurement.timestampS-this.previousGyroMeasurement.timestampS,t=this.gyroToQuaternionDelta_(this.currentGyroMeasurement.sample,e);this.gyroIntegralQ.multiply(t),this.filterQ.copy(this.previousFilterQ),this.filterQ.multiply(t);var i=new Quaternion;i.copy(this.filterQ),i.inverse(),this.estimatedGravity.set(0,0,-1),this.estimatedGravity.applyQuaternion(i),this.estimatedGravity.normalize(),this.measuredGravity.copy(this.currentAccelMeasurement.sample),this.measuredGravity.normalize();var r=new Quaternion;r.setFromUnitVectors(this.estimatedGravity,this.measuredGravity),r.inverse();var n=new Quaternion;n.copy(this.filterQ),n.multiply(r),this.filterQ.slerp(n,1-this.kFilter),this.previousFilterQ.copy(this.filterQ)}},{key:"getOrientation",value:function(){return this.filterQ}},{key:"accelToQuaternion_",value:function(e){var t=new Vector3;t.copy(e),t.normalize();var i=new Quaternion;return i.setFromUnitVectors(new Vector3(0,0,-1),t),i.inverse(),i}},{key:"gyroToQuaternionDelta_",value:function(e,t){var i=new Quaternion,r=new Vector3;return r.copy(e),r.normalize(),i.setFromAxisAngle(r,e.length()*t),i}}]),e}(),DEG2RAD$3=_Math.DEG2RAD,AXIS=new Vector3,PosePredictor=function(){function e(t){classCallCheck(this,e),this.predictionTimeS=t,this.previousQ=new Quaternion,this.previousTimestampS=null,this.deltaQ=new Quaternion}return createClass(e,[{key:"getPrediction",value:function(e,t,i,r){if(!this.previousTimestampS)return this.previousQ.copy(e),this.previousTimestampS=i,e;AXIS.copy(t),AXIS.normalize();var n=t.length();if(n<20*DEG2RAD$3)return r.copy(e),void this.previousQ.copy(e);var o=(i-this.previousTimestampS,n*this.predictionTimeS);this.deltaQ.setFromAxisAngle(AXIS,o),r.copy(this.previousQ),r.multiply(this.deltaQ),this.previousQ.copy(e),this.previousTimestampS=i}}]),e}(),isFirefoxAndroid=isFirefox&&isMobile,DEG2RAD$2=_Math.DEG2RAD,FusionPoseSensor=function(){function e(t){classCallCheck(this,e),t=Object.assign({K_FILTER:.98,PREDICTION_TIME_S:.04},t),this.deviceId="webvr-polyfill:fused",this.deviceName="VR Position Device (webvr-polyfill:fused)",this.accelerometer=new Vector3,this.gyroscope=new Vector3,window.addEventListener("devicemotion",this.onDeviceMotionChange_.bind(this)),window.addEventListener("orientationchange",this.onScreenOrientationChange_.bind(this)),this.filter=new ComplementaryFilter(t.K_FILTER),this.posePredictor=new PosePredictor(t.PREDICTION_TIME_S),this.filterToWorldQ=new Quaternion,isiOS?this.filterToWorldQ.setFromAxisAngle(new Vector3(1,0,0),Math.PI/2):this.filterToWorldQ.setFromAxisAngle(new Vector3(1,0,0),-Math.PI/2),this.inverseWorldToScreenQ=new Quaternion,this.worldToScreenQ=new Quaternion,this.originalPoseAdjustQ=new Quaternion,this.originalPoseAdjustQ.setFromAxisAngle(new Vector3(0,0,1),-window.orientation*DEG2RAD$2),this.setScreenTransform_(),isLandscape()&&this.filterToWorldQ.multiply(this.inverseWorldToScreenQ),this.resetQ=new Quaternion,this.orientationOut_=new Float32Array(4),this.predictedQ=new Quaternion,this.previousTimestampS=null}return createClass(e,[{key:"getPosition",value:function(){return null}},{key:"getOrientation",value:function(){var e=this.filter.getOrientation();this.posePredictor.getPrediction(e,this.gyroscope,this.previousTimestampS,this.predictedQ);var t=new Quaternion;return t.copy(this.filterToWorldQ),t.multiply(this.resetQ),t.multiply(this.predictedQ),t.multiply(this.worldToScreenQ),this.orientationOut_[0]=t.x,this.orientationOut_[1]=t.y,this.orientationOut_[2]=t.z,this.orientationOut_[3]=t.w,this.orientationOut_}},{key:"getPose",value:function(){return{position:this.getPosition(),orientation:this.getOrientation(),linearVelocity:null,linearAcceleration:null,angularVelocity:null,angularAcceleration:null}}},{key:"onDeviceMotionChange_",value:function(e){var t=e.accelerationIncludingGravity,i=e.rotationRate,r=e.timeStamp/1e3;isFirefoxAndroid&&(r/=1e3);var n=r-this.previousTimestampS;isTimestampDeltaValid(n)?(this.accelerometer.set(-t.x,-t.y,-t.z),this.gyroscope.set(i.alpha,i.beta,i.gamma),(isiOS||isFirefoxAndroid)&&this.gyroscope.multiplyScalar(DEG2RAD$2),this.filter.addAccelMeasurement(this.accelerometer,r),this.filter.addGyroMeasurement(this.gyroscope,r)):null!==this.previousTimestampS&&console.warn("Invalid timestamps detected. Time step between successive gyroscope sensor samples is very small or not monotonic"),this.previousTimestampS=r}},{key:"onScreenOrientationChange_",value:function(e){this.setScreenTransform_()}},{key:"setScreenTransform_",value:function(){switch(this.worldToScreenQ.set(0,0,0,1),window.orientation){case 0:break;case 90:this.worldToScreenQ.setFromAxisAngle(new Vector3(0,0,1),-Math.PI/2);break;case-90:this.worldToScreenQ.setFromAxisAngle(new Vector3(0,0,1),Math.PI/2);break;case 180:}this.inverseWorldToScreenQ.copy(this.worldToScreenQ),this.inverseWorldToScreenQ.inverse()}}]),e}(),Eye={LEFT:"left",RIGHT:"right"},ipd=.03,neckLength=0,neckDepth=0,CardboardVRDisplay=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Google Cardboard"));return i.DOMElement=null,i.poseSensor_=e&&e.overrideOrientation||new FusionPoseSensor(e),i}return inherits(t,e),createClass(t,null,[{key:"IPD",get:function(){return ipd},set:function(e){ipd=e}},{key:"NECK_LENGTH",get:function(){return neckLength},set:function(e){neckLength=e}},{key:"NECK_DEPTH",get:function(){return neckDepth},set:function(e){neckDepth=e}}]),createClass(t,[{key:"_getPose",value:function(){return this.poseSensor_.getPose()}},{key:"getEyeParameters",value:function(e){var t=[ipd,neckLength,neckDepth];e==Eye.LEFT&&(t[0]*=-1);var i=calculateElementSize(this);return{fieldOfView:{upDegrees:40,leftDegrees:40,rightDegrees:40,downDegrees:40},offset:t,renderWidth:.5*i.width,renderHeight:i.height}}}]),t}(VRDisplay),Automator=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window;classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.root=e,i.frames=[],i.startT=null,i}return inherits(t,e),createClass(t,[{key:"update",value:function(e){null===this.startT&&(this.startT=e)}},{key:"reset",value:function(){this.frames.splice(0),this.startT=null}},{key:"length",get:function(){return this.frames.length}}]),t}(EventDispatcher),Obj=function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window;classCallCheck(this,e),this.path=t;var r=t.split("."),n=r[r.length-1],o=function(e){for(var t=i,n=0;n<r.length-1;++n){var o=r[n];if(void 0===t[o]||null===t[o]){if(!e){t=null;break}/^\d+$/.test(r[n+1])?t[o]=[]:t[o]={}}t=t[o]}return t};this.get=function(){var e=o(!1);return e&&e[n]},this.set=function(e){var t=o(!0);t&&(t[n]=e)}},Record=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n.value=i,n}return inherits(t,e),createClass(t,[{key:"write",value:function(){this.value!==this.get()&&this.set(this.value)}}]),t}(Obj),Frame=function(){function e(t,i){classCallCheck(this,e),this.t=t,this.records=i}return createClass(e,null,[{key:"parse",value:function(t,i,r){for(var n=[{path:"",value:i}],o=[];n.length>0;){var a=n.shift(),s=a.path,l=a.value;if("object"===("undefined"==typeof l?"undefined":_typeof(l)))for(var c in l){var h=s;s.length>0&&(h+="."),h+=c,n.push({path:h,value:l[c]})}else o.push(new Record(s,l,r))}return new e(t,o)}}]),createClass(e,[{key:"write",value:function(){for(var e=0;e<this.records.length;++e)this.records[e].write()}}]),e}(),Player=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.frameIndex=-1,i}return inherits(t,e),createClass(t,[{key:"parse",value:function(e){this.load(JSON.parse(e))}},{key:"load",value:function(e){var t=[];for(var i in e)t.push(Frame.parse(i,e[i],this.root));this.append(t)}},{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.frameIndex=-1}},{key:"update",value:function(e){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this,e),e+=this.minT-this.startT;for(var i=this.frameIndex;this.frameIndex<this.frames.length-1&&e>=this.frames[this.frameIndex+1].t;)++this.frameIndex;if(this.frameIndex!==i&&0<=this.frameIndex&&this.frameIndex<this.frames.length){var r=this.frames[this.frameIndex];r.write(),this.emit("frame",r)}}},{key:"append",value:function(e){e&&(this.frames.push.apply(this.frames,e),this.minT=this.frames.map(function(e){return e.t}).reduce(function(e,t){return Math.min(e,t)},Number.MAX_VALUE))}},{key:"reverse",value:function(){var e=this.frames.map(function(e){return e.t}).reduce(function(e,t){return Math.max(e,t)},Number.MIN_VALUE);this.frames.reverse();for(var t=0;t<this.frames.length;++t){var i=this.frames[t];i.t=e-i.t+this.minT}}},{key:"done",get:function(){return this.frameIndex>=this.frames.length-1}}]),t}(Automator),MockVRDisplay=function(){function e(t){classCallCheck(this,e);var i=null,r=null,n=null;Object.defineProperties(this,{displayName:{get:function(){return"Mock "+r},set:function(e){return r=e}}});var o={currentDisplay:this,currentEyeParams:{left:{fieldOfView:{downDegrees:null,leftDegrees:null,rightDegrees:null,upDegrees:null},renderWidth:null,renderHeight:null,offset:null},right:{fieldOfView:{downDegrees:null,leftDegrees:null,rightDegrees:null,upDegrees:null},renderWidth:null,renderHeight:null,offset:null}},currentPose:{timestamp:null,orientation:null,position:null}};Object.defineProperties(o.currentPose,{timestamp:{get:function(){return i},set:function(e){return i=e}},timeStamp:{get:function(){return i},set:function(e){return i=e}}});var a=new Player(o);a.load(t),a.update(0),this.requestAnimationFrame=function(e){return window.requestAnimationFrame(function(t){null===n&&(n=t),a.update(t-n),e(t)})},this.getPose=function(){return o.currentPose},this.getEyeParameters=function(e){return o.currentEyeParams[e]}}return createClass(e,[{key:"cancelAnimationFrame",value:function(e){window.cancelAnimationFrame(e)}}]),e}(),HTTP={del:del,delObject:delObject,get:get$1,getBuffer:getBuffer,getObject:getObject,getText:getText,post:post,postObject:postObject,XHR:XHR},hasNativeWebVR="getVRDisplays"in navigator,allDisplays=[],isCardboardCompatible=isMobile&&!isGearVR,polyFillDevicesPopulated=!1,standardMonitorPopulated=!1,ViewCameraTransform=function(){function e(t){classCallCheck(this,e),this.display=t}return createClass(e,null,[{key:"makeTransform",value:function(t,i,r){return{translation:(new Vector3).fromArray(t.offset),projection:e.fieldOfViewToProjectionMatrix(t.fieldOfView,i,r),viewport:{left:0,top:0,width:t.renderWidth,height:t.renderHeight}}}},{key:"fieldOfViewToProjectionMatrix",value:function(e,t,i){var r=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),s=2/(o+a),l=2/(r+n),c=new Matrix4;return c.elements[0]=s,c.elements[1]=0,c.elements[2]=0,c.elements[3]=0,c.elements[4]=0,c.elements[5]=l,c.elements[6]=0,c.elements[7]=0,c.elements[8]=-((o-a)*s*.5),c.elements[9]=(r-n)*l*.5,c.elements[10]=-(t+i)/(i-t),c.elements[11]=-1,c.elements[12]=0,c.elements[13]=0,c.elements[14]=-(2*i*t)/(i-t),c.elements[15]=0,c}}]),createClass(e,[{key:"getTransforms",value:function(t,i){var r=this.display.getEyeParameters("left"),n=this.display.getEyeParameters("right"),o=[e.makeTransform(r,t,i)];n&&o.push(e.makeTransform(n,t,i));for(var a=1;a<o.length;++a)o[a].viewport.left=o[a-1].viewport.left+o[a-1].viewport.width;return o}}]),e}(),VR=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"VR"));return i.options=e,i.displays=[],i._transformers=[],i.currentDeviceIndex=-1,i.movePlayer=new Matrix4,i.stage=null,i.lastStageWidth=null,i.lastStageDepth=null,i.isStereo=!1,install(e),null!==i.options.nonstandardIPD&&(CardboardVRDisplay.IPD=i.options.nonstandardIPD),null!==i.options.nonstandardNeckLength&&(CardboardVRDisplay.NECK_LENGTH=i.options.nonstandardNeckLength),null!==i.options.nonstandardNeckDepth&&(CardboardVRDisplay.NECK_DEPTH=i.options.nonstandardNeckDepth),i.ready=navigator.getVRDisplays().then(function(e){return i.displays.push.apply(i.displays,e),i.connect(0),i.displays}),i}return inherits(t,e),createClass(t,null,[{key:"isStereoDisplay",value:function(e){var t=e.getEyeParameters("left"),i=e.getEyeParameters("right");return!(!t||!i)}}]),createClass(t,[{key:"connect",value:function(e){this.currentDevice=null,this.currentDeviceIndex=e,this.currentPose=null,0<=e&&e<=this.displays.length&&(this.currentDevice=this.displays[e],this.currentPose=this.currentDevice.getPose(),this.isStereo=t.isStereoDisplay(this.currentDevice))}},{key:"requestPresent",value:function(e){if(this.currentDevice){var t=e;e[0].source;t instanceof Array||(t=[t]),this.isNativeMobileWebVR&&this.isStereo&&!isGearVR&&(t=t[0]);var i=this.currentDevice.requestPresent(t);return!isMobile&&isFirefox||(i=i.then(standardLockBehavior)),i}return Promise.reject("No display")}},{key:"cancel",value:function(){var e=this,t=null;return this.isPresenting?(t=this.currentDevice.exitPresent(),this.currentDevice=null,this.currentDeviceIndex=-1,this.currentPose=null):t=Promise.resolve(),this.isNativeMobileWebVR&&(t=t.then(Orientation.unlock)),t.then(PointerLock.exit).catch(function(e){return console.warn(e)}).then(function(){return e.connect(0)})}},{key:"update",value:function(e){var i,r,n;this.currentDevice?(this.currentPose=this.currentDevice.getPose(),n=this.currentDevice.stageParameters):n=null,get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this,e),n?(this.movePlayer.fromArray(n.sittingToStandingTransform),i=n.sizeX,r=n.sizeZ):(this.movePlayer.makeTranslation(0,this.options.avatarHeight,0),i=0,r=0);var o={matrix:this.movePlayer,sizeX:i,sizeZ:r};this.stage&&o.sizeX===this.stage.sizeX&&o.sizeZ===this.stage.sizeZ||(this.stage=o)}},{key:"submitFrame",value:function(){this.currentDevice&&this.currentDevice.submitFrame(this.currentPose)}},{key:"getTransforms",value:function(e,t){if(this.currentDevice)return this._transformers[this.currentDeviceIndex]||(this._transformers[this.currentDeviceIndex]=new ViewCameraTransform(this.currentDevice)),this.currentDevice.depthNear=e,this.currentDevice.depthFar=t,this._transformers[this.currentDeviceIndex].getTransforms(e,t)}},{key:"isNativeMobileWebVR",get:function(){return this.isNativeWebVR&&isChrome&&isMobile}},{key:"isNativeWebVR",get:function(){return this.currentDevice&&!this.currentDevice.isPolyfilled}},{key:"hasStage",get:function(){return this.stage&&this.stage.sizeX*this.stage.sizeZ>0}},{key:"canMirror",get:function(){return this.currentDevice&&this.currentDevice.capabilities.hasExternalDisplay}},{key:"isPolyfilled",get:function(){return this.currentDevice&&this.currentDevice.isPolyfilled}},{key:"isPresenting",get:function(){return this.currentDevice&&this.currentDevice.isPresenting}},{key:"hasOrientation",get:function(){return this.currentDevice&&this.currentDevice.capabilities.hasOrientation}},{key:"currentCanvas",get:function(){if(this.isPresenting){var e=this.currentDevice.getLayers();if(e.length>0)return e[0].source}return null}}]),t}(PoseInputProcessor),RemoteUser=function(e){function t(e,i,r,n,o,a,s,l){classCallCheck(this,t);var c=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));c.time=0,c.userName=e,c.peeringError=null,c.peering=!1,c.peered=!1,c.stage=i.clone(),c.stage.traverse(function(e){"AvatarBelt"===e.name?colored(e,color()):"AvatarHead"===e.name&&(c.head=e)}),c.nameObject=colored(text3D(.1,e),r);var h=c.nameObject.geometry.boundingBox.max;return c.nameObject.rotation.set(0,Math.PI,0),c.nameObject.position.set(h.x/2,h.y,0),c.head.add(c.nameObject),c.dStageQuaternion=new Quaternion,c.dHeadPosition=new Vector3,c.dHeadQuaternion=new Quaternion,c.lastStageQuaternion=new Quaternion,c.lastHeadPosition=new Vector3,c.lastHeadQuaternion=new Quaternion,c.headPosition={arr1:[],arr2:[],last:c.lastHeadPosition,delta:c.dHeadPosition,curr:c.head.position},c.headQuaternion={arr1:[],arr2:[],last:c.lastHeadQuaternion,delta:c.dHeadQuaternion,curr:c.head.quaternion},c.audioChannel=null,c.audioElement=null,c.audioStream=null,c.gain=null,c.panner=null,c.analyzer=null,c}return inherits(t,e),createClass(t,[{key:"setAudio",value:function(e,t){t instanceof Element?(this.audioElement=t,Audio3D.setAudioProperties(this.audioElement),this.audioStream=e.context.createMediaElementSource(this.audioElement)):(this.audioElement=Audio3D.setAudioStream(t,"audio"+this.userName),this.audioStream=e.context.createMediaStreamSource(t)),this.gain=e.context.createGain(),this.panner=e.context.createPanner(),this.audioStream.connect(this.gain),this.gain.connect(this.panner),this.panner.connect(e.mainVolume),this.panner.coneInnerAngle=180,this.panner.coneOuterAngle=360,this.panner.coneOuterGain=.1,this.panner.panningModel="HRTF",this.panner.distanceModel="exponential"}},{key:"unpeer",value:function(){this.audioChannel&&(this.audioChannel.close(),this.audioElement&&(document.body.removeChild(this.audioElement),this.panner&&(this.panner.disconnect(),this.gain.disconnect(),this.audioStream.disconnect())))}},{key:"_updateV",value:function(e,i,r){e.curr.toArray(e.arr1),e.delta.toArray(e.arr2);for(var n=0;n<e.arr1.length;++n)r&&(e.arr2[n]*=t.FADE_FACTOR),e.arr1[n]+=e.arr2[n]*i;e.curr.fromArray(e.arr1),e.delta.fromArray(e.arr2)}},{key:"_predict",value:function(e,i,r){e.delta.fromArray(i,r),e.delta.toArray(e.arr1),e.curr.toArray(e.arr2);for(var n=0;n<e.arr1.length;++n)e.arr1[n]=(e.arr1[n]-e.arr2[n])*t.NETWORK_DT_INV;e.delta.fromArray(e.arr1)}},{key:"update",value:function(e){this.time+=e;var i=this.time>=t.NETWORK_DT;this._updateV(this.headPosition,e,i),this._updateV(this.headQuaternion,e,i),this.stage.rotation.setFromQuaternion(this.headQuaternion.curr),this.stage.rotation.x=0,this.stage.rotation.z=0,this.stage.position.copy(this.headPosition.curr),this.stage.position.y=0,this.panner&&(this.panner.setPosition(this.stage.position.x,this.stage.position.y,this.stage.position.z),this.panner.setOrientation(Math.sin(this.stage.rotation.y),0,Math.cos(this.stage.rotation.y)))}},{key:"setState",value:function(e){this.time=0,this._predict(this.headPosition,e,1),this._predict(this.headQuaternion,e,4)}},{key:"toString",value:function(e){return this.stage.position.curr.toString(e)+" "+this.headPosition.curr.toString(e)}}]),t}(EventDispatcher);RemoteUser.FADE_FACTOR=.5,RemoteUser.NETWORK_DT=.1,RemoteUser.NETWORK_DT_INV=1/RemoteUser.NETWORK_DT;var Manager=function(e){function t(e,i,r,n){classCallCheck(this,t);
var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.localUser=e,o.audio=i,o.factories=r,o.options=n,o.lastNetworkUpdate=0,o.oldState=[],o.users={},o.waitForLastUser=Promise.resolve(),o._socket=null,o.userName=null,o.microphone=null,o.audioHeap={},o}return inherits(t,e),createClass(t,[{key:"update",value:function(e){if(this._socket&&0===this.deviceIndex&&(this.lastNetworkUpdate+=e,this.lastNetworkUpdate>=RemoteUser.NETWORK_DT)){this.lastNetworkUpdate-=RemoteUser.NETWORK_DT;for(var t=0;t<this.localUser.newState.length;++t)if(this.oldState[t]!==this.localUser.newState[t]){this._socket.emit("userState",this.localUser.newState),this.oldState=this.localUser.newState;break}}for(var i in this.users){var r=this.users[i];r.update(e),this.audioHeap[i]&&(r.setAudio(this.audio,this.audioHeap[i]),delete this.audioHeap[i])}}},{key:"updateUser",value:function(e){var t=e[0];if(t!==this.userName){var i=this.users[t];i&&i.setState(e)}else this.deviceIndex>0&&(this.localUser.stage.position.fromArray(e,1),this.localUser.stage.quaternion.fromArray(e,4),this.localUser.head.position.fromArray(e,8),this.localUser.head.quaternion.fromArray(e,11))}},{key:"connect",value:function(e,t){this.userName=t.toLocaleUpperCase(),this.microphone||(this.microphone=navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).catch(console.warn.bind(console,"Can't get audio"))),this._socket||(this._socket=e,this._socket.on("userList",this.listUsers.bind(this)),this._socket.on("userJoin",this.addUser.bind(this)),this._socket.on("deviceAdded",this.addDevice.bind(this)),this._socket.on("deviceIndex",this.setDeviceIndex.bind(this)),this._socket.on("chat",this.receiveChat.bind(this)),this._socket.on("userState",this.updateUser.bind(this)),this._socket.on("userLeft",this.removeUser.bind(this)),this._socket.on("connection_lost",this.lostConnection.bind(this)),this._socket.emit("listUsers"),this._socket.emit("getDeviceIndex"))}},{key:"disconnect",value:function(){this.userName=null,this._socket.close(),this._socket=null}},{key:"addUser",value:function(e,t){console.log("User %s logging on.",e[0]);var i=e[0],r=new RemoteUser(i,this.factories.avatar,this.options.foregroundColor,this.options.disableWebRTC,this.options.webRTC,this.microphone,this.userName,t);this.users[i]=r,this.updateUser(e),this.emit("addavatar",r)}},{key:"removeUser",value:function(e){console.log("User %s logging off.",e);var t=this.users[e];t&&(t.peered&&t.unpeer(),delete this.users[e],this.emit("removeavatar",t))}},{key:"listUsers",value:function(e){for(Object.keys(this.users).forEach(this.removeUser.bind(this));e.length>0;)this.addUser(e.shift(),!0);this.emit("authorizationsucceeded")}},{key:"receiveChat",value:function(e){console.log("chat",e)}},{key:"lostConnection",value:function(){this.deviceIndex=null}},{key:"addDevice",value:function(e){console.log("addDevice",e)}},{key:"setDeviceIndex",value:function(e){this.deviceIndex=e}},{key:"setAudioFromUser",value:function(e,t){this.audioHeap[e]=t}}]),t}(EventDispatcher),PlainText=new Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]]),DIFF=new Vector3,MAX_MOVE_DISTANCE=5,MAX_MOVE_DISTANCE_SQ=MAX_MOVE_DISTANCE*MAX_MOVE_DISTANCE,MAX_TELEPORT_WAGGLE=.5,TELEPORT_PAD_RADIUS=.4,Teleporter=function(){function e(t){var i=this;classCallCheck(this,e),this.enabled=!0,this._environment=t,this._startPoint=new Vector3,this._moveDistance=0,this._start=this._start.bind(this),this._exit=this._exit.bind(this),this._move=this._move.bind(this),this._end=this._end.bind(this),t.ground.on("exit",this._exit).on("gazecancel",this._exit).on("gazecomplete",this._exit).on("pointerend",this._exit).on("pointerstart",this._start).on("gazestart",this._start).on("pointermove",this._move).on("gazemove",this._move).on("select",this._end),this.disk=sphere(TELEPORT_PAD_RADIUS,128,3).colored(16711680,{unshaded:!0}).named("disk").addTo(t.scene),this.disk.geometry.computeBoundingBox(),this.disk.geometry.vertices.forEach(function(e){e.y=.1*(e.y-i.disk.geometry.boundingBox.min.y)}),this.disk.geometry.computeBoundingBox(),this.disk.visible=!1}return createClass(e,[{key:"_exit",value:function(e){this.disk.visible=!1}},{key:"_start",value:function(e){this.enabled&&(this._updatePosition(e),this.disk.visible=!0,this._moveDistance=0)}},{key:"_move",value:function(e){this.enabled&&(this._updatePosition(e),this.disk.visible=this._moveDistance<MAX_TELEPORT_WAGGLE)}},{key:"_end",value:function(e){this.enabled&&(this._updatePosition(e),this._moveDistance<MAX_TELEPORT_WAGGLE&&this._environment.teleport(this.disk.position))}},{key:"_updatePosition",value:function(e){this._startPoint.copy(this.disk.position),this.disk.position.copy(e.hit.point).sub(this._environment.head.position);var t=this.disk.position.x*this.disk.position.x+this.disk.position.z*this.disk.position.z;if(t>MAX_MOVE_DISTANCE_SQ){var i=Math.sqrt(t),r=MAX_MOVE_DISTANCE/i,n=this.disk.position.y;this.disk.position.y=0,this.disk.position.multiplyScalar(r),this.disk.position.y=n}this.disk.position.add(this._environment.head.position);var o=DIFF.copy(this.disk.position).sub(this._startPoint).length();this._moveDistance+=o}}]),e}(),G=6.673e-11,PIXEL_SCALES=[.5,.25,.333333,.5,1],SKINS=[16768964,15783358,15650483,14792857,15057560,16768178,15054983,15048819,15179373,14389349,13538940,13006934,12217417,10842711,15780041,14526624,12156013,11040108,11363410,6043702,13337666,12415548,7356729,10716778,8848384,7405825,4390912,5963777,3157550],SYS_FONTS="-apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif",Quality={NONE:0,VERYLOW:1,LOW:2,MEDIUM:3,HIGH:4,MAXIMUM:PIXEL_SCALES.length-1},NAMES=["Dahlia","Zinnia","Camellia","Ren","Lotus","Azalea","Kunal","Saffron","Jessamine","Basil","Indigo","Violet","Iris","Holly","Yarrow","Hazel","Cypress","Amaranth","Aster","Emerald","Ash","Boxwood","Birchwood","Ebony","Forsythia","Hawthorn","Hemlock","Locust","Juniper","Linden","Magnolia","Laurel","Oak","Alder","Sycamore","Blackhaw"],Constants={G:G,NAMES:NAMES,PIXEL_SCALES:PIXEL_SCALES,Quality:Quality,SKINS:SKINS,SYS_FONTS:SYS_FONTS},MILLISECONDS_TO_SECONDS=.001,TELEPORT_DISPLACEMENT=new Vector3,DISPLACEMENT=new Vector3,EULER_TEMP=new Euler,QUAT_TEMP=new Quaternion,WEDGE=Math.PI/3,BrowserEnvironment=function(e){function t(e){function i(){if(isiOS){var e=isLandscape();e!=o&&(o=e,window.dispatchEvent(new Event("resize")))}}function r(e){var t=e.clone(),i=t.getHSL();for(i.h=i.h+.5,i.l=1-i.l;i.h>1;)i.h-=1;return t.setHSL(i.h,i.s,i.l),t}classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));n.options=Object.assign({},t.DEFAULTS,e),n.options.foregroundColor=n.options.foregroundColor||r(new Color(n.options.backgroundColor)).getHex(),n.deltaTime=1,n.network=null,null!==n.options.nonstandardIPD&&(n.options.nonstandardIPD*=.5),n.audioQueue=[],n.zero=function(){if(!n.lockMovement){for(var e=0;e<n.managers.length;++e)n.managers[e].zero();n.quality===Quality.NONE&&(n.quality=Quality.HIGH)}};var o=isLandscape(),a=0,s=0,l=function(e){i();for(var t=0;t<n.scene.children.length;++t){var r=n.scene.children[t];r.rigidBody&&!r.rigidBody.world&&n.physics.addBody(r.rigidBody)}if(e=Math.min(1,e*MILLISECONDS_TO_SECONDS),e>0){s+=e;var o=Math.max(1,Math.round(1/e));n.deltaTime=Math.min(n.deltaTime,1/o);var l=s/n.deltaTime;a+=l-1,l>10&&(l=1,s=n.deltaTime),a>0&&(a>=10&&e<1&&(n.deltaTime=e,a=0),1===l&&(a-=.1)),E(e);for(var c=0;c<l;++c){s-=n.deltaTime;var h=n.hasGamepad;n.gamepadMgr&&n.gamepadMgr.poll();for(var d=0;d<n.managers.length;++d)n.managers[d].update(e);!h&&n.hasGamepad&&(n.Mouse.inPhysicalUse=!1),n.head.showPointer=n.VR.hasOrientation&&n.VR.isStereo&&n.options.showHeadPointer,n.mousePointer.visible=(n.VR.isPresenting||!n.VR.isStereo)&&!n.hasTouch,n.mousePointer.showPointer=!n.hasMotionControllers&&!n.VR.isStereo;for(var p=0,f=0,m=0,v=0,g=0;g<n.managers.length;++g){var y=n.managers[g];y.enabled&&("Mouse"!==y.name&&(p+=y.getValue("heading")),f+=y.getValue("pitch"),m+=y.getValue("strafe"),v+=y.getValue("drive"))}if(n.hasMouse){var x=null;if(n.VR.hasOrientation){x=n.mousePointer.rotation.y;var b=WEDGE*Math.floor(x/WEDGE+.5);0!==b&&(n.Mouse.commands.U.offset-=n.Mouse.getValue("U")-1),x=b+2*n.Mouse.commands.U.offset}else x=n.Mouse.getValue("heading");p+=x}n.VR.hasOrientation&&(f=0),EULER_TEMP.set(f,p,0,"YXZ"),n.stage.quaternion.setFromEuler(EULER_TEMP),n.velocity.set(m,0,v),QUAT_TEMP.copy(n.head.quaternion),EULER_TEMP.setFromQuaternion(QUAT_TEMP),EULER_TEMP.x=0,EULER_TEMP.z=0,QUAT_TEMP.setFromEuler(EULER_TEMP),n.moveStage(DISPLACEMENT.copy(n.velocity).multiplyScalar(e).applyQuaternion(QUAT_TEMP).add(n.head.position)),n.stage.position.y=n.ground.getHeightAt(n.stage.position)||0,n.stage.position.y+=n.options.avatarHeight;for(var _=0;_<n.motionDevices.length;++_)n.motionDevices[_].posePosition.y-=n.options.avatarHeight;n.stage.updateMatrix(),n.matrix.multiplyMatrices(n.stage.matrix,n.VR.stage.matrix);for(var w=0;w<n.motionDevices.length;++w)n.motionDevices[w].updateStage(n.matrix);for(var M=0;M<n.pointers.length;++M)n.pointers[M].update();if(n.newState=[],n.head.updateMatrix(),n.stage.rotation.x=0,n.stage.rotation.z=0,n.stage.quaternion.setFromEuler(n.stage.rotation),n.stage.updateMatrix(),n.head.position.toArray(n.newState,0),n.head.quaternion.toArray(n.newState,3),0===c){updateAll();for(var S=null,T=0;T<n.pointers.length;++T)S=n.pointers[T].resolvePicking(n.scene);for(var C=0;C<n.managers.length;++C)n.managers[C].userActionHandlers=S;n.ground.moveTo(n.head.position),n.sky.position.copy(n.head.position),u()}try{n.emit("update")}catch(e){console.error("User update errored",e)}0===c&&n.network&&n.network.update(e)}n.physics.step(n.deltaTime,e),updateAllEntities()}};n.turns=new Angle(0);var c=new Euler,h=-Math.PI/4,u=(Math.PI/6,function(e){var t=n.vicinity.position.y,i=n.options.vicinityFollowRate,r=1-i;n.vicinity.position.lerp(n.head.position,i),n.vicinity.position.y=t,c.setFromQuaternion(n.head.quaternion),n.turns.radians=c.y,c.set(h,n.turns.radians,0,"YXZ"),n.ui.quaternion.setFromEuler(c),n.ui.position.y=n.ui.position.y*r+n.head.position.y*i}),d=function e(t){R=null;var i=t-m;m=t,l(i),n.audio.setPlayer(n.head.mesh),p(),L(e)},p=function(){n.camera.position.set(0,0,0),n.camera.quaternion.set(0,0,0,1),n.renderer.clear(!0,!0,!0);for(var e=n.VR.getTransforms(n.options.nearPlane,n.options.nearPlane+n.options.drawDistance),t=0;e&&t<e.length;++t){eyeBlankAll(t);var i=e[t],r=i.viewport;n.renderer.setViewport(r.left*g,r.top*g,r.width*g,r.height*g),n.camera.projectionMatrix.copy(i.projection),n.mousePointer.unproject&&n.mousePointer.unproject.getInverse(i.projection),n.camera.translateOnAxis(i.translation,1),n.renderer.render(n.scene,n.camera),n.camera.translateOnAxis(i.translation,-1)}n.VR.submitFrame()},f=function(){var e=n.options.nearPlane,t=e+n.options.drawDistance,i=n.VR&&n.VR.getTransforms(e,t);if(i){for(var r=0,o=0,a=0;a<i.length;++a)r+=i[a].viewport.width,o=Math.max(o,i[a].viewport.height);n.mousePointer.setSize(r,o);var s=r/devicePixelRatio,l=o/devicePixelRatio;r=Math.floor(r*g),o=Math.floor(o*g),n.renderer.domElement.width=r,n.renderer.domElement.height=o,n.renderer.domElement.style.width=s+"px",n.renderer.domElement.style.height=l+"px",null===R&&p()}},m=0,v=(new Quaternion,new Vector3,new Vector3,{scene:n.options.sceneModel,avatar:n.options.avatarModel,button:n.options.button&&"string"==typeof n.options.button.model&&n.options.button.model,font:n.options.font}),g=1;n.factories={avatar:null};var y=ModelFactory.loadObjects(v,n.options.progress.thunk).then(function(e){window.text3D=function(e,t,i){var r=new TextGeometry(i,{font:e,size:t,height:t/5,curveSegments:2});return r.computeBoundingSphere(),r.computeBoundingBox(),r}.bind(window,e.font),e.scene&&T(e.scene),e.avatar&&(n.factories.avatar=new ModelFactory(e.avatar)),e.button&&(n.buttonFactory=new ButtonFactory(e.button,n.options.button.options))}).catch(function(e){return console.error(e)}).then(function(){return n.buttonFactory=n.buttonFactory||ButtonFactory.DEFAULT});n.speech=new Speech(n.options.speech),n.audio=new Audio3D,n.options.ambientSound&&n.audio.load3DSound(n.options.ambientSound,!0,-1,1,-1).then(function(e){e.source instanceof MediaElementAudioSourceNode||(e.volume.gain.value=.1,e.source.start())}).catch(console.error.bind(console,"Audio3D loadSource"));var x=null;x="complete"===document.readyState?Promise.resolve("already"):new Promise(function(e,t){document.addEventListener("readystatechange",function(t){"complete"===document.readyState&&e("had to wait for it")},!1)}),n.music=new Music(n.audio),n.currentControl=null;var b=null,_=null,w=null,M=null;n.fadeOut=function(){return w?Promise.reject("Currently fading in."):(b||(n.fader.visible=!0,n.fader.material.opacity=0,n.fader.material.needsUpdate=!0,b=new Promise(function(e,t){return _=function(t){b=null,_=null,e(t)}})),b)},n.fadeIn=function(){return b?Promise.reject("Currently fading out."):(w||(w=new Promise(function(e,t){return M=function(t){w=null,M=null,n.fader.visible=!1,e(t)}})),w)};var E=function(e){if(b||w){var t=n.fader.material,i=n.options.fadeRate*e;t.needsUpdate=!0,b?(t.opacity+=i,1<=t.opacity&&(t.opacity=1,_())):(t.opacity-=i,t.opacity<=0&&(t.opacity=0,M()))}};n.teleportAvailable=!0,n.transition=function(e,t,i){return i?(e(),Promise.resolve()):!t||t()?n.fadeOut().then(e).then(n.fadeIn).catch(console.warn.bind(console,"Error transitioning")):void 0},n.teleport=function(e,t){return n.transition(function(){return n.moveStage(e)},function(){return n.teleportAvailable&&TELEPORT_DISPLACEMENT.copy(e).sub(n.head.position).length()>.2},t)};var S=function e(){n.currentControl&&(n.currentControl.removeEventListener("blur",e),n.Keyboard.enabled=!0,n.Mouse.commands.pitch.disabled=n.Mouse.commands.heading.disabled=n.VR.isPresenting,n.currentControl.blur(),n.currentControl=null)};n.consumeEvent=function(e){var t=e.hit&&e.hit.object,i="exit"===e.type||"NORMAL_ESCAPE"===e.cmdName;("select"===e.type||i)&&(t!==n.currentControl||i)&&(S(),!i&&t.isSurface&&(n.currentControl=t,n.currentControl.focus(),n.currentControl.addEventListener("blur",S),n.currentControl.lockMovement&&(n.Keyboard.enabled=!1,n.Mouse.commands.pitch.disabled=n.Mouse.commands.heading.disabled=!n.VR.isPresenting))),t?t.dispatchEvent(e):n.currentControl&&n.currentControl.dispatchEvent(e),n.dispatchEvent(e)},n.physics=new cannon.World,n.physics.gravity.set(0,n.options.gravity,0),n.physics.broadphase=new cannon.NaiveBroadphase,n.physics.solver.iterations=10,n.physics.addEventListener("preStep",preStepAllEntities),n.physics.addEventListener("postStep",postStepAllEntities),n.options.scene=n.scene=n.options.scene||new Scene,n.options.useFog&&(n.scene.fog=new FogExp2(n.options.backgroundColor,1/Math.sqrt(n.options.drawDistance))),n.camera=new PerspectiveCamera(75,1,n.options.nearPlane,n.options.nearPlane+n.options.drawDistance),n.sky=new Sky(n.options).addTo(n.scene),n.ground=new Ground(n.options).addTo(n.scene),n.teleporter=new Teleporter(n),n.vicinity=hub().named("Vicinity").addTo(n.scene),n.ui=hub().named("UI").addTo(n.vicinity);var T=function(e){return e.buttons=[],e.traverse(function(t){t.isButton&&e.buttons.push(new Button3D(t.parent,t.name)),t.name&&(e[t.name]=t)}),n.scene.add.apply(n.scene,e.children),n.scene.traverse(function(e){n.options.disableDefaultLighting&&e.material&&(e.material.map?e.textured(e.material.map,{unshaded:!0}):e.colored(e.material.color.getHex(),{unshaded:!0})),e.name&&(n.scene[e.name]=e)}),e.Camera&&(n.camera.position.copy(e.Camera.position),n.camera.quaternion.copy(e.Camera.quaternion)),e};n.goFullScreen=function(e,t){if("Gaze"!==t){var i=null;return i="force"===t||n.VR.canMirror||n.VR.isNativeWebVR?n.renderer.domElement:n.options.fullScreenElement,n.VR.connect(e),n.VR.requestPresent([{source:i}]).catch(function(e){return console.error("whaaat",e)}).then(function(){return i.focus()})}},n.addAvatar=function(e){console.log(e),n.scene.add(e.stage),n.scene.add(e.head)},n.removeAvatar=function(e){n.scene.remove(e.stage),n.scene.remove(e.head)},PointerLock.addChangeListener(function(e){n.VR.isPresenting&&!PointerLock.isActive&&n.cancelVR()});var C=function(e){var t=!!n.VR.isPresenting,i=(t?"remove":"add")+"Button";n.Mouse[i]("dx",0),n.Mouse[i]("dy",0),n.Mouse.commands.U.disabled=n.Mouse.commands.V.disabled=t&&!n.VR.isStereo,n.Mouse.commands.heading.scale=t?-1:1,n.Mouse.commands.pitch.scale=t?-1:1,t||n.cancelVR(),f()},A=!0,P=null,R=null,L=function(e){P=n.VR.currentDevice||window,null===R&&(R=P.requestAnimationFrame(e))};if(n.start=function(){A&&n.ready.then(function(){n.audio.start(),m=performance.now()*MILLISECONDS_TO_SECONDS,L(d)})},n.stop=function(e,t){A&&(A=t,A||console.log("stopped"),P&&(null!==R&&(P.cancelAnimationFrame(R),R=null),n.audio.stop(),P=null))},n.pause=function(e){return n.stop(e,!0)},window.addEventListener("vrdisplaypresentchange",C,!1),window.addEventListener("resize",f,!1),e.disableAutoPause||(window.addEventListener("focus",n.start,!1),window.addEventListener("blur",n.pause,!1)),window.addEventListener("stop",n.stop,!1),document.addEventListener("amazonPlatformReady",function(){document.addEventListener("pause",n.pause,!1),document.addEventListener("resume",n.start,!1)},!1),x=x.then(function(){n.options.renderer?n.renderer=n.options.renderer:(n.renderer=new WebGLRenderer({canvas:cascadeElement(n.options.canvasElement,"canvas",HTMLCanvasElement),context:n.options.context,antialias:n.options.antialias,alpha:!0,logarithmicDepthBuffer:!1}),n.renderer.autoClear=!1,n.renderer.sortObjects=!0,n.renderer.setClearColor(n.options.backgroundColor),n.renderer.domElement.parentElement||document.body.appendChild(n.renderer.domElement)),n.options.fullScreenElement=cascadeElement(n.options.fullScreenElement)||n.renderer.domElement;for(var e=0,t=document.querySelectorAll("[tabIndex]"),i=0;i<t.length;++i)e=Math.max(e,t[i].tabIndex);if(n.renderer.domElement.tabIndex=e+1,n.renderer.domElement.addEventListener("webglcontextlost",n.pause,!1),n.renderer.domElement.addEventListener("webglcontextrestored",n.start,!1),n.managers=[],n.newState=[],n.pointers=[],n.motionDevices=[],n.velocity=new Vector3,n.matrix=new Matrix4,n.options.disableKeyboard||(n.addInputManager(new Keyboard(n,{strafeLeft:{buttons:[-Keys.A,-Keys.LEFTARROW]},strafeRight:{buttons:[Keys.D,Keys.RIGHTARROW]},strafe:{commands:["strafeLeft","strafeRight"]},driveForward:{buttons:[-Keys.W,-Keys.UPARROW]},driveBack:{buttons:[Keys.S,Keys.DOWNARROW]},drive:{commands:["driveForward","driveBack"]},select:{buttons:[Keys.ENTER]},dSelect:{buttons:[Keys.ENTER],delta:!0},zero:{buttons:[Keys.Z],metaKeys:[-Keys.CTRL,-Keys.ALT,-Keys.SHIFT,-Keys.META],commandUp:n.emit.bind(n,"zero")}})),n.Keyboard.operatingSystem=n.options.os,n.Keyboard.codePage=n.options.language),n.addInputManager(new Touch(n.renderer.domElement,{U:{axes:["X0"],min:0,max:2,offset:0},V:{axes:["Y0"],min:0,max:2},buttons:{axes:["FINGERS"]},dButtons:{axes:["FINGERS"],delta:!0},heading:{axes:["DX0"],integrate:!0},pitch:{axes:["DY0"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI}})),n.addInputManager(new Mouse(n.options.fullScreenElement,{U:{axes:["X"],min:0,max:2,offset:0},V:{axes:["Y"],min:0,max:2},buttons:{axes:["BUTTONS"]},dButtons:{axes:["BUTTONS"],delta:!0},_dx:{axes:["X"],delta:!0,scale:.25},dx:{buttons:[0],commands:["_dx"]},heading:{commands:["dx"],integrate:!0},_dy:{axes:["Y"],delta:!0,scale:.25},dy:{buttons:[0],commands:["_dy"]},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI}})),n.Touch.addEventListener("activate",function(e){return n.Mouse.inPhysicalUse=!1}),n.Mouse.addEventListener("activate",function(e){return n.Touch.inPhysicalUse=!1}),n.addInputManager(new VR(n.options)),n.motionDevices.push(n.VR),!n.options.disableGamepad&&GamepadManager.isAvailable&&(n.gamepadMgr=new GamepadManager,n.gamepadMgr.addEventListener("gamepadconnected",function(e){var t=Gamepad.ID(e),i=null;if("Unknown"!==t&&"Rift"!==t)if(Gamepad.isMotionController(e)){for(var r=0,o=0;o<n.managers.length;++o)i=n.managers[o],i.currentPad&&i.currentPad.id===e.id&&++r;i=new Gamepad(n.gamepadMgr,e,r,{buttons:{axes:["BUTTONS"]},dButtons:{axes:["BUTTONS"],delta:!0},zero:{buttons:[Gamepad.VIVE_BUTTONS.GRIP_PRESSED],commandUp:n.emit.bind(n,"zero")}}),n.addInputManager(i),n.motionDevices.push(i);var a=8*(n.motionDevices.length-2),s=255<<a,l=16711680>>a,c=new Pointer(t+"Pointer",s,1,l,[i],null,n.options);box(.1,.025,.2).colored(s,{emissive:l}).addTo(c),c.route(Pointer.EVENTS,n.consumeEvent.bind(n)),n.pointers.push(c),n.scene.add(c),n.emit("motioncontrollerfound",i)}else i=new Gamepad(n.gamepadMgr,e,0,{buttons:{axes:["BUTTONS"]},dButtons:{axes:["BUTTONS"],delta:!0},strafe:{axes:["LSX"],deadzone:.2},drive:{axes:["LSY"],deadzone:.2},heading:{axes:["RSX"],scale:-1,deadzone:.2,integrate:!0},dHeading:{commands:["heading"],delta:!0},pitch:{axes:["RSY"],scale:-1,deadzone:.2,integrate:!0},zero:{buttons:[Gamepad.XBOX_ONE_BUTTONS.BACK],commandUp:n.emit.bind(n,"zero")}}),n.addInputManager(i),n.mousePointer.addDevice(i,i)}),n.gamepadMgr.addEventListener("gamepaddisconnected",n.removeInputManager.bind(n))),n.stage=hub(),n.head=new Pointer("GazePointer",16776960,255,.8,[n.VR],[n.Mouse,n.Touch,n.Keyboard],n.options).addTo(n.scene),n.head.route(Pointer.EVENTS,n.consumeEvent.bind(n)),n.head.rotation.order="YXZ",n.head.useGaze=n.options.useGaze,n.pointers.push(n.head),n.mousePointer=new Pointer("MousePointer",16711680,65280,1,[n.Mouse,n.Touch],null,n.options),n.mousePointer.route(Pointer.EVENTS,n.consumeEvent.bind(n)),n.mousePointer.unproject=new Matrix4,n.pointers.push(n.mousePointer),n.head.add(n.mousePointer),n.VR.ready.then(function(e){return e.forEach(function(e,t){window.addEventListener("vrdisplayactivate",function(i){if(i.display===e){var r=function e(){window.removeEventListener("vrdisplaydeactivate",e),n.cancelVR()};window.addEventListener("vrdisplaydeactivate",r,!1),n.goFullScreen(t)}},!1)})}),n.fader=box(1,1,1).colored(n.options.backgroundColor,{opacity:0,useFog:!1,transparent:!0,unshaded:!0,side:BackSide}).addTo(n.head),n.fader.visible=!1,!n.options.disableKeyboard){var r=function(e){e.returnValue=!1},o=function(e){n.VR.isPresenting&&(e.keyCode!==Keys.ESCAPE||n.VR.isPolyfilled||n.cancelVR()),n.Keyboard.consumeEvent(e),n.consumeEvent(e)},a=function(e){n.Keyboard.consumeEvent(e),n.consumeEvent(e)},s=function(e){return function(t){n.currentControl&&(n.currentControl[e]?n.currentControl[e](t):console.warn("Couldn't find %s on %o",e,n.currentControl))}};window.addEventListener("keydown",o,!1),window.addEventListener("keyup",a,!1),window.addEventListener("paste",s("readClipboard"),!1),window.addEventListener("wheel",s("readWheel"),!1);var l=function(e){if(n.lockMovement){var t=n.Keyboard.operatingSystem.makeCommandName(e,n.Keyboard.codePage);"CUT"!==t&&"COPY"!==t||(h.style.display="block",h.focus())}},c=function(e){n.currentControl&&(n.currentControl[e.type+"SelectedText"](e),e.returnValue||e.preventDefault(),h.style.display="none",n.currentControl.focus())},h=cascadeElement("primrose-surrogate-textarea","textarea",HTMLTextAreaElement),u=makeHidingContainer("primrose-surrogate-textarea-container",h);u.style.position="absolute",u.style.overflow="hidden",u.style.width=0,u.style.height=0,h.addEventListener("beforecopy",r,!1),h.addEventListener("copy",c,!1),h.addEventListener("beforecut",r,!1),h.addEventListener("cut",c,!1),document.body.insertBefore(u,document.body.children[0]),window.addEventListener("beforepaste",r,!1),window.addEventListener("keydown",l,!0)}return n.head.add(n.camera),Promise.all(n.managers.map(function(e){return e.ready}).filter(identity))}),n._readyParts=[n.sky.ready,n.ground.ready,y,x],n.ready=Promise.all(n._readyParts).then(function(){n.ground.rigidBody&&n.physics.addBody(n.ground.rigidBody),n.renderer.domElement.style.cursor="none",n.options.enableShadows&&n.sky.sun&&(n.renderer.shadowMap.enabled=!0,n.renderer.shadowMap.type=PCFSoftShadowMap),n.VR.displays.forEach(function(e){void 0!==e.DOMElement&&(e.DOMElement=n.renderer.domElement)}),n.options.fullScreenButtonContainer&&n.insertFullScreenButtons(n.options.fullScreenButtonContainer),n.VR.connect(0),n.options.progress.hide(),n.emit("ready")}),Object.defineProperties(n,{quality:{get:function(){return n.options.quality},set:function(e){0<=e&&e<PIXEL_SCALES.length&&(n.options.quality=e,g=PIXEL_SCALES[e]),n.ready.then(f)}}}),n.quality=n.options.quality,window.alert.toString().indexOf("native code")>-1){var B=function(e,t){return t||(t=function(){}),function(){this.VR&&this.VR.isPresenting?t():e.apply(window,arguments)}.bind(n)};window.alert=B(window.alert),window.confirm=B(window.confirm),window.prompt=B(window.prompt)}return n.start(),n}return inherits(t,e),createClass(t,[{key:"connect",value:function(e,t){return this.network||(this.network=new Manager(this,this.audio,this.factories,this.options),this.network.addEventListener("addavatar",this.addAvatar),this.network.addEventListener("removeavatar",this.removeAvatar)),this.network&&this.network.connect(e,t)}},{key:"disconnect",value:function(){return this.network&&this.network.disconnect()}},{key:"addInputManager",value:function(e){for(var t=this.managers.length-1;t>=0;--t)this.managers[t].name===e.name&&this.managers.splice(t,1);this.managers.push(e),this[e.name]=e}},{key:"removeInputManager",value:function(e){var t=this[e],i=this.managers.indexOf(t);i>-1&&(this.managers.splice(i,1),delete this[e]),console.log("removed",t)}},{key:"moveStage",value:function(e){DISPLACEMENT.copy(e).sub(this.head.position),this.stage.position.add(DISPLACEMENT)}},{key:"cancelVR",value:function(){this.VR.cancel(),this.Touch.commands.U.offset=this.Mouse.commands.U.offset=0}},{key:"setAudioFromUser",value:function(e,t){if(this.audioQueue.push([e,t]),this.network)for(;this.audioQueue.length>0;)this.network.setAudioFromUser.apply(this.network,this.audioQueue.shift())}},{key:"insertFullScreenButtons",value:function(e){var t=this,i=document.querySelector(e),r=function(e,t,r){var n=document.createElement("button");return n.type="button",n.title=e,n.appendChild(document.createTextNode(t)),n.addEventListener("click",r,!1),i.appendChild(n),n},n=this.displays.map(function(e,i){if(!isiOS||VR.isStereoDisplay(e)){var n=t.goFullScreen.bind(t,i),o=r(e.displayName,e.displayName,n),a=VR.isStereoDisplay(e);return o.className=a?"stereo":"mono",o}}).filter(identity);return/(www\.)?primrosevr.com/.test(document.location.hostname)||this.options.disableAdvertising||n.push(r("Primrose","✿",function(){return open("https://www.primrosevr.com","_blank")})),n}},{key:"lockMovement",get:function(){return this.currentControl&&this.currentControl.lockMovement}},{key:"displays",get:function(){return this.VR.displays}},{key:"fieldOfView",get:function(){var e=this.VR.currentDevice,t=[e&&e.getEyeParameters("left"),e&&e.getEyeParameters("right")].filter(identity);if(t.length>0)return t.reduce(function(e,t){return Math.max(e,t.fieldOfView.upDegrees+t.fieldOfView.downDegrees)},0)},set:function(e){this.options.defaultFOV=StandardMonitorVRDisplay.DEFAULT_FOV=e}},{key:"currentTime",get:function(){return this.audio.context.currentTime}},{key:"hasMotionControllers",get:function(){return!!(this.Vive_0&&this.Vive_0.enabled&&this.Vive_0.inPhysicalUse||this.Vive_1&&this.Vive_1.enabled&&this.Vive_1.inPhysicalUse)}},{key:"hasGamepad",get:function(){return!!(this.Gamepad_0&&this.Gamepad_0.enabled&&this.Gamepad_0.inPhysicalUse)}},{key:"hasMouse",get:function(){return!!(this.Mouse&&this.Mouse.enabled&&this.Mouse.inPhysicalUse)}},{key:"hasTouch",get:function(){return!!(this.Touch&&this.Touch.enabled&&this.Touch.inPhysicalUse)}}]),t}(EventDispatcher);BrowserEnvironment.DEFAULTS={antialias:!0,quality:Quality.MAXIMUM,useGaze:isCardboard,useFog:!1,avatarHeight:1.65,walkSpeed:2,disableKeyboard:!1,enableShadows:!1,shadowMapSize:2048,shadowCameraSize:15,shadowRadius:1,progress:window.Preloader||{thunk:function(){},hide:function(){},resize:function(){}},fadeRate:5,vicinityFollowRate:.02,gravity:-9.8,gazeLength:1.5,disableAutoPause:!1,disableMirroring:!1,disableDefaultLighting:!1,backgroundColor:11517951,skyTexture:null,groundTexture:null,nearPlane:.01,drawDistance:100,defaultFOV:StandardMonitorVRDisplay.DEFAULT_FOV,ambientSound:null,canvasElement:"frontBuffer",renderer:null,context:null,scene:null,nonstandardNeckLength:null,nonstandardNeckDepth:null,showHeadPointer:!0,nonstandardIPD:null,disableAdvertising:!1};var COUNTER$7=0,Model=function(e){function t(e,i){classCallCheck(this,t),name=i&&i.id||"Primrose.Controls.Model["+COUNTER$7++ +"]";var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,name,i));return r._file=e,r._model=null,r}return inherits(t,e),createClass(t,[{key:"_ready",get:function(){var e=this;return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_ready",this).then(function(){return cache(e._file,function(){return ModelFactory.loadModel(e._file,e.options.type,e.options.progress)}).then(function(t){return e._model=t.clone(),e.add(e._model),e})})}}]),t}(Entity),PlainText$1=function e(t,i,r,n,o,a,s){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"center";classCallCheck(this,e),t=t.replace(/\r\n/g,"\n");var c=t.split("\n"),h=1e3*i,u=h*c.length,d=document.createElement("canvas"),p=d.getContext("2d");p.font=h+"px Arial";var f=p.measureText(t).width;d.width=f,d.height=u,p.font=.8*h+"px Arial","transparent"!==n&&(p.fillStyle=n,p.fillRect(0,0,d.width,d.height)),p.fillStyle=r;for(var m=0;m<c.length;++m)p.fillText(c[m],0,m*h);var v=new Texture(d);v.needsUpdate=!0;var g=new MeshBasicMaterial({map:v,transparent:"transparent"===n,useScreenCoordinates:!1,color:16777215,shading:FlatShading}),y=new PlaneGeometry(i*f/h,i*c.length);y.computeBoundingBox(),y.computeVertexNormals();var x=new Mesh(y,g);return"left"===l?o-=y.boundingBox.min.x:"right"===l&&(o+=y.boundingBox.min.x),x.position.set(o,a,s),x},SIZE=1,INSET=.8,PROPORTION=10,SIZE_SMALL=SIZE/PROPORTION,INSET_LARGE=1-(1-INSET)/PROPORTION,Progress=function(){function e(t,i){classCallCheck(this,e),t=t||16777215,i=i||0;var r=box(SIZE,SIZE_SMALL,SIZE_SMALL);this.totalBar=r.colored(i,{unshaded:!0,side:BackSide}),this.valueBar=r.colored(t,{unshaded:!0}).scl(0,INSET,INSET).addTo(this.totalBar),this.fileState=null,this.reset()}return createClass(e,[{key:"reset",value:function(){this.fileState={},this.value=0}},{key:"onProgress",value:function(e){var t=e.target.responseURL||e.target.currentSrc;if(t&&void 0!==e.loaded){this.fileState[t]||(this.fileState[t]={});var i=this.fileState[t];i.loaded=e.loaded,i.total=e.total}var r=0,n=0;for(var o in this.fileState){var a=this.fileState[o];r+=a.total,n+=a.loaded}r>0?this.value=n/r:this.value=0}},{key:"visible",get:function(){return this.totalBar.visible},set:function(e){this.totalBar.visible=e}},{key:"position",get:function(){return this.totalBar.position}},{key:"quaternion",get:function(){return this.totalBar.quaternion}},{key:"value",get:function(){return this.valueBar.scale.x/INSET_LARGE},set:function(e){this.valueBar.scale.x=e*INSET_LARGE,this.valueBar.position.x=-SIZE*(1-e)*INSET_LARGE/2}}]),e}(),TextInput$2=new BasicTextInput("Text Line input commands"),COUNTER$8=0,TextInput=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({},{id:"Primrose.Controls.TextInput["+COUNTER$8++ +"]",padding:5,singleLine:!0,disableWordWrap:!0,hideLineNumbers:!0,hideScrollBars:!0,tabWidth:1,tokenizer:PlainText,commands:TextInput$2}),e));return i.passwordCharacter=i.options.passwordCharacter,i}return inherits(t,e),createClass(t,[{key:"drawText",value:function(e,i,r,n){if(this.passwordCharacter){for(var o="",a=0;a<i.length;++a)o+=this.passwordCharacter;i=o}get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"drawText",this).call(this,e,i,r,n)}},{key:"value",get:function(){return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"value",this)},set:function(e){e=e||"",e=e.replace(/\r?\n/g,""),set(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"value",e,this);
}},{key:"selectedText",get:function(){return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"selectedText",this)},set:function(e){e=e||"",e=e.replace(/\r?\n/g,""),set(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"selectedText",e,this)}}]),t}(TextBox),Controls={Button2D:Button2D,Button3D:Button3D,ButtonFactory:ButtonFactory,Component:Component,Entity:Entity,Ground:Ground,Image:Image,Label:Label,Model:Model,PlainText:PlainText$1,Progress:Progress,Sky:Sky,Surface:Surface,TextBox:TextBox,TextInput:TextInput,Video:Video},Displays={CardboardVRDisplay:CardboardVRDisplay,install:install,MockVRDisplay:MockVRDisplay,StandardMonitorVRDisplay:StandardMonitorVRDisplay,VRDisplay:VRDisplay,VRFrameData:VRFrameData},DOM={cascadeElement:cascadeElement,findEverything:findEverything,makeHidingContainer:makeHidingContainer},Graphics={fixGeometry:fixGeometry,InsideSphereGeometry:InsideSphereGeometry,loadTexture:loadTexture,ModelFactory:ModelFactory},Location=function(e){function t(e,i){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"Location",e,["LONGITUDE","LATITUDE","ALTITUDE","HEADING","SPEED"]));return r.options=Object.assign({},t.DEFAULTS,i),r.available=!!navigator.geolocation,r.available&&navigator.geolocation.watchPosition(r.setState.bind(r),function(){return r.available=!1},r.options),r}return inherits(t,e),createClass(t,[{key:"setState",value:function(e){this.inPhysicalUse=!0;for(var t in e.coords){var i=t.toUpperCase();this.axisNames.indexOf(i)>-1&&this.setAxis(i,e.coords[t])}this.update()}}]),t}(InputProcessor);Location.DEFAULTS={enableHighAccuracy:!0,maximumAge:3e4,timeout:25e3};var Input={Gamepad:Gamepad,InputProcessor:InputProcessor,Keyboard:Keyboard,Location:Location,Mouse:Mouse,PoseInputProcessor:PoseInputProcessor,Speech:Speech$1,Touch:Touch,VR:VR},PEERING_TIMEOUT_LENGTH=3e4,INSTANCE_COUNT=0,WebRTCSocketEvent=function(e){function t(e,i,r,n,o){classCallCheck(this,t);var a=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return Object.assign(a,{fromUserName:r,toUserName:n,item:o}),a}return inherits(t,e),t}(Event),WebRTCSocket=function(e){function t(e,i,r,n){classCallCheck(this,t);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),a=0,s=++INSTANCE_COUNT,l=function(e,t,i){if(t<a){for(var r=["%s: "+i,t],n=3;n<arguments.length;++n)r.push(arguments[n]);console[e].apply(console,r)}return arguments[3]};o.myResult=null,o.theirResult=null,o._timeout=null,o._log=l.bind(null,"trace"),o._error=l.bind(null,"error",0,""),o.fromUserName=i,o.toUserName=r,o.rtc=null,o.inAudioStreams=[],o.outAudioStreams=[],o.dataChannels=[],o.goFirst=!n,o.preferOpus=!0,o.progress={offer:{created:!1,received:!1},answer:{created:!1,received:!1}},window.addEventListener("unload",o.close.bind(o));var c=function(e){o._log(2,"Tearing down event handlers"),o.stopTimeout(),o.rtc.onsignalingstatechange=null,o.rtc.oniceconnectionstatechange=null,o.rtc.onnegotiationneeded=null,o.rtc.onicecandidate=null,o.rtc.ondatachannel=null,o.rtc.ontrack=null,o.rtc.onaddstream=null,o.teardown(),e&&o.close()},h=function(e){return o.complete&&(o._log(1,"Timeout avoided."),c(),o.emit("ready",o.dataChannels[0])),e};if(o.peering_answer=function(e){return o._log(1,"description",e),o.recordProgress(e.item,"received"),o.rtc.setRemoteDescription(new RTCSessionDescription(e.item)).then(h).catch(o.peering_error)},o.descriptionCreated=function(e){return o.recordProgress(e,"created"),o.rtc.setLocalDescription(e).then(function(){return o.emit(e.type,e)}).then(h).catch(o.peering_error)},o.peering_error=function(e){o._error(e),o.emit("cancel",e),o._log(1,"Timeout avoided, but only because of an error."),c(!0),o.emit("error",e)},o.peering_cancel=function(e){o._error(e),o._log(1,"Timeout avoided, but only because of an error."),c(!0),o.emit("error",e)},o.peering_offer=function(e){o._log(1,"offer",e);var t=o.peering_answer(e);if(t)return t.then(function(){return o.rtc.createAnswer()}).then(o.descriptionCreated)},o.peering_ice=function(e){o._log(1,"ice",e);var t=new RTCIceCandidate(e.item);return o.rtc.addIceCandidate(t).catch(o._error)},o.peering_peer=function(e){o._log(1,"peering",e),o.goFirst&&(o._log(0,"Creating data channel"),o.emit("readyforcontent"))},e===!0?e=t.DEFAULT_ICE_CONFIG:e===!1&&(e=null),e){for(var u=e.iceServers.length-1;u>=0;--u){var d=e.iceServers[u];d.urls&&0!==d.urls.length?(d.url&&!d.urls&&(d.urls=[d.url],delete d.url),d.username&&d.credential&&(d.credentialType="token")):e.iceServers.splice(u,1)}e.iceCandidatePoolSize=100}o._log(1,JSON.stringify(e)),o.rtc=new RTCPeerConnection(e),o.rtc.onsignalingstatechange=function(e){return o._log(1,"[%s] Signal State: %s",s,o.rtc.signalingState)},o.rtc.oniceconnectionstatechange=function(e){return o._log(1,"[%s] ICE Connection %s, Gathering %s",s,o.rtc.iceConnectionState,o.rtc.iceGatheringState)},o.rtc.onnegotiationneeded=function(e){return o.createOffer().then(o.descriptionCreated)},o.rtc.onicecandidate=function(e){e.candidate&&o.emit("ice",e.candidate)};var p=function(e){o.inAudio=e,o.goFirst||(o._log(0,"Creating the second stream from %s to %s",o.fromUserName,o.toUserName),o.stopTimeout(),o._log(1,"Restarting timeout."),o.startTimeout(),o.addStream())};return"ontrack"in o.rtc?o.rtc.ontrack=function(e){return p(e.streams[0])}:o.rtc.onaddstream=function(e){return p(e.stream)},o}return inherits(t,e),createClass(t,[{key:"createChannel",value:function(){if(this.rtc){var e=this.rtc.createDataChannel("from-"+this.fromUserName+"-to-"+this.toUserName+"-"+this.dataChannels.length);return this.dataChannels.push(e),e}}},{key:"addStream",value:function(){var e=this;this._log(0,"adding stream",this.outAudio,this.rtc.addTrack),this.outAudio.then(function(t){e.rtc.addTrack?t.getAudioTracks().forEach(function(i){return e.rtc.addTrack(i,t)}):e.rtc.addStream(t),isIE&&e.createOffer().then(e.descriptionCreated)})}},{key:"connect",value:function(){var e=this;return new Promise(function(t,i){var r=function(){e.removeEventListener("ready",n),e.removeEventListener("error",o)},n=function(e){r(),t(e.item)},o=function(e){r(),i(e)};e.addEventListener("ready",n),e.addEventListener("error",o),e.goFirst||e.emit("peer")})}},{key:"emit",value:function(e,t){this.dispatchEvent(new WebRTCSocketEvent(e,this,this.fromUserName,this.toUserName,t))}},{key:"startTimeout",value:function(){null===this._timeout&&(this._log(1,"Timing out in "+Math.floor(PEERING_TIMEOUT_LENGTH/1e3)+" seconds."),this._timeout=setTimeout(this.peering_error.bind(this,"Gave up waiting on the peering connection."),PEERING_TIMEOUT_LENGTH))}},{key:"stopTimeout",value:function(){null!==this._timeout&&(clearTimeout(this._timeout),this._timeout=null)}},{key:"createOffer",value:function(){return this.rtc.createOffer(this.offerOptions)}},{key:"recordProgress",value:function(e,t){this._log(2,"Logging progress [%s]: %s %s -> true",e.type,t,this.progress[e.type][t]),this.progress[e.type][t]=!0}},{key:"close",value:function(){this.rtc&&"closed"!==this.rtc.signalingState&&(this.rtc.close(),this.rtc=null)}},{key:"teardown",value:function(){this.rtc.ondatachannel=null}},{key:"complete",get:function(){return this.goFirst?this._log(1,"[First]: OC %s -> AR %s.",this.progress.offer.created,this.progress.answer.received):this._log(1,"[Second]: OC %s -> AR %s.",this.progress.offer.created,this.progress.answer.received),!this.rtc||"closed"===this.rtc.signalingState||this.dataChannels.length>0&&(this.goFirst&&this.progress.offer.created&&this.progress.answer.received||!this.goFirst&&this.progress.offer.received&&this.progress.answer.created)}}]),t}(EventDispatcher);WebRTCSocket.PEERING_EVENTS=["peer","cancel","offer","ice","answer"],WebRTCSocket.DEFAULT_ICE_CONFIG={iceServers:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302"].map(function(e){return Object.assign({credential:null,url:e,urls:e,username:null})})};var ENABLE_OPUS_HACK=!0,AudioChannel=function(e){function t(e,i,r,n,o){classCallCheck(this,t),console.log("attempting to peer audio from %s to %s. %s goes first.",i,r,o?r:i);var a=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,0,r,0,o));return a.outAudio=n,a.inAudio=null,a.startTimeout(),a}return inherits(t,e),createClass(t,[{key:"issueRequest",value:function(){var e=this;console.log("going first",this.goFirst);var t=function(){e._log(0,"adding stream",e.outAudio,e.rtc.addTrack),e.outAudio.then(function(t){e.rtc.addTrack?t.getAudioTracks().forEach(function(i){return e.rtc.addTrack(i,t)}):e.rtc.addStream(t),isIE&&e.createOffer().then(e.descriptionCreated)})},i=function(i){e.inAudio=i,e.goFirst||(e._log(0,"Creating the second stream from %s to %s",e.fromUserName,e.toUserName),e.stopTimeout(),e._log(1,"Restarting timeout."),e.startTimeout(),t())};"ontrack"in this.rtc?this.rtc.ontrack=function(e){return i(e.streams[0])}:this.rtc.onaddstream=function(e){return i(e.stream)},this.goFirst&&(this._log(0,"Creating the first stream from %s to %s",this.fromUserName,this.toUserName),t())}},{key:"teardown",value:function(){"ontrack"in this.rtc?this.rtc.ontrack=null:this.rtc.onaddstream=null}},{key:"createOffer",value:function(){return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"createOffer",this).call(this).then(preferOpus)}},{key:"complete",get:function(){return this.goFirst?this._log(1,"[First]: offer created: %s, answer recv: %s -> offer recv: %s -> answer created: %s.",this.progress.offer.created,this.progress.answer.received,this.progress.offer.received,this.progress.answer.created,this.rtc.signalingState):this._log(1,"[Second]: offer recv: %s, answer created: %s -> offer created: %s -> answer recv: %s.",this.progress.offer.received,this.progress.answer.created,this.progress.offer.created,this.progress.answer.received,this.rtc.signalingState),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"complete",this)||this.progress.offer.received&&this.progress.offer.created&&this.progress.answer.received&&this.progress.answer.created}}]),t}(WebRTCSocket),DataChannel=function(e){function t(e,i,r,n,o,a){classCallCheck(this,t);var s=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,r,n,o,a));return s.dataChannel=null,s}return inherits(t,e),createClass(t,[{key:"issueRequest",value:function(){var e=this;this.goFirst?(this._log(0,"Creating data channel"),this.dataChannel=this.rtc.createDataChannel()):this.ondatachannel=function(t){e._log(0,"Receving data channel"),e.dataChannel=t.channel}}},{key:"teardown",value:function(){this.rtc.ondatachannel=null}},{key:"complete",get:function(){return this.goFirst?this._log(1,"[First]: OC %s -> AR %s.",this.progress.offer.created,this.progress.answer.received):this._log(1,"[Second]: OC %s -> AR %s.",this.progress.offer.created,this.progress.answer.received),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"complete",this)||this.goFirst&&this.progress.offer.created&&this.progress.answer.received||!this.goFirst&&this.progress.offer.received&&this.progress.answer.created}}]),t}(WebRTCSocket),Network={AudioChannel:AudioChannel,DataChannel:DataChannel,Manager:Manager,RemoteUser:RemoteUser,WebRTCSocket:WebRTCSocket},Vec3=cannon.Vec3,TEMP$3=new Vec3,DirectedForceField=function(e){function t(e,i,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.bodyStart=e,n.bodyEnd=i,r=Object.assign({force:1,gravitational:!1,falloff:!0},r),n.force=r.force,n.gravitational=r.gravitational,n.falloff=r.falloff,n}return inherits(t,e),createClass(t,[{key:"preStep",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"preStep",this).call(this);var e=this.bodyEnd.rigidBody,i=this.bodyStart.rigidBody;if(e&&i){i.position.vsub(e.position,TEMP$3);var r=TEMP$3.length(),n=this.force;this.gravitational&&(n*=e.mass*i.mass),(this.gravitational||this.falloff)&&(r*=r*r),TEMP$3.mult(n/r,TEMP$3),i.force.vadd(TEMP$3,i.force),TEMP$3.negate(TEMP$3),e.force.vadd(TEMP$3,e.force)}}}]),t}(Component),Physics={DirectedForceField:DirectedForceField,Spring:Spring},Random={color:color,flipCoin:flipCoin,ID:ID,int:int,item:item,number:number,steps:steps,vector:vector},Watcher=function(e){function t(e,i){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return r.read=function(){var e=r.get();return e!==r.lastValue?(r.lastValue=e,new Record(r.path,e,i)):null},r}return inherits(t,e),t}(Obj),Recorder=function(e){function t(e,i){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i));return r.watchers=e.map(function(e){return new Watcher(e,r.root)}),r}return inherits(t,e),createClass(t,[{key:"update",value:function(e){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"update",this).call(this,e);var i=this.watchers.map(function(e){return e.read()}).filter(function(e){return e}),r=new Frame(e-this.startT,i);this.frames.push(r),this.emit("frame",r)}},{key:"toJSON",value:function(){var e={};return this.frames.forEach(function(t){e[t.t]={};for(var i=0;i<t.records.length;++i){var r=t.records[i];if(null!==r.value){for(var n=r.path.split("."),o=n[n.length-1],a=e[t.t],s=0;s<n.length-1;++s){var l=n[s];void 0!==a[l]&&null!==a[l]||(/^\d+$/.test(n[s+1])?a[l]=[]:a[l]={}),a=a[l]}a[o]=r.value}}}),JSON.stringify(e)}}]),t}(Automator),Replay={Automator:Automator,Frame:Frame,Obj:Obj,Player:Player,Record:Record,Recorder:Recorder,Watcher:Watcher},CommandPacks={BasicTextInput:BasicTextInput,CommandPack:CommandPack,TextEditor:TextEditor,TextInput:TextInput$2},eval2=eval,Basic=new Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["startLineComments",/^REM\s/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=Basic.tokenize;Basic.tokenize=function(e){return oldTokenize.call(this,e.toUpperCase())},Basic.interpret=function(e,t,i,r,n,o,a,s){function l(e){return new Token(e.toString(),"numbers")}function c(e){return new Token('"'+e.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function h(e){if(e&&e.length>0){var t=e.shift();if(t){if(re.hasOwnProperty(t.value))return re[t.value](e);if(!isNaN(t.value))return v([t]);if(K[t.value]||e.length>0&&"operators"===e[0].type&&"="===e[0].value)return e.unshift(t),k(e);u("Unknown command. >>> "+t.value)}}return y()}function u(e){r("At line "+z[V]+": "+e)}function d(e){var t=z[e],i=G[t];return i&&i.slice()}function p(e){for(var t="",i=0;i<e.length;++i){var r=e[i],n=0;if("identifiers"===r.type&&"function"!=typeof K[r.value]&&i<e.length-1&&"("===e[i+1].value)for(var o=i+1;o<e.length;++o){var a=e[o];if("("===a.value?(0===n&&(a.value="["),++n):")"===a.value?(--n,0===n&&(a.value="]")):","===a.value&&1===n&&(a.value="]["),0===n)break}t+=r.value}try{return eval2(t)}catch(i){console.error(i),console.debug(e.join(", ")),console.error(t),u(i.message+": "+t)}}function f(e){var t,i=[],r=[i],n=0;for(t=0;t<e.length;++t){var o=e[t];"("===o.value?++n:")"===o.value&&--n,0===n&&","===o.value?(i=[],r.push(i)):i.push(o)}for(t=0;t<r.length;++t){i=r[t];var a=i.shift();if("identifiers"===a.type){var s,l=null;if(a=a.value,"("===i[0].value&&")"===i[i.length-1].value){var c=[];for(s=1;s<i.length-1;++s)"numbers"===i[s].type&&c.push(0|i[s].value);if(0===c.length)l=[];else{l=new Array(c[0]);var h=[l];for(s=1;s<c.length;++s)for(var d=c[s],p=0,f=h.length;p<f;++p)for(var m=h.shift(),v=0;v<m.length;++v)m[v]=new Array(d),s<c.length-1&&h.push(m[v])}}return K[a]=l,!0}u("Identifier expected: "+a.value)}}function m(e){var t="\n",r=0;e=e.map(function(i,n){return i=i.clone(),"operators"===i.type&&(","===i.value?0===r&&(i.value='+ ", " + '):";"===i.value?(i.value='+ " "',n<e.length-1?i.value+=" + ":t=""):"("===i.value?++r:")"===i.value&&--r),i});var n=p(e);return void 0===n&&(n=""),i(n+t),!0}function v(e){var t=parseFloat(p(e));for(V=-1;V<z.length-1&&z[V+1]<t;)++V;return!0}function g(e){var t,i=-1,r=-1;for(t=0;t<e.length;++t)"keywords"===e[t].type&&"THEN"===e[t].value?i=t:"keywords"===e[t].type&&"ELSE"===e[t].value&&(r=t);if(i===-1)u("Expected THEN clause.");else{var n=e.slice(0,i);for(t=0;t<n.length;++t){var o=n[t];"operators"===o.type&&"="===o.value&&(o.value="==")}var a,s;if(r===-1?a=e.slice(i+1):(a=e.slice(i+1,r),s=e.slice(r+1)),p(n))return h(a);if(s)return h(s)}return!0}function y(){return i("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),t(function(){U=!0,s&&s()}),!1}function x(e){return e.push(N),e.push(l(z[V])),k(e)}function b(e){var i=e.pop();return e.length>0&&m(e),t(function(e){e=e.toUpperCase();var t=null;t=isNaN(e)?c(e):l(e),p([i,N,t]),n&&n()}),!1}function _(e){var t=[],i=null,r=[];try{for(;e.length>0&&("keywords"!==e[0].type||"GOTO"!==e[0].value);)t.push(e.shift());if(e.length>0){e.shift();for(var n=0;n<e.length;++n){var o=e[n];"operators"===o.type&&","===o.value||r.push(o)}if(i=p(t)-1,0<=i&&i<r.length)return v([r[i]])}}catch(e){console.error(e)}return!0}function w(e){return q.push(l(z[V+1])),v(e)}function M(){return q.push(l(z[V])),!0}function E(e){var t=!0,i=q.pop();return i&&e&&(t=v([i])),t}function S(e){var t=!p(e);return E(t)}function T(e){for(J=V+1;J<z.length;++J){var t=d(J);if(t[0].value===e)return J}return z.length}function C(e){var t=p(e);return t?q.push(l(z[V])):V=T("WEND"),!0}function A(e){var t=z[V],i=[],r=[],n=[],o=[],a=[i,r,n,o],s=0,c=0;for(c=0;c<e.length;++c){var u=e[c];u.value===ie[s]?(0===s&&i.push(u),++s):a[s].push(u)}var d=1;o.length>0&&(d=p(o)),void 0===X[t]&&(X[t]=p(r));var f=p(n),m=X[t]<=f;return m?(i.push(l(X[t])),h(i),X[t]+=d,q.push(l(z[V]))):(delete X[t],V=T("NEXT")),!0}function P(){return E(!0)}function R(e){return a(p(e)).then(n),!1}function L(){return!0}function B(e){for(;e.length>0;){var t=e.shift();"operators"!==t.type&&W.push(t.value)}return!0}function O(e){if(0===W.length){var t=T("DATA");h(d(t))}var i=W[Y];return++Y,e.push(N),e.push(l(i)),k(e)}function I(){return Y=0,!0}function D(e){for(var t=e.shift().value,i="",r="",n=!0,o=0;o<e.length;++o){var a=e[o];"operators"===a.type&&"="===a.value?n=!1:n?i+=a.value:r+=a.value}t="FN"+t;var s="(function "+t+i+"{ return "+r+"; })";return K[t]=eval2(s),!0}function k(e){return p(e),!0}for(var F=this.tokenize(e),N=new Token("=","operators"),V=0,U=!1,G={},z=[],j=[],H=[j],W=[],q=[],X={},Y=0,K={INT:function(e){return 0|e},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(e){return e.length},LINE:function(){return z[V]},TAB:function(e){for(var t="",i=0;i<e;++i)t+=" ";return t},POW:function(e,t){return Math.pow(e,t)}},Q={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};F.length>0;){var Z=F.shift();"newlines"===Z.type?(j=[],H.push(j)):"regular"!==Z.type&&"comments"!==Z.type&&(Z.value=Q[Z.value]||Z.value,j.push(Z))}for(var J=0;J<H.length;++J){var $=H[J];if($.length>0){var ee=z[z.length-1],te=$.shift();if("lineNumbers"!==te.type&&($.unshift(te),void 0===ee&&(ee=-1),te=l(ee+1)),te=parseFloat(te.value),ee&&te<=ee)throw new Error("expected line number greater than "+ee+", but received "+te+".");$.length>0&&(z.push(te),G[te]=$)}}var ie=["=","TO","STEP"],re={DIM:f,LET:k,PRINT:m,GOTO:v,IF:g,INPUT:b,END:y,STOP:y,REM:L,"'":L,CLS:o,ON:_,GOSUB:w,RETURN:P,LOAD:R,DATA:B,READ:O,RESTORE:I,REPEAT:M,UNTIL:S,"DEF FN":D,WHILE:C,WEND:P,FOR:A,NEXT:P,LABEL:x};return function(){if(!U)for(var e=!0;e;){var t=d(V);e=h(t),++V}}};var HTML=new Grammar("HTML",[["newlines",/(?:\r\n|\r|\n)/],["startBlockComments",/(?:<|&lt;)!--/],["endBlockComments",/--(?:>|&gt;)/],["stringDelim",/("|')/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/(?:<|&lt;)\/?(html|base|head|link|meta|style|title|address|article|aside|footer|header|h1|h2|h3|h4|h5|h6|hgroup|nav|section|dd|div|dl|dt|figcaption|figure|hr|li|main|ol|p|pre|ul|a|abbr|b|bdi|bdo|br|cite|code|data|dfn|em|i|kbd|mark|q|rp|rt|rtc|ruby|s|samp|small|span|strong|sub|sup|time|u|var|wbr|area|audio|img|map|track|video|embed|object|param|source|canvas|noscript|script|del|ins|caption|col|colgroup|table|tbody|td|tfoot|th|thead|tr|button|datalist|fieldset|form|input|label|legend|meter|optgroup|option|output|progress|select|textarea|details|dialog|menu|menuitem|summary|content|element|shadow|template|acronym|applet|basefont|big|blink|center|command|content|dir|font|frame|frameset|isindex|keygen|listing|marquee|multicol|nextid|noembed|plaintext|spacer|strike|tt|xmp)\b/],["members",/(\w+)=/]]),TestResults=new Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]]),Grammars={Basic:Basic,Grammar:Grammar,HTML:HTML,JavaScript:JavaScript,PlainText:PlainText,TestResults:TestResults},OperatingSystems={Linux:Windows,macOS:macOS,OperatingSystem:OperatingSystem,Windows:Windows},Terminal=function e(t,i){function r(e){e.selectionStart=e.selectionEnd=e.value.length,e.scrollIntoView(e.frontCursor)}function n(){g.running&&(a(),g.running=!1,v&&(t.tokenizer=u,t.value=h),r(t))}function o(){return i.selectionStart=i.selectionEnd=0,i.value="",!0}function a(){if(m.length>0){for(var e=m.split("\n"),t=0;t<p&&e.length>0;++t)f.push(e.shift());e.length>0&&f.push(" ----- more -----"),m=e.join("\n")}}function s(e){c=e,g.waitingForInput=!0,a()}function l(e){m+=e}classCallCheck(this,e),i=i||t;var c=null,h=null,u=null,d=0,p=40,f=[],m="",v=t===i,g=this;this.running=!1,this.waitingForInput=!1,this.sendInput=function(e){if(m.length>0)a();else{i.keyDown(e);var t=i.value.substring(d);c(t.trim()),c=null,this.waitingForInput=!1}},this.execute=function(){if(p=10,u=t.tokenizer,u&&u.interpret){this.running=!0;var e,r=function(){g.running&&setTimeout(e,1)};h=t.value,e=u.interpret(h,s,l,l,r,o,this.loadFile.bind(this),n),i.tokenizer=PlainText,o(),r()}},this.loadFile=function(e){return getText(e.toLowerCase()).then(function(e){return isMacOS&&(e=e.replace("CTRL+SHIFT+SPACE","CMD+OPT+E")),t.value=h=e,e})},this.update=function(){f.length>0&&(i.value+=f.shift()+"\n",r(i),d=i.selectionStart)}},Dark={name:"Dark",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"white",fontSize:16,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}},Themes={Dark:Dark,Default:Default},Text={CodePages:CodePages,CommandPacks:CommandPacks,Cursor:Cursor,Grammars:Grammars,OperatingSystems:OperatingSystems,Point:Point,Rectangle:Rectangle,Rule:Rule,Size:Size,Terminal:Terminal,Themes:Themes,Token:Token},Tools={Teleporter:Teleporter},index$5={Audio:Audio$2,BrowserEnvironment:BrowserEnvironment,Constants:Constants,Controls:Controls,Displays:Displays,DOM:DOM,Graphics:Graphics,HTTP:HTTP,Input:Input,Keys:Keys,Network:Network,Pointer:Pointer,Physics:Physics,Random:Random,Replay:Replay,Text:Text,Tools:Tools};Object.assign(window,flags,liveAPI,util);export default index$5;
