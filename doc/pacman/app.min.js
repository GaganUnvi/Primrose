!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(this,function(){"use strict";function e(e){var n=t.toString(),o=e&&n||getSetting(l,n);if(o===n){var i=o.replace("\r\n","\n").split("\n");i.pop(),i.shift();for(var r=0;r<i.length;++r)i[r]=i[r].substring(2);o=i.join("\n")}return o.trim()}function t(){function e(e,t,n){0!==e&&put(colored(cylinder(.5,.5,r),255)).on(scene).rot(0,e*Math.PI/2,Math.PI/2).at(r*t-l/2,a.avatarHeight,r*n-c/2)}function t(e,t,n){var o=Math.floor((t.position.x+l/2+1)/r),i=Math.floor((t.position.z+c/2+1)/r),a=d[i],s=a&&0|a[o],u=t.velocity.clone().multiplyScalar(1.5*-e);s>0&&((n||t.isOnGround)&&t.position.add(u),n&&t.velocity.set(t.velocity.z,0,-t.velocity.x))}for(var n,o=Primrose.Random.int,i=Primrose.Graphics.ModelLoader.loadObject,r=3,l=30,c=30,s=[16711680,16776960,16711935,65535],d=["12222222221","10000000001","10222022201","10001000001","10101022201","10100010101","10222220101","10000000001","12222222221"],u=0;u<d.length;++u)for(var f=d[u],p=0;p<f.length;++p)e(0|f[p],p,u);return console.log("Here we go"),i("../models/ghost.obj").then(function(e){console.log("ghost",e),n=s.map(function(t,n){var i=e.clone(),r=i.children[0];return colored(r,t),scene.appendChild(i),i.position.set(3*n-4,0,-5),i.velocity=v3(0,0,0),i.velocity.x=o(-1,2),0===i.velocity.x&&0===i.velocity.z&&(i.velocity.z=o(-1,2)),i})}),function(e){n&&n.forEach(function(n){n.position.add(n.velocity.clone().multiplyScalar(e)),t(e,n,a.input.head)}),t(e,a.input.head,null)}}function n(){for(var e=v.children.length-1;e>=0;--e)v.remove(v.children[e])}function o(){var e=c.value;if(e!==p){i=null,p=e,e.indexOf("function update")>=0&&e.indexOf("return update")<0&&(e+="\nreturn update;");try{console.log("----- loading new script -----");var t=new Function("scene",e);n(),y=t.call(a,v),y&&y(0),console.log("----- script loaded -----"),y?a.quality===Primrose.Quality.NONE&&(a.quality=Primrose.Quality.MEDIUM):console.log("----- No update script provided -----")}catch(e){throw console.error(e),y=null,e}}}var i,r="../images/deck.png",l="Pacman code",a=new Primrose.BrowserEnvironment({quality:Primrose.Quality.HIGH,backgroundColor:0,skyTexture:r,groundTexture:r,font:"../fonts/helvetiker_regular.typeface.json"}),c=null,s=null,d=null,u=isMacOS?"metaKey":"ctrlKey",f=isMacOS?"altKey":"shiftKey",p=(isMacOS?"CMD":"CTRL",isMacOS?"OPT":"SHIFT",null),y=null,v=hub(),h=hub();a.addEventListener("ready",function(){a.appendChild(h),a.appendChild(v);var t=isMobile?512:1024,n=40/a.quality;s=a.createElement("section"),s.id="EditorFrame",s.className="shell",s.style.width=t,s.style.height=t,c=a.createElement("textarea"),c.id="Editor",c.style.width=s.surfaceWidth,c.style.height=s.surfaceHeight,c.style.fontSize=n,c.tokenizer=Primrose.Text.Grammars.JavaScript,c.value=e(isInIFrame),s.appendChild(c),d=h.appendChild(s),d.name="EditorFrameMesh",d.position.set(0,a.avatarHeight,0),d.visible=!1,d.disabled=!0},!1),window.addEventListener("beforeunload",function(e){},!1),window.addEventListener("unload",function(e){var t=c.value;t.length>0&&setSetting(l,t)},!1),a.addEventListener("update",function(e){if(i||(i=setTimeout(o,500)),y)if(a.quality===Primrose.Quality.NONE)y=null,n();else try{y.call(a,e)}catch(e){console.error(e),y=null}}),window.addEventListener("keydown",function(t){t[u]&&t[f]&&(t.keyCode===Primrose.Keys.E?(d.visible&&a.currentControl&&a.currentControl.focused&&(a.currentControl.blur(),a.currentControl=null),d.visible=!d.visible,d.disabled=!d.disabled):t.keyCode===Primrose.Keys.E&&c?Primrose.HTTP.postObject("saveScript",{"Content-Type":"application/json",data:{fileName:"pacman",content:c.value}}):t.keyCode===Primrose.Keys.X&&(c.value=e(!0))),i&&(clearTimeout(i),i=null)})});