"use strict";function documentReady(){return new Promise(function(e,n){function t(){var n="complete"===document.readyState;return n&&(document.removeEventListener("readystatechange",t),e()),n}t()||document.addEventListener("readystatechange",t)})}function noop(){}function immutable(e){return{get:function(){return e}}}function StandardMonitor(e){function n(e){if("left"===e){var n=this.DOMElement&&this.DOMElement.offsetWidth||screen.width,t=this.DOMElement&&this.DOMElement.offsetHeight||screen.height,r=n/t,i=25,o=i*r;return{renderWidth:n*devicePixelRatio,renderHeight:t*devicePixelRatio,offset:new Float32Array([0,0,0]),fieldOfView:{upDegrees:i,downDegrees:i,leftDegrees:o,rightDegrees:o}}}}function t(){return{position:[0,0,0],orientation:[0,0,0,1],linearVelocity:null,linearAcceleration:null,angularVelocity:null,angularAcceleration:null}}var r=.01,i=1e4,o={};currentLayers=[],fireDisplayPresentChange=function(e){this.isPresenting||FullScreen.removeChangeListener(fireDisplayPresentChange),window.dispatchEvent(new Event("vrdisplaypresentchange"))}.bind(this),Object.defineProperties(o,{hasPosition:immutable(!1),hasOrientation:immutable(isMobile),hasExternalDisplay:immutable(!1),canPresent:immutable(!0),maxLayers:immutable(1)}),Object.defineProperties(this,{displayId:immutable(e&&e.displayId||"N/A"),displayName:immutable(isMobile&&"Magic Window"||"Standard Monitor"),isConnected:immutable(!e||e.isConnected),stageParameters:immutable(e&&e.stageParameters||null),resetPose:immutable(e&&e.resetPose.bind(e)||noop),isPolyfilled:immutable(e&&e.isPolyfilled),depthNear:{get:function(){return e?e.depthNear:r},set:function(n){e?e.depthNear=n:r=n}},depthFar:{get:function(){return e?e.depthFar:i},set:function(n){e?e.depthFar=n:i=n}},capabilities:immutable(o),requestAnimationFrame:immutable(window.requestAnimationFrame.bind(window)),cancelAnimationFrame:immutable(window.cancelAnimationFrame.bind(window)),submitFrame:immutable(noop),requestPresent:immutable(function(e){for(var n=0;n<e.length&&n<1;++n)currentLayers[n]=e[n];FullScreen.addChangeListener(fireDisplayPresentChange);var t=FullScreen.request(e[0].source);return isMobile&&(t=t.then(Orientation.lock)),t}),isPresenting:{get:function(){return e&&e.isPresenting||!e&&FullScreen.isActive}},getLayers:immutable(function(){return currentLayers}),exitPresent:immutable(function(){currentLayers.splice(0);var e=FullScreen.exit();return isMobile&&(e=e.then(Orientation.unlock)),e}),getEyeParameters:immutable(n),getPose:immutable(isMobile&&e&&e.getPose.bind(e)||t),getImmediatePose:immutable(isMobile&&e&&e.getImmediatePose.bind(e)||t)})}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}window.isChrome=!!window.chrome&&!window.opera&&navigator.userAgent.indexOf(" OPR/")===-1,window.isMobile=window.isMobile||function(e){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substring(0,4))}(navigator.userAgent||navigator.vendor||window.opera);var AsyncLockRequest=function(){function e(e,n){for(var t=0;t<n.length;++t)if(void 0!==e[n[t]])return n[t]}return function(n,t,r,i,o,a,s){var c=e(document,t),l=e(document,r),u=e(document,i),m=e(document.documentElement,o),d=e(document,a),f=null;l=l&&l.substring(2),u=u&&u.substring(2);var p={addChangeListener:function(e,n){return document.addEventListener(l,e,n)},removeChangeListener:function(e){return document.removeEventListener(l,e)},addErrorListener:function(e,n){return document.addEventListener(u,e,n)},removeErrorListener:function(e){return document.removeEventListener(u,e)},withChange:function(e){return new Promise(function(t,r){var i=function(){setTimeout(s),t(p.element)},o=function(e){setTimeout(s),r(e)},a=function(){f&&(clearTimeout(f),f=null)},s=function(){a(),p.removeChangeListener(i),p.removeErrorListener(o)};p.addChangeListener(i,!1),p.addErrorListener(o,!1),e()?(s(),t(p.element)):(a(),f=setTimeout(function(){s(),r(n+" state did not change in allotted time")},1e3))})},request:function(e,t){return s&&(t=s(t)),p.withChange(function(){if(!m)throw new Error("No "+n+" API support.");return!!p.isActive||void(t?e[m](t):isChrome?e[m](window.Element.ALLOW_KEYBOARD_INPUT):e[m]())})},exit:function(){return p.withChange(function(){if(!d)throw new Error("No Fullscreen API support.");return!p.isActive||void document[d]()})}};return Object.defineProperties(p,{element:{get:function(){return document[c]}},isActive:{get:function(){return!!document[c]}}}),p}}(),FullScreen=AsyncLockRequest("Fullscreen",["fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement"],["onfullscreenchange","onmozfullscreenchange","onwebkitfullscreenchange","onmsfullscreenchange"],["onfullscreenerror","onmozfullscreenerror","onwebkitfullscreenerror","onmsfullscreenerror"],["requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","webkitRequestFullScreen","msRequestFullscreen"],["exitFullscreen","mozExitFullScreen","webkitExitFullscreen","webkitExitFullScreen","msExitFullscreen"],function(e){return e||isChrome&&window.Element.ALLOW_KEYBOARD_INPUT||void 0}),loadFiles=function(){function e(e,n,t){var r=new XMLHttpRequest;r.onload=function(){n(r.status<400?r.response:new Error(r.status))},r.open("GET",e),r.onprogress=t,r.send()}function n(t,r,i,o,a,s){if(o<t.length){var c=t[o][0],l=(t[o][1],c.match(/\.\w+$/)[0]||"none"),u=c.match(/(\.\w+)+$/)[0]||"none",m=s;e(c,function(e){if(e instanceof Error)console.error("Failed to load "+c+": "+e.message);else if(".js"===l&&".typeface.js"!==u){var m=document.createElement("script");m.type="text/javascript",m.src=c,m.defer=!1,m.async=!1,document.head.appendChild(m)}n(t,r,i,o+1,a,s)},function(e){return i(s=m+e.loaded,a)})}else r()}function t(t,r,i){function o(e){for(var t=0,o=0;o<e.length;++o)t+=e[o][1];r=r||console.log.bind(console,"File load progress"),n(e,i,r,0,t,0)}t instanceof String||"string"==typeof t?e(t,function(e){o(JSON.parse(e))}):t instanceof Array&&o(t)}return function(e,n){return new Promise(function(r,i){return t(e,n,r)})}}(),Orientation=function(){function e(){var e=screen.orientation&&screen.orientation.type||screen.mozOrientation||"";if(e.indexOf("landscape")===-1&&(e="landscape-primary"),screen.orientation&&screen.orientation.lock)return screen.orientation.lock(e);if(!screen.mozLockOrientation)return Promise.reject();var n=screen.mozLockOrientation(e);return n?Promise.resolve():void 0}function n(){screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.mozUnlockOrientation&&screen.mozUnlockOrientation()}return{lock:e,unlock:n}}(),PointerLock=AsyncLockRequest("Pointer Lock",["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"],["onpointerlockchange","onmozpointerlockchange","onwebkitpointerlockchange"],["onpointerlockerror","onmozpointerlockerror","onwebkitpointerlockerror"],["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock","webkitRequestPointerLock"],["exitPointerLock","mozExitPointerLock","webkitExitPointerLock","webkitExitPointerLock"]),_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),ViewCameraTransform=function(){function e(n){_classCallCheck(this,e),this._display=n}return _createClass(e,null,[{key:"makeTransform",value:function(n,t,r){return{translation:(new THREE.Vector3).fromArray(n.offset),projection:e.fieldOfViewToProjectionMatrix(n.fieldOfView,t,r),viewport:{left:0,top:0,width:n.renderWidth,height:n.renderHeight}}}},{key:"fieldOfViewToProjectionMatrix",value:function(e,n,t){var r=Math.tan(e.upDegrees*Math.PI/180),i=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),s=2/(o+a),c=2/(r+i),l=new THREE.Matrix4;return l.elements[0]=s,l.elements[1]=0,l.elements[2]=0,l.elements[3]=0,l.elements[4]=0,l.elements[5]=c,l.elements[6]=0,l.elements[7]=0,l.elements[8]=-((o-a)*s*.5),l.elements[9]=(r-i)*c*.5,l.elements[10]=-(n+t)/(t-n),l.elements[11]=-1,l.elements[12]=0,l.elements[13]=0,l.elements[14]=-(2*t*n)/(t-n),l.elements[15]=0,l}}]),_createClass(e,[{key:"getTransforms",value:function(n,t){var r=this._display.getEyeParameters("left"),i=this._display.getEyeParameters("right"),o=[e.makeTransform(r,n,t)];i&&o.push(e.makeTransform(i,n,t));for(var a=1;a<o.length;++a)o[a].viewport.left=o[a-1].viewport.left+o[a-1].viewport.width;return o}}]),e}(),WebVRBootstrapper=function(){function e(e){return wrapWebVR(),documentReady().then(function(){return function(n){return e&&loadFiles(e,n)}})}return e}(),wrapWebVR=function(){var e=navigator.getVRDisplays||Promise.resolve.bind(Promise,[]);navigator.getVRDisplays=function(){return e.call(navigator).then(function(e){var n=e.map(function(e){return e instanceof StandardMonitor}).reduce(function(e,n){return e||n},!1);if(!n){for(var t=!1,r=0;r<e.length;++r){var i=e[r],o=i instanceof StandardMonitor;o||"Mouse and Keyboard VRDisplay (webvr-polyfill)"!==i.displayName||(t=!0,e[r]=new StandardMonitor(i))}t||e.unshift(new StandardMonitor(e[0]))}return e})}};