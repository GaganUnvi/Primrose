function getSourceCode(e){var t=pacman.toString(),r=e&&t||getSetting(CODE_KEY,t);if(r===t){var i=r.replace("\r\n","\n").split("\n");i.pop(),i.shift();for(var n=0;n<i.length;++n)i[n]=i[n].substring(2);r=i.join("\n")}return r.trim()}function wipeScene(){for(var e=subScene.children.length-1;e>=0;--e)subScene.remove(subScene.children[e])}function updateScript(){var e=editor.value;if(e!==lastScript){scriptUpdateTimeout=null,lastScript=e,e.indexOf("function update")>=0&&e.indexOf("return update")<0&&(e+="\nreturn update;");try{console.log("----- loading new script -----");var t=new Function("scene",e);wipeScene(),scriptAnimate=t.call(env,subScene),scriptAnimate&&scriptAnimate(0),console.log("----- script loaded -----"),scriptAnimate?env.quality===Primrose.Constants.Quality.NONE&&(env.quality=Primrose.Constants.Quality.MEDIUM):console.log("----- No update script provided -----")}catch(e){throw console.error(e),scriptAnimate=null,e}}}function clrscr(){if(output){var e=output;e.value="",e.selectionStart=e.selectionEnd=e.value.length,e.scrollIntoView(e.frontCursor)}}function pacman(){function e(e,t,r){0!==e&&put(colored(cylinder(.5,.5,o),255)).on(scene).rot(0,e*Math.PI/2,Math.PI/2).at(o*t-a/2,env.options.avatarHeight,o*r-l/2)}function t(e,t,r){var i=Math.floor((t.position.x+a/2+1)/o),n=Math.floor((t.position.z+l/2+1)/o),s=d[n],c=s&&0|s[i],u=t.velocity.clone().multiplyScalar(1.5*-e);c>0&&((r||t.isOnGround)&&t.position.add(u),r&&t.velocity.set(t.velocity.z,0,-t.velocity.x))}for(var r,i=Primrose.Random.int,n=Primrose.Graphics.ModelLoader.loadObject,o=3,a=30,l=30,s=[16711680,16776960,16711935,65535],d=["12222222221","10000000001","10222022201","10001000001","10101022201","10100010101","10222220101","10000000001","12222222221"],c=0;c<d.length;++c)for(var u=d[c],p=0;p<u.length;++p)e(0|u[p],p,c);return console.log("Here we go"),n("../models/ghost.obj").then(function(e){console.log("ghost",e),r=s.map(function(t,r){var n=e.clone(),o=n.children[0];return colored(o,t),scene.appendChild(n),n.position.set(3*r-4,0,-5),n.velocity=v3(0,0,0),n.velocity.x=i(-1,2),0===n.velocity.x&&0===n.velocity.z&&(n.velocity.z=i(-1,2)),n})}),function(e){r&&r.forEach(function(r){r.position.add(r.velocity.clone().multiplyScalar(e)),t(e,r,env.input.head)}),t(e,env.input.head,null)}}var GRASS="../images/grass.png",ROCK="../images/rock.png",SAND="../images/sand.png",WATER="../images/water.png",DECK="../images/deck.png",CODE_KEY="Pacman code",env=new Primrose.BrowserEnvironment({backgroundColor:0,skyTexture:DECK,groundTexture:DECK,font:"../fonts/helvetiker_regular.typeface.json",fullScreenButtonContainer:"#fullScreenButtonContainer",progress:Preloader.thunk}),editor=null,output=null,editorFrame=null,editorFrameMesh=null,modA=isMacOS?"metaKey":"ctrlKey",modB=isMacOS?"altKey":"shiftKey",cmdA=isMacOS?"CMD":"CTRL",cmdB=isMacOS?"OPT":"SHIFT",cmdPre=cmdA+"+"+cmdB,scriptUpdateTimeout,lastScript=null,scriptAnimate=null,subScene=hub(),editorCenter=hub();env.addEventListener("ready",function(){env.appendChild(editorCenter),env.appendChild(subScene);var e=isMobile?512:1024,t=40/env.quality;editorFrame=env.createElement("section"),editorFrame.id="EditorFrame",editorFrame.className="shell",editorFrame.style.width=e,editorFrame.style.height=e,editor=env.createElement("textarea"),editor.id="Editor",editor.style.width=editorFrame.surfaceWidth,editor.style.height=editorFrame.surfaceHeight,editor.style.fontSize=t,editor.tokenizer=Primrose.Text.Grammars.JavaScript,editor.value=getSourceCode(isInIFrame),editorFrame.appendChild(editor),editorFrameMesh=editorCenter.appendChild(editorFrame),editorFrameMesh.name="EditorFrameMesh",editorFrameMesh.position.set(0,env.options.avatarHeight,0),editorFrameMesh.visible=!1,editorFrameMesh.disabled=!0,Preloader.hide()},!1),window.addEventListener("beforeunload",function(e){},!1),window.addEventListener("unload",function(e){var t=editor&&editor.value;t&&t.length>0&&setSetting(CODE_KEY,t)},!1),env.addEventListener("update",function(e){if(scriptUpdateTimeout||(scriptUpdateTimeout=setTimeout(updateScript,500)),scriptAnimate)if(env.quality===Primrose.Constants.Quality.NONE)scriptAnimate=null,wipeScene();else try{scriptAnimate.call(env,e)}catch(e){console.error(e),scriptAnimate=null}}),window.addEventListener("keydown",function(e){e[modA]&&e[modB]&&(e.keyCode===Primrose.Keys.E?(editorFrameMesh.visible&&env.currentControl&&env.currentControl.focused&&(env.currentControl.blur(),env.currentControl=null),editorFrameMesh.visible=!editorFrameMesh.visible,editorFrameMesh.disabled=!editorFrameMesh.disabled):e.keyCode===Primrose.Keys.E&&editor?Primrose.HTTP.postObject("saveScript",{"Content-Type":"application/json",data:{fileName:"pacman",content:editor.value}}):e.keyCode===Primrose.Keys.X&&(editor.value=getSourceCode(!0))),scriptUpdateTimeout&&(clearTimeout(scriptUpdateTimeout),scriptUpdateTimeout=null)});