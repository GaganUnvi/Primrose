function wipeScene(){for(var e=subScene.children.length-1;e>=0;--e)subScene.remove(subScene.children[e])}function updateScript(){var e=editor.value;e!==lastScript&&(env.transition(function(){scriptUpdateTimeout=null,lastScript=e,e.indexOf("function update")>=0&&e.indexOf("return update")<0&&(e+="\nreturn update;"),console.log("----- loading new script -----"),scriptAnimate=null;try{var t=new Function("scene",e);wipeScene(),scriptAnimate=t.call(env,subScene),scriptAnimate&&scriptAnimate(0),console.log("----- script loaded -----"),scriptAnimate?env.quality===Primrose.Constants.Quality.NONE&&(env.quality=Primrose.Constants.Quality.MEDIUM):console.log("----- No update script provided -----")}catch(t){console.error(t),console.error(e)}},null,first),first=!1)}function getSourceCode(e){var t=testDemo.toString(),r=e&&t||getSetting("code",t);if(r===t){var n=r.replace("\r\n","\n").split("\n");n.pop(),n.shift();for(var i=0;i<n.length;++i)n[i]=n[i].substring(2);r=n.join("\n")}return r.trim()}function testDemo(e){for(var t="../images/deck.png",r=5,n=5,i=5,o=r/2-5,a=put(hub()).on(e).at(-o,0,-i-2).obj(),s=[],d=0;d<10;++d)s.push(put(brick(t)).on(a).at(number(r),number(n),number(i)).obj()),s[d].velocity=v3(number(r),number(n),number(i))}Object.assign(window,Primrose.Random);var GRASS="../images/grass.png",ROCK="../images/rock.png",SAND="../images/sand.png",WATER="../images/water.png",DECK="../images/deck.png";window.env=new Primrose.BrowserEnvironment({skyTexture:"../images/bg2.jpg",groundTexture:GRASS,font:"../fonts/helvetiker_regular.typeface.json",fullScreenButtonContainer:"#fullScreenButtonContainer",progress:Preloader.thunk});var subScene=null,editor=null,editorFrame=null,editorFrameMesh=null,modA=isMacOS?"metaKey":"ctrlKey",modB=isMacOS?"altKey":"shiftKey",cmdA=isMacOS?"CMD":"CTRL",cmdB=isMacOS?"OPT":"SHIFT",cmdPre=cmdA+"+"+cmdB,scriptUpdateTimeout,lastScript=null,scriptAnimate=null;env.addEventListener("ready",function(){subScene=hub(),env.scene.add(subScene);var e=isMobile?512:1024,t=isMobile?10:20;editorFrame=env.createElement("section"),editorFrame.id="EditorFrame",editorFrame.className="shell",editorFrame.style.width=e,editorFrame.style.height=e,editor=env.createElement("textarea"),editor.id="Editor",editor.style.width=editorFrame.surfaceWidth,editor.style.height=editorFrame.surfaceHeight,editor.style.fontSize=t,editor.tokenizer=Primrose.Text.Grammars.JavaScript,editor.value=getSourceCode(isInIFrame),editorFrame.appendChild(editor),editorFrameMesh=env.appendChild(editorFrame),editorFrameMesh.name="MyWindow",editorFrameMesh.position.set(0,env.options.avatarHeight,0),console.log("INSTRUCTIONS:"),console.log(" - "+cmdPre+"+E to show/hide editor"),console.log(" - "+cmdPre+"+X to reload original demo code"),console.log(" - Z to reset position/sensor"),console.log(),Preloader.hide()}),env.addEventListener("update",function(e){scriptUpdateTimeout||(scriptUpdateTimeout=setTimeout(updateScript,500)),scriptAnimate&&(env.quality===Primrose.Constants.Quality.NONE?(scriptAnimate=null,wipeScene()):scriptAnimate.call(env,e))}),env.addEventListener("keydown",function(e){e[modA]&&e[modB]&&(e.keyCode===Primrose.Keys.E?(editorFrameMesh.visible=!editorFrameMesh.visible,!editorFrameMesh.visible&&env.currentControl&&env.currentControl.focused&&(env.currentControl.blur(),env.currentControl=null)):e.keyCode===Primrose.Keys.X&&(editor.value=getSourceCode(!0))),scriptUpdateTimeout&&(clearTimeout(scriptUpdateTimeout),scriptUpdateTimeout=null)}),window.addEventListener("beforeunload",function(e){return e.returnValue="Are you sure you want to leave?"},!1),window.addEventListener("unload",function(){if(console.log("unloading, going to try to save file?",!!editor),editor){var e=editor.value;e.length>0&&setSetting("code",e)}});var first=!0;