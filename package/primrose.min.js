const combiningMarks=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,surrogatePair=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;function reverse(e){let t="";for(let n=(e=e.replace(combiningMarks,(function(e,t,n){return reverse(n)+t})).replace(surrogatePair,"$2$1")).length-1;n>=0;--n)t+=e[n];return t}class Cursor{static min(e,t){return e.i<=t.i?e:t}static max(e,t){return e.i>t.i?e:t}constructor(e,t,n){this.i=e||0,this.x=t||0,this.y=n||0,this.moved=!0,Object.seal(this)}clone(){return new Cursor(this.i,this.x,this.y)}toString(){return"[i:"+this.i+" x:"+this.x+" y:"+this.y+"]"}copy(e){this.i=e.i,this.x=e.x,this.y=e.y,this.moved=!1}fullHome(){this.i=0,this.x=0,this.y=0,this.moved=!0}fullEnd(e){this.i=0;let t=0;for(let n=0;n<e.length;++n){t=e[n].length,this.i+=t}this.y=e.length-1,this.x=t,this.moved=!0}left(e,t=!1){if(this.i>0)if(--this.i,--this.x,this.x<0){--this.y;const t=e[this.y];this.x=t.length-1}else t||e[this.y].adjust(this,-1);this.moved=!0}skipLeft(e){if(this.x<=1)this.left(e);else{const t=this.x-1,n=reverse(e[this.y].substring(0,t)).match(/\w+/),i=n?n.index+n[0].length+1:this.x;this.i-=i,this.x-=i,e[this.y].adjust(this,-1)}this.moved=!0}right(e,t=!1){const n=e[this.y];(this.y<e.length-1||this.x<n.length)&&(++this.i,++this.x,this.y<e.length-1&&this.x===n.length?(this.x=0,++this.y):t||e[this.y].adjust(this,1))}skipRight(e){const t=e[this.y];if(this.x<t.length-1){const n=this.x+1,i=t.substring(n).match(/\w+/),o=i?i.index+i[0].length+1:t.length-this.x;this.i+=o,this.x+=o,this.x>0&&this.x===t.length&&this.y<e.length-1&&(--this.x,--this.i),e[this.y].adjust(this,1)}else this.y<e.length-1&&this.right(e);this.moved=!0}home(){this.i-=this.x,this.x=0,this.moved=!0}end(e){let t=e[this.y].length-this.x;this.y<e.length-1&&--t,this.i+=t,this.x+=t,this.moved=!0}up(e,t=!1){if(this.y>0){--this.y;const n=e[this.y],i=Math.min(0,n.length-this.x-1);this.x+=i,this.i-=n.length-i,t||e[this.y].adjust(this,1)}this.moved=!0}down(e,t=!1){if(this.y<e.length-1){const n=e[this.y];++this.y,this.i+=n.length;const i=e[this.y];if(this.x>=i.length){let t=this.x-i.length;this.y<e.length-1&&++t,this.i-=t,this.x-=t}t||e[this.y].adjust(this,1)}this.moved=!0}incX(e,t){const n=Math.sign(t);if(t=Math.abs(t),-1===n){for(let n=0;n<t;++n)this.left(e,!0);e[this.y].adjust(this,-1)}else if(1===n){for(let n=0;n<t;++n)this.right(e,!0);e[this.y].adjust(this,1)}}incY(e,t){const n=Math.sign(t);if(t=Math.abs(t),-1===n)for(let n=0;n<t;++n)this.up(e,!0);else if(1===n)for(let n=0;n<t;++n)this.down(e,!0);e[this.y].adjust(this,1)}setXY(e,t,n){t=Math.floor(t),n=Math.floor(n),this.y=Math.max(0,Math.min(e.length-1,n));const i=e[this.y];this.x=Math.max(0,Math.min(i.length,t)),this.i=this.x;for(let t=0;t<this.y;++t)this.i+=e[t].length;this.x>0&&this.x===i.length&&this.y<e.length-1&&(--this.x,--this.i),e[this.y].adjust(this,1),this.moved=!0}setI(e,t){this.x=this.i=t,this.y=0;let n=0,i=e[this.y];for(;this.x>i.length;){if(this.x-=i.length,n+=i.length,this.y>=e.length-1){this.i=n,this.x=i.length,this.moved=!0;break}++this.y,i=e[this.y]}e[this.y].adjust(this,1),this.moved=!0}}const monospaceFamily="'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace";class Line{constructor(e){this.length=e.length;const t=Object.freeze([...e]),n=new Array(e.length),i=new Array(e.length);let o=0;for(let e of t){n[o]=0,i[o]=0;for(let t=1;t<e.length;++t)n[o+t]=-t,i[o+t]=e.length-t;o+=e.length}this.adjust=(e,t)=>{const o=(-1===t?n:i)[e.x];e.x+=o,e.i+=o},this.toString=()=>e,this.substring=(t,n)=>e.substring(t,n),Object.freeze(this)}}const Dark=Object.freeze({name:"Dark",cursorColor:"white",lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}),Light=Object.freeze({name:"Light",cursorColor:"black",lineNumbers:{foreColor:"black"},regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}),themes=Object.freeze(new Map([["light",Light],["dark",Dark]]));class TimedEvent extends EventTarget{constructor(e,t=!1){super();const n=new Event("tick");let i=null;this.cancel=()=>{const e=this.isRunning;return e&&(t?clearInterval(i):clearTimeout(i),i=null),e};const o=()=>{t||this.cancel(),this.dispatchEvent(n)};this.start=()=>{this.cancel(),i=t?setTimeout(o,e):setInterval(o,e)},Object.defineProperties(this,{isRunning:{get:()=>null!==i}}),Object.freeze(this)}}function assignAttributes(e,...t){t.filter(e=>!(e instanceof Element||e instanceof String||"string"==typeof e)).forEach(t=>{for(let n in t){const i=t[n];if("style"===n)for(let t in i)e[n][t]=i[t];else"textContent"===n||"innerText"===n?e.appendChild(document.createTextNode(i)):n.startsWith("on")&&"function"==typeof i?e.addEventListener(n.substring(2),i):("boolean"==typeof i||i instanceof Boolean)&&"muted"!==n?i?e.setAttribute(n,""):e.removeAttribute(n):e[n]=i}})}function tag(e,...t){const n=document.createElement(e);assignAttributes(n,...t);const i=t.filter(e=>e instanceof String||"string"==typeof e).reduce((e,t)=>e+"\n"+t,"").trim();return i.length>0&&n.appendChild(document.createTextNode(i)),t.filter(e=>e instanceof Element).forEach(n.appendChild.bind(n)),n}function br(){return tag("br")}function canvas(...e){return tag("canvas",...e)}function div(...e){return tag("div",...e)}function span(...e){return tag("span",...e)}function text(e){return document.createTextNode(e)}function isCanvas(e){return e instanceof HTMLCanvasElement||!!(window.OffscreenCanvas&&e instanceof OffscreenCanvas)}function offscreenCanvas(e){const t=e&&e.width||512,n=e&&e.height||t;return e instanceof Object&&Object.assign(e,{width:t,height:n}),window.OffscreenCanvas?new OffscreenCanvas(t,n):canvas(e)}function setCanvasSize(e,t,n,i=1){return t=Math.floor(t*i),n=Math.floor(n*i),(e.width!=t||e.height!=n)&&(e.width=t,e.height=n,!0)}function setContextSize(e,t,n,i=1){const o=e.imageSmoothingEnabled,r=e.textBaseline,s=e.textAlign,a=e.font,l=setCanvasSize(e.canvas,t,n,i);return l&&(e.imageSmoothingEnabled=o,e.textBaseline=r,e.textAlign=s,e.font=a),l}function resizeContext(e,t=1){return setContextSize(e,e.canvas.clientWidth,e.canvas.clientHeight,t)}const isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox=void 0!==window.InstallTrigger,isiOS=/iP(hone|od|ad)/.test(navigator.userAgent||""),isMacOS=/Macintosh/.test(navigator.userAgent||""),isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;function testUserAgent(e){return/(android|bb\d+|meego).+|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substring(0,4))}const isMobile=testUserAgent(navigator.userAgent||navigator.vendor||window.opera);class Point{constructor(e,t){this.set(e||0,t||0),Object.seal(this)}set(e,t){this.x=e,this.y=t}copy(e){e&&(this.x=e.x,this.y=e.y)}toCell(e,t,n){this.x=Math.round(this.x/e.width)+t.x-n.x,this.y=Math.floor(this.y/e.height-.25)+t.y}inBounds(e){return e.left<=this.x&&this.x<e.right&&e.top<=this.y&&this.y<e.bottom}clone(){return new Point(this.x,this.y)}toString(){return"(x:"+this.x+", y:"+this.y+")"}}class Size{constructor(e,t){this.width=e||0,this.height=t||0,Object.seal(this)}set(e,t){this.width=e,this.height=t}copy(e){e&&(this.width=e.width,this.height=e.height)}clone(){return new Size(this.width,this.height)}toString(){return"<w:"+this.width+", h:"+this.height+">"}}class Rectangle{constructor(e,t,n,i){this.point=new Point(e,t),this.size=new Size(n,i),Object.freeze(this)}get x(){return this.point.x}set x(e){this.point.x=e}get left(){return this.point.x}set left(e){this.point.x=e}get width(){return this.size.width}set width(e){this.size.width=e}get right(){return this.point.x+this.size.width}set right(e){this.point.x=e-this.size.width}get y(){return this.point.y}set y(e){this.point.y=e}get top(){return this.point.y}set top(e){this.point.y=e}get height(){return this.size.height}set height(e){this.size.height=e}get bottom(){return this.point.y+this.size.height}set bottom(e){this.point.y=e-this.size.height}get area(){return this.width*this.height}set(e,t,n,i){this.point.set(e,t),this.size.set(n,i)}copy(e){e&&(this.point.copy(e.point),this.size.copy(e.size))}clone(){return new Rectangle(this.point.x,this.point.y,this.size.width,this.size.height)}overlap(e){const t=Math.max(this.left,e.left),n=Math.max(this.top,e.top),i=Math.min(this.right,e.right),o=Math.min(this.bottom,e.bottom);if(i>t&&o>n)return new Rectangle(t,n,i-t,o-n)}toString(){return`[${this.point.toString()} x ${this.size.toString()}]`}}const keyGroups=Object.freeze(new Map([["special",["Unidentified"]],["modifier",["Alt","AltGraph","CapsLock","Control","Fn","FnLock","Hyper","Meta","NumLock","ScrollLock","Shift","Super","Symbol","SymbolLock"]],["whitespace",["Enter","Tab"]],["navigation",["ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Home","PageDown","PageUp"]],["editing",["Backspace","Clear","Copy","CrSel","Cut","Delete","EraseEof","ExSel","Insert","Paste","Redo","Undo"]],["ui",["Accept","Again","Attn","Cancel","ContextMenu","Escape","Execute","Find","Finish","Help","Pause","Play","Props","Select","ZoomIn","ZoomOut"]],["device",["BrightnessDown","BrightnessUp","Eject","LogOff","Power","PowerOff","PrintScreen","Hibernate","Standby","WakeUp"]],["ime",["AllCandidates","Alphanumeric","CodeInput","Compose","Convert","Dead","FinalMode","GroupFirst","GroupNext","GroupPrevious","ModeChange","NextCandidate","NonConvert","PreviousCandidate","Process","SingleCandidate"]],["korean",["HangulMode","HanjaMode","JunjaMode"]],["japanese",["Eisu","Hankaku","Hiragana","HiraganaKatakana","KanaMode","KanjiMode","Katakana","Romaji","Zenkaku","ZenkakuHanaku"]],["function",["F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","Soft1","Soft2","Soft3","Soft4"]],["phone",["AppSwitch","Call","Camera","CameraFocus","EndCall","GoBack","GoHome","HeadsetHook","LastNumberRedial","Notification","MannerMode","VoiceDial"]],["multimedia",["ChannelDown","ChannelUp","MediaFastForward","MediaPause","MediaPlay","MediaPlayPause","MediaRecord","MediaRewind","MediaStop","MediaTrackNext","MediaTrackPrevious"]],["audio",["AudioBalanceLeft","AudioBalanceRight","AudioBassDown","AudioBassBoostDown","AudioBassBoostToggle","AudioBassBoostUp","AudioBassUp","AudioFaderFront","AudioFaderRear","AudioSurroundModeNext","AudioTrebleDown","AudioTrebleUp","AudioVolumeDown","AudioVolumeMute","AudioVolumeUp","MicrophoneToggle","MicrophoneVolumeDown","MicrophoneVolumeMute","MicrophoneVolumeUp"]],["tv",["TV","TV3DMode","TVAntennaCable","TVAudioDescription","TVAudioDescriptionMixDown","TVAudioDescriptionMixUp","TVContentsMenu","TVDataService","TVInput","TVInputComponent1","TVInputComponent2","TVInputComposite1","TVInputComposite2","TVInputHDMI1","TVInputHDMI2","TVInputHDMI3","TVInputHDMI4","TVInputVGA1","TVMediaContext","TVNetwork","TVNumberEntry","TVPower","TVRadioService","TVSatellite","TVSatelliteBS","TVSatelliteCS","TVSatelliteToggle","TVTerrestrialAnalog","TVTerrestrialDigital","TVTimer"]],["mediaController",["AVRInput","AVRPower","ColorF0Red","ColorF1Green","ColorF2Yellow","ColorF3Blue","ColorF4Grey","ColorF5Brown","ClosedCaptionToggle","Dimmer","DisplaySwap","DVR","Exit","FavoriteClear0","FavoriteClear1","FavoriteClear2","FavoriteClear3","FavoriteRecall0","FavoriteRecall1","FavoriteRecall2","FavoriteRecall3","FavoriteStore0","FavoriteStore1","FavoriteStore2","FavoriteStore3","Guide","GuideNextDay","GuidePreviousDay","Info","InstantReplay","Link","ListProgram","LiveContent","Lock","MediaApps","MediaAudioTrack","MediaLast","MediaSkipBackward","MediaSkipForward","MediaStepBackward","MediaStepForward","MediaTopMenu","NavigateIn","NavigateNext","NavigateOut","NavigatePrevious","NextFavoriteChannel","NextUserProfile","OnDemand","Pairing","PinPDown","PinPMove","PinPToggle","PinPUp","PlaySpeedDown","PlaySpeedReset","PlaySpeedUp","RandomToggle","RcLowBattery","RecordSpeedNext","RfBypass","ScanChannelsToggle","ScreenModeNext","Settings","SplitScreenToggle","STBInput","STBPower","Subtitle","Teletext","VideoModeNext","Wink","ZoomToggle"]],["speechRecognition",["SpeechCorrectionList","SpeechInputToggle"]],["document",["Close","New","Open","Print","Save","SpellCheck","MailForward","MailReply","MailSend"]],["applicationSelector",["LaunchCalculator","LaunchCalendar","LaunchContacts","LaunchMail","LaunchMediaPlayer","LaunchMusicPlayer","LaunchMyComputer","LaunchPhone","LaunchScreenSaver","LaunchSpreadsheet","LaunchWebBrowser","LaunchWebCam","LaunchWordProcessor","LaunchApplication1","LaunchApplication2","LaunchApplication3","LaunchApplication4","LaunchApplication5","LaunchApplication6","LaunchApplication7","LaunchApplication8","LaunchApplication9"]],["browserControl",["BrowserBack","BrowserFavorites","BrowserForward","BrowserHome","BrowserRefresh","BrowserSearch","BrowserStop"]],["numericKeypad",["Clear"]]])),keyTypes=new Map;for(let e of keyGroups)for(let t of e[1])keyTypes.set(t,e[0]);Object.freeze(keyTypes);let isFnDown=!1;function normalizeKeyValue(e){return"OS"!==e.key||"OSLeft"!==e.code&&"OSRight"!==e.code?"Scroll"===e.key?"ScrollLock":"Win"===e.key?"Meta":"Spacebar"===e.key?" ":"\n"===e.key?"Enter":"Down"===e.key?"ArrowDown":"Left"===e.key?"ArrowLeft":"Right"===e.key?"ArrowRight":"Up"===e.key?"ArrowUp":"Del"===e.key?"Delete":"Delete"===e.key&&isMacOS&&isFnDown?"Backspace":"Crsel"===e.key?"CrSel":"Exsel"===e.key?"ExSel":"Esc"===e.key?"Escape":"Apps"===e.key?"ContextMenu":"Multi"===e.key?"Compose":"Nonconvert"===e.key?"NonConvert":"RomanCharacters"===e.key?"Eisu":"HalfWidth"===e.key?"Hankaku":"FullWidth"===e.key?"Zenkaku":"Exit"===e.key||"MozHomeScreen"===e.key?"GoHome":"MediaNextTrack"===e.key?"MediaTrackNext":"MediaPreviousTrack"===e.key?"MediaTrackPrevious":"FastFwd"===e.key?"MedaiFastFwd":"VolumeDown"===e.key?"AudioVolumeDown":"VolumeMute"===e.key?"AudioVolumeMute":"VolumeUp"===e.key?"AudioVolumeUp":"Live"===e.key?"TV":"Zoom"===e.key?"ZoomToggle":"SelectMedia"===e.key||"MediaSelect"===e.key?"LaunchMediaPlayer":"Add"===e.key?"+":"Divide"===e.key?"/":"Decimal"===e.key?".":"Key11"===e.key?"11":"Key12"===e.key?"12":"Multiply"===e.key?"*":"Subtract"===e.key?"-":"Separator"===e.key?",":e.key:"Meta"}isMacOS&&(window.addEventListener("keydown",e=>{"Fn"===e.key&&(isFnDown=!0)}),window.addEventListener("keyup",e=>{"Fn"===e.key&&(isFnDown=!1)}));const gesture=Object.seal({type:"",text:"",command:""});class OperatingSystem{constructor(e,t,n,i,o,r,s,a,l,h){this.name=e;const u=o;o=o.length>0?o:"Normal";const c=Object.freeze(new Map([["CursorDown","Normal_ArrowDown"],["CursorLeft","Normal_ArrowLeft"],["CursorRight","Normal_ArrowRight"],["CursorUp","Normal_ArrowUp"],["CursorPageDown","Normal_PageDown"],["CursorPageUp","Normal_PageUp"],["CursorSkipLeft",n+"_ArrowLeft"],["CursorSkipRight",n+"_ArrowRight"],["CursorHome",`${o}_${r}`],["CursorEnd",`${o}_${s}`],["CursorFullHome",`${a}_${l}`],["CursorFullEnd",`${a}_${h}`],["SelectDown","Shift_ArrowDown"],["SelectLeft","Shift_ArrowLeft"],["SelectRight","Shift_ArrowRight"],["SelectUp","Shift_ArrowUp"],["SelectPageDown","Shift_PageDown"],["SelectPageUp","Shift_PageUp"],["SelectSkipLeft",n+"Shift_ArrowLeft"],["SelectSkipRight",n+"Shift_ArrowRight"],["SelectHome",`${u}Shift_${r}`],["SelectEnd",`${u}Shift_${s}`],["SelectFullHome",`${a}Shift_${l}`],["SelectFullEnd",`${a}Shift_${h}`],["SelectAll",t+"_a"],["ScrollDown",t+"_ArrowDown"],["ScrollUp",t+"_ArrowUp"],["DeleteLetterLeft","Normal_Backspace"],["DeleteLetterRight","Normal_Delete"],["DeleteWordLeft",n+"_Backspace"],["DeleteWordRight",n+"_Delete"],["DeleteLine","Shift_Delete"],["AppendNewline","Normal_Enter"],["PrependNewline",n+"_Enter"],["InsertTab","Normal_Tab"],["RemoveTab","Shift_Tab"],["Undo",t+"_z"],["Redo",i]])),d=new Map;for(let e of c)d.set(e[1],e[0]);Object.freeze(d),this.makeCommand=e=>(gesture.text=normalizeKeyValue(e),gesture.type=keyTypes.has(gesture.text)?keyTypes.get(gesture.text):"printable",gesture.command="",(e.ctrlKey||e.altKey||e.metaKey)&&("printable"!==gesture.type&&"whitespace"!==gesture.type||(gesture.type="special"),e.ctrlKey&&(gesture.command+="Control"),e.altKey&&(gesture.command+="Alt"),e.metaKey&&(gesture.command+="Meta")),e.shiftKey&&(gesture.command+="Shift"),""===gesture.command&&(gesture.command+="Normal"),gesture.command+="_"+gesture.text,d.has(gesture.command)&&(gesture.command=d.get(gesture.command)),"PrependNewline"===gesture.command&&(gesture.type="whitespace"),gesture),Object.freeze(this)}}const Windows=new OperatingSystem("Windows","Control","Control","Control_y","","Home","End","Control","Home","End"),MacOS=new OperatingSystem("macOS","Meta","Alt","MetaShift_z","Meta","ArrowLeft","ArrowRight","Meta","ArrowUp","ArrowDown");class Rule{constructor(e,t){this.name=e,this.test=t,Object.freeze(this)}carveOutMatchedToken(e,t){const n=e[t];if("regular"===n.type){const i=this.test.exec(n.value);if(i){const o=i[i.length-1],r=i.input.indexOf(o),s=r+o.length;if(0===r){if(n.type=this.name,s<n.value.length){const i=n.splitAt(s);i.type="regular",e.splice(t+1,0,i)}}else{const i=n.splitAt(r);if(o.length<i.value.length){const n=i.splitAt(o.length);e.splice(t+1,0,n)}i.type=this.name,e.splice(t+1,0,i)}}}}}class Token{constructor(e,t,n,i){this.value=e,this.type=t,this.index=n,this.line=i,Object.seal(this)}clone(){return new Token(this.value,this.type,this.index,this.line)}splitAt(e){var t=this.value.substring(e);return this.value=this.value.substring(0,e),new Token(t,this.type,this.index+e,this.line)}toString(){return"["+this.type+": "+this.value+"]"}}const DefaultRules=[["newlines",/(?:\r\n|\r|\n)/],["whitespace",/(?:\s+)/]];class Grammar{constructor(e,t){t=t||[],t=DefaultRules.concat(t),this.name=e,this.grammar=t.map(e=>new Rule(e[0],e[1])),this.tokenize=function(e){const t=[new Token(e,"regular",0)];for(let e of this.grammar)for(var n=0;n<t.length;++n)e.carveOutMatchedToken(t,n);return function(e){var t,n,i=null,o=null,r=0;for(t=0;t<e.length;++t)(n=e[t]).line=r,"newlines"===n.type&&++r,o?("stringDelim"!==n.type||n.value!==o||0!==t&&"\\"===e[t-1].value[e[t-1].value.length-1]||(o=null),"newlines"!==n.type&&(n.type="strings")):i?(("startBlockComments"===i&&"endBlockComments"===n.type||"startLineComments"===i&&"newlines"===n.type)&&(i=null),"newlines"!==n.type&&(n.type="comments")):"stringDelim"===n.type?(o=n.value,n.type="strings"):"startBlockComments"!==n.type&&"startLineComments"!==n.type||(i=n.type,n.type="comments");for(t=e.length-1;t>0;--t){var s=e[t-1];n=e[t],s.type===n.type&&"newlines"!==s.type&&(s.value+=n.value,e.splice(t,1))}}(t),t},Object.freeze(this)}toHTML(e,t,n,i){void 0===n&&(n=Light);for(var o=this.tokenize(t),r=div(),s=0;s<o.length;++s){var a=o[s];if("newlines"===a.type)r.appendChild(br());else{var l=n[a.type]||{},h=span({fontWeight:l.fontWeight||n.regular.fontWeight,fontStyle:l.fontStyle||n.regular.fontStyle||"",color:l.foreColor||n.regular.foreColor,backgroundColor:l.backColor||n.regular.backColor,fontFamily:monospaceFamily});h.appendChild(text(a.value)),r.appendChild(h)}}e.innerHTML=r.innerHTML,Object.assign(e.style,{backgroundColor:n.regular.backColor,fontSize:i+"px",lineHeight:i+"px"})}}class BasicGrammar extends Grammar{constructor(){super("BASIC",[["lineNumbers",/^\d+\s+/],["startLineComments",/^REM\s/],["stringDelim",/("|')/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["members",/\w+\$?/]])}tokenize(e){return super.tokenize(e.toUpperCase())}interpret(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Token("=","operators"),counter=0,isDone=!1,program=new Map,lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters=new Map,dataCounter=0;function toNum(e){return new Token(e.toString(),"numbers")}function toStr(e){return new Token('"'+e.replace("\n","\\n").replace('"','\\"')+'"',"strings")}Object.assign(window,{INT:function(e){return 0|e},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(e){return e.length},LINE:function(){return lineNumbers[counter]},TAB:function(e){for(var t="",n=0;n<e;++n)t+=" ";return t},POW:function(e,t){return Math.pow(e,t)}});for(var tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lineNumber<=lastLine)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program.set(lineNumber,line))}}function process(e){if(e&&e.length>0){var t=e.shift();if(t){if(commands.hasOwnProperty(t.value))return commands[t.value](e);if(!isNaN(t.value))return setProgramCounter([t]);if(window[t.value]||e.length>0&&"operators"===e[0].type&&"="===e[0].value)return e.unshift(t),translate(e);error("Unknown command. >>> "+t.value)}}return pauseBeforeComplete()}function error(e){errorOut("At line "+lineNumbers[counter]+": "+e)}function getLine(e){var t=lineNumbers[e],n=program.get(t);return n&&n.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof window[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}try{return eval(script)}catch(e){console.error(e),console.debug(line.join(", ")),console.error(script),error(e.message+": "+script)}}function declareVariable(e){var t,n=[],i=[n],o=0;for(t=0;t<e.length;++t){var r=e[t];"("===r.value?++o:")"===r.value&&--o,0===o&&","===r.value?(n=[],i.push(n)):n.push(r)}for(t=0;t<i.length;++t){var s=(n=i[t]).shift();if("identifiers"===s.type){var a,l=null;if(s=s.value,"("===n[0].value&&")"===n[n.length-1].value){var h=[];for(a=1;a<n.length-1;++a)"numbers"===n[a].type&&h.push(0|n[a].value);if(0===h.length)l=[];else{var u=[l=new Array(h[0])];for(a=1;a<h.length;++a)for(var c=h[a],d=0,g=u.length;d<g;++d)for(var p=u.shift(),m=0;m<p.length;++m)p[m]=new Array(c),a<h.length-1&&u.push(p[m])}}return window[s]=l,!0}error("Identifier expected: "+s.value)}}function print(e){var t="\n",n=0,i=evaluate(e=e.map((function(i,o){return"operators"===(i=i.clone()).type&&(","===i.value?0===n&&(i.value='+ ", " + '):";"===i.value?(i.value='+ " "',o<e.length-1?i.value+=" + ":t=""):"("===i.value?++n:")"===i.value&&--n),i})));return void 0===i&&(i=""),output(i+t),!0}function setProgramCounter(e){var t=parseFloat(evaluate(e));for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<t;)++counter;return!0}function checkConditional(e){var t,n=-1,i=-1;for(t=0;t<e.length;++t)"keywords"===e[t].type&&"THEN"===e[t].value?n=t:"keywords"===e[t].type&&"ELSE"===e[t].value&&(i=t);if(-1===n)error("Expected THEN clause.");else{var o,r,s=e.slice(0,n);for(t=0;t<s.length;++t){var a=s[t];"operators"===a.type&&"="===a.value&&(a.value="==")}if(-1===i?o=e.slice(n+1):(o=e.slice(n+1,i),r=e.slice(i+1)),evaluate(s))return process(o);if(r)return process(r)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input((function(){isDone=!0,done&&done()})),!1}function labelLine(e){return e.push(EQUAL_SIGN),e.push(toNum(lineNumbers[counter])),translate(e)}function waitForInput(e){var t=e.pop();return e.length>0&&print(e),input((function(e){e=e.toUpperCase();var n=null;n=isNaN(e)?toStr(e):toNum(e),evaluate([t,EQUAL_SIGN,n]),next&&next()})),!1}function onStatement(e){var t=[],n=null,i=[];try{for(;e.length>0&&("keywords"!==e[0].type||"GOTO"!==e[0].value);)t.push(e.shift());if(e.length>0){e.shift();for(var o=0;o<e.length;++o){var r=e[o];"operators"===r.type&&","===r.value||i.push(r)}if(0<=(n=evaluate(t)-1)&&n<i.length)return setProgramCounter([i[n]])}}catch(e){console.error(e)}return!0}function gotoSubroutine(e){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(e)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(e){var t=!0,n=returnStack.pop();return n&&e&&(t=setProgramCounter([n])),t}function untilLoop(e){return conditionalReturn(!evaluate(e))}function findNext(e){for(i=counter+1;i<lineNumbers.length;++i){if(getLine(i)[0].value===e)return i}return lineNumbers.length}function whileLoop(e){return evaluate(e)?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}var FOR_LOOP_DELIMS=["=","TO","STEP"];function forLoop(e){var t=lineNumbers[counter],n=[],i=[],o=[],r=[],s=[n,i,o,r],a=0,l=0;for(l=0;l<e.length;++l){var h=e[l];h.value===FOR_LOOP_DELIMS[a]?(0===a&&n.push(h),++a):s[a].push(h)}var u=1;r.length>0&&(u=evaluate(r)),void 0===!forLoopCounters.has(t)&&forLoopCounters.set(t,evaluate(i));var c=evaluate(o);if(forLoopCounters.get(t)<=c){var d=forLoopCounters.get(t);n.push(toNum(d)),process(n),d+=u,forLoopCounters.set(t,d),returnStack.push(toNum(lineNumbers[counter]))}else forLoopCounters.delete(t),counter=findNext("NEXT");return!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(e){return loadFile(evaluate(e)).then(next),!1}function noop(){return!0}function loadData(e){for(;e.length>0;){var t=e.shift();"operators"!==t.type&&data.push(t.value)}return!0}function readData(e){0===data.length&&process(getLine(findNext("DATA")));var t=data[dataCounter];return++dataCounter,e.push(EQUAL_SIGN),e.push(toNum(t)),translate(e)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return window[name]=eval(script),!0}function translate(e){return evaluate(e),!0}var commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var e=!0;e;){e=process(getLine(counter)),++counter}}}}const Basic=new BasicGrammar,HTML=new Grammar("HTML",[["startBlockComments",/(?:<|&lt;)!--/],["endBlockComments",/--(?:>|&gt;)/],["stringDelim",/("|')/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/(?:<|&lt;)\/?(html|base|head|link|meta|style|title|address|article|aside|footer|header|h1|h2|h3|h4|h5|h6|hgroup|nav|section|dd|div|dl|dt|figcaption|figure|hr|li|main|ol|p|pre|ul|a|abbr|b|bdi|bdo|br|cite|code|data|dfn|em|i|kbd|mark|q|rp|rt|rtc|ruby|s|samp|small|span|strong|sub|sup|time|u|var|wbr|area|audio|img|map|track|video|embed|object|param|source|canvas|noscript|script|del|ins|caption|col|colgroup|table|tbody|td|tfoot|th|thead|tr|button|datalist|fieldset|form|input|label|legend|meter|optgroup|option|output|progress|select|textarea|details|dialog|menu|menuitem|summary|content|element|shadow|template|acronym|applet|basefont|big|blink|center|command|content|dir|font|frame|frameset|isindex|keygen|listing|marquee|multicol|nextid|noembed|plaintext|spacer|strike|tt|xmp)\b/],["members",/(\w+)=/]]),JavaScript=new Grammar("JavaScript",[["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["regexes",/(?:^|,|;|\(|\[|\{)(?:\s*)(\/(?:\\\/|[^\n\/])+\/)/],["stringDelim",/("|'|`)/],["startLineComments",/\/\/.*$/m],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|class|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(\w+)\./],["members",/((\w+\.)+)(\w+)/]]),PlainText=new Grammar("PlainText"),grammars=Object.freeze(new Map([["basic",Basic],["bas",Basic],["html",HTML],["javascript",JavaScript],["js",JavaScript],["plaintext",PlainText],["txt",PlainText]])),singleLineOutput=Object.freeze(["CursorLeft","CursorRight","CursorSkipLeft","CursorSkipRight","CursorHome","CursorEnd","CursorFullHome","CursorFullEnd","SelectLeft","SelectRight","SelectSkipLeft","SelectSkipRight","SelectHome","SelectEnd","SelectFullHome","SelectFullEnd","SelectAll"]),multiLineOutput=Object.freeze(singleLineOutput.concat(["CursorDown","CursorUp","CursorPageDown","CursorPageUp","SelectDown","SelectUp","SelectPageDown","SelectPageUp","ScrollDown","ScrollUp"])),input=["Backspace","Delete","DeleteWordLeft","DeleteWordRight","DeleteLine","Undo","Redo"],singleLineInput=Object.freeze(singleLineOutput.concat(input)),multiLineInput=Object.freeze(multiLineOutput.concat(input).concat(["AppendNewline","PrependNewline"]));let elementCounter=0,focusedControl=null,hoveredControl=null,publicControls=[];const wheelScrollSpeed=4,vScrollWidth=2,scrollScale=isFirefox?3:100,optionDefaults=Object.freeze({readOnly:!1,multiLine:!0,wordWrap:!0,scrollBars:!0,lineNumbers:!0,padding:0,fontSize:16,language:"JavaScript",scaleFactor:devicePixelRatio}),controls=[],elements=new WeakMap,ready=("complete"===document.readyState?Promise.resolve("already"):new Promise(e=>{document.addEventListener("readystatechange",t=>{"complete"===document.readyState&&e("had to wait for it")},!1)})).then(()=>{for(let e of document.getElementsByTagName("primrose"))new Primrose({element:e})});class Primrose extends EventTarget{constructor(e){super();const t=(e,t,n)=>i=>{n&&console.log("Primrose #"+ve,e,i),t&&t(i)};if(void 0===(e=e||{}).element&&(e.element=null),null!==e.element&&!(e.element instanceof HTMLElement))throw new Error("element must be null, an instance of HTMLElement, an instance of HTMLCanvaseElement, or an instance of OffscreenCanvas");e=Object.assign({},optionDefaults,e);let n=()=>{};const i=(e,t,n,i,o,r)=>{e.fillStyle=t,e.fillRect(n*Be.width,i*Be.height,o*Be.width+1,r*Be.height+1)},o=()=>{var e,t,n,o,r,s;rt.clearRect(0,0,Y.width,Y.height),rt.save(),rt.scale(te,te),rt.translate(K,K),fe&&(i(rt,$.regular.selectedBackColor||DefaultTheme.regular.selectedBackColor,0,0,Ie.x,this.width-2*K),e=rt,t=$.regular.foreColor||DefaultTheme.regular.foreColor,n=0,o=0,r=Ie.x,s=this.height-2*K,e.strokeStyle=t,e.strokeRect(n*Be.width,o*Be.height,r*Be.width+1,s*Be.height+1));let a=2;rt.save();{rt.translate((ce-.5)*Be.width,-Fe.y*Be.height);let e=-1;const t=0|Fe.y,n=t+Ie.height;Ve.setXY(Pe,0,t),je.copy(Ve);for(let i=t;i<=n&&i<Re.length;++i){const t=Re[i];for(let e=0;e<t.length;++e){const n=t[e];je.x+=n.value.length,je.i+=n.value.length}if(Ve.copy(je),a=Math.max(a,je.x-1),Ve.x=0,++Ve.y,je.copy(Ve),fe){const n=t.length>0?t[0].line:e+1,o=n.toString();n>e&&(e=n,rt.font="bold "+Qe.font,rt.fillStyle=$.regular.foreColor,rt.fillText(o,0,i*Be.height))}}}if(rt.restore(),me){const e=Ie.width*Be.width-K,t=Ie.height*Be.height,n=Fe.x*e/a+Ie.x*Be.width,i=Fe.y*t/Re.length;rt.fillStyle=$.regular.selectedBackColor||DefaultTheme.regular.selectedBackColor;let o=null;if(!se&&a>Ie.width){const t=e*(Ie.width/a),i=Ie.height*Be.height;o=Math.max(Be.width,t),rt.fillRect(n,i,o,Be.height),rt.strokeRect(n,i,o,Be.height)}if(Re.length>Ie.height){const e=t*(Ie.height/Re.length),n=this.width-vScrollWidth*Be.width-2*K,r=Math.max(Be.height,e);o=vScrollWidth*Be.width,rt.fillRect(n,i,o,r),rt.strokeRect(n,i,o,r)}}rt.restore(),Q||(rt.fillStyle=$.regular.unfocused||DefaultTheme.regular.unfocused,rt.fillRect(0,0,Y.width,Y.height))},r=()=>{if(q&&$){const e=Oe!==G,t=Q!==Ee,n=Qe.font!==Ne,r=K!==Le,s=$.name!==ke,a=Ie.toString()!==Se,l=Be.width!==be,h=Be.height!==Ce,u=_e.i!==Me||He.i!==xe,c=Fe.x!==Te||Fe.y!==De,d=J||a||e||l||h||r||c||s,g=d||n,p=d||t;(d||u)&&(()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He),n=$.regular.backColor?"fillRect":"clearRect";"fillRect"===n&&(it.fillStyle=$.regular.backColor),it[n](0,0,Y.width,Y.height),it.save(),it.scale(te,te),it.translate((Ie.x-Fe.x)*Be.width+K,-Fe.y*Be.height+K),Q&&i(it,$.regular.currentRowBackColor||DefaultTheme.regular.currentRowBackColor,0,e.y,Ie.width,t.y-e.y+1);const o=0|Fe.y,r=o+Ie.height,s=0|Fe.x,a=s+Ie.width;Ve.setXY(Pe,0,o),je.copy(Ve);for(let n=o;n<=r&&n<Re.length;++n){const o=Re[n];for(let n=0;n<o.length;++n){const r=o[n];if(je.x+=r.value.length,je.i+=r.value.length,s<=je.x&&Ve.x<=a){if(e.i<=je.i&&Ve.i<t.i){const n=Cursor.max(e,Ve),o=Cursor.min(t,je).i-n.i;i(it,$.regular.selectedBackColor||DefaultTheme.regular.selectedBackColor,n.x,n.y,o,1)}}Ve.copy(je)}Ve.x=0,++Ve.y,je.copy(Ve)}if(Q){const n=$.cursorColor||DefaultTheme.cursorColor,o=1/Be.width;i(it,n,e.x,e.y,o,1),i(it,n,t.x,t.y,o,1)}it.restore()})(),g&&(()=>{tt.clearRect(0,0,Y.width,Y.height),tt.save(),tt.scale(te,te),tt.translate((Ie.x-Fe.x)*Be.width+K,K);const e=0|Fe.y,t=e+Ie.height,n=0|Fe.x,i=n+Ie.width;Ve.setXY(Pe,0,e),je.copy(Ve);for(let o=e;o<=t&&o<Re.length;++o){const e=Re[o],t=(o-Fe.y)*Be.height;for(let o=0;o<e.length;++o){const r=e[o];if(je.x+=r.value.length,je.i+=r.value.length,n<=je.x&&Ve.x<=i){const e=$[r.type]||{},n=(e.fontWeight||$.regular.fontWeight||"")+" "+(e.fontStyle||$.regular.fontStyle||"")+" "+Qe.font;tt.font=n.trim(),tt.fillStyle=e.foreColor||$.regular.foreColor,tt.fillText(r.value,Ve.x*Be.width,t)}Ve.copy(je)}Ve.x=0,++Ve.y,je.copy(Ve)}tt.restore()})(),p&&o(),Qe.clearRect(0,0,Y.width,Y.height),Qe.save(),Qe.translate(z,B),Qe.drawImage(nt,0,0),Qe.drawImage(et,0,0),Qe.drawImage(ot,0,0),Qe.restore(),Se=Ie.toString(),Oe=G,be=Be.width,Ce=Be.height,Le=K,Me=_e.i,xe=He.i,Ee=Q,Ne=Qe.font,ke=$.name,Te=Fe.x,De=Fe.y,J=!1,this.dispatchEvent(Ye)}},s=(e,t)=>{(e=(e=e||"").replace(/\r\n/g,"\n"))!==G&&(G=e,t&&m(),l(),u(),this.dispatchEvent(Xe))},a=()=>{const e=ye;ye=oe&&he?multiLineOutput:oe&&!he?singleLineOutput:!oe&&he?multiLineInput:singleLineInput,ye!==e&&n()},l=()=>{q=pe.tokenize(G)},h=()=>{me?se?Ue.set(vScrollWidth,0):Ue.set(vScrollWidth,1):Ue.set(0,0)},u=()=>{if(ce=0,fe){const e=G.split(/\n/).length;ce=Math.max(1,Math.ceil(Math.log(e)/Math.LN10))+1}const e=Math.floor(ce+K/Be.width),t=Math.floor(K/Be.height),i=Math.floor((this.width-2*K)/Be.width)-e-Ue.width,o=Math.floor((this.height-2*K)/Be.height)-t-Ue.height;Ie.set(e,t,i,o),Pe.splice(0),Pe.push(""),Re.splice(0),Re.push([]);let r=0;const s=q.slice();for(let e=0;e<s.length;++e){const t=s[e].clone(),n=Ie.width-r,i=se&&"newlines"!==t.type&&t.value.length>n,o="newlines"===t.type||i;if(i){const i=t.value.length>Ie.width?n:0;s.splice(e+1,0,t.splitAt(i))}const a=Re.length-1;t.value.length>0&&(Re[a].push(t),Pe[a]+=t.value,r+=t.value.length),o&&(Pe[a]=new Line(Pe[a]),Pe.push(""),Re.push([]),r=0)}Pe[Pe.length-1]=new Line(Pe[Pe.length-1]),we=Math.max(0,Re.length-Ie.height),n()},c=()=>{J=!0,setContextSize(tt,Y.width,Y.height),setContextSize(it,Y.width,Y.height),setContextSize(rt,Y.width,Y.height),u()},d=(e,t,n)=>{const i=e-t,o=e-n+5;let r=0;return(i<0||o>=0)&&(r=Math.abs(i)<Math.abs(o)?i:o),r},g=()=>{const e=Fe.y<0||0===we,t=Fe.y>we;return e?Fe.y=0:t&&(Fe.y=we),n(),e||t},p=e=>{const t=d(e.x,Fe.x,Fe.x+Ie.width),n=d(e.y,Fe.y,Fe.y+Ie.height);this.scrollBy(t,n)},m=()=>{ae<Ae.length-1&&Ae.splice(ae+1),Ae.push({value:G,frontCursor:_e.i,backCursor:He.i}),ae=Ae.length-1},f=e=>{const t=ae+e;if(0<=t&&t<Ae.length){const e=Ae[ae];ae=t;const n=Ae[ae];s(n.value,!1),_e.setI(Pe,e.frontCursor),He.setI(Pe,e.backCursor)}};this.blur=()=>{Q&&(Q=!1,this.dispatchEvent(Ke),n())},this.focus=()=>{Q||(Q=!0,this.dispatchEvent($e),n())},this.resize=()=>{this.isInDocument?resizeContext(Qe,te)&&c():console.warn("Can't automatically resize a canvas that is not in the DOM tree")},this.setSize=(e,t)=>{setContextSize(Qe,e,t,te)&&c()},this.scrollTo=(e,t)=>(se||(Fe.x=e),Fe.y=t,g()),this.scrollBy=(e,t)=>this.scrollTo(Fe.x+e,Fe.y+t);const v=Object.freeze(new Map([["CursorUp",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);e.up(Pe),t.copy(e),p(_e)}],["CursorDown",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);t.down(Pe),e.copy(t),p(_e)}],["CursorLeft",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);e.i===t.i&&e.left(Pe),t.copy(e),p(_e)}],["CursorRight",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);e.i===t.i&&t.right(Pe),e.copy(t),p(_e)}],["CursorPageUp",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);e.incY(Pe,-Ie.height),t.copy(e),p(_e)}],["CursorPageDown",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);t.incY(Pe,Ie.height),e.copy(t),p(_e)}],["CursorSkipLeft",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);e.i===t.i&&e.skipLeft(Pe),t.copy(e),p(_e)}],["CursorSkipRight",()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);e.i===t.i&&t.skipRight(Pe),e.copy(t),p(_e)}],["CursorHome",()=>{_e.home(),He.copy(_e),p(_e)}],["CursorEnd",()=>{_e.end(Pe),He.copy(_e),p(_e)}],["CursorFullHome",()=>{_e.fullHome(Pe),He.copy(_e),p(_e)}],["CursorFullEnd",()=>{_e.fullEnd(Pe),He.copy(_e),p(_e)}],["SelectDown",()=>{He.down(Pe),p(_e)}],["SelectLeft",()=>{He.left(Pe),p(He)}],["SelectRight",()=>{He.right(Pe),p(He)}],["SelectUp",()=>{He.up(Pe),p(He)}],["SelectPageDown",()=>{He.incY(Pe,Ie.height),p(He)}],["SelectPageUp",()=>{He.incY(Pe,-Ie.height),p(He)}],["SelectSkipLeft",()=>{He.skipLeft(Pe),p(He)}],["SelectSkipRight",()=>{He.skipRight(Pe),p(He)}],["SelectHome",()=>{He.home(),p(He)}],["SelectEnd",()=>{He.end(Pe),p(He)}],["SelectFullHome",()=>{He.fullHome(Pe),p(He)}],["SelectFullEnd",()=>{He.fullEnd(Pe),p(He)}],["SelectAll",()=>{_e.fullHome(),He.fullEnd(Pe),n()}],["ScrollDown",()=>{Fe.y<Pe.length-Ie.height&&this.scrollBy(0,1)}],["ScrollUp",()=>{Fe.y>0&&this.scrollBy(0,-1)}],["DeleteLetterLeft",()=>{_e.i===He.i&&He.left(Pe),this.selectedText=""}],["DeleteLetterRight",()=>{_e.i===He.i&&He.right(Pe),this.selectedText=""}],["DeleteWordLeft",()=>{_e.i===He.i&&_e.skipLeft(Pe),this.selectedText=""}],["DeleteWordRight",()=>{_e.i===He.i&&He.skipRight(Pe),this.selectedText=""}],["DeleteLine",()=>{_e.i===He.i&&(_e.home(),He.end(Pe),He.right(Pe)),this.selectedText=""}],["Undo",()=>{f(-1)}],["Redo",()=>{f(1)}],["InsertTab",()=>{ue=!0,this.selectedText=ie,_e.incX(Pe,ie.length),He.copy(_e)}],["RemoveTab",()=>{const e=Pe[_e.y],t=Math.min(_e.x,X);for(let t=0;t<_e.x;++t)if(" "!==e[t])return;_e.incX(Pe,-t),this.selectedText="",_e.left(Pe),_e.right(Pe)}]]));this.readKeyDownEvent=t("keydown",e=>{const t=qe.makeCommand(e);v.has(t.command)&&(e.preventDefault(),v.get(t.command)(e))});const y=Object.freeze(new Map([["AppendNewline",()=>{if(he){let e="";const t=Re[_e.y];t.length>0&&"whitespace"===t[0].type&&(e=t[0].value),this.selectedText="\n"+e,_e.incX(Pe,e.length+1),He.copy(_e),n()}else this.dispatchEvent(Xe)}],["PrependNewline",()=>{if(he){let e="";const t=Re[_e.y];t.length>0&&"whitespace"===t[0].type&&(e=t[0].value),_e.home(),He.copy(_e),this.selectedText=e+"\n",_e.incX(Pe,e.length),He.copy(_e),n()}else this.dispatchEvent(Xe)}],["Undo",()=>{f(-1)}]]));this.readKeyPressEvent=t("keypress",e=>{const t=qe.makeCommand(e);this.readOnly||(e.preventDefault(),y.has(t.command)?y.get(t.command)():"printable"!==t.type&&"whitespace"!==t.type||(this.selectedText=t.text,_e.right(Pe),He.copy(_e)),g(),n())}),this.readKeyUpEvent=t("keyup");const w=e=>{if(Q&&_e.i!==He.i){return(e.clipboardData||window.clipboardData).setData(window.clipboardData?"Text":"text/plain",this.selectedText),e.returnValue=!1,!0}return!1};this.readCopyEvent=t("copy",e=>{w(e)}),this.readCutEvent=t("cut",e=>{w(e)&&!this.readOnly&&(this.selectedText="")}),this.readPasteEvent=t("paste",e=>{if(Q&&!this.readOnly){e.returnValue=!1;const t=(e.clipboardData||window.clipboardData).getData(window.clipboardData?"Text":"text/plain");t&&(this.selectedText=t,_e.incX(t.length),He.copy(_e))}});const C=()=>{Z=!0,this.dispatchEvent(Ge)},b=()=>{Z=!1,this.dispatchEvent(We)},M=()=>{this.focus(),ne=!0},S=()=>{re=!0,k(_e)},x=()=>{re?k(He):ne&&T()},k=e=>{ze.toCell(Be,Fe,Ie);const t=ze.x-Fe.x,i=ze.y-Fe.y,o=i>=Ie.height,r=t<0,s=ze.x>=Ie.width;if(le||o||r||s){if(le||s&&!o){le=!0;const e=Pe.length-Ie.height;if(i>=0&&e>=0){const t=i*e/Ie.height;this.scrollTo(Fe.x,t)}}else if(o&&!r){let e=0;for(let t=0;t<Pe.length;++t)e=Math.max(e,Pe[t].length);const n=e-Ie.width;if(t>=0&&n>=0){const e=t*n/Ie.width;this.scrollTo(e,Fe.y)}}}else e.setXY(Pe,ze.x,ze.y),He.copy(e);n()};let L=null,E=null;const T=()=>{if(null!==L&&null!==E){let e=(L-ze.x)/Be.width,t=(E-ze.y)/Be.height;this.scrollBy(e,t)}L=ze.x,E=ze.y},D=e=>t=>{e(t),M(),S()},N=()=>{ne=!1,re=!1,le=!1},O=e=>t=>{e(t),x()},A=e=>t=>{e(t),I=ze.x,j=ze.y,M(),U.start()},R=()=>{U.cancel()&&!re&&S(),N(),L=null,E=null},P=e=>t=>{if(e(t),U.isRunning){const e=ze.x-I,t=ze.y-j;e*e+t*t>25&&U.cancel()}U.isRunning||x()},F=e=>{ze.set(e.offsetX,e.offsetY)};this.readMouseOverEvent=t("mouseover",C),this.readMouseOutEvent=t("mouseout",b),this.readMouseDownEvent=t("mousedown",D(F)),this.readMouseUpEvent=t("mouseup",N),this.readMouseMoveEvent=t("mousemove",O(F)),this.readWheelEvent=t("wheel",e=>{if(Z||Q){if(e.ctrlKey||e.altKey||e.shiftKey||e.metaKey)e.ctrlKey||e.altKey||e.metaKey||(e.preventDefault(),this.fontSize+=-e.deltaY/scrollScale);else{const t=Math.floor(e.deltaY*wheelScrollSpeed/scrollScale);this.scrollBy(0,t)&&!Q||e.preventDefault()}n()}});let z=0,B=0;const U=new TimedEvent(1e3);U.addEventListener("tick",()=>{S(),He.copy(_e),_e.skipLeft(Pe),He.skipRight(Pe),n(),navigator.vibrate(20)});let I=0,j=0;const V=e=>{for(let t of e)return t;return null},H=e=>t=>{t.preventDefault(),e(V(t.touches)||V(t.changedTouches))},_=e=>{const t=Y.getBoundingClientRect();ze.set(e.clientX-t.left,e.clientY-t.top)};this.readTouchStartEvent=t("touchstart",H(A(_))),this.readTouchMoveEvent=t("touchmove",H(P(_))),this.readTouchEndEvent=t("touchend",H(R));const W=e=>{ze.set(e.uv.x*this.width,(1-e.uv.y)*this.height)};this.mouse=Object.freeze({readOverEventUV:t("mouseuvover",C),readOutEventUV:t("mouseuvout",b),readDownEventUV:t("mouseuvdown",D(W)),readUpEventUV:t("mouseuvup",N),readMoveEventUV:t("mouseuvmove",O(W))}),this.touch=Object.freeze({readOverEventUV:t("touchuvover",C),readOutEventUV:t("touchuvout",b),readDownEventUV:t("touchuvdown",A(W)),readMoveEventUV:t("touchuvmove",P(W)),readUpEventUV:t("touchuvup",R)}),Object.defineProperties(this,{element:{get:()=>ge},isInDocument:{get:()=>!de&&document.body.contains(Y)},canvas:{get:()=>Y},hovered:{get:()=>Z},focused:{get:()=>Q,set:e=>{e!==Q&&(e?this.focus():this.blur())}},readOnly:{get:()=>oe,set:e=>{(e=!!e)!==oe&&(oe=e,a())}},multiLine:{get:()=>he,set:e=>{(e=!!e)!==he&&(!e&&se&&(this.wordWrap=!1),he=e,a(),h())}},wordWrap:{get:()=>se,set:e=>{(e=!!e)===se||!he&&e||(se=e,h(),n())}},value:{get:()=>G,set:e=>s(e,!0)},text:{get:()=>G,set:e=>s(e,!0)},selectedText:{get:()=>{const e=Cursor.min(_e,He),t=Cursor.max(_e,He);return G.substring(e.i,t.i)},set:e=>{if(e=(e=e||"").replace(/\r\n/g,"\n"),_e.i!==He.i||e.length>0){const t=Cursor.min(_e,He),i=Cursor.max(_e,He),o=G.substring(0,t.i),r=G.substring(i.i);s(o+e+r,!0),i.copy(t),n()}}},selectionStart:{get:()=>_e.i,set:e=>{(e|=0)!==_e.i&&(_e.setI(Pe,e),n())}},selectionEnd:{get:()=>He.i,set:e=>{(e|=0)!==He.i&&(He.setI(Pe,e),n())}},selectionDirection:{get:()=>_e.i<=He.i?"forward":"backward"},tabWidth:{get:()=>X,set:e=>{X=e||2,ie="";for(let e=0;e<X;++e)ie+=" "}},theme:{get:()=>$,set:e=>{e!==$&&($=e,n())}},language:{get:()=>pe,set:e=>{e!==pe&&(pe=e,l(),n())}},padding:{get:()=>K,set:e=>{(e|=0)!==K&&(K=e,n())}},showLineNumbers:{get:()=>fe,set:e=>{(e=e||!1)!==fe&&(fe=e,h())}},showScrollBars:{get:()=>me,set:e=>{(e=e||!1)!==me&&(me=e,h())}},fontSize:{get:()=>ee,set:e=>{(e=Math.max(1,e||0))!==ee&&(ee=e,Qe.font=`${ee}px ${monospaceFamily}`,Be.height=ee,Be.width=Qe.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,u())}},scaleFactor:{get:()=>te,set:e=>{if((e=Math.max(.25,Math.min(4,e||0)))!==te){const t=this.width,n=this.height;te=e,this.setSize(t,n)}}},width:{get:()=>Y.width/te,set:e=>this.setSize(e,this.height)},height:{get:()=>Y.height/te,set:e=>this.setSize(this.width,e)}});let G="",K=0,$=Dark,X=2,Y=null,q=[],J=!1,Z=!1,Q=!1,ee=null,te=2,ne=!1,ie="  ",oe=!1,re=!1,se=!1,ae=-1,le=!1,he=!1,ue=!1,ce=0,de=!1,ge=null,pe=JavaScript,me=!1,fe=!1,ve=++elementCounter,ye=singleLineOutput,we=0,Ce=null,be=null,Me=null,Se=null,xe=null,ke=null,Le=null,Ee=null,Te=null,De=null,Ne=null,Oe=null;const Ae=[],Re=[],Pe=[""],Fe=new Point,ze=new Point,Be=new Size,Ue=new Size,Ie=new Rectangle,je=new Cursor,Ve=new Cursor,He=new Cursor,_e=new Cursor,We=new Event("out"),Ge=new Event("over"),Ke=new Event("blur"),$e=new Event("focus"),Xe=new Event("change"),Ye=new Event("update"),qe=isMacOS?MacOS:Windows;let Je="",Ze=-1;if(null!==e.element){const t=e.element,n=t.width,i=t.height;Ze=t.tabIndex;const o=(t.dataset.options||"").trim().split(","),r={};for(let e of o)if(e=e.trim(),e.length>0){const t=e.split("=");if(t.length>1){const e=t[0].trim(),n=t[1].trim(),i=n.toLocaleLowerCase();r[e]="true"===i||"false"===i?"true"===i:n}}Je=t.textContent,e=Object.assign(e,{width:n,height:i},r)}if(null===e.element?(Y=offscreenCanvas(e),de=!(Y instanceof HTMLCanvasElement)):isCanvas(e.element)?(ge=Y=e.element,Y.innerHTML=""):(ge=e.element,ge.innerHTML="",Y=canvas({style:{width:"100%",height:"100%"}}),ge.appendChild(Y),ge.removeAttribute("tabindex"),assignAttributes(ge,{style:{display:"block",padding:"none",border:"2px inset #c0c0c0",overflow:"unset"}})),null!==Y.parentElement&&-1===Ze){const e=document.querySelectorAll("[tabindex]");for(let t of e)Ze=Math.max(Ze,t.tabIndex);++Ze}Y instanceof HTMLCanvasElement&&this.isInDocument&&(Y.tabIndex=Ze,Y.style.touchAction="none",Y.addEventListener("focus",()=>this.focus()),Y.addEventListener("blur",()=>this.blur()),Y.addEventListener("mouseover",this.readMouseOverEvent),Y.addEventListener("mouseout",this.readMouseOutEvent),Y.addEventListener("mousedown",this.readMouseDownEvent),Y.addEventListener("mouseup",this.readMouseUpEvent),Y.addEventListener("mousemove",this.readMouseMoveEvent),Y.addEventListener("touchstart",this.readTouchStartEvent),Y.addEventListener("touchend",this.readTouchEndEvent),Y.addEventListener("touchmove",this.readTouchMoveEvent));const Qe=Y.getContext("2d"),et=offscreenCanvas(),tt=et.getContext("2d"),nt=offscreenCanvas(),it=nt.getContext("2d"),ot=offscreenCanvas(),rt=ot.getContext("2d");Qe.imageSmoothingEnabled=tt.imageSmoothingEnabled=it.imageSmoothingEnabled=rt.imageSmoothingEnabled=!0,Qe.textBaseline=tt.textBaseline=it.textBaseline=rt.textBaseline="top",rt.textAlign="right",tt.textAlign="left",this.addEventListener("blur",()=>{ue&&(ue=!1,this.focus())}),e.language=e.language.toLocaleLowerCase(),grammars.has(e.language)?e.language=grammars.get(e.language):e.language=null,Object.freeze(e),Object.seal(this),this.readOnly=e.readOnly,this.multiLine=e.multiLine,this.wordWrap=e.wordWrap,this.showScrollBars=e.scrollBars,this.showLineNumbers=e.lineNumbers,this.padding=e.padding,this.fontSize=e.fontSize,this.language=e.language,this.scaleFactor=e.scaleFactor,this.value=Je,n=()=>{requestAnimationFrame(r)},r(),Primrose.add(ge,this)}}Primrose.add=(e,t)=>{null!==e&&elements.set(e,t),-1===controls.indexOf(t)&&(controls.push(t),publicControls=Object.freeze(controls.slice()),t.addEventListener("blur",()=>{focusedControl=null}),t.addEventListener("focus",()=>{null===focusedControl||focusedControl.isInDocument&&t.isInDocument||focusedControl.blur(),focusedControl=t}),t.addEventListener("over",()=>{hoveredControl=t}),t.addEventListener("out",()=>{hoveredControl=null}))},Primrose.has=e=>elements.has(e),Primrose.get=e=>elements.has(e)?elements.get(e):null,Object.defineProperties(Primrose,{hoveredControl:{get:()=>hoveredControl},focusedControl:{get:()=>focusedControl},editors:{get:()=>publicControls},ready:{get:()=>ready}}),Object.freeze(Primrose),requestAnimationFrame((function e(){requestAnimationFrame(e);for(let e=controls.length-1;e>=0;--e){const t=controls[e];t.isInDocument&&(elements.has(t.element)?t.resize():(controls.splice(e,1),publicControls=Object.freeze(controls.slice())))}}));const withCurrentControl=e=>{const t=e.toLocaleLowerCase(),n=`read${e}Event`;window.addEventListener(t,e=>{null!==focusedControl&&focusedControl[n](e)},{passive:!1})};withCurrentControl("KeyDown"),withCurrentControl("KeyPress"),withCurrentControl("KeyUp"),withCurrentControl("Copy"),withCurrentControl("Cut"),withCurrentControl("Paste"),window.addEventListener("wheel",e=>{const t=focusedControl||hoveredControl;null!==t&&t.readWheelEvent(e)},{passive:!1});export{Basic,Dark,Grammar,HTML,JavaScript,Light,PlainText,Primrose,grammars,themes};
