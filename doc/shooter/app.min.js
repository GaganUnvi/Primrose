!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o():"function"==typeof define&&define.amd?define(o):o()}(this,function(){"use strict";function e(){for(var o=document.querySelectorAll("audio"),n=0;n<audio.length;++n)o[n].play();o.length>0&&(i.options.fullScreenElement.removeEventListener("mousedown",e),i.options.fullScreenElement.removeEventListener("touchstart",e),i.options.fullScreenElement.removeEventListener("keydown",e))}function o(e,o){e.velocity&&(a.copy(e.velocity).multiplyScalar(o).add(e.position),e.position.copy(a),e.sound&&e.sound.at(e.position.x,e.position.y,e.position.z,e.velocity.x,e.velocity.y,e.velocity.z))}function n(e){var o=0;for(o=0;o<s.length&&s[o].visible;++o);var n=null;o>=s.length?(n=box(.01,.01,.05).colored(16777087,{unshaded:!0}).named("shot"+s.length),n.velocity=v3(),s.push(n),i.scene.add(n)):n=s[o],n.position.copy(e.pointer.picker.ray.origin),n.position.y-=.5,n.position.x+=.5*(2*(o%2)-1),n.velocity.copy(e.pointer.picker.ray.direction).multiplyScalar(10),n.age=3,n.lookAt(a.copy(n.position).add(n.velocity)),n.visible=!0,n.sound=i.music.getOsc(d).on(30,.25).at(n.position.x,n.position.y,n.position.z,n.velocity.x,n.velocity.y,n.velocity.z).on(5,.25,.5,!0).off(.51)}for(var t=range(6,function(e){return"../images/space"+e+".jpg"}),i=new Primrose.BrowserEnvironment({font:"../fonts/helvetiker_regular.typeface.json",skyTexture:t,backgroundColor:0,drawDistance:100,gazeLength:.25,showHeadPointer:isMobile,ambientSound:"../audio/space.ogg"}),r=[],s=[],a=v3(),l=3,c=8355711,d="sawtooth",v=[box(l).colored(c).named("asteroid1"),[],[]],p=null,u=0,y=shooter(),f=1;f<=2;++f)for(var m=0;m<2;++m)for(var g=0;g<2;++g)for(var h=0;h<2;++h){var S=.5*l/f,x=box(S).colored(c).named("asteroid"+f+"_"+m+"_"+g+"_"+h);x.position.set(S*(m-1),S*(g-1),S*(h-1)),v[f].push(x)}i.addEventListener("ready",function(){isMobile&&(i.options.fullScreenElement.addEventListener("mousedown",e),i.options.fullScreenElement.addEventListener("touchstart",e),i.options.fullScreenElement.addEventListener("keydown",e)),i.insertFullScreenButtons("body"),Promise.all(range(10,function(){return new Primrose.Audio.Sound(i.audio,"../audio/exp.ogg").ready})).then(function(e){p=e,range(10,function(){var e=v[0].clone();e.nextSize=1,e.position.copy(Primrose.Random.vector(-15,15)),e.velocity=Primrose.Random.vector(-1,1),r.push(e),i.scene.add(e)})})}),i.addEventListener("update",function(e){for(var n=0;n<r.length;++n){var t=r[n];a.copy(i.input.head.position).sub(t.position);var l=a.lengthSq();t.velocity.add(a.normalize().multiplyScalar(.5/l)),o(t,e)}for(var n=0;n<s.length;++n){var c=s[n],d=c.velocity.lengthSq()*e;if(o(c,e),c.age-=e,c.age<=0&&(c.visible=!1),c.visible){y.set(c.position,c.velocity),y.ray.direction.normalize();for(var f=y.intersectObjects(r),m=0;m<f.length;++m){var g=f[m],h=g.distance*g.distance;if(h<d){c.age=0,c.visible=!1;var t=g.object,S=r.indexOf(t);if(p){var x=p[u];u=(u+1)%p.length,x.play().at(t.position.x,t.position.y,t.position.z,t.velocity.x,t.velocity.y,t.velocity.z)}if(i.scene.remove(t),t.nextSize<v.length)for(var b=v[t.nextSize],E=0;E<b.length;++E){var z=b[E].clone();z.velocity=Primrose.Random.vector(-1,1).add(t.velocity),z.position.add(t.position),z.nextSize=t.nextSize+1,0===E?r[S]=z:r.push(z),i.scene.add(z)}else r.splice(S,1);break}}}}}),i.addEventListener("pointerend",n),i.addEventListener("gazecomplete",n)});